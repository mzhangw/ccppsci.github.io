<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.16.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="CCPP SciDoc" />
<meta property="og:image" content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452" />
<meta property="og:description" content="CCPP Scientific Documentation" />
<meta property="og:url" content="https://github.com/ufs-community/ccpp-physics" />
<!-- END opengraph metadata -->
<title>CCPP SciDoc v7.0.0: /Users/man.zhang/github_doxygen/ccpp-physics/physics/SFC_Models/Lake/CLM/clm_lake.f90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/svg+xml" href="logo.drawio.svg"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-ccpp.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/ufs-community/ccpp-physics" class="github-corner" title="View source on GitHub" target="_blank" rel="noopener noreferrer">
    <svg viewBox="0 0 250 250" width="60" height="60" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="dtc_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CCPP SciDoc v7.0.0
   &#160;<span id="projectnumber">v7.0.0</span>
   </div>
   <div id="projectbrief">Common Community Physics Package Developed at DTC</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect" class="search-icon" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"><span class="search-icon-dropdown"></span></span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><div id="MSearchCloseImg" class="close-icon"></div></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.16.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('clm__lake_8f90_source.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">clm_lake.f90</div></div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="comment">!&gt; \file clm_lake.f90</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="comment">!!  Contains code related to the CLM lake model</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="comment"></span> </div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="comment">!&gt; This module contains the CLM Lake model.</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="comment">!!</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="comment">!! This lake scheme was taken from module_sf_lake in WRF 4.3.1, and</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="comment">!! modified for CCPP by Sam Trahan in June 2022.</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="comment">!!</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="comment">!! The original documentation said:</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="comment">!! </span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="comment">!! The lake scheme was retrieved from the Community Land Model version 4.5 </span></div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="comment">!! (Oleson et al. (2013) \cite Oleson2013) with some modifications by Gu et al. (2015) \cite Gu2015. It is a </span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="comment">!! one-dimensional mass and energy balance scheme with 20-25 model layers, </span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="comment">!! including up to 5 snow layers on the lake ice, 10 water layers, and 10 soil </span></div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="comment">!! layers on the lake bottom. The lake scheme is used with actual lake points and </span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="comment">!! lake depth derived from the WPS, and it also can be used with user defined </span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="comment">!! lake points and lake depth in WRF (lake_min_elev and lakedepth_default). </span></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="comment">!! The lake scheme is independent of a land surface scheme and therefore </span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span><span class="comment">!! can be used with any land surface scheme embedded in WRF. The lake scheme </span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="comment">!! developments and evaluations were included in Subin et al. (2012) \cite Subin_2012 </span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span><span class="comment">!! and Gu et al. (2015) \cite Gu2015 . </span></div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno"><a class="line" href="namespaceclm__lake.html">   22</a></span><span class="keyword">MODULE</span> <a class="code hl_namespace" href="namespaceclm__lake.html">clm_lake</a></div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>  </div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span>    <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacemachine.html">machine</a>,               <span class="keywordtype">only</span>: kind_phys, kind_dbl_prec</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span> </div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>    <span class="keywordtype">implicit none</span> </div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span> </div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span>    <span class="keywordtype">private</span></div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span> </div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>    <span class="keywordtype">public</span> :: clm_lake_run, clm_lake_init, lakedebug</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span> </div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>    <span class="comment">! In WRF, the CLM Lake Model was hard-coded to use double precision, regardless of</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>    <span class="comment">! precision of physics. For that reason, we retain double precision here. However,</span></div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>    <span class="comment">! we&#39;re not yet certain that all of CLM Lake needs to be double precision, so we</span></div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>    <span class="comment">! maintain a &quot;kind_lake&quot; to allow future experimentation in datatypes.</span></div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ae18904fc5c68d5a6973946a8a9972022.html#ae18904fc5c68d5a6973946a8a9972022">   36</a></span>    <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span>, <span class="keywordtype">public</span> :: kind_lake = kind_dbl_prec</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span> </div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno"><a class="line" href="namespaceclm__lake_aba9d5338cde19843602bcee5fe662b63.html#aba9d5338cde19843602bcee5fe662b63">   38</a></span>    <span class="keywordtype">logical</span> :: lakedebug = .false. <span class="comment">! Enable lots of checks and debug prints and errors</span></div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno"><a class="line" href="namespaceclm__lake_aba8e1f8ac742c7e171a7eab6bb119e35.html#aba8e1f8ac742c7e171a7eab6bb119e35">   39</a></span>    <span class="keywordtype">logical</span> :: debug_print = .false. <span class="comment">! Enable lots of checks and debug prints and errors</span></div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span> </div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a9200c35a3bf27039d3fb8b09e2abb6b6.html#a9200c35a3bf27039d3fb8b09e2abb6b6">   41</a></span>    <span class="keywordtype">logical</span>, <span class="keywordtype">parameter</span> :: pergro = .false.</div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span> </div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a723331d7d636d13063effccd4fc74671.html#a723331d7d636d13063effccd4fc74671">   43</a></span>    <span class="keywordtype">logical</span>, <span class="keywordtype">parameter</span> :: use_etalake = .false.</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ae784eafab47c780547ea5a7e20c99836.html#ae784eafab47c780547ea5a7e20c99836">   44</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: etalake = 1.1925*50**(-0.424)<span class="comment"> !&lt; Set this to your desired value if USE_ETALAKE=.true.</span></div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span> </div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>    <span class="comment">! Level counts must be consistent with model (GFS_typedefs.F90)</span></div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ab6ea9bc6bd1db1f9ce986ada3c4b123d.html#ab6ea9bc6bd1db1f9ce986ada3c4b123d">   47</a></span>    <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: nlevsoil     =  10<span class="comment">   !&lt; number of soil layers</span></div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ad9f8eacbce8bb6a43583325fa13fba19.html#ad9f8eacbce8bb6a43583325fa13fba19">   48</a></span>    <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: nlevlake     =  10<span class="comment">   !&lt; number of lake layers</span></div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a90adbd42f9d6589e3822d30fd2c34050.html#a90adbd42f9d6589e3822d30fd2c34050">   49</a></span>    <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: nlevsnow     =   5<span class="comment">   !&lt; maximum number of snow layers</span></div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a0a5916608cff6a4a7a806a14d1e368b8.html#a0a5916608cff6a4a7a806a14d1e368b8">   50</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: scalez  = 0.025_kind_lake   <span class="comment">!&lt; Soil layer thickness discretization (m)</span></div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span> </div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a9da1b19602efa3d8d0d79b1b1fba30e1.html#a9da1b19602efa3d8d0d79b1b1fba30e1">   52</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     lbp = 1<span class="comment">                        !&lt; pft-index bounds</span></div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a8f3bdc0a1d9d31c51f45a72a6999dd41.html#a8f3bdc0a1d9d31c51f45a72a6999dd41">   53</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     ubp = 1</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a6ea75f1fafcf3ab6bd1de2cc90798dcb.html#a6ea75f1fafcf3ab6bd1de2cc90798dcb">   54</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     lbc = 1<span class="comment">                        !&lt; column-index bounds</span></div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a3ae72bd8214a384f857cce599034b089.html#a3ae72bd8214a384f857cce599034b089">   55</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     ubc = 1</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a72221e9f88d4fb83394146b4b0f5d72e.html#a72221e9f88d4fb83394146b4b0f5d72e">   56</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     num_shlakec       = 1<span class="comment">          !&lt; number of columns in lake filter</span></div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a760b2fea007cadeb65b88dd6fa49dd70.html#a760b2fea007cadeb65b88dd6fa49dd70">   57</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     filter_shlakec(1) = 1<span class="comment">          !&lt; lake filter (columns)</span></div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a6008e16ba689ccb8b980e15bbed3f3a3.html#a6008e16ba689ccb8b980e15bbed3f3a3">   58</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     num_shlakep       = 1<span class="comment">          !&lt; number of pfts in lake filter</span></div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno"><a class="line" href="namespaceclm__lake_abae2104f594b0f18ec7ee22a8c43f359.html#abae2104f594b0f18ec7ee22a8c43f359">   59</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     filter_shlakep(1) = 1<span class="comment">          !&lt; lake filter (pfts)</span></div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a6a97aa42f4c0f1fb254f1785b183e63f.html#a6a97aa42f4c0f1fb254f1785b183e63f">   60</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     pcolumn(1)        = 1  </div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a1e4650464f2edc0f70ef2dc4a6e71c1b.html#a1e4650464f2edc0f70ef2dc4a6e71c1b">   61</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     pgridcell(1)      = 1  </div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a3c5c0e4decb0dc204c0e616998560ab2.html#a3c5c0e4decb0dc204c0e616998560ab2">   62</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     cgridcell(1)      = 1<span class="comment">          !&lt; gridcell index of column</span></div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a7fe1cfc979b58b8595ac68a2ec55c7e5.html#a7fe1cfc979b58b8595ac68a2ec55c7e5">   63</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     clandunit(1)      = 1<span class="comment">          !&lt; landunit index of column</span></div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>  </div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a97398a9f01acec1151acb6c5d2695e0e.html#a97398a9f01acec1151acb6c5d2695e0e">   65</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     begg = 1</div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a354e0f8f839b5815ffdb618dd8f41fa7.html#a354e0f8f839b5815ffdb618dd8f41fa7">   66</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     endg = 1</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno"><a class="line" href="namespaceclm__lake_aa37dbdefe9fb9f56efb0272b362aded6.html#aa37dbdefe9fb9f56efb0272b362aded6">   67</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     begl = 1</div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a5f9283920812dc4f6ed8e87f8c0114cc.html#a5f9283920812dc4f6ed8e87f8c0114cc">   68</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     endl = 1</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ad8ff83d32edd7662ce768baca4b7d053.html#ad8ff83d32edd7662ce768baca4b7d053">   69</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     begc = 1</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a66203b5743d25888537d07c67c67ab25.html#a66203b5743d25888537d07c67c67ab25">   70</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     endc = 1</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a10eca1142e1656cfc3c2327828ef3b8e.html#a10eca1142e1656cfc3c2327828ef3b8e">   71</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     begp = 1</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a37d75928d1488dd50f47682ff5e5ca5d.html#a37d75928d1488dd50f47682ff5e5ca5d">   72</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     endp = 1</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span> </div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a934f47a1f86f5538e09a0a3558e9b9c7.html#a934f47a1f86f5538e09a0a3558e9b9c7">   74</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span>  ::     column    =1</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno"><a class="line" href="namespaceclm__lake_af9529d02d589bb6170be8e9994be1c6a.html#af9529d02d589bb6170be8e9994be1c6a">   75</a></span>    <span class="keywordtype">logical</span>,<span class="keywordtype">parameter</span>  ::     lakpoi(1) = .true.</div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>   </div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>    <span class="comment">!Initialize physical constants not available from model:</span></div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a6bb4b28b05c2df6aa1f2f4396046899e.html#a6bb4b28b05c2df6aa1f2f4396046899e">   78</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: tcrit  = 2.5<span class="comment">          !&lt; critical temperature to determine rain or snow</span></div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a365dcd933ca86f9e41d0f993fb1b900e.html#a365dcd933ca86f9e41d0f993fb1b900e">   79</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: tkwat  = 0.6<span class="comment">          !&lt; thermal conductivity of water [W/m/k]</span></div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno"><a class="line" href="namespaceclm__lake_acc8c6644179b63f24ddf4856f87cb9d1.html#acc8c6644179b63f24ddf4856f87cb9d1">   80</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: tkice  = 2.290<span class="comment">        !&lt; thermal conductivity of ice   [W/m/k]</span></div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno"><a class="line" href="namespaceclm__lake_afdca3ceec17b8711dd20d14ae8135289.html#afdca3ceec17b8711dd20d14ae8135289">   81</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: tkairc = 0.023<span class="comment">        !&lt; thermal conductivity of air   [W/m/k]</span></div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a74b1f87f7dec69f5f1a61a7ecb0b1364.html#a74b1f87f7dec69f5f1a61a7ecb0b1364">   82</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: snow_bd = 250<span class="comment">         !&lt; constant snow bulk density (only used in special case here) [kg/m^3]</span></div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>  </div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>    <span class="comment">! Constants that are copied from model values by clm_lake_init:</span></div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno"><a class="line" href="namespaceclm__lake_abad43d83568f0f1e938ec2e5f7158537.html#abad43d83568f0f1e938ec2e5f7158537">   85</a></span><span class="keywordtype">    real</span>(kind_lake) :: pi<span class="comment">                   !&lt; ratio of the circumference of a circle to its diameter</span></div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a52ab2a2d6e5349079033817f647dfb3e.html#a52ab2a2d6e5349079033817f647dfb3e">   86</a></span><span class="keywordtype">    real</span>(kind_lake) :: vkc<span class="comment">                  !&lt; von Karman constant [-]</span></div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno"><a class="line" href="namespaceclm__lake_af7b0b4edad2328e14d8f105c5bdd3d8c.html#af7b0b4edad2328e14d8f105c5bdd3d8c">   87</a></span><span class="keywordtype">    real</span>(kind_lake) :: grav<span class="comment">                 !&lt; gravity constant [m/s2]</span></div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ab05a492acbc4fc3c791d69df3c2f81ce.html#ab05a492acbc4fc3c791d69df3c2f81ce">   88</a></span><span class="keywordtype">    real</span>(kind_lake) :: sb<span class="comment">                   !&lt; stefan-boltzmann constant  [W/m2/K4]</span></div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno"><a class="line" href="namespaceclm__lake_aad26ad6ec4098f3e0a18fab4ba092d7f.html#aad26ad6ec4098f3e0a18fab4ba092d7f">   89</a></span><span class="keywordtype">    real</span>(kind_lake) :: tfrz<span class="comment">                 !&lt; freezing temperature [K]</span></div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a8a016fd3d56fd17fb0dc54dceb23fe89.html#a8a016fd3d56fd17fb0dc54dceb23fe89">   90</a></span><span class="keywordtype">    real</span>(kind_lake) :: denh2o<span class="comment">               !&lt; density of liquid water [kg/m3]</span></div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno"><a class="line" href="namespaceclm__lake_acf2ec0f47557c38a231808b9d6b48a1a.html#acf2ec0f47557c38a231808b9d6b48a1a">   91</a></span><span class="keywordtype">    real</span>(kind_lake) :: denice<span class="comment">               !&lt; density of ice [kg/m3]</span></div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ab9a94c1010ec5a186d87d6a8927c24c8.html#ab9a94c1010ec5a186d87d6a8927c24c8">   92</a></span><span class="keywordtype">    real</span>(kind_lake) :: cpice<span class="comment">                !&lt; Specific heat of ice [J/kg-K]</span></div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a06395ef2f6cd444ace77c129b4bdcded.html#a06395ef2f6cd444ace77c129b4bdcded">   93</a></span><span class="keywordtype">    real</span>(kind_lake) :: cpliq<span class="comment">                !&lt; Specific heat of water [J/kg-K]</span></div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a11f6915733a310b7a5b10d2a22b56a98.html#a11f6915733a310b7a5b10d2a22b56a98">   94</a></span><span class="keywordtype">    real</span>(kind_lake) :: hfus<span class="comment">                 !&lt; Latent heat of fusion for ice [J/kg]</span></div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a58573f58d4f34a40d3a49451a1aa01a7.html#a58573f58d4f34a40d3a49451a1aa01a7">   95</a></span><span class="keywordtype">    real</span>(kind_lake) :: hvap<span class="comment">                 !&lt; Latent heat of evap for water [J/kg]</span></div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a3679f49be967804cf8a63654c35448d3.html#a3679f49be967804cf8a63654c35448d3">   96</a></span><span class="keywordtype">    real</span>(kind_lake) :: hsub<span class="comment">                 !&lt; Latent heat of sublimation    [J/kg]</span></div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ad49f85055cd9c19709748f4a23e5e935.html#ad49f85055cd9c19709748f4a23e5e935">   97</a></span><span class="keywordtype">    real</span>(kind_lake) :: invhvap<span class="comment">              !&lt; 1/hvap [kg/J]</span></div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno"><a class="line" href="namespaceclm__lake_af4301a526233f3a82599fe54cdb2d978.html#af4301a526233f3a82599fe54cdb2d978">   98</a></span><span class="keywordtype">    real</span>(kind_lake) :: invhsub<span class="comment">              !&lt; 1/hsub [kg/J]</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a8037e9dedacdc3de509a07bb64ae6888.html#a8037e9dedacdc3de509a07bb64ae6888">   99</a></span><span class="keywordtype">    real</span>(kind_lake) :: rair<span class="comment">                 !&lt; gas constant for dry air [J/kg/K]</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a7170735216051aad78d2dd134a877f28.html#a7170735216051aad78d2dd134a877f28">  100</a></span><span class="keywordtype">    real</span>(kind_lake) :: cpair<span class="comment">                !&lt; specific heat of dry air [J/kg/K]</span></div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a3fac244fe0b15259e7c5a356e789c4cf.html#a3fac244fe0b15259e7c5a356e789c4cf">  101</a></span><span class="keywordtype">    real</span>(kind_lake) :: con_eps<span class="comment">              !&lt; ratio of gas constants of air and water vapor [unitless]</span></div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a2de62b5c8f337db5f6167f906b03fe7e.html#a2de62b5c8f337db5f6167f906b03fe7e">  102</a></span><span class="keywordtype">    real</span>(kind_lake) :: one_minus_con_eps<span class="comment">    !&lt; 1 - con_eps [unitless]</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno"><a class="line" href="namespaceclm__lake_af248577ddf1ed21ea07bd4fac4389f2a.html#af248577ddf1ed21ea07bd4fac4389f2a">  103</a></span><span class="keywordtype">    real</span>(kind_lake) :: con_fvirt<span class="comment">            !&lt; 1/con_eps - 1 [unitless]</span></div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>    </div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ae2ab76d5917aa2c84d4f5ca2e70a43f6.html#ae2ab76d5917aa2c84d4f5ca2e70a43f6">  105</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">public</span>, <span class="keywordtype">parameter</span> :: spval = 1.e36 <span class="comment">!&lt; special value for missing data (ocean)</span></div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a6ebc870fb8193360558d563c892581c1.html#a6ebc870fb8193360558d563c892581c1">  106</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span>  ::     depth_c = 50.<span class="comment">    !&lt; below the level t_lake3d will be 277.0  !mchen</span></div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno"><a class="line" href="namespaceclm__lake_adfcb6f4aa3976cbc8957f61f8f0a2fb0.html#adfcb6f4aa3976cbc8957f61f8f0a2fb0">  107</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: zero_h2o = 1e-12      <span class="comment">!&lt; lower mixing ratio is is treated as zero</span></div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>    </div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>   <span class="comment">! These are tunable constants</span></div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a2995fca78b6dd742076e5fc05f7e125f.html#a2995fca78b6dd742076e5fc05f7e125f">  110</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: wimp   = 0.05<span class="comment">    !&lt; Water impermeable if porosity less than wimp</span></div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a659fdd131d92d0ebd5e32b1ffe2fb989.html#a659fdd131d92d0ebd5e32b1ffe2fb989">  111</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: ssi    = 0.033<span class="comment">   !&lt; Irreducible water saturation of snow</span></div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno"><a class="line" href="namespaceclm__lake_acea160cb5ef1cf3ff319272727ca8d0f.html#acea160cb5ef1cf3ff319272727ca8d0f">  112</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: cnfac  = 0.5<span class="comment">     !&lt; Crank Nicholson factor between 0 and 1</span></div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span> </div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>   <span class="comment">! Initialize water type constants</span></div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a053fff2d9b5846a1fb92d11363c4de1f.html#a053fff2d9b5846a1fb92d11363c4de1f">  115</a></span>    <span class="keywordtype">integer</span>,<span class="keywordtype">parameter</span> :: istsoil = 1<span class="comment">!soil         &quot;water&quot; type</span><span class="comment">               !&lt;</span></div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span> </div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>    <span class="comment">! percent sand</span></div>
<div class="foldopen" id="foldopen00118" data-start="" data-end="">
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno"><a class="line" href="namespaceclm__lake_af8e43865b4193c8054259f04505fe69c.html#af8e43865b4193c8054259f04505fe69c">  118</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: sand(19) = &amp;</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>         (/92.,80.,66.,20.,5.,43.,60.,10.,32.,51., 6.,22.,39.7,0.,100.,54.,17.,100.,92./)</div>
</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span> </div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>    <span class="comment">! percent clay</span></div>
<div class="foldopen" id="foldopen00122" data-start="" data-end="">
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ad8dffa65f4ea44f68bb15524ef9de9a2.html#ad8dffa65f4ea44f68bb15524ef9de9a2">  122</a></span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: clay(19) = &amp;</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>         (/ 3., 5.,10.,15.,5.,18.,27.,33.,33.,41.,47.,58.,14.7,0., 0., 8.5,54.,  0., 3./)</div>
</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span> </div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>    <span class="comment">! These are initialized in clm_lake_init and are not modified elsewhere</span></div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a8f0eea6d1129080dcf5607a1f00f6c20.html#a8f0eea6d1129080dcf5607a1f00f6c20">  126</a></span><span class="keywordtype">    real</span>(kind_lake) :: zlak(1:nlevlake)<span class="comment">     !&lt; lake z  (layers)</span></div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a6211ddac2ef19e0c2b92f7f9ce4d8ec6.html#a6211ddac2ef19e0c2b92f7f9ce4d8ec6">  127</a></span><span class="keywordtype">    real</span>(kind_lake) :: dzlak(1:nlevlake)<span class="comment">    !&lt; lake dz (thickness)</span></div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a0fc819a9aa7a9b11885ce4dbaa685884.html#a0fc819a9aa7a9b11885ce4dbaa685884">  128</a></span><span class="keywordtype">    real</span>(kind_lake) :: zsoi(1:nlevsoil)<span class="comment">     !&lt; soil z  (layers)</span></div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a1b00598bdb5ccd040fca5053c353a4a9.html#a1b00598bdb5ccd040fca5053c353a4a9">  129</a></span><span class="keywordtype">    real</span>(kind_lake) :: dzsoi(1:nlevsoil)<span class="comment">    !&lt; soil dz (thickness)</span></div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a39381bf128f151ce5c8b869f0acce991.html#a39381bf128f151ce5c8b869f0acce991">  130</a></span><span class="keywordtype">    real</span>(kind_lake) :: zisoi(0:nlevsoil)<span class="comment">    !&lt; soil zi (interfaces)  </span></div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span> </div>
<div class="foldopen" id="foldopen00132" data-start="" data-end="">
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a3922db70cf29a1f55d77d3d86b91dc48.html#a3922db70cf29a1f55d77d3d86b91dc48">  132</a></span><span class="keywordtype">    real</span>, <span class="keywordtype">parameter</span> :: saltlk_t(1:25) = (/ 0.5,  0.,-0.5, 3., 4.,  7., 8., 12.,  13., 16., 19., 21., &amp;</div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>                                          23.5, 25., 26.,24.,23.,20.5,18., 15., 11.5,  8.,  4.,  1., 0.5/)</div>
</div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno"><a class="line" href="namespaceclm__lake_aede6513fda19d929a92a85971029c757.html#aede6513fda19d929a92a85971029c757">  134</a></span><span class="keywordtype">    real</span>, <span class="keywordtype">parameter</span> :: month_length(12) = (/ 31, 29, 31, 30, 31, 30, 31, 30, 30, 31, 30, 31 /)</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a219e646e39eb849c33e3137355fd5c12.html#a219e646e39eb849c33e3137355fd5c12">  135</a></span>    <span class="keywordtype">logical</span>, <span class="keywordtype">parameter</span> :: include_all_salty_locations = .false.</div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span> </div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>    <span class="keyword">CONTAINS</span></div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span> </div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span> </div>
<div class="foldopen" id="foldopen00141" data-start="" data-end="">
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ad415a439ef667391595b8c68bb31b819.html#ad415a439ef667391595b8c68bb31b819">  141</a></span>    <span class="keyword">logical </span><span class="keyword">function </span>limit_temperature_by_climatology(xlat_d,xlon_positive)</div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span><span class="keywordtype">      real</span>(kind_phys), <span class="keywordtype">intent(in)</span> :: xlat_d, xlon_positive</div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span><span class="keywordtype">      real</span>(kind_phys) :: xlon_d</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span> </div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>      xlon_d = xlon_positive</div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>      <span class="keywordflow">if</span>(xlon_d&gt;180) xlon_d = xlon_d - 360</div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span> </div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>      limit_temperature_by_climatology=.false.</div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span><span class="comment"></span> </div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span><span class="comment">      !&gt;tgs  - 7nov19 - salinity effect on freezing point (Tanya, Stan, Trevor).</span></div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span><span class="comment">      !! The Great Salt Lake (GSL), Utah lat/long (39.5-42.0,-111.5- -117.7).</span></div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span><span class="comment">      !! The GSL&#39;s salinity is 270 ppt above ~41.22 N with freezing point of -24 C, </span></div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span><span class="comment">      !! and 150 ppt south of ~41.22 N with freezing point -10 C (info from Trevor Alcott). </span></div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span><span class="comment">      !! The fresh-water Willard Bay should be excluded from the box around the Great Salt</span></div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span><span class="comment">      !! Lake: lat/long 41.3539, -112.102, HRRR i,j = 494,667 (info from Stan and Trevor).</span></div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span><span class="comment">      !! </span></div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span><span class="comment">      !! 1jun2020: reset the GSL freezing point to be -5 C,</span></div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span><span class="comment">      !! and add a check (after call to LakeMain) to keep the lake ice free for the whole year.</span></div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>      <span class="keywordflow">if</span> ((xlon_d.gt.-117.7 .and. xlon_d.lt.-111.5) .and.    &amp;</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>                                <span class="comment">! excludes Willard Bay</span></div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>           .not. (xlon_d.gt.-112.104 .and. xlon_d.lt.-112.100))<span class="keywordflow">then</span></div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span> </div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>         <span class="keywordflow">if</span>(xlat_d.gt.39.5 .and. xlat_d.lt.41.22) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>            <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>               print *,<span class="stringliteral">&#39;The Great Salt Lake south of 41.22 N, lat,lon&#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>            limit_temperature_by_climatology = .true.</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span> </div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>         <span class="keywordflow">elseif</span>(( xlat_d.ge.41.22 .and. xlat_d.lt.42.) .and. .not. &amp;</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>                                <span class="comment">! excludes Willard Bay</span></div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>              (xlat_d.gt.41.352 .and. xlat_d.lt.41.354)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>            <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>               print *,<span class="stringliteral">&#39;The Great Salt Lake north of 41.22 N xlat_d,xlon_d &#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>            <span class="comment">!print *,&#39;Ice fraction on the GSL &#39;, i,j,lake_icefrac3d(i,:,j)</span></div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>            limit_temperature_by_climatology = .true.</div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span> </div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span><span class="keywordflow">         endif</span> <span class="comment">! xlat_d</span></div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span> </div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span><span class="keywordflow">      endif</span> <span class="comment">! xlon_d</span></div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span> </div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>      <span class="comment">!if(i==495.and.j==668) print *,&#39;Willard Bay salty=&#39;,i,j,limit_temperature_by_climatology,xlat_d,xlon_d</span></div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span> </div>
</div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>    <span class="keyword">end function </span>limit_temperature_by_climatology</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span> </div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span> </div>
<div class="foldopen" id="foldopen00189" data-start="" data-end="">
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a8277cbe815e5f397427775563aa4f398.html#a8277cbe815e5f397427775563aa4f398">  189</a></span>    <span class="keyword">subroutine </span>is_salty(xlat_d,xlon_positive, cannot_freeze, salty)</div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span><span class="keywordtype">      real</span>(kind_phys), <span class="keywordtype">intent(in)</span> :: xlat_d, xlon_positive</div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>      <span class="keywordtype">logical</span>, <span class="keywordtype">intent(inout)</span> :: cannot_freeze, salty</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span><span class="keywordtype">      real</span>(kind_phys) :: xlon_d</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span> </div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>      xlon_d = xlon_positive</div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span>      <span class="keywordflow">if</span>(xlon_d&gt;180) xlon_d = xlon_d - 360</div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span> </div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>      <span class="comment">! for the Great Salt Lake</span></div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>      cannot_freeze = limit_temperature_by_climatology(xlat_d,xlon_d)</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>      salty = cannot_freeze</div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span> </div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span>      <span class="comment">! --- The Mono Lake in California, salinity is 75 ppt with freezing point at</span></div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span>      <span class="comment">! --- -4.2 C (Stan). The Mono Lake lat/long (37.9-38.2, -119.3 - 118.8)</span></div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>      <span class="keywordflow">if</span> (xlon_d.gt.-119.3.and. xlon_d.lt.-118.8) <span class="keywordflow">then</span>  </div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span>         <span class="keywordflow">if</span>(xlat_d.gt.37.9 .and. xlat_d.lt.38.2) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>            salty = .true.</div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>            <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>               print *,<span class="stringliteral">&#39;Salty Mono Lake, i,j&#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span><span class="keywordflow">         endif</span> <span class="comment">! xlat_d</span></div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span><span class="keywordflow">      endif</span> <span class="comment">! xlon_d</span></div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span> </div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span>     other_locations: <span class="keywordflow">if</span>(include_all_salty_locations) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>      <span class="comment">! --- Caspian Sea and Dead Sea are salty too (Sam, Tanya)</span></div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>      <span class="keywordflow">if</span> ( xlat_d&gt;36.5_kind_phys .and. xlat_d&lt;47.1_kind_phys .and. xlon_d&gt;46.8_kind_phys .and. xlon_d&lt;55.0_kind_phys ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>         <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span>            print *,<span class="stringliteral">&#39;Salty Caspian Sea &#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>         salty = .true.</div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span><span class="keywordflow">      end if</span> </div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span>      <span class="keywordflow">if</span> ( xlon_d&gt;35.3 .and. xlon_d&lt;35.6 .and. xlat_d&gt;31.3 .and. xlat_d&lt;31.8) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span>         <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>            print *,<span class="stringliteral">&#39;Salty Dead Sea &#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>         salty = .true.</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span><span class="keywordflow">     endif</span> other_locations</div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span>     <span class="comment">!tgs --- end of special treatment for salty lakes</span></div>
</div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span>    <span class="keyword">end subroutine </span>is_salty</div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span> </div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span> </div>
<div class="foldopen" id="foldopen00233" data-start="" data-end="">
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno"><a class="line" href="namespaceclm__lake_aad30c3d31dcc613d1f03e742a998f38d.html#aad30c3d31dcc613d1f03e742a998f38d">  233</a></span>    <span class="keyword">subroutine </span>calculate_z_dz_lake(i,input_lakedepth,clm_lakedepth,z_lake,dz_lake)</div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: i</div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span><span class="keywordtype">      real</span>(kind_phys), <span class="keywordtype">intent(inout)</span> :: clm_lakedepth(:) <span class="comment">! lake depth used by clm</span></div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span><span class="keywordtype">      real</span>(kind_phys), <span class="keywordtype">intent(in)</span> :: input_lakedepth(:) <span class="comment">! lake depth before correction (m)</span></div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span><span class="keywordtype">      real</span>(kind_lake) :: z_lake(nlevlake)  <span class="comment">! layer depth for lake (m)</span></div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span><span class="keywordtype">      real</span>(kind_lake) :: dz_lake(nlevlake) <span class="comment">! layer thickness for lake (m)</span></div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span><span class="keywordtype">      real</span>(kind_lake) :: depthratio</div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span> </div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>      <span class="keywordflow">if</span> (input_lakedepth(i) == spval .or. input_lakedepth(i) &lt; 0.1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span>        <span class="comment">! This is a safeguard against:</span></div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span>        <span class="comment">! 1. missing in the lakedepth database (== spval)</span></div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>        <span class="comment">! 2. errors in model cycling or unexpected changes in the orography database (&lt; 0.1)</span></div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>        clm_lakedepth(i) = zlak(nlevlake) + 0.5_kind_lake*dzlak(nlevlake)</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>        z_lake(1:nlevlake) = zlak(1:nlevlake)</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>        dz_lake(1:nlevlake) = dzlak(1:nlevlake)</div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>        depthratio = input_lakedepth(i) / (zlak(nlevlake) + 0.5_kind_lake*dzlak(nlevlake)) </div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span>        z_lake(1) = zlak(1)</div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span>        dz_lake(1) = dzlak(1)</div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span>        dz_lake(2:nlevlake) = dzlak(2:nlevlake)*depthratio</div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>        z_lake(2:nlevlake) = zlak(2:nlevlake)*depthratio + dz_lake(1)*(1._kind_lake - depthratio)</div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span> </div>
</div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span>    <span class="keyword">end subroutine </span>calculate_z_dz_lake</div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span> </div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span><span class="comment"></span> </div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span><span class="comment">    !&gt; \section arg_table_clm_lake_run Argument Table</span></div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span><span class="comment">    !! \htmlinclude clm_lake_run.html</span></div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span><span class="comment">    !!</span></div>
<div class="foldopen" id="foldopen00264" data-start="" data-end="">
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a45370a45ff94cf5dc347a180920eb69a.html#a45370a45ff94cf5dc347a180920eb69a">  264</a></span>    <span class="keyword">SUBROUTINE </span>clm_lake_run( &amp;</div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span>         ! Model time and metadata:</div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span>         flag_restart, im, km, me, master, fhour, IDATE, kdt,                     &amp;</div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span> </div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span>         ! Configuration and initialization:</div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span>         iopt_lake, iopt_lake_clm, min_lakeice, lakedepth_default, use_lakedepth, &amp;</div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span>         dtp, use_lake_model, clm_lake_initialized, frac_grid, frac_ice, lkm,     &amp;</div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span>         use_cdeps_data, mask_dat,                                                &amp;</div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span> </div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span>         ! Atmospheric model state inputs:</div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span>         tg3, pgr, zlvl, gt0, prsi, phii, qvcurr, gu0, gv0, xlat_d, xlon_d,       &amp;</div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>         ch, cm, dlwsfci, dswsfci, oro_lakedepth, wind, tsfc,                     &amp;</div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span>         flag_iter, flag_lakefreeze, ISLTYP, rainncprv, raincprv,                 &amp;</div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span> </div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span>         ! Feedback to atmosphere:</div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>         evap_wat,     evap_ice,   hflx_wat,    hflx_ice,  gflx_wat, gflx_ice,    &amp;</div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>         ep1d_water,   ep1d_ice,   tsurf_water, tsurf_ice, tsfc_wat, tisfc,       &amp;</div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span>         weasdi,       snodi,      hice,        qss_water, qss_ice,               &amp;</div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span>         cmm_water,    cmm_ice,    chh_water,   chh_ice,                          &amp;</div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>         uustar_water, uustar_ice, lake_t_snow, albedo,    zorlw,                 &amp;</div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span>         zorli,        lake_t2m,   lake_q2m,    weasd,     snowd,    fice,        &amp;</div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span>         icy,                                                                     &amp;</div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span> </div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span>         ! Lake model internal state stored by caller:</div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span> </div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span>         salty, savedtke12d, snowdp2d, h2osno2d, snl2d, t_grnd2d, t_lake3d,       &amp;</div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span>         lake_icefrac3d, t_soisno3d, h2osoi_ice3d, h2osoi_liq3d, h2osoi_vol3d,    &amp;</div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span>         z3d, dz3d, zi3d, t1, qv1, prsl1,                                         &amp;</div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span>                   input_lakedepth, clm_lakedepth, cannot_freeze,                 &amp;</div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span> </div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span>         ! Error reporting:</div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>         errflg, errmsg)</div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span> </div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span>      <span class="comment">!==============================================================================</span></div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span>      <span class="comment">! This subroutine was first edited by Hongping Gu and Jiming Jin for coupling</span></div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span>      <span class="comment">! 07/20/2010</span></div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span>      <span class="comment">! Long after, in June 2022, Sam Trahan updated it for CCPP</span></div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span>      <span class="comment">!==============================================================================</span></div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span> </div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span>    <span class="keywordtype">IMPLICIT NONE</span></div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span>    </div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span>    <span class="comment">! Model time and metadata:</span></div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span>    <span class="keywordtype">LOGICAL</span> , <span class="keywordtype">INTENT (IN)</span> :: flag_restart</div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span>    <span class="keywordtype">INTEGER</span> , <span class="keywordtype">INTENT (IN)</span> :: im,km,me,master</div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span> :: idate(4), kdt</div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span><span class="keywordtype">    REAL</span>(kind_phys), <span class="keywordtype">INTENT(IN)</span> :: fhour</div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span> :: lkm</div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span> </div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span>    <span class="comment">! Configuration and initialization:</span></div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(IN)</span> :: iopt_lake, iopt_lake_clm</div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span><span class="keywordtype">    REAL</span>(kind_phys), <span class="keywordtype">INTENT(IN)</span>  :: min_lakeice, lakedepth_default, dtp</div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>    <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span> :: use_lakedepth</div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(IN)</span> :: use_lake_model</div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span><span class="keywordtype">    REAL</span>(kind_phys), <span class="keywordtype">INTENT(INOUT)</span> :: clm_lake_initialized(:)</div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span>    <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(IN)</span> :: frac_grid, frac_ice, use_cdeps_data</div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span><span class="keywordtype">    REAL</span>(kind_phys), <span class="keywordtype">INTENT(IN)</span>, <span class="keywordtype">OPTIONAL</span> :: mask_dat(:)</div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span> </div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span> </div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span>    <span class="comment">! Atmospheric model state inputs:</span></div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span><span class="keywordtype">    REAL</span>(kind_phys), <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(IN)</span>:: &amp;</div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>         tg3, pgr, zlvl, qvcurr, xlat_d, xlon_d, ch, cm, &amp;</div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>         dlwsfci, dswsfci, oro_lakedepth, wind, &amp;</div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span>         t1, qv1, prsl1</div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span><span class="keywordtype">    REAL</span>(kind_phys), <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(IN)</span> :: &amp;</div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span>         rainncprv, raincprv</div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span><span class="keywordtype">    REAL</span>(kind_phys), <span class="keywordtype">DIMENSION(:,:)</span>, <span class="keywordtype">INTENT(in)</span> :: gu0, gv0, prsi, gt0, phii</div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span>    <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(IN)</span> :: flag_iter</div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span>    <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(INOUT)</span> :: flag_lakefreeze</div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span> </div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(IN)</span> :: isltyp</div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span> </div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>    <span class="comment">! Feedback to atmosphere:</span></div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span><span class="keywordtype">    REAL</span>(kind_phys), <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(INOUT)</span> :: &amp;</div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>         evap_wat,     evap_ice,   hflx_wat,    hflx_ice,  gflx_wat, gflx_ice,    &amp;</div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span>         ep1d_water,   ep1d_ice,   tsurf_water, tsurf_ice, tsfc_wat, tisfc, tsfc, &amp;</div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span>         weasdi,       snodi,      hice,        qss_water, qss_ice,               &amp;</div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span>         cmm_water,    cmm_ice,    chh_water,   chh_ice,                          &amp;</div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span>         uustar_water, uustar_ice, zorlw,       zorli,     weasd,    snowd, fice</div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span><span class="keywordtype">    REAL</span>(kind_phys), <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(INOUT)</span>  ::                              &amp;</div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>         lake_t_snow, <a class="code hl_function" href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a>, lake_t2m, lake_q2m</div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span>    <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT(INOUT)</span> :: icy(:)</div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span> </div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span>    <span class="comment">! Lake model internal state stored by caller:</span></div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">DIMENSION( : )</span>, <span class="keywordtype">INTENT(INOUT)</span> :: salty</div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">DIMENSION( : )</span>, <span class="keywordtype">INTENT(INOUT)</span> :: cannot_freeze</div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span> </div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span><span class="keywordtype">    real</span>(kind_phys),           <span class="keywordtype">dimension(: )</span>      ,<span class="keywordtype">intent(inout)</span>            :: savedtke12d,    &amp;</div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>                                                                               snowdp2d,       &amp;    </div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span>                                                                               h2osno2d,       &amp;    </div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>                                                                               snl2d,          &amp;    </div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span>                                                                               t_grnd2d</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span>    </div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span><span class="keywordtype">    real</span>(kind_phys),    <span class="keywordtype">dimension( :,: )</span>,  <span class="keywordtype">INTENT(inout)</span>  :: t_lake3d,       &amp;    </div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span>                                                                                  lake_icefrac3d</div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span><span class="keywordtype">    real</span>(kind_phys),    <span class="keywordtype">dimension( :,-nlevsnow+1: )</span>  ,<span class="keywordtype">INTENT(inout)</span>            :: t_soisno3d,     &amp;    </div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span>                                                                                  h2osoi_ice3d,   &amp;    </div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>                                                                                  h2osoi_liq3d,   &amp;    </div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>                                                                                  h2osoi_vol3d,   &amp;    </div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>                                                                                  z3d,            &amp;    </div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span>                                                                                  dz3d </div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span><span class="keywordtype">    real</span>(kind_phys),    <span class="keywordtype">dimension( :,-nlevsnow+0: )</span>  ,<span class="keywordtype">INTENT(inout)</span>  :: zi3d    </div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span> </div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span><span class="keywordtype">    REAL</span>(kind_phys),           <span class="keywordtype">DIMENSION( : )</span>  ,<span class="keywordtype">INTENT(INOUT)</span> :: clm_lakedepth</div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span><span class="keywordtype">    REAL</span>(kind_phys),           <span class="keywordtype">DIMENSION( : )</span>  ,<span class="keywordtype">INTENT(INOUT)</span> :: input_lakedepth</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span> </div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>    <span class="comment">! Error reporting:</span></div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(OUT)</span> :: errflg</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span>    <span class="keywordtype">CHARACTER(*)</span>, <span class="keywordtype">INTENT(OUT)</span> :: errmsg</div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span> </div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span>       </div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span> </div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>    <span class="comment">!local variables:</span></div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>    <span class="comment">!</span></div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span> </div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span><span class="keywordtype">    REAL</span>(kind_lake)     :: sfctmp,pbot,psfc,q2k,lwdn,prcp,soldn,solnet,dtime</div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>    <span class="keywordtype">INTEGER</span>  :: c,i,j,k</div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span> </div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span> </div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span>      <span class="comment">!temporary varibles in:</span></div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span><span class="keywordtype">      real</span>(kind_lake)  :: forc_t(1)          <span class="comment">! atmospheric temperature (Kelvin)</span></div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span><span class="keywordtype">      real</span>(kind_lake)  :: forc_pbot(1)       <span class="comment">! atm bottom level pressure (Pa) </span></div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span><span class="keywordtype">      real</span>(kind_lake)  :: forc_psrf(1)       <span class="comment">! atmospheric surface pressure (Pa)</span></div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span><span class="keywordtype">      real</span>(kind_lake)  :: forc_hgt(1)        <span class="comment">! atmospheric reference height (m)</span></div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span><span class="keywordtype">      real</span>(kind_lake)  :: forc_hgt_q(1)      <span class="comment">! observational height of humidity [m]</span></div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span><span class="keywordtype">      real</span>(kind_lake)  :: forc_hgt_t(1)      <span class="comment">! observational height of temperature [m]</span></div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span><span class="keywordtype">      real</span>(kind_lake)  :: forc_hgt_u(1)      <span class="comment">! observational height of wind [m]</span></div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span><span class="keywordtype">      real</span>(kind_lake)  :: forc_q(1)          <span class="comment">! atmospheric specific humidity (kg/kg)</span></div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span><span class="keywordtype">      real</span>(kind_lake)  :: forc_u(1)          <span class="comment">! atmospheric wind speed in east direction (m/s)</span></div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span><span class="keywordtype">      real</span>(kind_lake)  :: forc_v(1)          <span class="comment">! atmospheric wind speed in north direction (m/s)</span></div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span><span class="keywordtype">      real</span>(kind_lake)  :: forc_lwrad(1)      <span class="comment">! downward infrared (longwave) radiation (W/m**2)</span></div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span><span class="keywordtype">      real</span>(kind_lake)  :: prec(1)            <span class="comment">! snow or rain rate [mm/s]</span></div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span><span class="keywordtype">      real</span>(kind_lake)  :: sabg(1)            <span class="comment">! solar radiation absorbed by ground (W/m**2)</span></div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span><span class="keywordtype">      real</span>(kind_lake)  :: lat(1)             <span class="comment">! latitude (radians)</span></div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span><span class="keywordtype">      real</span>(kind_lake)  :: z_lake(1,nlevlake)  <span class="comment">! layer depth for lake (m)</span></div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span><span class="keywordtype">      real</span>(kind_lake)  :: dz_lake(1,nlevlake)                  <span class="comment">! layer thickness for lake (m)</span></div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span> </div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span><span class="keywordtype">      real</span>(kind_lake)  :: lakedepth(1)       <span class="comment">! column lake depth (m)</span></div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span>      <span class="keywordtype">logical</span>   :: do_capsnow(1)     <span class="comment">! true =&gt; do snow capping</span></div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span> </div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span>      <span class="comment">!in&amp;out</span></div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span><span class="keywordtype">      real</span>(kind_lake)  :: h2osoi_vol(1,-nlevsnow+1:nlevsoil)  <span class="comment">! volumetric soil water (0&lt;=h2osoi_vol&lt;=watsat)[m3/m3]</span></div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span><span class="keywordtype">      real</span>(kind_lake)  :: t_grnd(1)          <span class="comment">! ground temperature (Kelvin)</span></div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span><span class="keywordtype">      real</span>(kind_lake)  :: h2osno(1)          <span class="comment">! snow water (mm H2O)</span></div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span><span class="keywordtype">      real</span>(kind_lake)  :: snowdp(1)          <span class="comment">! snow height (m)</span></div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span><span class="keywordtype">      real</span>(kind_lake)  :: z(1,-nlevsnow+1:nlevsoil)             <span class="comment">! layer depth for snow &amp; soil (m)</span></div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span><span class="keywordtype">      real</span>(kind_lake)  :: dz(1,-nlevsnow+1:nlevsoil)            <span class="comment">! layer thickness for soil or snow (m)</span></div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span><span class="keywordtype">      real</span>(kind_lake)  :: t_soisno(1,-nlevsnow+1:nlevsoil)      <span class="comment">! soil (or snow) temperature (Kelvin)</span></div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span><span class="keywordtype">      real</span>(kind_lake)  :: t_lake(1,nlevlake)                   <span class="comment">! lake temperature (Kelvin)</span></div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span>      <span class="keywordtype">integer</span>   :: snl(1)                              <span class="comment">! number of snow layers</span></div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span><span class="keywordtype">      real</span>(kind_lake)  :: h2osoi_liq(1,-nlevsnow+1:nlevsoil)    <span class="comment">! liquid water (kg/m2)</span></div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span><span class="keywordtype">      real</span>(kind_lake)  :: h2osoi_ice(1,-nlevsnow+1:nlevsoil)    <span class="comment">! ice lens (kg/m2)</span></div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span><span class="keywordtype">      real</span>(kind_lake)  :: savedtke1(1)       <span class="comment">! top level eddy conductivity from previous timestep (W/m.K)</span></div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span><span class="keywordtype">      real</span>(kind_lake)  :: zi(1,-nlevsnow+0:nlevsoil)            <span class="comment">! interface level below a &quot;z&quot; level (m)</span></div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span><span class="keywordtype">      real</span>(kind_lake)  :: lake_icefrac(1,nlevlake)  <span class="comment">! mass fraction of lake layer that is frozen</span></div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span> </div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span> </div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span>      <span class="comment">!out:</span></div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span><span class="keywordtype">      real</span>(kind_lake)  :: eflx_gnet(1)       <span class="comment">!net heat flux into ground (W/m**2)</span></div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span><span class="keywordtype">      real</span>(kind_lake)  :: eflx_lwrad_net(1)  <span class="comment">! net infrared (longwave) rad (W/m**2) [+ = to atm]</span></div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span><span class="keywordtype">      real</span>(kind_lake)  :: eflx_sh_tot(1)     <span class="comment">! total sensible heat flux (W/m**2) [+ to atm]</span></div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span><span class="keywordtype">      real</span>(kind_lake)  :: eflx_lh_tot(1)     <span class="comment">! total latent heat flux (W/m8*2)  [+ to atm]</span></div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span><span class="keywordtype">      real</span>(kind_lake)  :: t_ref2m(1)         <span class="comment">! 2 m height surface air temperature (Kelvin)</span></div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span><span class="keywordtype">      real</span>(kind_lake)  :: q_ref2m(1)         <span class="comment">! 2 m height surface specific humidity (kg/kg)</span></div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span><span class="keywordtype">      real</span>(kind_lake)  :: taux(1)            <span class="comment">! wind (shear) stress: e-w (kg/m/s**2)</span></div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span><span class="keywordtype">      real</span>(kind_lake)  :: tauy(1)            <span class="comment">! wind (shear) stress: n-s (kg/m/s**2)</span></div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span><span class="keywordtype">      real</span>(kind_lake)  :: ram1(1)            <span class="comment">! aerodynamical resistance (s/m)</span></div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span>                                               <span class="comment">! for calculation of decay of eddy diffusivity with depth</span></div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>                                               <span class="comment">! Change the type variable to pass back to WRF.</span></div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span><span class="keywordtype">      real</span>(kind_lake)  :: z0mg(1)            <span class="comment">! roughness length over ground, momentum (m(</span></div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span><span class="keywordtype">      real</span>(kind_lake)  :: qfx                <span class="comment">! mass flux, old WRF qfx(:) variable, (kg/(sm^2))</span></div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span> </div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span><span class="keywordtype">      real</span>(kind_lake) :: ustar_out(1)        <span class="comment">! friction velocity (temporary) [m/s]</span></div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span> </div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span><span class="keywordtype">      real</span>(kind_lake) :: discard1, discard2, discard3 <span class="comment">! for unused temporary data</span></div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span> </div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span><span class="keywordtype">      real</span>(kind_lake) :: watsat(1,nlevsoil)      <span class="comment">! volumetric soil water at saturation (porosity)</span></div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span><span class="keywordtype">      real</span>(kind_lake) :: tksatu(1,nlevsoil)      <span class="comment">! thermal conductivity, saturated soil [W/m-K]</span></div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span><span class="keywordtype">      real</span>(kind_lake) :: tkmg(1,nlevsoil)        <span class="comment">! thermal conductivity, soil minerals  [W/m-K]</span></div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span><span class="keywordtype">      real</span>(kind_lake) :: tkdry(1,nlevsoil)       <span class="comment">! thermal conductivity, dry soil (W/m/Kelvin)</span></div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span><span class="keywordtype">      real</span>(kind_lake) :: csol(1,nlevsoil)        <span class="comment">! heat capacity, soil solids (J/m**3/Kelvin)</span></div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span> </div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span><span class="comment">!      real(kind_lake)  :: emiss             ! surface emissivity</span></div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span> </div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span>      <span class="keywordtype">integer</span> :: lake_points, snow_points, ice_points</div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span>      <span class="keywordtype">character*255</span> :: message</div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span>      <span class="keywordtype">logical</span>, <span class="keywordtype">parameter</span> :: feedback_to_atmosphere = .true. <span class="comment">! FIXME: REMOVE</span></div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span> </div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span><span class="keywordtype">      real</span>(kind_lake) :: to_radians, lat_d, lon_d, qss, tkm, bd</div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span><span class="keywordtype">      real</span>(kind_lake) :: rho0                    <span class="comment">! lowest model level air density</span></div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span> </div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span>      <span class="keywordtype">integer</span> :: month,num1,num2,day_of_month,isl</div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span><span class="keywordtype">      real</span>(kind_lake) :: wght1,wght2,tclim,depthratio</div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span> </div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span>      <span class="keywordtype">logical</span> salty_flag, cannot_freeze_flag</div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span> </div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span>      errmsg = <span class="stringliteral">&#39; &#39;</span></div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span>      errflg = 0</div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span> </div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span>      <span class="keywordflow">if</span>(iopt_lake/=iopt_lake_clm .or. lkm==0 .or. all(use_lake_model==0)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span>        <span class="keywordflow">return</span> <span class="comment">! nothing to do</span></div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span> </div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span>      dtime=dtp</div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span> </div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span>        <span class="comment">! Initialize any uninitialized lake points.</span></div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span>        <span class="keyword">call </span>lakeini(kdt=kdt, isltyp=isltyp, gt0=gt0, snowd=snowd, weasd=weasd,           &amp;</div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span>                              lakedepth_default=lakedepth_default, fhour=fhour,           &amp;</div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span>             oro_lakedepth=oro_lakedepth, savedtke12d=savedtke12d, snowdp2d=snowdp2d,     &amp;</div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span>             h2osno2d=h2osno2d, snl2d=snl2d, t_grnd2d=t_grnd2d, t_lake3d=t_lake3d,        &amp;</div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span>             lake_icefrac3d=lake_icefrac3d,                                               &amp;</div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span>             t_soisno3d=t_soisno3d, h2osoi_ice3d=h2osoi_ice3d, h2osoi_liq3d=h2osoi_liq3d, &amp;</div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span>             h2osoi_vol3d=h2osoi_vol3d, z3d=z3d, dz3d=dz3d, zi3d=zi3d,                    &amp;</div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span>                                           fice=fice, hice=hice, min_lakeice=min_lakeice, &amp;</div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span>             tsfc=tsfc,                                                                   &amp;</div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span>             use_lake_model=use_lake_model, use_lakedepth=use_lakedepth,                  &amp;</div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span>                                im=im, prsi=prsi, xlat_d=xlat_d, xlon_d=xlon_d,           &amp;</div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span>             clm_lake_initialized=clm_lake_initialized, input_lakedepth=input_lakedepth,  &amp;</div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span>             tg3=tg3, clm_lakedepth=clm_lakedepth, km=km, me=me, master=master,           &amp;</div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span>             errmsg=errmsg, errflg=errflg)</div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span>        <span class="keywordflow">if</span>(errflg/=0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>          <span class="keywordflow">return</span></div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span> </div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span>      lake_points=0</div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span>      snow_points=0</div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>      ice_points=0</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span> </div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>      to_radians = pi/180</div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span> </div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>      month = idate(2)</div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>      day_of_month = idate(3)</div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span> </div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span>        num1 = month*2-1</div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>        <span class="keywordflow">if</span>(day_of_month&gt;15) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span>          num1 = num1 + 1</div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span>        num2 = num1+1</div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span> </div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>        wght2 = day_of_month/month_length(month)</div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>        <span class="keywordflow">if</span>(wght2&lt;0 .or. wght2&gt;1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span>          <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span>            <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;Warning: wght2 is not 0..1: &#39;</span>,wght2</div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span>          wght2 = max(0.0_kind_lake,min(1.0_kind_lake,wght2))</div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span>        wght1 = 1.0_kind_lake - wght2</div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span>  </div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span>        <span class="keywordflow">if</span>(debug_print ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span>          print *,<span class="stringliteral">&#39;month,num1,num2,wght1,wght2&#39;</span>,month,num1,num2,wght1,wght2</div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span>      </div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span>        lake_top_loop: <span class="keywordflow">DO</span> i = 1,im</div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span> </div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span>        if_lake_is_here: <span class="keywordflow">if</span> (flag_iter(i) .and. use_lake_model(i)/=0) <span class="keywordflow">THEN</span></div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span> </div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span>          <span class="keyword">call </span>is_salty(xlat_d(i),xlon_d(i),salty_flag,cannot_freeze_flag)</div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span> </div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span>           <span class="keywordflow">if</span>(salty_flag) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span>              salty(i) = 1 <span class="comment">! The Great Salt Lake and Mono Lake</span></div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span>           <span class="keywordflow">else</span></div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span>              salty(i) = 0</div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span><span class="keywordflow">           endif</span></div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span> </div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span>           <span class="keywordflow">if</span>(cannot_freeze_flag) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span>              cannot_freeze(i) = 1 <span class="comment">! only the Great Salt Lake</span></div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span>           <span class="keywordflow">else</span></div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span>              cannot_freeze(i) = 0</div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span><span class="keywordflow">           endif</span></div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span> </div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span>           sfctmp  = gt0(i,1)</div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span>           pbot    = prsi(i,1)</div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span>           psfc    = pgr(i)</div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span>           q2k     = qvcurr(i)</div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span><span class="comment">!           EMISS   = 0.99 * lake_icefrac3d(i,1) +  emg * (1.0-lake_icefrac3d(i,1)) ! emg=0.97, parameter, needs to be moved to the top</span></div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span>           lwdn    = dlwsfci(i) <span class="comment">! LWDN is downward LW flux, do not use EMISS here.</span></div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span><span class="comment">!           LWDN    = DLWSFCI(I)*EMISS(I)</span></div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span>           <span class="comment">! FIXME: Should multiply PRCP by 1000</span></div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span>           prcp    = (raincprv(i)+rainncprv(i))/dtime  <span class="comment">! [mm/s] use physics timestep since PRCP comes from non-surface schemes</span></div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span>           soldn   = dswsfci(i)                        <span class="comment">! SOLDN is total incoming solar</span></div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span>           <a class="code hl_function" href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a>(i) = ( 0.6 * lake_icefrac3d(i,1) ) +  &amp;</div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span>                       ( (1.0-lake_icefrac3d(i,1)) * 0.08)</div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span>           solnet  = soldn*(1.-<a class="code hl_function" href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a>(i))              <span class="comment">! use mid-day albedo to determine net downward solar</span></div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span>                                                       <span class="comment">! (no solar zenith angle correction) </span></div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span> </div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span>           lake_points = lake_points+1</div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span> </div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span>           <span class="keyword">call </span>calculate_z_dz_lake(i,input_lakedepth,clm_lakedepth,z_lake(1,:),dz_lake(1,:))</div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span> </div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span>           <span class="keywordflow">do</span> c = 2,column</div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span>             z_lake(c,:) = z_lake(1,:)</div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span>             dz_lake(c,:) = dz_lake(1,:)</div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span><span class="keywordflow">           enddo</span></div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span> </div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span>           <span class="comment">! Soil hydraulic and thermal properties</span></div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span>           isl = isltyp(i)   </div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span>           <span class="keywordflow">if</span> (isl == 0  ) isl = 14</div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span>           <span class="keywordflow">if</span> (isl == 14 ) isl = isl + 1 </div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span> </div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span>           watsat = 0.489_kind_lake - 0.00126_kind_lake*sand(isl)</div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span>           csol   = (2.128_kind_lake*sand(isl)+2.385_kind_lake*clay(isl)) / (sand(isl)+clay(isl))*1.e6_kind_lake  <span class="comment">! J/(m3 K)</span></div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span>           tkm    = (8.80_kind_lake*sand(isl)+2.92_kind_lake*clay(isl))/(sand(isl)+clay(isl))          <span class="comment">! W/(m K)</span></div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span>           bd     = (1._kind_lake-watsat(1,1))*2.7e3_kind_lake</div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span>           tkmg   = tkm ** (1._kind_lake- watsat(1,1))</div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span>           tkdry  = (0.135_kind_lake*bd + 64.7_kind_lake) / (2.7e3_kind_lake - 0.947_kind_lake*bd)</div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span>           tksatu = tkmg(1,1)*0.57_kind_lake**watsat(1,1)</div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span> </div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span>           <span class="keywordflow">do</span> c = 1,column</div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span>     </div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span>            forc_t(c)          = sfctmp           <span class="comment">! [K]</span></div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span>            forc_pbot(c)       = pbot             <span class="comment">! [Pa]</span></div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span>            forc_psrf(c)       = psfc             <span class="comment">! [Pa]</span></div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span>            forc_hgt(c)        = zlvl(i)          <span class="comment">! [m]</span></div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span>            forc_hgt_q(c)      = zlvl(i)          <span class="comment">! [m]</span></div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span>            forc_hgt_t(c)      = zlvl(i)          <span class="comment">! [m]</span></div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span>            forc_hgt_u(c)      = zlvl(i)          <span class="comment">! [m]</span></div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span>            forc_q(c)          = q2k              <span class="comment">! [kg/kg]</span></div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span>            forc_u(c)          = gu0(i,1)         <span class="comment">! [m/s]</span></div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span>            forc_v(c)          = gv0(i,1)         <span class="comment">! [m/s]</span></div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span>            forc_lwrad(c)      = lwdn             <span class="comment">! [W/m/m]</span></div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span>            prec(c)            = prcp             <span class="comment">! [mm/s]</span></div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span>            sabg(c)            = solnet</div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span>            lat(c)             = xlat_d(i)*to_radians  <span class="comment">! [radian] </span></div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span>            do_capsnow(c)      = .false.</div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span> </div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span>            lakedepth(c)           = clm_lakedepth(i)</div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span>            savedtke1(c)           = savedtke12d(i)</div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span>            snowdp(c)              = snowdp2d(i)</div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span>            h2osno(c)              = h2osno2d(i)</div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span>            snl(c)                 = snl2d(i)</div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span>            t_grnd(c)              = t_grnd2d(i)</div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span>            <span class="keywordflow">do</span> k = 1,nlevlake</div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span>               t_lake(c,k)        = t_lake3d(i,k)</div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span>               lake_icefrac(c,k)  = lake_icefrac3d(i,k)</div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span>            <span class="keywordflow">do</span> k = -nlevsnow+1,nlevsoil</div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span>               t_soisno(c,k)      = t_soisno3d(i,k)</div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span>               h2osoi_ice(c,k)    = h2osoi_ice3d(i,k)</div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span>               h2osoi_liq(c,k)    = h2osoi_liq3d(i,k)</div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span>               h2osoi_vol(c,k)    = h2osoi_vol3d(i,k)</div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span>               z(c,k)             = z3d(i,k)</div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>               dz(c,k)            = dz3d(i,k)</div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span><span class="keywordflow">            enddo</span>   </div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span>            <span class="keywordflow">do</span> k = -nlevsnow+0,nlevsoil</div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span>               zi(c,k)            = zi3d(i,k)</div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span> </div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span>          eflx_lwrad_net = -9999</div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>          eflx_gnet = -9999</div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span>          eflx_sh_tot = -9999</div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span>          eflx_lh_tot = -9999</div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span>          t_ref2m = -9999</div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span>          q_ref2m = -9999</div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span>          taux = -9999</div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span>          tauy = -9999</div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span>          ram1 = -9999</div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span>          z0mg = -9999</div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span>          ustar_out = -9999</div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span>          lat_d = xlat_d(i)</div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span>          lon_d = xlon_d(i)</div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span> </div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>            <span class="keyword">CALL </span>lakemain(forc_t,forc_pbot,forc_psrf,forc_hgt,forc_hgt_q,   &amp; <span class="comment">!I  </span></div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span>                          forc_hgt_t,forc_hgt_u,forc_q, forc_u,         &amp;</div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>                          forc_v,forc_lwrad,prec, sabg,lat,             &amp;</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span>                          z_lake,dz_lake,lakedepth,do_capsnow,          &amp;</div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span>                          h2osno,snowdp,snl,z,dz,zi,                    &amp; <span class="comment">!H</span></div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span>                          h2osoi_vol,h2osoi_liq,h2osoi_ice,             &amp;</div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span>                          t_grnd,t_soisno,t_lake,                       &amp;</div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span>                          savedtke1,lake_icefrac,                       &amp;</div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span>                          eflx_lwrad_net,eflx_gnet,                     &amp; <span class="comment">!O </span></div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span>                          eflx_sh_tot,eflx_lh_tot,                      &amp;</div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span>                          t_ref2m,q_ref2m, dtime,                       &amp;</div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span>                          watsat, tksatu, tkmg, tkdry, csol,            &amp;</div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span>                          taux,tauy,ram1,z0mg,ustar_out,errmsg,errflg,  &amp;</div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span>                          lat_d,lon_d)</div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span>           <span class="comment">! Renew Lake State Variables:(14)</span></div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span>           <span class="keywordflow">do</span> c = 1,column</div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span> </div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span>            <span class="keywordflow">if</span>(cannot_freeze(i) == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span>            <span class="comment">!  The Great Salt Lake</span></div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span>              <span class="keywordflow">do</span> k = 1,nlevlake</div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span>                lake_icefrac(c,k) = 0._kind_lake</div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span><span class="keywordflow">              enddo</span></div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span>              <span class="comment">!  bound lake temperture with the climatology</span></div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span>              tclim = tfrz + wght1*saltlk_t(num1)  &amp;</div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span>                           + wght2*saltlk_t(num2)</div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span>              <span class="keywordflow">if</span>(debug_print) print *,<span class="stringliteral">&#39;GSL - Tclim,tsfc,t_lake3d&#39;</span>,i,tclim,t_grnd(c),t_lake(c,:),t_soisno(c,:)</div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span>              t_grnd(c) = min(tclim+3.0_kind_lake,(max(t_grnd(c),tclim-3.0_kind_lake)))</div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span>              <span class="keywordflow">do</span> k = 1,nlevlake</div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span>                t_lake(c,k) = min(tclim+3.0_kind_lake,(max(t_lake(c,k),tclim-3.0_kind_lake)))</div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span><span class="keywordflow">              enddo</span></div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span>              t_soisno(c,1) = min(tclim+3.0_kind_lake,(max(t_soisno(c,1),tclim-3.0_kind_lake)))</div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span>              <span class="keywordflow">if</span>(debug_print) print *,<span class="stringliteral">&#39;GSL - after Tclim,tsfc,t_lake3d&#39;</span>,i,tclim,t_grnd(c),t_lake(c,:),t_soisno(c,:)</div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span>            <span class="keywordflow">elseif</span>(salty(i) == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span>            <span class="comment">! Mono Lake never freezes, its temperature is above freezing point = -4.2 C</span></div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span>                t_grnd(c) = max(tfrz-4.2_kind_lake,t_grnd(c))</div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span>              <span class="keywordflow">do</span> k = 1,nlevlake</div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span>                lake_icefrac(c,k) = 0._kind_lake</div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span>                t_lake(c,k) = max(tfrz-4.2_kind_lake,t_lake(c,k))</div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span><span class="keywordflow">              enddo</span></div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span>              t_soisno(c,1) = max(tfrz-4.2_kind_lake,t_soisno(c,1))</div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span>              <span class="keywordflow">if</span>(debug_print) print *,<span class="stringliteral">&#39;Mono - tsfc,t_lake3d&#39;</span>,i,t_grnd(c),t_lake(c,:),t_soisno(c,:)</div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span><span class="keywordflow">            endif</span> </div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span>           </div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span>            savedtke12d(i)         = savedtke1(c)</div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span>            snowdp2d(i)            = snowdp(c)</div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span>            h2osno2d(i)            = h2osno(c)</div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span>            snl2d(i)               = snl(c)</div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span>            t_grnd2d(i)            = t_grnd(c)</div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span>            <span class="keywordflow">do</span> k = 1,nlevlake</div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span>               t_lake3d(i,k)       = t_lake(c,k)</div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span>               lake_icefrac3d(i,k) = lake_icefrac(c,k)</div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span>            <span class="keywordflow">do</span> k = -nlevsnow+1,nlevsoil</div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span>               z3d(i,k)            = z(c,k)</div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span>               dz3d(i,k)           = dz(c,k)</div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span>               t_soisno3d(i,k)     = t_soisno(c,k)</div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span>               h2osoi_liq3d(i,k)   = h2osoi_liq(c,k)</div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span>               h2osoi_ice3d(i,k)   = h2osoi_ice(c,k)</div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span>               h2osoi_vol3d(i,k)   = h2osoi_vol(c,k)</div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span><span class="keywordflow">           enddo</span></div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span>           <span class="keywordflow">do</span> k = -nlevsnow+0,nlevsoil</div>
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno">  699</span>               zi3d(i,k)           = zi(c,k)</div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span><span class="keywordflow">           enddo</span></div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span>            </div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span><span class="keywordflow">         enddo</span></div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span>         </div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span>            feedback: <span class="keywordflow">if</span>(feedback_to_atmosphere) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span>                c = 1</div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span> </div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span>                <span class="comment">!-- The CLM output is combined for fractional ice and water</span></div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span>                <span class="keywordflow">if</span>( t_grnd(c) &gt;= tfrz ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span>                  qfx           = eflx_lh_tot(c)*invhvap</div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span>                  qfx           = eflx_lh_tot(c)*invhsub      <span class="comment">! heat flux (W/m^2)=&gt;mass flux(kg/(sm^2))</span></div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span><span class="keywordflow">                endif</span></div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span>                rho0            = prsl1(i) / (rair*t1(i)*(1.0 + con_fvirt*qv1(i)))</div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span>                evap_wat(i)     = qfx/rho0                    <span class="comment">! kinematic_surface_upward_latent_heat_flux_over_water</span></div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span>                hflx_wat(i)     = eflx_sh_tot(c)/(rho0*cpair) <span class="comment">! kinematic_surface_upward_sensible_heat_flux_over_water</span></div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span>                gflx_wat(i)     = eflx_gnet(c)              <span class="comment">![W/m/m]   upward_heat_flux_in_soil_over_water</span></div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span>                ep1d_water(i)   = eflx_lh_tot(c)            <span class="comment">![W/m/m]   surface_upward_potential_latent_heat_flux_over_water</span></div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span>                <span class="comment">!don&#39;t overwrite surface skin temperature over ice, sea ice area fraction, skin temperature over water when using CDEPS inline over the mask</span></div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span>                <span class="keywordflow">if</span> (use_cdeps_data) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span>                  <span class="keywordflow">if</span> (mask_dat(i) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span>                    tsfc_wat(i)     = t_grnd(c)                 <span class="comment">![K]       surface skin temperature over water</span></div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span>                    tisfc(i)        = t_grnd(c)</div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span>                    fice(i)         = lake_icefrac3d(i,1)       <span class="comment">! sea_ice_area_fraction_of_sea_area_fraction</span></div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span>                    tsurf_water(i)  = t_grnd(c)                 <span class="comment">![K]       surface skin temperature after iteration over water</span></div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span>                    tsurf_ice(i)    = t_grnd(c)                 <span class="comment">! surface_skin_temperature_after_iteration_over_ice</span></div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span><span class="keywordflow">                  endif</span></div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span>                  tsfc_wat(i)     = t_grnd(c)                 <span class="comment">![K]       surface skin temperature over water</span></div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span>                  tisfc(i)        = t_grnd(c)</div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span>                  fice(i)         = lake_icefrac3d(i,1)       <span class="comment">! sea_ice_area_fraction_of_sea_area_fraction</span></div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span>                  tsurf_water(i)  = t_grnd(c)                 <span class="comment">![K]       surface skin temperature after iteration over water</span></div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>                  tsurf_ice(i)    = t_grnd(c)                 <span class="comment">! surface_skin_temperature_after_iteration_over_ice</span></div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span><span class="keywordflow">                endif</span></div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span>                tsfc(i)         = t_grnd(c)</div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span>                lake_t2m(i)     = t_ref2m(c)                <span class="comment">![K]       temperature_at_2m_from_clm_lake</span></div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span>                lake_q2m(i)     = q_ref2m(c)                <span class="comment">! [frac] specific_humidity_at_2m_from_clm_lake</span></div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span>                <a class="code hl_function" href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a>(i)       = ( 0.6 * lake_icefrac3d(i,1) ) + &amp;  <span class="comment">! mid_day_surface_albedo_over_lake</span></div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span>                                  ( (1.0-lake_icefrac3d(i,1)) * 0.08)</div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span>                <span class="comment">!uustar_water(i) = ustar_out(c)              ! surface_friction_velocity_over_water</span></div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span>                zorlw(i) = z0mg(c)                          <span class="comment">! surface_roughness_length_over_water</span></div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span> </div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span>                <span class="comment">! WRF variables with no equivalent in CCPP:</span></div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span>                <span class="comment">! LH(I)         = eflx_lh_tot(c)/rho1(i)    ![kg*m/(kg*s)]</span></div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span>                <span class="comment">!TH2(I)         = T2(I)*(1.E5/PSFC)**RCP    ! potential temperature</span></div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span> </div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span>                <span class="comment">! Calculate qsfc from t_grnd:               ! surface_specific_humidity_over_water</span></div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span>                psfc = prsi(i,1) </div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span>                discard1 = -9999</div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span>                discard2 = -9999</div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span>                discard3 = -9999</div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span>                qss = qss_water(i)</div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span>                <span class="keyword">call </span>qsat(t_grnd(c),psfc,discard1,discard2,qss,discard3)</div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span>                qss_water(i) = qss</div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span> </div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span>                <span class="comment">! Combined water-ice chh and cmm calculations come from Flake model:</span></div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span>                chh_water(i)    = ch(i)*wind(i)*1.225       <span class="comment">! surface_drag_mass_flux_for_heat_and_moisture_in_air_over_water</span></div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span>                cmm_water(i)    = cm(i)*wind(i)             <span class="comment">! surface_drag_wind_speed_for_momentum_in_air_over_water</span></div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span> </div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span>                ice_point: <span class="keywordflow">if</span>(fice(i)&gt;=min_lakeice) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span>                  <span class="comment">! Icy lake</span></div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno">  761</span>                  <span class="comment">! Most ice variables are identical to water variables.</span></div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span>                  <span class="keywordflow">if</span>(debug_print) print *,<span class="stringliteral">&#39;Icy xlat_d(i),xlon_d(i),frac_ice,frac_grid &#39;</span>,xlat_d(i),xlon_d(i),frac_ice,frac_grid</div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span>                  <span class="keywordflow">if</span>(frac_ice .or. frac_grid) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span>                    evap_ice(i)   = evap_wat(i)               <span class="comment">! kinematic_surface_upward_latent_heat_flux_over_ice</span></div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span>                    hflx_ice(i)   = hflx_wat(i)               <span class="comment">! kinematic_surface_upward_sensible_heat_flux_over_ice</span></div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span>                    gflx_ice(i)   = gflx_wat(i)               <span class="comment">! upward_heat_flux_in_soil_over_ice</span></div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span>                    ep1d_ice(i)   = ep1d_water(i)             <span class="comment">! surface_upward_potential_latent_heat_flux_over_ice</span></div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span>                    chh_ice(i)    = chh_water(i)              <span class="comment">! surface_drag_mass_flux_for_heat_and_moisture_in_air_over_ice</span></div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span>                    cmm_ice(i)    = cmm_water(i)              <span class="comment">! surface_drag_wind_speed_for_momentum_in_air_over_ice</span></div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span>                    qss_ice(i)    = qss_water(i)              <span class="comment">! surface_specific_humidity_over_ice</span></div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span><span class="comment">!                    uustar_ice(i) = uustar_water(i)           ! surface_friction_velocity_over_ice</span></div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span><span class="keywordflow">                  endif</span></div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span> </div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span>                  <span class="comment">!don&#39;t overwrite surface skin temperature over ice when using CDEPS inline over the mask</span></div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span>                  <span class="keywordflow">if</span> (use_cdeps_data) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span>                    <span class="keywordflow">if</span> (mask_dat(i) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span>                      tisfc(i)        = t_grnd(c)</div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span>                      tsurf_ice(i)  = t_grnd(c)                 <span class="comment">! surface_skin_temperature_after_iteration_over_ice</span></div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span><span class="keywordflow">                    endif</span></div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span>                  <span class="keywordflow">else</span></div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span>                    tisfc(i)        = t_grnd(c)</div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span>                    tsurf_ice(i)  = t_grnd(c)                 <span class="comment">! surface_skin_temperature_after_iteration_over_ice</span></div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span><span class="keywordflow">                  endif</span></div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span>                  tsfc(i)       = t_grnd(c)                 <span class="comment">! surface_skin_temperature_over_ice</span></div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span>                  weasdi(i)     = h2osno(c)                 <span class="comment">! water_equivalent_accumulated_snow_depth_over_ice</span></div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span>                  snodi(i)      = snowdp(c)*1.e3            <span class="comment">! surface_snow_thickness_water_equivalent_over_ice</span></div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span>                  weasd(i)      = weasdi(i)</div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span>                  snowd(i)      = snodi(c)                  <span class="comment">! surface_snow_thickness_water_equivalent_over_ice</span></div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span> </div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span> </div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span>                  <span class="keywordflow">if</span> (.not. icy(i)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span>                     flag_lakefreeze(i)=.true.</div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span><span class="keywordflow">                  end if</span></div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span> </div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span>                  <span class="comment">! Ice points are icy:</span></div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span>                  icy(i)=.true.                             <span class="comment">! flag_nonzero_sea_ice_surface_fraction</span></div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>                  ice_points = ice_points+1</div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span> </div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span>                  zorli(i) = z0mg(c)                        <span class="comment">! surface_roughness_length_over_ice</span></div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span> </div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span>                  <span class="comment">! Assume that, if a layer has ice, the entire layer thickness is ice.</span></div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span>                  <span class="comment">!don&#39;t overwrite sea ice thickness when using CDEPS inline over the mask</span></div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span>                  <span class="keywordflow">if</span> (use_cdeps_data) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span>                    <span class="keywordflow">if</span> (mask_dat(i) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span>                      hice(i) = 0                               <span class="comment">! sea_ice_thickness</span></div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span>                      <span class="keywordflow">do</span> k=1,nlevlake</div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span>                        <span class="keywordflow">if</span>(lake_icefrac3d(i,k)&gt;0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>                          hice(i) = hice(i) + dz_lake(c,k)</div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span><span class="keywordflow">                        endif</span></div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span><span class="keywordflow">                      end do</span></div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span><span class="keywordflow">                    endif</span></div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span>                  <span class="keywordflow">else</span></div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span>                    hice(i) = 0                               <span class="comment">! sea_ice_thickness</span></div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span>                    <span class="keywordflow">do</span> k=1,nlevlake</div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span>                      <span class="keywordflow">if</span>(lake_icefrac3d(i,k)&gt;0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span>                        hice(i) = hice(i) + dz_lake(c,k)</div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span><span class="keywordflow">                      endif</span></div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span><span class="keywordflow">                    end do</span></div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span><span class="keywordflow">                  endif</span></div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span>                  </div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span>                <span class="keywordflow">else</span> <span class="comment">! Not an ice point</span></div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span>                  <span class="comment">! On non-icy lake points, set variables relevant to</span></div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span>                  <span class="comment">! lake ice to reasonable defaults.  Let LSM fill in</span></div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span>                  <span class="comment">! other variables.</span></div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span>                  icy(i)=.false.</div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span>                  weasdi(i) = 0</div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span>                  snodi(i) = 0</div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span>                  weasd(i) = 0</div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span>                  snowd(i) = 0</div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span>                  <span class="comment">!don&#39;t overwrite surface skin temperature over ice when using CDEPS inline over the mask</span></div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span>                  <span class="keywordflow">if</span> (use_cdeps_data) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span>                    <span class="keywordflow">if</span> (mask_dat(i) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span>                      tisfc(i)        = t_grnd(c)</div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span>                      tsurf_ice(i)    = tisfc(i)</div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span><span class="keywordflow">                    endif</span></div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span>                  <span class="keywordflow">else</span></div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span>                    tisfc(i)        = t_grnd(c)</div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>                    tsurf_ice(i) = tisfc(i)</div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span><span class="keywordflow">                  endif</span></div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span>                  tsfc(i) = t_grnd(c)</div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span>                  <span class="comment">!don&#39;t overwrite sea ice thickness when using CDEPS inline over the mask</span></div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span>                  <span class="keywordflow">if</span> (use_cdeps_data) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span>                    <span class="keywordflow">if</span> (mask_dat(i) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span>                      hice(i) = 0</div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span>                      fice(i) = 0</div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span><span class="keywordflow">                    endif</span></div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span>                  <span class="keywordflow">else</span></div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span>                    hice(i) = 0</div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span>                    fice(i) = 0</div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span><span class="keywordflow">                  endif</span></div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span><span class="keywordflow">                endif</span> ice_point</div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span> </div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span>                <span class="keywordflow">if</span>(snl2d(i)&lt;0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span>                  <span class="comment">! If there is snow, ice surface temperature should be snow temperature.</span></div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span>                  lake_t_snow(i) = t_grnd(c)                <span class="comment">! surface_skin_temperature_over_ice</span></div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>                  <span class="comment">!don&#39;t overwrite surface skin temperature over ice when using CDEPS inline over the mask</span></div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>                  <span class="keywordflow">if</span> (use_cdeps_data) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>                    <span class="keywordflow">if</span> (mask_dat(i) &lt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span>                      tisfc(i) = lake_t_snow(i)                 <span class="comment">! temperature_of_snow_on_lake</span></div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span><span class="keywordflow">                    endif</span></div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span>                  <span class="keywordflow">else</span></div>
<div class="line"><a id="l00862" name="l00862"></a><span class="lineno">  862</span>                    tisfc(i) = lake_t_snow(i)                 <span class="comment">! temperature_of_snow_on_lake</span></div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span><span class="keywordflow">                  endif</span></div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span>                  snow_points = snow_points+1</div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno">  865</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span>                  lake_t_snow(i) = -9999</div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span><span class="keywordflow">                endif</span></div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span> </div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span><span class="keywordflow">            endif</span> feedback</div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span>        </div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span><span class="keywordflow">        endif</span> if_lake_is_here</div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span><span class="keywordflow">        ENDDO</span> lake_top_loop</div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span> </div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span>        <span class="keywordflow">if</span>(debug_print .and. lake_points&gt;0 .and. (kdt&lt;3 .or. mod(kdt,30)==3)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span>3082       <span class="keyword">format</span>(<span class="stringliteral">&#39;lake points processed in timestep &#39;</span>,i0,<span class="stringliteral">&#39; by rank &#39;</span>,i0,<span class="stringliteral">&#39; = &#39;</span>,i0,<span class="stringliteral">&#39; snow=&#39;</span>,i0,<span class="stringliteral">&#39; ice=&#39;</span>,i0)</div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span>           print 3082,kdt,me,lake_points,snow_points,ice_points</div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno">  878</span> </div>
</div>
<div class="line"><a id="l00879" name="l00879"></a><span class="lineno">  879</span>    <span class="keyword">END SUBROUTINE </span>clm_lake_run</div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span> </div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span> </div>
<div class="foldopen" id="foldopen00882" data-start="" data-end="">
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ad11c9e87b1be147aa2076463a7ee3dfc.html#ad11c9e87b1be147aa2076463a7ee3dfc">  882</a></span>    <span class="keyword">SUBROUTINE </span>lakemain(forc_t,forc_pbot,forc_psrf,forc_hgt,forc_hgt_q,     &amp; !I  </div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span>                          forc_hgt_t,forc_hgt_u,forc_q, forc_u,         &amp;   </div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span>                          forc_v,forc_lwrad,prec, sabg,lat,             &amp;   </div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span>                          z_lake,dz_lake,lakedepth,do_capsnow,          &amp;</div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span>                          h2osno,snowdp,snl,z,dz,zi,                    &amp; !H</div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno">  887</span>                          h2osoi_vol,h2osoi_liq,h2osoi_ice,             &amp;</div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span>                          t_grnd,t_soisno,t_lake,                       &amp;  </div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span>                          savedtke1,lake_icefrac,                       &amp;</div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span>                          eflx_lwrad_net,eflx_gnet,                     &amp; !O </div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span>                          eflx_sh_tot,eflx_lh_tot,                      &amp;</div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span>                          t_ref2m,q_ref2m, dtime,                       &amp;</div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span>                          watsat, tksatu, tkmg, tkdry, csol,            &amp;</div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span>                          taux,tauy,ram1,z0mg,ustar_out,errmsg,errflg, xlat_d,xlon_d)</div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span>    <span class="comment">!in: </span></div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span> </div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: errflg</div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span>    <span class="keywordtype">character(*)</span>, <span class="keywordtype">intent(inout)</span> :: errmsg</div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: dtime<span class="comment">              !&lt; timestep</span></div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: xlat_d, xlon_d<span class="comment">     !&lt; grid location for debugging</span></div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_t(1)<span class="comment">          !&lt; atmospheric temperature (Kelvin)</span></div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_pbot(1)<span class="comment">       !&lt; atm bottom level pressure (Pa) </span></div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_psrf(1)<span class="comment">       !&lt; atmospheric surface pressure (Pa)</span></div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_hgt(1)<span class="comment">        !&lt; atmospheric reference height (m)</span></div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_hgt_q(1)<span class="comment">      !&lt; observational height of humidity [m]</span></div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_hgt_t(1)<span class="comment">      !&lt; observational height of temperature [m]</span></div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_hgt_u(1)<span class="comment">      !&lt; observational height of wind [m]</span></div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_q(1)<span class="comment">          !&lt; atmospheric specific humidity (kg/kg)</span></div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_u(1)<span class="comment">          !&lt; atmospheric wind speed in east direction (m/s)</span></div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_v(1)<span class="comment">          !&lt; atmospheric wind speed in north direction (m/s)</span></div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span>   <span class="comment">! real(kind_lake),intent(in) :: forc_rho(1)        ! density (kg/m**3)</span></div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_lwrad(1)<span class="comment">      !&lt; downward infrared (longwave) radiation (W/m**2)</span></div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: prec(1)<span class="comment">               !&lt; snow or rain rate [mm/s]</span></div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: sabg(1)<span class="comment">            !&lt; solar radiation absorbed by ground (W/m**2)</span></div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: lat(1)<span class="comment">             !&lt; latitude (radians)</span></div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: z_lake(1,nlevlake)<span class="comment">  !&lt; layer depth for lake (m)</span></div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: dz_lake(1,nlevlake)<span class="comment">                  !&lt; layer thickness for lake (m)</span></div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span> :: ustar_out(1)<span class="comment">       !&lt; friction velocity [m/s]</span></div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: lakedepth(1)<span class="comment">!!!!!!!!!!!!!!tep(in),hydro(in)   </span><span class="comment">       !&lt; column lake depth (m)</span></div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span><span class="comment">    !!</span></div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span>   <span class="comment">! real(kind_lake), intent(in) :: watsat(1,1:nlevsoil)      ! volumetric soil water at saturation (porosity)</span></div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span>    <span class="comment">!!!!!!!!!!!!!!!!hydro</span></div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span>    <span class="keywordtype">logical</span> , <span class="keywordtype">intent(in)</span> :: do_capsnow(1)<span class="comment">     !&lt; true =&gt; do snow capping</span></div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: watsat(1,nlevsoil)<span class="comment">      !&lt; volumetric soil water at saturation (porosity)</span></div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: tksatu(1,nlevsoil)<span class="comment">      !&lt; thermal conductivity, saturated soil [W/m-K]</span></div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: tkmg(1,nlevsoil)<span class="comment">        !&lt; thermal conductivity, soil minerals  [W/m-K]</span></div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: tkdry(1,nlevsoil)<span class="comment">       !&lt; thermal conductivity, dry soil (W/m/Kelvin)</span></div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: csol(1,nlevsoil)<span class="comment">        !&lt; heat capacity, soil solids (J/m**3/Kelvin)</span></div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span>   </div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span> </div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span> </div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span>    <span class="comment">!in&amp;out</span></div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: h2osoi_vol(1,-nlevsnow+1:nlevsoil)<span class="comment">  !&lt; volumetric soil water (0&lt;=h2osoi_vol&lt;=watsat)[m3/m3]</span></div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: t_grnd(1)<span class="comment">          !&lt; ground temperature (Kelvin)</span></div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: h2osno(1)<span class="comment">          !&lt; snow water (mm H2O)</span></div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: snowdp(1)<span class="comment">          !&lt; snow height (m)</span></div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: z(1,-nlevsnow+1:nlevsoil)<span class="comment">             !&lt; layer depth for snow &amp; soil (m)</span></div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: dz(1,-nlevsnow+1:nlevsoil)<span class="comment">            !&lt; layer thickness for soil or snow (m)</span></div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: t_soisno(1,-nlevsnow+1:nlevsoil)<span class="comment">      !&lt; soil (or snow) temperature (Kelvin)</span></div>
<div class="line"><a id="l00941" name="l00941"></a><span class="lineno">  941</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: t_lake(1,nlevlake)<span class="comment">                   !&lt; lake temperature (Kelvin)</span></div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span>    <span class="keywordtype">integer</span> ,<span class="keywordtype">intent(inout)</span> :: snl(1)<span class="comment">                              !&lt; number of snow layers</span></div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: h2osoi_liq(1,-nlevsnow+1:nlevsoil)<span class="comment">    !&lt; liquid water (kg/m2)</span></div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: h2osoi_ice(1,-nlevsnow+1:nlevsoil)<span class="comment">    !&lt; ice lens (kg/m2)</span></div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: savedtke1(1)<span class="comment">       !&lt; top level eddy conductivity from previous timestep (W/m.K)</span></div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: zi(1,-nlevsnow+0:nlevsoil)<span class="comment">            !&lt; interface level below a &quot;z&quot; level (m)</span></div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: lake_icefrac(1,nlevlake)<span class="comment">  !&lt; mass fraction of lake layer that is frozen</span></div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span> </div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span> </div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span>    <span class="comment">!out:</span></div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span> :: eflx_gnet(1)<span class="comment">       !&lt; net heat flux into ground (W/m**2)</span></div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span> :: eflx_lwrad_net(1)<span class="comment">  !&lt; net infrared (longwave) rad (W/m**2) [+ = to atm]</span></div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span> :: eflx_sh_tot(1)<span class="comment">     !&lt; total sensible heat flux (W/m**2) [+ to atm]</span></div>
<div class="line"><a id="l00954" name="l00954"></a><span class="lineno">  954</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span> :: eflx_lh_tot(1)<span class="comment">     !&lt; total latent heat flux (W/m8*2)  [+ to atm]</span></div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span> :: t_ref2m(1)<span class="comment">         !&lt; 2 m height surface air temperature (Kelvin)</span></div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span> :: q_ref2m(1)<span class="comment">         !&lt; 2 m height surface specific humidity (kg/kg)</span></div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span> :: taux(1)<span class="comment">            !&lt; wind (shear) stress: e-w (kg/m/s**2)</span></div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span> :: tauy(1)<span class="comment">            !&lt; wind (shear) stress: n-s (kg/m/s**2)</span></div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span> :: ram1(1)<span class="comment">            !&lt; aerodynamical resistance (s/m)</span></div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span><span class="comment">                                                      !! for calculation of decay of eddy diffusivity with depth</span></div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span><span class="comment">                                                      !! Change the type variable to pass back to WRF.</span></div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span> :: z0mg(1)<span class="comment">            !&lt; roughness length over ground, momentum (m(</span></div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span> </div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span> </div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span>    <span class="comment">!local output</span></div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span>    </div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span><span class="keywordtype">    real</span>(kind_lake) :: begwb(1)           <span class="comment">! water mass begining of the time step</span></div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span><span class="keywordtype">    real</span>(kind_lake) :: t_veg(1)           <span class="comment">! vegetation temperature (Kelvin)</span></div>
<div class="line"><a id="l00969" name="l00969"></a><span class="lineno">  969</span><span class="keywordtype">    real</span>(kind_lake) :: eflx_soil_grnd(1)  <span class="comment">! soil heat flux (W/m**2) [+ = into soil]</span></div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span><span class="keywordtype">    real</span>(kind_lake) :: eflx_lh_grnd(1)    <span class="comment">! ground evaporation heat flux (W/m**2) [+ to atm]</span></div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span><span class="keywordtype">    real</span>(kind_lake) :: eflx_sh_grnd(1)    <span class="comment">! sensible heat flux from ground (W/m**2) [+ to atm]</span></div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span><span class="keywordtype">    real</span>(kind_lake) :: eflx_lwrad_out(1)  <span class="comment">! emitted infrared (longwave) radiation (W/m**2)</span></div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_evap_tot(1)   <span class="comment">! qflx_evap_soi + qflx_evap_veg + qflx_tran_veg</span></div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_evap_soi(1)   <span class="comment">! soil evaporation (mm H2O/s) (+ = to atm)</span></div>
<div class="line"><a id="l00975" name="l00975"></a><span class="lineno">  975</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_prec_grnd(1)  <span class="comment">! water onto ground including canopy runoff [kg/(m2 s)]</span></div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span><span class="keywordtype">    real</span>(kind_lake) :: forc_snow(1)       <span class="comment">! snow rate [mm/s]</span></div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span><span class="keywordtype">    real</span>(kind_lake) :: forc_rain(1)       <span class="comment">! rain rate [mm/s]</span></div>
<div class="line"><a id="l00978" name="l00978"></a><span class="lineno">  978</span><span class="keywordtype">    real</span>(kind_lake) :: ws(1)              <span class="comment">! surface friction velocity (m/s)</span></div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span><span class="keywordtype">    real</span>(kind_lake) :: ks(1)              <span class="comment">! coefficient passed to ShalLakeTemperature</span></div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_snomelt(1)    <span class="comment">!snow melt (mm H2O /s) tem(out),snowwater(in)</span></div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span>    <span class="keywordtype">integer</span>  :: imelt(1,-nlevsnow+1:nlevsoil)      <span class="comment">!flag for melting (=1), freezing (=2), Not=0 (new)</span></div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span><span class="keywordtype">    real</span>(kind_lake) :: endwb(1)         <span class="comment">! water mass end of the time step</span></div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span><span class="keywordtype">    real</span>(kind_lake) :: snowage(1)       <span class="comment">! non dimensional snow age [-]</span></div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span><span class="keywordtype">    real</span>(kind_lake) :: snowice(1)       <span class="comment">! average snow ice lens</span></div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span><span class="keywordtype">    real</span>(kind_lake) :: snowliq(1)       <span class="comment">! average snow liquid water</span></div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span><span class="keywordtype">    real</span>(kind_lake) :: t_snow(1)        <span class="comment">! vertically averaged snow temperature</span></div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_drain(1)    <span class="comment">! sub-surface runoff (mm H2O /s)</span></div>
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno">  988</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_surf(1)     <span class="comment">! surface runoff (mm H2O /s)</span></div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_infl(1)     <span class="comment">! infiltration (mm H2O /s)</span></div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_qrgwl(1)    <span class="comment">! qflx_surf at glaciers, wetlands, lakes</span></div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span><span class="keywordtype">    real</span>(kind_lake) :: qcharge(1)       <span class="comment">! aquifer recharge rate (mm/s)</span></div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_snowcap(1)       <span class="comment">! excess precipitation due to snow capping (mm H2O /s) [+]</span></div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_snowcap_col(1)   <span class="comment">! excess precipitation due to snow capping (mm H2O /s) [+]</span></div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_snow_grnd_pft(1) <span class="comment">! snow on ground after interception (mm H2O/s) [+]</span></div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_snow_grnd_col(1) <span class="comment">! snow on ground after interception (mm H2O/s) [+]</span></div>
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno">  996</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_rain_grnd(1)     <span class="comment">! rain on ground after interception (mm H2O/s) [+]</span></div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span><span class="keywordtype">    real</span>(kind_lake) :: frac_iceold(1,-nlevsnow+1:nlevsoil)      <span class="comment">! fraction of ice relative to the tot water</span></div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_evap_tot_col(1) <span class="comment">!pft quantity averaged to the column (assuming one pft)</span></div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span><span class="keywordtype">    real</span>(kind_lake) :: soilalpha(1)     <span class="comment">!factor that reduces ground saturated specific humidity (-)</span></div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span><span class="keywordtype">    real</span>(kind_lake) :: zwt(1)           <span class="comment">!water table depth</span></div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span><span class="keywordtype">    real</span>(kind_lake) :: fcov(1)          <span class="comment">!fractional area with water table at surface</span></div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span><span class="keywordtype">    real</span>(kind_lake) :: rootr_column(1,1:nlevsoil) <span class="comment">!effective fraction of roots in each soil layer</span></div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_evap_grnd(1)  <span class="comment">! ground surface evaporation rate (mm H2O/s) [+]</span></div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_sub_snow(1)   <span class="comment">! sublimation rate from snow pack (mm H2O /s) [+]</span></div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_dew_snow(1)   <span class="comment">! surface dew added to snow pack (mm H2O /s) [+]</span></div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_dew_grnd(1)   <span class="comment">! ground surface dew formation (mm H2O /s) [+]</span></div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_rain_grnd_col(1)   <span class="comment">!rain on ground after interception (mm H2O/s) [+]</span></div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span>    begwb = 0    </div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span> </div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span>    <span class="comment">!    lat  = lat*pi/180  ! [radian]</span></div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span> </div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span>    <span class="keywordflow">if</span> (prec(1)&gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span>        <span class="keywordflow">if</span> ( forc_t(1) &gt; (tfrz + tcrit)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"> 1014</span>            forc_rain(1) = prec(1)</div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span>            forc_snow(1) = 0.</div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span>          <span class="comment">!   flfall(1) = 1.</span></div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span>         <span class="keywordflow">else</span></div>
<div class="line"><a id="l01018" name="l01018"></a><span class="lineno"> 1018</span>            forc_rain(1) = 0.</div>
<div class="line"><a id="l01019" name="l01019"></a><span class="lineno"> 1019</span>            forc_snow(1) = prec(1)</div>
<div class="line"><a id="l01020" name="l01020"></a><span class="lineno"> 1020</span> </div>
<div class="line"><a id="l01021" name="l01021"></a><span class="lineno"> 1021</span>          <span class="comment">!  if ( forc_t(1) &lt;= tfrz) then</span></div>
<div class="line"><a id="l01022" name="l01022"></a><span class="lineno"> 1022</span>          <span class="comment">!      flfall(1) = 0.</span></div>
<div class="line"><a id="l01023" name="l01023"></a><span class="lineno"> 1023</span>          <span class="comment">!  else if ( forc_t(1) &lt;= tfrz+2.) then</span></div>
<div class="line"><a id="l01024" name="l01024"></a><span class="lineno"> 1024</span>          <span class="comment">!      flfall(1) = -54.632 + 0.2 *  forc_t(1)</span></div>
<div class="line"><a id="l01025" name="l01025"></a><span class="lineno"> 1025</span>          <span class="comment">!  else</span></div>
<div class="line"><a id="l01026" name="l01026"></a><span class="lineno"> 1026</span>          <span class="comment">!      flfall(1) = 0.4</span></div>
<div class="line"><a id="l01027" name="l01027"></a><span class="lineno"> 1027</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l01028" name="l01028"></a><span class="lineno"> 1028</span>    <span class="keywordflow">else</span></div>
<div class="line"><a id="l01029" name="l01029"></a><span class="lineno"> 1029</span>         forc_rain(1) = 0.</div>
<div class="line"><a id="l01030" name="l01030"></a><span class="lineno"> 1030</span>         forc_snow(1) = 0.</div>
<div class="line"><a id="l01031" name="l01031"></a><span class="lineno"> 1031</span>       <span class="comment">!  flfall(1) = 1.</span></div>
<div class="line"><a id="l01032" name="l01032"></a><span class="lineno"> 1032</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l01033" name="l01033"></a><span class="lineno"> 1033</span> </div>
<div class="line"><a id="l01034" name="l01034"></a><span class="lineno"> 1034</span>    <span class="keyword">CALL </span>shallakefluxes(forc_t,forc_pbot,forc_psrf,forc_hgt,forc_hgt_q,   &amp;  <span class="comment">!i</span></div>
<div class="line"><a id="l01035" name="l01035"></a><span class="lineno"> 1035</span>                          forc_hgt_t,forc_hgt_u,forc_q,                   &amp;</div>
<div class="line"><a id="l01036" name="l01036"></a><span class="lineno"> 1036</span>                          forc_u,forc_v,forc_lwrad,forc_snow,             &amp;</div>
<div class="line"><a id="l01037" name="l01037"></a><span class="lineno"> 1037</span>                          forc_rain,t_grnd,h2osno,snowdp,sabg,lat,        &amp;</div>
<div class="line"><a id="l01038" name="l01038"></a><span class="lineno"> 1038</span>                          dz,dz_lake,t_soisno,t_lake,snl,h2osoi_liq,      &amp;</div>
<div class="line"><a id="l01039" name="l01039"></a><span class="lineno"> 1039</span>                          h2osoi_ice,savedtke1,                           &amp;</div>
<div class="line"><a id="l01040" name="l01040"></a><span class="lineno"> 1040</span>                          qflx_prec_grnd,qflx_evap_soi,qflx_evap_tot,     &amp;  <span class="comment">!o</span></div>
<div class="line"><a id="l01041" name="l01041"></a><span class="lineno"> 1041</span>                          eflx_sh_grnd,eflx_lwrad_out,eflx_lwrad_net,     &amp;</div>
<div class="line"><a id="l01042" name="l01042"></a><span class="lineno"> 1042</span>                          eflx_soil_grnd,eflx_sh_tot,eflx_lh_tot,         &amp;</div>
<div class="line"><a id="l01043" name="l01043"></a><span class="lineno"> 1043</span>                          eflx_lh_grnd,t_veg,t_ref2m,q_ref2m,taux,tauy,   &amp;</div>
<div class="line"><a id="l01044" name="l01044"></a><span class="lineno"> 1044</span>                          ram1,ws,ks,eflx_gnet,z0mg,ustar_out,errmsg,errflg,xlat_d,xlon_d)</div>
<div class="line"><a id="l01045" name="l01045"></a><span class="lineno"> 1045</span>    <span class="keywordflow">if</span>(errflg/=0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01046" name="l01046"></a><span class="lineno"> 1046</span>      <span class="keywordflow">return</span> <span class="comment">! State is invalid now, so pass error to caller.</span></div>
<div class="line"><a id="l01047" name="l01047"></a><span class="lineno"> 1047</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l01048" name="l01048"></a><span class="lineno"> 1048</span> </div>
<div class="line"><a id="l01049" name="l01049"></a><span class="lineno"> 1049</span>    <span class="keyword">CALL </span>shallaketemperature(t_grnd,h2osno,sabg,dz,dz_lake,z,zi,             &amp; <span class="comment">!i</span></div>
<div class="line"><a id="l01050" name="l01050"></a><span class="lineno"> 1050</span>                                 z_lake,ws,ks,snl,eflx_gnet,lakedepth,       &amp;</div>
<div class="line"><a id="l01051" name="l01051"></a><span class="lineno"> 1051</span>                                 lake_icefrac,snowdp,                        &amp; <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l01052" name="l01052"></a><span class="lineno"> 1052</span>                                 eflx_sh_grnd,eflx_sh_tot,eflx_soil_grnd,    &amp; <span class="comment">!o</span></div>
<div class="line"><a id="l01053" name="l01053"></a><span class="lineno"> 1053</span>                                 t_lake,t_soisno,h2osoi_liq,                 &amp;</div>
<div class="line"><a id="l01054" name="l01054"></a><span class="lineno"> 1054</span>                                 h2osoi_ice,savedtke1,                       &amp;</div>
<div class="line"><a id="l01055" name="l01055"></a><span class="lineno"> 1055</span>                                 watsat, tksatu, tkmg, tkdry, csol, dtime,   &amp;</div>
<div class="line"><a id="l01056" name="l01056"></a><span class="lineno"> 1056</span>                                 frac_iceold,qflx_snomelt,imelt,errmsg,errflg,xlat_d,xlon_d)</div>
<div class="line"><a id="l01057" name="l01057"></a><span class="lineno"> 1057</span>    <span class="keywordflow">if</span>(errflg/=0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01058" name="l01058"></a><span class="lineno"> 1058</span>      <span class="keywordflow">return</span> <span class="comment">! State is invalid now, so pass error to caller.</span></div>
<div class="line"><a id="l01059" name="l01059"></a><span class="lineno"> 1059</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l01060" name="l01060"></a><span class="lineno"> 1060</span> </div>
<div class="line"><a id="l01061" name="l01061"></a><span class="lineno"> 1061</span>    <span class="keyword">CALL </span>shallakehydrology(dz_lake,forc_rain,forc_snow,                          &amp; <span class="comment">!i</span></div>
<div class="line"><a id="l01062" name="l01062"></a><span class="lineno"> 1062</span>                               begwb,qflx_evap_tot,forc_t,do_capsnow,            &amp;</div>
<div class="line"><a id="l01063" name="l01063"></a><span class="lineno"> 1063</span>                               t_grnd,qflx_evap_soi,                             &amp;</div>
<div class="line"><a id="l01064" name="l01064"></a><span class="lineno"> 1064</span>                               qflx_snomelt,imelt,frac_iceold,                   &amp; <span class="comment">!i add by guhp</span></div>
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"> 1065</span>                               z,dz,zi,snl,h2osno,snowdp,lake_icefrac,t_lake,      &amp; <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l01066" name="l01066"></a><span class="lineno"> 1066</span>                               endwb,snowage,snowice,snowliq,t_snow,             &amp; <span class="comment">!o</span></div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span>                               t_soisno,h2osoi_ice,h2osoi_liq,h2osoi_vol,        &amp;</div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"> 1068</span>                               qflx_drain,qflx_surf,qflx_infl,qflx_qrgwl,        &amp;</div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span>                               qcharge,qflx_prec_grnd,qflx_snowcap,              &amp;</div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span>                               qflx_snowcap_col,qflx_snow_grnd_pft,              &amp;</div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span>                               qflx_snow_grnd_col,qflx_rain_grnd,                &amp;</div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span>                               qflx_evap_tot_col,soilalpha,zwt,fcov,             &amp;</div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span>                               rootr_column,qflx_evap_grnd,qflx_sub_snow,        &amp;</div>
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"> 1074</span>                               qflx_dew_snow,qflx_dew_grnd,qflx_rain_grnd_col,   &amp;</div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span>                               watsat, tksatu, tkmg, tkdry, csol,                &amp;</div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span>                               dtime,errmsg,errflg)</div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span>    <span class="keywordflow">if</span>(errflg/=0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span>      <span class="keywordflow">return</span> <span class="comment">! State is invalid now, so pass error to caller.</span></div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span>                       </div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span>    <span class="comment">!==================================================================================</span></div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"> 1082</span>    <span class="comment">! !DESCRIPTION:</span></div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span>    <span class="comment">! Calculation of Shallow Lake Hydrology. Full hydrology of snow layers is</span></div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span>    <span class="comment">! done. However, there is no infiltration, and the water budget is balanced with </span></div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span>                       </div>
</div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span>   <span class="keyword">END SUBROUTINE </span>lakemain</div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span> </div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span> </div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span>  <span class="comment">! DESCRIPTION:</span><span class="comment"></span></div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span><span class="comment">  !&gt; Calculates lake temperatures and surface fluxes for shallow lakes.</span></div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span><span class="comment">  !!</span></div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span><span class="comment">  !! Shallow lakes have variable depth, possible snow layers above, freezing &amp; thawing of lake water,</span></div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span><span class="comment">  !! and soil layers with active temperature and gas diffusion below.        </span></div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span><span class="comment">  !!                             </span></div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span><span class="comment">  !! WARNING: This subroutine assumes lake columns have one and only one pft.</span></div>
<div class="foldopen" id="foldopen01096" data-start="" data-end="">
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ae43526b91157fb0eb0769fe727f708c6.html#ae43526b91157fb0eb0769fe727f708c6"> 1096</a></span><span class="keyword">SUBROUTINE </span>shallakefluxes(forc_t,forc_pbot,forc_psrf,forc_hgt,forc_hgt_q,           &amp;  !i</div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span>                          forc_hgt_t,forc_hgt_u,forc_q,                   &amp;</div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span>                          forc_u,forc_v,forc_lwrad,forc_snow,             &amp;</div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span>                          forc_rain,t_grnd,h2osno,snowdp,sabg,lat,        &amp;</div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span>                          dz,dz_lake,t_soisno,t_lake,snl,h2osoi_liq,      &amp;</div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span>                          h2osoi_ice,savedtke1,                           &amp;</div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span>                          qflx_prec_grnd,qflx_evap_soi,qflx_evap_tot,     &amp;  !o</div>
<div class="line"><a id="l01103" name="l01103"></a><span class="lineno"> 1103</span>                          eflx_sh_grnd,eflx_lwrad_out,eflx_lwrad_net,     &amp;</div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span>                          eflx_soil_grnd,eflx_sh_tot,eflx_lh_tot,         &amp;</div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span>                          eflx_lh_grnd,t_veg,t_ref2m,q_ref2m,taux,tauy,   &amp;</div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span>                          ram1,ws,ks,eflx_gnet,z0mg,ustar_out,errmsg,errflg,xlat_d,xlon_d)</div>
<div class="line"><a id="l01107" name="l01107"></a><span class="lineno"> 1107</span>  <span class="comment">!==============================================================================</span></div>
<div class="line"><a id="l01108" name="l01108"></a><span class="lineno"> 1108</span>  <span class="comment">! REVISION HISTORY:</span></div>
<div class="line"><a id="l01109" name="l01109"></a><span class="lineno"> 1109</span>  <span class="comment">! - Created by Zack Subin, 2009</span></div>
<div class="line"><a id="l01110" name="l01110"></a><span class="lineno"> 1110</span>  <span class="comment">! - Reedited by Hongping Gu, 2010 </span></div>
<div class="line"><a id="l01111" name="l01111"></a><span class="lineno"> 1111</span>  <span class="comment">! - Updated for CCPP by Sam Trahan, 2022</span></div>
<div class="line"><a id="l01112" name="l01112"></a><span class="lineno"> 1112</span>  <span class="comment">!==============================================================================</span></div>
<div class="line"><a id="l01113" name="l01113"></a><span class="lineno"> 1113</span>  </div>
<div class="line"><a id="l01114" name="l01114"></a><span class="lineno"> 1114</span>   <span class="comment">! implicit none</span></div>
<div class="line"><a id="l01115" name="l01115"></a><span class="lineno"> 1115</span> </div>
<div class="line"><a id="l01116" name="l01116"></a><span class="lineno"> 1116</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l01117" name="l01117"></a><span class="lineno"> 1117</span> </div>
<div class="line"><a id="l01118" name="l01118"></a><span class="lineno"> 1118</span>    <span class="comment">!in: </span></div>
<div class="line"><a id="l01119" name="l01119"></a><span class="lineno"> 1119</span> </div>
<div class="line"><a id="l01120" name="l01120"></a><span class="lineno"> 1120</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: errflg<span class="comment">                 !&lt;</span></div>
<div class="line"><a id="l01121" name="l01121"></a><span class="lineno"> 1121</span>    <span class="keywordtype">character(len=*)</span>, <span class="keywordtype">intent(inout)</span> :: errmsg<span class="comment">        !&lt;</span></div>
<div class="line"><a id="l01122" name="l01122"></a><span class="lineno"> 1122</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: xlat_d,xlon_d<span class="comment">      !&lt;</span></div>
<div class="line"><a id="l01123" name="l01123"></a><span class="lineno"> 1123</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_t(1)<span class="comment">          !&lt; atmospheric temperature (Kelvin)</span></div>
<div class="line"><a id="l01124" name="l01124"></a><span class="lineno"> 1124</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_pbot(1)<span class="comment">       !&lt; atmospheric pressure (Pa)</span></div>
<div class="line"><a id="l01125" name="l01125"></a><span class="lineno"> 1125</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_psrf(1)<span class="comment">       !&lt; atmospheric surface pressure (Pa)</span></div>
<div class="line"><a id="l01126" name="l01126"></a><span class="lineno"> 1126</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_hgt(1)<span class="comment">        !&lt; atmospheric reference height (m)</span></div>
<div class="line"><a id="l01127" name="l01127"></a><span class="lineno"> 1127</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_hgt_q(1)<span class="comment">      !&lt; observational height of humidity [m]</span></div>
<div class="line"><a id="l01128" name="l01128"></a><span class="lineno"> 1128</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_hgt_t(1)<span class="comment">      !&lt; observational height of temperature [m]</span></div>
<div class="line"><a id="l01129" name="l01129"></a><span class="lineno"> 1129</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_hgt_u(1)<span class="comment">      !&lt; observational height of wind [m]</span></div>
<div class="line"><a id="l01130" name="l01130"></a><span class="lineno"> 1130</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_q(1)<span class="comment">          !&lt; atmospheric specific humidity (kg/kg)</span></div>
<div class="line"><a id="l01131" name="l01131"></a><span class="lineno"> 1131</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_u(1)<span class="comment">          !&lt; atmospheric wind speed in east direction (m/s)</span></div>
<div class="line"><a id="l01132" name="l01132"></a><span class="lineno"> 1132</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_v(1)<span class="comment">          !&lt; atmospheric wind speed in north direction (m/s)</span></div>
<div class="line"><a id="l01133" name="l01133"></a><span class="lineno"> 1133</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_lwrad(1)<span class="comment">      !&lt; downward infrared (longwave) radiation (W/m**2)</span></div>
<div class="line"><a id="l01134" name="l01134"></a><span class="lineno"> 1134</span>   <span class="comment">! real(kind_lake),intent(in) :: forc_rho(1)        ! density (kg/m**3)</span></div>
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"> 1135</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_snow(1)<span class="comment">       !&lt; snow rate [mm/s]</span></div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: forc_rain(1)<span class="comment">       !&lt; rain rate [mm/s]</span></div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: h2osno(1)<span class="comment">          !&lt; snow water (mm H2O)</span></div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: snowdp(1)<span class="comment">          !&lt; snow height (m)</span></div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: sabg(1)<span class="comment">            !&lt; solar radiation absorbed by ground (W/m**2)</span></div>
<div class="line"><a id="l01140" name="l01140"></a><span class="lineno"> 1140</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: lat(1)<span class="comment">             !&lt; latitude (radians)</span></div>
<div class="line"><a id="l01141" name="l01141"></a><span class="lineno"> 1141</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: dz(1,-nlevsnow+1:nlevsoil)<span class="comment">           !&lt; layer thickness for soil or snow (m)</span></div>
<div class="line"><a id="l01142" name="l01142"></a><span class="lineno"> 1142</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: dz_lake(1,nlevlake)<span class="comment">                  !&lt; layer thickness for lake (m)</span></div>
<div class="line"><a id="l01143" name="l01143"></a><span class="lineno"> 1143</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: t_soisno(1,-nlevsnow+1:nlevsoil)<span class="comment">     !&lt; soil (or snow) temperature (Kelvin)</span></div>
<div class="line"><a id="l01144" name="l01144"></a><span class="lineno"> 1144</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: t_lake(1,nlevlake)<span class="comment">                   !&lt; lake temperature (Kelvin)</span></div>
<div class="line"><a id="l01145" name="l01145"></a><span class="lineno"> 1145</span>    <span class="keywordtype">integer</span> ,<span class="keywordtype">intent(in)</span> :: snl(1)<span class="comment">                              !&lt; number of snow layers</span></div>
<div class="line"><a id="l01146" name="l01146"></a><span class="lineno"> 1146</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: h2osoi_liq(1,-nlevsnow+1:nlevsoil)<span class="comment">    !&lt; liquid water (kg/m2)</span></div>
<div class="line"><a id="l01147" name="l01147"></a><span class="lineno"> 1147</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: h2osoi_ice(1,-nlevsnow+1:nlevsoil)<span class="comment">    !&lt; ice lens (kg/m2)</span></div>
<div class="line"><a id="l01148" name="l01148"></a><span class="lineno"> 1148</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(in)</span> :: savedtke1(1)<span class="comment">       !&lt; top level eddy conductivity from previous timestep (W/m.K)</span></div>
<div class="line"><a id="l01149" name="l01149"></a><span class="lineno"> 1149</span> </div>
<div class="line"><a id="l01150" name="l01150"></a><span class="lineno"> 1150</span>    <span class="comment">!inout:</span></div>
<div class="line"><a id="l01151" name="l01151"></a><span class="lineno"> 1151</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(inout)</span> :: t_grnd(1)<span class="comment">          !&lt; ground temperature (Kelvin)</span></div>
<div class="line"><a id="l01152" name="l01152"></a><span class="lineno"> 1152</span>    <span class="comment">!out:</span></div>
<div class="line"><a id="l01153" name="l01153"></a><span class="lineno"> 1153</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: ustar_out(1)<span class="comment">       !&lt; friction velocity [m/s]</span></div>
<div class="line"><a id="l01154" name="l01154"></a><span class="lineno"> 1154</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: qflx_prec_grnd(1)<span class="comment">  !&lt; water onto ground including canopy runoff [kg/(m2 s)]</span></div>
<div class="line"><a id="l01155" name="l01155"></a><span class="lineno"> 1155</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: qflx_evap_soi(1)<span class="comment">   !&lt; soil evaporation (mm H2O/s) (+ = to atm)</span></div>
<div class="line"><a id="l01156" name="l01156"></a><span class="lineno"> 1156</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: qflx_evap_tot(1)<span class="comment">   !&lt; qflx_evap_soi + qflx_evap_veg + qflx_tran_veg</span></div>
<div class="line"><a id="l01157" name="l01157"></a><span class="lineno"> 1157</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: eflx_sh_grnd(1)<span class="comment">    !&lt; sensible heat flux from ground (W/m**2) [+ to atm]</span></div>
<div class="line"><a id="l01158" name="l01158"></a><span class="lineno"> 1158</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: eflx_lwrad_out(1)<span class="comment">  !&lt; emitted infrared (longwave) radiation (W/m**2)</span></div>
<div class="line"><a id="l01159" name="l01159"></a><span class="lineno"> 1159</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: eflx_lwrad_net(1)<span class="comment">  !&lt; net infrared (longwave) rad (W/m**2) [+ = to atm]</span></div>
<div class="line"><a id="l01160" name="l01160"></a><span class="lineno"> 1160</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: eflx_soil_grnd(1)<span class="comment">  !&lt; soil heat flux (W/m**2) [+ = into soil]</span></div>
<div class="line"><a id="l01161" name="l01161"></a><span class="lineno"> 1161</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: eflx_sh_tot(1)<span class="comment">     !&lt; total sensible heat flux (W/m**2) [+ to atm]</span></div>
<div class="line"><a id="l01162" name="l01162"></a><span class="lineno"> 1162</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: eflx_lh_tot(1)<span class="comment">     !&lt; total latent heat flux (W/m8*2)  [+ to atm]</span></div>
<div class="line"><a id="l01163" name="l01163"></a><span class="lineno"> 1163</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: eflx_lh_grnd(1)<span class="comment">    !&lt; ground evaporation heat flux (W/m**2) [+ to atm]</span></div>
<div class="line"><a id="l01164" name="l01164"></a><span class="lineno"> 1164</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: t_veg(1)<span class="comment">           !&lt; vegetation temperature (Kelvin)</span></div>
<div class="line"><a id="l01165" name="l01165"></a><span class="lineno"> 1165</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: t_ref2m(1)<span class="comment">         !&lt; 2 m height surface air temperature (Kelvin)</span></div>
<div class="line"><a id="l01166" name="l01166"></a><span class="lineno"> 1166</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: q_ref2m(1)<span class="comment">         !&lt; 2 m height surface specific humidity (kg/kg)</span></div>
<div class="line"><a id="l01167" name="l01167"></a><span class="lineno"> 1167</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: taux(1)<span class="comment">            !&lt; wind (shear) stress: e-w (kg/m/s**2)</span></div>
<div class="line"><a id="l01168" name="l01168"></a><span class="lineno"> 1168</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: tauy(1)<span class="comment">            !&lt; wind (shear) stress: n-s (kg/m/s**2)</span></div>
<div class="line"><a id="l01169" name="l01169"></a><span class="lineno"> 1169</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: ram1(1)<span class="comment">            !&lt; aerodynamical resistance (s/m)</span></div>
<div class="line"><a id="l01170" name="l01170"></a><span class="lineno"> 1170</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: ws(1)<span class="comment">              !&lt; surface friction velocity (m/s)</span></div>
<div class="line"><a id="l01171" name="l01171"></a><span class="lineno"> 1171</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: ks(1)<span class="comment">              !&lt; coefficient passed to ShalLakeTemperature</span></div>
<div class="line"><a id="l01172" name="l01172"></a><span class="lineno"> 1172</span><span class="comment">                                                     !! for calculation of decay of eddy diffusivity with depth</span></div>
<div class="line"><a id="l01173" name="l01173"></a><span class="lineno"> 1173</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: eflx_gnet(1)<span class="comment">       !&lt; net heat flux into ground (W/m**2)</span></div>
<div class="line"><a id="l01174" name="l01174"></a><span class="lineno"> 1174</span><span class="comment">                                                     !! Change the type variable to pass back to WRF.</span></div>
<div class="line"><a id="l01175" name="l01175"></a><span class="lineno"> 1175</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">intent(out)</span>:: z0mg(1)<span class="comment">            !&lt; roughness length over ground, momentum (m(</span></div>
<div class="line"><a id="l01176" name="l01176"></a><span class="lineno"> 1176</span> </div>
<div class="line"><a id="l01177" name="l01177"></a><span class="lineno"> 1177</span> </div>
<div class="line"><a id="l01178" name="l01178"></a><span class="lineno"> 1178</span> </div>
<div class="line"><a id="l01179" name="l01179"></a><span class="lineno"> 1179</span>    <span class="comment">!OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"> 1180</span> </div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">parameter</span> :: islak  = 2       <span class="comment">! index of lake, 1 = deep lake, 2 = shallow lake</span></div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">parameter</span> :: niters = 3       <span class="comment">! maximum number of iterations for surface temperature</span></div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: beta1  = 1._kind_lake   <span class="comment">! coefficient of convective velocity (in computing W_*) [-]</span></div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: emg    = 0.97_kind_lake <span class="comment">! ground emissivity (0.97 for water)</span></div>
<div class="line"><a id="l01185" name="l01185"></a><span class="lineno"> 1185</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: zii    = 1000._kind_lake<span class="comment">! convective boundary height [m]</span></div>
<div class="line"><a id="l01186" name="l01186"></a><span class="lineno"> 1186</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: tdmax  = 277._kind_lake <span class="comment">! temperature of maximum water density</span></div>
<div class="line"><a id="l01187" name="l01187"></a><span class="lineno"> 1187</span><span class="keywordtype">    real</span>(kind_lake) :: forc_th(1)         <span class="comment">! atmospheric potential temperature (Kelvin)</span></div>
<div class="line"><a id="l01188" name="l01188"></a><span class="lineno"> 1188</span><span class="keywordtype">    real</span>(kind_lake) :: forc_vp(1)         <span class="comment">!atmospheric vapor pressure (Pa)</span></div>
<div class="line"><a id="l01189" name="l01189"></a><span class="lineno"> 1189</span><span class="keywordtype">    real</span>(kind_lake) :: forc_rho(1)        <span class="comment">! density (kg/m**3)</span></div>
<div class="line"><a id="l01190" name="l01190"></a><span class="lineno"> 1190</span>    <span class="keywordtype">integer</span>  :: i,fc,fp,g,c,p           <span class="comment">! do loop or array index</span></div>
<div class="line"><a id="l01191" name="l01191"></a><span class="lineno"> 1191</span>    <span class="keywordtype">integer</span>  :: fncopy                  <span class="comment">! number of values in pft filter copy</span></div>
<div class="line"><a id="l01192" name="l01192"></a><span class="lineno"> 1192</span>    <span class="keywordtype">integer</span>  :: fnold                   <span class="comment">! previous number of pft filter values</span></div>
<div class="line"><a id="l01193" name="l01193"></a><span class="lineno"> 1193</span>    <span class="keywordtype">integer</span>  :: fpcopy(num_shlakep)     <span class="comment">! pft filter copy for iteration loop</span></div>
<div class="line"><a id="l01194" name="l01194"></a><span class="lineno"> 1194</span>    <span class="keywordtype">integer</span>  :: iter                    <span class="comment">! iteration index</span></div>
<div class="line"><a id="l01195" name="l01195"></a><span class="lineno"> 1195</span>    <span class="keywordtype">integer</span>  :: nmozsgn(lbp:ubp)        <span class="comment">! number of times moz changes sign</span></div>
<div class="line"><a id="l01196" name="l01196"></a><span class="lineno"> 1196</span>    <span class="keywordtype">integer</span>  :: jtop(lbc:ubc)           <span class="comment">! top level for each column (no longer all 1)</span></div>
<div class="line"><a id="l01197" name="l01197"></a><span class="lineno"> 1197</span><span class="keywordtype">    real</span>(kind_lake) :: ax                      <span class="comment">! used in iteration loop for calculating t_grnd (numerator of NR solution)</span></div>
<div class="line"><a id="l01198" name="l01198"></a><span class="lineno"> 1198</span><span class="keywordtype">    real</span>(kind_lake) :: bx                      <span class="comment">! used in iteration loop for calculating t_grnd (denomin. of NR solution)</span></div>
<div class="line"><a id="l01199" name="l01199"></a><span class="lineno"> 1199</span><span class="keywordtype">    real</span>(kind_lake) :: degdT                   <span class="comment">! d(eg)/dT</span></div>
<div class="line"><a id="l01200" name="l01200"></a><span class="lineno"> 1200</span><span class="keywordtype">    real</span>(kind_lake) :: dqh(lbp:ubp)            <span class="comment">! diff of humidity between ref. height and surface</span></div>
<div class="line"><a id="l01201" name="l01201"></a><span class="lineno"> 1201</span><span class="keywordtype">    real</span>(kind_lake) :: dth(lbp:ubp)            <span class="comment">! diff of virtual temp. between ref. height and surface</span></div>
<div class="line"><a id="l01202" name="l01202"></a><span class="lineno"> 1202</span><span class="keywordtype">    real</span>(kind_lake) :: dthv                    <span class="comment">! diff of vir. poten. temp. between ref. height and surface</span></div>
<div class="line"><a id="l01203" name="l01203"></a><span class="lineno"> 1203</span><span class="keywordtype">    real</span>(kind_lake) :: dzsur(lbc:ubc)          <span class="comment">! 1/2 the top layer thickness (m)</span></div>
<div class="line"><a id="l01204" name="l01204"></a><span class="lineno"> 1204</span><span class="keywordtype">    real</span>(kind_lake) :: eg                      <span class="comment">! water vapor pressure at temperature T [pa]</span></div>
<div class="line"><a id="l01205" name="l01205"></a><span class="lineno"> 1205</span><span class="keywordtype">    real</span>(kind_lake) :: htvp(lbc:ubc)           <span class="comment">! latent heat of vapor of water (or sublimation) [j/kg]</span></div>
<div class="line"><a id="l01206" name="l01206"></a><span class="lineno"> 1206</span><span class="keywordtype">    real</span>(kind_lake) :: obu(lbp:ubp)            <span class="comment">! monin-obukhov length (m)</span></div>
<div class="line"><a id="l01207" name="l01207"></a><span class="lineno"> 1207</span><span class="keywordtype">    real</span>(kind_lake) :: obuold(lbp:ubp)         <span class="comment">! monin-obukhov length of previous iteration</span></div>
<div class="line"><a id="l01208" name="l01208"></a><span class="lineno"> 1208</span><span class="keywordtype">    real</span>(kind_lake) :: qsatg(lbc:ubc)          <span class="comment">! saturated humidity [kg/kg]</span></div>
<div class="line"><a id="l01209" name="l01209"></a><span class="lineno"> 1209</span><span class="keywordtype">    real</span>(kind_lake) :: qsatgdT(lbc:ubc)        <span class="comment">! d(qsatg)/dT</span></div>
<div class="line"><a id="l01210" name="l01210"></a><span class="lineno"> 1210</span><span class="keywordtype">    real</span>(kind_lake) :: qstar                   <span class="comment">! moisture scaling parameter</span></div>
<div class="line"><a id="l01211" name="l01211"></a><span class="lineno"> 1211</span><span class="keywordtype">    real</span>(kind_lake) :: ram(lbp:ubp)            <span class="comment">! aerodynamical resistance [s/m]</span></div>
<div class="line"><a id="l01212" name="l01212"></a><span class="lineno"> 1212</span><span class="keywordtype">    real</span>(kind_lake) :: rah(lbp:ubp)            <span class="comment">! thermal resistance [s/m]</span></div>
<div class="line"><a id="l01213" name="l01213"></a><span class="lineno"> 1213</span><span class="keywordtype">    real</span>(kind_lake) :: raw(lbp:ubp)            <span class="comment">! moisture resistance [s/m]</span></div>
<div class="line"><a id="l01214" name="l01214"></a><span class="lineno"> 1214</span><span class="keywordtype">    real</span>(kind_lake) :: stftg3(lbp:ubp)         <span class="comment">! derivative of fluxes w.r.t ground temperature</span></div>
<div class="line"><a id="l01215" name="l01215"></a><span class="lineno"> 1215</span><span class="keywordtype">    real</span>(kind_lake) :: temp1(lbp:ubp)          <span class="comment">! relation for potential temperature profile</span></div>
<div class="line"><a id="l01216" name="l01216"></a><span class="lineno"> 1216</span><span class="keywordtype">    real</span>(kind_lake) :: temp12m(lbp:ubp)        <span class="comment">! relation for potential temperature profile applied at 2-m</span></div>
<div class="line"><a id="l01217" name="l01217"></a><span class="lineno"> 1217</span><span class="keywordtype">    real</span>(kind_lake) :: temp2(lbp:ubp)          <span class="comment">! relation for specific humidity profile</span></div>
<div class="line"><a id="l01218" name="l01218"></a><span class="lineno"> 1218</span><span class="keywordtype">    real</span>(kind_lake) :: temp22m(lbp:ubp)        <span class="comment">! relation for specific humidity profile applied at 2-m</span></div>
<div class="line"><a id="l01219" name="l01219"></a><span class="lineno"> 1219</span><span class="keywordtype">    real</span>(kind_lake) :: tgbef(lbc:ubc)          <span class="comment">! initial ground temperature</span></div>
<div class="line"><a id="l01220" name="l01220"></a><span class="lineno"> 1220</span><span class="keywordtype">    real</span>(kind_lake) :: thm(lbc:ubc)            <span class="comment">! intermediate variable (forc_t+0.0098*forc_hgt_t)</span></div>
<div class="line"><a id="l01221" name="l01221"></a><span class="lineno"> 1221</span><span class="keywordtype">    real</span>(kind_lake) :: thv(lbc:ubc)            <span class="comment">! virtual potential temperature (kelvin)</span></div>
<div class="line"><a id="l01222" name="l01222"></a><span class="lineno"> 1222</span><span class="keywordtype">    real</span>(kind_lake) :: thvstar                 <span class="comment">! virtual potential temperature scaling parameter</span></div>
<div class="line"><a id="l01223" name="l01223"></a><span class="lineno"> 1223</span><span class="keywordtype">    real</span>(kind_lake) :: tksur                   <span class="comment">! thermal conductivity of snow/soil (w/m/kelvin)</span></div>
<div class="line"><a id="l01224" name="l01224"></a><span class="lineno"> 1224</span><span class="keywordtype">    real</span>(kind_lake) :: tsur                    <span class="comment">! top layer temperature</span></div>
<div class="line"><a id="l01225" name="l01225"></a><span class="lineno"> 1225</span><span class="keywordtype">    real</span>(kind_lake) :: tstar                   <span class="comment">! temperature scaling parameter</span></div>
<div class="line"><a id="l01226" name="l01226"></a><span class="lineno"> 1226</span><span class="keywordtype">    real</span>(kind_lake) :: um(lbp:ubp)             <span class="comment">! wind speed including the stablity effect [m/s]</span></div>
<div class="line"><a id="l01227" name="l01227"></a><span class="lineno"> 1227</span><span class="keywordtype">    real</span>(kind_lake) :: ur(lbp:ubp)             <span class="comment">! wind speed at reference height [m/s]</span></div>
<div class="line"><a id="l01228" name="l01228"></a><span class="lineno"> 1228</span><span class="keywordtype">    real</span>(kind_lake) :: ustar(lbp:ubp)          <span class="comment">! friction velocity [m/s]</span></div>
<div class="line"><a id="l01229" name="l01229"></a><span class="lineno"> 1229</span><span class="keywordtype">    real</span>(kind_lake) :: wc                      <span class="comment">! convective velocity [m/s]</span></div>
<div class="line"><a id="l01230" name="l01230"></a><span class="lineno"> 1230</span><span class="keywordtype">    real</span>(kind_lake) :: zeta                    <span class="comment">! dimensionless height used in Monin-Obukhov theory</span></div>
<div class="line"><a id="l01231" name="l01231"></a><span class="lineno"> 1231</span><span class="keywordtype">    real</span>(kind_lake) :: zldis(lbp:ubp)          <span class="comment">! reference height &quot;minus&quot; zero displacement height [m]</span></div>
<div class="line"><a id="l01232" name="l01232"></a><span class="lineno"> 1232</span><span class="keywordtype">    real</span>(kind_lake) :: displa(lbp:ubp)         <span class="comment">! displacement (always zero) [m]</span></div>
<div class="line"><a id="l01233" name="l01233"></a><span class="lineno"> 1233</span>    <span class="comment">!    real(kind_lake) :: z0mg(lbp:ubp)           ! roughness length over ground, momentum [m]</span></div>
<div class="line"><a id="l01234" name="l01234"></a><span class="lineno"> 1234</span><span class="keywordtype">    real</span>(kind_lake) :: z0hg(lbp:ubp)           <span class="comment">! roughness length over ground, sensible heat [m]</span></div>
<div class="line"><a id="l01235" name="l01235"></a><span class="lineno"> 1235</span><span class="keywordtype">    real</span>(kind_lake) :: z0qg(lbp:ubp)           <span class="comment">! roughness length over ground, latent heat [m]</span></div>
<div class="line"><a id="l01236" name="l01236"></a><span class="lineno"> 1236</span><span class="keywordtype">    real</span>(kind_lake) :: u2m                     <span class="comment">! 2 m wind speed (m/s)</span></div>
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"> 1237</span><span class="keywordtype">    real</span>(kind_lake) :: u10(1)         <span class="comment">! 10-m wind (m/s) (for dust model)</span></div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span><span class="keywordtype">    real</span>(kind_lake) :: fv(1)          <span class="comment">! friction velocity (m/s) (for dust model)</span></div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span> </div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"> 1240</span><span class="keywordtype">    real</span>(kind_lake) :: fm(lbp:ubp)             <span class="comment">! needed for BGC only to diagnose 10m wind speed</span></div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span><span class="keywordtype">    real</span>(kind_lake) :: bw                       <span class="comment">! partial density of water (ice + liquid)</span></div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span><span class="keywordtype">    real</span>(kind_lake) :: t_grnd_temp              <span class="comment">! Used in surface flux correction over frozen ground</span></div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span><span class="keywordtype">    real</span>(kind_lake) :: betaprime(lbc:ubc)       <span class="comment">! Effective beta: 1 for snow layers, beta(islak) otherwise</span></div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span>    <span class="keywordtype">character*256</span> :: message </div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span>    <span class="comment">! tgs COARE</span></div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span><span class="keywordtype">    real</span>(kind_lake) :: tc, visc, ren</div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span> </div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span>      <span class="comment">! This assumes all radiation is absorbed in the top snow layer and will need</span></div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span>      <span class="comment">! to be changed for CLM 4.</span></div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span>    <span class="comment">!</span></div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span>    <span class="comment">! Constants for lake temperature model</span></div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span>    <span class="comment">!</span></div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: beta(2) = &amp; <span class="comment">! fraction solar rad absorbed at surface: depends on lake type</span></div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span>         (/0.4_kind_lake, 0.4_kind_lake/)  <span class="comment">! (deep lake, shallow lake)</span></div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span>    <span class="comment">! This is the energy absorbed at the lake surface if no snow.</span></div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span>    <span class="comment">!    data za  /0.6_kind_lake, 0.5_kind_lake/</span></div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span>    <span class="comment">!    data eta /0.1_kind_lake, 0.5_kind_lake/</span></div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span> </div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span>    <span class="comment">! Begin calculations</span></div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span>    </div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span>    forc_th(1)  = forc_t(1) * (forc_psrf(1)/ forc_pbot(1))**(rair/cpair)</div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span>    forc_vp(1)  = forc_q(1) * forc_pbot(1)/ (con_eps + one_minus_con_eps * forc_q(1))</div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span>    forc_rho(1) = (forc_pbot(1) - one_minus_con_eps * forc_vp(1)) / (rair * forc_t(1))</div>
<div class="line"><a id="l01267" name="l01267"></a><span class="lineno"> 1267</span> </div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"> 1268</span>    <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span>       c = filter_shlakec(fc)</div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span>       g = cgridcell(c)</div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span> </div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span>       <span class="comment">! Surface temperature and fluxes</span></div>
<div class="line"><a id="l01273" name="l01273"></a><span class="lineno"> 1273</span> </div>
<div class="line"><a id="l01274" name="l01274"></a><span class="lineno"> 1274</span>       <span class="comment">! Find top layer</span></div>
<div class="line"><a id="l01275" name="l01275"></a><span class="lineno"> 1275</span>       <span class="keywordflow">if</span> (snl(c) &gt; 0 .or. snl(c) &lt; -5) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01276" name="l01276"></a><span class="lineno"> 1276</span>         errmsg=<span class="stringliteral">&#39;snl is not defined in ShalLakeFluxesMod; snl: out of range value&#39;</span></div>
<div class="line"><a id="l01277" name="l01277"></a><span class="lineno"> 1277</span>         errflg=1</div>
<div class="line"><a id="l01278" name="l01278"></a><span class="lineno"> 1278</span>         <span class="keywordflow">return</span> <span class="comment">! Cannot continue</span></div>
<div class="line"><a id="l01279" name="l01279"></a><span class="lineno"> 1279</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l01280" name="l01280"></a><span class="lineno"> 1280</span>       <span class="comment">!       if (snl(c) /= 0) then</span></div>
<div class="line"><a id="l01281" name="l01281"></a><span class="lineno"> 1281</span>       <span class="comment">!           write(6,*)&#39;snl is not equal to zero in ShalLakeFluxesMod&#39;</span></div>
<div class="line"><a id="l01282" name="l01282"></a><span class="lineno"> 1282</span>       <span class="comment">!           call endrun()</span></div>
<div class="line"><a id="l01283" name="l01283"></a><span class="lineno"> 1283</span>       <span class="comment">!       end if</span></div>
<div class="line"><a id="l01284" name="l01284"></a><span class="lineno"> 1284</span>       jtop(c) = snl(c) + 1</div>
<div class="line"><a id="l01285" name="l01285"></a><span class="lineno"> 1285</span> </div>
<div class="line"><a id="l01286" name="l01286"></a><span class="lineno"> 1286</span> </div>
<div class="line"><a id="l01287" name="l01287"></a><span class="lineno"> 1287</span>       <span class="keywordflow">if</span> (snl(c) &lt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01288" name="l01288"></a><span class="lineno"> 1288</span>           betaprime(c) = 1._kind_lake  <span class="comment">!Assume all solar rad. absorbed at the surface of the top snow layer. </span></div>
<div class="line"><a id="l01289" name="l01289"></a><span class="lineno"> 1289</span>           dzsur(c) = dz(c,jtop(c))*0.5_kind_lake</div>
<div class="line"><a id="l01290" name="l01290"></a><span class="lineno"> 1290</span>       <span class="keywordflow">else</span></div>
<div class="line"><a id="l01291" name="l01291"></a><span class="lineno"> 1291</span>           betaprime(c) = beta(islak)</div>
<div class="line"><a id="l01292" name="l01292"></a><span class="lineno"> 1292</span>           dzsur(c) = dz_lake(c,1)*0.5_kind_lake</div>
<div class="line"><a id="l01293" name="l01293"></a><span class="lineno"> 1293</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l01294" name="l01294"></a><span class="lineno"> 1294</span>       <span class="comment">! Originally this was 1*dz, but shouldn&#39;t it be 1/2?</span></div>
<div class="line"><a id="l01295" name="l01295"></a><span class="lineno"> 1295</span> </div>
<div class="line"><a id="l01296" name="l01296"></a><span class="lineno"> 1296</span>       <span class="comment">! Saturated vapor pressure, specific humidity and their derivatives</span></div>
<div class="line"><a id="l01297" name="l01297"></a><span class="lineno"> 1297</span>       <span class="comment">! at lake surface</span></div>
<div class="line"><a id="l01298" name="l01298"></a><span class="lineno"> 1298</span> </div>
<div class="line"><a id="l01299" name="l01299"></a><span class="lineno"> 1299</span>       <span class="keyword">call </span>qsat(t_grnd(c), forc_pbot(g), eg, degdt, qsatg(c), qsatgdt(c))</div>
<div class="line"><a id="l01300" name="l01300"></a><span class="lineno"> 1300</span> </div>
<div class="line"><a id="l01301" name="l01301"></a><span class="lineno"> 1301</span>       <span class="comment">! Potential, virtual potential temperature, and wind speed at the</span></div>
<div class="line"><a id="l01302" name="l01302"></a><span class="lineno"> 1302</span>       <span class="comment">! reference height</span></div>
<div class="line"><a id="l01303" name="l01303"></a><span class="lineno"> 1303</span> </div>
<div class="line"><a id="l01304" name="l01304"></a><span class="lineno"> 1304</span>       thm(c) = forc_t(g) + 0.0098_kind_lake*forc_hgt_t(g)   <span class="comment">! intermediate variable</span></div>
<div class="line"><a id="l01305" name="l01305"></a><span class="lineno"> 1305</span>       thv(c) = forc_th(g)*(1._kind_lake+con_fvirt*forc_q(g))     <span class="comment">! virtual potential T</span></div>
<div class="line"><a id="l01306" name="l01306"></a><span class="lineno"> 1306</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l01307" name="l01307"></a><span class="lineno"> 1307</span> </div>
<div class="line"><a id="l01308" name="l01308"></a><span class="lineno"> 1308</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l01309" name="l01309"></a><span class="lineno"> 1309</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l01310" name="l01310"></a><span class="lineno"> 1310</span>    <span class="keywordflow">do</span> fp = 1, num_shlakep</div>
<div class="line"><a id="l01311" name="l01311"></a><span class="lineno"> 1311</span>       p = filter_shlakep(fp)</div>
<div class="line"><a id="l01312" name="l01312"></a><span class="lineno"> 1312</span>       c = pcolumn(p)</div>
<div class="line"><a id="l01313" name="l01313"></a><span class="lineno"> 1313</span>       g = pgridcell(p)</div>
<div class="line"><a id="l01314" name="l01314"></a><span class="lineno"> 1314</span> </div>
<div class="line"><a id="l01315" name="l01315"></a><span class="lineno"> 1315</span>       nmozsgn(p) = 0</div>
<div class="line"><a id="l01316" name="l01316"></a><span class="lineno"> 1316</span>       obuold(p) = 0._kind_lake</div>
<div class="line"><a id="l01317" name="l01317"></a><span class="lineno"> 1317</span>       displa(p) = 0._kind_lake</div>
<div class="line"><a id="l01318" name="l01318"></a><span class="lineno"> 1318</span> </div>
<div class="line"><a id="l01319" name="l01319"></a><span class="lineno"> 1319</span>       <span class="comment">! Roughness lengths</span></div>
<div class="line"><a id="l01320" name="l01320"></a><span class="lineno"> 1320</span> </div>
<div class="line"><a id="l01321" name="l01321"></a><span class="lineno"> 1321</span> </div>
<div class="line"><a id="l01322" name="l01322"></a><span class="lineno"> 1322</span>       <span class="comment">! changed by Hongping Gu</span></div>
<div class="line"><a id="l01323" name="l01323"></a><span class="lineno"> 1323</span>    <span class="comment">!   if (t_grnd(c) &gt;= tfrz) then   ! for unfrozen lake</span></div>
<div class="line"><a id="l01324" name="l01324"></a><span class="lineno"> 1324</span>    <span class="comment">!      z0mg(p) = 0.01_kind_lake</span></div>
<div class="line"><a id="l01325" name="l01325"></a><span class="lineno"> 1325</span>    <span class="comment">!   else                          ! for frozen lake</span></div>
<div class="line"><a id="l01326" name="l01326"></a><span class="lineno"> 1326</span>    <span class="comment">!   ! Is this okay even if it is snow covered?  What is the roughness over</span></div>
<div class="line"><a id="l01327" name="l01327"></a><span class="lineno"> 1327</span>    <span class="comment">!   non-veg. snow?</span></div>
<div class="line"><a id="l01328" name="l01328"></a><span class="lineno"> 1328</span>    <span class="comment">!      z0mg(p) = 0.04_kind_lake</span></div>
<div class="line"><a id="l01329" name="l01329"></a><span class="lineno"> 1329</span>    <span class="comment">!   end if</span></div>
<div class="line"><a id="l01330" name="l01330"></a><span class="lineno"> 1330</span> </div>
<div class="line"><a id="l01331" name="l01331"></a><span class="lineno"> 1331</span>       <span class="keywordflow">if</span> (t_grnd(c) &gt;= tfrz) <span class="keywordflow">then</span>   <span class="comment">! for unfrozen lake</span></div>
<div class="line"><a id="l01332" name="l01332"></a><span class="lineno"> 1332</span>          z0mg(p) = 0.001_kind_lake        <span class="comment">!original 0.01</span></div>
<div class="line"><a id="l01333" name="l01333"></a><span class="lineno"> 1333</span>       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(snl(c) == 0 ) <span class="keywordflow">then</span>                         <span class="comment">! for frozen lake</span></div>
<div class="line"><a id="l01334" name="l01334"></a><span class="lineno"> 1334</span>       <span class="comment">! Is this okay even if it is snow covered?  What is the roughness over</span></div>
<div class="line"><a id="l01335" name="l01335"></a><span class="lineno"> 1335</span>       <span class="comment">! non-veg. snow?</span></div>
<div class="line"><a id="l01336" name="l01336"></a><span class="lineno"> 1336</span>          z0mg(p) = 0.005_kind_lake          <span class="comment">!original 0.04, now for frozen lake without snow</span></div>
<div class="line"><a id="l01337" name="l01337"></a><span class="lineno"> 1337</span>       <span class="keywordflow">else</span>                          <span class="comment">! for frozen lake with snow   </span></div>
<div class="line"><a id="l01338" name="l01338"></a><span class="lineno"> 1338</span>          z0mg(p) = 0.0024_kind_lake</div>
<div class="line"><a id="l01339" name="l01339"></a><span class="lineno"> 1339</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l01340" name="l01340"></a><span class="lineno"> 1340</span> </div>
<div class="line"><a id="l01341" name="l01341"></a><span class="lineno"> 1341</span>       <span class="keywordflow">if</span>(.false.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01342" name="l01342"></a><span class="lineno"> 1342</span>         <span class="comment">! This can&#39;t work since it uses ustar before ustar is initialized</span></div>
<div class="line"><a id="l01343" name="l01343"></a><span class="lineno"> 1343</span>       <span class="comment">!- tgs - use COARE formulation for z0hg and z0qg.</span></div>
<div class="line"><a id="l01344" name="l01344"></a><span class="lineno"> 1344</span>       <span class="comment">!-- suggestion from Ayumi Manome (GLERL), Aug. 2018</span></div>
<div class="line"><a id="l01345" name="l01345"></a><span class="lineno"> 1345</span>       <span class="comment">!-- Charusombat et al., 2018, https://doi.org/10.5194/hess-2017-725</span></div>
<div class="line"><a id="l01346" name="l01346"></a><span class="lineno"> 1346</span>        tc=forc_t(g)-273.15_kind_lake</div>
<div class="line"><a id="l01347" name="l01347"></a><span class="lineno"> 1347</span>        visc=1.326e-5_kind_lake*(1._kind_lake + 6.542e-3_kind_lake*tc + 8.301e-6_kind_lake*tc*tc &amp;</div>
<div class="line"><a id="l01348" name="l01348"></a><span class="lineno"> 1348</span>                        - 4.84e-9_kind_lake*tc*tc*tc)</div>
<div class="line"><a id="l01349" name="l01349"></a><span class="lineno"> 1349</span>        visc=max(1e-7_kind_lake, visc)</div>
<div class="line"><a id="l01350" name="l01350"></a><span class="lineno"> 1350</span> </div>
<div class="line"><a id="l01351" name="l01351"></a><span class="lineno"> 1351</span>        ren = max(ustar(p)*z0mg(p)/visc, 0.1_kind_lake)</div>
<div class="line"><a id="l01352" name="l01352"></a><span class="lineno"> 1352</span>        z0hg(p) = (5.5e-5_kind_lake)*(ren**(-0.60_kind_lake))</div>
<div class="line"><a id="l01353" name="l01353"></a><span class="lineno"> 1353</span> </div>
<div class="line"><a id="l01354" name="l01354"></a><span class="lineno"> 1354</span>        z0hg(p) = min(z0hg(p),1.0e-4_kind_lake)</div>
<div class="line"><a id="l01355" name="l01355"></a><span class="lineno"> 1355</span>        z0hg(p) = max(z0hg(p),2.0e-9_kind_lake)</div>
<div class="line"><a id="l01356" name="l01356"></a><span class="lineno"> 1356</span> </div>
<div class="line"><a id="l01357" name="l01357"></a><span class="lineno"> 1357</span>        z0qg(p) = z0hg(p)</div>
<div class="line"><a id="l01358" name="l01358"></a><span class="lineno"> 1358</span> </div>
<div class="line"><a id="l01359" name="l01359"></a><span class="lineno"> 1359</span>       <span class="comment">! end COARE </span></div>
<div class="line"><a id="l01360" name="l01360"></a><span class="lineno"> 1360</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l01361" name="l01361"></a><span class="lineno"> 1361</span>       z0hg(p) = z0mg(p)</div>
<div class="line"><a id="l01362" name="l01362"></a><span class="lineno"> 1362</span>       z0qg(p) = z0mg(p)</div>
<div class="line"><a id="l01363" name="l01363"></a><span class="lineno"> 1363</span> </div>
<div class="line"><a id="l01364" name="l01364"></a><span class="lineno"> 1364</span>       <span class="comment">! Latent heat</span></div>
<div class="line"><a id="l01365" name="l01365"></a><span class="lineno"> 1365</span> </div>
<div class="line"><a id="l01366" name="l01366"></a><span class="lineno"> 1366</span>       <span class="keywordflow">if</span>(pergro) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01367" name="l01367"></a><span class="lineno"> 1367</span>         htvp(c) = hvap</div>
<div class="line"><a id="l01368" name="l01368"></a><span class="lineno"> 1368</span>       <span class="keywordflow">else</span></div>
<div class="line"><a id="l01369" name="l01369"></a><span class="lineno"> 1369</span>         <span class="keywordflow">if</span> (t_grnd(c) &gt; tfrz) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01370" name="l01370"></a><span class="lineno"> 1370</span>           htvp(c) = hvap</div>
<div class="line"><a id="l01371" name="l01371"></a><span class="lineno"> 1371</span>         <span class="keywordflow">else</span></div>
<div class="line"><a id="l01372" name="l01372"></a><span class="lineno"> 1372</span>           htvp(c) = hsub</div>
<div class="line"><a id="l01373" name="l01373"></a><span class="lineno"> 1373</span><span class="keywordflow">         end if</span></div>
<div class="line"><a id="l01374" name="l01374"></a><span class="lineno"> 1374</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l01375" name="l01375"></a><span class="lineno"> 1375</span> </div>
<div class="line"><a id="l01376" name="l01376"></a><span class="lineno"> 1376</span>       <span class="comment">! Zack Subin, 3/26/09: Shouldn&#39;t this be the ground temperature rather than the air temperature above?</span></div>
<div class="line"><a id="l01377" name="l01377"></a><span class="lineno"> 1377</span>       <span class="comment">! I&#39;ll change it for now.</span></div>
<div class="line"><a id="l01378" name="l01378"></a><span class="lineno"> 1378</span> </div>
<div class="line"><a id="l01379" name="l01379"></a><span class="lineno"> 1379</span>       <span class="comment">! Initialize stability variables</span></div>
<div class="line"><a id="l01380" name="l01380"></a><span class="lineno"> 1380</span> </div>
<div class="line"><a id="l01381" name="l01381"></a><span class="lineno"> 1381</span>       ur(p)    = max(1.0_kind_lake,sqrt(forc_u(g)*forc_u(g)+forc_v(g)*forc_v(g)))</div>
<div class="line"><a id="l01382" name="l01382"></a><span class="lineno"> 1382</span>       dth(p)   = thm(c)-t_grnd(c)</div>
<div class="line"><a id="l01383" name="l01383"></a><span class="lineno"> 1383</span>       dqh(p)   = forc_q(g)-qsatg(c)</div>
<div class="line"><a id="l01384" name="l01384"></a><span class="lineno"> 1384</span>       dthv     = dth(p)*(1._kind_lake+con_fvirt*forc_q(g))+con_fvirt*forc_th(g)*dqh(p)</div>
<div class="line"><a id="l01385" name="l01385"></a><span class="lineno"> 1385</span>       zldis(p) = forc_hgt_u(g) - 0._kind_lake</div>
<div class="line"><a id="l01386" name="l01386"></a><span class="lineno"> 1386</span> </div>
<div class="line"><a id="l01387" name="l01387"></a><span class="lineno"> 1387</span>       <span class="comment">! Initialize Monin-Obukhov length and wind speed</span></div>
<div class="line"><a id="l01388" name="l01388"></a><span class="lineno"> 1388</span> </div>
<div class="line"><a id="l01389" name="l01389"></a><span class="lineno"> 1389</span>       <span class="keyword">call </span>moninobukini(ur(p), thv(c), dthv, zldis(p), z0mg(p), um(p), obu(p))</div>
<div class="line"><a id="l01390" name="l01390"></a><span class="lineno"> 1390</span> </div>
<div class="line"><a id="l01391" name="l01391"></a><span class="lineno"> 1391</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l01392" name="l01392"></a><span class="lineno"> 1392</span> </div>
<div class="line"><a id="l01393" name="l01393"></a><span class="lineno"> 1393</span>    iter = 1</div>
<div class="line"><a id="l01394" name="l01394"></a><span class="lineno"> 1394</span>    fncopy = num_shlakep</div>
<div class="line"><a id="l01395" name="l01395"></a><span class="lineno"> 1395</span>    fpcopy(1:num_shlakep) = filter_shlakep(1:num_shlakep)</div>
<div class="line"><a id="l01396" name="l01396"></a><span class="lineno"> 1396</span> </div>
<div class="line"><a id="l01397" name="l01397"></a><span class="lineno"> 1397</span>    <span class="comment">! Begin stability iteration</span></div>
<div class="line"><a id="l01398" name="l01398"></a><span class="lineno"> 1398</span> </div>
<div class="line"><a id="l01399" name="l01399"></a><span class="lineno"> 1399</span>    iteration : <span class="keywordflow">do</span> <span class="keywordflow">while</span> (iter &lt;= niters .and. fncopy &gt; 0)</div>
<div class="line"><a id="l01400" name="l01400"></a><span class="lineno"> 1400</span> </div>
<div class="line"><a id="l01401" name="l01401"></a><span class="lineno"> 1401</span>       <span class="comment">! Determine friction velocity, and potential temperature and humidity</span></div>
<div class="line"><a id="l01402" name="l01402"></a><span class="lineno"> 1402</span>       <span class="comment">! profiles of the surface boundary layer</span></div>
<div class="line"><a id="l01403" name="l01403"></a><span class="lineno"> 1403</span> </div>
<div class="line"><a id="l01404" name="l01404"></a><span class="lineno"> 1404</span>       <span class="keyword">call </span>frictionvelocity(pgridcell,forc_hgt,forc_hgt_u,          &amp; <span class="comment">!i</span></div>
<div class="line"><a id="l01405" name="l01405"></a><span class="lineno"> 1405</span>                             forc_hgt_t,forc_hgt_q,                  &amp; <span class="comment">!i</span></div>
<div class="line"><a id="l01406" name="l01406"></a><span class="lineno"> 1406</span>                             lbp, ubp, fncopy, fpcopy,               &amp; <span class="comment">!i</span></div>
<div class="line"><a id="l01407" name="l01407"></a><span class="lineno"> 1407</span>                             displa, z0mg, z0hg, z0qg,               &amp; <span class="comment">!i</span></div>
<div class="line"><a id="l01408" name="l01408"></a><span class="lineno"> 1408</span>                             obu, iter, ur, um,                      &amp; <span class="comment">!i</span></div>
<div class="line"><a id="l01409" name="l01409"></a><span class="lineno"> 1409</span>                             ustar,temp1, temp2, temp12m, temp22m,   &amp; <span class="comment">!o</span></div>
<div class="line"><a id="l01410" name="l01410"></a><span class="lineno"> 1410</span>                             u10,fv,                                 &amp; <span class="comment">!o</span></div>
<div class="line"><a id="l01411" name="l01411"></a><span class="lineno"> 1411</span>                             fm)  <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l01412" name="l01412"></a><span class="lineno"> 1412</span> </div>
<div class="line"><a id="l01413" name="l01413"></a><span class="lineno"> 1413</span>       <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l01414" name="l01414"></a><span class="lineno"> 1414</span>       <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l01415" name="l01415"></a><span class="lineno"> 1415</span>       <span class="keywordflow">do</span> fp = 1, fncopy</div>
<div class="line"><a id="l01416" name="l01416"></a><span class="lineno"> 1416</span>          p = fpcopy(fp)</div>
<div class="line"><a id="l01417" name="l01417"></a><span class="lineno"> 1417</span>          c = pcolumn(p)</div>
<div class="line"><a id="l01418" name="l01418"></a><span class="lineno"> 1418</span>          g = pgridcell(p)</div>
<div class="line"><a id="l01419" name="l01419"></a><span class="lineno"> 1419</span> </div>
<div class="line"><a id="l01420" name="l01420"></a><span class="lineno"> 1420</span>          tgbef(c) = t_grnd(c)</div>
<div class="line"><a id="l01421" name="l01421"></a><span class="lineno"> 1421</span>          <span class="keywordflow">if</span> (t_grnd(c) &gt; tfrz .and. t_lake(c,1) &gt; tfrz .and. snl(c) == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01422" name="l01422"></a><span class="lineno"> 1422</span>             tksur = savedtke1(c)</div>
<div class="line"><a id="l01423" name="l01423"></a><span class="lineno"> 1423</span>             <span class="comment">! Set this to the eddy conductivity from the last</span></div>
<div class="line"><a id="l01424" name="l01424"></a><span class="lineno"> 1424</span>             <span class="comment">! timestep, as the molecular conductivity will be orders of magnitude too small.</span></div>
<div class="line"><a id="l01425" name="l01425"></a><span class="lineno"> 1425</span>             <span class="comment">! Will have to deal with first timestep.</span></div>
<div class="line"><a id="l01426" name="l01426"></a><span class="lineno"> 1426</span>             tsur = t_lake(c,1)</div>
<div class="line"><a id="l01427" name="l01427"></a><span class="lineno"> 1427</span>          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (snl(c) == 0) <span class="keywordflow">then</span>  <span class="comment">!frozen but no snow layers</span></div>
<div class="line"><a id="l01428" name="l01428"></a><span class="lineno"> 1428</span>             tksur = tkice</div>
<div class="line"><a id="l01429" name="l01429"></a><span class="lineno"> 1429</span>             tsur = t_lake(c,1)</div>
<div class="line"><a id="l01430" name="l01430"></a><span class="lineno"> 1430</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l01431" name="l01431"></a><span class="lineno"> 1431</span>          <span class="comment">!Need to calculate thermal conductivity of the top snow layer</span></div>
<div class="line"><a id="l01432" name="l01432"></a><span class="lineno"> 1432</span>             bw = (h2osoi_ice(c,jtop(c))+h2osoi_liq(c,jtop(c)))/dz(c,jtop(c))</div>
<div class="line"><a id="l01433" name="l01433"></a><span class="lineno"> 1433</span>             tksur = tkairc + (7.75e-5_kind_lake *bw + 1.105e-6_kind_lake*bw*bw)*(tkice-tkairc)</div>
<div class="line"><a id="l01434" name="l01434"></a><span class="lineno"> 1434</span>             tsur = t_soisno(c,jtop(c))</div>
<div class="line"><a id="l01435" name="l01435"></a><span class="lineno"> 1435</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l01436" name="l01436"></a><span class="lineno"> 1436</span> </div>
<div class="line"><a id="l01437" name="l01437"></a><span class="lineno"> 1437</span>          <span class="comment">! Determine aerodynamic resistances</span></div>
<div class="line"><a id="l01438" name="l01438"></a><span class="lineno"> 1438</span> </div>
<div class="line"><a id="l01439" name="l01439"></a><span class="lineno"> 1439</span>          ram(p)  = 1._kind_lake/(ustar(p)*ustar(p)/um(p))</div>
<div class="line"><a id="l01440" name="l01440"></a><span class="lineno"> 1440</span>          rah(p)  = 1._kind_lake/(temp1(p)*ustar(p))</div>
<div class="line"><a id="l01441" name="l01441"></a><span class="lineno"> 1441</span>          raw(p)  = 1._kind_lake/(temp2(p)*ustar(p))</div>
<div class="line"><a id="l01442" name="l01442"></a><span class="lineno"> 1442</span>          ram1(p) = ram(p)   <span class="comment">!pass value to global variable</span></div>
<div class="line"><a id="l01443" name="l01443"></a><span class="lineno"> 1443</span> </div>
<div class="line"><a id="l01444" name="l01444"></a><span class="lineno"> 1444</span>          <span class="comment">! Get derivative of fluxes with respect to ground temperature</span></div>
<div class="line"><a id="l01445" name="l01445"></a><span class="lineno"> 1445</span> </div>
<div class="line"><a id="l01446" name="l01446"></a><span class="lineno"> 1446</span>          stftg3(p) = emg*sb*tgbef(c)*tgbef(c)*tgbef(c)</div>
<div class="line"><a id="l01447" name="l01447"></a><span class="lineno"> 1447</span> </div>
<div class="line"><a id="l01448" name="l01448"></a><span class="lineno"> 1448</span>          <span class="comment">! Changed surface temperature from t_lake(c,1) to tsur.</span></div>
<div class="line"><a id="l01449" name="l01449"></a><span class="lineno"> 1449</span>          <span class="comment">! Also adjusted so that if there are snow layers present, all radiation is absorbed in the top layer.</span></div>
<div class="line"><a id="l01450" name="l01450"></a><span class="lineno"> 1450</span>          ax  = betaprime(c)*sabg(p) + emg*forc_lwrad(g) + 3._kind_lake*stftg3(p)*tgbef(c) &amp;</div>
<div class="line"><a id="l01451" name="l01451"></a><span class="lineno"> 1451</span>               + forc_rho(g)*cpair/rah(p)*thm(c) &amp;</div>
<div class="line"><a id="l01452" name="l01452"></a><span class="lineno"> 1452</span>               - htvp(c)*forc_rho(g)/raw(p)*(qsatg(c)-qsatgdt(c)*tgbef(c) - forc_q(g)) &amp;</div>
<div class="line"><a id="l01453" name="l01453"></a><span class="lineno"> 1453</span>               + tksur*tsur/dzsur(c)</div>
<div class="line"><a id="l01454" name="l01454"></a><span class="lineno"> 1454</span>          <span class="comment">!Changed sabg(p) and to betaprime(c)*sabg(p).</span></div>
<div class="line"><a id="l01455" name="l01455"></a><span class="lineno"> 1455</span>          bx  = 4._kind_lake*stftg3(p) + forc_rho(g)*cpair/rah(p) &amp;</div>
<div class="line"><a id="l01456" name="l01456"></a><span class="lineno"> 1456</span>               + htvp(c)*forc_rho(g)/raw(p)*qsatgdt(c) + tksur/dzsur(c)</div>
<div class="line"><a id="l01457" name="l01457"></a><span class="lineno"> 1457</span> </div>
<div class="line"><a id="l01458" name="l01458"></a><span class="lineno"> 1458</span>          t_grnd(c) = ax/bx</div>
<div class="line"><a id="l01459" name="l01459"></a><span class="lineno"> 1459</span> </div>
<div class="line"><a id="l01460" name="l01460"></a><span class="lineno"> 1460</span>          <span class="comment">! Update htvp</span></div>
<div class="line"><a id="l01461" name="l01461"></a><span class="lineno"> 1461</span>          <span class="keywordflow">if</span>(.not.pergro) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01462" name="l01462"></a><span class="lineno"> 1462</span>            <span class="keywordflow">if</span> (t_grnd(c) &gt; tfrz) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01463" name="l01463"></a><span class="lineno"> 1463</span>              htvp(c) = hvap</div>
<div class="line"><a id="l01464" name="l01464"></a><span class="lineno"> 1464</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l01465" name="l01465"></a><span class="lineno"> 1465</span>              htvp(c) = hsub</div>
<div class="line"><a id="l01466" name="l01466"></a><span class="lineno"> 1466</span><span class="keywordflow">            end if</span></div>
<div class="line"><a id="l01467" name="l01467"></a><span class="lineno"> 1467</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l01468" name="l01468"></a><span class="lineno"> 1468</span> </div>
<div class="line"><a id="l01469" name="l01469"></a><span class="lineno"> 1469</span>          <span class="comment">! Surface fluxes of momentum, sensible and latent heat</span></div>
<div class="line"><a id="l01470" name="l01470"></a><span class="lineno"> 1470</span>          <span class="comment">! using ground temperatures from previous time step</span></div>
<div class="line"><a id="l01471" name="l01471"></a><span class="lineno"> 1471</span> </div>
<div class="line"><a id="l01472" name="l01472"></a><span class="lineno"> 1472</span>          eflx_sh_grnd(p) = forc_rho(g)*cpair*(t_grnd(c)-thm(c))/rah(p)</div>
<div class="line"><a id="l01473" name="l01473"></a><span class="lineno"> 1473</span>          qflx_evap_soi(p) = forc_rho(g)*(qsatg(c)+qsatgdt(c)*(t_grnd(c)-tgbef(c))-forc_q(g))/raw(p)</div>
<div class="line"><a id="l01474" name="l01474"></a><span class="lineno"> 1474</span> </div>
<div class="line"><a id="l01475" name="l01475"></a><span class="lineno"> 1475</span>          <span class="comment">! Re-calculate saturated vapor pressure, specific humidity and their</span></div>
<div class="line"><a id="l01476" name="l01476"></a><span class="lineno"> 1476</span>          <span class="comment">! derivatives at lake surface</span></div>
<div class="line"><a id="l01477" name="l01477"></a><span class="lineno"> 1477</span> </div>
<div class="line"><a id="l01478" name="l01478"></a><span class="lineno"> 1478</span>          <span class="keyword">call </span>qsat(t_grnd(c), forc_pbot(g), eg, degdt, qsatg(c), qsatgdt(c))</div>
<div class="line"><a id="l01479" name="l01479"></a><span class="lineno"> 1479</span> </div>
<div class="line"><a id="l01480" name="l01480"></a><span class="lineno"> 1480</span>          dth(p)=thm(c)-t_grnd(c)</div>
<div class="line"><a id="l01481" name="l01481"></a><span class="lineno"> 1481</span>          dqh(p)=forc_q(g)-qsatg(c)</div>
<div class="line"><a id="l01482" name="l01482"></a><span class="lineno"> 1482</span> </div>
<div class="line"><a id="l01483" name="l01483"></a><span class="lineno"> 1483</span>          tstar = temp1(p)*dth(p)</div>
<div class="line"><a id="l01484" name="l01484"></a><span class="lineno"> 1484</span>          qstar = temp2(p)*dqh(p)</div>
<div class="line"><a id="l01485" name="l01485"></a><span class="lineno"> 1485</span> </div>
<div class="line"><a id="l01486" name="l01486"></a><span class="lineno"> 1486</span>          thvstar=tstar*(1._kind_lake+con_fvirt*forc_q(g)) + con_fvirt*forc_th(g)*qstar</div>
<div class="line"><a id="l01487" name="l01487"></a><span class="lineno"> 1487</span>          zeta=zldis(p)*vkc * grav*thvstar/(ustar(p)**2*thv(c))</div>
<div class="line"><a id="l01488" name="l01488"></a><span class="lineno"> 1488</span> </div>
<div class="line"><a id="l01489" name="l01489"></a><span class="lineno"> 1489</span>          <span class="keywordflow">if</span> (zeta &gt;= 0._kind_lake) <span class="keywordflow">then</span>     <span class="comment">!stable</span></div>
<div class="line"><a id="l01490" name="l01490"></a><span class="lineno"> 1490</span>             zeta = min(2._kind_lake,max(zeta,0.01_kind_lake))</div>
<div class="line"><a id="l01491" name="l01491"></a><span class="lineno"> 1491</span>             um(p) = max(ur(p),0.1_kind_lake)</div>
<div class="line"><a id="l01492" name="l01492"></a><span class="lineno"> 1492</span>          <span class="keywordflow">else</span>                     <span class="comment">!unstable</span></div>
<div class="line"><a id="l01493" name="l01493"></a><span class="lineno"> 1493</span>             zeta = max(-100._kind_lake,min(zeta,-0.01_kind_lake))</div>
<div class="line"><a id="l01494" name="l01494"></a><span class="lineno"> 1494</span>             wc = beta1*(-grav*ustar(p)*thvstar*zii/thv(c))**0.333_kind_lake</div>
<div class="line"><a id="l01495" name="l01495"></a><span class="lineno"> 1495</span>             um(p) = sqrt(ur(p)*ur(p)+wc*wc)</div>
<div class="line"><a id="l01496" name="l01496"></a><span class="lineno"> 1496</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l01497" name="l01497"></a><span class="lineno"> 1497</span>          obu(p) = zldis(p)/zeta</div>
<div class="line"><a id="l01498" name="l01498"></a><span class="lineno"> 1498</span> </div>
<div class="line"><a id="l01499" name="l01499"></a><span class="lineno"> 1499</span>          <span class="keywordflow">if</span> (obuold(p)*obu(p) &lt; 0._kind_lake) nmozsgn(p) = nmozsgn(p)+1</div>
<div class="line"><a id="l01500" name="l01500"></a><span class="lineno"> 1500</span> </div>
<div class="line"><a id="l01501" name="l01501"></a><span class="lineno"> 1501</span>          obuold(p) = obu(p)</div>
<div class="line"><a id="l01502" name="l01502"></a><span class="lineno"> 1502</span> </div>
<div class="line"><a id="l01503" name="l01503"></a><span class="lineno"> 1503</span><span class="keywordflow">       end do</span>   <span class="comment">! end of filtered pft loop</span></div>
<div class="line"><a id="l01504" name="l01504"></a><span class="lineno"> 1504</span> </div>
<div class="line"><a id="l01505" name="l01505"></a><span class="lineno"> 1505</span>       iter = iter + 1</div>
<div class="line"><a id="l01506" name="l01506"></a><span class="lineno"> 1506</span>       <span class="keywordflow">if</span> (iter &lt;= niters ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01507" name="l01507"></a><span class="lineno"> 1507</span>          <span class="comment">! Rebuild copy of pft filter for next pass through the ITERATION loop</span></div>
<div class="line"><a id="l01508" name="l01508"></a><span class="lineno"> 1508</span> </div>
<div class="line"><a id="l01509" name="l01509"></a><span class="lineno"> 1509</span>          fnold = fncopy</div>
<div class="line"><a id="l01510" name="l01510"></a><span class="lineno"> 1510</span>          fncopy = 0</div>
<div class="line"><a id="l01511" name="l01511"></a><span class="lineno"> 1511</span>          <span class="keywordflow">do</span> fp = 1, fnold</div>
<div class="line"><a id="l01512" name="l01512"></a><span class="lineno"> 1512</span>             p = fpcopy(fp)</div>
<div class="line"><a id="l01513" name="l01513"></a><span class="lineno"> 1513</span>             <span class="keywordflow">if</span> (nmozsgn(p) &lt; 3) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01514" name="l01514"></a><span class="lineno"> 1514</span>                fncopy = fncopy + 1</div>
<div class="line"><a id="l01515" name="l01515"></a><span class="lineno"> 1515</span>                fpcopy(fncopy) = p</div>
<div class="line"><a id="l01516" name="l01516"></a><span class="lineno"> 1516</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l01517" name="l01517"></a><span class="lineno"> 1517</span><span class="keywordflow">          end do</span>   <span class="comment">! end of filtered pft loop</span></div>
<div class="line"><a id="l01518" name="l01518"></a><span class="lineno"> 1518</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l01519" name="l01519"></a><span class="lineno"> 1519</span> </div>
<div class="line"><a id="l01520" name="l01520"></a><span class="lineno"> 1520</span><span class="keywordflow">    end do</span> iteration   <span class="comment">! end of stability iteration</span></div>
<div class="line"><a id="l01521" name="l01521"></a><span class="lineno"> 1521</span> </div>
<div class="line"><a id="l01522" name="l01522"></a><span class="lineno"> 1522</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l01523" name="l01523"></a><span class="lineno"> 1523</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l01524" name="l01524"></a><span class="lineno"> 1524</span>    <span class="keywordflow">do</span> fp = 1, num_shlakep</div>
<div class="line"><a id="l01525" name="l01525"></a><span class="lineno"> 1525</span>       p = filter_shlakep(fp)</div>
<div class="line"><a id="l01526" name="l01526"></a><span class="lineno"> 1526</span>       c = pcolumn(p)</div>
<div class="line"><a id="l01527" name="l01527"></a><span class="lineno"> 1527</span>       g = pgridcell(p)</div>
<div class="line"><a id="l01528" name="l01528"></a><span class="lineno"> 1528</span> </div>
<div class="line"><a id="l01529" name="l01529"></a><span class="lineno"> 1529</span>       <span class="comment">! If there is snow on the ground and t_grnd &gt; tfrz: reset t_grnd = tfrz.</span></div>
<div class="line"><a id="l01530" name="l01530"></a><span class="lineno"> 1530</span>       <span class="comment">! Re-evaluate ground fluxes.</span></div>
<div class="line"><a id="l01531" name="l01531"></a><span class="lineno"> 1531</span>       <span class="comment">! h2osno &gt; 0.5 prevents spurious fluxes.</span></div>
<div class="line"><a id="l01532" name="l01532"></a><span class="lineno"> 1532</span>       <span class="comment">! note that qsatg and qsatgdT should be f(tgbef) (PET: not sure what this</span></div>
<div class="line"><a id="l01533" name="l01533"></a><span class="lineno"> 1533</span>       <span class="comment">! comment means)</span></div>
<div class="line"><a id="l01534" name="l01534"></a><span class="lineno"> 1534</span>       <span class="comment">! Zack Subin, 3/27/09: Since they are now a function of whatever t_grnd was before cooling</span></div>
<div class="line"><a id="l01535" name="l01535"></a><span class="lineno"> 1535</span>       <span class="comment">!    to freezing temperature, then this value should be used in the derivative correction term.</span></div>
<div class="line"><a id="l01536" name="l01536"></a><span class="lineno"> 1536</span>       <span class="comment">! Should this happen if the lake temperature is below freezing, too? I&#39;ll assume that for now.</span></div>
<div class="line"><a id="l01537" name="l01537"></a><span class="lineno"> 1537</span>       <span class="comment">! Also, allow convection if ground temp is colder than lake but warmer than 4C, or warmer than </span></div>
<div class="line"><a id="l01538" name="l01538"></a><span class="lineno"> 1538</span>       <span class="comment">!    lake which is warmer than freezing but less than 4C.</span></div>
<div class="line"><a id="l01539" name="l01539"></a><span class="lineno"> 1539</span>       <span class="keywordflow">if</span> ( (h2osno(c) &gt; 0.5_kind_lake .or. t_lake(c,1) &lt;= tfrz) .and. t_grnd(c) &gt; tfrz) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01540" name="l01540"></a><span class="lineno"> 1540</span>          t_grnd_temp = t_grnd(c)</div>
<div class="line"><a id="l01541" name="l01541"></a><span class="lineno"> 1541</span>          t_grnd(c) = tfrz</div>
<div class="line"><a id="l01542" name="l01542"></a><span class="lineno"> 1542</span>          eflx_sh_grnd(p) = forc_rho(g)*cpair*(t_grnd(c)-thm(c))/rah(p)</div>
<div class="line"><a id="l01543" name="l01543"></a><span class="lineno"> 1543</span>          qflx_evap_soi(p) = forc_rho(g)*(qsatg(c)+qsatgdt(c)*(t_grnd(c)-t_grnd_temp) - forc_q(g))/raw(p)</div>
<div class="line"><a id="l01544" name="l01544"></a><span class="lineno"> 1544</span>       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (t_lake(c,1) &gt; t_grnd(c) .and. t_grnd(c) &gt; tdmax) .or. &amp;</div>
<div class="line"><a id="l01545" name="l01545"></a><span class="lineno"> 1545</span>                 (t_lake(c,1) &lt; t_grnd(c) .and. t_lake(c,1) &gt; tfrz .and. t_grnd(c) &lt; tdmax) ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01546" name="l01546"></a><span class="lineno"> 1546</span>                 <span class="comment">! Convective mixing will occur at surface</span></div>
<div class="line"><a id="l01547" name="l01547"></a><span class="lineno"> 1547</span>          t_grnd_temp = t_grnd(c)</div>
<div class="line"><a id="l01548" name="l01548"></a><span class="lineno"> 1548</span>          t_grnd(c) = t_lake(c,1)</div>
<div class="line"><a id="l01549" name="l01549"></a><span class="lineno"> 1549</span>          eflx_sh_grnd(p) = forc_rho(g)*cpair*(t_grnd(c)-thm(c))/rah(p)</div>
<div class="line"><a id="l01550" name="l01550"></a><span class="lineno"> 1550</span>          qflx_evap_soi(p) = forc_rho(g)*(qsatg(c)+qsatgdt(c)*(t_grnd(c)-t_grnd_temp) - forc_q(g))/raw(p)</div>
<div class="line"><a id="l01551" name="l01551"></a><span class="lineno"> 1551</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l01552" name="l01552"></a><span class="lineno"> 1552</span> </div>
<div class="line"><a id="l01553" name="l01553"></a><span class="lineno"> 1553</span>          <span class="comment">! Update htvp</span></div>
<div class="line"><a id="l01554" name="l01554"></a><span class="lineno"> 1554</span>       <span class="keywordflow">if</span>(.not.pergro) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01555" name="l01555"></a><span class="lineno"> 1555</span>         <span class="keywordflow">if</span> (t_grnd(c) &gt; tfrz) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01556" name="l01556"></a><span class="lineno"> 1556</span>           htvp(c) = hvap</div>
<div class="line"><a id="l01557" name="l01557"></a><span class="lineno"> 1557</span>         <span class="keywordflow">else</span></div>
<div class="line"><a id="l01558" name="l01558"></a><span class="lineno"> 1558</span>           htvp(c) = hsub</div>
<div class="line"><a id="l01559" name="l01559"></a><span class="lineno"> 1559</span><span class="keywordflow">         end if</span></div>
<div class="line"><a id="l01560" name="l01560"></a><span class="lineno"> 1560</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l01561" name="l01561"></a><span class="lineno"> 1561</span> </div>
<div class="line"><a id="l01562" name="l01562"></a><span class="lineno"> 1562</span>       <span class="comment">! Net longwave from ground to atmosphere</span></div>
<div class="line"><a id="l01563" name="l01563"></a><span class="lineno"> 1563</span> </div>
<div class="line"><a id="l01564" name="l01564"></a><span class="lineno"> 1564</span>       <span class="comment">!       eflx_lwrad_out(p) = (1._kind_lake-emg)*forc_lwrad(g) + stftg3(p)*(-3._kind_lake*tgbef(c)+4._kind_lake*t_grnd(c))</span></div>
<div class="line"><a id="l01565" name="l01565"></a><span class="lineno"> 1565</span>       <span class="comment">! What is tgbef doing in this equation? Can&#39;t it be exact now? --Zack Subin, 4/14/09</span></div>
<div class="line"><a id="l01566" name="l01566"></a><span class="lineno"> 1566</span>       eflx_lwrad_out(p) = (1._kind_lake-emg)*forc_lwrad(g) + emg*sb*t_grnd(c)**4</div>
<div class="line"><a id="l01567" name="l01567"></a><span class="lineno"> 1567</span> </div>
<div class="line"><a id="l01568" name="l01568"></a><span class="lineno"> 1568</span>       <span class="comment">! Ground heat flux</span></div>
<div class="line"><a id="l01569" name="l01569"></a><span class="lineno"> 1569</span> </div>
<div class="line"><a id="l01570" name="l01570"></a><span class="lineno"> 1570</span>       eflx_soil_grnd(p) = sabg(p) + forc_lwrad(g) - eflx_lwrad_out(p) - &amp;</div>
<div class="line"><a id="l01571" name="l01571"></a><span class="lineno"> 1571</span>            eflx_sh_grnd(p) - htvp(c)*qflx_evap_soi(p)</div>
<div class="line"><a id="l01572" name="l01572"></a><span class="lineno"> 1572</span>       <span class="comment">!Why is this sabg(p) and not beta*sabg(p)??</span></div>
<div class="line"><a id="l01573" name="l01573"></a><span class="lineno"> 1573</span>       <span class="comment">!I&#39;ve kept this as the incorrect sabg so that the energy balance check will be correct.</span></div>
<div class="line"><a id="l01574" name="l01574"></a><span class="lineno"> 1574</span>       <span class="comment">!This is the effective energy flux into the ground including the lake solar absorption</span></div>
<div class="line"><a id="l01575" name="l01575"></a><span class="lineno"> 1575</span>       <span class="comment">!below the surface.  The variable eflx_gnet will be used to pass the actual heat flux</span></div>
<div class="line"><a id="l01576" name="l01576"></a><span class="lineno"> 1576</span>       <span class="comment">!from the ground interface into the lake.</span></div>
<div class="line"><a id="l01577" name="l01577"></a><span class="lineno"> 1577</span> </div>
<div class="line"><a id="l01578" name="l01578"></a><span class="lineno"> 1578</span>       taux(p) = -forc_rho(g)*forc_u(g)/ram(p)</div>
<div class="line"><a id="l01579" name="l01579"></a><span class="lineno"> 1579</span>       tauy(p) = -forc_rho(g)*forc_v(g)/ram(p)</div>
<div class="line"><a id="l01580" name="l01580"></a><span class="lineno"> 1580</span> </div>
<div class="line"><a id="l01581" name="l01581"></a><span class="lineno"> 1581</span>       eflx_sh_tot(p)   = eflx_sh_grnd(p)</div>
<div class="line"><a id="l01582" name="l01582"></a><span class="lineno"> 1582</span>       qflx_evap_tot(p) = qflx_evap_soi(p)</div>
<div class="line"><a id="l01583" name="l01583"></a><span class="lineno"> 1583</span>       eflx_lh_tot(p)   = htvp(c)*qflx_evap_soi(p)</div>
<div class="line"><a id="l01584" name="l01584"></a><span class="lineno"> 1584</span>       eflx_lh_grnd(p)  = htvp(c)*qflx_evap_soi(p)</div>
<div class="line"><a id="l01585" name="l01585"></a><span class="lineno"> 1585</span>       <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01586" name="l01586"></a><span class="lineno"> 1586</span>1604     <span class="keyword">format</span>(<span class="stringliteral">&#39;CLM_Lake ShalLakeFluxes: c=&#39;</span>,i0,<span class="stringliteral">&#39; sensible heat = &#39;</span>,f12.4,<span class="stringliteral">&#39; latent heat =&#39;</span>,f12.4, &amp;</div>
<div class="line"><a id="l01587" name="l01587"></a><span class="lineno"> 1587</span>                <span class="stringliteral">&#39; ground temp = &#39;</span>, f12.4, <span class="stringliteral">&#39; h2osno = &#39;</span>, f12.4, <span class="stringliteral">&#39; at xlat_d=&#39;</span>,f10.3,<span class="stringliteral">&#39; xlon_d=&#39;</span>,f10.3)</div>
<div class="line"><a id="l01588" name="l01588"></a><span class="lineno"> 1588</span>         print 1604, c, eflx_sh_tot(p), eflx_lh_tot(p), t_grnd(c), h2osno(c),xlat_d,xlon_d</div>
<div class="line"><a id="l01589" name="l01589"></a><span class="lineno"> 1589</span>         <span class="keywordflow">if</span> (abs(eflx_sh_tot(p)) &gt; 1500 .or. abs(eflx_lh_tot(p)) &gt; 1500) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01590" name="l01590"></a><span class="lineno"> 1590</span>3018       <span class="keyword">format</span>(<span class="stringliteral">&#39;CLM_Lake ShalLakeFluxes: WARNING: SH=&#39;</span>,f12.4,<span class="stringliteral">&#39; LH=&#39;</span>,f12.4,<span class="stringliteral">&#39; at xlat_d=&#39;</span>,f10.3,<span class="stringliteral">&#39; xlon_d=&#39;</span>,f10.3)</div>
<div class="line"><a id="l01591" name="l01591"></a><span class="lineno"> 1591</span>           print 3018,eflx_sh_tot(p), eflx_lh_tot(p),xlat_d,xlon_d</div>
<div class="line"><a id="l01592" name="l01592"></a><span class="lineno"> 1592</span><span class="keywordflow">         end if</span></div>
<div class="line"><a id="l01593" name="l01593"></a><span class="lineno"> 1593</span>         <span class="keywordflow">if</span> (abs(eflx_sh_tot(p)) &gt; 10000 .or. abs(eflx_lh_tot(p)) &gt; 10000 &amp;</div>
<div class="line"><a id="l01594" name="l01594"></a><span class="lineno"> 1594</span>              .or. abs(t_grnd(c)-288)&gt;200 ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01595" name="l01595"></a><span class="lineno"> 1595</span>840        <span class="keyword">format</span>(<span class="stringliteral">&#39;CLM_Lake ShalLakeFluxes: t_grnd is out of range: eflx_sh_tot(p)=&#39;</span>,g20.12,<span class="stringliteral">&#39; eflx_lh_tot(p)=&#39;</span>,g20.12,<span class="stringliteral">&#39; t_grnd(c)=&#39;</span>,g20.12,<span class="stringliteral">&#39; at p=&#39;</span>,i0,<span class="stringliteral">&#39; c=&#39;</span>,i0,<span class="stringliteral">&#39; xlat_d=&#39;</span>,f10.3,<span class="stringliteral">&#39; xlon_d=&#39;</span>,f10.3)</div>
<div class="line"><a id="l01596" name="l01596"></a><span class="lineno"> 1596</span>           <span class="keyword">write</span>(message,840) eflx_sh_tot(p),eflx_lh_tot(p),t_grnd(c),p,c,xlat_d,xlon_d</div>
<div class="line"><a id="l01597" name="l01597"></a><span class="lineno"> 1597</span>           <span class="comment">! errmsg=message</span></div>
<div class="line"><a id="l01598" name="l01598"></a><span class="lineno"> 1598</span>           <span class="comment">! errflg=1</span></div>
<div class="line"><a id="l01599" name="l01599"></a><span class="lineno"> 1599</span>           <span class="keyword">write</span>(0,<span class="stringliteral">&#39;(A)&#39;</span>) trim(message)</div>
<div class="line"><a id="l01600" name="l01600"></a><span class="lineno"> 1600</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l01601" name="l01601"></a><span class="lineno"> 1601</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l01602" name="l01602"></a><span class="lineno"> 1602</span>       <span class="comment">! 2 m height air temperature</span></div>
<div class="line"><a id="l01603" name="l01603"></a><span class="lineno"> 1603</span>       t_ref2m(p) = thm(c) + temp1(p)*dth(p)*(1._kind_lake/temp12m(p) - 1._kind_lake/temp1(p))</div>
<div class="line"><a id="l01604" name="l01604"></a><span class="lineno"> 1604</span> </div>
<div class="line"><a id="l01605" name="l01605"></a><span class="lineno"> 1605</span>       <span class="comment">! 2 m height specific humidity</span></div>
<div class="line"><a id="l01606" name="l01606"></a><span class="lineno"> 1606</span>       q_ref2m(p) = forc_q(g) + temp2(p)*dqh(p)*(1._kind_lake/temp22m(p) - 1._kind_lake/temp2(p))</div>
<div class="line"><a id="l01607" name="l01607"></a><span class="lineno"> 1607</span> </div>
<div class="line"><a id="l01608" name="l01608"></a><span class="lineno"> 1608</span>       <span class="comment">! Energy residual used for melting snow</span></div>
<div class="line"><a id="l01609" name="l01609"></a><span class="lineno"> 1609</span>       <span class="comment">! Effectively moved to ShalLakeTemp</span></div>
<div class="line"><a id="l01610" name="l01610"></a><span class="lineno"> 1610</span> </div>
<div class="line"><a id="l01611" name="l01611"></a><span class="lineno"> 1611</span>       <span class="comment">! Prepare for lake layer temperature calculations below</span></div>
<div class="line"><a id="l01612" name="l01612"></a><span class="lineno"> 1612</span>       <span class="comment">! fin(c) = betaprime * sabg(p) + forc_lwrad(g) - (eflx_lwrad_out(p) + &amp;</span></div>
<div class="line"><a id="l01613" name="l01613"></a><span class="lineno"> 1613</span>       <span class="comment">!          eflx_sh_tot(p) + eflx_lh_tot(p))</span></div>
<div class="line"><a id="l01614" name="l01614"></a><span class="lineno"> 1614</span>       <span class="comment">! NOW this is just the net ground heat flux calculated below.</span></div>
<div class="line"><a id="l01615" name="l01615"></a><span class="lineno"> 1615</span> </div>
<div class="line"><a id="l01616" name="l01616"></a><span class="lineno"> 1616</span>       eflx_gnet(p) = betaprime(c) * sabg(p) + forc_lwrad(g) - (eflx_lwrad_out(p) + &amp;</div>
<div class="line"><a id="l01617" name="l01617"></a><span class="lineno"> 1617</span>            eflx_sh_tot(p) + eflx_lh_tot(p))</div>
<div class="line"><a id="l01618" name="l01618"></a><span class="lineno"> 1618</span>       <span class="comment">! This is the actual heat flux from the ground interface into the lake, not including</span></div>
<div class="line"><a id="l01619" name="l01619"></a><span class="lineno"> 1619</span>       <span class="comment">! the light that penetrates the surface.</span></div>
<div class="line"><a id="l01620" name="l01620"></a><span class="lineno"> 1620</span> </div>
<div class="line"><a id="l01621" name="l01621"></a><span class="lineno"> 1621</span>       <span class="comment">!       u2m = max(1.0_kind_lake,ustar(p)/vkc*log(2._kind_lake/z0mg(p)))</span></div>
<div class="line"><a id="l01622" name="l01622"></a><span class="lineno"> 1622</span>       <span class="comment">! u2 often goes below 1 m/s; it seems like the only reason for this minimum is to</span></div>
<div class="line"><a id="l01623" name="l01623"></a><span class="lineno"> 1623</span>       <span class="comment">! keep it from being zero in the ks equation below; 0.1 m/s is a better limit for</span></div>
<div class="line"><a id="l01624" name="l01624"></a><span class="lineno"> 1624</span>       <span class="comment">! stable conditions --ZS</span></div>
<div class="line"><a id="l01625" name="l01625"></a><span class="lineno"> 1625</span>       u2m = max(0.1_kind_lake,ustar(p)/vkc*log(2._kind_lake/z0mg(p)))</div>
<div class="line"><a id="l01626" name="l01626"></a><span class="lineno"> 1626</span> </div>
<div class="line"><a id="l01627" name="l01627"></a><span class="lineno"> 1627</span>       ws(c) = 1.2e-03_kind_lake * u2m</div>
<div class="line"><a id="l01628" name="l01628"></a><span class="lineno"> 1628</span>       ks(c) = 6.6_kind_lake*sqrt(abs(sin(lat(g))))*(u2m**(-1.84_kind_lake))</div>
<div class="line"><a id="l01629" name="l01629"></a><span class="lineno"> 1629</span> </div>
<div class="line"><a id="l01630" name="l01630"></a><span class="lineno"> 1630</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l01631" name="l01631"></a><span class="lineno"> 1631</span> </div>
<div class="line"><a id="l01632" name="l01632"></a><span class="lineno"> 1632</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l01633" name="l01633"></a><span class="lineno"> 1633</span>    <span class="comment">! End of surface flux relevant code in original BiogeophysicsLakeMod until history loop.</span></div>
<div class="line"><a id="l01634" name="l01634"></a><span class="lineno"> 1634</span> </div>
<div class="line"><a id="l01635" name="l01635"></a><span class="lineno"> 1635</span>    <span class="comment">! The following are needed for global average on history tape.</span></div>
<div class="line"><a id="l01636" name="l01636"></a><span class="lineno"> 1636</span> </div>
<div class="line"><a id="l01637" name="l01637"></a><span class="lineno"> 1637</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l01638" name="l01638"></a><span class="lineno"> 1638</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l01639" name="l01639"></a><span class="lineno"> 1639</span>    <span class="keywordflow">do</span> fp = 1, num_shlakep</div>
<div class="line"><a id="l01640" name="l01640"></a><span class="lineno"> 1640</span>       p = filter_shlakep(fp)</div>
<div class="line"><a id="l01641" name="l01641"></a><span class="lineno"> 1641</span>       c = pcolumn(p)</div>
<div class="line"><a id="l01642" name="l01642"></a><span class="lineno"> 1642</span>       g = pgridcell(p)</div>
<div class="line"><a id="l01643" name="l01643"></a><span class="lineno"> 1643</span>       <span class="comment">!       t_veg(p) = forc_t(g)</span></div>
<div class="line"><a id="l01644" name="l01644"></a><span class="lineno"> 1644</span>        <span class="comment">!This is an odd choice, since elsewhere t_veg = t_grnd for bare ground.</span></div>
<div class="line"><a id="l01645" name="l01645"></a><span class="lineno"> 1645</span>        <span class="comment">!Zack Subin, 4/09</span></div>
<div class="line"><a id="l01646" name="l01646"></a><span class="lineno"> 1646</span>       t_veg(p) = t_grnd(c)</div>
<div class="line"><a id="l01647" name="l01647"></a><span class="lineno"> 1647</span>       eflx_lwrad_net(p)  = eflx_lwrad_out(p) - forc_lwrad(g)</div>
<div class="line"><a id="l01648" name="l01648"></a><span class="lineno"> 1648</span>       qflx_prec_grnd(p) = forc_rain(g) + forc_snow(g)</div>
<div class="line"><a id="l01649" name="l01649"></a><span class="lineno"> 1649</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l01650" name="l01650"></a><span class="lineno"> 1650</span> </div>
<div class="line"><a id="l01651" name="l01651"></a><span class="lineno"> 1651</span>    ustar_out(1) = ustar(1)</div>
<div class="line"><a id="l01652" name="l01652"></a><span class="lineno"> 1652</span> </div>
<div class="line"><a id="l01653" name="l01653"></a><span class="lineno"> 1653</span> </div>
</div>
<div class="line"><a id="l01654" name="l01654"></a><span class="lineno"> 1654</span><span class="keyword">END SUBROUTINE </span>shallakefluxes</div>
<div class="line"><a id="l01655" name="l01655"></a><span class="lineno"> 1655</span> </div>
<div class="foldopen" id="foldopen01656" data-start="" data-end="">
<div class="line"><a id="l01656" name="l01656"></a><span class="lineno"><a class="line" href="namespaceclm__lake_adde4522aabff9fa7dcd826ce3997ed5f.html#adde4522aabff9fa7dcd826ce3997ed5f"> 1656</a></span><span class="keyword">SUBROUTINE </span>shallaketemperature(t_grnd,h2osno,sabg,dz,dz_lake,z,zi,           &amp; !i</div>
<div class="line"><a id="l01657" name="l01657"></a><span class="lineno"> 1657</span>                                 z_lake,ws,ks,snl,eflx_gnet,lakedepth,       &amp;</div>
<div class="line"><a id="l01658" name="l01658"></a><span class="lineno"> 1658</span>                                 lake_icefrac,snowdp,                        &amp; !i&amp;o</div>
<div class="line"><a id="l01659" name="l01659"></a><span class="lineno"> 1659</span>                                 eflx_sh_grnd,eflx_sh_tot,eflx_soil_grnd,    &amp; !o</div>
<div class="line"><a id="l01660" name="l01660"></a><span class="lineno"> 1660</span>                                 t_lake,t_soisno,h2osoi_liq,                 &amp;</div>
<div class="line"><a id="l01661" name="l01661"></a><span class="lineno"> 1661</span>                                 h2osoi_ice,savedtke1,                       &amp;</div>
<div class="line"><a id="l01662" name="l01662"></a><span class="lineno"> 1662</span>                                 watsat, tksatu, tkmg, tkdry, csol, dtime,   &amp;</div>
<div class="line"><a id="l01663" name="l01663"></a><span class="lineno"> 1663</span>                                 frac_iceold,qflx_snomelt,imelt,errmsg,errflg,xlat_d,xlon_d)</div>
<div class="line"><a id="l01664" name="l01664"></a><span class="lineno"> 1664</span>  <span class="comment">!=======================================================================================================</span></div>
<div class="line"><a id="l01665" name="l01665"></a><span class="lineno"> 1665</span>  <span class="comment">! DESCRIPTION:</span></div>
<div class="line"><a id="l01666" name="l01666"></a><span class="lineno"> 1666</span>  <span class="comment">!&lt; Calculates temperatures in the 20-25 layer column of (possible) snow,</span></div>
<div class="line"><a id="l01667" name="l01667"></a><span class="lineno"> 1667</span><span class="comment">  !! lake water, and soil beneath lake.</span></div>
<div class="line"><a id="l01668" name="l01668"></a><span class="lineno"> 1668</span><span class="comment">  !! Snow and soil temperatures are determined as in SoilTemperature, except</span></div>
<div class="line"><a id="l01669" name="l01669"></a><span class="lineno"> 1669</span><span class="comment">  !! for appropriate boundary conditions at the top of the snow (the flux is fixed</span></div>
<div class="line"><a id="l01670" name="l01670"></a><span class="lineno"> 1670</span><span class="comment">  !! to be the ground heat flux calculated in ShalLakeFluxes), the bottom of the snow</span></div>
<div class="line"><a id="l01671" name="l01671"></a><span class="lineno"> 1671</span><span class="comment">  !! (adjacent to top lake layer), and the top of the soil (adjacent to the bottom</span></div>
<div class="line"><a id="l01672" name="l01672"></a><span class="lineno"> 1672</span><span class="comment">  !! lake layer). Also, the soil is assumed to be always fully saturated (ShalLakeHydrology</span></div>
<div class="line"><a id="l01673" name="l01673"></a><span class="lineno"> 1673</span><span class="comment">  !! will have to insure this). The whole column is solved simultaneously as one tridiagonal matrix.</span></div>
<div class="line"><a id="l01674" name="l01674"></a><span class="lineno"> 1674</span><span class="comment">  !! Lake temperatures are determined from the Hostetler model as before, except now:</span></div>
<div class="line"><a id="l01675" name="l01675"></a><span class="lineno"> 1675</span><span class="comment">  !!\n    i) Lake water layers can freeze by any fraction and release latent heat; thermal</span></div>
<div class="line"><a id="l01676" name="l01676"></a><span class="lineno"> 1676</span><span class="comment">  !!       and mechanical properties are adjusted for ice fraction.</span></div>
<div class="line"><a id="l01677" name="l01677"></a><span class="lineno"> 1677</span><span class="comment">  !!\n   ii) Convective mixing (though not eddy diffusion) still occurs for frozen lakes.</span></div>
<div class="line"><a id="l01678" name="l01678"></a><span class="lineno"> 1678</span><span class="comment">  !!\n  iii) No sunlight is absorbed in the lake if there are snow layers.</span></div>
<div class="line"><a id="l01679" name="l01679"></a><span class="lineno"> 1679</span><span class="comment">  !!\n   iv) Light is allowed to reach the top soil layer (where it is assumed to be completely absorbed).</span></div>
<div class="line"><a id="l01680" name="l01680"></a><span class="lineno"> 1680</span><span class="comment">  !!\n    v) Lakes have variable depth, set ultimately in surface data set but now in initShalLakeMod.</span></div>
<div class="line"><a id="l01681" name="l01681"></a><span class="lineno"> 1681</span>  <span class="comment">!</span></div>
<div class="line"><a id="l01682" name="l01682"></a><span class="lineno"> 1682</span>  <span class="comment">! Eddy + molecular diffusion:</span></div>
<div class="line"><a id="l01683" name="l01683"></a><span class="lineno"> 1683</span>  <span class="comment">! d ts    d            d ts     1 ds</span></div>
<div class="line"><a id="l01684" name="l01684"></a><span class="lineno"> 1684</span>  <span class="comment">! ---- = -- [(km + ke) ----] + -- --</span></div>
<div class="line"><a id="l01685" name="l01685"></a><span class="lineno"> 1685</span>  <span class="comment">!  dt    dz             dz     cw dz</span></div>
<div class="line"><a id="l01686" name="l01686"></a><span class="lineno"> 1686</span>  <span class="comment">!</span></div>
<div class="line"><a id="l01687" name="l01687"></a><span class="lineno"> 1687</span>  <span class="comment">! where: ts = temperature (kelvin)</span></div>
<div class="line"><a id="l01688" name="l01688"></a><span class="lineno"> 1688</span>  <span class="comment">!         t = time (s)</span></div>
<div class="line"><a id="l01689" name="l01689"></a><span class="lineno"> 1689</span>  <span class="comment">!         z = depth (m)</span></div>
<div class="line"><a id="l01690" name="l01690"></a><span class="lineno"> 1690</span>  <span class="comment">!        km = molecular diffusion coefficient (m**2/s)</span></div>
<div class="line"><a id="l01691" name="l01691"></a><span class="lineno"> 1691</span>  <span class="comment">!        ke = eddy diffusion coefficient (m**2/s)</span></div>
<div class="line"><a id="l01692" name="l01692"></a><span class="lineno"> 1692</span>  <span class="comment">!        cw = heat capacity (j/m**3/kelvin)</span></div>
<div class="line"><a id="l01693" name="l01693"></a><span class="lineno"> 1693</span>  <span class="comment">!         s = heat source term (w/m**2)</span></div>
<div class="line"><a id="l01694" name="l01694"></a><span class="lineno"> 1694</span>  <span class="comment">!</span></div>
<div class="line"><a id="l01695" name="l01695"></a><span class="lineno"> 1695</span>  <span class="comment">!   Shallow lakes are allowed to have variable depth, set in _____.</span></div>
<div class="line"><a id="l01696" name="l01696"></a><span class="lineno"> 1696</span>  <span class="comment">!</span></div>
<div class="line"><a id="l01697" name="l01697"></a><span class="lineno"> 1697</span>  <span class="comment">!   For shallow lakes:    ke &gt; 0 if unfrozen,</span></div>
<div class="line"><a id="l01698" name="l01698"></a><span class="lineno"> 1698</span>  <span class="comment">!       and convective mixing occurs WHETHER OR NOT frozen. (See e.g. Martynov...)</span></div>
<div class="line"><a id="l01699" name="l01699"></a><span class="lineno"> 1699</span>  <span class="comment">!</span></div>
<div class="line"><a id="l01700" name="l01700"></a><span class="lineno"> 1700</span>  <span class="comment">! Use the Crank-Nicholson method to set up tridiagonal system of equations to</span></div>
<div class="line"><a id="l01701" name="l01701"></a><span class="lineno"> 1701</span>  <span class="comment">! solve for ts at time n+1, where the temperature equation for layer i is</span></div>
<div class="line"><a id="l01702" name="l01702"></a><span class="lineno"> 1702</span>  <span class="comment">! r_i = a_i [ts_i-1] n+1 + b_i [ts_i] n+1 + c_i [ts_i+1] n+1</span></div>
<div class="line"><a id="l01703" name="l01703"></a><span class="lineno"> 1703</span>  <span class="comment">!</span></div>
<div class="line"><a id="l01704" name="l01704"></a><span class="lineno"> 1704</span>  <span class="comment">! The solution conserves energy as:</span></div>
<div class="line"><a id="l01705" name="l01705"></a><span class="lineno"> 1705</span>  <span class="comment">!</span></div>
<div class="line"><a id="l01706" name="l01706"></a><span class="lineno"> 1706</span>  <span class="comment">! [For lake layers]</span></div>
<div class="line"><a id="l01707" name="l01707"></a><span class="lineno"> 1707</span>  <span class="comment">! cw*([ts(      1)] n+1 - [ts(      1)] n)*dz(      1)/dt + ... +</span></div>
<div class="line"><a id="l01708" name="l01708"></a><span class="lineno"> 1708</span>  <span class="comment">! cw*([ts(nlevlake)] n+1 - [ts(nlevlake)] n)*dz(nlevlake)/dt = fin</span></div>
<div class="line"><a id="l01709" name="l01709"></a><span class="lineno"> 1709</span>  <span class="comment">! But now there is phase change, so cv is not constant and there is</span></div>
<div class="line"><a id="l01710" name="l01710"></a><span class="lineno"> 1710</span>  <span class="comment">! latent heat.</span></div>
<div class="line"><a id="l01711" name="l01711"></a><span class="lineno"> 1711</span>  <span class="comment">!</span></div>
<div class="line"><a id="l01712" name="l01712"></a><span class="lineno"> 1712</span>  <span class="comment">! where:</span></div>
<div class="line"><a id="l01713" name="l01713"></a><span class="lineno"> 1713</span>  <span class="comment">! [ts] n   = old temperature (kelvin)</span></div>
<div class="line"><a id="l01714" name="l01714"></a><span class="lineno"> 1714</span>  <span class="comment">! [ts] n+1 = new temperature (kelvin)</span></div>
<div class="line"><a id="l01715" name="l01715"></a><span class="lineno"> 1715</span>  <span class="comment">! fin      = heat flux into lake (w/m**2)</span></div>
<div class="line"><a id="l01716" name="l01716"></a><span class="lineno"> 1716</span>  <span class="comment">!          = betaprime*sabg + forc_lwrad - eflx_lwrad_out - eflx_sh_tot - eflx_lh_tot</span></div>
<div class="line"><a id="l01717" name="l01717"></a><span class="lineno"> 1717</span>  <span class="comment">!          (This is now the same as the ground heat flux.)</span></div>
<div class="line"><a id="l01718" name="l01718"></a><span class="lineno"> 1718</span>  <span class="comment">!            + phi(1) + ... + phi(nlevlake) + phi(top soil level)</span></div>
<div class="line"><a id="l01719" name="l01719"></a><span class="lineno"> 1719</span>  <span class="comment">! betaprime = beta(islak) for no snow layers, and 1 for snow layers.</span></div>
<div class="line"><a id="l01720" name="l01720"></a><span class="lineno"> 1720</span>  <span class="comment">! This assumes all radiation is absorbed in the top snow layer and will need</span></div>
<div class="line"><a id="l01721" name="l01721"></a><span class="lineno"> 1721</span>  <span class="comment">! to be changed for CLM 4.</span></div>
<div class="line"><a id="l01722" name="l01722"></a><span class="lineno"> 1722</span>  <span class="comment">!</span></div>
<div class="line"><a id="l01723" name="l01723"></a><span class="lineno"> 1723</span>  <span class="comment">! WARNING: This subroutine assumes lake columns have one and only one pft.</span></div>
<div class="line"><a id="l01724" name="l01724"></a><span class="lineno"> 1724</span>  <span class="comment">!</span></div>
<div class="line"><a id="l01725" name="l01725"></a><span class="lineno"> 1725</span>  <span class="comment">! Outline:</span></div>
<div class="line"><a id="l01726" name="l01726"></a><span class="lineno"> 1726</span>  <span class="comment">! 1!) Initialization</span></div>
<div class="line"><a id="l01727" name="l01727"></a><span class="lineno"> 1727</span>  <span class="comment">! 2!) Lake density</span></div>
<div class="line"><a id="l01728" name="l01728"></a><span class="lineno"> 1728</span>  <span class="comment">! 3!) Diffusivity</span></div>
<div class="line"><a id="l01729" name="l01729"></a><span class="lineno"> 1729</span>  <span class="comment">! 4!) Heat source term from solar radiation penetrating lake</span></div>
<div class="line"><a id="l01730" name="l01730"></a><span class="lineno"> 1730</span>  <span class="comment">! 5!) Set thermal props and find initial energy content</span></div>
<div class="line"><a id="l01731" name="l01731"></a><span class="lineno"> 1731</span>  <span class="comment">! 6!) Set up vectors for tridiagonal matrix solution</span></div>
<div class="line"><a id="l01732" name="l01732"></a><span class="lineno"> 1732</span>  <span class="comment">! 7!) Solve tridiagonal and back-substitute</span></div>
<div class="line"><a id="l01733" name="l01733"></a><span class="lineno"> 1733</span>  <span class="comment">! 8!) (Optional) Do first energy check using temperature change at constant heat capacity.</span></div>
<div class="line"><a id="l01734" name="l01734"></a><span class="lineno"> 1734</span>  <span class="comment">! 9!) Phase change</span></div>
<div class="line"><a id="l01735" name="l01735"></a><span class="lineno"> 1735</span>  <span class="comment">! 9.5!) (Optional) Do second energy check using temperature change and latent heat, considering changed heat capacity.</span></div>
<div class="line"><a id="l01736" name="l01736"></a><span class="lineno"> 1736</span>  <span class="comment">!                  Also do soil water balance check.</span></div>
<div class="line"><a id="l01737" name="l01737"></a><span class="lineno"> 1737</span>  <span class="comment">!10!) Convective mixing </span></div>
<div class="line"><a id="l01738" name="l01738"></a><span class="lineno"> 1738</span>  <span class="comment">!11!) Do final energy check to detect small numerical errors (especially from convection)</span></div>
<div class="line"><a id="l01739" name="l01739"></a><span class="lineno"> 1739</span>  <span class="comment">!     and dump small imbalance into sensible heat, or pass large errors to BalanceCheckMod for abort.</span></div>
<div class="line"><a id="l01740" name="l01740"></a><span class="lineno"> 1740</span>  <span class="comment">!</span></div>
<div class="line"><a id="l01741" name="l01741"></a><span class="lineno"> 1741</span>  <span class="comment">! REVISION HISTORY:</span></div>
<div class="line"><a id="l01742" name="l01742"></a><span class="lineno"> 1742</span>  <span class="comment">! Created by Zack Subin, 2009.</span></div>
<div class="line"><a id="l01743" name="l01743"></a><span class="lineno"> 1743</span>  <span class="comment">! Reedited by Hongping Gu, 2010.</span></div>
<div class="line"><a id="l01744" name="l01744"></a><span class="lineno"> 1744</span>  <span class="comment">! Updated for CCPP by Sam Trahan, 2022.</span></div>
<div class="line"><a id="l01745" name="l01745"></a><span class="lineno"> 1745</span>  <span class="comment">!=========================================================================================================</span></div>
<div class="line"><a id="l01746" name="l01746"></a><span class="lineno"> 1746</span>  </div>
<div class="line"><a id="l01747" name="l01747"></a><span class="lineno"> 1747</span>    </div>
<div class="line"><a id="l01748" name="l01748"></a><span class="lineno"> 1748</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l01749" name="l01749"></a><span class="lineno"> 1749</span> </div>
<div class="line"><a id="l01750" name="l01750"></a><span class="lineno"> 1750</span>    <span class="comment">!in:</span></div>
<div class="line"><a id="l01751" name="l01751"></a><span class="lineno"> 1751</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: xlat_d<span class="comment">                  !&lt; latitude (degrees)</span></div>
<div class="line"><a id="l01752" name="l01752"></a><span class="lineno"> 1752</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: xlon_d<span class="comment">                  !&lt; longitude (degrees)</span></div>
<div class="line"><a id="l01753" name="l01753"></a><span class="lineno"> 1753</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: errflg<span class="comment">                       !&lt;</span></div>
<div class="line"><a id="l01754" name="l01754"></a><span class="lineno"> 1754</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: watsat(1,nlevsoil)<span class="comment">      !&lt; volumetric soil water at saturation (porosity)</span></div>
<div class="line"><a id="l01755" name="l01755"></a><span class="lineno"> 1755</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: tksatu(1,nlevsoil)<span class="comment">      !&lt; thermal conductivity, saturated soil [W/m-K]</span></div>
<div class="line"><a id="l01756" name="l01756"></a><span class="lineno"> 1756</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: tkmg(1,nlevsoil)<span class="comment">        !&lt; thermal conductivity, soil minerals  [W/m-K]</span></div>
<div class="line"><a id="l01757" name="l01757"></a><span class="lineno"> 1757</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: tkdry(1,nlevsoil)<span class="comment">       !&lt; thermal conductivity, dry soil (W/m/Kelvin)</span></div>
<div class="line"><a id="l01758" name="l01758"></a><span class="lineno"> 1758</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: csol(1,nlevsoil)<span class="comment">        !&lt; heat capacity, soil solids (J/m**3/Kelvin)</span></div>
<div class="line"><a id="l01759" name="l01759"></a><span class="lineno"> 1759</span>    <span class="keywordtype">character(*)</span>, <span class="keywordtype">intent(inout)</span> :: errmsg<span class="comment">                  !&lt;</span></div>
<div class="line"><a id="l01760" name="l01760"></a><span class="lineno"> 1760</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: t_grnd(1)<span class="comment">               !&lt; ground temperature (Kelvin)</span></div>
<div class="line"><a id="l01761" name="l01761"></a><span class="lineno"> 1761</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osno(1)<span class="comment">            !&lt; snow water (mm H2O)</span></div>
<div class="line"><a id="l01762" name="l01762"></a><span class="lineno"> 1762</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: sabg(1)<span class="comment">                 !&lt; solar radiation absorbed by ground (W/m**2)</span></div>
<div class="line"><a id="l01763" name="l01763"></a><span class="lineno"> 1763</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: dz(1,-nlevsnow + 1:nlevsoil)<span class="comment">         !&lt; layer thickness for snow &amp; soil (m)</span></div>
<div class="line"><a id="l01764" name="l01764"></a><span class="lineno"> 1764</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: dz_lake(1,nlevlake)<span class="comment">                  !&lt; layer thickness for lake (m)</span></div>
<div class="line"><a id="l01765" name="l01765"></a><span class="lineno"> 1765</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: z(1,-nlevsnow+1:nlevsoil)<span class="comment">            !&lt; layer depth for snow &amp; soil (m)</span></div>
<div class="line"><a id="l01766" name="l01766"></a><span class="lineno"> 1766</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: zi(1,-nlevsnow+0:nlevsoil)<span class="comment">           !&lt; interface level below a &quot;z&quot; level (m)</span></div>
<div class="line"><a id="l01767" name="l01767"></a><span class="lineno"> 1767</span><span class="comment">                                                                        !! the other z and dz variables</span></div>
<div class="line"><a id="l01768" name="l01768"></a><span class="lineno"> 1768</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: z_lake(1,nlevlake)<span class="comment">  !&lt; layer depth for lake (m)</span></div>
<div class="line"><a id="l01769" name="l01769"></a><span class="lineno"> 1769</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: ws(1)<span class="comment">               !&lt; surface friction velocity (m/s)</span></div>
<div class="line"><a id="l01770" name="l01770"></a><span class="lineno"> 1770</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: ks(1)<span class="comment">               !&lt; coefficient passed to ShalLakeTemperature</span></div>
<div class="line"><a id="l01771" name="l01771"></a><span class="lineno"> 1771</span><span class="comment">                                                       !! for calculation of decay of eddy diffusivity with depth</span></div>
<div class="line"><a id="l01772" name="l01772"></a><span class="lineno"> 1772</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span> :: snl(1)<span class="comment">                     !&lt; negative of number of snow layers</span></div>
<div class="line"><a id="l01773" name="l01773"></a><span class="lineno"> 1773</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: eflx_gnet(1)<span class="comment">     !&lt; net heat flux into ground (W/m**2) at the surface interface</span></div>
<div class="line"><a id="l01774" name="l01774"></a><span class="lineno"> 1774</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: lakedepth(1)<span class="comment">        !&lt; column lake depth (m)</span></div>
<div class="line"><a id="l01775" name="l01775"></a><span class="lineno"> 1775</span>    </div>
<div class="line"><a id="l01776" name="l01776"></a><span class="lineno"> 1776</span>   <span class="comment">! real(kind_lake), intent(in) :: watsat(1,nlevsoil)      ! volumetric soil water at saturation (porosity)</span></div>
<div class="line"><a id="l01777" name="l01777"></a><span class="lineno"> 1777</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: snowdp(1)<span class="comment">        !&lt; snow height (m)</span></div>
<div class="line"><a id="l01778" name="l01778"></a><span class="lineno"> 1778</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: dtime<span class="comment">               !&lt; timestep</span></div>
<div class="line"><a id="l01779" name="l01779"></a><span class="lineno"> 1779</span>    <span class="comment">!out: </span></div>
<div class="line"><a id="l01780" name="l01780"></a><span class="lineno"> 1780</span> </div>
<div class="line"><a id="l01781" name="l01781"></a><span class="lineno"> 1781</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: eflx_sh_grnd(1)<span class="comment">    !&lt; sensible heat flux from ground (W/m**2) [+ to atm]</span></div>
<div class="line"><a id="l01782" name="l01782"></a><span class="lineno"> 1782</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: eflx_sh_tot(1)<span class="comment">     !&lt; total sensible heat flux (W/m**2) [+ to atm]</span></div>
<div class="line"><a id="l01783" name="l01783"></a><span class="lineno"> 1783</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: eflx_soil_grnd(1)<span class="comment">  !&lt; heat flux into snow / lake (W/m**2) [+ = into soil]</span></div>
<div class="line"><a id="l01784" name="l01784"></a><span class="lineno"> 1784</span><span class="comment">                                                       !! Here this includes the whole lake radiation absorbed.</span></div>
<div class="line"><a id="l01785" name="l01785"></a><span class="lineno"> 1785</span>    <span class="comment">!real(kind_lake), intent(out) :: qmelt(1)          !&lt; snow melt [mm/s] [temporary]</span></div>
<div class="line"><a id="l01786" name="l01786"></a><span class="lineno"> 1786</span> </div>
<div class="line"><a id="l01787" name="l01787"></a><span class="lineno"> 1787</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: t_lake(1,nlevlake)<span class="comment">                  !&lt; lake temperature (Kelvin)</span></div>
<div class="line"><a id="l01788" name="l01788"></a><span class="lineno"> 1788</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: t_soisno(1,-nlevsnow+1:nlevsoil)<span class="comment">    !&lt; soil (or snow) temperature (Kelvin)</span></div>
<div class="line"><a id="l01789" name="l01789"></a><span class="lineno"> 1789</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osoi_liq(1,-nlevsnow+1:nlevsoil)<span class="comment">  !&lt; liquid water (kg/m2) [for snow &amp; soil layers]</span></div>
<div class="line"><a id="l01790" name="l01790"></a><span class="lineno"> 1790</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osoi_ice(1,-nlevsnow+1:nlevsoil)<span class="comment">  !&lt; ice lens (kg/m2) [for snow &amp; soil layers]</span></div>
<div class="line"><a id="l01791" name="l01791"></a><span class="lineno"> 1791</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: lake_icefrac(1,nlevlake)<span class="comment">            !&lt; mass fraction of lake layer that is frozen</span></div>
<div class="line"><a id="l01792" name="l01792"></a><span class="lineno"> 1792</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: savedtke1(1)<span class="comment">                          !&lt; top level thermal conductivity (W/mK)</span></div>
<div class="line"><a id="l01793" name="l01793"></a><span class="lineno"> 1793</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: frac_iceold(1,-nlevsnow+1:nlevsoil)<span class="comment">   !&lt; fraction of ice relative to the tot water</span></div>
<div class="line"><a id="l01794" name="l01794"></a><span class="lineno"> 1794</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_snomelt(1)<span class="comment">  !&lt; snow melt (mm H2O /s)</span></div>
<div class="line"><a id="l01795" name="l01795"></a><span class="lineno"> 1795</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(out)</span>  :: imelt(1,-nlevsnow+1:nlevsoil)<span class="comment">        !&lt; flag for melting (=1), freezing (=2), Not=0 (new)</span></div>
<div class="line"><a id="l01796" name="l01796"></a><span class="lineno"> 1796</span> </div>
<div class="line"><a id="l01797" name="l01797"></a><span class="lineno"> 1797</span> </div>
<div class="line"><a id="l01798" name="l01798"></a><span class="lineno"> 1798</span>    <span class="comment">! OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l01799" name="l01799"></a><span class="lineno"> 1799</span> </div>
<div class="line"><a id="l01800" name="l01800"></a><span class="lineno"> 1800</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">parameter</span>  :: islak = 2     <span class="comment">! index of lake, 1 = deep lake, 2 = shallow lake</span></div>
<div class="line"><a id="l01801" name="l01801"></a><span class="lineno"> 1801</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span>  :: p0 = 1._kind_lake     <span class="comment">! neutral value of turbulent prandtl number</span></div>
<div class="line"><a id="l01802" name="l01802"></a><span class="lineno"> 1802</span>    <span class="keywordtype">integer</span>  :: i,j,fc,fp,g,c,p         <span class="comment">! do loop or array index</span></div>
<div class="line"><a id="l01803" name="l01803"></a><span class="lineno"> 1803</span><span class="keywordtype">    real</span>(kind_lake) :: eta(2)                  <span class="comment">! light extinction coefficient (/m): depends on lake type</span></div>
<div class="line"><a id="l01804" name="l01804"></a><span class="lineno"> 1804</span><span class="keywordtype">    real</span>(kind_lake) :: cwat                    <span class="comment">! specific heat capacity of water (j/m**3/kelvin)</span></div>
<div class="line"><a id="l01805" name="l01805"></a><span class="lineno"> 1805</span><span class="keywordtype">    real</span>(kind_lake) :: cice_eff                <span class="comment">! effective heat capacity of ice (using density of</span></div>
<div class="line"><a id="l01806" name="l01806"></a><span class="lineno"> 1806</span>                                          <span class="comment">! water because layer depth is not adjusted when freezing</span></div>
<div class="line"><a id="l01807" name="l01807"></a><span class="lineno"> 1807</span><span class="keywordtype">    real</span>(kind_lake) :: cfus                    <span class="comment">! effective heat of fusion per unit volume</span></div>
<div class="line"><a id="l01808" name="l01808"></a><span class="lineno"> 1808</span>                                          <span class="comment">! using water density as above</span></div>
<div class="line"><a id="l01809" name="l01809"></a><span class="lineno"> 1809</span><span class="keywordtype">    real</span>(kind_lake) :: km                      <span class="comment">! molecular diffusion coefficient (m**2/s)</span></div>
<div class="line"><a id="l01810" name="l01810"></a><span class="lineno"> 1810</span><span class="keywordtype">    real</span>(kind_lake) :: tkice_eff               <span class="comment">! effective conductivity since layer depth is constant</span></div>
<div class="line"><a id="l01811" name="l01811"></a><span class="lineno"> 1811</span><span class="keywordtype">    real</span>(kind_lake) :: a(lbc:ubc,-nlevsnow+1:nlevlake+nlevsoil)      <span class="comment">! &quot;a&quot; vector for tridiagonal matrix</span></div>
<div class="line"><a id="l01812" name="l01812"></a><span class="lineno"> 1812</span><span class="keywordtype">    real</span>(kind_lake) :: b(lbc:ubc,-nlevsnow+1:nlevlake+nlevsoil)      <span class="comment">! &quot;b&quot; vector for tridiagonal matrix</span></div>
<div class="line"><a id="l01813" name="l01813"></a><span class="lineno"> 1813</span><span class="keywordtype">    real</span>(kind_lake) :: c1(lbc:ubc,-nlevsnow+1:nlevlake+nlevsoil)     <span class="comment">! &quot;c&quot; vector for tridiagonal matrix</span></div>
<div class="line"><a id="l01814" name="l01814"></a><span class="lineno"> 1814</span><span class="keywordtype">    real</span>(kind_lake) :: r(lbc:ubc,-nlevsnow+1:nlevlake+nlevsoil)      <span class="comment">! &quot;r&quot; vector for tridiagonal solution</span></div>
<div class="line"><a id="l01815" name="l01815"></a><span class="lineno"> 1815</span><span class="keywordtype">    real</span>(kind_lake) :: rhow(lbc:ubc,nlevlake)   <span class="comment">! density of water (kg/m**3)</span></div>
<div class="line"><a id="l01816" name="l01816"></a><span class="lineno"> 1816</span><span class="keywordtype">    real</span>(kind_lake) :: phi(lbc:ubc,nlevlake)    <span class="comment">! solar radiation absorbed by layer (w/m**2)</span></div>
<div class="line"><a id="l01817" name="l01817"></a><span class="lineno"> 1817</span><span class="keywordtype">    real</span>(kind_lake) :: kme(lbc:ubc,nlevlake)    <span class="comment">! molecular + eddy diffusion coefficient (m**2/s)</span></div>
<div class="line"><a id="l01818" name="l01818"></a><span class="lineno"> 1818</span><span class="keywordtype">    real</span>(kind_lake) :: rsfin                   <span class="comment">! relative flux of solar radiation into layer</span></div>
<div class="line"><a id="l01819" name="l01819"></a><span class="lineno"> 1819</span><span class="keywordtype">    real</span>(kind_lake) :: rsfout                  <span class="comment">! relative flux of solar radiation out of layer</span></div>
<div class="line"><a id="l01820" name="l01820"></a><span class="lineno"> 1820</span><span class="keywordtype">    real</span>(kind_lake) :: phi_soil(lbc:ubc)       <span class="comment">! solar radiation into top soil layer (W/m**2)</span></div>
<div class="line"><a id="l01821" name="l01821"></a><span class="lineno"> 1821</span><span class="keywordtype">    real</span>(kind_lake) :: ri                      <span class="comment">! richardson number</span></div>
<div class="line"><a id="l01822" name="l01822"></a><span class="lineno"> 1822</span><span class="keywordtype">    real</span>(kind_lake) :: fin(lbc:ubc)            <span class="comment">! net heat flux into lake at ground interface (w/m**2)</span></div>
<div class="line"><a id="l01823" name="l01823"></a><span class="lineno"> 1823</span><span class="keywordtype">    real</span>(kind_lake) :: ocvts(lbc:ubc)          <span class="comment">! (cwat*(t_lake[n  ])*dz</span></div>
<div class="line"><a id="l01824" name="l01824"></a><span class="lineno"> 1824</span><span class="keywordtype">    real</span>(kind_lake) :: ncvts(lbc:ubc)          <span class="comment">! (cwat*(t_lake[n+1])*dz</span></div>
<div class="line"><a id="l01825" name="l01825"></a><span class="lineno"> 1825</span><span class="keywordtype">    real</span>(kind_lake) :: ke                      <span class="comment">! eddy diffusion coefficient (m**2/s)</span></div>
<div class="line"><a id="l01826" name="l01826"></a><span class="lineno"> 1826</span><span class="keywordtype">    real</span>(kind_lake) :: zin                     <span class="comment">! depth at top of layer (m)</span></div>
<div class="line"><a id="l01827" name="l01827"></a><span class="lineno"> 1827</span><span class="keywordtype">    real</span>(kind_lake) :: zout                    <span class="comment">! depth at bottom of layer (m)</span></div>
<div class="line"><a id="l01828" name="l01828"></a><span class="lineno"> 1828</span><span class="keywordtype">    real</span>(kind_lake) :: drhodz                  <span class="comment">! d [rhow] /dz (kg/m**4)</span></div>
<div class="line"><a id="l01829" name="l01829"></a><span class="lineno"> 1829</span><span class="keywordtype">    real</span>(kind_lake) :: n2                      <span class="comment">! brunt-vaisala frequency (/s**2)</span></div>
<div class="line"><a id="l01830" name="l01830"></a><span class="lineno"> 1830</span><span class="keywordtype">    real</span>(kind_lake) :: num                     <span class="comment">! used in calculating ri</span></div>
<div class="line"><a id="l01831" name="l01831"></a><span class="lineno"> 1831</span><span class="keywordtype">    real</span>(kind_lake) :: den                     <span class="comment">! used in calculating ri</span></div>
<div class="line"><a id="l01832" name="l01832"></a><span class="lineno"> 1832</span><span class="keywordtype">    real</span>(kind_lake) :: tav_froz(lbc:ubc)       <span class="comment">! used in aver temp for convectively mixed layers (C)</span></div>
<div class="line"><a id="l01833" name="l01833"></a><span class="lineno"> 1833</span><span class="keywordtype">    real</span>(kind_lake) :: tav_unfr(lbc:ubc)       <span class="comment">! &quot;</span></div>
<div class="line"><a id="l01834" name="l01834"></a><span class="lineno"> 1834</span><span class="keywordtype">    real</span>(kind_lake) :: nav(lbc:ubc)            <span class="comment">! used in aver temp for convectively mixed layers</span></div>
<div class="line"><a id="l01835" name="l01835"></a><span class="lineno"> 1835</span><span class="keywordtype">    real</span>(kind_lake) :: phidum                  <span class="comment">! temporary value of phi</span></div>
<div class="line"><a id="l01836" name="l01836"></a><span class="lineno"> 1836</span><span class="keywordtype">    real</span>(kind_lake) :: iceav(lbc:ubc)          <span class="comment">! used in calc aver ice for convectively mixed layers</span></div>
<div class="line"><a id="l01837" name="l01837"></a><span class="lineno"> 1837</span><span class="keywordtype">    real</span>(kind_lake) :: qav(lbc:ubc)            <span class="comment">! used in calc aver heat content for conv. mixed layers</span></div>
<div class="line"><a id="l01838" name="l01838"></a><span class="lineno"> 1838</span>    <span class="keywordtype">integer</span>  :: jtop(lbc:ubc)           <span class="comment">! top level for each column (no longer all 1)</span></div>
<div class="line"><a id="l01839" name="l01839"></a><span class="lineno"> 1839</span><span class="keywordtype">    real</span>(kind_lake) :: cv (lbc:ubc,-nlevsnow+1:nlevsoil)  <span class="comment">!heat capacity of soil/snow [J/(m2 K)]</span></div>
<div class="line"><a id="l01840" name="l01840"></a><span class="lineno"> 1840</span><span class="keywordtype">    real</span>(kind_lake) :: tk (lbc:ubc,-nlevsnow+1:nlevsoil)  <span class="comment">!thermal conductivity of soil/snow [W/(m K)]</span></div>
<div class="line"><a id="l01841" name="l01841"></a><span class="lineno"> 1841</span>                                                 <span class="comment">!(at interface below, except for j=0)</span></div>
<div class="line"><a id="l01842" name="l01842"></a><span class="lineno"> 1842</span><span class="keywordtype">    real</span>(kind_lake) :: cv_lake (lbc:ubc,1:nlevlake)      <span class="comment">!heat capacity [J/(m2 K)]</span></div>
<div class="line"><a id="l01843" name="l01843"></a><span class="lineno"> 1843</span><span class="keywordtype">    real</span>(kind_lake) :: tk_lake (lbc:ubc,1:nlevlake)  <span class="comment">!thermal conductivity at layer node [W/(m K)]</span></div>
<div class="line"><a id="l01844" name="l01844"></a><span class="lineno"> 1844</span><span class="keywordtype">    real</span>(kind_lake) :: cvx (lbc:ubc,-nlevsnow+1:nlevlake+nlevsoil) <span class="comment">!heat capacity for whole column [J/(m2 K)]</span></div>
<div class="line"><a id="l01845" name="l01845"></a><span class="lineno"> 1845</span><span class="keywordtype">    real</span>(kind_lake) :: tkix(lbc:ubc,-nlevsnow+1:nlevlake+nlevsoil) <span class="comment">!thermal conductivity at layer interfaces</span></div>
<div class="line"><a id="l01846" name="l01846"></a><span class="lineno"> 1846</span>                                                         <span class="comment">!for whole column [W/(m K)]</span></div>
<div class="line"><a id="l01847" name="l01847"></a><span class="lineno"> 1847</span><span class="keywordtype">    real</span>(kind_lake) :: tx(lbc:ubc,-nlevsnow+1:nlevlake+nlevsoil) <span class="comment">! temperature of whole column [K]</span></div>
<div class="line"><a id="l01848" name="l01848"></a><span class="lineno"> 1848</span><span class="keywordtype">    real</span>(kind_lake) :: tktopsoillay(lbc:ubc)          <span class="comment">! thermal conductivity [W/(m K)]</span></div>
<div class="line"><a id="l01849" name="l01849"></a><span class="lineno"> 1849</span><span class="keywordtype">    real</span>(kind_lake) :: fnx(lbc:ubc,-nlevsnow+1:nlevlake+nlevsoil)  <span class="comment">!heat diffusion through the layer interface below [W/m2]</span></div>
<div class="line"><a id="l01850" name="l01850"></a><span class="lineno"> 1850</span><span class="keywordtype">    real</span>(kind_lake) :: phix(lbc:ubc,-nlevsnow+1:nlevlake+nlevsoil) <span class="comment">!solar source term for whole column [W/m**2]</span></div>
<div class="line"><a id="l01851" name="l01851"></a><span class="lineno"> 1851</span><span class="keywordtype">    real</span>(kind_lake) :: zx(lbc:ubc,-nlevsnow+1:nlevlake+nlevsoil)   <span class="comment">!interface depth (+ below surface) for whole column [m]</span></div>
<div class="line"><a id="l01852" name="l01852"></a><span class="lineno"> 1852</span><span class="keywordtype">    real</span>(kind_lake) :: dzm                              <span class="comment">!used in computing tridiagonal matrix [m]</span></div>
<div class="line"><a id="l01853" name="l01853"></a><span class="lineno"> 1853</span><span class="keywordtype">    real</span>(kind_lake) :: dzp                              <span class="comment">!used in computing tridiagonal matrix [m]</span></div>
<div class="line"><a id="l01854" name="l01854"></a><span class="lineno"> 1854</span>    <span class="keywordtype">integer</span>  :: jprime                   <span class="comment">! j - nlevlake</span></div>
<div class="line"><a id="l01855" name="l01855"></a><span class="lineno"> 1855</span><span class="keywordtype">    real</span>(kind_lake) :: factx(lbc:ubc,-nlevsnow+1:nlevlake+nlevsoil) <span class="comment">!coefficient used in computing tridiagonal matrix</span></div>
<div class="line"><a id="l01856" name="l01856"></a><span class="lineno"> 1856</span><span class="keywordtype">    real</span>(kind_lake) :: t_lake_bef(lbc:ubc,1:nlevlake)    <span class="comment">!beginning lake temp for energy conservation check [K]</span></div>
<div class="line"><a id="l01857" name="l01857"></a><span class="lineno"> 1857</span><span class="keywordtype">    real</span>(kind_lake) :: t_soisno_bef(lbc:ubc,-nlevsnow+1:nlevsoil) <span class="comment">!beginning soil temp for E cons. check [K]</span></div>
<div class="line"><a id="l01858" name="l01858"></a><span class="lineno"> 1858</span><span class="keywordtype">    real</span>(kind_lake) :: lhabs(lbc:ubc)       <span class="comment">! total per-column latent heat abs. from phase change  (J/m^2)</span></div>
<div class="line"><a id="l01859" name="l01859"></a><span class="lineno"> 1859</span><span class="keywordtype">    real</span>(kind_lake) :: esum1(lbc:ubc)        <span class="comment">! temp for checking energy (J/m^2)</span></div>
<div class="line"><a id="l01860" name="l01860"></a><span class="lineno"> 1860</span><span class="keywordtype">    real</span>(kind_lake) :: esum2(lbc:ubc)        <span class="comment">! &quot;&quot;</span></div>
<div class="line"><a id="l01861" name="l01861"></a><span class="lineno"> 1861</span><span class="keywordtype">    real</span>(kind_lake) :: zsum(lbc:ubc)        <span class="comment">! temp for putting ice at the top during convection (m)</span></div>
<div class="line"><a id="l01862" name="l01862"></a><span class="lineno"> 1862</span><span class="keywordtype">    real</span>(kind_lake) :: wsum(lbc:ubc)        <span class="comment">! temp for checking water (kg/m^2)</span></div>
<div class="line"><a id="l01863" name="l01863"></a><span class="lineno"> 1863</span><span class="keywordtype">    real</span>(kind_lake) :: wsum_end(lbc:ubc)    <span class="comment">! temp for checking water (kg/m^2)</span></div>
<div class="line"><a id="l01864" name="l01864"></a><span class="lineno"> 1864</span><span class="keywordtype">    real</span>(kind_lake) :: errsoi(1)                         <span class="comment">! soil/lake energy conservation error (W/m**2)</span></div>
<div class="line"><a id="l01865" name="l01865"></a><span class="lineno"> 1865</span><span class="keywordtype">    real</span>(kind_lake) :: eflx_snomelt(1)  <span class="comment">!snow melt heat flux (W/m**2)</span></div>
<div class="line"><a id="l01866" name="l01866"></a><span class="lineno"> 1866</span>    <span class="keywordtype">CHARACTER*256</span> :: message</div>
<div class="line"><a id="l01867" name="l01867"></a><span class="lineno"> 1867</span>    <span class="comment">!</span></div>
<div class="line"><a id="l01868" name="l01868"></a><span class="lineno"> 1868</span>    <span class="comment">! Constants for lake temperature model</span></div>
<div class="line"><a id="l01869" name="l01869"></a><span class="lineno"> 1869</span>    <span class="comment">!</span></div>
<div class="line"><a id="l01870" name="l01870"></a><span class="lineno"> 1870</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: beta(2) = &amp; <span class="comment">! fraction solar rad absorbed at surface: depends on lake type</span></div>
<div class="line"><a id="l01871" name="l01871"></a><span class="lineno"> 1871</span>         (/0.4_kind_lake, 0.4_kind_lake/)  <span class="comment">! (deep lake, shallow lake)</span></div>
<div class="line"><a id="l01872" name="l01872"></a><span class="lineno"> 1872</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: za(2) = &amp; <span class="comment">! base of surface absorption layer (m): depends on lake type</span></div>
<div class="line"><a id="l01873" name="l01873"></a><span class="lineno"> 1873</span>         (/0.6_kind_lake, 0.6_kind_lake/)</div>
<div class="line"><a id="l01874" name="l01874"></a><span class="lineno"> 1874</span>    <span class="comment">!   For now, keep beta and za for shallow lake the same as deep lake, until better data is found.</span></div>
<div class="line"><a id="l01875" name="l01875"></a><span class="lineno"> 1875</span>    <span class="comment">!   It looks like eta is key and that larger values give better results for shallow lakes.  Use</span></div>
<div class="line"><a id="l01876" name="l01876"></a><span class="lineno"> 1876</span>    <span class="comment">!   empirical expression from Hakanson (below). This is still a very unconstrained parameter</span></div>
<div class="line"><a id="l01877" name="l01877"></a><span class="lineno"> 1877</span>    <span class="comment">!   that deserves more attention.</span></div>
<div class="line"><a id="l01878" name="l01878"></a><span class="lineno"> 1878</span>    <span class="comment">!   Some radiation will be allowed to reach the soil.</span></div>
<div class="line"><a id="l01879" name="l01879"></a><span class="lineno"> 1879</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l01880" name="l01880"></a><span class="lineno"> 1880</span>    </div>
<div class="line"><a id="l01881" name="l01881"></a><span class="lineno"> 1881</span>    </div>
<div class="line"><a id="l01882" name="l01882"></a><span class="lineno"> 1882</span>    <span class="comment">! 1!) Initialization</span></div>
<div class="line"><a id="l01883" name="l01883"></a><span class="lineno"> 1883</span>    <span class="comment">! Determine step size</span></div>
<div class="line"><a id="l01884" name="l01884"></a><span class="lineno"> 1884</span> </div>
<div class="line"><a id="l01885" name="l01885"></a><span class="lineno"> 1885</span>    <span class="comment">! Initialize constants</span></div>
<div class="line"><a id="l01886" name="l01886"></a><span class="lineno"> 1886</span>    cwat = cpliq*denh2o <span class="comment">! water heat capacity per unit volume</span></div>
<div class="line"><a id="l01887" name="l01887"></a><span class="lineno"> 1887</span>    cice_eff = cpice*denh2o <span class="comment">!use water density because layer depth is not adjusted</span></div>
<div class="line"><a id="l01888" name="l01888"></a><span class="lineno"> 1888</span>                              <span class="comment">!for freezing</span></div>
<div class="line"><a id="l01889" name="l01889"></a><span class="lineno"> 1889</span>    cfus = hfus*denh2o  <span class="comment">! latent heat per unit volume</span></div>
<div class="line"><a id="l01890" name="l01890"></a><span class="lineno"> 1890</span>    tkice_eff = tkice * denice/denh2o <span class="comment">!effective conductivity since layer depth is constant</span></div>
<div class="line"><a id="l01891" name="l01891"></a><span class="lineno"> 1891</span>    km = tkwat/cwat     <span class="comment">! a constant (molecular diffusivity)</span></div>
<div class="line"><a id="l01892" name="l01892"></a><span class="lineno"> 1892</span> </div>
<div class="line"><a id="l01893" name="l01893"></a><span class="lineno"> 1893</span>    <span class="comment">! Begin calculations</span></div>
<div class="line"><a id="l01894" name="l01894"></a><span class="lineno"> 1894</span> </div>
<div class="line"><a id="l01895" name="l01895"></a><span class="lineno"> 1895</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l01896" name="l01896"></a><span class="lineno"> 1896</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l01897" name="l01897"></a><span class="lineno"> 1897</span>    <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l01898" name="l01898"></a><span class="lineno"> 1898</span>       c = filter_shlakec(fc)</div>
<div class="line"><a id="l01899" name="l01899"></a><span class="lineno"> 1899</span> </div>
<div class="line"><a id="l01900" name="l01900"></a><span class="lineno"> 1900</span>       <span class="comment">! Initialize Ebal quantities computed below</span></div>
<div class="line"><a id="l01901" name="l01901"></a><span class="lineno"> 1901</span> </div>
<div class="line"><a id="l01902" name="l01902"></a><span class="lineno"> 1902</span>       ocvts(c) = 0._kind_lake</div>
<div class="line"><a id="l01903" name="l01903"></a><span class="lineno"> 1903</span>       ncvts(c) = 0._kind_lake</div>
<div class="line"><a id="l01904" name="l01904"></a><span class="lineno"> 1904</span>       esum1(c) = 0._kind_lake</div>
<div class="line"><a id="l01905" name="l01905"></a><span class="lineno"> 1905</span>       esum2(c) = 0._kind_lake</div>
<div class="line"><a id="l01906" name="l01906"></a><span class="lineno"> 1906</span> </div>
<div class="line"><a id="l01907" name="l01907"></a><span class="lineno"> 1907</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l01908" name="l01908"></a><span class="lineno"> 1908</span> </div>
<div class="line"><a id="l01909" name="l01909"></a><span class="lineno"> 1909</span>    <span class="comment">! Initialize set of previous time-step variables as in DriverInit,</span></div>
<div class="line"><a id="l01910" name="l01910"></a><span class="lineno"> 1910</span>    <span class="comment">! which is currently not called over lakes. This has to be done</span></div>
<div class="line"><a id="l01911" name="l01911"></a><span class="lineno"> 1911</span>    <span class="comment">! here because phase change will occur in this routine.</span></div>
<div class="line"><a id="l01912" name="l01912"></a><span class="lineno"> 1912</span>    <span class="comment">! Ice fraction of snow at previous time step</span></div>
<div class="line"><a id="l01913" name="l01913"></a><span class="lineno"> 1913</span> </div>
<div class="line"><a id="l01914" name="l01914"></a><span class="lineno"> 1914</span>    <span class="keywordflow">do</span> j = -nlevsnow+1,0</div>
<div class="line"><a id="l01915" name="l01915"></a><span class="lineno"> 1915</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l01916" name="l01916"></a><span class="lineno"> 1916</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l01917" name="l01917"></a><span class="lineno"> 1917</span>      <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l01918" name="l01918"></a><span class="lineno"> 1918</span>         c = filter_shlakec(fc)</div>
<div class="line"><a id="l01919" name="l01919"></a><span class="lineno"> 1919</span>         <span class="keywordflow">if</span> (j &gt;= snl(c) + 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01920" name="l01920"></a><span class="lineno"> 1920</span>            frac_iceold(c,j) = h2osoi_ice(c,j)/(h2osoi_liq(c,j)+h2osoi_ice(c,j))</div>
<div class="line"><a id="l01921" name="l01921"></a><span class="lineno"> 1921</span><span class="keywordflow">         end if</span></div>
<div class="line"><a id="l01922" name="l01922"></a><span class="lineno"> 1922</span><span class="keywordflow">      end do</span></div>
<div class="line"><a id="l01923" name="l01923"></a><span class="lineno"> 1923</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l01924" name="l01924"></a><span class="lineno"> 1924</span> </div>
<div class="line"><a id="l01925" name="l01925"></a><span class="lineno"> 1925</span>    <span class="comment">! Sum soil water.</span></div>
<div class="line"><a id="l01926" name="l01926"></a><span class="lineno"> 1926</span>    <span class="keywordflow">do</span> j = 1, nlevsoil</div>
<div class="line"><a id="l01927" name="l01927"></a><span class="lineno"> 1927</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l01928" name="l01928"></a><span class="lineno"> 1928</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l01929" name="l01929"></a><span class="lineno"> 1929</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l01930" name="l01930"></a><span class="lineno"> 1930</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l01931" name="l01931"></a><span class="lineno"> 1931</span>          <span class="keywordflow">if</span> (j == 1) wsum(c) = 0._kind_lake</div>
<div class="line"><a id="l01932" name="l01932"></a><span class="lineno"> 1932</span>          wsum(c) = wsum(c) + h2osoi_ice(c,j) + h2osoi_liq(c,j)</div>
<div class="line"><a id="l01933" name="l01933"></a><span class="lineno"> 1933</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l01934" name="l01934"></a><span class="lineno"> 1934</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l01935" name="l01935"></a><span class="lineno"> 1935</span> </div>
<div class="line"><a id="l01936" name="l01936"></a><span class="lineno"> 1936</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l01937" name="l01937"></a><span class="lineno"> 1937</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l01938" name="l01938"></a><span class="lineno"> 1938</span>    <span class="keywordflow">do</span> fp = 1, num_shlakep</div>
<div class="line"><a id="l01939" name="l01939"></a><span class="lineno"> 1939</span>       p = filter_shlakep(fp)</div>
<div class="line"><a id="l01940" name="l01940"></a><span class="lineno"> 1940</span>       c = pcolumn(p)</div>
<div class="line"><a id="l01941" name="l01941"></a><span class="lineno"> 1941</span> </div>
<div class="line"><a id="l01942" name="l01942"></a><span class="lineno"> 1942</span> </div>
<div class="line"><a id="l01943" name="l01943"></a><span class="lineno"> 1943</span>       <span class="comment">! Prepare for lake layer temperature calculations below</span></div>
<div class="line"><a id="l01944" name="l01944"></a><span class="lineno"> 1944</span> </div>
<div class="line"><a id="l01945" name="l01945"></a><span class="lineno"> 1945</span>       <span class="comment">! fin(c) = betaprime * sabg(p) + forc_lwrad(g) - (eflx_lwrad_out(p) + &amp;</span></div>
<div class="line"><a id="l01946" name="l01946"></a><span class="lineno"> 1946</span>       <span class="comment">!     eflx_sh_tot(p) + eflx_lh_tot(p)) </span></div>
<div class="line"><a id="l01947" name="l01947"></a><span class="lineno"> 1947</span>       <span class="comment">! fin(c) now passed from ShalLakeFluxes as eflx_gnet</span></div>
<div class="line"><a id="l01948" name="l01948"></a><span class="lineno"> 1948</span>       fin(c) = eflx_gnet(p)</div>
<div class="line"><a id="l01949" name="l01949"></a><span class="lineno"> 1949</span> </div>
<div class="line"><a id="l01950" name="l01950"></a><span class="lineno"> 1950</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l01951" name="l01951"></a><span class="lineno"> 1951</span> </div>
<div class="line"><a id="l01952" name="l01952"></a><span class="lineno"> 1952</span>    <span class="comment">! 2!) Lake density</span></div>
<div class="line"><a id="l01953" name="l01953"></a><span class="lineno"> 1953</span> </div>
<div class="line"><a id="l01954" name="l01954"></a><span class="lineno"> 1954</span>    <span class="keywordflow">do</span> j = 1, nlevlake</div>
<div class="line"><a id="l01955" name="l01955"></a><span class="lineno"> 1955</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l01956" name="l01956"></a><span class="lineno"> 1956</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l01957" name="l01957"></a><span class="lineno"> 1957</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l01958" name="l01958"></a><span class="lineno"> 1958</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l01959" name="l01959"></a><span class="lineno"> 1959</span>          rhow(c,j) = (1._kind_lake - lake_icefrac(c,j)) * &amp; </div>
<div class="line"><a id="l01960" name="l01960"></a><span class="lineno"> 1960</span>                      1000._kind_lake*( 1.0_kind_lake - 1.9549e-05_kind_lake*(abs(t_lake(c,j)-277._kind_lake))**1.68_kind_lake ) &amp;</div>
<div class="line"><a id="l01961" name="l01961"></a><span class="lineno"> 1961</span>                    + lake_icefrac(c,j)*denice</div>
<div class="line"><a id="l01962" name="l01962"></a><span class="lineno"> 1962</span>                    <span class="comment">! Allow for ice fraction; assume constant ice density.</span></div>
<div class="line"><a id="l01963" name="l01963"></a><span class="lineno"> 1963</span>                    <span class="comment">! Is this the right weighted average?</span></div>
<div class="line"><a id="l01964" name="l01964"></a><span class="lineno"> 1964</span>                    <span class="comment">! Using this average will make sure that surface ice is treated properly during</span></div>
<div class="line"><a id="l01965" name="l01965"></a><span class="lineno"> 1965</span>                    <span class="comment">! convective mixing.</span></div>
<div class="line"><a id="l01966" name="l01966"></a><span class="lineno"> 1966</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l01967" name="l01967"></a><span class="lineno"> 1967</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l01968" name="l01968"></a><span class="lineno"> 1968</span> </div>
<div class="line"><a id="l01969" name="l01969"></a><span class="lineno"> 1969</span>    <span class="comment">! 3!) Diffusivity and implied thermal &quot;conductivity&quot; = diffusivity * cwat</span></div>
<div class="line"><a id="l01970" name="l01970"></a><span class="lineno"> 1970</span>    <span class="keywordflow">do</span> j = 1, nlevlake-1</div>
<div class="line"><a id="l01971" name="l01971"></a><span class="lineno"> 1971</span>      <span class="comment">!dir$ prefervector</span></div>
<div class="line"><a id="l01972" name="l01972"></a><span class="lineno"> 1972</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l01973" name="l01973"></a><span class="lineno"> 1973</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l01974" name="l01974"></a><span class="lineno"> 1974</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l01975" name="l01975"></a><span class="lineno"> 1975</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l01976" name="l01976"></a><span class="lineno"> 1976</span>          drhodz = (rhow(c,j+1)-rhow(c,j)) / (z_lake(c,j+1)-z_lake(c,j))</div>
<div class="line"><a id="l01977" name="l01977"></a><span class="lineno"> 1977</span>          n2 = grav / rhow(c,j) * drhodz</div>
<div class="line"><a id="l01978" name="l01978"></a><span class="lineno"> 1978</span>          <span class="comment">! Fixed sign error here: our z goes up going down into the lake, so no negative</span></div>
<div class="line"><a id="l01979" name="l01979"></a><span class="lineno"> 1979</span>          <span class="comment">! sign is needed to make this positive unlike in Hostetler. --ZS</span></div>
<div class="line"><a id="l01980" name="l01980"></a><span class="lineno"> 1980</span>          num = 40._kind_lake * n2 * (vkc*z_lake(c,j))**2</div>
<div class="line"><a id="l01981" name="l01981"></a><span class="lineno"> 1981</span>          den = max( (ws(c)**2) * exp(-2._kind_lake*ks(c)*z_lake(c,j)), 1.e-10_kind_lake )</div>
<div class="line"><a id="l01982" name="l01982"></a><span class="lineno"> 1982</span>          ri = ( -1._kind_lake + sqrt( max(1._kind_lake+num/den, 0._kind_lake) ) ) / 20._kind_lake</div>
<div class="line"><a id="l01983" name="l01983"></a><span class="lineno"> 1983</span>          <span class="keywordflow">if</span> (t_grnd(c) &gt; tfrz .and. t_lake(c,1) &gt; tfrz .and. snl(c) == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01984" name="l01984"></a><span class="lineno"> 1984</span>            <span class="comment">! ke = vkc*ws(c)*z_lake(c,j)/p0 * exp(-ks(c)*z_lake(c,j)) / (1._kind_lake+37._kind_lake*ri*ri)</span></div>
<div class="line"><a id="l01985" name="l01985"></a><span class="lineno"> 1985</span> </div>
<div class="line"><a id="l01986" name="l01986"></a><span class="lineno"> 1986</span>             <span class="keywordflow">if</span>( t_lake(c,1) &gt; 277.15_kind_lake ) <span class="keywordflow">then</span> </div>
<div class="line"><a id="l01987" name="l01987"></a><span class="lineno"> 1987</span>                <span class="keywordflow">if</span> (lakedepth(c) &gt; 15.0 ) <span class="keywordflow">then</span> </div>
<div class="line"><a id="l01988" name="l01988"></a><span class="lineno"> 1988</span>                   ke = 1.e+2_kind_lake*vkc*ws(c)*z_lake(c,j)/p0 * exp(-ks(c)*z_lake(c,j)) / (1._kind_lake+37._kind_lake*ri*ri)</div>
<div class="line"><a id="l01989" name="l01989"></a><span class="lineno"> 1989</span>                <span class="keywordflow">else</span> </div>
<div class="line"><a id="l01990" name="l01990"></a><span class="lineno"> 1990</span>                   ke = vkc*ws(c)*z_lake(c,j)/p0 * exp(-ks(c)*z_lake(c,j)) / (1._kind_lake+37._kind_lake*ri*ri)</div>
<div class="line"><a id="l01991" name="l01991"></a><span class="lineno"> 1991</span><span class="keywordflow">                endif</span></div>
<div class="line"><a id="l01992" name="l01992"></a><span class="lineno"> 1992</span>             <span class="keywordflow">else</span> </div>
<div class="line"><a id="l01993" name="l01993"></a><span class="lineno"> 1993</span>                <span class="keywordflow">if</span> (lakedepth(c) &gt; 15.0 ) <span class="keywordflow">then</span> </div>
<div class="line"><a id="l01994" name="l01994"></a><span class="lineno"> 1994</span>                  <span class="keywordflow">if</span> (lakedepth(c) &gt; 150.0 ) <span class="keywordflow">then</span> </div>
<div class="line"><a id="l01995" name="l01995"></a><span class="lineno"> 1995</span>                    ke = 1.e+5_kind_lake*vkc*ws(c)*z_lake(c,j)/p0 * exp(-ks(c)*z_lake(c,j)) / (1._kind_lake+37._kind_lake*ri*ri)</div>
<div class="line"><a id="l01996" name="l01996"></a><span class="lineno"> 1996</span>                  <span class="keywordflow">else</span> </div>
<div class="line"><a id="l01997" name="l01997"></a><span class="lineno"> 1997</span>                    ke =1.e+4_kind_lake*vkc*ws(c)*z_lake(c,j)/p0 * exp(-ks(c)*z_lake(c,j)) / (1._kind_lake+37._kind_lake*ri*ri)</div>
<div class="line"><a id="l01998" name="l01998"></a><span class="lineno"> 1998</span><span class="keywordflow">                  end if</span></div>
<div class="line"><a id="l01999" name="l01999"></a><span class="lineno"> 1999</span>                <span class="keywordflow">else</span> </div>
<div class="line"><a id="l02000" name="l02000"></a><span class="lineno"> 2000</span>                  ke = vkc*ws(c)*z_lake(c,j)/p0 * exp(-ks(c)*z_lake(c,j)) / (1._kind_lake+37._kind_lake*ri*ri)</div>
<div class="line"><a id="l02001" name="l02001"></a><span class="lineno"> 2001</span><span class="keywordflow">                endif</span> </div>
<div class="line"><a id="l02002" name="l02002"></a><span class="lineno"> 2002</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02003" name="l02003"></a><span class="lineno"> 2003</span> </div>
<div class="line"><a id="l02004" name="l02004"></a><span class="lineno"> 2004</span>             kme(c,j) = km + ke</div>
<div class="line"><a id="l02005" name="l02005"></a><span class="lineno"> 2005</span>             tk_lake(c,j) = kme(c,j)*cwat</div>
<div class="line"><a id="l02006" name="l02006"></a><span class="lineno"> 2006</span>             <span class="comment">! If there is some ice in this layer (this should rarely happen because the surface</span></div>
<div class="line"><a id="l02007" name="l02007"></a><span class="lineno"> 2007</span>             <span class="comment">! is unfrozen and it will be unstable), still use the cwat to get out the tk b/c the eddy</span></div>
<div class="line"><a id="l02008" name="l02008"></a><span class="lineno"> 2008</span>             <span class="comment">! diffusivity equation assumes water.</span></div>
<div class="line"><a id="l02009" name="l02009"></a><span class="lineno"> 2009</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l02010" name="l02010"></a><span class="lineno"> 2010</span>             kme(c,j) = km</div>
<div class="line"><a id="l02011" name="l02011"></a><span class="lineno"> 2011</span>             tk_lake(c,j) = tkwat*tkice_eff / ( (1._kind_lake-lake_icefrac(c,j))*tkice_eff &amp;</div>
<div class="line"><a id="l02012" name="l02012"></a><span class="lineno"> 2012</span>                            + tkwat*lake_icefrac(c,j) )</div>
<div class="line"><a id="l02013" name="l02013"></a><span class="lineno"> 2013</span>             <span class="comment">! Assume the resistances add as for the calculation of conductivities at layer interfaces.</span></div>
<div class="line"><a id="l02014" name="l02014"></a><span class="lineno"> 2014</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02015" name="l02015"></a><span class="lineno"> 2015</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02016" name="l02016"></a><span class="lineno"> 2016</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02017" name="l02017"></a><span class="lineno"> 2017</span> </div>
<div class="line"><a id="l02018" name="l02018"></a><span class="lineno"> 2018</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02019" name="l02019"></a><span class="lineno"> 2019</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02020" name="l02020"></a><span class="lineno"> 2020</span>    <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02021" name="l02021"></a><span class="lineno"> 2021</span>       c = filter_shlakec(fc)</div>
<div class="line"><a id="l02022" name="l02022"></a><span class="lineno"> 2022</span> </div>
<div class="line"><a id="l02023" name="l02023"></a><span class="lineno"> 2023</span>       j = nlevlake</div>
<div class="line"><a id="l02024" name="l02024"></a><span class="lineno"> 2024</span>       kme(c,nlevlake) = kme(c,nlevlake-1)</div>
<div class="line"><a id="l02025" name="l02025"></a><span class="lineno"> 2025</span> </div>
<div class="line"><a id="l02026" name="l02026"></a><span class="lineno"> 2026</span>       <span class="keywordflow">if</span> (t_grnd(c) &gt; tfrz .and. t_lake(c,1) &gt; tfrz .and. snl(c) == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02027" name="l02027"></a><span class="lineno"> 2027</span>          tk_lake(c,j) = tk_lake(c,j-1)</div>
<div class="line"><a id="l02028" name="l02028"></a><span class="lineno"> 2028</span>       <span class="keywordflow">else</span></div>
<div class="line"><a id="l02029" name="l02029"></a><span class="lineno"> 2029</span>          tk_lake(c,j) = tkwat*tkice_eff / ( (1._kind_lake-lake_icefrac(c,j))*tkice_eff &amp;</div>
<div class="line"><a id="l02030" name="l02030"></a><span class="lineno"> 2030</span>                            + tkwat*lake_icefrac(c,j) )</div>
<div class="line"><a id="l02031" name="l02031"></a><span class="lineno"> 2031</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l02032" name="l02032"></a><span class="lineno"> 2032</span> </div>
<div class="line"><a id="l02033" name="l02033"></a><span class="lineno"> 2033</span>       <span class="comment">! Use in surface flux calculation for next timestep.</span></div>
<div class="line"><a id="l02034" name="l02034"></a><span class="lineno"> 2034</span>       savedtke1(c) = kme(c,1)*cwat <span class="comment">! Will only be used if unfrozen</span></div>
<div class="line"><a id="l02035" name="l02035"></a><span class="lineno"> 2035</span>       <span class="comment">! set number of column levels for use by Tridiagonal below</span></div>
<div class="line"><a id="l02036" name="l02036"></a><span class="lineno"> 2036</span>       jtop(c) = snl(c) + 1</div>
<div class="line"><a id="l02037" name="l02037"></a><span class="lineno"> 2037</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02038" name="l02038"></a><span class="lineno"> 2038</span> </div>
<div class="line"><a id="l02039" name="l02039"></a><span class="lineno"> 2039</span>    <span class="comment">! 4!) Heat source term: unfrozen lakes only</span></div>
<div class="line"><a id="l02040" name="l02040"></a><span class="lineno"> 2040</span>    <span class="keywordflow">do</span> j = 1, nlevlake</div>
<div class="line"><a id="l02041" name="l02041"></a><span class="lineno"> 2041</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02042" name="l02042"></a><span class="lineno"> 2042</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02043" name="l02043"></a><span class="lineno"> 2043</span>       <span class="keywordflow">do</span> fp = 1, num_shlakep</div>
<div class="line"><a id="l02044" name="l02044"></a><span class="lineno"> 2044</span>          p = filter_shlakep(fp)</div>
<div class="line"><a id="l02045" name="l02045"></a><span class="lineno"> 2045</span>          c = pcolumn(p)</div>
<div class="line"><a id="l02046" name="l02046"></a><span class="lineno"> 2046</span> </div>
<div class="line"><a id="l02047" name="l02047"></a><span class="lineno"> 2047</span>          <span class="comment">! Set eta(:), the extinction coefficient, according to L Hakanson, Aquatic Sciences, 1995</span></div>
<div class="line"><a id="l02048" name="l02048"></a><span class="lineno"> 2048</span>          <span class="comment">! (regression of Secchi Depth with lake depth for small glacial basin lakes), and the</span></div>
<div class="line"><a id="l02049" name="l02049"></a><span class="lineno"> 2049</span>          <span class="comment">! Poole &amp; Atkins expression for extinction coeffient of 1.7 / Secchi Depth (m).</span></div>
<div class="line"><a id="l02050" name="l02050"></a><span class="lineno"> 2050</span>          <span class="keywordflow">if</span>(.not.use_etalake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02051" name="l02051"></a><span class="lineno"> 2051</span>            eta(:) = 1.1925_kind_lake*lakedepth(c)**(-0.424)</div>
<div class="line"><a id="l02052" name="l02052"></a><span class="lineno"> 2052</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l02053" name="l02053"></a><span class="lineno"> 2053</span>            eta(:) = etalake</div>
<div class="line"><a id="l02054" name="l02054"></a><span class="lineno"> 2054</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l02055" name="l02055"></a><span class="lineno"> 2055</span> </div>
<div class="line"><a id="l02056" name="l02056"></a><span class="lineno"> 2056</span>          zin  = z_lake(c,j) - 0.5_kind_lake*dz_lake(c,j)</div>
<div class="line"><a id="l02057" name="l02057"></a><span class="lineno"> 2057</span>          zout = z_lake(c,j) + 0.5_kind_lake*dz_lake(c,j)</div>
<div class="line"><a id="l02058" name="l02058"></a><span class="lineno"> 2058</span>          rsfin  = exp( -eta(islak)*max(  zin-za(islak),0._kind_lake ) )</div>
<div class="line"><a id="l02059" name="l02059"></a><span class="lineno"> 2059</span>          rsfout = exp( -eta(islak)*max( zout-za(islak),0._kind_lake ) )</div>
<div class="line"><a id="l02060" name="l02060"></a><span class="lineno"> 2060</span> </div>
<div class="line"><a id="l02061" name="l02061"></a><span class="lineno"> 2061</span>          <span class="comment">! Let rsfout for bottom layer go into soil.</span></div>
<div class="line"><a id="l02062" name="l02062"></a><span class="lineno"> 2062</span>          <span class="comment">! This looks like it should be robust even for pathological cases,</span></div>
<div class="line"><a id="l02063" name="l02063"></a><span class="lineno"> 2063</span>            <span class="comment">! like lakes thinner than za.</span></div>
<div class="line"><a id="l02064" name="l02064"></a><span class="lineno"> 2064</span>          <span class="keywordflow">if</span> (t_grnd(c) &gt; tfrz .and. t_lake(c,1) &gt; tfrz .and. snl(c) == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02065" name="l02065"></a><span class="lineno"> 2065</span>             phidum = (rsfin-rsfout) * sabg(p) * (1._kind_lake-beta(islak))</div>
<div class="line"><a id="l02066" name="l02066"></a><span class="lineno"> 2066</span>             <span class="keywordflow">if</span> (j == nlevlake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02067" name="l02067"></a><span class="lineno"> 2067</span>                phi_soil(c) = rsfout * sabg(p) * (1._kind_lake-beta(islak))</div>
<div class="line"><a id="l02068" name="l02068"></a><span class="lineno"> 2068</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02069" name="l02069"></a><span class="lineno"> 2069</span>          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j == 1 .and. snl(c) == 0) <span class="keywordflow">then</span> <span class="comment">!if frozen but no snow layers</span></div>
<div class="line"><a id="l02070" name="l02070"></a><span class="lineno"> 2070</span>             phidum = sabg(p) * (1._kind_lake-beta(islak))</div>
<div class="line"><a id="l02071" name="l02071"></a><span class="lineno"> 2071</span>          <span class="keywordflow">else</span> <span class="comment">!radiation absorbed at surface</span></div>
<div class="line"><a id="l02072" name="l02072"></a><span class="lineno"> 2072</span>             phidum = 0._kind_lake</div>
<div class="line"><a id="l02073" name="l02073"></a><span class="lineno"> 2073</span>             <span class="keywordflow">if</span> (j == nlevlake) phi_soil(c) = 0._kind_lake</div>
<div class="line"><a id="l02074" name="l02074"></a><span class="lineno"> 2074</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02075" name="l02075"></a><span class="lineno"> 2075</span>          phi(c,j) = phidum</div>
<div class="line"><a id="l02076" name="l02076"></a><span class="lineno"> 2076</span> </div>
<div class="line"><a id="l02077" name="l02077"></a><span class="lineno"> 2077</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02078" name="l02078"></a><span class="lineno"> 2078</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02079" name="l02079"></a><span class="lineno"> 2079</span> </div>
<div class="line"><a id="l02080" name="l02080"></a><span class="lineno"> 2080</span>    <span class="comment">! 5!) Set thermal properties and check initial energy content.</span></div>
<div class="line"><a id="l02081" name="l02081"></a><span class="lineno"> 2081</span> </div>
<div class="line"><a id="l02082" name="l02082"></a><span class="lineno"> 2082</span>    <span class="comment">! For lake</span></div>
<div class="line"><a id="l02083" name="l02083"></a><span class="lineno"> 2083</span>    <span class="keywordflow">do</span> j = 1, nlevlake</div>
<div class="line"><a id="l02084" name="l02084"></a><span class="lineno"> 2084</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02085" name="l02085"></a><span class="lineno"> 2085</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02086" name="l02086"></a><span class="lineno"> 2086</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02087" name="l02087"></a><span class="lineno"> 2087</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02088" name="l02088"></a><span class="lineno"> 2088</span> </div>
<div class="line"><a id="l02089" name="l02089"></a><span class="lineno"> 2089</span>          cv_lake(c,j) = dz_lake(c,j) * (cwat*(1._kind_lake-lake_icefrac(c,j)) + cice_eff*lake_icefrac(c,j))</div>
<div class="line"><a id="l02090" name="l02090"></a><span class="lineno"> 2090</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02091" name="l02091"></a><span class="lineno"> 2091</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02092" name="l02092"></a><span class="lineno"> 2092</span> </div>
<div class="line"><a id="l02093" name="l02093"></a><span class="lineno"> 2093</span>    <span class="comment">! For snow / soil</span></div>
<div class="line"><a id="l02094" name="l02094"></a><span class="lineno"> 2094</span>  <span class="keyword">call </span>soilthermprop_lake (snl,dz,zi,z,t_soisno,h2osoi_liq,h2osoi_ice,    &amp;</div>
<div class="line"><a id="l02095" name="l02095"></a><span class="lineno"> 2095</span>        watsat, tksatu, tkmg, tkdry, csol, tk, cv, tktopsoillay,errmsg,errflg)</div>
<div class="line"><a id="l02096" name="l02096"></a><span class="lineno"> 2096</span>  <span class="keywordflow">if</span>(errflg/=0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02097" name="l02097"></a><span class="lineno"> 2097</span>    <span class="comment">! State is no longer valid, so return error to caller</span></div>
<div class="line"><a id="l02098" name="l02098"></a><span class="lineno"> 2098</span>    <span class="comment">! FIXME: PUT THIS BACK return</span></div>
<div class="line"><a id="l02099" name="l02099"></a><span class="lineno"> 2099</span><span class="keywordflow">  endif</span></div>
<div class="line"><a id="l02100" name="l02100"></a><span class="lineno"> 2100</span> </div>
<div class="line"><a id="l02101" name="l02101"></a><span class="lineno"> 2101</span>    <span class="comment">! Sum cv*t_lake for energy check</span></div>
<div class="line"><a id="l02102" name="l02102"></a><span class="lineno"> 2102</span>    <span class="comment">! Include latent heat term, and correction for changing heat capacity with phase change.</span></div>
<div class="line"><a id="l02103" name="l02103"></a><span class="lineno"> 2103</span> </div>
<div class="line"><a id="l02104" name="l02104"></a><span class="lineno"> 2104</span>    <span class="comment">! This will need to be over all soil / lake / snow layers. Lake is below.</span></div>
<div class="line"><a id="l02105" name="l02105"></a><span class="lineno"> 2105</span>    <span class="keywordflow">do</span> j = 1, nlevlake</div>
<div class="line"><a id="l02106" name="l02106"></a><span class="lineno"> 2106</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02107" name="l02107"></a><span class="lineno"> 2107</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02108" name="l02108"></a><span class="lineno"> 2108</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02109" name="l02109"></a><span class="lineno"> 2109</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02110" name="l02110"></a><span class="lineno"> 2110</span> </div>
<div class="line"><a id="l02111" name="l02111"></a><span class="lineno"> 2111</span>          <span class="comment">!          ocvts(c) = ocvts(c) + cv_lake(c,j)*t_lake(c,j) &amp;</span></div>
<div class="line"><a id="l02112" name="l02112"></a><span class="lineno"> 2112</span>          ocvts(c) = ocvts(c) + cv_lake(c,j)*(t_lake(c,j)-tfrz) &amp;</div>
<div class="line"><a id="l02113" name="l02113"></a><span class="lineno"> 2113</span>                   + cfus*dz_lake(c,j)*(1._kind_lake-lake_icefrac(c,j)) <span class="comment">!&amp;</span></div>
<div class="line"><a id="l02114" name="l02114"></a><span class="lineno"> 2114</span>          <span class="comment">!                   + (cwat-cice_eff)*lake_icefrac(c)*tfrz*dz_lake(c,j) !enthalpy reconciliation term</span></div>
<div class="line"><a id="l02115" name="l02115"></a><span class="lineno"> 2115</span>          t_lake_bef(c,j) = t_lake(c,j)</div>
<div class="line"><a id="l02116" name="l02116"></a><span class="lineno"> 2116</span>         <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02117" name="l02117"></a><span class="lineno"> 2117</span>           <span class="keywordflow">if</span> (abs(xlat_d-52.1152).lt.0.1 .and.     &amp;</div>
<div class="line"><a id="l02118" name="l02118"></a><span class="lineno"> 2118</span>            abs(xlon_d-260.405).lt.0.1)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02119" name="l02119"></a><span class="lineno"> 2119</span>            print *,<span class="stringliteral">&#39; ocvts(c) at xlat_d,xlon_d&#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l02120" name="l02120"></a><span class="lineno"> 2120</span>            print *,<span class="stringliteral">&#39;j,dz_lake(c,j) &#39;</span>, j,dz_lake(c,j)</div>
<div class="line"><a id="l02121" name="l02121"></a><span class="lineno"> 2121</span>            print*,<span class="stringliteral">&#39;cv_lake(c,j),lake_icefrac(c,j),t_lake(c,j),cfus,ocvts(c)&#39;</span>, &amp;</div>
<div class="line"><a id="l02122" name="l02122"></a><span class="lineno"> 2122</span>                    cv_lake(c,j),lake_icefrac(c,j),t_lake(c,j),cfus,ocvts(c)</div>
<div class="line"><a id="l02123" name="l02123"></a><span class="lineno"> 2123</span><span class="keywordflow">           endif</span></div>
<div class="line"><a id="l02124" name="l02124"></a><span class="lineno"> 2124</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l02125" name="l02125"></a><span class="lineno"> 2125</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02126" name="l02126"></a><span class="lineno"> 2126</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02127" name="l02127"></a><span class="lineno"> 2127</span> </div>
<div class="line"><a id="l02128" name="l02128"></a><span class="lineno"> 2128</span>    <span class="comment">! Now do for soil / snow layers</span></div>
<div class="line"><a id="l02129" name="l02129"></a><span class="lineno"> 2129</span>    <span class="keywordflow">do</span> j = -nlevsnow + 1, nlevsoil</div>
<div class="line"><a id="l02130" name="l02130"></a><span class="lineno"> 2130</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02131" name="l02131"></a><span class="lineno"> 2131</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02132" name="l02132"></a><span class="lineno"> 2132</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02133" name="l02133"></a><span class="lineno"> 2133</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02134" name="l02134"></a><span class="lineno"> 2134</span> </div>
<div class="line"><a id="l02135" name="l02135"></a><span class="lineno"> 2135</span>          <span class="keywordflow">if</span> (j &gt;= jtop(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02136" name="l02136"></a><span class="lineno"> 2136</span>            <span class="comment">!             ocvts(c) = ocvts(c) + cv(c,j)*t_soisno(c,j) &amp;</span></div>
<div class="line"><a id="l02137" name="l02137"></a><span class="lineno"> 2137</span>             ocvts(c) = ocvts(c) + cv(c,j)*(t_soisno(c,j)-tfrz) &amp;</div>
<div class="line"><a id="l02138" name="l02138"></a><span class="lineno"> 2138</span>                      + hfus*h2osoi_liq(c,j) <span class="comment">!&amp;</span></div>
<div class="line"><a id="l02139" name="l02139"></a><span class="lineno"> 2139</span>             <span class="comment">!                      + (cpliq-cpice)*h2osoi_ice(c,j)*tfrz !enthalpy reconciliation term</span></div>
<div class="line"><a id="l02140" name="l02140"></a><span class="lineno"> 2140</span>         <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02141" name="l02141"></a><span class="lineno"> 2141</span>           <span class="keywordflow">if</span> (abs(xlat_d-52.1152).lt.0.1 .and.     &amp;</div>
<div class="line"><a id="l02142" name="l02142"></a><span class="lineno"> 2142</span>               abs(xlon_d-260.405).lt.0.1)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02143" name="l02143"></a><span class="lineno"> 2143</span>             print *,<span class="stringliteral">&#39; ocvts(c) at xlat_d,xlon_d&#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l02144" name="l02144"></a><span class="lineno"> 2144</span>             print *,<span class="stringliteral">&#39; j,jtop(c)&#39;</span>,j,jtop(c),<span class="stringliteral">&#39;h2osoi_liq(c,j) &#39;</span>,h2osoi_liq(c,j),<span class="stringliteral">&#39;h2osoi_ice(c,j)&#39;</span>,h2osoi_ice(c,j)</div>
<div class="line"><a id="l02145" name="l02145"></a><span class="lineno"> 2145</span>             print *,<span class="stringliteral">&#39; cv(c,j),t_soisno(c,j),hfus,ocvts(c)&#39;</span>,c,j,cv(c,j),t_soisno(c,j),hfus,ocvts(c)</div>
<div class="line"><a id="l02146" name="l02146"></a><span class="lineno"> 2146</span>             print *,<span class="stringliteral">&#39; h2osno(c)&#39;</span>,h2osno(c)</div>
<div class="line"><a id="l02147" name="l02147"></a><span class="lineno"> 2147</span><span class="keywordflow">           endif</span></div>
<div class="line"><a id="l02148" name="l02148"></a><span class="lineno"> 2148</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l02149" name="l02149"></a><span class="lineno"> 2149</span>             <span class="keywordflow">if</span> (j == 1 .and. h2osno(c) &gt; 0._kind_lake .and. j == jtop(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02150" name="l02150"></a><span class="lineno"> 2150</span>                ocvts(c) = ocvts(c) - h2osno(c)*hfus</div>
<div class="line"><a id="l02151" name="l02151"></a><span class="lineno"> 2151</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02152" name="l02152"></a><span class="lineno"> 2152</span>             t_soisno_bef(c,j) = t_soisno(c,j)</div>
<div class="line"><a id="l02153" name="l02153"></a><span class="lineno"> 2153</span>             <span class="keywordflow">if</span>(abs(t_soisno(c,j)-288) &gt; 150)   <span class="keywordflow">then</span> </div>
<div class="line"><a id="l02154" name="l02154"></a><span class="lineno"> 2154</span>48              <span class="keyword">format</span>(<span class="stringliteral">&#39;WARNING: At c=&#39;</span>,i0,<span class="stringliteral">&#39; level=&#39;</span>,i0,<span class="stringliteral">&#39; extreme t_soisno = &#39;</span>,f15.10)</div>
<div class="line"><a id="l02155" name="l02155"></a><span class="lineno"> 2155</span>                <span class="keyword">WRITE</span>(message,48) c,j,t_soisno(c,j)</div>
<div class="line"><a id="l02156" name="l02156"></a><span class="lineno"> 2156</span>                <span class="comment">! errmsg=trim(message)</span></div>
<div class="line"><a id="l02157" name="l02157"></a><span class="lineno"> 2157</span>                <span class="comment">! errflg=1</span></div>
<div class="line"><a id="l02158" name="l02158"></a><span class="lineno"> 2158</span>                <span class="keyword">write</span>(0,<span class="stringliteral">&#39;(A)&#39;</span>) trim(message)</div>
<div class="line"><a id="l02159" name="l02159"></a><span class="lineno"> 2159</span><span class="keywordflow">             endif</span></div>
<div class="line"><a id="l02160" name="l02160"></a><span class="lineno"> 2160</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02161" name="l02161"></a><span class="lineno"> 2161</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02162" name="l02162"></a><span class="lineno"> 2162</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02163" name="l02163"></a><span class="lineno"> 2163</span> </div>
<div class="line"><a id="l02164" name="l02164"></a><span class="lineno"> 2164</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02165" name="l02165"></a><span class="lineno"> 2165</span>    <span class="comment">! 6!) Set up vector r and vectors a, b, c1 that define tridiagonal matrix</span></div>
<div class="line"><a id="l02166" name="l02166"></a><span class="lineno"> 2166</span> </div>
<div class="line"><a id="l02167" name="l02167"></a><span class="lineno"> 2167</span>    <span class="comment">! Heat capacity and resistance of snow without snow layers (&lt;1cm) is ignored during diffusion,</span></div>
<div class="line"><a id="l02168" name="l02168"></a><span class="lineno"> 2168</span>    <span class="comment">! but its capacity to absorb latent heat may be used during phase change.</span></div>
<div class="line"><a id="l02169" name="l02169"></a><span class="lineno"> 2169</span> </div>
<div class="line"><a id="l02170" name="l02170"></a><span class="lineno"> 2170</span>    <span class="comment">! Set up interface depths, zx, heat capacities, cvx, solar source terms, phix, and temperatures, tx.</span></div>
<div class="line"><a id="l02171" name="l02171"></a><span class="lineno"> 2171</span>    <span class="keywordflow">do</span> j = -nlevsnow+1, nlevlake+nlevsoil</div>
<div class="line"><a id="l02172" name="l02172"></a><span class="lineno"> 2172</span>      <span class="comment">!dir$ prefervector</span></div>
<div class="line"><a id="l02173" name="l02173"></a><span class="lineno"> 2173</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02174" name="l02174"></a><span class="lineno"> 2174</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02175" name="l02175"></a><span class="lineno"> 2175</span>       <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l02176" name="l02176"></a><span class="lineno"> 2176</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02177" name="l02177"></a><span class="lineno"> 2177</span> </div>
<div class="line"><a id="l02178" name="l02178"></a><span class="lineno"> 2178</span>          jprime = j - nlevlake</div>
<div class="line"><a id="l02179" name="l02179"></a><span class="lineno"> 2179</span> </div>
<div class="line"><a id="l02180" name="l02180"></a><span class="lineno"> 2180</span>          <span class="keywordflow">if</span> (j &gt;= jtop(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02181" name="l02181"></a><span class="lineno"> 2181</span>             <span class="keywordflow">if</span> (j &lt; 1) <span class="keywordflow">then</span> <span class="comment">!snow layer</span></div>
<div class="line"><a id="l02182" name="l02182"></a><span class="lineno"> 2182</span>                zx(c,j) = z(c,j)</div>
<div class="line"><a id="l02183" name="l02183"></a><span class="lineno"> 2183</span>                cvx(c,j) = cv(c,j)</div>
<div class="line"><a id="l02184" name="l02184"></a><span class="lineno"> 2184</span>                phix(c,j) = 0._kind_lake</div>
<div class="line"><a id="l02185" name="l02185"></a><span class="lineno"> 2185</span>                tx(c,j) = t_soisno(c,j)</div>
<div class="line"><a id="l02186" name="l02186"></a><span class="lineno"> 2186</span>             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j &lt;= nlevlake) <span class="keywordflow">then</span> <span class="comment">!lake layer</span></div>
<div class="line"><a id="l02187" name="l02187"></a><span class="lineno"> 2187</span>                zx(c,j) = z_lake(c,j)</div>
<div class="line"><a id="l02188" name="l02188"></a><span class="lineno"> 2188</span>                cvx(c,j) = cv_lake(c,j)</div>
<div class="line"><a id="l02189" name="l02189"></a><span class="lineno"> 2189</span>                phix(c,j) = phi(c,j)</div>
<div class="line"><a id="l02190" name="l02190"></a><span class="lineno"> 2190</span>                tx(c,j) = t_lake(c,j)</div>
<div class="line"><a id="l02191" name="l02191"></a><span class="lineno"> 2191</span>             <span class="keywordflow">else</span> <span class="comment">!soil layer</span></div>
<div class="line"><a id="l02192" name="l02192"></a><span class="lineno"> 2192</span>                zx(c,j) = zx(c,nlevlake) + dz_lake(c,nlevlake)*0.5_kind_lake + z(c,jprime)</div>
<div class="line"><a id="l02193" name="l02193"></a><span class="lineno"> 2193</span>                cvx(c,j) = cv(c,jprime)</div>
<div class="line"><a id="l02194" name="l02194"></a><span class="lineno"> 2194</span>                <span class="keywordflow">if</span> (j == nlevlake + 1) <span class="keywordflow">then</span> <span class="comment">!top soil layer</span></div>
<div class="line"><a id="l02195" name="l02195"></a><span class="lineno"> 2195</span>                   phix(c,j) = phi_soil(c)</div>
<div class="line"><a id="l02196" name="l02196"></a><span class="lineno"> 2196</span>                <span class="keywordflow">else</span> <span class="comment">!middle or bottom soil layer</span></div>
<div class="line"><a id="l02197" name="l02197"></a><span class="lineno"> 2197</span>                   phix(c,j) = 0._kind_lake</div>
<div class="line"><a id="l02198" name="l02198"></a><span class="lineno"> 2198</span><span class="keywordflow">                end if</span></div>
<div class="line"><a id="l02199" name="l02199"></a><span class="lineno"> 2199</span>                tx(c,j) = t_soisno(c,jprime)</div>
<div class="line"><a id="l02200" name="l02200"></a><span class="lineno"> 2200</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02201" name="l02201"></a><span class="lineno"> 2201</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02202" name="l02202"></a><span class="lineno"> 2202</span> </div>
<div class="line"><a id="l02203" name="l02203"></a><span class="lineno"> 2203</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02204" name="l02204"></a><span class="lineno"> 2204</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02205" name="l02205"></a><span class="lineno"> 2205</span> </div>
<div class="line"><a id="l02206" name="l02206"></a><span class="lineno"> 2206</span>    <span class="comment">! Determine interface thermal conductivities, tkix</span></div>
<div class="line"><a id="l02207" name="l02207"></a><span class="lineno"> 2207</span> </div>
<div class="line"><a id="l02208" name="l02208"></a><span class="lineno"> 2208</span>    <span class="keywordflow">do</span> j = -nlevsnow+1, nlevlake+nlevsoil</div>
<div class="line"><a id="l02209" name="l02209"></a><span class="lineno"> 2209</span>      <span class="comment">!dir$ prefervector</span></div>
<div class="line"><a id="l02210" name="l02210"></a><span class="lineno"> 2210</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02211" name="l02211"></a><span class="lineno"> 2211</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02212" name="l02212"></a><span class="lineno"> 2212</span>       <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l02213" name="l02213"></a><span class="lineno"> 2213</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02214" name="l02214"></a><span class="lineno"> 2214</span> </div>
<div class="line"><a id="l02215" name="l02215"></a><span class="lineno"> 2215</span>          jprime = j - nlevlake</div>
<div class="line"><a id="l02216" name="l02216"></a><span class="lineno"> 2216</span> </div>
<div class="line"><a id="l02217" name="l02217"></a><span class="lineno"> 2217</span>          <span class="keywordflow">if</span> (j &gt;= jtop(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02218" name="l02218"></a><span class="lineno"> 2218</span>             <span class="keywordflow">if</span> (j &lt; 0) <span class="keywordflow">then</span> <span class="comment">!non-bottom snow layer</span></div>
<div class="line"><a id="l02219" name="l02219"></a><span class="lineno"> 2219</span>                tkix(c,j) = tk(c,j)</div>
<div class="line"><a id="l02220" name="l02220"></a><span class="lineno"> 2220</span>             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j == 0) <span class="keywordflow">then</span> <span class="comment">!bottom snow layer</span></div>
<div class="line"><a id="l02221" name="l02221"></a><span class="lineno"> 2221</span>                dzp = zx(c,j+1) - zx(c,j)</div>
<div class="line"><a id="l02222" name="l02222"></a><span class="lineno"> 2222</span>                tkix(c,j) = tk_lake(c,1)*tk(c,j)*dzp / &amp;</div>
<div class="line"><a id="l02223" name="l02223"></a><span class="lineno"> 2223</span>                      (tk(c,j)*z_lake(c,1) + tk_lake(c,1)*(-z(c,j)) )</div>
<div class="line"><a id="l02224" name="l02224"></a><span class="lineno"> 2224</span>                <span class="comment">! tk(c,0) is the conductivity at the middle of that layer, as defined in SoilThermProp_Lake</span></div>
<div class="line"><a id="l02225" name="l02225"></a><span class="lineno"> 2225</span>             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j &lt; nlevlake) <span class="keywordflow">then</span> <span class="comment">!non-bottom lake layer</span></div>
<div class="line"><a id="l02226" name="l02226"></a><span class="lineno"> 2226</span>                tkix(c,j) = ( tk_lake(c,j)*tk_lake(c,j+1) * (dz_lake(c,j+1)+dz_lake(c,j)) ) &amp;</div>
<div class="line"><a id="l02227" name="l02227"></a><span class="lineno"> 2227</span>                           / ( tk_lake(c,j)*dz_lake(c,j+1) + tk_lake(c,j+1)*dz_lake(c,j) )</div>
<div class="line"><a id="l02228" name="l02228"></a><span class="lineno"> 2228</span>             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j == nlevlake) <span class="keywordflow">then</span> <span class="comment">!bottom lake layer</span></div>
<div class="line"><a id="l02229" name="l02229"></a><span class="lineno"> 2229</span>                dzp = zx(c,j+1) - zx(c,j)</div>
<div class="line"><a id="l02230" name="l02230"></a><span class="lineno"> 2230</span>                tkix(c,j) = (tktopsoillay(c)*tk_lake(c,j)*dzp / &amp;</div>
<div class="line"><a id="l02231" name="l02231"></a><span class="lineno"> 2231</span>                    (tktopsoillay(c)*dz_lake(c,j)*0.5_kind_lake + tk_lake(c,j)*z(c,1) ) )</div>
<div class="line"><a id="l02232" name="l02232"></a><span class="lineno"> 2232</span>                    <span class="comment">! tktopsoillay is the conductivity at the middle of that layer, as defined in SoilThermProp_Lake</span></div>
<div class="line"><a id="l02233" name="l02233"></a><span class="lineno"> 2233</span>             <span class="keywordflow">else</span> <span class="comment">!soil layer</span></div>
<div class="line"><a id="l02234" name="l02234"></a><span class="lineno"> 2234</span>                tkix(c,j) = tk(c,jprime)</div>
<div class="line"><a id="l02235" name="l02235"></a><span class="lineno"> 2235</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02236" name="l02236"></a><span class="lineno"> 2236</span><span class="keywordflow">         end if</span></div>
<div class="line"><a id="l02237" name="l02237"></a><span class="lineno"> 2237</span> </div>
<div class="line"><a id="l02238" name="l02238"></a><span class="lineno"> 2238</span><span class="keywordflow">      end do</span> </div>
<div class="line"><a id="l02239" name="l02239"></a><span class="lineno"> 2239</span><span class="keywordflow">   end do</span></div>
<div class="line"><a id="l02240" name="l02240"></a><span class="lineno"> 2240</span> </div>
<div class="line"><a id="l02241" name="l02241"></a><span class="lineno"> 2241</span> </div>
<div class="line"><a id="l02242" name="l02242"></a><span class="lineno"> 2242</span>    <span class="comment">! Determine heat diffusion through the layer interface and factor used in computing</span></div>
<div class="line"><a id="l02243" name="l02243"></a><span class="lineno"> 2243</span>    <span class="comment">! tridiagonal matrix and set up vector r and vectors a, b, c1 that define tridiagonal</span></div>
<div class="line"><a id="l02244" name="l02244"></a><span class="lineno"> 2244</span>    <span class="comment">! matrix and solve system</span></div>
<div class="line"><a id="l02245" name="l02245"></a><span class="lineno"> 2245</span> </div>
<div class="line"><a id="l02246" name="l02246"></a><span class="lineno"> 2246</span>    <span class="keywordflow">do</span> j = -nlevsnow+1, nlevlake+nlevsoil</div>
<div class="line"><a id="l02247" name="l02247"></a><span class="lineno"> 2247</span>      <span class="comment">!dir$ prefervector</span></div>
<div class="line"><a id="l02248" name="l02248"></a><span class="lineno"> 2248</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02249" name="l02249"></a><span class="lineno"> 2249</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02250" name="l02250"></a><span class="lineno"> 2250</span>       <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l02251" name="l02251"></a><span class="lineno"> 2251</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02252" name="l02252"></a><span class="lineno"> 2252</span>          <span class="keywordflow">if</span> (j &gt;= jtop(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02253" name="l02253"></a><span class="lineno"> 2253</span>             <span class="keywordflow">if</span> (j &lt; nlevlake+nlevsoil) <span class="keywordflow">then</span> <span class="comment">!top or interior layer</span></div>
<div class="line"><a id="l02254" name="l02254"></a><span class="lineno"> 2254</span>                factx(c,j) = dtime/cvx(c,j)</div>
<div class="line"><a id="l02255" name="l02255"></a><span class="lineno"> 2255</span>                fnx(c,j) = tkix(c,j)*(tx(c,j+1)-tx(c,j))/(zx(c,j+1)-zx(c,j))</div>
<div class="line"><a id="l02256" name="l02256"></a><span class="lineno"> 2256</span>             <span class="keywordflow">else</span> <span class="comment">!bottom soil layer</span></div>
<div class="line"><a id="l02257" name="l02257"></a><span class="lineno"> 2257</span>                factx(c,j) = dtime/cvx(c,j)</div>
<div class="line"><a id="l02258" name="l02258"></a><span class="lineno"> 2258</span>                fnx(c,j) = 0._kind_lake <span class="comment">!not used</span></div>
<div class="line"><a id="l02259" name="l02259"></a><span class="lineno"> 2259</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02260" name="l02260"></a><span class="lineno"> 2260</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02261" name="l02261"></a><span class="lineno"> 2261</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02262" name="l02262"></a><span class="lineno"> 2262</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02263" name="l02263"></a><span class="lineno"> 2263</span> </div>
<div class="line"><a id="l02264" name="l02264"></a><span class="lineno"> 2264</span>    <span class="keywordflow">do</span> j = -nlevsnow+1,nlevlake+nlevsoil</div>
<div class="line"><a id="l02265" name="l02265"></a><span class="lineno"> 2265</span>      <span class="comment">!dir$ prefervector</span></div>
<div class="line"><a id="l02266" name="l02266"></a><span class="lineno"> 2266</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02267" name="l02267"></a><span class="lineno"> 2267</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02268" name="l02268"></a><span class="lineno"> 2268</span>       <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l02269" name="l02269"></a><span class="lineno"> 2269</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02270" name="l02270"></a><span class="lineno"> 2270</span>          <span class="keywordflow">if</span> (j &gt;= jtop(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02271" name="l02271"></a><span class="lineno"> 2271</span>             <span class="keywordflow">if</span> (j == jtop(c)) <span class="keywordflow">then</span> <span class="comment">!top layer</span></div>
<div class="line"><a id="l02272" name="l02272"></a><span class="lineno"> 2272</span>                dzp    = zx(c,j+1)-zx(c,j)</div>
<div class="line"><a id="l02273" name="l02273"></a><span class="lineno"> 2273</span>                a(c,j) = 0._kind_lake</div>
<div class="line"><a id="l02274" name="l02274"></a><span class="lineno"> 2274</span>                b(c,j) = 1+(1._kind_lake-cnfac)*factx(c,j)*tkix(c,j)/dzp</div>
<div class="line"><a id="l02275" name="l02275"></a><span class="lineno"> 2275</span>                c1(c,j) =  -(1._kind_lake-cnfac)*factx(c,j)*tkix(c,j)/dzp</div>
<div class="line"><a id="l02276" name="l02276"></a><span class="lineno"> 2276</span>                r(c,j) = tx(c,j) + factx(c,j)*( fin(c) + phix(c,j) + cnfac*fnx(c,j) )</div>
<div class="line"><a id="l02277" name="l02277"></a><span class="lineno"> 2277</span>             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j &lt; nlevlake+nlevsoil) <span class="keywordflow">then</span> <span class="comment">!middle layer</span></div>
<div class="line"><a id="l02278" name="l02278"></a><span class="lineno"> 2278</span>                dzm    = (zx(c,j)-zx(c,j-1))</div>
<div class="line"><a id="l02279" name="l02279"></a><span class="lineno"> 2279</span>                dzp    = (zx(c,j+1)-zx(c,j))</div>
<div class="line"><a id="l02280" name="l02280"></a><span class="lineno"> 2280</span>                a(c,j) =   - (1._kind_lake-cnfac)*factx(c,j)* tkix(c,j-1)/dzm</div>
<div class="line"><a id="l02281" name="l02281"></a><span class="lineno"> 2281</span>                b(c,j) = 1._kind_lake+ (1._kind_lake-cnfac)*factx(c,j)*(tkix(c,j)/dzp + tkix(c,j-1)/dzm)</div>
<div class="line"><a id="l02282" name="l02282"></a><span class="lineno"> 2282</span>                c1(c,j) =   - (1._kind_lake-cnfac)*factx(c,j)* tkix(c,j)/dzp</div>
<div class="line"><a id="l02283" name="l02283"></a><span class="lineno"> 2283</span>                r(c,j) = tx(c,j) + cnfac*factx(c,j)*( fnx(c,j) - fnx(c,j-1) ) + factx(c,j)*phix(c,j)</div>
<div class="line"><a id="l02284" name="l02284"></a><span class="lineno"> 2284</span>             <span class="keywordflow">else</span>  <span class="comment">!bottom soil layer</span></div>
<div class="line"><a id="l02285" name="l02285"></a><span class="lineno"> 2285</span>                dzm     = (zx(c,j)-zx(c,j-1))</div>
<div class="line"><a id="l02286" name="l02286"></a><span class="lineno"> 2286</span>                a(c,j) =   - (1._kind_lake-cnfac)*factx(c,j)*tkix(c,j-1)/dzm</div>
<div class="line"><a id="l02287" name="l02287"></a><span class="lineno"> 2287</span>                b(c,j) = 1._kind_lake+ (1._kind_lake-cnfac)*factx(c,j)*tkix(c,j-1)/dzm</div>
<div class="line"><a id="l02288" name="l02288"></a><span class="lineno"> 2288</span>                c1(c,j) = 0._kind_lake</div>
<div class="line"><a id="l02289" name="l02289"></a><span class="lineno"> 2289</span>                r(c,j) = tx(c,j) - cnfac*factx(c,j)*fnx(c,j-1)</div>
<div class="line"><a id="l02290" name="l02290"></a><span class="lineno"> 2290</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02291" name="l02291"></a><span class="lineno"> 2291</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02292" name="l02292"></a><span class="lineno"> 2292</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02293" name="l02293"></a><span class="lineno"> 2293</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02294" name="l02294"></a><span class="lineno"> 2294</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02295" name="l02295"></a><span class="lineno"> 2295</span> </div>
<div class="line"><a id="l02296" name="l02296"></a><span class="lineno"> 2296</span> </div>
<div class="line"><a id="l02297" name="l02297"></a><span class="lineno"> 2297</span>    <span class="comment">! 7!) Solve for tdsolution</span></div>
<div class="line"><a id="l02298" name="l02298"></a><span class="lineno"> 2298</span> </div>
<div class="line"><a id="l02299" name="l02299"></a><span class="lineno"> 2299</span>    <span class="keyword">call </span>tridiagonal(lbc, ubc, -nlevsnow + 1, nlevlake + nlevsoil, jtop, num_shlakec, filter_shlakec, &amp;</div>
<div class="line"><a id="l02300" name="l02300"></a><span class="lineno"> 2300</span>                     a, b, c1, r, tx)</div>
<div class="line"><a id="l02301" name="l02301"></a><span class="lineno"> 2301</span> </div>
<div class="line"><a id="l02302" name="l02302"></a><span class="lineno"> 2302</span>    <span class="comment">! Set t_soisno and t_lake</span></div>
<div class="line"><a id="l02303" name="l02303"></a><span class="lineno"> 2303</span>    <span class="keywordflow">do</span> j = -nlevsnow+1, nlevlake + nlevsoil</div>
<div class="line"><a id="l02304" name="l02304"></a><span class="lineno"> 2304</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02305" name="l02305"></a><span class="lineno"> 2305</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02306" name="l02306"></a><span class="lineno"> 2306</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02307" name="l02307"></a><span class="lineno"> 2307</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02308" name="l02308"></a><span class="lineno"> 2308</span> </div>
<div class="line"><a id="l02309" name="l02309"></a><span class="lineno"> 2309</span>          jprime = j - nlevlake</div>
<div class="line"><a id="l02310" name="l02310"></a><span class="lineno"> 2310</span> </div>
<div class="line"><a id="l02311" name="l02311"></a><span class="lineno"> 2311</span>          <span class="comment">! Don&#39;t do anything with invalid snow layers.</span></div>
<div class="line"><a id="l02312" name="l02312"></a><span class="lineno"> 2312</span>          <span class="keywordflow">if</span> (j &gt;= jtop(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02313" name="l02313"></a><span class="lineno"> 2313</span>             <span class="keywordflow">if</span> (j &lt; 1) <span class="keywordflow">then</span> <span class="comment">!snow layer</span></div>
<div class="line"><a id="l02314" name="l02314"></a><span class="lineno"> 2314</span>             t_soisno(c,j) = tx(c,j)</div>
<div class="line"><a id="l02315" name="l02315"></a><span class="lineno"> 2315</span>             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j &lt;= nlevlake) <span class="keywordflow">then</span> <span class="comment">!lake layer</span></div>
<div class="line"><a id="l02316" name="l02316"></a><span class="lineno"> 2316</span>             t_lake(c,j)   = tx(c,j)</div>
<div class="line"><a id="l02317" name="l02317"></a><span class="lineno"> 2317</span>             <span class="keywordflow">else</span> <span class="comment">!soil layer</span></div>
<div class="line"><a id="l02318" name="l02318"></a><span class="lineno"> 2318</span>             t_soisno(c,jprime) = tx(c,j)</div>
<div class="line"><a id="l02319" name="l02319"></a><span class="lineno"> 2319</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02320" name="l02320"></a><span class="lineno"> 2320</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02321" name="l02321"></a><span class="lineno"> 2321</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02322" name="l02322"></a><span class="lineno"> 2322</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02323" name="l02323"></a><span class="lineno"> 2323</span> </div>
<div class="line"><a id="l02324" name="l02324"></a><span class="lineno"> 2324</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02325" name="l02325"></a><span class="lineno"> 2325</span> </div>
<div class="line"><a id="l02326" name="l02326"></a><span class="lineno"> 2326</span>    <span class="comment">! 8!) Sum energy content and total energy into lake for energy check. Any errors will be from the</span></div>
<div class="line"><a id="l02327" name="l02327"></a><span class="lineno"> 2327</span>    <span class="comment">!     Tridiagonal solution.</span></div>
<div class="line"><a id="l02328" name="l02328"></a><span class="lineno"> 2328</span> </div>
<div class="line"><a id="l02329" name="l02329"></a><span class="lineno"> 2329</span>    if_debug_energy: <span class="keywordflow">if</span> (lakedebug) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02330" name="l02330"></a><span class="lineno"> 2330</span>    <span class="keywordflow">do</span> j = 1, nlevlake</div>
<div class="line"><a id="l02331" name="l02331"></a><span class="lineno"> 2331</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02332" name="l02332"></a><span class="lineno"> 2332</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02333" name="l02333"></a><span class="lineno"> 2333</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02334" name="l02334"></a><span class="lineno"> 2334</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02335" name="l02335"></a><span class="lineno"> 2335</span> </div>
<div class="line"><a id="l02336" name="l02336"></a><span class="lineno"> 2336</span>          esum1(c) = esum1(c) + (t_lake(c,j)-t_lake_bef(c,j))*cv_lake(c,j)</div>
<div class="line"><a id="l02337" name="l02337"></a><span class="lineno"> 2337</span>          esum2(c) = esum2(c) + (t_lake(c,j)-tfrz)*cv_lake(c,j)</div>
<div class="line"><a id="l02338" name="l02338"></a><span class="lineno"> 2338</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02339" name="l02339"></a><span class="lineno"> 2339</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02340" name="l02340"></a><span class="lineno"> 2340</span> </div>
<div class="line"><a id="l02341" name="l02341"></a><span class="lineno"> 2341</span>    <span class="keywordflow">do</span> j = -nlevsnow+1, nlevsoil</div>
<div class="line"><a id="l02342" name="l02342"></a><span class="lineno"> 2342</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02343" name="l02343"></a><span class="lineno"> 2343</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02344" name="l02344"></a><span class="lineno"> 2344</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02345" name="l02345"></a><span class="lineno"> 2345</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02346" name="l02346"></a><span class="lineno"> 2346</span> </div>
<div class="line"><a id="l02347" name="l02347"></a><span class="lineno"> 2347</span>          <span class="keywordflow">if</span> (j &gt;= jtop(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02348" name="l02348"></a><span class="lineno"> 2348</span>             esum1(c) = esum1(c) + (t_soisno(c,j)-t_soisno_bef(c,j))*cv(c,j)</div>
<div class="line"><a id="l02349" name="l02349"></a><span class="lineno"> 2349</span>             esum2(c) = esum2(c) + (t_soisno(c,j)-tfrz)*cv(c,j)</div>
<div class="line"><a id="l02350" name="l02350"></a><span class="lineno"> 2350</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02351" name="l02351"></a><span class="lineno"> 2351</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02352" name="l02352"></a><span class="lineno"> 2352</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02353" name="l02353"></a><span class="lineno"> 2353</span> </div>
<div class="line"><a id="l02354" name="l02354"></a><span class="lineno"> 2354</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02355" name="l02355"></a><span class="lineno"> 2355</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02356" name="l02356"></a><span class="lineno"> 2356</span>       <span class="keywordflow">do</span> fp = 1, num_shlakep</div>
<div class="line"><a id="l02357" name="l02357"></a><span class="lineno"> 2357</span>          p = filter_shlakep(fp)</div>
<div class="line"><a id="l02358" name="l02358"></a><span class="lineno"> 2358</span>          c = pcolumn(p)</div>
<div class="line"><a id="l02359" name="l02359"></a><span class="lineno"> 2359</span>          <span class="comment">! Again assuming only one pft per column</span></div>
<div class="line"><a id="l02360" name="l02360"></a><span class="lineno"> 2360</span>          <span class="comment">!          esum1(c) = esum1(c) + lhabs(c)</span></div>
<div class="line"><a id="l02361" name="l02361"></a><span class="lineno"> 2361</span>          errsoi(c) = esum1(c)/dtime - eflx_soil_grnd(p)</div>
<div class="line"><a id="l02362" name="l02362"></a><span class="lineno"> 2362</span>                    <span class="comment">! eflx_soil_grnd includes all the solar radiation absorbed in the lake,</span></div>
<div class="line"><a id="l02363" name="l02363"></a><span class="lineno"> 2363</span>                    <span class="comment">! unlike eflx_gnet</span></div>
<div class="line"><a id="l02364" name="l02364"></a><span class="lineno"> 2364</span>          <span class="keywordflow">if</span>(abs(errsoi(c)) &gt; .001_kind_lake) <span class="keywordflow">then</span> <span class="comment">! 1.e-5_kind_lake) then</span></div>
<div class="line"><a id="l02365" name="l02365"></a><span class="lineno"> 2365</span>             <span class="keyword">WRITE</span>( message,* )<span class="stringliteral">&#39;Primary soil energy conservation error in shlake &amp;</span></div>
<div class="line"><a id="l02366" name="l02366"></a><span class="lineno"> 2366</span><span class="stringliteral"></span><span class="stringliteral">                                &amp;column during Tridiagonal Solution,&#39;</span>, <span class="stringliteral">&#39;error (W/m^2):&#39;</span>, c, errsoi(c) </div>
<div class="line"><a id="l02367" name="l02367"></a><span class="lineno"> 2367</span>             errmsg=trim(message)</div>
<div class="line"><a id="l02368" name="l02368"></a><span class="lineno"> 2368</span>             errflg=1</div>
<div class="line"><a id="l02369" name="l02369"></a><span class="lineno"> 2369</span>             <span class="keywordflow">return</span></div>
<div class="line"><a id="l02370" name="l02370"></a><span class="lineno"> 2370</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02371" name="l02371"></a><span class="lineno"> 2371</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02372" name="l02372"></a><span class="lineno"> 2372</span>       <span class="comment">! This has to be done before convective mixing because the heat capacities for each layer</span></div>
<div class="line"><a id="l02373" name="l02373"></a><span class="lineno"> 2373</span>       <span class="comment">! will get scrambled.</span></div>
<div class="line"><a id="l02374" name="l02374"></a><span class="lineno"> 2374</span> </div>
<div class="line"><a id="l02375" name="l02375"></a><span class="lineno"> 2375</span><span class="keywordflow">    end if</span> if_debug_energy</div>
<div class="line"><a id="l02376" name="l02376"></a><span class="lineno"> 2376</span> </div>
<div class="line"><a id="l02377" name="l02377"></a><span class="lineno"> 2377</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02378" name="l02378"></a><span class="lineno"> 2378</span> </div>
<div class="line"><a id="l02379" name="l02379"></a><span class="lineno"> 2379</span>    <span class="comment">! 9!) Phase change</span></div>
<div class="line"><a id="l02380" name="l02380"></a><span class="lineno"> 2380</span>    <span class="keyword">call </span>phasechange_lake (snl,h2osno,dz,dz_lake,                            &amp; <span class="comment">!i</span></div>
<div class="line"><a id="l02381" name="l02381"></a><span class="lineno"> 2381</span>                               t_soisno,h2osoi_liq,h2osoi_ice,               &amp; <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l02382" name="l02382"></a><span class="lineno"> 2382</span>                               lake_icefrac,t_lake, snowdp,                  &amp; <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l02383" name="l02383"></a><span class="lineno"> 2383</span>                               qflx_snomelt,eflx_snomelt,imelt,              &amp; <span class="comment">!o  </span></div>
<div class="line"><a id="l02384" name="l02384"></a><span class="lineno"> 2384</span>                               cv, cv_lake,                                  &amp; <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l02385" name="l02385"></a><span class="lineno"> 2385</span>                               lhabs)                                          <span class="comment">!o</span></div>
<div class="line"><a id="l02386" name="l02386"></a><span class="lineno"> 2386</span> </div>
<div class="line"><a id="l02387" name="l02387"></a><span class="lineno"> 2387</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02388" name="l02388"></a><span class="lineno"> 2388</span> </div>
<div class="line"><a id="l02389" name="l02389"></a><span class="lineno"> 2389</span>    <span class="comment">! 9.5!) Second energy check and water check.  Now check energy balance before and after phase</span></div>
<div class="line"><a id="l02390" name="l02390"></a><span class="lineno"> 2390</span>    <span class="comment">!       change, considering the possibility of changed heat capacity during phase change, by</span></div>
<div class="line"><a id="l02391" name="l02391"></a><span class="lineno"> 2391</span>    <span class="comment">!       using initial heat capacity in the first step, final heat capacity in the second step,</span></div>
<div class="line"><a id="l02392" name="l02392"></a><span class="lineno"> 2392</span>    <span class="comment">!       and differences from tfrz only to avoid enthalpy correction for (cpliq-cpice)*melt*tfrz.</span></div>
<div class="line"><a id="l02393" name="l02393"></a><span class="lineno"> 2393</span>    <span class="comment">!       Also check soil water sum.</span></div>
<div class="line"><a id="l02394" name="l02394"></a><span class="lineno"> 2394</span> </div>
<div class="line"><a id="l02395" name="l02395"></a><span class="lineno"> 2395</span>    if_debug_balance: <span class="keywordflow">if</span> (lakedebug) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02396" name="l02396"></a><span class="lineno"> 2396</span>    <span class="keywordflow">do</span> j = 1, nlevlake</div>
<div class="line"><a id="l02397" name="l02397"></a><span class="lineno"> 2397</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02398" name="l02398"></a><span class="lineno"> 2398</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02399" name="l02399"></a><span class="lineno"> 2399</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02400" name="l02400"></a><span class="lineno"> 2400</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02401" name="l02401"></a><span class="lineno"> 2401</span> </div>
<div class="line"><a id="l02402" name="l02402"></a><span class="lineno"> 2402</span>          esum2(c) = esum2(c) - (t_lake(c,j)-tfrz)*cv_lake(c,j)</div>
<div class="line"><a id="l02403" name="l02403"></a><span class="lineno"> 2403</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02404" name="l02404"></a><span class="lineno"> 2404</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02405" name="l02405"></a><span class="lineno"> 2405</span> </div>
<div class="line"><a id="l02406" name="l02406"></a><span class="lineno"> 2406</span>    <span class="keywordflow">do</span> j = -nlevsnow+1, nlevsoil</div>
<div class="line"><a id="l02407" name="l02407"></a><span class="lineno"> 2407</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02408" name="l02408"></a><span class="lineno"> 2408</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02409" name="l02409"></a><span class="lineno"> 2409</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02410" name="l02410"></a><span class="lineno"> 2410</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02411" name="l02411"></a><span class="lineno"> 2411</span> </div>
<div class="line"><a id="l02412" name="l02412"></a><span class="lineno"> 2412</span>          <span class="keywordflow">if</span> (j &gt;= jtop(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02413" name="l02413"></a><span class="lineno"> 2413</span>             esum2(c) = esum2(c) - (t_soisno(c,j)-tfrz)*cv(c,j)</div>
<div class="line"><a id="l02414" name="l02414"></a><span class="lineno"> 2414</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02415" name="l02415"></a><span class="lineno"> 2415</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02416" name="l02416"></a><span class="lineno"> 2416</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02417" name="l02417"></a><span class="lineno"> 2417</span> </div>
<div class="line"><a id="l02418" name="l02418"></a><span class="lineno"> 2418</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02419" name="l02419"></a><span class="lineno"> 2419</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02420" name="l02420"></a><span class="lineno"> 2420</span>       <span class="keywordflow">do</span> fp = 1, num_shlakep</div>
<div class="line"><a id="l02421" name="l02421"></a><span class="lineno"> 2421</span>          p = filter_shlakep(fp)</div>
<div class="line"><a id="l02422" name="l02422"></a><span class="lineno"> 2422</span>          c = pcolumn(p)</div>
<div class="line"><a id="l02423" name="l02423"></a><span class="lineno"> 2423</span>          <span class="comment">! Again assuming only one pft per column</span></div>
<div class="line"><a id="l02424" name="l02424"></a><span class="lineno"> 2424</span>          esum2(c) = esum2(c) - lhabs(c)</div>
<div class="line"><a id="l02425" name="l02425"></a><span class="lineno"> 2425</span>          errsoi(c) = esum2(c)/dtime</div>
<div class="line"><a id="l02426" name="l02426"></a><span class="lineno"> 2426</span>          <span class="keywordflow">if</span>(abs(errsoi(c)) &gt; 1.e-5_kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02427" name="l02427"></a><span class="lineno"> 2427</span>             <span class="keyword">write</span>(message,*)<span class="stringliteral">&#39;Primary soil energy conservation error in shlake column during Phase Change, error (W/m^2):&#39;</span>, &amp;</div>
<div class="line"><a id="l02428" name="l02428"></a><span class="lineno"> 2428</span>                       c, errsoi(c)</div>
<div class="line"><a id="l02429" name="l02429"></a><span class="lineno"> 2429</span>             errmsg=trim(message)</div>
<div class="line"><a id="l02430" name="l02430"></a><span class="lineno"> 2430</span>             errflg=1</div>
<div class="line"><a id="l02431" name="l02431"></a><span class="lineno"> 2431</span>             <span class="keywordflow">return</span></div>
<div class="line"><a id="l02432" name="l02432"></a><span class="lineno"> 2432</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02433" name="l02433"></a><span class="lineno"> 2433</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02434" name="l02434"></a><span class="lineno"> 2434</span> </div>
<div class="line"><a id="l02435" name="l02435"></a><span class="lineno"> 2435</span>    <span class="comment">! Check soil water</span></div>
<div class="line"><a id="l02436" name="l02436"></a><span class="lineno"> 2436</span>    <span class="comment">! Sum soil water.</span></div>
<div class="line"><a id="l02437" name="l02437"></a><span class="lineno"> 2437</span>    <span class="keywordflow">do</span> j = 1, nlevsoil</div>
<div class="line"><a id="l02438" name="l02438"></a><span class="lineno"> 2438</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02439" name="l02439"></a><span class="lineno"> 2439</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02440" name="l02440"></a><span class="lineno"> 2440</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02441" name="l02441"></a><span class="lineno"> 2441</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02442" name="l02442"></a><span class="lineno"> 2442</span>          <span class="keywordflow">if</span> (j == 1) wsum_end(c) = 0._kind_lake</div>
<div class="line"><a id="l02443" name="l02443"></a><span class="lineno"> 2443</span>          wsum_end(c) = wsum_end(c) + h2osoi_ice(c,j) + h2osoi_liq(c,j)</div>
<div class="line"><a id="l02444" name="l02444"></a><span class="lineno"> 2444</span>          <span class="keywordflow">if</span> (j == nlevsoil) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02445" name="l02445"></a><span class="lineno"> 2445</span>             <span class="keywordflow">if</span> (abs(wsum(c)-wsum_end(c))&gt;1.e-7_kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02446" name="l02446"></a><span class="lineno"> 2446</span>                <span class="keyword">write</span>(message,*)<span class="stringliteral">&#39;Soil water balance error during phase change in ShalLakeTemperature.&#39;</span>, &amp;</div>
<div class="line"><a id="l02447" name="l02447"></a><span class="lineno"> 2447</span>                          <span class="stringliteral">&#39;column, error (kg/m^2):&#39;</span>, c, wsum_end(c)-wsum(c)</div>
<div class="line"><a id="l02448" name="l02448"></a><span class="lineno"> 2448</span>                errmsg=trim(message)</div>
<div class="line"><a id="l02449" name="l02449"></a><span class="lineno"> 2449</span>                errflg=1</div>
<div class="line"><a id="l02450" name="l02450"></a><span class="lineno"> 2450</span>                <span class="keywordflow">return</span></div>
<div class="line"><a id="l02451" name="l02451"></a><span class="lineno"> 2451</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02452" name="l02452"></a><span class="lineno"> 2452</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02453" name="l02453"></a><span class="lineno"> 2453</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02454" name="l02454"></a><span class="lineno"> 2454</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02455" name="l02455"></a><span class="lineno"> 2455</span> </div>
<div class="line"><a id="l02456" name="l02456"></a><span class="lineno"> 2456</span><span class="keywordflow">    endif</span> if_debug_balance</div>
<div class="line"><a id="l02457" name="l02457"></a><span class="lineno"> 2457</span> </div>
<div class="line"><a id="l02458" name="l02458"></a><span class="lineno"> 2458</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02459" name="l02459"></a><span class="lineno"> 2459</span>    <span class="comment">! 10!) Convective mixing: make sure fracice*dz is conserved, heat content c*dz*T is conserved, and</span></div>
<div class="line"><a id="l02460" name="l02460"></a><span class="lineno"> 2460</span>    <span class="comment">! all ice ends up at the top. Done over all lakes even if frozen.</span></div>
<div class="line"><a id="l02461" name="l02461"></a><span class="lineno"> 2461</span>    <span class="comment">! Either an unstable density profile or ice in a layer below an incompletely frozen layer will trigger.</span></div>
<div class="line"><a id="l02462" name="l02462"></a><span class="lineno"> 2462</span> </div>
<div class="line"><a id="l02463" name="l02463"></a><span class="lineno"> 2463</span>    <span class="comment">!Recalculate density</span></div>
<div class="line"><a id="l02464" name="l02464"></a><span class="lineno"> 2464</span>    <span class="keywordflow">do</span> j = 1, nlevlake</div>
<div class="line"><a id="l02465" name="l02465"></a><span class="lineno"> 2465</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02466" name="l02466"></a><span class="lineno"> 2466</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02467" name="l02467"></a><span class="lineno"> 2467</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02468" name="l02468"></a><span class="lineno"> 2468</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02469" name="l02469"></a><span class="lineno"> 2469</span>          rhow(c,j) = (1._kind_lake - lake_icefrac(c,j)) * &amp;</div>
<div class="line"><a id="l02470" name="l02470"></a><span class="lineno"> 2470</span>                      1000._kind_lake*( 1.0_kind_lake - 1.9549e-05_kind_lake*(abs(t_lake(c,j)-277._kind_lake))**1.68_kind_lake ) &amp;</div>
<div class="line"><a id="l02471" name="l02471"></a><span class="lineno"> 2471</span>                    + lake_icefrac(c,j)*denice</div>
<div class="line"><a id="l02472" name="l02472"></a><span class="lineno"> 2472</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02473" name="l02473"></a><span class="lineno"> 2473</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02474" name="l02474"></a><span class="lineno"> 2474</span> </div>
<div class="line"><a id="l02475" name="l02475"></a><span class="lineno"> 2475</span>    <span class="keywordflow">do</span> j = 1, nlevlake-1</div>
<div class="line"><a id="l02476" name="l02476"></a><span class="lineno"> 2476</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02477" name="l02477"></a><span class="lineno"> 2477</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02478" name="l02478"></a><span class="lineno"> 2478</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02479" name="l02479"></a><span class="lineno"> 2479</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02480" name="l02480"></a><span class="lineno"> 2480</span>          qav(c) = 0._kind_lake</div>
<div class="line"><a id="l02481" name="l02481"></a><span class="lineno"> 2481</span>          nav(c) = 0._kind_lake</div>
<div class="line"><a id="l02482" name="l02482"></a><span class="lineno"> 2482</span>          iceav(c) = 0._kind_lake</div>
<div class="line"><a id="l02483" name="l02483"></a><span class="lineno"> 2483</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02484" name="l02484"></a><span class="lineno"> 2484</span> </div>
<div class="line"><a id="l02485" name="l02485"></a><span class="lineno"> 2485</span>       <span class="keywordflow">do</span> i = 1, j+1</div>
<div class="line"><a id="l02486" name="l02486"></a><span class="lineno"> 2486</span>         <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02487" name="l02487"></a><span class="lineno"> 2487</span>         <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02488" name="l02488"></a><span class="lineno"> 2488</span>          <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02489" name="l02489"></a><span class="lineno"> 2489</span>             c = filter_shlakec(fc)</div>
<div class="line"><a id="l02490" name="l02490"></a><span class="lineno"> 2490</span>             <span class="keywordflow">if</span> (rhow(c,j) &gt; rhow(c,j+1) .or. &amp;</div>
<div class="line"><a id="l02491" name="l02491"></a><span class="lineno"> 2491</span>                (lake_icefrac(c,j) &lt; 1._kind_lake .and. lake_icefrac(c,j+1) &gt; 0._kind_lake) ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02492" name="l02492"></a><span class="lineno"> 2492</span>               <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02493" name="l02493"></a><span class="lineno"> 2493</span>                 <span class="keywordflow">if</span> (i==1)  <span class="keywordflow">then</span></div>
<div class="line"><a id="l02494" name="l02494"></a><span class="lineno"> 2494</span>                   print *, <span class="stringliteral">&#39;Convective Ice Mixing in column &#39;</span>, c, <span class="stringliteral">&#39;lake_icefrac(c,j) &#39;</span>,lake_icefrac(c,j),lake_icefrac(c,j+1)</div>
<div class="line"><a id="l02495" name="l02495"></a><span class="lineno"> 2495</span><span class="keywordflow">                 endif</span></div>
<div class="line"><a id="l02496" name="l02496"></a><span class="lineno"> 2496</span><span class="keywordflow">               endif</span></div>
<div class="line"><a id="l02497" name="l02497"></a><span class="lineno"> 2497</span>                qav(c) = qav(c) + dz_lake(c,i)*(t_lake(c,i)-tfrz) * &amp; </div>
<div class="line"><a id="l02498" name="l02498"></a><span class="lineno"> 2498</span>                        ((1._kind_lake - lake_icefrac(c,i))*cwat + lake_icefrac(c,i)*cice_eff)</div>
<div class="line"><a id="l02499" name="l02499"></a><span class="lineno"> 2499</span>                <span class="comment">!                tav(c) = tav(c) + t_lake(c,i)*dz_lake(c,i)</span></div>
<div class="line"><a id="l02500" name="l02500"></a><span class="lineno"> 2500</span>                iceav(c) = iceav(c) + lake_icefrac(c,i)*dz_lake(c,i)</div>
<div class="line"><a id="l02501" name="l02501"></a><span class="lineno"> 2501</span>                nav(c) = nav(c) + dz_lake(c,i)</div>
<div class="line"><a id="l02502" name="l02502"></a><span class="lineno"> 2502</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02503" name="l02503"></a><span class="lineno"> 2503</span><span class="keywordflow">          end do</span></div>
<div class="line"><a id="l02504" name="l02504"></a><span class="lineno"> 2504</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02505" name="l02505"></a><span class="lineno"> 2505</span> </div>
<div class="line"><a id="l02506" name="l02506"></a><span class="lineno"> 2506</span>       <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02507" name="l02507"></a><span class="lineno"> 2507</span>       <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02508" name="l02508"></a><span class="lineno"> 2508</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02509" name="l02509"></a><span class="lineno"> 2509</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02510" name="l02510"></a><span class="lineno"> 2510</span>          <span class="keywordflow">if</span> (rhow(c,j) &gt; rhow(c,j+1) .or. &amp;</div>
<div class="line"><a id="l02511" name="l02511"></a><span class="lineno"> 2511</span>             (lake_icefrac(c,j) &lt; 1._kind_lake .and. lake_icefrac(c,j+1) &gt; 0._kind_lake) ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02512" name="l02512"></a><span class="lineno"> 2512</span>             qav(c) = qav(c)/nav(c)</div>
<div class="line"><a id="l02513" name="l02513"></a><span class="lineno"> 2513</span>             iceav(c) = iceav(c)/nav(c)</div>
<div class="line"><a id="l02514" name="l02514"></a><span class="lineno"> 2514</span>             <span class="comment">!If the average temperature is above freezing, put the extra energy into the water.</span></div>
<div class="line"><a id="l02515" name="l02515"></a><span class="lineno"> 2515</span>             <span class="comment">!If it is below freezing, take it away from the ice.</span></div>
<div class="line"><a id="l02516" name="l02516"></a><span class="lineno"> 2516</span>             <span class="keywordflow">if</span> (qav(c) &gt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02517" name="l02517"></a><span class="lineno"> 2517</span>                tav_froz(c) = 0._kind_lake <span class="comment">!Celsius</span></div>
<div class="line"><a id="l02518" name="l02518"></a><span class="lineno"> 2518</span>                tav_unfr(c) = qav(c) / ((1._kind_lake - iceav(c))*cwat)</div>
<div class="line"><a id="l02519" name="l02519"></a><span class="lineno"> 2519</span>             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (qav(c) &lt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02520" name="l02520"></a><span class="lineno"> 2520</span>                tav_froz(c) = qav(c) / (iceav(c)*cice_eff)</div>
<div class="line"><a id="l02521" name="l02521"></a><span class="lineno"> 2521</span>                tav_unfr(c) = 0._kind_lake <span class="comment">!Celsius</span></div>
<div class="line"><a id="l02522" name="l02522"></a><span class="lineno"> 2522</span>             <span class="keywordflow">else</span></div>
<div class="line"><a id="l02523" name="l02523"></a><span class="lineno"> 2523</span>                tav_froz(c) = 0._kind_lake</div>
<div class="line"><a id="l02524" name="l02524"></a><span class="lineno"> 2524</span>                tav_unfr(c) = 0._kind_lake</div>
<div class="line"><a id="l02525" name="l02525"></a><span class="lineno"> 2525</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02526" name="l02526"></a><span class="lineno"> 2526</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02527" name="l02527"></a><span class="lineno"> 2527</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02528" name="l02528"></a><span class="lineno"> 2528</span> </div>
<div class="line"><a id="l02529" name="l02529"></a><span class="lineno"> 2529</span>       <span class="keywordflow">do</span> i = 1, j+1</div>
<div class="line"><a id="l02530" name="l02530"></a><span class="lineno"> 2530</span>         <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02531" name="l02531"></a><span class="lineno"> 2531</span>         <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02532" name="l02532"></a><span class="lineno"> 2532</span>          <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02533" name="l02533"></a><span class="lineno"> 2533</span>             c = filter_shlakec(fc)</div>
<div class="line"><a id="l02534" name="l02534"></a><span class="lineno"> 2534</span>             <span class="keywordflow">if</span> (nav(c) &gt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02535" name="l02535"></a><span class="lineno"> 2535</span>               <span class="comment">!             if(0==1) then</span></div>
<div class="line"><a id="l02536" name="l02536"></a><span class="lineno"> 2536</span> </div>
<div class="line"><a id="l02537" name="l02537"></a><span class="lineno"> 2537</span>                <span class="comment">!Put all the ice at the top.!</span></div>
<div class="line"><a id="l02538" name="l02538"></a><span class="lineno"> 2538</span>                <span class="comment">!If the average temperature is above freezing, put the extra energy into the water.</span></div>
<div class="line"><a id="l02539" name="l02539"></a><span class="lineno"> 2539</span>                <span class="comment">!If it is below freezing, take it away from the ice.</span></div>
<div class="line"><a id="l02540" name="l02540"></a><span class="lineno"> 2540</span>                <span class="comment">!For the layer with both ice &amp; water, be careful to use the average temperature</span></div>
<div class="line"><a id="l02541" name="l02541"></a><span class="lineno"> 2541</span>                <span class="comment">!that preserves the correct total heat content given what the heat capacity of that</span></div>
<div class="line"><a id="l02542" name="l02542"></a><span class="lineno"> 2542</span>                <span class="comment">!layer will actually be.</span></div>
<div class="line"><a id="l02543" name="l02543"></a><span class="lineno"> 2543</span>                <span class="keywordflow">if</span> (i == 1) zsum(c) = 0._kind_lake</div>
<div class="line"><a id="l02544" name="l02544"></a><span class="lineno"> 2544</span>                <span class="keywordflow">if</span> ((zsum(c)+dz_lake(c,i))/nav(c) &lt;= iceav(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02545" name="l02545"></a><span class="lineno"> 2545</span>                   t_lake(c,i) = tav_froz(c) + tfrz</div>
<div class="line"><a id="l02546" name="l02546"></a><span class="lineno"> 2546</span>                   <span class="comment">!tgs - 30jul19 - the next line is a bug and should be commented</span></div>
<div class="line"><a id="l02547" name="l02547"></a><span class="lineno"> 2547</span>                   <span class="comment">!out. This bug prevents lake ice form completely melting.</span></div>
<div class="line"><a id="l02548" name="l02548"></a><span class="lineno"> 2548</span>                   <span class="comment">!  lake_icefrac(c,i) = 1._kind_lake</span></div>
<div class="line"><a id="l02549" name="l02549"></a><span class="lineno"> 2549</span>                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zsum(c)/nav(c) &lt; iceav(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02550" name="l02550"></a><span class="lineno"> 2550</span>                   <span class="comment">!tgs - change ice fraction</span></div>
<div class="line"><a id="l02551" name="l02551"></a><span class="lineno"> 2551</span>                   lake_icefrac(c,i) = (iceav(c)*nav(c) - zsum(c)) / dz_lake(c,i)</div>
<div class="line"><a id="l02552" name="l02552"></a><span class="lineno"> 2552</span>                   <span class="comment">! Find average value that preserves correct heat content.</span></div>
<div class="line"><a id="l02553" name="l02553"></a><span class="lineno"> 2553</span>                   t_lake(c,i) = ( lake_icefrac(c,i)*tav_froz(c)*cice_eff &amp;</div>
<div class="line"><a id="l02554" name="l02554"></a><span class="lineno"> 2554</span>                               + (1._kind_lake - lake_icefrac(c,i))*tav_unfr(c)*cwat ) &amp;</div>
<div class="line"><a id="l02555" name="l02555"></a><span class="lineno"> 2555</span>                               / ( lake_icefrac(c,i)*cice_eff + (1-lake_icefrac(c,i))*cwat ) + tfrz</div>
<div class="line"><a id="l02556" name="l02556"></a><span class="lineno"> 2556</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l02557" name="l02557"></a><span class="lineno"> 2557</span>                   <span class="comment">!tgs - remove ice</span></div>
<div class="line"><a id="l02558" name="l02558"></a><span class="lineno"> 2558</span>                   lake_icefrac(c,i) = 0._kind_lake</div>
<div class="line"><a id="l02559" name="l02559"></a><span class="lineno"> 2559</span>                   t_lake(c,i) = tav_unfr(c) + tfrz</div>
<div class="line"><a id="l02560" name="l02560"></a><span class="lineno"> 2560</span><span class="keywordflow">                end if</span></div>
<div class="line"><a id="l02561" name="l02561"></a><span class="lineno"> 2561</span>                zsum(c) = zsum(c) + dz_lake(c,i)</div>
<div class="line"><a id="l02562" name="l02562"></a><span class="lineno"> 2562</span> </div>
<div class="line"><a id="l02563" name="l02563"></a><span class="lineno"> 2563</span>                rhow(c,i) = (1._kind_lake - lake_icefrac(c,i)) * &amp; </div>
<div class="line"><a id="l02564" name="l02564"></a><span class="lineno"> 2564</span>                            1000._kind_lake*( 1.0_kind_lake - 1.9549e-05_kind_lake*(abs(t_lake(c,i)-277._kind_lake))**1.68_kind_lake ) &amp;</div>
<div class="line"><a id="l02565" name="l02565"></a><span class="lineno"> 2565</span>                          + lake_icefrac(c,i)*denice</div>
<div class="line"><a id="l02566" name="l02566"></a><span class="lineno"> 2566</span>                <span class="keywordflow">if</span> (debug_print .and. lake_icefrac(c,j) &gt; 0.)print *,<span class="stringliteral">&#39;rhow(c,i),lake_icefrac(c,i),t_lake(c,i)&#39;</span>,  &amp;</div>
<div class="line"><a id="l02567" name="l02567"></a><span class="lineno"> 2567</span>                                                                    i,rhow(c,i),lake_icefrac(c,i),t_lake(c,i),denice</div>
<div class="line"><a id="l02568" name="l02568"></a><span class="lineno"> 2568</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02569" name="l02569"></a><span class="lineno"> 2569</span><span class="keywordflow">          end do</span></div>
<div class="line"><a id="l02570" name="l02570"></a><span class="lineno"> 2570</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02571" name="l02571"></a><span class="lineno"> 2571</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02572" name="l02572"></a><span class="lineno"> 2572</span> </div>
<div class="line"><a id="l02573" name="l02573"></a><span class="lineno"> 2573</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02574" name="l02574"></a><span class="lineno"> 2574</span>    <span class="comment">! 11!) Re-evaluate thermal properties and sum energy content.</span></div>
<div class="line"><a id="l02575" name="l02575"></a><span class="lineno"> 2575</span>    <span class="comment">! For lake</span></div>
<div class="line"><a id="l02576" name="l02576"></a><span class="lineno"> 2576</span>    <span class="keywordflow">do</span> j = 1, nlevlake</div>
<div class="line"><a id="l02577" name="l02577"></a><span class="lineno"> 2577</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02578" name="l02578"></a><span class="lineno"> 2578</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02579" name="l02579"></a><span class="lineno"> 2579</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02580" name="l02580"></a><span class="lineno"> 2580</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02581" name="l02581"></a><span class="lineno"> 2581</span> </div>
<div class="line"><a id="l02582" name="l02582"></a><span class="lineno"> 2582</span>          cv_lake(c,j) = dz_lake(c,j) * (cwat*(1._kind_lake-lake_icefrac(c,j)) + cice_eff*lake_icefrac(c,j))</div>
<div class="line"><a id="l02583" name="l02583"></a><span class="lineno"> 2583</span>          <span class="keywordflow">if</span> (debug_print .and. lake_icefrac(c,j) &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02584" name="l02584"></a><span class="lineno"> 2584</span>            print *,<span class="stringliteral">&#39;Lake Ice Fraction, c, level:&#39;</span>, c, j, lake_icefrac(c,j)</div>
<div class="line"><a id="l02585" name="l02585"></a><span class="lineno"> 2585</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l02586" name="l02586"></a><span class="lineno"> 2586</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02587" name="l02587"></a><span class="lineno"> 2587</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02588" name="l02588"></a><span class="lineno"> 2588</span>    <span class="comment">! For snow / soil</span></div>
<div class="line"><a id="l02589" name="l02589"></a><span class="lineno"> 2589</span>  <span class="comment">!  call SoilThermProp_Lake(lbc, ubc, num_shlakec, filter_shlakec, tk, cv, tktopsoillay)</span></div>
<div class="line"><a id="l02590" name="l02590"></a><span class="lineno"> 2590</span>  <span class="keyword">call </span>soilthermprop_lake (snl,dz,zi,z,t_soisno,h2osoi_liq,h2osoi_ice,    &amp;</div>
<div class="line"><a id="l02591" name="l02591"></a><span class="lineno"> 2591</span>       watsat, tksatu, tkmg, tkdry, csol, tk, cv, tktopsoillay,errmsg,errflg)</div>
<div class="line"><a id="l02592" name="l02592"></a><span class="lineno"> 2592</span> </div>
<div class="line"><a id="l02593" name="l02593"></a><span class="lineno"> 2593</span> </div>
<div class="line"><a id="l02594" name="l02594"></a><span class="lineno"> 2594</span>    <span class="comment">! Do as above to sum energy content</span></div>
<div class="line"><a id="l02595" name="l02595"></a><span class="lineno"> 2595</span>    <span class="keywordflow">do</span> j = 1, nlevlake</div>
<div class="line"><a id="l02596" name="l02596"></a><span class="lineno"> 2596</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02597" name="l02597"></a><span class="lineno"> 2597</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02598" name="l02598"></a><span class="lineno"> 2598</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02599" name="l02599"></a><span class="lineno"> 2599</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02600" name="l02600"></a><span class="lineno"> 2600</span> </div>
<div class="line"><a id="l02601" name="l02601"></a><span class="lineno"> 2601</span>          <span class="comment">!          ncvts(c) = ncvts(c) + cv_lake(c,j)*t_lake(c,j) &amp;</span></div>
<div class="line"><a id="l02602" name="l02602"></a><span class="lineno"> 2602</span>          ncvts(c) = ncvts(c) + cv_lake(c,j)*(t_lake(c,j)-tfrz) &amp;</div>
<div class="line"><a id="l02603" name="l02603"></a><span class="lineno"> 2603</span>                   + cfus*dz_lake(c,j)*(1._kind_lake-lake_icefrac(c,j)) <span class="comment">!&amp;</span></div>
<div class="line"><a id="l02604" name="l02604"></a><span class="lineno"> 2604</span>          <span class="comment">!                   + (cwat-cice_eff)*lake_icefrac(c)*tfrz*dz_lake(c,j) !enthalpy reconciliation term</span></div>
<div class="line"><a id="l02605" name="l02605"></a><span class="lineno"> 2605</span>          fin(c) = fin(c) + phi(c,j)</div>
<div class="line"><a id="l02606" name="l02606"></a><span class="lineno"> 2606</span>         <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02607" name="l02607"></a><span class="lineno"> 2607</span>           <span class="keywordflow">if</span> (abs(xlat_d-52.1152).lt.0.1 .and.     &amp;</div>
<div class="line"><a id="l02608" name="l02608"></a><span class="lineno"> 2608</span>               abs(xlon_d-260.405).lt.0.1)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02609" name="l02609"></a><span class="lineno"> 2609</span>             print *,<span class="stringliteral">&#39; ncvts(c) at  xlat_d,xlon_d&#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l02610" name="l02610"></a><span class="lineno"> 2610</span>             print *,<span class="stringliteral">&#39; new cv_lake(c,j),t_lake(c,j),cfus,lake_icefrac(c,j),ncvts(c),fin(c)&#39;</span>, &amp;</div>
<div class="line"><a id="l02611" name="l02611"></a><span class="lineno"> 2611</span>                         j,cv_lake(c,j),t_lake(c,j),cfus,lake_icefrac(c,j),ncvts(c),fin(c)</div>
<div class="line"><a id="l02612" name="l02612"></a><span class="lineno"> 2612</span>             print *,<span class="stringliteral">&#39; new dz_lake(c,j),fin(c),phi(c,j)&#39;</span>,c,dz_lake(c,j),fin(c),phi(c,j)</div>
<div class="line"><a id="l02613" name="l02613"></a><span class="lineno"> 2613</span><span class="keywordflow">           endif</span></div>
<div class="line"><a id="l02614" name="l02614"></a><span class="lineno"> 2614</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l02615" name="l02615"></a><span class="lineno"> 2615</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02616" name="l02616"></a><span class="lineno"> 2616</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02617" name="l02617"></a><span class="lineno"> 2617</span> </div>
<div class="line"><a id="l02618" name="l02618"></a><span class="lineno"> 2618</span>    <span class="keywordflow">do</span> j = -nlevsnow + 1, nlevsoil</div>
<div class="line"><a id="l02619" name="l02619"></a><span class="lineno"> 2619</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02620" name="l02620"></a><span class="lineno"> 2620</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02621" name="l02621"></a><span class="lineno"> 2621</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02622" name="l02622"></a><span class="lineno"> 2622</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02623" name="l02623"></a><span class="lineno"> 2623</span> </div>
<div class="line"><a id="l02624" name="l02624"></a><span class="lineno"> 2624</span>          <span class="keywordflow">if</span> (j &gt;= jtop(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02625" name="l02625"></a><span class="lineno"> 2625</span>            <span class="comment">!             ncvts(c) = ncvts(c) + cv(c,j)*t_soisno(c,j) &amp;</span></div>
<div class="line"><a id="l02626" name="l02626"></a><span class="lineno"> 2626</span>             ncvts(c) = ncvts(c) + cv(c,j)*(t_soisno(c,j)-tfrz) &amp;</div>
<div class="line"><a id="l02627" name="l02627"></a><span class="lineno"> 2627</span>                      + hfus*h2osoi_liq(c,j) <span class="comment">!&amp;</span></div>
<div class="line"><a id="l02628" name="l02628"></a><span class="lineno"> 2628</span>             <span class="comment">!                      + (cpliq-cpice)*h2osoi_ice(c,j)*tfrz !enthalpy reconciliation term</span></div>
<div class="line"><a id="l02629" name="l02629"></a><span class="lineno"> 2629</span>          <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02630" name="l02630"></a><span class="lineno"> 2630</span>            <span class="keywordflow">if</span> (abs(xlat_d-52.1152).lt.0.1 .and.     &amp;</div>
<div class="line"><a id="l02631" name="l02631"></a><span class="lineno"> 2631</span>                abs(xlon_d-260.405).lt.0.1)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02632" name="l02632"></a><span class="lineno"> 2632</span>              print *,<span class="stringliteral">&#39; ncvts(c) at xlat_d,xlon_d&#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l02633" name="l02633"></a><span class="lineno"> 2633</span>              print *,<span class="stringliteral">&#39;new j,jtop(c)&#39;</span>,j,jtop(c),<span class="stringliteral">&#39;h2osoi_liq(c,j) &#39;</span>,h2osoi_liq(c,j),<span class="stringliteral">&#39;h2osoi_ice(c,j)&#39;</span>,h2osoi_ice(c,j)</div>
<div class="line"><a id="l02634" name="l02634"></a><span class="lineno"> 2634</span>              print *,<span class="stringliteral">&#39;new cv(c,j),t_soisno(c,j),hfus,ncvts(c)&#39;</span>,c,j,cv(c,j),t_soisno(c,j),hfus,ncvts(c)</div>
<div class="line"><a id="l02635" name="l02635"></a><span class="lineno"> 2635</span>              print *,<span class="stringliteral">&#39;new h2osno(c)&#39;</span>,h2osno(c)</div>
<div class="line"><a id="l02636" name="l02636"></a><span class="lineno"> 2636</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l02637" name="l02637"></a><span class="lineno"> 2637</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l02638" name="l02638"></a><span class="lineno"> 2638</span>             <span class="keywordflow">if</span> (j == 1 .and. h2osno(c) &gt; 0._kind_lake .and. j == jtop(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02639" name="l02639"></a><span class="lineno"> 2639</span>                ncvts(c) = ncvts(c) - h2osno(c)*hfus</div>
<div class="line"><a id="l02640" name="l02640"></a><span class="lineno"> 2640</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l02641" name="l02641"></a><span class="lineno"> 2641</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02642" name="l02642"></a><span class="lineno"> 2642</span>          <span class="keywordflow">if</span> (j == 1) fin(c) = fin(c) + phi_soil(c)</div>
<div class="line"><a id="l02643" name="l02643"></a><span class="lineno"> 2643</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02644" name="l02644"></a><span class="lineno"> 2644</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02645" name="l02645"></a><span class="lineno"> 2645</span> </div>
<div class="line"><a id="l02646" name="l02646"></a><span class="lineno"> 2646</span> </div>
<div class="line"><a id="l02647" name="l02647"></a><span class="lineno"> 2647</span>    <span class="comment">! Check energy conservation.</span></div>
<div class="line"><a id="l02648" name="l02648"></a><span class="lineno"> 2648</span> </div>
<div class="line"><a id="l02649" name="l02649"></a><span class="lineno"> 2649</span>    <span class="keywordflow">do</span> fp = 1, num_shlakep</div>
<div class="line"><a id="l02650" name="l02650"></a><span class="lineno"> 2650</span>       p = filter_shlakep(fp)</div>
<div class="line"><a id="l02651" name="l02651"></a><span class="lineno"> 2651</span>       c = pcolumn(p)</div>
<div class="line"><a id="l02652" name="l02652"></a><span class="lineno"> 2652</span>       errsoi(c) = (ncvts(c)-ocvts(c)) / dtime - fin(c)</div>
<div class="line"><a id="l02653" name="l02653"></a><span class="lineno"> 2653</span>      <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02654" name="l02654"></a><span class="lineno"> 2654</span>        <span class="keywordflow">if</span> (abs(xlat_d-52.1152).lt.0.1 .and.     &amp;</div>
<div class="line"><a id="l02655" name="l02655"></a><span class="lineno"> 2655</span>            abs(xlon_d-260.405).lt.0.1)<span class="keywordflow">then</span></div>
<div class="line"><a id="l02656" name="l02656"></a><span class="lineno"> 2656</span>          print *,<span class="stringliteral">&#39;xlat_d,xlon_d&#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l02657" name="l02657"></a><span class="lineno"> 2657</span>          print *,<span class="stringliteral">&#39;errsoi(c),fin(c),ncvts(c),ocvts(c),dtime,lake_icefrac(c,:),h2osno(c)&#39;</span>, &amp;</div>
<div class="line"><a id="l02658" name="l02658"></a><span class="lineno"> 2658</span>                   errsoi(c),fin(c),ncvts(c),ocvts(c),dtime,lake_icefrac(c,:),h2osno(c)</div>
<div class="line"><a id="l02659" name="l02659"></a><span class="lineno"> 2659</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l02660" name="l02660"></a><span class="lineno"> 2660</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l02661" name="l02661"></a><span class="lineno"> 2661</span>      <span class="keywordflow">if</span>( .not.lakedebug ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02662" name="l02662"></a><span class="lineno"> 2662</span>       <span class="keywordflow">if</span> (abs(errsoi(c)) &lt; 10._kind_lake)  <span class="keywordflow">then</span></div>
<div class="line"><a id="l02663" name="l02663"></a><span class="lineno"> 2663</span>          eflx_sh_tot(p) = eflx_sh_tot(p) - errsoi(c)</div>
<div class="line"><a id="l02664" name="l02664"></a><span class="lineno"> 2664</span>          eflx_sh_grnd(p) = eflx_sh_grnd(p) - errsoi(c)</div>
<div class="line"><a id="l02665" name="l02665"></a><span class="lineno"> 2665</span>          eflx_soil_grnd(p) = eflx_soil_grnd(p) + errsoi(c)</div>
<div class="line"><a id="l02666" name="l02666"></a><span class="lineno"> 2666</span>          eflx_gnet(p) = eflx_gnet(p) + errsoi(c)</div>
<div class="line"><a id="l02667" name="l02667"></a><span class="lineno"> 2667</span>          <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02668" name="l02668"></a><span class="lineno"> 2668</span>            <span class="keywordflow">if</span> (abs(errsoi(c)) &gt; 1.e-1_kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02669" name="l02669"></a><span class="lineno"> 2669</span>              print *,<span class="stringliteral">&#39;errsoi incorporated at xlat_d,xlon_d&#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l02670" name="l02670"></a><span class="lineno"> 2670</span>              print *,<span class="stringliteral">&#39;errsoi incorporated into sensible heat in ShalLakeTemperature: c, (W/m^2):&#39;</span>, c, errsoi(c)</div>
<div class="line"><a id="l02671" name="l02671"></a><span class="lineno"> 2671</span><span class="keywordflow">            end if</span></div>
<div class="line"><a id="l02672" name="l02672"></a><span class="lineno"> 2672</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l02673" name="l02673"></a><span class="lineno"> 2673</span>          errsoi(c) = 0._kind_lake</div>
<div class="line"><a id="l02674" name="l02674"></a><span class="lineno"> 2674</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l02675" name="l02675"></a><span class="lineno"> 2675</span>      <span class="keywordflow">elseif</span> ( lakedebug) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02676" name="l02676"></a><span class="lineno"> 2676</span>        <span class="keywordflow">if</span> (abs(errsoi(c)) &lt; 1._kind_lake)  <span class="keywordflow">then</span></div>
<div class="line"><a id="l02677" name="l02677"></a><span class="lineno"> 2677</span>          eflx_sh_tot(p) = eflx_sh_tot(p) - errsoi(c)</div>
<div class="line"><a id="l02678" name="l02678"></a><span class="lineno"> 2678</span>          eflx_sh_grnd(p) = eflx_sh_grnd(p) - errsoi(c)</div>
<div class="line"><a id="l02679" name="l02679"></a><span class="lineno"> 2679</span>          eflx_soil_grnd(p) = eflx_soil_grnd(p) + errsoi(c)</div>
<div class="line"><a id="l02680" name="l02680"></a><span class="lineno"> 2680</span>          eflx_gnet(p) = eflx_gnet(p) + errsoi(c)</div>
<div class="line"><a id="l02681" name="l02681"></a><span class="lineno"> 2681</span>          <span class="keywordflow">if</span> (abs(errsoi(c)) &gt; 1.e-1_kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02682" name="l02682"></a><span class="lineno"> 2682</span>             print *,<span class="stringliteral">&#39;errsoi incorporated into sensible heat in ShalLakeTemperature: c, (W/m^2):&#39;</span>, c, errsoi(c)</div>
<div class="line"><a id="l02683" name="l02683"></a><span class="lineno"> 2683</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02684" name="l02684"></a><span class="lineno"> 2684</span>          errsoi(c) = 0._kind_lake</div>
<div class="line"><a id="l02685" name="l02685"></a><span class="lineno"> 2685</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l02686" name="l02686"></a><span class="lineno"> 2686</span>          print *,<span class="stringliteral">&#39;Soil Energy Balance Error at column, &#39;</span>, c, <span class="stringliteral">&#39;G, fintotal, column E tendency = &#39;</span>, &amp;</div>
<div class="line"><a id="l02687" name="l02687"></a><span class="lineno"> 2687</span>             eflx_gnet(p), fin(c), (ncvts(c)-ocvts(c)) / dtime,<span class="stringliteral">&#39;xlat_d,xlon_d&#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l02688" name="l02688"></a><span class="lineno"> 2688</span>          print *,<span class="stringliteral">&#39;errsoi(c),ncvts(c),ocvts(c)&#39;</span>,errsoi(c),ncvts(c),ocvts(c),<span class="stringliteral">&#39;xlat_d,xlon_d&#39;</span>,xlat_d,xlon_d</div>
<div class="line"><a id="l02689" name="l02689"></a><span class="lineno"> 2689</span>          print *,<span class="stringliteral">&#39;lake_icefrac(c,:),h2osno(c)&#39;</span>, lake_icefrac(c,:),h2osno(c)</div>
<div class="line"><a id="l02690" name="l02690"></a><span class="lineno"> 2690</span>          print *,<span class="stringliteral">&#39;t_lake(c,:),t_soisno(c,:)&#39;</span>,t_lake(c,:),t_soisno(c,:)</div>
<div class="line"><a id="l02691" name="l02691"></a><span class="lineno"> 2691</span><span class="keywordflow">        end if</span></div>
<div class="line"><a id="l02692" name="l02692"></a><span class="lineno"> 2692</span><span class="keywordflow">      end if</span> <span class="comment">! LAKEDEBUG</span></div>
<div class="line"><a id="l02693" name="l02693"></a><span class="lineno"> 2693</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02694" name="l02694"></a><span class="lineno"> 2694</span>    <span class="comment">! This loop assumes only one point per column.</span></div>
<div class="line"><a id="l02695" name="l02695"></a><span class="lineno"> 2695</span> </div>
</div>
<div class="line"><a id="l02696" name="l02696"></a><span class="lineno"> 2696</span>  <span class="keyword">end subroutine </span>shallaketemperature</div>
<div class="line"><a id="l02697" name="l02697"></a><span class="lineno"> 2697</span> </div>
<div class="line"><a id="l02698" name="l02698"></a><span class="lineno"> 2698</span>  <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02699" name="l02699"></a><span class="lineno"> 2699</span>  <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02700" name="l02700"></a><span class="lineno"> 2700</span>  <span class="comment">!BOP</span></div>
<div class="line"><a id="l02701" name="l02701"></a><span class="lineno"> 2701</span>  <span class="comment">!</span></div>
<div class="line"><a id="l02702" name="l02702"></a><span class="lineno"> 2702</span>  <span class="comment">! ROUTINE: SoilThermProp_Lake</span></div>
<div class="line"><a id="l02703" name="l02703"></a><span class="lineno"> 2703</span>  <span class="comment">!</span></div>
<div class="line"><a id="l02704" name="l02704"></a><span class="lineno"> 2704</span>  <span class="comment">! INTERFACE:</span></div>
<div class="line"><a id="l02705" name="l02705"></a><span class="lineno"> 2705</span>    <span class="comment">! DESCRIPTION:  </span><span class="comment"></span></div>
<div class="line"><a id="l02706" name="l02706"></a><span class="lineno"> 2706</span><span class="comment">    !&gt; Calculation of thermal conductivities and heat capacities of</span></div>
<div class="line"><a id="l02707" name="l02707"></a><span class="lineno"> 2707</span><span class="comment">    !! snow/soil layers</span></div>
<div class="line"><a id="l02708" name="l02708"></a><span class="lineno"> 2708</span><span class="comment">    !!\n (1) The volumetric heat capacity is calculated as a linear combination</span></div>
<div class="line"><a id="l02709" name="l02709"></a><span class="lineno"> 2709</span><span class="comment">    !!     in terms of the volumetric fraction of the constituent phases.</span></div>
<div class="line"><a id="l02710" name="l02710"></a><span class="lineno"> 2710</span><span class="comment">    !!    </span></div>
<div class="line"><a id="l02711" name="l02711"></a><span class="lineno"> 2711</span><span class="comment">    !!\n (2) The thermal conductivity of soil is computed from the algorithm of</span></div>
<div class="line"><a id="l02712" name="l02712"></a><span class="lineno"> 2712</span><span class="comment">    !!     Johansen (as reported by Farouki 1981), and of snow is from the</span></div>
<div class="line"><a id="l02713" name="l02713"></a><span class="lineno"> 2713</span><span class="comment">    !!     formulation used in SNTHERM (Jordan 1991).</span></div>
<div class="line"><a id="l02714" name="l02714"></a><span class="lineno"> 2714</span><span class="comment">    !! The thermal conductivities at the interfaces between two neighboring</span></div>
<div class="line"><a id="l02715" name="l02715"></a><span class="lineno"> 2715</span><span class="comment">    !! layers (j, j+1) are derived from an assumption that the flux across</span></div>
<div class="line"><a id="l02716" name="l02716"></a><span class="lineno"> 2716</span><span class="comment">    !! the interface is equal to that from the node j to the interface and the</span></div>
<div class="line"><a id="l02717" name="l02717"></a><span class="lineno"> 2717</span><span class="comment">    !! flux from the interface to the node j+1.</span></div>
<div class="line"><a id="l02718" name="l02718"></a><span class="lineno"> 2718</span><span class="comment">    !!</span></div>
<div class="line"><a id="l02719" name="l02719"></a><span class="lineno"> 2719</span><span class="comment">    !! For lakes, the proper soil layers (not snow) should always be saturated.</span></div>
<div class="foldopen" id="foldopen02720" data-start="" data-end="">
<div class="line"><a id="l02720" name="l02720"></a><span class="lineno"><a class="line" href="namespaceclm__lake_af23692ae185eeb3cde51c989c4f4cc2f.html#af23692ae185eeb3cde51c989c4f4cc2f"> 2720</a></span>  <span class="keyword">subroutine </span>soilthermprop_lake (snl,dz,zi,z,t_soisno,h2osoi_liq,h2osoi_ice,    &amp;</div>
<div class="line"><a id="l02721" name="l02721"></a><span class="lineno"> 2721</span>       watsat, tksatu, tkmg, tkdry, csol, tk, cv, tktopsoillay,errmsg,errflg)</div>
<div class="line"><a id="l02722" name="l02722"></a><span class="lineno"> 2722</span> </div>
<div class="line"><a id="l02723" name="l02723"></a><span class="lineno"> 2723</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02724" name="l02724"></a><span class="lineno"> 2724</span>    <span class="comment">!in</span></div>
<div class="line"><a id="l02725" name="l02725"></a><span class="lineno"> 2725</span> </div>
<div class="line"><a id="l02726" name="l02726"></a><span class="lineno"> 2726</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: errflg                       </div>
<div class="line"><a id="l02727" name="l02727"></a><span class="lineno"> 2727</span>    <span class="keywordtype">character(*)</span>, <span class="keywordtype">intent(inout)</span> :: errmsg                  </div>
<div class="line"><a id="l02728" name="l02728"></a><span class="lineno"> 2728</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span> :: snl(1)<span class="comment">                         !&lt; number of snow layers</span></div>
<div class="line"><a id="l02729" name="l02729"></a><span class="lineno"> 2729</span>    <span class="comment">!    real(kind_lake), intent(in) :: h2osno(1)          !&lt; snow water (mm H2O)</span></div>
<div class="line"><a id="l02730" name="l02730"></a><span class="lineno"> 2730</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: watsat(1,nlevsoil)<span class="comment">      !&lt; volumetric soil water at saturation (porosity)</span></div>
<div class="line"><a id="l02731" name="l02731"></a><span class="lineno"> 2731</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: tksatu(1,nlevsoil)<span class="comment">      !&lt; thermal conductivity, saturated soil [W/m-K]</span></div>
<div class="line"><a id="l02732" name="l02732"></a><span class="lineno"> 2732</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: tkmg(1,nlevsoil)<span class="comment">        !&lt; thermal conductivity, soil minerals  [W/m-K]</span></div>
<div class="line"><a id="l02733" name="l02733"></a><span class="lineno"> 2733</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: tkdry(1,nlevsoil)<span class="comment">       !&lt; thermal conductivity, dry soil (W/m/Kelvin)</span></div>
<div class="line"><a id="l02734" name="l02734"></a><span class="lineno"> 2734</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: csol(1,nlevsoil)<span class="comment">        !&lt; heat capacity, soil solids (J/m**3/Kelvin)</span></div>
<div class="line"><a id="l02735" name="l02735"></a><span class="lineno"> 2735</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: dz(1,-nlevsnow+1:nlevsoil)<span class="comment">          !&lt; layer thickness (m)</span></div>
<div class="line"><a id="l02736" name="l02736"></a><span class="lineno"> 2736</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: zi(1,-nlevsnow+0:nlevsoil)<span class="comment">          !&lt; interface level below a &quot;z&quot; level (m)</span></div>
<div class="line"><a id="l02737" name="l02737"></a><span class="lineno"> 2737</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: z(1,-nlevsnow+1:nlevsoil)<span class="comment">           !&lt; layer depth (m)</span></div>
<div class="line"><a id="l02738" name="l02738"></a><span class="lineno"> 2738</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: t_soisno(1,-nlevsnow+1:nlevsoil)<span class="comment">    !&lt; soil temperature (Kelvin)</span></div>
<div class="line"><a id="l02739" name="l02739"></a><span class="lineno"> 2739</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: h2osoi_liq(1,-nlevsnow+1:nlevsoil)<span class="comment">  !&lt; liquid water (kg/m2)</span></div>
<div class="line"><a id="l02740" name="l02740"></a><span class="lineno"> 2740</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: h2osoi_ice(1,-nlevsnow+1:nlevsoil)<span class="comment">  !&lt; ice lens (kg/m2)</span></div>
<div class="line"><a id="l02741" name="l02741"></a><span class="lineno"> 2741</span> </div>
<div class="line"><a id="l02742" name="l02742"></a><span class="lineno"> 2742</span>    <span class="comment">!out</span></div>
<div class="line"><a id="l02743" name="l02743"></a><span class="lineno"> 2743</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: cv(lbc:ubc,-nlevsnow+1:nlevsoil)<span class="comment"> !&lt; heat capacity [J/(m2 K)]</span></div>
<div class="line"><a id="l02744" name="l02744"></a><span class="lineno"> 2744</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: tk(lbc:ubc,-nlevsnow+1:nlevsoil)<span class="comment"> !&lt; thermal conductivity [W/(m K)]</span></div>
<div class="line"><a id="l02745" name="l02745"></a><span class="lineno"> 2745</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: tktopsoillay(lbc:ubc)<span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><span class="comment">            !&lt; thermal conductivity [W/(m K)]</span></div>
<div class="line"><a id="l02746" name="l02746"></a><span class="lineno"> 2746</span><span class="comment">    !!</span></div>
<div class="line"><a id="l02747" name="l02747"></a><span class="lineno"> 2747</span>    <span class="comment">! !CALLED FROM:</span></div>
<div class="line"><a id="l02748" name="l02748"></a><span class="lineno"> 2748</span>    <span class="comment">! subroutine ShalLakeTemperature in this module.</span></div>
<div class="line"><a id="l02749" name="l02749"></a><span class="lineno"> 2749</span>    <span class="comment">!</span></div>
<div class="line"><a id="l02750" name="l02750"></a><span class="lineno"> 2750</span>    <span class="comment">! !REVISION HISTORY:</span></div>
<div class="line"><a id="l02751" name="l02751"></a><span class="lineno"> 2751</span>    <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l02752" name="l02752"></a><span class="lineno"> 2752</span>    <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l02753" name="l02753"></a><span class="lineno"> 2753</span>    <span class="comment">! 2/13/02, Peter Thornton: migrated to new data structures</span></div>
<div class="line"><a id="l02754" name="l02754"></a><span class="lineno"> 2754</span>    <span class="comment">! 7/01/03, Mariana Vertenstein: migrated to vector code</span></div>
<div class="line"><a id="l02755" name="l02755"></a><span class="lineno"> 2755</span>    <span class="comment">! 4/09, Zack Subin, adjustment for ShalLake code.</span></div>
<div class="line"><a id="l02756" name="l02756"></a><span class="lineno"> 2756</span>    <span class="comment">! June 2022, Sam Trahan updated for CCPP</span></div>
<div class="line"><a id="l02757" name="l02757"></a><span class="lineno"> 2757</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l02758" name="l02758"></a><span class="lineno"> 2758</span>    <span class="comment">! !LOCAL VARIABLES:</span></div>
<div class="line"><a id="l02759" name="l02759"></a><span class="lineno"> 2759</span>    <span class="comment">!</span></div>
<div class="line"><a id="l02760" name="l02760"></a><span class="lineno"> 2760</span>    <span class="comment">! local pointers to original implicit in scalars</span></div>
<div class="line"><a id="l02761" name="l02761"></a><span class="lineno"> 2761</span>    <span class="comment">!</span></div>
<div class="line"><a id="l02762" name="l02762"></a><span class="lineno"> 2762</span>    <span class="comment">!    integer , pointer :: clandunit(:)     ! column&#39;s landunit</span></div>
<div class="line"><a id="l02763" name="l02763"></a><span class="lineno"> 2763</span>    <span class="comment">!    integer , pointer :: ityplun(:)       ! landunit type</span></div>
<div class="line"><a id="l02764" name="l02764"></a><span class="lineno"> 2764</span>    <span class="comment">!</span></div>
<div class="line"><a id="l02765" name="l02765"></a><span class="lineno"> 2765</span>    <span class="comment">!EOP</span></div>
<div class="line"><a id="l02766" name="l02766"></a><span class="lineno"> 2766</span>    </div>
<div class="line"><a id="l02767" name="l02767"></a><span class="lineno"> 2767</span>    </div>
<div class="line"><a id="l02768" name="l02768"></a><span class="lineno"> 2768</span>    <span class="comment">! OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l02769" name="l02769"></a><span class="lineno"> 2769</span>    </div>
<div class="line"><a id="l02770" name="l02770"></a><span class="lineno"> 2770</span>    <span class="keywordtype">integer</span>  :: l,c,j                     <span class="comment">! indices</span></div>
<div class="line"><a id="l02771" name="l02771"></a><span class="lineno"> 2771</span>    <span class="keywordtype">integer</span>  :: fc                        <span class="comment">! lake filtered column indices</span></div>
<div class="line"><a id="l02772" name="l02772"></a><span class="lineno"> 2772</span><span class="keywordtype">    real</span>(kind_lake) :: bw                        <span class="comment">! partial density of water (ice + liquid)</span></div>
<div class="line"><a id="l02773" name="l02773"></a><span class="lineno"> 2773</span><span class="keywordtype">    real</span>(kind_lake) :: dksat                     <span class="comment">! thermal conductivity for saturated soil (j/(k s m))</span></div>
<div class="line"><a id="l02774" name="l02774"></a><span class="lineno"> 2774</span><span class="keywordtype">    real</span>(kind_lake) :: dke                       <span class="comment">! kersten number</span></div>
<div class="line"><a id="l02775" name="l02775"></a><span class="lineno"> 2775</span><span class="keywordtype">    real</span>(kind_lake) :: fl                        <span class="comment">! fraction of liquid or unfrozen water to total water</span></div>
<div class="line"><a id="l02776" name="l02776"></a><span class="lineno"> 2776</span><span class="keywordtype">    real</span>(kind_lake) :: satw                      <span class="comment">! relative total water content of soil.</span></div>
<div class="line"><a id="l02777" name="l02777"></a><span class="lineno"> 2777</span><span class="keywordtype">    real</span>(kind_lake) :: thk(lbc:ubc,-nlevsnow+1:nlevsoil) <span class="comment">! thermal conductivity of layer</span></div>
<div class="line"><a id="l02778" name="l02778"></a><span class="lineno"> 2778</span>    <span class="keywordtype">character*256</span> :: message </div>
<div class="line"><a id="l02779" name="l02779"></a><span class="lineno"> 2779</span> </div>
<div class="line"><a id="l02780" name="l02780"></a><span class="lineno"> 2780</span><span class="keywordtype">    real</span>(kind_lake) :: denom</div>
<div class="line"><a id="l02781" name="l02781"></a><span class="lineno"> 2781</span> </div>
<div class="line"><a id="l02782" name="l02782"></a><span class="lineno"> 2782</span>    <span class="comment">! Thermal conductivity of soil from Farouki (1981)</span></div>
<div class="line"><a id="l02783" name="l02783"></a><span class="lineno"> 2783</span> </div>
<div class="line"><a id="l02784" name="l02784"></a><span class="lineno"> 2784</span>    <span class="keywordflow">do</span> j = -nlevsnow+1,nlevsoil</div>
<div class="line"><a id="l02785" name="l02785"></a><span class="lineno"> 2785</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02786" name="l02786"></a><span class="lineno"> 2786</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02787" name="l02787"></a><span class="lineno"> 2787</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l02788" name="l02788"></a><span class="lineno"> 2788</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02789" name="l02789"></a><span class="lineno"> 2789</span> </div>
<div class="line"><a id="l02790" name="l02790"></a><span class="lineno"> 2790</span>          <span class="comment">! Only examine levels from 1-&gt;nlevsoil</span></div>
<div class="line"><a id="l02791" name="l02791"></a><span class="lineno"> 2791</span>          <span class="keywordflow">if</span> (j &gt;= 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02792" name="l02792"></a><span class="lineno"> 2792</span>            <span class="comment">!             l = clandunit(c)</span></div>
<div class="line"><a id="l02793" name="l02793"></a><span class="lineno"> 2793</span>            <span class="comment">!             if (ityplun(l) /= istwet .AND. ityplun(l) /= istice) then</span></div>
<div class="line"><a id="l02794" name="l02794"></a><span class="lineno"> 2794</span>              <span class="comment">! This could be altered later for allowing this to be over glaciers.</span></div>
<div class="line"><a id="l02795" name="l02795"></a><span class="lineno"> 2795</span> </div>
<div class="line"><a id="l02796" name="l02796"></a><span class="lineno"> 2796</span>          <span class="comment">! Soil should be saturated.</span></div>
<div class="line"><a id="l02797" name="l02797"></a><span class="lineno"> 2797</span>                <span class="keywordflow">if</span> (lakedebug) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02798" name="l02798"></a><span class="lineno"> 2798</span>                  satw = (h2osoi_liq(c,j)/denh2o + h2osoi_ice(c,j)/denice)/(dz(c,j)*watsat(c,j))</div>
<div class="line"><a id="l02799" name="l02799"></a><span class="lineno"> 2799</span>                  <span class="comment">!                satw = min(1._kind_lake, satw)</span></div>
<div class="line"><a id="l02800" name="l02800"></a><span class="lineno"> 2800</span>                  <span class="keywordflow">if</span> (satw &lt; 0.999_kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02801" name="l02801"></a><span class="lineno"> 2801</span>                    <span class="keyword">write</span>(message,*)<span class="stringliteral">&#39;WARNING: soil layer unsaturated in SoilThermProp_Lake, satw, j = &#39;</span>, satw, j</div>
<div class="line"><a id="l02802" name="l02802"></a><span class="lineno"> 2802</span>                    <span class="comment">! errmsg=trim(message)</span></div>
<div class="line"><a id="l02803" name="l02803"></a><span class="lineno"> 2803</span>                    <span class="comment">! errflg=1</span></div>
<div class="line"><a id="l02804" name="l02804"></a><span class="lineno"> 2804</span>                    <span class="keyword">write</span>(0,<span class="stringliteral">&#39;(A)&#39;</span>) trim(message)</div>
<div class="line"><a id="l02805" name="l02805"></a><span class="lineno"> 2805</span><span class="keywordflow">                  end if</span></div>
<div class="line"><a id="l02806" name="l02806"></a><span class="lineno"> 2806</span>          <span class="comment">! Could use denice because if it starts out frozen, the volume of water will go below sat.,</span></div>
<div class="line"><a id="l02807" name="l02807"></a><span class="lineno"> 2807</span>          <span class="comment">! since we&#39;re not yet doing excess ice.</span></div>
<div class="line"><a id="l02808" name="l02808"></a><span class="lineno"> 2808</span>          <span class="comment">! But take care of this in HydrologyLake.</span></div>
<div class="line"><a id="l02809" name="l02809"></a><span class="lineno"> 2809</span><span class="keywordflow">                endif</span></div>
<div class="line"><a id="l02810" name="l02810"></a><span class="lineno"> 2810</span>                satw = 1._kind_lake</div>
<div class="line"><a id="l02811" name="l02811"></a><span class="lineno"> 2811</span>                   denom = (h2osoi_ice(c,j)+h2osoi_liq(c,j))</div>
<div class="line"><a id="l02812" name="l02812"></a><span class="lineno"> 2812</span>                   <span class="keywordflow">if</span>(denom&gt;zero_h2o) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02813" name="l02813"></a><span class="lineno"> 2813</span>                      fl = h2osoi_liq(c,j)/denom</div>
<div class="line"><a id="l02814" name="l02814"></a><span class="lineno"> 2814</span>                   <span class="keywordflow">else</span></div>
<div class="line"><a id="l02815" name="l02815"></a><span class="lineno"> 2815</span>                      <span class="keyword">write</span>(message,<span class="stringliteral">&#39;(A,I0)&#39;</span>) <span class="stringliteral">&#39;WARNING: zero h2osoi_ice+h2osoi_liq at j = &#39;</span>, j</div>
<div class="line"><a id="l02816" name="l02816"></a><span class="lineno"> 2816</span>                      <span class="comment">! errmsg=trim(message)</span></div>
<div class="line"><a id="l02817" name="l02817"></a><span class="lineno"> 2817</span>                      <span class="comment">! errflg=1</span></div>
<div class="line"><a id="l02818" name="l02818"></a><span class="lineno"> 2818</span>                      fl = 0</div>
<div class="line"><a id="l02819" name="l02819"></a><span class="lineno"> 2819</span>                      <span class="keyword">write</span>(0,<span class="stringliteral">&#39;(A)&#39;</span>) trim(message)</div>
<div class="line"><a id="l02820" name="l02820"></a><span class="lineno"> 2820</span><span class="keywordflow">                   endif</span></div>
<div class="line"><a id="l02821" name="l02821"></a><span class="lineno"> 2821</span>                   <span class="keywordflow">if</span> (t_soisno(c,j) &gt;= tfrz) <span class="keywordflow">then</span>       <span class="comment">! Unfrozen soil</span></div>
<div class="line"><a id="l02822" name="l02822"></a><span class="lineno"> 2822</span>                      dke = max(0._kind_lake, log10(satw) + 1.0_kind_lake)</div>
<div class="line"><a id="l02823" name="l02823"></a><span class="lineno"> 2823</span>                      dksat = tksatu(c,j)</div>
<div class="line"><a id="l02824" name="l02824"></a><span class="lineno"> 2824</span>                   <span class="keywordflow">else</span>                               <span class="comment">! Frozen soil</span></div>
<div class="line"><a id="l02825" name="l02825"></a><span class="lineno"> 2825</span>                      dke = satw</div>
<div class="line"><a id="l02826" name="l02826"></a><span class="lineno"> 2826</span>                      dksat = tkmg(c,j)*0.249_kind_lake**(fl*watsat(c,j))*2.29_kind_lake**watsat(c,j)</div>
<div class="line"><a id="l02827" name="l02827"></a><span class="lineno"> 2827</span><span class="keywordflow">                   endif</span></div>
<div class="line"><a id="l02828" name="l02828"></a><span class="lineno"> 2828</span>                   thk(c,j) = dke*dksat + (1._kind_lake-dke)*tkdry(c,j)</div>
<div class="line"><a id="l02829" name="l02829"></a><span class="lineno"> 2829</span>                   <span class="comment">!             else</span></div>
<div class="line"><a id="l02830" name="l02830"></a><span class="lineno"> 2830</span>                   <span class="comment">!                thk(c,j) = tkwat</span></div>
<div class="line"><a id="l02831" name="l02831"></a><span class="lineno"> 2831</span>                   <span class="comment">!                if (t_soisno(c,j) &lt; tfrz) thk(c,j) = tkice</span></div>
<div class="line"><a id="l02832" name="l02832"></a><span class="lineno"> 2832</span>                   <span class="comment">!             endif</span></div>
<div class="line"><a id="l02833" name="l02833"></a><span class="lineno"> 2833</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l02834" name="l02834"></a><span class="lineno"> 2834</span> </div>
<div class="line"><a id="l02835" name="l02835"></a><span class="lineno"> 2835</span>          <span class="comment">! Thermal conductivity of snow, which from Jordan (1991) pp. 18</span></div>
<div class="line"><a id="l02836" name="l02836"></a><span class="lineno"> 2836</span>          <span class="comment">! Only examine levels from snl(c)+1 -&gt; 0 where snl(c) &lt; 1</span></div>
<div class="line"><a id="l02837" name="l02837"></a><span class="lineno"> 2837</span>          <span class="keywordflow">if</span> (snl(c)+1 &lt; 1 .AND. (j &gt;= snl(c)+1) .AND. (j &lt;= 0)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02838" name="l02838"></a><span class="lineno"> 2838</span>             bw = (h2osoi_ice(c,j)+h2osoi_liq(c,j))/dz(c,j)</div>
<div class="line"><a id="l02839" name="l02839"></a><span class="lineno"> 2839</span>             thk(c,j) = tkairc + (7.75e-5_kind_lake *bw + 1.105e-6_kind_lake*bw*bw)*(tkice-tkairc)</div>
<div class="line"><a id="l02840" name="l02840"></a><span class="lineno"> 2840</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02841" name="l02841"></a><span class="lineno"> 2841</span> </div>
<div class="line"><a id="l02842" name="l02842"></a><span class="lineno"> 2842</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02843" name="l02843"></a><span class="lineno"> 2843</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02844" name="l02844"></a><span class="lineno"> 2844</span> </div>
<div class="line"><a id="l02845" name="l02845"></a><span class="lineno"> 2845</span>    <span class="comment">! Thermal conductivity at the layer interface</span></div>
<div class="line"><a id="l02846" name="l02846"></a><span class="lineno"> 2846</span> </div>
<div class="line"><a id="l02847" name="l02847"></a><span class="lineno"> 2847</span>    <span class="comment">! Have to correct for the fact that bottom snow layer and top soil layer border lake.</span></div>
<div class="line"><a id="l02848" name="l02848"></a><span class="lineno"> 2848</span>    <span class="comment">! For the first case, the snow layer conductivity for the middle of the layer will be returned.</span></div>
<div class="line"><a id="l02849" name="l02849"></a><span class="lineno"> 2849</span>    <span class="comment">! Because the interfaces are below the soil layers, the conductivity for the top soil layer</span></div>
<div class="line"><a id="l02850" name="l02850"></a><span class="lineno"> 2850</span>    <span class="comment">! will have to be returned separately.</span></div>
<div class="line"><a id="l02851" name="l02851"></a><span class="lineno"> 2851</span>    <span class="keywordflow">do</span> j = -nlevsnow+1,nlevsoil</div>
<div class="line"><a id="l02852" name="l02852"></a><span class="lineno"> 2852</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02853" name="l02853"></a><span class="lineno"> 2853</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02854" name="l02854"></a><span class="lineno"> 2854</span>       <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l02855" name="l02855"></a><span class="lineno"> 2855</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02856" name="l02856"></a><span class="lineno"> 2856</span>          <span class="keywordflow">if</span> (j &gt;= snl(c)+1 .AND. j &lt;= nlevsoil-1 .AND. j /= 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02857" name="l02857"></a><span class="lineno"> 2857</span>             tk(c,j) = thk(c,j)*thk(c,j+1)*(z(c,j+1)-z(c,j)) &amp;</div>
<div class="line"><a id="l02858" name="l02858"></a><span class="lineno"> 2858</span>                  /(thk(c,j)*(z(c,j+1)-zi(c,j))+thk(c,j+1)*(zi(c,j)-z(c,j)))</div>
<div class="line"><a id="l02859" name="l02859"></a><span class="lineno"> 2859</span>          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02860" name="l02860"></a><span class="lineno"> 2860</span>             tk(c,j) = thk(c,j)</div>
<div class="line"><a id="l02861" name="l02861"></a><span class="lineno"> 2861</span>          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (j == nlevsoil) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02862" name="l02862"></a><span class="lineno"> 2862</span>             tk(c,j) = 0._kind_lake</div>
<div class="line"><a id="l02863" name="l02863"></a><span class="lineno"> 2863</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02864" name="l02864"></a><span class="lineno"> 2864</span>          <span class="comment">! For top soil layer.</span></div>
<div class="line"><a id="l02865" name="l02865"></a><span class="lineno"> 2865</span>          <span class="keywordflow">if</span> (j == 1) tktopsoillay(c) = thk(c,j)</div>
<div class="line"><a id="l02866" name="l02866"></a><span class="lineno"> 2866</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02867" name="l02867"></a><span class="lineno"> 2867</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02868" name="l02868"></a><span class="lineno"> 2868</span> </div>
<div class="line"><a id="l02869" name="l02869"></a><span class="lineno"> 2869</span>    <span class="comment">! Soil heat capacity, from de Vires (1963)</span></div>
<div class="line"><a id="l02870" name="l02870"></a><span class="lineno"> 2870</span> </div>
<div class="line"><a id="l02871" name="l02871"></a><span class="lineno"> 2871</span>    <span class="keywordflow">do</span> j = 1, nlevsoil</div>
<div class="line"><a id="l02872" name="l02872"></a><span class="lineno"> 2872</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02873" name="l02873"></a><span class="lineno"> 2873</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02874" name="l02874"></a><span class="lineno"> 2874</span>       <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l02875" name="l02875"></a><span class="lineno"> 2875</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02876" name="l02876"></a><span class="lineno"> 2876</span>          <span class="comment">!          l = clandunit(c)</span></div>
<div class="line"><a id="l02877" name="l02877"></a><span class="lineno"> 2877</span>          <span class="comment">!          if (ityplun(l) /= istwet .AND. ityplun(l) /= istice) then</span></div>
<div class="line"><a id="l02878" name="l02878"></a><span class="lineno"> 2878</span>             cv(c,j) = csol(c,j)*(1-watsat(c,j))*dz(c,j) +   &amp;</div>
<div class="line"><a id="l02879" name="l02879"></a><span class="lineno"> 2879</span>               (h2osoi_ice(c,j)*cpice + h2osoi_liq(c,j)*cpliq)</div>
<div class="line"><a id="l02880" name="l02880"></a><span class="lineno"> 2880</span>             <span class="comment">!          else</span></div>
<div class="line"><a id="l02881" name="l02881"></a><span class="lineno"> 2881</span>             <span class="comment">!             cv(c,j) = (h2osoi_ice(c,j)*cpice + h2osoi_liq(c,j)*cpliq)</span></div>
<div class="line"><a id="l02882" name="l02882"></a><span class="lineno"> 2882</span>             <span class="comment">!          endif</span></div>
<div class="line"><a id="l02883" name="l02883"></a><span class="lineno"> 2883</span>             <span class="comment">!          if (j == 1) then</span></div>
<div class="line"><a id="l02884" name="l02884"></a><span class="lineno"> 2884</span>             <span class="comment">!             if (snl(c)+1 == 1 .AND. h2osno(c) &gt; 0._kind_lake) then</span></div>
<div class="line"><a id="l02885" name="l02885"></a><span class="lineno"> 2885</span>             <span class="comment">!                cv(c,j) = cv(c,j) + cpice*h2osno(c)</span></div>
<div class="line"><a id="l02886" name="l02886"></a><span class="lineno"> 2886</span>             <span class="comment">!             end if</span></div>
<div class="line"><a id="l02887" name="l02887"></a><span class="lineno"> 2887</span>             <span class="comment">!          end if</span></div>
<div class="line"><a id="l02888" name="l02888"></a><span class="lineno"> 2888</span>             <span class="comment">! Won&#39;t worry about heat capacity for thin snow on lake with no snow layers.</span></div>
<div class="line"><a id="l02889" name="l02889"></a><span class="lineno"> 2889</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l02890" name="l02890"></a><span class="lineno"> 2890</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02891" name="l02891"></a><span class="lineno"> 2891</span> </div>
<div class="line"><a id="l02892" name="l02892"></a><span class="lineno"> 2892</span>    <span class="comment">! Snow heat capacity</span></div>
<div class="line"><a id="l02893" name="l02893"></a><span class="lineno"> 2893</span> </div>
<div class="line"><a id="l02894" name="l02894"></a><span class="lineno"> 2894</span>    <span class="keywordflow">do</span> j = -nlevsnow+1,0</div>
<div class="line"><a id="l02895" name="l02895"></a><span class="lineno"> 2895</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02896" name="l02896"></a><span class="lineno"> 2896</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02897" name="l02897"></a><span class="lineno"> 2897</span>      <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l02898" name="l02898"></a><span class="lineno"> 2898</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l02899" name="l02899"></a><span class="lineno"> 2899</span>          <span class="keywordflow">if</span> (snl(c)+1 &lt; 1 .and. j &gt;= snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02900" name="l02900"></a><span class="lineno"> 2900</span>             cv(c,j) = cpliq*h2osoi_liq(c,j) + cpice*h2osoi_ice(c,j)</div>
<div class="line"><a id="l02901" name="l02901"></a><span class="lineno"> 2901</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l02902" name="l02902"></a><span class="lineno"> 2902</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l02903" name="l02903"></a><span class="lineno"> 2903</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02904" name="l02904"></a><span class="lineno"> 2904</span> </div>
</div>
<div class="line"><a id="l02905" name="l02905"></a><span class="lineno"> 2905</span>  <span class="keyword">end subroutine </span>soilthermprop_lake</div>
<div class="line"><a id="l02906" name="l02906"></a><span class="lineno"> 2906</span> </div>
<div class="line"><a id="l02907" name="l02907"></a><span class="lineno"> 2907</span> </div>
<div class="line"><a id="l02908" name="l02908"></a><span class="lineno"> 2908</span>  <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02909" name="l02909"></a><span class="lineno"> 2909</span>  <span class="comment">!BOP</span></div>
<div class="line"><a id="l02910" name="l02910"></a><span class="lineno"> 2910</span>  <span class="comment">!</span></div>
<div class="line"><a id="l02911" name="l02911"></a><span class="lineno"> 2911</span>  <span class="comment">! ROUTINE: PhaseChange_Lake</span></div>
<div class="line"><a id="l02912" name="l02912"></a><span class="lineno"> 2912</span>  <span class="comment">!</span></div>
<div class="line"><a id="l02913" name="l02913"></a><span class="lineno"> 2913</span>  <span class="comment">! !INTERFACE:</span></div>
<div class="line"><a id="l02914" name="l02914"></a><span class="lineno"> 2914</span> </div>
<div class="line"><a id="l02915" name="l02915"></a><span class="lineno"> 2915</span>    <span class="comment">! DESCRIPTION:</span><span class="comment"></span></div>
<div class="line"><a id="l02916" name="l02916"></a><span class="lineno"> 2916</span><span class="comment">    !&gt; Calculation of the phase change within snow, soil, &amp; lake layers:</span></div>
<div class="line"><a id="l02917" name="l02917"></a><span class="lineno"> 2917</span><span class="comment">    !!\n (1) Check the conditions for which the phase change may take place,</span></div>
<div class="line"><a id="l02918" name="l02918"></a><span class="lineno"> 2918</span><span class="comment">    !!     i.e., the layer temperature is greater than the freezing point</span></div>
<div class="line"><a id="l02919" name="l02919"></a><span class="lineno"> 2919</span><span class="comment">    !!     and the ice mass is not equal to zero (i.e. melting),       </span></div>
<div class="line"><a id="l02920" name="l02920"></a><span class="lineno"> 2920</span><span class="comment">    !!     or the layer temperature is less than the freezing point    </span></div>
<div class="line"><a id="l02921" name="l02921"></a><span class="lineno"> 2921</span><span class="comment">    !!     and the liquid water mass is greater than the allowable supercooled </span></div>
<div class="line"><a id="l02922" name="l02922"></a><span class="lineno"> 2922</span><span class="comment">    !!    (i.e. freezing).</span></div>
<div class="line"><a id="l02923" name="l02923"></a><span class="lineno"> 2923</span><span class="comment">    !!\n (2) Assess the amount of phase change from the energy excess (or deficit)</span></div>
<div class="line"><a id="l02924" name="l02924"></a><span class="lineno"> 2924</span><span class="comment">    !!     after setting the layer temperature to freezing point, depending on</span></div>
<div class="line"><a id="l02925" name="l02925"></a><span class="lineno"> 2925</span><span class="comment">    !!     how much water or ice is available.</span></div>
<div class="line"><a id="l02926" name="l02926"></a><span class="lineno"> 2926</span><span class="comment">    !!\n (3) Re-adjust the ice and liquid mass, and the layer temperature: either to</span></div>
<div class="line"><a id="l02927" name="l02927"></a><span class="lineno"> 2927</span><span class="comment">    !!     the freezing point if enough water or ice is available to fully compensate,</span></div>
<div class="line"><a id="l02928" name="l02928"></a><span class="lineno"> 2928</span><span class="comment">    !!     or to a remaining temperature.</span></div>
<div class="line"><a id="l02929" name="l02929"></a><span class="lineno"> 2929</span><span class="comment">    !!</span></div>
<div class="line"><a id="l02930" name="l02930"></a><span class="lineno"> 2930</span><span class="comment">    !! The specific heats are assumed constant. Potential cycling errors resulting from</span></div>
<div class="line"><a id="l02931" name="l02931"></a><span class="lineno"> 2931</span><span class="comment">    !! this assumption will be trapped at the end of ShalLakeTemperature.</span></div>
<div class="foldopen" id="foldopen02932" data-start="" data-end="">
<div class="line"><a id="l02932" name="l02932"></a><span class="lineno"><a class="line" href="namespaceclm__lake_acbf73d26ff8d333240b46663ba694c88.html#acbf73d26ff8d333240b46663ba694c88"> 2932</a></span>  <span class="keyword">subroutine </span>phasechange_lake (snl,h2osno,dz,dz_lake,                        &amp; !i</div>
<div class="line"><a id="l02933" name="l02933"></a><span class="lineno"> 2933</span>                               t_soisno,h2osoi_liq,h2osoi_ice,               &amp; !i&amp;o</div>
<div class="line"><a id="l02934" name="l02934"></a><span class="lineno"> 2934</span>                               lake_icefrac,t_lake, snowdp,                  &amp; !i&amp;o</div>
<div class="line"><a id="l02935" name="l02935"></a><span class="lineno"> 2935</span>                               qflx_snomelt,eflx_snomelt,imelt,              &amp; !o  </div>
<div class="line"><a id="l02936" name="l02936"></a><span class="lineno"> 2936</span>                               cv, cv_lake,                                  &amp; !i&amp;o</div>
<div class="line"><a id="l02937" name="l02937"></a><span class="lineno"> 2937</span>                               lhabs)                                          <span class="comment">!o</span></div>
<div class="line"><a id="l02938" name="l02938"></a><span class="lineno"> 2938</span>    <span class="comment">!=============================================================================================</span></div>
<div class="line"><a id="l02939" name="l02939"></a><span class="lineno"> 2939</span>    <span class="comment">!CALLED FROM:</span></div>
<div class="line"><a id="l02940" name="l02940"></a><span class="lineno"> 2940</span>    <span class="comment">! subroutine ShalLakeTemperature in this module</span></div>
<div class="line"><a id="l02941" name="l02941"></a><span class="lineno"> 2941</span>    <span class="comment">!</span></div>
<div class="line"><a id="l02942" name="l02942"></a><span class="lineno"> 2942</span>    <span class="comment">!REVISION HISTORY:</span></div>
<div class="line"><a id="l02943" name="l02943"></a><span class="lineno"> 2943</span>    <span class="comment">! - 04/2009 Zack Subin: Initial code</span></div>
<div class="line"><a id="l02944" name="l02944"></a><span class="lineno"> 2944</span>    <span class="comment">! - June 2022 Sam Trahan: Modified for CCPP</span></div>
<div class="line"><a id="l02945" name="l02945"></a><span class="lineno"> 2945</span>    <span class="comment">!==============================================================================================</span></div>
<div class="line"><a id="l02946" name="l02946"></a><span class="lineno"> 2946</span>    <span class="comment">! !USES:</span></div>
<div class="line"><a id="l02947" name="l02947"></a><span class="lineno"> 2947</span>    <span class="comment">!</span></div>
<div class="line"><a id="l02948" name="l02948"></a><span class="lineno"> 2948</span>    <span class="comment">! !ARGUMENTS:</span></div>
<div class="line"><a id="l02949" name="l02949"></a><span class="lineno"> 2949</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l02950" name="l02950"></a><span class="lineno"> 2950</span>    <span class="comment">!in: </span></div>
<div class="line"><a id="l02951" name="l02951"></a><span class="lineno"> 2951</span> </div>
<div class="line"><a id="l02952" name="l02952"></a><span class="lineno"> 2952</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span> :: snl(1)<span class="comment">           !&lt; number of snow layers</span></div>
<div class="line"><a id="l02953" name="l02953"></a><span class="lineno"> 2953</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osno(1)<span class="comment">        !&lt; snow water (mm H2O)</span></div>
<div class="line"><a id="l02954" name="l02954"></a><span class="lineno"> 2954</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: dz(1,-nlevsnow+1:nlevsoil)<span class="comment">          !&lt; layer thickness (m)</span></div>
<div class="line"><a id="l02955" name="l02955"></a><span class="lineno"> 2955</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: dz_lake(1,nlevlake)<span class="comment">     !&lt; lake layer thickness (m)</span></div>
<div class="line"><a id="l02956" name="l02956"></a><span class="lineno"> 2956</span>    <span class="comment">! Needed in case snow height is less than critical value.</span></div>
<div class="line"><a id="l02957" name="l02957"></a><span class="lineno"> 2957</span> </div>
<div class="line"><a id="l02958" name="l02958"></a><span class="lineno"> 2958</span>    <span class="comment">!inout: </span></div>
<div class="line"><a id="l02959" name="l02959"></a><span class="lineno"> 2959</span> </div>
<div class="line"><a id="l02960" name="l02960"></a><span class="lineno"> 2960</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: snowdp(1)<span class="comment">        !&lt; snow height (m)</span></div>
<div class="line"><a id="l02961" name="l02961"></a><span class="lineno"> 2961</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: t_soisno(1,-nlevsnow+1:nlevsoil)<span class="comment">     !&lt; soil temperature (Kelvin)</span></div>
<div class="line"><a id="l02962" name="l02962"></a><span class="lineno"> 2962</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osoi_liq(1,-nlevsnow+1:nlevsoil)<span class="comment">   !&lt; liquid water (kg/m2)</span></div>
<div class="line"><a id="l02963" name="l02963"></a><span class="lineno"> 2963</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osoi_ice(1,-nlevsnow+1:nlevsoil)<span class="comment">   !&lt; ice lens (kg/m2)</span></div>
<div class="line"><a id="l02964" name="l02964"></a><span class="lineno"> 2964</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: lake_icefrac(1,nlevlake)<span class="comment"> !&lt;  mass fraction of lake layer that is frozen</span></div>
<div class="line"><a id="l02965" name="l02965"></a><span class="lineno"> 2965</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: t_lake(1,nlevlake)<span class="comment">       !&lt;  lake temperature (Kelvin)</span></div>
<div class="line"><a id="l02966" name="l02966"></a><span class="lineno"> 2966</span>    <span class="comment">!out: </span></div>
<div class="line"><a id="l02967" name="l02967"></a><span class="lineno"> 2967</span> </div>
<div class="line"><a id="l02968" name="l02968"></a><span class="lineno"> 2968</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_snomelt(1)<span class="comment">  !&lt; snow melt (mm H2O /s)</span></div>
<div class="line"><a id="l02969" name="l02969"></a><span class="lineno"> 2969</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: eflx_snomelt(1)<span class="comment">  !&lt; snow melt heat flux (W/m**2)</span></div>
<div class="line"><a id="l02970" name="l02970"></a><span class="lineno"> 2970</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(out)</span>  :: imelt(1,-nlevsnow+1:nlevsoil)<span class="comment">        !&lt; flag for melting (=1), freezing (=2), Not=0 (new)</span></div>
<div class="line"><a id="l02971" name="l02971"></a><span class="lineno"> 2971</span>                                          <span class="comment">!What&#39;s the sign of this? Is it just output?</span></div>
<div class="line"><a id="l02972" name="l02972"></a><span class="lineno"> 2972</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: cv(lbc:ubc,-nlevsnow+1:nlevsoil)<span class="comment">       !&lt; heat capacity [J/(m2 K)]</span></div>
<div class="line"><a id="l02973" name="l02973"></a><span class="lineno"> 2973</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: cv_lake (lbc:ubc,1:nlevlake)<span class="comment">          !&lt; heat capacity [J/(m2 K)]</span></div>
<div class="line"><a id="l02974" name="l02974"></a><span class="lineno"> 2974</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span>:: lhabs(lbc:ubc)<span class="comment">                       !&lt;  total per-column latent heat abs. (J/m^2)</span></div>
<div class="line"><a id="l02975" name="l02975"></a><span class="lineno"> 2975</span> </div>
<div class="line"><a id="l02976" name="l02976"></a><span class="lineno"> 2976</span> </div>
<div class="line"><a id="l02977" name="l02977"></a><span class="lineno"> 2977</span>    <span class="comment">! OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l02978" name="l02978"></a><span class="lineno"> 2978</span> </div>
<div class="line"><a id="l02979" name="l02979"></a><span class="lineno"> 2979</span>    <span class="keywordtype">integer</span>  :: j,c,g                              <span class="comment">!do loop index</span></div>
<div class="line"><a id="l02980" name="l02980"></a><span class="lineno"> 2980</span>    <span class="keywordtype">integer</span>  :: fc                                 <span class="comment">!lake filtered column indices</span></div>
<div class="line"><a id="l02981" name="l02981"></a><span class="lineno"> 2981</span><span class="keywordtype">    real</span>(kind_lake) :: heatavail                          <span class="comment">!available energy for melting or freezing (J/m^2)</span></div>
<div class="line"><a id="l02982" name="l02982"></a><span class="lineno"> 2982</span><span class="keywordtype">    real</span>(kind_lake) :: heatrem                            <span class="comment">!energy residual or loss after melting or freezing</span></div>
<div class="line"><a id="l02983" name="l02983"></a><span class="lineno"> 2983</span><span class="keywordtype">    real</span>(kind_lake) :: melt                               <span class="comment">!actual melting (+) or freezing (-) [kg/m2]</span></div>
<div class="line"><a id="l02984" name="l02984"></a><span class="lineno"> 2984</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: smallnumber = 1.e-7_kind_lake  <span class="comment">!to prevent tiny residuals from rounding error</span></div>
<div class="line"><a id="l02985" name="l02985"></a><span class="lineno"> 2985</span>    <span class="keywordtype">logical</span>  :: dophasechangeflag</div>
<div class="line"><a id="l02986" name="l02986"></a><span class="lineno"> 2986</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l02987" name="l02987"></a><span class="lineno"> 2987</span>    </div>
<div class="line"><a id="l02988" name="l02988"></a><span class="lineno"> 2988</span>    <span class="comment">! Initialization</span></div>
<div class="line"><a id="l02989" name="l02989"></a><span class="lineno"> 2989</span> </div>
<div class="line"><a id="l02990" name="l02990"></a><span class="lineno"> 2990</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l02991" name="l02991"></a><span class="lineno"> 2991</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l02992" name="l02992"></a><span class="lineno"> 2992</span>    <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l02993" name="l02993"></a><span class="lineno"> 2993</span>       c = filter_shlakec(fc)</div>
<div class="line"><a id="l02994" name="l02994"></a><span class="lineno"> 2994</span> </div>
<div class="line"><a id="l02995" name="l02995"></a><span class="lineno"> 2995</span>       qflx_snomelt(c) = 0._kind_lake</div>
<div class="line"><a id="l02996" name="l02996"></a><span class="lineno"> 2996</span>       eflx_snomelt(c) = 0._kind_lake</div>
<div class="line"><a id="l02997" name="l02997"></a><span class="lineno"> 2997</span>       lhabs(c)        = 0._kind_lake</div>
<div class="line"><a id="l02998" name="l02998"></a><span class="lineno"> 2998</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l02999" name="l02999"></a><span class="lineno"> 2999</span> </div>
<div class="line"><a id="l03000" name="l03000"></a><span class="lineno"> 3000</span>    <span class="keywordflow">do</span> j = -nlevsnow+1,0</div>
<div class="line"><a id="l03001" name="l03001"></a><span class="lineno"> 3001</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03002" name="l03002"></a><span class="lineno"> 3002</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03003" name="l03003"></a><span class="lineno"> 3003</span>       <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l03004" name="l03004"></a><span class="lineno"> 3004</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l03005" name="l03005"></a><span class="lineno"> 3005</span> </div>
<div class="line"><a id="l03006" name="l03006"></a><span class="lineno"> 3006</span>          <span class="keywordflow">if</span> (j &gt;= snl(c) + 1) imelt(c,j) = 0</div>
<div class="line"><a id="l03007" name="l03007"></a><span class="lineno"> 3007</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03008" name="l03008"></a><span class="lineno"> 3008</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03009" name="l03009"></a><span class="lineno"> 3009</span> </div>
<div class="line"><a id="l03010" name="l03010"></a><span class="lineno"> 3010</span>    <span class="comment">! Check for case of snow without snow layers and top lake layer temp above freezing.</span></div>
<div class="line"><a id="l03011" name="l03011"></a><span class="lineno"> 3011</span> </div>
<div class="line"><a id="l03012" name="l03012"></a><span class="lineno"> 3012</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03013" name="l03013"></a><span class="lineno"> 3013</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03014" name="l03014"></a><span class="lineno"> 3014</span>    <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l03015" name="l03015"></a><span class="lineno"> 3015</span>       c = filter_shlakec(fc)</div>
<div class="line"><a id="l03016" name="l03016"></a><span class="lineno"> 3016</span> </div>
<div class="line"><a id="l03017" name="l03017"></a><span class="lineno"> 3017</span>       <span class="keywordflow">if</span> (snl(c) == 0 .and. h2osno(c) &gt; 0._kind_lake .and. t_lake(c,1) &gt; tfrz) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03018" name="l03018"></a><span class="lineno"> 3018</span>          heatavail = (t_lake(c,1) - tfrz) * cv_lake(c,1)</div>
<div class="line"><a id="l03019" name="l03019"></a><span class="lineno"> 3019</span>          melt = min(h2osno(c), heatavail/hfus)</div>
<div class="line"><a id="l03020" name="l03020"></a><span class="lineno"> 3020</span>          heatrem = max(heatavail - melt*hfus, 0._kind_lake)</div>
<div class="line"><a id="l03021" name="l03021"></a><span class="lineno"> 3021</span>                       <span class="comment">!catch small negative value to keep t at tfrz</span></div>
<div class="line"><a id="l03022" name="l03022"></a><span class="lineno"> 3022</span>          t_lake(c,1) = tfrz + heatrem/(cv_lake(c,1))</div>
<div class="line"><a id="l03023" name="l03023"></a><span class="lineno"> 3023</span>          snowdp(c) = snowdp(c)*(1._kind_lake - melt/h2osno(c))</div>
<div class="line"><a id="l03024" name="l03024"></a><span class="lineno"> 3024</span>          h2osno(c) = h2osno(c) - melt</div>
<div class="line"><a id="l03025" name="l03025"></a><span class="lineno"> 3025</span>          lhabs(c) = lhabs(c) + melt*hfus</div>
<div class="line"><a id="l03026" name="l03026"></a><span class="lineno"> 3026</span>          qflx_snomelt(c) = qflx_snomelt(c) + melt</div>
<div class="line"><a id="l03027" name="l03027"></a><span class="lineno"> 3027</span>          <span class="comment">! Prevent tiny residuals</span></div>
<div class="line"><a id="l03028" name="l03028"></a><span class="lineno"> 3028</span>          <span class="keywordflow">if</span> (h2osno(c) &lt; smallnumber) h2osno(c) = 0._kind_lake</div>
<div class="line"><a id="l03029" name="l03029"></a><span class="lineno"> 3029</span>          <span class="keywordflow">if</span> (snowdp(c) &lt; smallnumber) snowdp(c) = 0._kind_lake</div>
<div class="line"><a id="l03030" name="l03030"></a><span class="lineno"> 3030</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l03031" name="l03031"></a><span class="lineno"> 3031</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03032" name="l03032"></a><span class="lineno"> 3032</span> </div>
<div class="line"><a id="l03033" name="l03033"></a><span class="lineno"> 3033</span>    <span class="comment">! Lake phase change</span></div>
<div class="line"><a id="l03034" name="l03034"></a><span class="lineno"> 3034</span> </div>
<div class="line"><a id="l03035" name="l03035"></a><span class="lineno"> 3035</span>    <span class="keywordflow">do</span> j = 1,nlevlake</div>
<div class="line"><a id="l03036" name="l03036"></a><span class="lineno"> 3036</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03037" name="l03037"></a><span class="lineno"> 3037</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03038" name="l03038"></a><span class="lineno"> 3038</span>       <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l03039" name="l03039"></a><span class="lineno"> 3039</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l03040" name="l03040"></a><span class="lineno"> 3040</span> </div>
<div class="line"><a id="l03041" name="l03041"></a><span class="lineno"> 3041</span>          dophasechangeflag = .false.</div>
<div class="line"><a id="l03042" name="l03042"></a><span class="lineno"> 3042</span>          <span class="keywordflow">if</span> (t_lake(c,j) &gt; tfrz .and. lake_icefrac(c,j) &gt; 0._kind_lake) <span class="keywordflow">then</span> <span class="comment">! melting</span></div>
<div class="line"><a id="l03043" name="l03043"></a><span class="lineno"> 3043</span>             dophasechangeflag = .true.</div>
<div class="line"><a id="l03044" name="l03044"></a><span class="lineno"> 3044</span>             heatavail = (t_lake(c,j) - tfrz) * cv_lake(c,j)</div>
<div class="line"><a id="l03045" name="l03045"></a><span class="lineno"> 3045</span>             melt = min(lake_icefrac(c,j)*denh2o*dz_lake(c,j), heatavail/hfus)</div>
<div class="line"><a id="l03046" name="l03046"></a><span class="lineno"> 3046</span>                        <span class="comment">!denh2o is used because layer thickness is not adjusted for freezing</span></div>
<div class="line"><a id="l03047" name="l03047"></a><span class="lineno"> 3047</span>             heatrem = max(heatavail - melt*hfus, 0._kind_lake)</div>
<div class="line"><a id="l03048" name="l03048"></a><span class="lineno"> 3048</span>                       <span class="comment">!catch small negative value to keep t at tfrz</span></div>
<div class="line"><a id="l03049" name="l03049"></a><span class="lineno"> 3049</span>          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t_lake(c,j) &lt; tfrz .and. lake_icefrac(c,j) &lt; 1._kind_lake) <span class="keywordflow">then</span> <span class="comment">!freezing</span></div>
<div class="line"><a id="l03050" name="l03050"></a><span class="lineno"> 3050</span>             dophasechangeflag = .true.</div>
<div class="line"><a id="l03051" name="l03051"></a><span class="lineno"> 3051</span>             heatavail = (t_lake(c,j) - tfrz) * cv_lake(c,j)</div>
<div class="line"><a id="l03052" name="l03052"></a><span class="lineno"> 3052</span>             melt = max(-(1._kind_lake-lake_icefrac(c,j))*denh2o*dz_lake(c,j), heatavail/hfus)</div>
<div class="line"><a id="l03053" name="l03053"></a><span class="lineno"> 3053</span>                        <span class="comment">!denh2o is used because layer thickness is not adjusted for freezing</span></div>
<div class="line"><a id="l03054" name="l03054"></a><span class="lineno"> 3054</span>             heatrem = min(heatavail - melt*hfus, 0._kind_lake)</div>
<div class="line"><a id="l03055" name="l03055"></a><span class="lineno"> 3055</span>                       <span class="comment">!catch small positive value to keep t at tfrz</span></div>
<div class="line"><a id="l03056" name="l03056"></a><span class="lineno"> 3056</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03057" name="l03057"></a><span class="lineno"> 3057</span>          <span class="comment">! Update temperature and ice fraction.</span></div>
<div class="line"><a id="l03058" name="l03058"></a><span class="lineno"> 3058</span>          <span class="keywordflow">if</span> (dophasechangeflag) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03059" name="l03059"></a><span class="lineno"> 3059</span>             lake_icefrac(c,j) = lake_icefrac(c,j) - melt/(denh2o*dz_lake(c,j))</div>
<div class="line"><a id="l03060" name="l03060"></a><span class="lineno"> 3060</span>             lhabs(c) = lhabs(c) + melt*hfus</div>
<div class="line"><a id="l03061" name="l03061"></a><span class="lineno"> 3061</span>          <span class="comment">! Update heat capacity</span></div>
<div class="line"><a id="l03062" name="l03062"></a><span class="lineno"> 3062</span>             cv_lake(c,j) = cv_lake(c,j) + melt*(cpliq-cpice)</div>
<div class="line"><a id="l03063" name="l03063"></a><span class="lineno"> 3063</span>             t_lake(c,j) = tfrz + heatrem/cv_lake(c,j)</div>
<div class="line"><a id="l03064" name="l03064"></a><span class="lineno"> 3064</span>             <span class="comment">! Prevent tiny residuals</span></div>
<div class="line"><a id="l03065" name="l03065"></a><span class="lineno"> 3065</span>             <span class="keywordflow">if</span> (lake_icefrac(c,j) &gt; 1._kind_lake - smallnumber) lake_icefrac(c,j) = 1._kind_lake</div>
<div class="line"><a id="l03066" name="l03066"></a><span class="lineno"> 3066</span>             <span class="keywordflow">if</span> (lake_icefrac(c,j) &lt; smallnumber)         lake_icefrac(c,j) = 0._kind_lake</div>
<div class="line"><a id="l03067" name="l03067"></a><span class="lineno"> 3067</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03068" name="l03068"></a><span class="lineno"> 3068</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03069" name="l03069"></a><span class="lineno"> 3069</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03070" name="l03070"></a><span class="lineno"> 3070</span> </div>
<div class="line"><a id="l03071" name="l03071"></a><span class="lineno"> 3071</span>    <span class="comment">! Snow &amp; soil phase change</span></div>
<div class="line"><a id="l03072" name="l03072"></a><span class="lineno"> 3072</span> </div>
<div class="line"><a id="l03073" name="l03073"></a><span class="lineno"> 3073</span>    <span class="keywordflow">do</span> j = -nlevsnow+1,nlevsoil</div>
<div class="line"><a id="l03074" name="l03074"></a><span class="lineno"> 3074</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03075" name="l03075"></a><span class="lineno"> 3075</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03076" name="l03076"></a><span class="lineno"> 3076</span>       <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l03077" name="l03077"></a><span class="lineno"> 3077</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l03078" name="l03078"></a><span class="lineno"> 3078</span>          dophasechangeflag = .false.</div>
<div class="line"><a id="l03079" name="l03079"></a><span class="lineno"> 3079</span> </div>
<div class="line"><a id="l03080" name="l03080"></a><span class="lineno"> 3080</span>          <span class="keywordflow">if</span> (j &gt;= snl(c) + 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03081" name="l03081"></a><span class="lineno"> 3081</span> </div>
<div class="line"><a id="l03082" name="l03082"></a><span class="lineno"> 3082</span>             <span class="keywordflow">if</span> (t_soisno(c,j) &gt; tfrz .and. h2osoi_ice(c,j) &gt; 0._kind_lake) <span class="keywordflow">then</span> <span class="comment">! melting</span></div>
<div class="line"><a id="l03083" name="l03083"></a><span class="lineno"> 3083</span>                dophasechangeflag = .true.</div>
<div class="line"><a id="l03084" name="l03084"></a><span class="lineno"> 3084</span>                heatavail = (t_soisno(c,j) - tfrz) * cv(c,j)</div>
<div class="line"><a id="l03085" name="l03085"></a><span class="lineno"> 3085</span>                melt = min(h2osoi_ice(c,j), heatavail/hfus)</div>
<div class="line"><a id="l03086" name="l03086"></a><span class="lineno"> 3086</span>                heatrem = max(heatavail - melt*hfus, 0._kind_lake)</div>
<div class="line"><a id="l03087" name="l03087"></a><span class="lineno"> 3087</span>                          <span class="comment">!catch small negative value to keep t at tfrz</span></div>
<div class="line"><a id="l03088" name="l03088"></a><span class="lineno"> 3088</span>                <span class="keywordflow">if</span> (j &lt;= 0) <span class="keywordflow">then</span> <span class="comment">!snow</span></div>
<div class="line"><a id="l03089" name="l03089"></a><span class="lineno"> 3089</span>                   imelt(c,j) = 1</div>
<div class="line"><a id="l03090" name="l03090"></a><span class="lineno"> 3090</span>                   qflx_snomelt(c) = qflx_snomelt(c) + melt</div>
<div class="line"><a id="l03091" name="l03091"></a><span class="lineno"> 3091</span><span class="keywordflow">                end if</span></div>
<div class="line"><a id="l03092" name="l03092"></a><span class="lineno"> 3092</span>             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (t_soisno(c,j) &lt; tfrz .and. h2osoi_liq(c,j) &gt; 0._kind_lake) <span class="keywordflow">then</span> <span class="comment">!freezing</span></div>
<div class="line"><a id="l03093" name="l03093"></a><span class="lineno"> 3093</span>                dophasechangeflag = .true.</div>
<div class="line"><a id="l03094" name="l03094"></a><span class="lineno"> 3094</span>                heatavail = (t_soisno(c,j) - tfrz) * cv(c,j)</div>
<div class="line"><a id="l03095" name="l03095"></a><span class="lineno"> 3095</span>                melt = max(-h2osoi_liq(c,j), heatavail/hfus)</div>
<div class="line"><a id="l03096" name="l03096"></a><span class="lineno"> 3096</span>                heatrem = min(heatavail - melt*hfus, 0._kind_lake)</div>
<div class="line"><a id="l03097" name="l03097"></a><span class="lineno"> 3097</span>                          <span class="comment">!catch small positive value to keep t at tfrz</span></div>
<div class="line"><a id="l03098" name="l03098"></a><span class="lineno"> 3098</span>                <span class="keywordflow">if</span> (j &lt;= 0) <span class="keywordflow">then</span> <span class="comment">!snow</span></div>
<div class="line"><a id="l03099" name="l03099"></a><span class="lineno"> 3099</span>                   imelt(c,j) = 2</div>
<div class="line"><a id="l03100" name="l03100"></a><span class="lineno"> 3100</span>                   qflx_snomelt(c) = qflx_snomelt(c) + melt</div>
<div class="line"><a id="l03101" name="l03101"></a><span class="lineno"> 3101</span>                   <span class="comment">! Does this works for both signs of melt in SnowHydrology? I think</span></div>
<div class="line"><a id="l03102" name="l03102"></a><span class="lineno"> 3102</span>                   <span class="comment">! qflx_snomelt(c) is just output.</span></div>
<div class="line"><a id="l03103" name="l03103"></a><span class="lineno"> 3103</span><span class="keywordflow">                end if</span></div>
<div class="line"><a id="l03104" name="l03104"></a><span class="lineno"> 3104</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l03105" name="l03105"></a><span class="lineno"> 3105</span> </div>
<div class="line"><a id="l03106" name="l03106"></a><span class="lineno"> 3106</span>             <span class="comment">! Update temperature and soil components.</span></div>
<div class="line"><a id="l03107" name="l03107"></a><span class="lineno"> 3107</span>             <span class="keywordflow">if</span> (dophasechangeflag) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03108" name="l03108"></a><span class="lineno"> 3108</span>                h2osoi_ice(c,j) = h2osoi_ice(c,j) - melt</div>
<div class="line"><a id="l03109" name="l03109"></a><span class="lineno"> 3109</span>                h2osoi_liq(c,j) = h2osoi_liq(c,j) + melt</div>
<div class="line"><a id="l03110" name="l03110"></a><span class="lineno"> 3110</span>                lhabs(c) = lhabs(c) + melt*hfus</div>
<div class="line"><a id="l03111" name="l03111"></a><span class="lineno"> 3111</span>             <span class="comment">! Update heat capacity</span></div>
<div class="line"><a id="l03112" name="l03112"></a><span class="lineno"> 3112</span>                cv(c,j) = cv(c,j) + melt*(cpliq-cpice)</div>
<div class="line"><a id="l03113" name="l03113"></a><span class="lineno"> 3113</span>                t_soisno(c,j) = tfrz + heatrem/cv(c,j)</div>
<div class="line"><a id="l03114" name="l03114"></a><span class="lineno"> 3114</span>                <span class="comment">! Prevent tiny residuals</span></div>
<div class="line"><a id="l03115" name="l03115"></a><span class="lineno"> 3115</span>                <span class="keywordflow">if</span> (h2osoi_ice(c,j) &lt; smallnumber) h2osoi_ice(c,j) = 0._kind_lake</div>
<div class="line"><a id="l03116" name="l03116"></a><span class="lineno"> 3116</span>                <span class="keywordflow">if</span> (h2osoi_liq(c,j) &lt; smallnumber) h2osoi_liq(c,j) = 0._kind_lake</div>
<div class="line"><a id="l03117" name="l03117"></a><span class="lineno"> 3117</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l03118" name="l03118"></a><span class="lineno"> 3118</span> </div>
<div class="line"><a id="l03119" name="l03119"></a><span class="lineno"> 3119</span><span class="keywordflow">         end if</span></div>
<div class="line"><a id="l03120" name="l03120"></a><span class="lineno"> 3120</span><span class="keywordflow">      end do</span></div>
<div class="line"><a id="l03121" name="l03121"></a><span class="lineno"> 3121</span><span class="keywordflow">   end do</span></div>
<div class="line"><a id="l03122" name="l03122"></a><span class="lineno"> 3122</span> </div>
<div class="line"><a id="l03123" name="l03123"></a><span class="lineno"> 3123</span>   <span class="comment">! Update eflx_snomelt(c)</span></div>
<div class="line"><a id="l03124" name="l03124"></a><span class="lineno"> 3124</span>   <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03125" name="l03125"></a><span class="lineno"> 3125</span>   <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03126" name="l03126"></a><span class="lineno"> 3126</span>    <span class="keywordflow">do</span> fc = 1,num_shlakec</div>
<div class="line"><a id="l03127" name="l03127"></a><span class="lineno"> 3127</span>       c = filter_shlakec(fc)</div>
<div class="line"><a id="l03128" name="l03128"></a><span class="lineno"> 3128</span>       eflx_snomelt(c) = qflx_snomelt(c)*hfus</div>
<div class="line"><a id="l03129" name="l03129"></a><span class="lineno"> 3129</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03130" name="l03130"></a><span class="lineno"> 3130</span>   <span class="comment">!!!</span></div>
<div class="line"><a id="l03131" name="l03131"></a><span class="lineno"> 3131</span> </div>
</div>
<div class="line"><a id="l03132" name="l03132"></a><span class="lineno"> 3132</span>   <span class="keyword">end subroutine </span>phasechange_lake</div>
<div class="line"><a id="l03133" name="l03133"></a><span class="lineno"> 3133</span> </div>
<div class="line"><a id="l03134" name="l03134"></a><span class="lineno"> 3134</span>    <span class="comment">! DESCRIPTION:</span><span class="comment"></span></div>
<div class="line"><a id="l03135" name="l03135"></a><span class="lineno"> 3135</span><span class="comment">    !&gt; Calculation of Shallow Lake Hydrology. Full hydrology of snow layers is</span></div>
<div class="line"><a id="l03136" name="l03136"></a><span class="lineno"> 3136</span><span class="comment">    !! done. However, there is no infiltration, and the water budget is balanced with</span></div>
<div class="line"><a id="l03137" name="l03137"></a><span class="lineno"> 3137</span><span class="comment">    !! qflx_qrgwl. Lake water mass is kept constant. The soil is simply maintained at</span></div>
<div class="line"><a id="l03138" name="l03138"></a><span class="lineno"> 3138</span><span class="comment">    !! volumetric saturation if ice melting frees up pore space. Likewise, if the water</span></div>
<div class="line"><a id="l03139" name="l03139"></a><span class="lineno"> 3139</span><span class="comment">    !! portion alone at some point exceeds pore capacity, it is reduced. This is consistent</span></div>
<div class="line"><a id="l03140" name="l03140"></a><span class="lineno"> 3140</span><span class="comment">    !! with the possibility of initializing the soil layer with excess ice. The only</span></div>
<div class="line"><a id="l03141" name="l03141"></a><span class="lineno"> 3141</span><span class="comment">    !! real error with that is that the thermal conductivity will ignore the excess ice</span></div>
<div class="line"><a id="l03142" name="l03142"></a><span class="lineno"> 3142</span><span class="comment">    !! (and accompanying thickness change).</span></div>
<div class="line"><a id="l03143" name="l03143"></a><span class="lineno"> 3143</span><span class="comment">    !!</span></div>
<div class="line"><a id="l03144" name="l03144"></a><span class="lineno"> 3144</span><span class="comment">    !! If snow layers are present over an unfrozen lake, and the top layer of the lake</span></div>
<div class="line"><a id="l03145" name="l03145"></a><span class="lineno"> 3145</span><span class="comment">    !! is capable of absorbing the latent heat without going below freezing,</span></div>
<div class="line"><a id="l03146" name="l03146"></a><span class="lineno"> 3146</span><span class="comment">    !! the snow-water is runoff and the latent heat is subtracted from the lake.</span></div>
<div class="foldopen" id="foldopen03147" data-start="" data-end="">
<div class="line"><a id="l03147" name="l03147"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a8880c2394213f41e2e8303f2fa89ed61.html#a8880c2394213f41e2e8303f2fa89ed61"> 3147</a></span>  <span class="keyword">subroutine </span>shallakehydrology(dz_lake,forc_rain,forc_snow,                      &amp; !i</div>
<div class="line"><a id="l03148" name="l03148"></a><span class="lineno"> 3148</span>                               begwb,qflx_evap_tot,forc_t,do_capsnow,            &amp;</div>
<div class="line"><a id="l03149" name="l03149"></a><span class="lineno"> 3149</span>                               t_grnd,qflx_evap_soi,                             &amp;</div>
<div class="line"><a id="l03150" name="l03150"></a><span class="lineno"> 3150</span>                               qflx_snomelt,imelt,frac_iceold,                   &amp; !i add by guhp</div>
<div class="line"><a id="l03151" name="l03151"></a><span class="lineno"> 3151</span>                               z,dz,zi,snl,h2osno,snowdp,lake_icefrac,t_lake,      &amp; !i&amp;o</div>
<div class="line"><a id="l03152" name="l03152"></a><span class="lineno"> 3152</span>                               endwb,snowage,snowice,snowliq,t_snow,             &amp; !o</div>
<div class="line"><a id="l03153" name="l03153"></a><span class="lineno"> 3153</span>                               t_soisno,h2osoi_ice,h2osoi_liq,h2osoi_vol,        &amp;</div>
<div class="line"><a id="l03154" name="l03154"></a><span class="lineno"> 3154</span>                               qflx_drain,qflx_surf,qflx_infl,qflx_qrgwl,        &amp;</div>
<div class="line"><a id="l03155" name="l03155"></a><span class="lineno"> 3155</span>                               qcharge,qflx_prec_grnd,qflx_snowcap,              &amp;</div>
<div class="line"><a id="l03156" name="l03156"></a><span class="lineno"> 3156</span>                               qflx_snowcap_col,qflx_snow_grnd_pft,              &amp;</div>
<div class="line"><a id="l03157" name="l03157"></a><span class="lineno"> 3157</span>                               qflx_snow_grnd_col,qflx_rain_grnd,                &amp;</div>
<div class="line"><a id="l03158" name="l03158"></a><span class="lineno"> 3158</span>                               qflx_evap_tot_col,soilalpha,zwt,fcov,             &amp;</div>
<div class="line"><a id="l03159" name="l03159"></a><span class="lineno"> 3159</span>                               rootr_column,qflx_evap_grnd,qflx_sub_snow,        &amp;</div>
<div class="line"><a id="l03160" name="l03160"></a><span class="lineno"> 3160</span>                               qflx_dew_snow,qflx_dew_grnd,qflx_rain_grnd_col,   &amp;</div>
<div class="line"><a id="l03161" name="l03161"></a><span class="lineno"> 3161</span>                               watsat, tksatu, tkmg, tkdry, csol,                &amp;</div>
<div class="line"><a id="l03162" name="l03162"></a><span class="lineno"> 3162</span>                               dtime,errmsg,errflg)</div>
<div class="line"><a id="l03163" name="l03163"></a><span class="lineno"> 3163</span>                       </div>
<div class="line"><a id="l03164" name="l03164"></a><span class="lineno"> 3164</span>    <span class="comment">!==================================================================================</span></div>
<div class="line"><a id="l03165" name="l03165"></a><span class="lineno"> 3165</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03166" name="l03166"></a><span class="lineno"> 3166</span>    <span class="comment">! WARNING: This subroutine assumes lake columns have one and only one pft.</span></div>
<div class="line"><a id="l03167" name="l03167"></a><span class="lineno"> 3167</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03168" name="l03168"></a><span class="lineno"> 3168</span>    <span class="comment">! Sequence is:</span></div>
<div class="line"><a id="l03169" name="l03169"></a><span class="lineno"> 3169</span>    <span class="comment">!  ShalLakeHydrology:</span></div>
<div class="line"><a id="l03170" name="l03170"></a><span class="lineno"> 3170</span>    <span class="comment">!    Do needed tasks from Hydrology1, Biogeophysics2, &amp; top of Hydrology2.</span></div>
<div class="line"><a id="l03171" name="l03171"></a><span class="lineno"> 3171</span>    <span class="comment">!    -&gt; SnowWater:             change of snow mass and snow water onto soil</span></div>
<div class="line"><a id="l03172" name="l03172"></a><span class="lineno"> 3172</span>    <span class="comment">!    -&gt; SnowCompaction:        compaction of snow layers</span></div>
<div class="line"><a id="l03173" name="l03173"></a><span class="lineno"> 3173</span>    <span class="comment">!    -&gt; CombineSnowLayers:     combine snow layers that are thinner than minimum</span></div>
<div class="line"><a id="l03174" name="l03174"></a><span class="lineno"> 3174</span>    <span class="comment">!    -&gt; DivideSnowLayers:      subdivide snow layers that are thicker than maximum</span></div>
<div class="line"><a id="l03175" name="l03175"></a><span class="lineno"> 3175</span>    <span class="comment">!    Add water to soil if melting has left it with open pore space.</span></div>
<div class="line"><a id="l03176" name="l03176"></a><span class="lineno"> 3176</span>    <span class="comment">!    Cleanup and do water balance.</span></div>
<div class="line"><a id="l03177" name="l03177"></a><span class="lineno"> 3177</span>    <span class="comment">!    If snow layers are found above a lake with unfrozen top layer, whose top</span></div>
<div class="line"><a id="l03178" name="l03178"></a><span class="lineno"> 3178</span>    <span class="comment">!    layer has enough heat to melt all the snow ice without freezing, do so</span></div>
<div class="line"><a id="l03179" name="l03179"></a><span class="lineno"> 3179</span>    <span class="comment">!    and eliminate the snow layers.</span></div>
<div class="line"><a id="l03180" name="l03180"></a><span class="lineno"> 3180</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03181" name="l03181"></a><span class="lineno"> 3181</span>    <span class="comment">! !REVISION HISTORY:</span></div>
<div class="line"><a id="l03182" name="l03182"></a><span class="lineno"> 3182</span>    <span class="comment">! Created by Zack Subin, 2009</span></div>
<div class="line"><a id="l03183" name="l03183"></a><span class="lineno"> 3183</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03184" name="l03184"></a><span class="lineno"> 3184</span>    <span class="comment">!============================================================================================</span></div>
<div class="line"><a id="l03185" name="l03185"></a><span class="lineno"> 3185</span>    </div>
<div class="line"><a id="l03186" name="l03186"></a><span class="lineno"> 3186</span>    <span class="comment">! USES:</span></div>
<div class="line"><a id="l03187" name="l03187"></a><span class="lineno"> 3187</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03188" name="l03188"></a><span class="lineno"> 3188</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l03189" name="l03189"></a><span class="lineno"> 3189</span> </div>
<div class="line"><a id="l03190" name="l03190"></a><span class="lineno"> 3190</span>    <span class="comment">! in:</span></div>
<div class="line"><a id="l03191" name="l03191"></a><span class="lineno"> 3191</span> </div>
<div class="line"><a id="l03192" name="l03192"></a><span class="lineno"> 3192</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: errflg</div>
<div class="line"><a id="l03193" name="l03193"></a><span class="lineno"> 3193</span>    <span class="keywordtype">character(*)</span>, <span class="keywordtype">intent(inout)</span> :: errmsg</div>
<div class="line"><a id="l03194" name="l03194"></a><span class="lineno"> 3194</span> </div>
<div class="line"><a id="l03195" name="l03195"></a><span class="lineno"> 3195</span><span class="keywordtype">    real</span>(kind_lake) :: watsat(1,nlevsoil)<span class="comment">      !&lt; volumetric soil water at saturation (porosity)</span></div>
<div class="line"><a id="l03196" name="l03196"></a><span class="lineno"> 3196</span><span class="keywordtype">    real</span>(kind_lake) :: tksatu(1,nlevsoil)<span class="comment">      !&lt; thermal conductivity, saturated soil [W/m-K]</span></div>
<div class="line"><a id="l03197" name="l03197"></a><span class="lineno"> 3197</span><span class="keywordtype">    real</span>(kind_lake) :: tkmg(1,nlevsoil)<span class="comment">        !&lt; thermal conductivity, soil minerals  [W/m-K]</span></div>
<div class="line"><a id="l03198" name="l03198"></a><span class="lineno"> 3198</span><span class="keywordtype">    real</span>(kind_lake) :: tkdry(1,nlevsoil)<span class="comment">       !&lt; thermal conductivity, dry soil (W/m/Kelvin)</span></div>
<div class="line"><a id="l03199" name="l03199"></a><span class="lineno"> 3199</span><span class="keywordtype">    real</span>(kind_lake) :: csol(1,nlevsoil)<span class="comment">        !&lt; heat capacity, soil solids (J/m**3/Kelvin)</span></div>
<div class="line"><a id="l03200" name="l03200"></a><span class="lineno"> 3200</span> </div>
<div class="line"><a id="l03201" name="l03201"></a><span class="lineno"> 3201</span>   <span class="comment">! integer , intent(in) :: clandunit(1)     !&lt; column&#39;s landunit</span></div>
<div class="line"><a id="l03202" name="l03202"></a><span class="lineno"> 3202</span>   <span class="comment">! integer , intent(in) :: ityplun(1)       !&lt; landunit type</span></div>
<div class="line"><a id="l03203" name="l03203"></a><span class="lineno"> 3203</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: dtime<span class="comment">      !&lt; timestep</span></div>
<div class="line"><a id="l03204" name="l03204"></a><span class="lineno"> 3204</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: dz_lake(1,nlevlake)<span class="comment">     !&lt; layer thickness for lake (m)</span></div>
<div class="line"><a id="l03205" name="l03205"></a><span class="lineno"> 3205</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: forc_rain(1)<span class="comment">     !&lt; rain rate [mm/s]</span></div>
<div class="line"><a id="l03206" name="l03206"></a><span class="lineno"> 3206</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: forc_snow(1)<span class="comment">     !&lt; snow rate [mm/s]</span></div>
<div class="line"><a id="l03207" name="l03207"></a><span class="lineno"> 3207</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: qflx_evap_tot(1)<span class="comment"> !&lt; qflx_evap_soi + qflx_evap_veg + qflx_tran_veg</span></div>
<div class="line"><a id="l03208" name="l03208"></a><span class="lineno"> 3208</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: forc_t(1)<span class="comment">        !&lt; atmospheric temperature (Kelvin)</span></div>
<div class="line"><a id="l03209" name="l03209"></a><span class="lineno"> 3209</span> </div>
<div class="line"><a id="l03210" name="l03210"></a><span class="lineno"> 3210</span>    <span class="comment">!real(kind_lake), intent(in),optional :: flfall(1)        !&lt; fraction of liquid water within falling precipitation (unused)</span></div>
<div class="line"><a id="l03211" name="l03211"></a><span class="lineno"> 3211</span> </div>
<div class="line"><a id="l03212" name="l03212"></a><span class="lineno"> 3212</span>    <span class="keywordtype">logical</span> , <span class="keywordtype">intent(in)</span> :: do_capsnow(1)<span class="comment">     !&lt; true =&gt; do snow capping</span></div>
<div class="line"><a id="l03213" name="l03213"></a><span class="lineno"> 3213</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: t_grnd(1)<span class="comment">          !&lt; ground temperature (Kelvin)</span></div>
<div class="line"><a id="l03214" name="l03214"></a><span class="lineno"> 3214</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: qflx_evap_soi(1)<span class="comment">   !&lt; soil evaporation (mm H2O/s) (+ = to atm)</span></div>
<div class="line"><a id="l03215" name="l03215"></a><span class="lineno"> 3215</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: qflx_snomelt(1)<span class="comment">     !&lt; snow melt (mm H2O /s)</span></div>
<div class="line"><a id="l03216" name="l03216"></a><span class="lineno"> 3216</span>    <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in)</span> :: imelt(1,-nlevsnow+1:nlevsoil)<span class="comment">        !&lt; flag for melting (=1), freezing (=2), Not=0</span></div>
<div class="line"><a id="l03217" name="l03217"></a><span class="lineno"> 3217</span> </div>
<div class="line"><a id="l03218" name="l03218"></a><span class="lineno"> 3218</span>    <span class="comment">!inout:</span></div>
<div class="line"><a id="l03219" name="l03219"></a><span class="lineno"> 3219</span> </div>
<div class="line"><a id="l03220" name="l03220"></a><span class="lineno"> 3220</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: begwb(1)<span class="comment">         !&lt; water mass begining of the time step</span></div>
<div class="line"><a id="l03221" name="l03221"></a><span class="lineno"> 3221</span> </div>
<div class="line"><a id="l03222" name="l03222"></a><span class="lineno"> 3222</span>    <span class="comment">! inout: </span></div>
<div class="line"><a id="l03223" name="l03223"></a><span class="lineno"> 3223</span> </div>
<div class="line"><a id="l03224" name="l03224"></a><span class="lineno"> 3224</span>    </div>
<div class="line"><a id="l03225" name="l03225"></a><span class="lineno"> 3225</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: z(1,-nlevsnow+1:nlevsoil)<span class="comment">           !&lt; layer depth  (m)</span></div>
<div class="line"><a id="l03226" name="l03226"></a><span class="lineno"> 3226</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: dz(1,-nlevsnow+1:nlevsoil)<span class="comment">          !&lt; layer thickness depth (m)</span></div>
<div class="line"><a id="l03227" name="l03227"></a><span class="lineno"> 3227</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: zi(1,-nlevsnow+0:nlevsoil)<span class="comment">          !&lt; interface depth (m)</span></div>
<div class="line"><a id="l03228" name="l03228"></a><span class="lineno"> 3228</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(inout)</span> :: snl(1)<span class="comment">           !&lt; number of snow layers</span></div>
<div class="line"><a id="l03229" name="l03229"></a><span class="lineno"> 3229</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osno(1)<span class="comment">        !&lt; snow water (mm H2O)</span></div>
<div class="line"><a id="l03230" name="l03230"></a><span class="lineno"> 3230</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: snowdp(1)<span class="comment">        !&lt; snow height (m)</span></div>
<div class="line"><a id="l03231" name="l03231"></a><span class="lineno"> 3231</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: lake_icefrac(1,nlevlake)<span class="comment">  !&lt; mass fraction of lake layer that is frozen</span></div>
<div class="line"><a id="l03232" name="l03232"></a><span class="lineno"> 3232</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: t_lake(1,nlevlake)<span class="comment">        !&lt; lake temperature (Kelvin)</span></div>
<div class="line"><a id="l03233" name="l03233"></a><span class="lineno"> 3233</span> </div>
<div class="line"><a id="l03234" name="l03234"></a><span class="lineno"> 3234</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: frac_iceold(1,-nlevsnow+1:nlevsoil)<span class="comment">      !&lt; fraction of ice relative to the tot water</span></div>
<div class="line"><a id="l03235" name="l03235"></a><span class="lineno"> 3235</span>    <span class="comment">! out: </span></div>
<div class="line"><a id="l03236" name="l03236"></a><span class="lineno"> 3236</span> </div>
<div class="line"><a id="l03237" name="l03237"></a><span class="lineno"> 3237</span> </div>
<div class="line"><a id="l03238" name="l03238"></a><span class="lineno"> 3238</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: endwb(1)<span class="comment">         !&lt; water mass end of the time step</span></div>
<div class="line"><a id="l03239" name="l03239"></a><span class="lineno"> 3239</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: snowage(1)<span class="comment">       !&lt; non dimensional snow age [-]</span></div>
<div class="line"><a id="l03240" name="l03240"></a><span class="lineno"> 3240</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: snowice(1)<span class="comment">       !&lt; average snow ice lens</span></div>
<div class="line"><a id="l03241" name="l03241"></a><span class="lineno"> 3241</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: snowliq(1)<span class="comment">       !&lt; average snow liquid water</span></div>
<div class="line"><a id="l03242" name="l03242"></a><span class="lineno"> 3242</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: t_snow(1)<span class="comment">        !&lt; vertically averaged snow temperature</span></div>
<div class="line"><a id="l03243" name="l03243"></a><span class="lineno"> 3243</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: t_soisno(1,-nlevsnow+1:nlevsoil)<span class="comment">    !&lt; snow temperature (Kelvin)</span></div>
<div class="line"><a id="l03244" name="l03244"></a><span class="lineno"> 3244</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: h2osoi_ice(1,-nlevsnow+1:nlevsoil)<span class="comment">  !&lt; ice lens (kg/m2)</span></div>
<div class="line"><a id="l03245" name="l03245"></a><span class="lineno"> 3245</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: h2osoi_liq(1,-nlevsnow+1:nlevsoil)<span class="comment">  !&lt; liquid water (kg/m2)</span></div>
<div class="line"><a id="l03246" name="l03246"></a><span class="lineno"> 3246</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: h2osoi_vol(1,-nlevsnow+1:nlevsoil)<span class="comment">  !&lt; volumetric soil water (0&lt;=h2osoi_vol&lt;=watsat)[m3/m3]</span></div>
<div class="line"><a id="l03247" name="l03247"></a><span class="lineno"> 3247</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_drain(1)<span class="comment">    !&lt; sub-surface runoff (mm H2O /s)</span></div>
<div class="line"><a id="l03248" name="l03248"></a><span class="lineno"> 3248</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_surf(1)<span class="comment">     !&lt; surface runoff (mm H2O /s)</span></div>
<div class="line"><a id="l03249" name="l03249"></a><span class="lineno"> 3249</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_infl(1)<span class="comment">     !&lt; infiltration (mm H2O /s)</span></div>
<div class="line"><a id="l03250" name="l03250"></a><span class="lineno"> 3250</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_qrgwl(1)<span class="comment">    !&lt; qflx_surf at glaciers, wetlands, lakes</span></div>
<div class="line"><a id="l03251" name="l03251"></a><span class="lineno"> 3251</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qcharge(1)<span class="comment">       !&lt; aquifer recharge rate (mm/s)</span></div>
<div class="line"><a id="l03252" name="l03252"></a><span class="lineno"> 3252</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_prec_grnd(1)<span class="comment">     !&lt; water onto ground including canopy runoff [kg/(m2 s)]</span></div>
<div class="line"><a id="l03253" name="l03253"></a><span class="lineno"> 3253</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_snowcap(1)<span class="comment">       !&lt; excess precipitation due to snow capping (mm H2O /s) [+]</span></div>
<div class="line"><a id="l03254" name="l03254"></a><span class="lineno"> 3254</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_snowcap_col(1)<span class="comment">   !&lt; excess precipitation due to snow capping (mm H2O /s) [+]</span></div>
<div class="line"><a id="l03255" name="l03255"></a><span class="lineno"> 3255</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_snow_grnd_pft(1)<span class="comment"> !&lt; snow on ground after interception (mm H2O/s) [+]</span></div>
<div class="line"><a id="l03256" name="l03256"></a><span class="lineno"> 3256</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_snow_grnd_col(1)<span class="comment"> !&lt; snow on ground after interception (mm H2O/s) [+]</span></div>
<div class="line"><a id="l03257" name="l03257"></a><span class="lineno"> 3257</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_rain_grnd(1)<span class="comment">     !&lt; rain on ground after interception (mm H2O/s) [+]</span></div>
<div class="line"><a id="l03258" name="l03258"></a><span class="lineno"> 3258</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_evap_tot_col(1)<span class="comment"> !&lt; pft quantity averaged to the column (assuming one pft)</span></div>
<div class="line"><a id="l03259" name="l03259"></a><span class="lineno"> 3259</span><span class="keywordtype">    real</span>(kind_lake) ,<span class="keywordtype">intent(out)</span> :: soilalpha(1)<span class="comment">     !&lt; factor that reduces ground saturated specific humidity (-)</span></div>
<div class="line"><a id="l03260" name="l03260"></a><span class="lineno"> 3260</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: zwt(1)<span class="comment">           !&lt; water table depth</span></div>
<div class="line"><a id="l03261" name="l03261"></a><span class="lineno"> 3261</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: fcov(1)<span class="comment">          !&lt; fractional area with water table at surface</span></div>
<div class="line"><a id="l03262" name="l03262"></a><span class="lineno"> 3262</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: rootr_column(1,1:nlevsoil)<span class="comment"> !&lt; effective fraction of roots in each soil layer</span></div>
<div class="line"><a id="l03263" name="l03263"></a><span class="lineno"> 3263</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_evap_grnd(1)<span class="comment">  !&lt; ground surface evaporation rate (mm H2O/s) [+]</span></div>
<div class="line"><a id="l03264" name="l03264"></a><span class="lineno"> 3264</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_sub_snow(1)<span class="comment">   !&lt; sublimation rate from snow pack (mm H2O /s) [+]</span></div>
<div class="line"><a id="l03265" name="l03265"></a><span class="lineno"> 3265</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_dew_snow(1)<span class="comment">   !&lt; surface dew added to snow pack (mm H2O /s) [+]</span></div>
<div class="line"><a id="l03266" name="l03266"></a><span class="lineno"> 3266</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_dew_grnd(1)<span class="comment">   !&lt; ground surface dew formation (mm H2O /s) [+]</span></div>
<div class="line"><a id="l03267" name="l03267"></a><span class="lineno"> 3267</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_rain_grnd_col(1)<span class="comment">   !&lt; rain on ground after interception (mm H2O/s) [+]</span></div>
<div class="line"><a id="l03268" name="l03268"></a><span class="lineno"> 3268</span> </div>
<div class="line"><a id="l03269" name="l03269"></a><span class="lineno"> 3269</span>    <span class="comment">! Block of biogeochem currently not used.</span></div>
<div class="line"><a id="l03270" name="l03270"></a><span class="lineno"> 3270</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">pointer</span> :: sucsat(:,:)      <span class="comment">! minimum soil suction (mm)</span></div>
<div class="line"><a id="l03271" name="l03271"></a><span class="lineno"> 3271</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">pointer</span> :: bsw(:,:)         <span class="comment">! Clapp and Hornberger &quot;b&quot;</span></div>
<div class="line"><a id="l03272" name="l03272"></a><span class="lineno"> 3272</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">pointer</span> :: bsw2(:,:)        <span class="comment">! Clapp and Hornberger &quot;b&quot; for CN code</span></div>
<div class="line"><a id="l03273" name="l03273"></a><span class="lineno"> 3273</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">pointer</span> :: psisat(:,:)      <span class="comment">! soil water potential at saturation for CN code (MPa)</span></div>
<div class="line"><a id="l03274" name="l03274"></a><span class="lineno"> 3274</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">pointer</span> :: vwcsat(:,:)      <span class="comment">! volumetric water content at saturation for CN code (m3/m3)</span></div>
<div class="line"><a id="l03275" name="l03275"></a><span class="lineno"> 3275</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">pointer</span> :: wf(:)            <span class="comment">! soil water as frac. of whc for top 0.5 m</span></div>
<div class="line"><a id="l03276" name="l03276"></a><span class="lineno"> 3276</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">pointer</span> :: soilpsi(:,:)     <span class="comment">! soil water potential in each soil layer (MPa)</span></div>
<div class="line"><a id="l03277" name="l03277"></a><span class="lineno"> 3277</span> </div>
<div class="line"><a id="l03278" name="l03278"></a><span class="lineno"> 3278</span>    <span class="comment">! OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l03279" name="l03279"></a><span class="lineno"> 3279</span> </div>
<div class="line"><a id="l03280" name="l03280"></a><span class="lineno"> 3280</span>    <span class="keywordtype">integer</span>  :: p,fp,g,l,c,j,fc,jtop             <span class="comment">! indices</span></div>
<div class="line"><a id="l03281" name="l03281"></a><span class="lineno"> 3281</span>    <span class="keywordtype">integer</span>  :: num_shlakesnowc                  <span class="comment">! number of column snow points</span></div>
<div class="line"><a id="l03282" name="l03282"></a><span class="lineno"> 3282</span>    <span class="keywordtype">integer</span>  :: filter_shlakesnowc(ubc-lbc+1)    <span class="comment">! column filter for snow points</span></div>
<div class="line"><a id="l03283" name="l03283"></a><span class="lineno"> 3283</span>    <span class="keywordtype">integer</span>  :: num_shlakenosnowc                <span class="comment">! number of column non-snow points</span></div>
<div class="line"><a id="l03284" name="l03284"></a><span class="lineno"> 3284</span>    <span class="keywordtype">integer</span>  :: filter_shlakenosnowc(ubc-lbc+1)  <span class="comment">! column filter for non-snow points</span></div>
<div class="line"><a id="l03285" name="l03285"></a><span class="lineno"> 3285</span>    <span class="keywordtype">integer</span>  :: newnode                      <span class="comment">! flag when new snow node is set, (1=yes, 0=no)</span></div>
<div class="line"><a id="l03286" name="l03286"></a><span class="lineno"> 3286</span><span class="keywordtype">    real</span>(kind_lake) :: dz_snowf                     <span class="comment">! layer thickness rate change due to precipitation [mm/s]</span></div>
<div class="line"><a id="l03287" name="l03287"></a><span class="lineno"> 3287</span><span class="keywordtype">    real</span>(kind_lake) :: bifall                       <span class="comment">! bulk density of newly fallen dry snow [kg/m3]</span></div>
<div class="line"><a id="l03288" name="l03288"></a><span class="lineno"> 3288</span><span class="keywordtype">    real</span>(kind_lake) :: fracsnow(lbp:ubp)            <span class="comment">! frac of precipitation that is snow</span></div>
<div class="line"><a id="l03289" name="l03289"></a><span class="lineno"> 3289</span><span class="keywordtype">    real</span>(kind_lake) :: fracrain(lbp:ubp)            <span class="comment">! frac of precipitation that is rain</span></div>
<div class="line"><a id="l03290" name="l03290"></a><span class="lineno"> 3290</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_prec_grnd_snow(lbp:ubp) <span class="comment">! snow precipitation incident on ground [mm/s]</span></div>
<div class="line"><a id="l03291" name="l03291"></a><span class="lineno"> 3291</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_prec_grnd_rain(lbp:ubp) <span class="comment">! rain precipitation incident on ground [mm/s]</span></div>
<div class="line"><a id="l03292" name="l03292"></a><span class="lineno"> 3292</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_evap_soi_lim            <span class="comment">! temporary evap_soi limited by top snow layer content [mm/s]</span></div>
<div class="line"><a id="l03293" name="l03293"></a><span class="lineno"> 3293</span><span class="keywordtype">    real</span>(kind_lake) :: h2osno_temp                  <span class="comment">! temporary h2osno [kg/m^2]</span></div>
<div class="line"><a id="l03294" name="l03294"></a><span class="lineno"> 3294</span><span class="keywordtype">    real</span>(kind_lake) :: sumsnowice(lbc:ubc)             <span class="comment">! sum of snow ice if snow layers found above unfrozen lake [kg/m&amp;2]</span></div>
<div class="line"><a id="l03295" name="l03295"></a><span class="lineno"> 3295</span>    <span class="keywordtype">logical</span>  :: unfrozen(lbc:ubc)            <span class="comment">! true if top lake layer is unfrozen with snow layers above</span></div>
<div class="line"><a id="l03296" name="l03296"></a><span class="lineno"> 3296</span><span class="keywordtype">    real</span>(kind_lake) :: heatrem                      <span class="comment">! used in case above [J/m^2]</span></div>
<div class="line"><a id="l03297" name="l03297"></a><span class="lineno"> 3297</span><span class="keywordtype">    real</span>(kind_lake) :: heatsum(lbc:ubc)             <span class="comment">! used in case above [J/m^2]</span></div>
<div class="line"><a id="l03298" name="l03298"></a><span class="lineno"> 3298</span><span class="keywordtype">    real</span>(kind_lake) :: qflx_top_soil(1)     <span class="comment">!net water input into soil from top (mm/s)</span></div>
<div class="line"><a id="l03299" name="l03299"></a><span class="lineno"> 3299</span>    <span class="keywordtype">character*256</span> :: message </div>
<div class="line"><a id="l03300" name="l03300"></a><span class="lineno"> 3300</span> </div>
<div class="line"><a id="l03301" name="l03301"></a><span class="lineno"> 3301</span><span class="keywordtype">    real</span>(kind_lake),<span class="keywordtype">allocatable</span> :: snow_water(:)           <span class="comment">! temporary sum of snow water for Bal Check [kg/m^2]</span></div>
<div class="line"><a id="l03302" name="l03302"></a><span class="lineno"> 3302</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03303" name="l03303"></a><span class="lineno"> 3303</span> </div>
<div class="line"><a id="l03304" name="l03304"></a><span class="lineno"> 3304</span>    <span class="comment">! Determine step size</span></div>
<div class="line"><a id="l03305" name="l03305"></a><span class="lineno"> 3305</span> </div>
<div class="line"><a id="l03306" name="l03306"></a><span class="lineno"> 3306</span>    <span class="comment">! Add soil water to water balance.</span></div>
<div class="line"><a id="l03307" name="l03307"></a><span class="lineno"> 3307</span>    <span class="keywordflow">do</span> j = 1, nlevsoil</div>
<div class="line"><a id="l03308" name="l03308"></a><span class="lineno"> 3308</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03309" name="l03309"></a><span class="lineno"> 3309</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03310" name="l03310"></a><span class="lineno"> 3310</span>      <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l03311" name="l03311"></a><span class="lineno"> 3311</span>         c = filter_shlakec(fc)</div>
<div class="line"><a id="l03312" name="l03312"></a><span class="lineno"> 3312</span>         begwb(c) = begwb(c) + h2osoi_ice(c,j) + h2osoi_liq(c,j)</div>
<div class="line"><a id="l03313" name="l03313"></a><span class="lineno"> 3313</span><span class="keywordflow">      end do</span></div>
<div class="line"><a id="l03314" name="l03314"></a><span class="lineno"> 3314</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03315" name="l03315"></a><span class="lineno"> 3315</span> </div>
<div class="line"><a id="l03316" name="l03316"></a><span class="lineno"> 3316</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l03317" name="l03317"></a><span class="lineno"> 3317</span> </div>
<div class="line"><a id="l03318" name="l03318"></a><span class="lineno"> 3318</span>    <span class="comment">! Do precipitation onto ground, etc., from Hydrology1.</span></div>
<div class="line"><a id="l03319" name="l03319"></a><span class="lineno"> 3319</span> </div>
<div class="line"><a id="l03320" name="l03320"></a><span class="lineno"> 3320</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03321" name="l03321"></a><span class="lineno"> 3321</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03322" name="l03322"></a><span class="lineno"> 3322</span>    <span class="keywordflow">do</span> fp = 1, num_shlakep</div>
<div class="line"><a id="l03323" name="l03323"></a><span class="lineno"> 3323</span>       p = filter_shlakep(fp)</div>
<div class="line"><a id="l03324" name="l03324"></a><span class="lineno"> 3324</span>       g = pgridcell(p)</div>
<div class="line"><a id="l03325" name="l03325"></a><span class="lineno"> 3325</span>       <span class="comment">!       l = plandunit(p)</span></div>
<div class="line"><a id="l03326" name="l03326"></a><span class="lineno"> 3326</span>       c = pcolumn(p)</div>
<div class="line"><a id="l03327" name="l03327"></a><span class="lineno"> 3327</span> </div>
<div class="line"><a id="l03328" name="l03328"></a><span class="lineno"> 3328</span>       <span class="comment">! Precipitation onto ground (kg/(m2 s))</span></div>
<div class="line"><a id="l03329" name="l03329"></a><span class="lineno"> 3329</span>       <span class="comment">!       ! PET, 1/18/2005: Added new terms for mass balance correction</span></div>
<div class="line"><a id="l03330" name="l03330"></a><span class="lineno"> 3330</span>       <span class="comment">!       ! due to dynamic pft weight shifting (column-level h2ocan_loss)</span></div>
<div class="line"><a id="l03331" name="l03331"></a><span class="lineno"> 3331</span>       <span class="comment">!       ! Because the fractionation between rain and snow is indeterminate if</span></div>
<div class="line"><a id="l03332" name="l03332"></a><span class="lineno"> 3332</span>       <span class="comment">!       ! rain + snow = 0, I am adding this very small flux only to the rain</span></div>
<div class="line"><a id="l03333" name="l03333"></a><span class="lineno"> 3333</span>       <span class="comment">!       ! components.</span></div>
<div class="line"><a id="l03334" name="l03334"></a><span class="lineno"> 3334</span>       <span class="comment">! Not relevant unless PFTs are added to lake later.</span></div>
<div class="line"><a id="l03335" name="l03335"></a><span class="lineno"> 3335</span>       <span class="comment">!       if (frac_veg_nosno(p) == 0) then</span></div>
<div class="line"><a id="l03336" name="l03336"></a><span class="lineno"> 3336</span>          qflx_prec_grnd_snow(p) = forc_snow(g)</div>
<div class="line"><a id="l03337" name="l03337"></a><span class="lineno"> 3337</span>          qflx_prec_grnd_rain(p) = forc_rain(g) <span class="comment">!+ h2ocan_loss(c)</span></div>
<div class="line"><a id="l03338" name="l03338"></a><span class="lineno"> 3338</span>          <span class="comment">!       else</span></div>
<div class="line"><a id="l03339" name="l03339"></a><span class="lineno"> 3339</span>          <span class="comment">!          qflx_prec_grnd_snow(p) = qflx_through_snow(p) + (qflx_candrip(p) * fracsnow(p))</span></div>
<div class="line"><a id="l03340" name="l03340"></a><span class="lineno"> 3340</span>          <span class="comment">!          qflx_prec_grnd_rain(p) = qflx_through_rain(p) + (qflx_candrip(p) * fracrain(p)) + h2ocan_loss(c)</span></div>
<div class="line"><a id="l03341" name="l03341"></a><span class="lineno"> 3341</span>          <span class="comment">!       end if</span></div>
<div class="line"><a id="l03342" name="l03342"></a><span class="lineno"> 3342</span>       qflx_prec_grnd(p) = qflx_prec_grnd_snow(p) + qflx_prec_grnd_rain(p)</div>
<div class="line"><a id="l03343" name="l03343"></a><span class="lineno"> 3343</span> </div>
<div class="line"><a id="l03344" name="l03344"></a><span class="lineno"> 3344</span>       <span class="keywordflow">if</span> (do_capsnow(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03345" name="l03345"></a><span class="lineno"> 3345</span>          qflx_snowcap(p) = qflx_prec_grnd_snow(p) + qflx_prec_grnd_rain(p)</div>
<div class="line"><a id="l03346" name="l03346"></a><span class="lineno"> 3346</span>          qflx_snow_grnd_pft(p) = 0._kind_lake</div>
<div class="line"><a id="l03347" name="l03347"></a><span class="lineno"> 3347</span>          qflx_rain_grnd(p) = 0._kind_lake</div>
<div class="line"><a id="l03348" name="l03348"></a><span class="lineno"> 3348</span>       <span class="keywordflow">else</span></div>
<div class="line"><a id="l03349" name="l03349"></a><span class="lineno"> 3349</span>          qflx_snowcap(p) = 0._kind_lake</div>
<div class="line"><a id="l03350" name="l03350"></a><span class="lineno"> 3350</span>          qflx_snow_grnd_pft(p) = qflx_prec_grnd_snow(p)           <span class="comment">! ice onto ground (mm/s)</span></div>
<div class="line"><a id="l03351" name="l03351"></a><span class="lineno"> 3351</span>          qflx_rain_grnd(p)     = qflx_prec_grnd_rain(p)           <span class="comment">! liquid water onto ground (mm/s)</span></div>
<div class="line"><a id="l03352" name="l03352"></a><span class="lineno"> 3352</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l03353" name="l03353"></a><span class="lineno"> 3353</span>       <span class="comment">! Assuming one PFT; needed for below</span></div>
<div class="line"><a id="l03354" name="l03354"></a><span class="lineno"> 3354</span>       qflx_snow_grnd_col(c) = qflx_snow_grnd_pft(p)</div>
<div class="line"><a id="l03355" name="l03355"></a><span class="lineno"> 3355</span>       qflx_rain_grnd_col(c) = qflx_rain_grnd(p)</div>
<div class="line"><a id="l03356" name="l03356"></a><span class="lineno"> 3356</span> </div>
<div class="line"><a id="l03357" name="l03357"></a><span class="lineno"> 3357</span><span class="keywordflow">    end do</span> <span class="comment">! (end pft loop)</span></div>
<div class="line"><a id="l03358" name="l03358"></a><span class="lineno"> 3358</span> </div>
<div class="line"><a id="l03359" name="l03359"></a><span class="lineno"> 3359</span>    <span class="comment">! Determine snow height and snow water</span></div>
<div class="line"><a id="l03360" name="l03360"></a><span class="lineno"> 3360</span> </div>
<div class="line"><a id="l03361" name="l03361"></a><span class="lineno"> 3361</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03362" name="l03362"></a><span class="lineno"> 3362</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03363" name="l03363"></a><span class="lineno"> 3363</span>    <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l03364" name="l03364"></a><span class="lineno"> 3364</span>       c = filter_shlakec(fc)</div>
<div class="line"><a id="l03365" name="l03365"></a><span class="lineno"> 3365</span>       <span class="comment">!       l = clandunit(c)</span></div>
<div class="line"><a id="l03366" name="l03366"></a><span class="lineno"> 3366</span>       g = cgridcell(c)</div>
<div class="line"><a id="l03367" name="l03367"></a><span class="lineno"> 3367</span> </div>
<div class="line"><a id="l03368" name="l03368"></a><span class="lineno"> 3368</span>       <span class="comment">! Use Alta relationship, Anderson(1976); LaChapelle(1961),</span></div>
<div class="line"><a id="l03369" name="l03369"></a><span class="lineno"> 3369</span>       <span class="comment">! U.S.Department of Agriculture Forest Service, Project F,</span></div>
<div class="line"><a id="l03370" name="l03370"></a><span class="lineno"> 3370</span>       <span class="comment">! Progress Rep. 1, Alta Avalanche Study Center:Snow Layer Densification.</span></div>
<div class="line"><a id="l03371" name="l03371"></a><span class="lineno"> 3371</span> </div>
<div class="line"><a id="l03372" name="l03372"></a><span class="lineno"> 3372</span>       <span class="keywordflow">if</span> (do_capsnow(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03373" name="l03373"></a><span class="lineno"> 3373</span>          dz_snowf = 0._kind_lake</div>
<div class="line"><a id="l03374" name="l03374"></a><span class="lineno"> 3374</span>       <span class="keywordflow">else</span></div>
<div class="line"><a id="l03375" name="l03375"></a><span class="lineno"> 3375</span>          <span class="keywordflow">if</span> (forc_t(g) &gt; tfrz + 2._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03376" name="l03376"></a><span class="lineno"> 3376</span>             bifall=50._kind_lake + 1.7_kind_lake*(17.0_kind_lake)**1.5_kind_lake</div>
<div class="line"><a id="l03377" name="l03377"></a><span class="lineno"> 3377</span>          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (forc_t(g) &gt; tfrz - 15._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03378" name="l03378"></a><span class="lineno"> 3378</span>             bifall=50._kind_lake + 1.7_kind_lake*(forc_t(g) - tfrz + 15._kind_lake)**1.5_kind_lake</div>
<div class="line"><a id="l03379" name="l03379"></a><span class="lineno"> 3379</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l03380" name="l03380"></a><span class="lineno"> 3380</span>             bifall=50._kind_lake</div>
<div class="line"><a id="l03381" name="l03381"></a><span class="lineno"> 3381</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03382" name="l03382"></a><span class="lineno"> 3382</span>          dz_snowf = qflx_snow_grnd_col(c)/bifall</div>
<div class="line"><a id="l03383" name="l03383"></a><span class="lineno"> 3383</span>          snowdp(c) = snowdp(c) + dz_snowf*dtime</div>
<div class="line"><a id="l03384" name="l03384"></a><span class="lineno"> 3384</span>          h2osno(c) = h2osno(c) + qflx_snow_grnd_col(c)*dtime  <span class="comment">! snow water equivalent (mm)</span></div>
<div class="line"><a id="l03385" name="l03385"></a><span class="lineno"> 3385</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l03386" name="l03386"></a><span class="lineno"> 3386</span> </div>
<div class="line"><a id="l03387" name="l03387"></a><span class="lineno"> 3387</span>       <span class="comment">!       if (itype(l)==istwet .and. t_grnd(c)&gt;tfrz) then</span></div>
<div class="line"><a id="l03388" name="l03388"></a><span class="lineno"> 3388</span>       <span class="comment">!          h2osno(c)=0._kind_lake</span></div>
<div class="line"><a id="l03389" name="l03389"></a><span class="lineno"> 3389</span>       <span class="comment">!          snowdp(c)=0._kind_lake</span></div>
<div class="line"><a id="l03390" name="l03390"></a><span class="lineno"> 3390</span>       <span class="comment">!          snowage(c)=0._kind_lake</span></div>
<div class="line"><a id="l03391" name="l03391"></a><span class="lineno"> 3391</span>       <span class="comment">!       end if</span></div>
<div class="line"><a id="l03392" name="l03392"></a><span class="lineno"> 3392</span>       <span class="comment">! Take care of this later in function.</span></div>
<div class="line"><a id="l03393" name="l03393"></a><span class="lineno"> 3393</span> </div>
<div class="line"><a id="l03394" name="l03394"></a><span class="lineno"> 3394</span>       <span class="comment">! When the snow accumulation exceeds 10 mm, initialize snow layer</span></div>
<div class="line"><a id="l03395" name="l03395"></a><span class="lineno"> 3395</span>       <span class="comment">! Currently, the water temperature for the precipitation is simply set</span></div>
<div class="line"><a id="l03396" name="l03396"></a><span class="lineno"> 3396</span>       <span class="comment">! as the surface air temperature</span></div>
<div class="line"><a id="l03397" name="l03397"></a><span class="lineno"> 3397</span> </div>
<div class="line"><a id="l03398" name="l03398"></a><span class="lineno"> 3398</span>       newnode = 0    <span class="comment">! flag for when snow node will be initialized</span></div>
<div class="line"><a id="l03399" name="l03399"></a><span class="lineno"> 3399</span>       <span class="keywordflow">if</span> (snl(c) == 0 .and. qflx_snow_grnd_col(c) &gt; 0.0_kind_lake .and. snowdp(c) &gt;= 0.01_kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03400" name="l03400"></a><span class="lineno"> 3400</span>          newnode = 1</div>
<div class="line"><a id="l03401" name="l03401"></a><span class="lineno"> 3401</span>          snl(c) = -1</div>
<div class="line"><a id="l03402" name="l03402"></a><span class="lineno"> 3402</span>          dz(c,0) = snowdp(c)                       <span class="comment">! meter</span></div>
<div class="line"><a id="l03403" name="l03403"></a><span class="lineno"> 3403</span>          z(c,0) = -0.5_kind_lake*dz(c,0)</div>
<div class="line"><a id="l03404" name="l03404"></a><span class="lineno"> 3404</span>          zi(c,-1) = -dz(c,0)</div>
<div class="line"><a id="l03405" name="l03405"></a><span class="lineno"> 3405</span>          snowage(c) = 0._kind_lake                        <span class="comment">! snow age</span></div>
<div class="line"><a id="l03406" name="l03406"></a><span class="lineno"> 3406</span>          t_soisno(c,0) = min(tfrz, forc_t(g))      <span class="comment">! K</span></div>
<div class="line"><a id="l03407" name="l03407"></a><span class="lineno"> 3407</span>          h2osoi_ice(c,0) = h2osno(c)               <span class="comment">! kg/m2</span></div>
<div class="line"><a id="l03408" name="l03408"></a><span class="lineno"> 3408</span>          h2osoi_liq(c,0) = 0._kind_lake                   <span class="comment">! kg/m2</span></div>
<div class="line"><a id="l03409" name="l03409"></a><span class="lineno"> 3409</span>          frac_iceold(c,0) = 1._kind_lake</div>
<div class="line"><a id="l03410" name="l03410"></a><span class="lineno"> 3410</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l03411" name="l03411"></a><span class="lineno"> 3411</span> </div>
<div class="line"><a id="l03412" name="l03412"></a><span class="lineno"> 3412</span>       <span class="comment">! The change of ice partial density of surface node due to precipitation.</span></div>
<div class="line"><a id="l03413" name="l03413"></a><span class="lineno"> 3413</span>       <span class="comment">! Only ice part of snowfall is added here, the liquid part will be added</span></div>
<div class="line"><a id="l03414" name="l03414"></a><span class="lineno"> 3414</span>       <span class="comment">! later.</span></div>
<div class="line"><a id="l03415" name="l03415"></a><span class="lineno"> 3415</span> </div>
<div class="line"><a id="l03416" name="l03416"></a><span class="lineno"> 3416</span>       <span class="keywordflow">if</span> (snl(c) &lt; 0 .and. newnode == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03417" name="l03417"></a><span class="lineno"> 3417</span>          h2osoi_ice(c,snl(c)+1) = h2osoi_ice(c,snl(c)+1)+dtime*qflx_snow_grnd_col(c)</div>
<div class="line"><a id="l03418" name="l03418"></a><span class="lineno"> 3418</span>          dz(c,snl(c)+1) = dz(c,snl(c)+1)+dz_snowf*dtime</div>
<div class="line"><a id="l03419" name="l03419"></a><span class="lineno"> 3419</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l03420" name="l03420"></a><span class="lineno"> 3420</span> </div>
<div class="line"><a id="l03421" name="l03421"></a><span class="lineno"> 3421</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03422" name="l03422"></a><span class="lineno"> 3422</span> </div>
<div class="line"><a id="l03423" name="l03423"></a><span class="lineno"> 3423</span>    <span class="comment">! Calculate sublimation and dew, adapted from HydrologyLake and Biogeophysics2.</span></div>
<div class="line"><a id="l03424" name="l03424"></a><span class="lineno"> 3424</span> </div>
<div class="line"><a id="l03425" name="l03425"></a><span class="lineno"> 3425</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03426" name="l03426"></a><span class="lineno"> 3426</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03427" name="l03427"></a><span class="lineno"> 3427</span>    <span class="keywordflow">do</span> fp = 1,num_shlakep</div>
<div class="line"><a id="l03428" name="l03428"></a><span class="lineno"> 3428</span>       p = filter_shlakep(fp)</div>
<div class="line"><a id="l03429" name="l03429"></a><span class="lineno"> 3429</span>       c = pcolumn(p)</div>
<div class="line"><a id="l03430" name="l03430"></a><span class="lineno"> 3430</span>       jtop = snl(c)+1</div>
<div class="line"><a id="l03431" name="l03431"></a><span class="lineno"> 3431</span> </div>
<div class="line"><a id="l03432" name="l03432"></a><span class="lineno"> 3432</span>       <span class="comment">! Use column variables here</span></div>
<div class="line"><a id="l03433" name="l03433"></a><span class="lineno"> 3433</span>       qflx_evap_grnd(c) = 0._kind_lake</div>
<div class="line"><a id="l03434" name="l03434"></a><span class="lineno"> 3434</span>       qflx_sub_snow(c) = 0._kind_lake</div>
<div class="line"><a id="l03435" name="l03435"></a><span class="lineno"> 3435</span>       qflx_dew_snow(c) = 0._kind_lake</div>
<div class="line"><a id="l03436" name="l03436"></a><span class="lineno"> 3436</span>       qflx_dew_grnd(c) = 0._kind_lake</div>
<div class="line"><a id="l03437" name="l03437"></a><span class="lineno"> 3437</span> </div>
<div class="line"><a id="l03438" name="l03438"></a><span class="lineno"> 3438</span>       <span class="keywordflow">if</span> (jtop &lt;= 0) <span class="keywordflow">then</span> <span class="comment">! snow layers</span></div>
<div class="line"><a id="l03439" name="l03439"></a><span class="lineno"> 3439</span>          j = jtop</div>
<div class="line"><a id="l03440" name="l03440"></a><span class="lineno"> 3440</span>          <span class="comment">! Assign ground evaporation to sublimation from soil ice or to dew</span></div>
<div class="line"><a id="l03441" name="l03441"></a><span class="lineno"> 3441</span>          <span class="comment">! on snow or ground</span></div>
<div class="line"><a id="l03442" name="l03442"></a><span class="lineno"> 3442</span> </div>
<div class="line"><a id="l03443" name="l03443"></a><span class="lineno"> 3443</span>          <span class="keywordflow">if</span> (qflx_evap_soi(p) &gt;= 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03444" name="l03444"></a><span class="lineno"> 3444</span>          <span class="comment">! for evaporation partitioning between liquid evap and ice sublimation, </span></div>
<div class="line"><a id="l03445" name="l03445"></a><span class="lineno"> 3445</span>          <span class="comment">! use the ratio of liquid to (liquid+ice) in the top layer to determine split</span></div>
<div class="line"><a id="l03446" name="l03446"></a><span class="lineno"> 3446</span>          <span class="comment">! Since we&#39;re not limiting evap over lakes, but still can&#39;t remove more from top</span></div>
<div class="line"><a id="l03447" name="l03447"></a><span class="lineno"> 3447</span>          <span class="comment">! snow layer than there is there, create temp. limited evap_soi.</span></div>
<div class="line"><a id="l03448" name="l03448"></a><span class="lineno"> 3448</span>             qflx_evap_soi_lim = min(qflx_evap_soi(p), (h2osoi_liq(c,j)+h2osoi_ice(c,j))/dtime)</div>
<div class="line"><a id="l03449" name="l03449"></a><span class="lineno"> 3449</span>             <span class="keywordflow">if</span> ((h2osoi_liq(c,j)+h2osoi_ice(c,j)) &gt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03450" name="l03450"></a><span class="lineno"> 3450</span>                qflx_evap_grnd(c) = max(qflx_evap_soi_lim*(h2osoi_liq(c,j)/(h2osoi_liq(c,j)+h2osoi_ice(c,j))), 0._kind_lake)</div>
<div class="line"><a id="l03451" name="l03451"></a><span class="lineno"> 3451</span>             <span class="keywordflow">else</span></div>
<div class="line"><a id="l03452" name="l03452"></a><span class="lineno"> 3452</span>                qflx_evap_grnd(c) = 0._kind_lake</div>
<div class="line"><a id="l03453" name="l03453"></a><span class="lineno"> 3453</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l03454" name="l03454"></a><span class="lineno"> 3454</span>             qflx_sub_snow(c) = qflx_evap_soi_lim - qflx_evap_grnd(c)     </div>
<div class="line"><a id="l03455" name="l03455"></a><span class="lineno"> 3455</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l03456" name="l03456"></a><span class="lineno"> 3456</span>             <span class="keywordflow">if</span> (t_grnd(c) &lt; tfrz) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03457" name="l03457"></a><span class="lineno"> 3457</span>                qflx_dew_snow(c) = abs(qflx_evap_soi(p))</div>
<div class="line"><a id="l03458" name="l03458"></a><span class="lineno"> 3458</span>             <span class="keywordflow">else</span></div>
<div class="line"><a id="l03459" name="l03459"></a><span class="lineno"> 3459</span>                qflx_dew_grnd(c) = abs(qflx_evap_soi(p))</div>
<div class="line"><a id="l03460" name="l03460"></a><span class="lineno"> 3460</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l03461" name="l03461"></a><span class="lineno"> 3461</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03462" name="l03462"></a><span class="lineno"> 3462</span>          <span class="comment">! Update the pft-level qflx_snowcap</span></div>
<div class="line"><a id="l03463" name="l03463"></a><span class="lineno"> 3463</span>          <span class="comment">! This was moved in from Hydrology2 to keep all pft-level</span></div>
<div class="line"><a id="l03464" name="l03464"></a><span class="lineno"> 3464</span>          <span class="comment">! calculations out of Hydrology2</span></div>
<div class="line"><a id="l03465" name="l03465"></a><span class="lineno"> 3465</span>          <span class="keywordflow">if</span> (do_capsnow(c)) qflx_snowcap(p) = qflx_snowcap(p) + qflx_dew_snow(c) + qflx_dew_grnd(c)</div>
<div class="line"><a id="l03466" name="l03466"></a><span class="lineno"> 3466</span> </div>
<div class="line"><a id="l03467" name="l03467"></a><span class="lineno"> 3467</span>       <span class="keywordflow">else</span> <span class="comment">! No snow layers: do as in HydrologyLake but with actual clmtype variables</span></div>
<div class="line"><a id="l03468" name="l03468"></a><span class="lineno"> 3468</span>          <span class="keywordflow">if</span> (qflx_evap_soi(p) &gt;= 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03469" name="l03469"></a><span class="lineno"> 3469</span>             <span class="comment">! Sublimation: do not allow for more sublimation than there is snow</span></div>
<div class="line"><a id="l03470" name="l03470"></a><span class="lineno"> 3470</span>             <span class="comment">! after melt.  Remaining surface evaporation used for infiltration.</span></div>
<div class="line"><a id="l03471" name="l03471"></a><span class="lineno"> 3471</span>             qflx_sub_snow(c) = min(qflx_evap_soi(p), h2osno(c)/dtime)</div>
<div class="line"><a id="l03472" name="l03472"></a><span class="lineno"> 3472</span>             qflx_evap_grnd(c) = qflx_evap_soi(p) - qflx_sub_snow(c)</div>
<div class="line"><a id="l03473" name="l03473"></a><span class="lineno"> 3473</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l03474" name="l03474"></a><span class="lineno"> 3474</span>             <span class="keywordflow">if</span> (t_grnd(c) &lt; tfrz-0.1_kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03475" name="l03475"></a><span class="lineno"> 3475</span>                qflx_dew_snow(c) = abs(qflx_evap_soi(p))</div>
<div class="line"><a id="l03476" name="l03476"></a><span class="lineno"> 3476</span>             <span class="keywordflow">else</span></div>
<div class="line"><a id="l03477" name="l03477"></a><span class="lineno"> 3477</span>                qflx_dew_grnd(c) = abs(qflx_evap_soi(p))</div>
<div class="line"><a id="l03478" name="l03478"></a><span class="lineno"> 3478</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l03479" name="l03479"></a><span class="lineno"> 3479</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03480" name="l03480"></a><span class="lineno"> 3480</span> </div>
<div class="line"><a id="l03481" name="l03481"></a><span class="lineno"> 3481</span>          <span class="comment">! Update snow pack for dew &amp; sub.</span></div>
<div class="line"><a id="l03482" name="l03482"></a><span class="lineno"> 3482</span>          h2osno_temp = h2osno(c)</div>
<div class="line"><a id="l03483" name="l03483"></a><span class="lineno"> 3483</span>          <span class="keywordflow">if</span> (do_capsnow(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03484" name="l03484"></a><span class="lineno"> 3484</span>             h2osno(c) = h2osno(c) - qflx_sub_snow(c)*dtime</div>
<div class="line"><a id="l03485" name="l03485"></a><span class="lineno"> 3485</span>             qflx_snowcap(p) = qflx_snowcap(p) + qflx_dew_snow(c) + qflx_dew_grnd(c)</div>
<div class="line"><a id="l03486" name="l03486"></a><span class="lineno"> 3486</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l03487" name="l03487"></a><span class="lineno"> 3487</span>             h2osno(c) = h2osno(c) + (-qflx_sub_snow(c)+qflx_dew_snow(c))*dtime</div>
<div class="line"><a id="l03488" name="l03488"></a><span class="lineno"> 3488</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03489" name="l03489"></a><span class="lineno"> 3489</span>          <span class="keywordflow">if</span> (h2osno_temp &gt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03490" name="l03490"></a><span class="lineno"> 3490</span>             snowdp(c) = snowdp(c) * h2osno(c) / h2osno_temp</div>
<div class="line"><a id="l03491" name="l03491"></a><span class="lineno"> 3491</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l03492" name="l03492"></a><span class="lineno"> 3492</span>             snowdp(c) = h2osno(c)/snow_bd <span class="comment">!Assume a constant snow bulk density = 250.</span></div>
<div class="line"><a id="l03493" name="l03493"></a><span class="lineno"> 3493</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03494" name="l03494"></a><span class="lineno"> 3494</span> </div>
<div class="line"><a id="l03495" name="l03495"></a><span class="lineno"> 3495</span>          <span class="keywordflow">if</span> (pergro) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03496" name="l03496"></a><span class="lineno"> 3496</span>            <span class="keywordflow">if</span> (abs(h2osno(c)) &lt; 1.e-10_kind_lake) h2osno(c) = 0._kind_lake</div>
<div class="line"><a id="l03497" name="l03497"></a><span class="lineno"> 3497</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l03498" name="l03498"></a><span class="lineno"> 3498</span>            h2osno(c) = max(h2osno(c), 0._kind_lake)</div>
<div class="line"><a id="l03499" name="l03499"></a><span class="lineno"> 3499</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l03500" name="l03500"></a><span class="lineno"> 3500</span> </div>
<div class="line"><a id="l03501" name="l03501"></a><span class="lineno"> 3501</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l03502" name="l03502"></a><span class="lineno"> 3502</span> </div>
<div class="line"><a id="l03503" name="l03503"></a><span class="lineno"> 3503</span>    qflx_snowcap_col(c) = qflx_snowcap(p)</div>
<div class="line"><a id="l03504" name="l03504"></a><span class="lineno"> 3504</span> </div>
<div class="line"><a id="l03505" name="l03505"></a><span class="lineno"> 3505</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03506" name="l03506"></a><span class="lineno"> 3506</span> </div>
<div class="line"><a id="l03507" name="l03507"></a><span class="lineno"> 3507</span> </div>
<div class="line"><a id="l03508" name="l03508"></a><span class="lineno"> 3508</span>    <span class="comment">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l03509" name="l03509"></a><span class="lineno"> 3509</span>    <span class="comment">! Determine initial snow/no-snow filters (will be modified possibly by</span></div>
<div class="line"><a id="l03510" name="l03510"></a><span class="lineno"> 3510</span>    <span class="comment">! routines CombineSnowLayers and DivideSnowLayers below</span></div>
<div class="line"><a id="l03511" name="l03511"></a><span class="lineno"> 3511</span> </div>
<div class="line"><a id="l03512" name="l03512"></a><span class="lineno"> 3512</span>    <span class="keyword">call </span>buildsnowfilter(lbc, ubc, num_shlakec, filter_shlakec,snl,       &amp;            <span class="comment">!i</span></div>
<div class="line"><a id="l03513" name="l03513"></a><span class="lineno"> 3513</span>         num_shlakesnowc, filter_shlakesnowc, num_shlakenosnowc, filter_shlakenosnowc) <span class="comment">!o</span></div>
<div class="line"><a id="l03514" name="l03514"></a><span class="lineno"> 3514</span> </div>
<div class="line"><a id="l03515" name="l03515"></a><span class="lineno"> 3515</span>    <span class="comment">! Determine the change of snow mass and the snow water onto soil</span></div>
<div class="line"><a id="l03516" name="l03516"></a><span class="lineno"> 3516</span> </div>
<div class="line"><a id="l03517" name="l03517"></a><span class="lineno"> 3517</span>    <span class="keyword">call </span><a class="code hl_function" href="group___noah_m_p___l_s_m_ga8500bdb5fcc68e431512068da0d31cd5.html#ga8500bdb5fcc68e431512068da0d31cd5">snowwater</a>(lbc, ubc, num_shlakesnowc, filter_shlakesnowc,         &amp; <span class="comment">!i </span></div>
<div class="line"><a id="l03518" name="l03518"></a><span class="lineno"> 3518</span>                   num_shlakenosnowc, filter_shlakenosnowc,               &amp; <span class="comment">!i </span></div>
<div class="line"><a id="l03519" name="l03519"></a><span class="lineno"> 3519</span>                   snl,do_capsnow,qflx_snomelt,qflx_rain_grnd,            &amp; <span class="comment">!i </span></div>
<div class="line"><a id="l03520" name="l03520"></a><span class="lineno"> 3520</span>                   qflx_sub_snow,qflx_evap_grnd,                          &amp; <span class="comment">!i   </span></div>
<div class="line"><a id="l03521" name="l03521"></a><span class="lineno"> 3521</span>                   qflx_dew_snow,qflx_dew_grnd,dz,dtime,                  &amp; <span class="comment">!i   </span></div>
<div class="line"><a id="l03522" name="l03522"></a><span class="lineno"> 3522</span>                   h2osoi_ice,h2osoi_liq,                                 &amp; <span class="comment">!i&amp;o </span></div>
<div class="line"><a id="l03523" name="l03523"></a><span class="lineno"> 3523</span>                   qflx_top_soil)                                           <span class="comment">!o                        </span></div>
<div class="line"><a id="l03524" name="l03524"></a><span class="lineno"> 3524</span> </div>
<div class="line"><a id="l03525" name="l03525"></a><span class="lineno"> 3525</span> </div>
<div class="line"><a id="l03526" name="l03526"></a><span class="lineno"> 3526</span>    <span class="comment">! Determine soil hydrology</span></div>
<div class="line"><a id="l03527" name="l03527"></a><span class="lineno"> 3527</span>    <span class="comment">! Here this consists only of making sure that soil is saturated even as it melts and 10%</span></div>
<div class="line"><a id="l03528" name="l03528"></a><span class="lineno"> 3528</span>    <span class="comment">! of pore space opens up. Conversely, if excess ice is melting and the liquid water exceeds the</span></div>
<div class="line"><a id="l03529" name="l03529"></a><span class="lineno"> 3529</span>    <span class="comment">! saturation value, then remove water.</span></div>
<div class="line"><a id="l03530" name="l03530"></a><span class="lineno"> 3530</span> </div>
<div class="line"><a id="l03531" name="l03531"></a><span class="lineno"> 3531</span>    <span class="keywordflow">do</span> j = 1,nlevsoil</div>
<div class="line"><a id="l03532" name="l03532"></a><span class="lineno"> 3532</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03533" name="l03533"></a><span class="lineno"> 3533</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03534" name="l03534"></a><span class="lineno"> 3534</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l03535" name="l03535"></a><span class="lineno"> 3535</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l03536" name="l03536"></a><span class="lineno"> 3536</span> </div>
<div class="line"><a id="l03537" name="l03537"></a><span class="lineno"> 3537</span>          <span class="keywordflow">if</span> (h2osoi_vol(c,j) &lt; watsat(c,j)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03538" name="l03538"></a><span class="lineno"> 3538</span>             h2osoi_liq(c,j) = (watsat(c,j)*dz(c,j) - h2osoi_ice(c,j)/denice)*denh2o</div>
<div class="line"><a id="l03539" name="l03539"></a><span class="lineno"> 3539</span>          <span class="comment">! h2osoi_vol will be updated below, and this water addition will come from qflx_qrgwl</span></div>
<div class="line"><a id="l03540" name="l03540"></a><span class="lineno"> 3540</span>          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (h2osoi_liq(c,j) &gt; watsat(c,j)*denh2o*dz(c,j)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03541" name="l03541"></a><span class="lineno"> 3541</span>             h2osoi_liq(c,j) = watsat(c,j)*denh2o*dz(c,j)</div>
<div class="line"><a id="l03542" name="l03542"></a><span class="lineno"> 3542</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03543" name="l03543"></a><span class="lineno"> 3543</span> </div>
<div class="line"><a id="l03544" name="l03544"></a><span class="lineno"> 3544</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03545" name="l03545"></a><span class="lineno"> 3545</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03546" name="l03546"></a><span class="lineno"> 3546</span>    <span class="comment">!!!!!!!!!!</span></div>
<div class="line"><a id="l03547" name="l03547"></a><span class="lineno"> 3547</span> </div>
<div class="line"><a id="l03548" name="l03548"></a><span class="lineno"> 3548</span>    <span class="comment">!    if (.not. is_perpetual()) then</span></div>
<div class="line"><a id="l03549" name="l03549"></a><span class="lineno"> 3549</span>    <span class="keywordflow">if</span> (1==1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03550" name="l03550"></a><span class="lineno"> 3550</span> </div>
<div class="line"><a id="l03551" name="l03551"></a><span class="lineno"> 3551</span>       <span class="comment">! Natural compaction and metamorphosis.</span></div>
<div class="line"><a id="l03552" name="l03552"></a><span class="lineno"> 3552</span> </div>
<div class="line"><a id="l03553" name="l03553"></a><span class="lineno"> 3553</span>       <span class="keyword">call </span>snowcompaction(lbc, ubc, num_shlakesnowc, filter_shlakesnowc,   &amp;<span class="comment">!i</span></div>
<div class="line"><a id="l03554" name="l03554"></a><span class="lineno"> 3554</span>                           snl,imelt,frac_iceold,t_soisno,                  &amp;<span class="comment">!i</span></div>
<div class="line"><a id="l03555" name="l03555"></a><span class="lineno"> 3555</span>                           h2osoi_ice,h2osoi_liq,dtime,                     &amp;<span class="comment">!i</span></div>
<div class="line"><a id="l03556" name="l03556"></a><span class="lineno"> 3556</span>                           dz)                                               <span class="comment">!&amp;o</span></div>
<div class="line"><a id="l03557" name="l03557"></a><span class="lineno"> 3557</span> </div>
<div class="line"><a id="l03558" name="l03558"></a><span class="lineno"> 3558</span>       <span class="comment">! Combine thin snow elements</span></div>
<div class="line"><a id="l03559" name="l03559"></a><span class="lineno"> 3559</span> </div>
<div class="line"><a id="l03560" name="l03560"></a><span class="lineno"> 3560</span>       <span class="keyword">call </span>combinesnowlayers(lbc, ubc,                            &amp; <span class="comment">!i</span></div>
<div class="line"><a id="l03561" name="l03561"></a><span class="lineno"> 3561</span>                              num_shlakesnowc, filter_shlakesnowc, &amp; <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l03562" name="l03562"></a><span class="lineno"> 3562</span>                              snl,h2osno,snowdp,dz,zi,             &amp; <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l03563" name="l03563"></a><span class="lineno"> 3563</span>                              t_soisno,h2osoi_ice,h2osoi_liq,      &amp; <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l03564" name="l03564"></a><span class="lineno"> 3564</span>                              z)  <span class="comment">!o                              </span></div>
<div class="line"><a id="l03565" name="l03565"></a><span class="lineno"> 3565</span> </div>
<div class="line"><a id="l03566" name="l03566"></a><span class="lineno"> 3566</span> </div>
<div class="line"><a id="l03567" name="l03567"></a><span class="lineno"> 3567</span>       <span class="comment">! Divide thick snow elements</span></div>
<div class="line"><a id="l03568" name="l03568"></a><span class="lineno"> 3568</span> </div>
<div class="line"><a id="l03569" name="l03569"></a><span class="lineno"> 3569</span>       <span class="keyword">call </span>dividesnowlayers(lbc, ubc,                             &amp; <span class="comment">!i</span></div>
<div class="line"><a id="l03570" name="l03570"></a><span class="lineno"> 3570</span>                             num_shlakesnowc, filter_shlakesnowc,  &amp; <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l03571" name="l03571"></a><span class="lineno"> 3571</span>                             snl,dz,zi,t_soisno,                   &amp; <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l03572" name="l03572"></a><span class="lineno"> 3572</span>                             h2osoi_ice,h2osoi_liq,                &amp; <span class="comment">!i&amp;o</span></div>
<div class="line"><a id="l03573" name="l03573"></a><span class="lineno"> 3573</span>                             z)  <span class="comment">!o</span></div>
<div class="line"><a id="l03574" name="l03574"></a><span class="lineno"> 3574</span> </div>
<div class="line"><a id="l03575" name="l03575"></a><span class="lineno"> 3575</span> </div>
<div class="line"><a id="l03576" name="l03576"></a><span class="lineno"> 3576</span>    <span class="keywordflow">else</span></div>
<div class="line"><a id="l03577" name="l03577"></a><span class="lineno"> 3577</span> </div>
<div class="line"><a id="l03578" name="l03578"></a><span class="lineno"> 3578</span>       <span class="keywordflow">do</span> fc = 1, num_shlakesnowc</div>
<div class="line"><a id="l03579" name="l03579"></a><span class="lineno"> 3579</span>          c = filter_shlakesnowc(fc)</div>
<div class="line"><a id="l03580" name="l03580"></a><span class="lineno"> 3580</span>          h2osno(c) = 0._kind_lake</div>
<div class="line"><a id="l03581" name="l03581"></a><span class="lineno"> 3581</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03582" name="l03582"></a><span class="lineno"> 3582</span>       <span class="keywordflow">do</span> j = -nlevsnow+1,0</div>
<div class="line"><a id="l03583" name="l03583"></a><span class="lineno"> 3583</span>          <span class="keywordflow">do</span> fc = 1, num_shlakesnowc</div>
<div class="line"><a id="l03584" name="l03584"></a><span class="lineno"> 3584</span>             c = filter_shlakesnowc(fc)</div>
<div class="line"><a id="l03585" name="l03585"></a><span class="lineno"> 3585</span>             <span class="keywordflow">if</span> (j &gt;= snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03586" name="l03586"></a><span class="lineno"> 3586</span>                h2osno(c) = h2osno(c) + h2osoi_ice(c,j) + h2osoi_liq(c,j)</div>
<div class="line"><a id="l03587" name="l03587"></a><span class="lineno"> 3587</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l03588" name="l03588"></a><span class="lineno"> 3588</span><span class="keywordflow">          end do</span></div>
<div class="line"><a id="l03589" name="l03589"></a><span class="lineno"> 3589</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03590" name="l03590"></a><span class="lineno"> 3590</span> </div>
<div class="line"><a id="l03591" name="l03591"></a><span class="lineno"> 3591</span><span class="keywordflow">    end if</span></div>
<div class="line"><a id="l03592" name="l03592"></a><span class="lineno"> 3592</span> </div>
<div class="line"><a id="l03593" name="l03593"></a><span class="lineno"> 3593</span>    <span class="comment">! Check for snow layers above lake with unfrozen top layer.  Mechanically,</span></div>
<div class="line"><a id="l03594" name="l03594"></a><span class="lineno"> 3594</span>    <span class="comment">! the snow will fall into the lake and melt or turn to ice.  If the top layer has</span></div>
<div class="line"><a id="l03595" name="l03595"></a><span class="lineno"> 3595</span>    <span class="comment">! sufficient heat to melt the snow without freezing, then that will be done.</span></div>
<div class="line"><a id="l03596" name="l03596"></a><span class="lineno"> 3596</span>    <span class="comment">! Otherwise, the top layer will undergo freezing, but only if the top layer will</span></div>
<div class="line"><a id="l03597" name="l03597"></a><span class="lineno"> 3597</span>    <span class="comment">! not freeze completely.  Otherwise, let the snow layers persist and melt by diffusion.</span></div>
<div class="line"><a id="l03598" name="l03598"></a><span class="lineno"> 3598</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03599" name="l03599"></a><span class="lineno"> 3599</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03600" name="l03600"></a><span class="lineno"> 3600</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l03601" name="l03601"></a><span class="lineno"> 3601</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l03602" name="l03602"></a><span class="lineno"> 3602</span> </div>
<div class="line"><a id="l03603" name="l03603"></a><span class="lineno"> 3603</span>          <span class="keywordflow">if</span> (t_lake(c,1) &gt; tfrz .and. lake_icefrac(c,1) == 0._kind_lake .and. snl(c) &lt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03604" name="l03604"></a><span class="lineno"> 3604</span>             unfrozen(c) = .true.</div>
<div class="line"><a id="l03605" name="l03605"></a><span class="lineno"> 3605</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l03606" name="l03606"></a><span class="lineno"> 3606</span>             unfrozen(c) = .false.</div>
<div class="line"><a id="l03607" name="l03607"></a><span class="lineno"> 3607</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03608" name="l03608"></a><span class="lineno"> 3608</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03609" name="l03609"></a><span class="lineno"> 3609</span> </div>
<div class="line"><a id="l03610" name="l03610"></a><span class="lineno"> 3610</span>    <span class="keywordflow">do</span> j = -nlevsnow+1,0</div>
<div class="line"><a id="l03611" name="l03611"></a><span class="lineno"> 3611</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03612" name="l03612"></a><span class="lineno"> 3612</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03613" name="l03613"></a><span class="lineno"> 3613</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l03614" name="l03614"></a><span class="lineno"> 3614</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l03615" name="l03615"></a><span class="lineno"> 3615</span> </div>
<div class="line"><a id="l03616" name="l03616"></a><span class="lineno"> 3616</span>          <span class="keywordflow">if</span> (unfrozen(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03617" name="l03617"></a><span class="lineno"> 3617</span>             <span class="keywordflow">if</span> (j == -nlevsnow+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03618" name="l03618"></a><span class="lineno"> 3618</span>                sumsnowice(c) = 0._kind_lake</div>
<div class="line"><a id="l03619" name="l03619"></a><span class="lineno"> 3619</span>                heatsum(c) = 0._kind_lake</div>
<div class="line"><a id="l03620" name="l03620"></a><span class="lineno"> 3620</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l03621" name="l03621"></a><span class="lineno"> 3621</span>             <span class="keywordflow">if</span> (j &gt;= snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03622" name="l03622"></a><span class="lineno"> 3622</span>                sumsnowice(c) = sumsnowice(c) + h2osoi_ice(c,j)</div>
<div class="line"><a id="l03623" name="l03623"></a><span class="lineno"> 3623</span>                heatsum(c) = heatsum(c) + h2osoi_ice(c,j)*cpice*(tfrz - t_soisno(c,j)) &amp;</div>
<div class="line"><a id="l03624" name="l03624"></a><span class="lineno"> 3624</span>                           + h2osoi_liq(c,j)*cpliq*(tfrz - t_soisno(c,j))</div>
<div class="line"><a id="l03625" name="l03625"></a><span class="lineno"> 3625</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l03626" name="l03626"></a><span class="lineno"> 3626</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03627" name="l03627"></a><span class="lineno"> 3627</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03628" name="l03628"></a><span class="lineno"> 3628</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03629" name="l03629"></a><span class="lineno"> 3629</span> </div>
<div class="line"><a id="l03630" name="l03630"></a><span class="lineno"> 3630</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03631" name="l03631"></a><span class="lineno"> 3631</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03632" name="l03632"></a><span class="lineno"> 3632</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l03633" name="l03633"></a><span class="lineno"> 3633</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l03634" name="l03634"></a><span class="lineno"> 3634</span> </div>
<div class="line"><a id="l03635" name="l03635"></a><span class="lineno"> 3635</span>          <span class="keywordflow">if</span> (unfrozen(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03636" name="l03636"></a><span class="lineno"> 3636</span>             heatsum(c) = heatsum(c) + sumsnowice(c)*hfus</div>
<div class="line"><a id="l03637" name="l03637"></a><span class="lineno"> 3637</span>             heatrem = (t_lake(c,1) - tfrz)*cpliq*denh2o*dz_lake(c,1) - heatsum(c)</div>
<div class="line"><a id="l03638" name="l03638"></a><span class="lineno"> 3638</span> </div>
<div class="line"><a id="l03639" name="l03639"></a><span class="lineno"> 3639</span>             <span class="keywordflow">if</span> (heatrem + denh2o*dz_lake(c,1)*hfus &gt; 0._kind_lake) <span class="keywordflow">then</span>            </div>
<div class="line"><a id="l03640" name="l03640"></a><span class="lineno"> 3640</span>                <span class="comment">! Remove snow and subtract the latent heat from the top layer.</span></div>
<div class="line"><a id="l03641" name="l03641"></a><span class="lineno"> 3641</span>                h2osno(c) = 0._kind_lake</div>
<div class="line"><a id="l03642" name="l03642"></a><span class="lineno"> 3642</span>                snl(c) = 0</div>
<div class="line"><a id="l03643" name="l03643"></a><span class="lineno"> 3643</span>                <span class="comment">! The rest of the bookkeeping for the removed snow will be done below.</span></div>
<div class="line"><a id="l03644" name="l03644"></a><span class="lineno"> 3644</span>                <span class="keywordflow">if</span> (debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03645" name="l03645"></a><span class="lineno"> 3645</span>                  print *,<span class="stringliteral">&#39;Snow layers removed above unfrozen lake for column, snowice:&#39;</span>, &amp;</div>
<div class="line"><a id="l03646" name="l03646"></a><span class="lineno"> 3646</span>                       c, sumsnowice(c)</div>
<div class="line"><a id="l03647" name="l03647"></a><span class="lineno"> 3647</span><span class="keywordflow">                endif</span></div>
<div class="line"><a id="l03648" name="l03648"></a><span class="lineno"> 3648</span>                <span class="keywordflow">if</span> (heatrem &gt; 0._kind_lake) <span class="keywordflow">then</span> <span class="comment">! simply subtract the heat from the layer</span></div>
<div class="line"><a id="l03649" name="l03649"></a><span class="lineno"> 3649</span>                   t_lake(c,1) = t_lake(c,1) - heatrem/(cpliq*denh2o*dz_lake(c,1))</div>
<div class="line"><a id="l03650" name="l03650"></a><span class="lineno"> 3650</span>                <span class="keywordflow">else</span> <span class="comment">!freeze part of the layer</span></div>
<div class="line"><a id="l03651" name="l03651"></a><span class="lineno"> 3651</span>                   t_lake(c,1) = tfrz</div>
<div class="line"><a id="l03652" name="l03652"></a><span class="lineno"> 3652</span>                   lake_icefrac(c,1) = -heatrem/(denh2o*dz_lake(c,1)*hfus)</div>
<div class="line"><a id="l03653" name="l03653"></a><span class="lineno"> 3653</span><span class="keywordflow">                end if</span></div>
<div class="line"><a id="l03654" name="l03654"></a><span class="lineno"> 3654</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l03655" name="l03655"></a><span class="lineno"> 3655</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03656" name="l03656"></a><span class="lineno"> 3656</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03657" name="l03657"></a><span class="lineno"> 3657</span>    <span class="comment">!!!!!!!!!!!!</span></div>
<div class="line"><a id="l03658" name="l03658"></a><span class="lineno"> 3658</span> </div>
<div class="line"><a id="l03659" name="l03659"></a><span class="lineno"> 3659</span>    <span class="comment">! Set snow age to zero if no snow</span></div>
<div class="line"><a id="l03660" name="l03660"></a><span class="lineno"> 3660</span> </div>
<div class="line"><a id="l03661" name="l03661"></a><span class="lineno"> 3661</span>       <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03662" name="l03662"></a><span class="lineno"> 3662</span>       <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03663" name="l03663"></a><span class="lineno"> 3663</span>    <span class="keywordflow">do</span> fc = 1, num_shlakesnowc</div>
<div class="line"><a id="l03664" name="l03664"></a><span class="lineno"> 3664</span>       c = filter_shlakesnowc(fc)</div>
<div class="line"><a id="l03665" name="l03665"></a><span class="lineno"> 3665</span>       <span class="keywordflow">if</span> (snl(c) == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03666" name="l03666"></a><span class="lineno"> 3666</span>          snowage(c) = 0._kind_lake</div>
<div class="line"><a id="l03667" name="l03667"></a><span class="lineno"> 3667</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l03668" name="l03668"></a><span class="lineno"> 3668</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03669" name="l03669"></a><span class="lineno"> 3669</span> </div>
<div class="line"><a id="l03670" name="l03670"></a><span class="lineno"> 3670</span>    <span class="comment">! Set empty snow layers to zero</span></div>
<div class="line"><a id="l03671" name="l03671"></a><span class="lineno"> 3671</span> </div>
<div class="line"><a id="l03672" name="l03672"></a><span class="lineno"> 3672</span>    <span class="keywordflow">do</span> j = -nlevsnow+1,0</div>
<div class="line"><a id="l03673" name="l03673"></a><span class="lineno"> 3673</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03674" name="l03674"></a><span class="lineno"> 3674</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03675" name="l03675"></a><span class="lineno"> 3675</span>       <span class="keywordflow">do</span> fc = 1, num_shlakesnowc</div>
<div class="line"><a id="l03676" name="l03676"></a><span class="lineno"> 3676</span>          c = filter_shlakesnowc(fc)</div>
<div class="line"><a id="l03677" name="l03677"></a><span class="lineno"> 3677</span>          <span class="keywordflow">if</span> (j &lt;= snl(c) .and. snl(c) &gt; -nlevsnow) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03678" name="l03678"></a><span class="lineno"> 3678</span>             h2osoi_ice(c,j) = 0._kind_lake</div>
<div class="line"><a id="l03679" name="l03679"></a><span class="lineno"> 3679</span>             h2osoi_liq(c,j) = 0._kind_lake</div>
<div class="line"><a id="l03680" name="l03680"></a><span class="lineno"> 3680</span>             t_soisno(c,j) = 0._kind_lake</div>
<div class="line"><a id="l03681" name="l03681"></a><span class="lineno"> 3681</span>             dz(c,j) = 0._kind_lake</div>
<div class="line"><a id="l03682" name="l03682"></a><span class="lineno"> 3682</span>             z(c,j) = 0._kind_lake</div>
<div class="line"><a id="l03683" name="l03683"></a><span class="lineno"> 3683</span>             zi(c,j-1) = 0._kind_lake</div>
<div class="line"><a id="l03684" name="l03684"></a><span class="lineno"> 3684</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03685" name="l03685"></a><span class="lineno"> 3685</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03686" name="l03686"></a><span class="lineno"> 3686</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03687" name="l03687"></a><span class="lineno"> 3687</span> </div>
<div class="line"><a id="l03688" name="l03688"></a><span class="lineno"> 3688</span>    <span class="comment">! Build new snow filter</span></div>
<div class="line"><a id="l03689" name="l03689"></a><span class="lineno"> 3689</span> </div>
<div class="line"><a id="l03690" name="l03690"></a><span class="lineno"> 3690</span>    <span class="keyword">call </span>buildsnowfilter(lbc, ubc, num_shlakec, filter_shlakec, snl,&amp;   <span class="comment">!i</span></div>
<div class="line"><a id="l03691" name="l03691"></a><span class="lineno"> 3691</span>         num_shlakesnowc, filter_shlakesnowc, num_shlakenosnowc, filter_shlakenosnowc) <span class="comment">!o</span></div>
<div class="line"><a id="l03692" name="l03692"></a><span class="lineno"> 3692</span> </div>
<div class="line"><a id="l03693" name="l03693"></a><span class="lineno"> 3693</span>    <span class="comment">! Vertically average t_soisno and sum of h2osoi_liq and h2osoi_ice</span></div>
<div class="line"><a id="l03694" name="l03694"></a><span class="lineno"> 3694</span>    <span class="comment">! over all snow layers for history output</span></div>
<div class="line"><a id="l03695" name="l03695"></a><span class="lineno"> 3695</span> </div>
<div class="line"><a id="l03696" name="l03696"></a><span class="lineno"> 3696</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03697" name="l03697"></a><span class="lineno"> 3697</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03698" name="l03698"></a><span class="lineno"> 3698</span>    <span class="keywordflow">do</span> fc = 1, num_shlakesnowc</div>
<div class="line"><a id="l03699" name="l03699"></a><span class="lineno"> 3699</span>       c = filter_shlakesnowc(fc)</div>
<div class="line"><a id="l03700" name="l03700"></a><span class="lineno"> 3700</span>       t_snow(c)  = 0._kind_lake</div>
<div class="line"><a id="l03701" name="l03701"></a><span class="lineno"> 3701</span>       snowice(c) = 0._kind_lake</div>
<div class="line"><a id="l03702" name="l03702"></a><span class="lineno"> 3702</span>       snowliq(c) = 0._kind_lake</div>
<div class="line"><a id="l03703" name="l03703"></a><span class="lineno"> 3703</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03704" name="l03704"></a><span class="lineno"> 3704</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03705" name="l03705"></a><span class="lineno"> 3705</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03706" name="l03706"></a><span class="lineno"> 3706</span>    <span class="keywordflow">do</span> fc = 1, num_shlakenosnowc</div>
<div class="line"><a id="l03707" name="l03707"></a><span class="lineno"> 3707</span>       c = filter_shlakenosnowc(fc)</div>
<div class="line"><a id="l03708" name="l03708"></a><span class="lineno"> 3708</span>       t_snow(c)  = spval</div>
<div class="line"><a id="l03709" name="l03709"></a><span class="lineno"> 3709</span>       snowice(c) = spval</div>
<div class="line"><a id="l03710" name="l03710"></a><span class="lineno"> 3710</span>       snowliq(c) = spval</div>
<div class="line"><a id="l03711" name="l03711"></a><span class="lineno"> 3711</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03712" name="l03712"></a><span class="lineno"> 3712</span> </div>
<div class="line"><a id="l03713" name="l03713"></a><span class="lineno"> 3713</span>    <span class="keywordflow">do</span> j = -nlevsnow+1, 0</div>
<div class="line"><a id="l03714" name="l03714"></a><span class="lineno"> 3714</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03715" name="l03715"></a><span class="lineno"> 3715</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03716" name="l03716"></a><span class="lineno"> 3716</span>       <span class="keywordflow">do</span> fc = 1, num_shlakesnowc</div>
<div class="line"><a id="l03717" name="l03717"></a><span class="lineno"> 3717</span>          c = filter_shlakesnowc(fc)</div>
<div class="line"><a id="l03718" name="l03718"></a><span class="lineno"> 3718</span>          <span class="keywordflow">if</span> (j &gt;= snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03719" name="l03719"></a><span class="lineno"> 3719</span>             t_snow(c)  = t_snow(c) + t_soisno(c,j)</div>
<div class="line"><a id="l03720" name="l03720"></a><span class="lineno"> 3720</span>             snowice(c) = snowice(c) + h2osoi_ice(c,j)</div>
<div class="line"><a id="l03721" name="l03721"></a><span class="lineno"> 3721</span>             snowliq(c) = snowliq(c) + h2osoi_liq(c,j)</div>
<div class="line"><a id="l03722" name="l03722"></a><span class="lineno"> 3722</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03723" name="l03723"></a><span class="lineno"> 3723</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03724" name="l03724"></a><span class="lineno"> 3724</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03725" name="l03725"></a><span class="lineno"> 3725</span> </div>
<div class="line"><a id="l03726" name="l03726"></a><span class="lineno"> 3726</span>    <span class="comment">! Determine ending water balance and volumetric soil water</span></div>
<div class="line"><a id="l03727" name="l03727"></a><span class="lineno"> 3727</span> </div>
<div class="line"><a id="l03728" name="l03728"></a><span class="lineno"> 3728</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03729" name="l03729"></a><span class="lineno"> 3729</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03730" name="l03730"></a><span class="lineno"> 3730</span>    <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l03731" name="l03731"></a><span class="lineno"> 3731</span>       </div>
<div class="line"><a id="l03732" name="l03732"></a><span class="lineno"> 3732</span>       c = filter_shlakec(fc)</div>
<div class="line"><a id="l03733" name="l03733"></a><span class="lineno"> 3733</span>       <span class="keywordflow">if</span> (snl(c) &lt; 0) t_snow(c) = t_snow(c)/abs(snl(c))</div>
<div class="line"><a id="l03734" name="l03734"></a><span class="lineno"> 3734</span>       endwb(c) = h2osno(c)</div>
<div class="line"><a id="l03735" name="l03735"></a><span class="lineno"> 3735</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03736" name="l03736"></a><span class="lineno"> 3736</span> </div>
<div class="line"><a id="l03737" name="l03737"></a><span class="lineno"> 3737</span>    <span class="keywordflow">do</span> j = 1, nlevsoil</div>
<div class="line"><a id="l03738" name="l03738"></a><span class="lineno"> 3738</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03739" name="l03739"></a><span class="lineno"> 3739</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03740" name="l03740"></a><span class="lineno"> 3740</span>       <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l03741" name="l03741"></a><span class="lineno"> 3741</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l03742" name="l03742"></a><span class="lineno"> 3742</span>          endwb(c) = endwb(c) + h2osoi_ice(c,j) + h2osoi_liq(c,j)</div>
<div class="line"><a id="l03743" name="l03743"></a><span class="lineno"> 3743</span>          h2osoi_vol(c,j) = h2osoi_liq(c,j)/(dz(c,j)*denh2o) + h2osoi_ice(c,j)/(dz(c,j)*denice)</div>
<div class="line"><a id="l03744" name="l03744"></a><span class="lineno"> 3744</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03745" name="l03745"></a><span class="lineno"> 3745</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03746" name="l03746"></a><span class="lineno"> 3746</span> </div>
<div class="line"><a id="l03747" name="l03747"></a><span class="lineno"> 3747</span>    check_add_snow_water: <span class="keywordflow">if</span>(lakedebug) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03748" name="l03748"></a><span class="lineno"> 3748</span>      <span class="keyword">allocate</span>(snow_water(lbc:ubc))</div>
<div class="line"><a id="l03749" name="l03749"></a><span class="lineno"> 3749</span>      <span class="comment">! Check to make sure snow water adds up correctly.</span></div>
<div class="line"><a id="l03750" name="l03750"></a><span class="lineno"> 3750</span>      <span class="keywordflow">do</span> j = -nlevsnow+1,0</div>
<div class="line"><a id="l03751" name="l03751"></a><span class="lineno"> 3751</span>        <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03752" name="l03752"></a><span class="lineno"> 3752</span>        <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03753" name="l03753"></a><span class="lineno"> 3753</span>        <span class="keywordflow">do</span> fc = 1, num_shlakec</div>
<div class="line"><a id="l03754" name="l03754"></a><span class="lineno"> 3754</span>          c = filter_shlakec(fc)</div>
<div class="line"><a id="l03755" name="l03755"></a><span class="lineno"> 3755</span> </div>
<div class="line"><a id="l03756" name="l03756"></a><span class="lineno"> 3756</span>          jtop = snl(c)+1</div>
<div class="line"><a id="l03757" name="l03757"></a><span class="lineno"> 3757</span>          <span class="keywordflow">if</span>(j == jtop) snow_water(c) = 0._kind_lake</div>
<div class="line"><a id="l03758" name="l03758"></a><span class="lineno"> 3758</span>          <span class="keywordflow">if</span>(j &gt;= jtop) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03759" name="l03759"></a><span class="lineno"> 3759</span>            snow_water(c) = snow_water(c) + h2osoi_ice(c,j) + h2osoi_liq(c,j)</div>
<div class="line"><a id="l03760" name="l03760"></a><span class="lineno"> 3760</span>            <span class="keywordflow">if</span>(j == 0 .and. abs(snow_water(c)-h2osno(c))&gt;1.e-7_kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03761" name="l03761"></a><span class="lineno"> 3761</span>              <span class="keyword">write</span>(message,*)<span class="stringliteral">&#39;h2osno does not equal sum of snow layers in ShalLakeHydrology:&#39;</span>, &amp;</div>
<div class="line"><a id="l03762" name="l03762"></a><span class="lineno"> 3762</span>                   <span class="stringliteral">&#39;column, h2osno, sum of snow layers =&#39;</span>, c, h2osno(c), snow_water(c)</div>
<div class="line"><a id="l03763" name="l03763"></a><span class="lineno"> 3763</span>              <span class="comment">! errmsg=trim(message)</span></div>
<div class="line"><a id="l03764" name="l03764"></a><span class="lineno"> 3764</span>              <span class="comment">! errflg=1</span></div>
<div class="line"><a id="l03765" name="l03765"></a><span class="lineno"> 3765</span>              <span class="keyword">write</span>(0,<span class="stringliteral">&#39;(A)&#39;</span>) trim(message)</div>
<div class="line"><a id="l03766" name="l03766"></a><span class="lineno"> 3766</span><span class="keywordflow">            end if</span></div>
<div class="line"><a id="l03767" name="l03767"></a><span class="lineno"> 3767</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03768" name="l03768"></a><span class="lineno"> 3768</span><span class="keywordflow">        end do</span></div>
<div class="line"><a id="l03769" name="l03769"></a><span class="lineno"> 3769</span><span class="keywordflow">      end do</span></div>
<div class="line"><a id="l03770" name="l03770"></a><span class="lineno"> 3770</span>      <span class="keyword">deallocate</span>(snow_water)</div>
<div class="line"><a id="l03771" name="l03771"></a><span class="lineno"> 3771</span><span class="keywordflow">    end if</span> check_add_snow_water</div>
<div class="line"><a id="l03772" name="l03772"></a><span class="lineno"> 3772</span> </div>
<div class="line"><a id="l03773" name="l03773"></a><span class="lineno"> 3773</span>    <span class="comment">!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l03774" name="l03774"></a><span class="lineno"> 3774</span>    <span class="comment">! Do history variables and set special landunit runoff (adapted from end of HydrologyLake)</span></div>
<div class="line"><a id="l03775" name="l03775"></a><span class="lineno"> 3775</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03776" name="l03776"></a><span class="lineno"> 3776</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03777" name="l03777"></a><span class="lineno"> 3777</span>    <span class="keywordflow">do</span> fp = 1,num_shlakep</div>
<div class="line"><a id="l03778" name="l03778"></a><span class="lineno"> 3778</span>       p = filter_shlakep(fp)</div>
<div class="line"><a id="l03779" name="l03779"></a><span class="lineno"> 3779</span>       c = pcolumn(p)</div>
<div class="line"><a id="l03780" name="l03780"></a><span class="lineno"> 3780</span>       g = pgridcell(p)</div>
<div class="line"><a id="l03781" name="l03781"></a><span class="lineno"> 3781</span> </div>
<div class="line"><a id="l03782" name="l03782"></a><span class="lineno"> 3782</span>       qflx_infl(c)      = 0._kind_lake</div>
<div class="line"><a id="l03783" name="l03783"></a><span class="lineno"> 3783</span>       qflx_surf(c)      = 0._kind_lake</div>
<div class="line"><a id="l03784" name="l03784"></a><span class="lineno"> 3784</span>       qflx_drain(c)     = 0._kind_lake</div>
<div class="line"><a id="l03785" name="l03785"></a><span class="lineno"> 3785</span>       rootr_column(c,:) = spval</div>
<div class="line"><a id="l03786" name="l03786"></a><span class="lineno"> 3786</span>       soilalpha(c)      = spval</div>
<div class="line"><a id="l03787" name="l03787"></a><span class="lineno"> 3787</span>       zwt(c)            = spval</div>
<div class="line"><a id="l03788" name="l03788"></a><span class="lineno"> 3788</span>       fcov(c)           = spval</div>
<div class="line"><a id="l03789" name="l03789"></a><span class="lineno"> 3789</span>       qcharge(c)        = spval</div>
<div class="line"><a id="l03790" name="l03790"></a><span class="lineno"> 3790</span>       <span class="comment">!       h2osoi_vol(c,:)   = spval</span></div>
<div class="line"><a id="l03791" name="l03791"></a><span class="lineno"> 3791</span> </div>
<div class="line"><a id="l03792" name="l03792"></a><span class="lineno"> 3792</span>       <span class="comment">! Insure water balance using qflx_qrgwl</span></div>
<div class="line"><a id="l03793" name="l03793"></a><span class="lineno"> 3793</span>       qflx_qrgwl(c)     = forc_rain(g) + forc_snow(g) - qflx_evap_tot(p) - (endwb(c)-begwb(c))/dtime</div>
<div class="line"><a id="l03794" name="l03794"></a><span class="lineno"> 3794</span>       <span class="keywordflow">if</span> (debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03795" name="l03795"></a><span class="lineno"> 3795</span>         print *,<span class="stringliteral">&#39;c, rain, snow, evap, endwb, begwb, qflx_qrgwl:&#39;</span>, &amp;</div>
<div class="line"><a id="l03796" name="l03796"></a><span class="lineno"> 3796</span>              c, forc_rain(g), forc_snow(g), qflx_evap_tot(p), endwb(c), begwb(c), qflx_qrgwl(c)</div>
<div class="line"><a id="l03797" name="l03797"></a><span class="lineno"> 3797</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l03798" name="l03798"></a><span class="lineno"> 3798</span> </div>
<div class="line"><a id="l03799" name="l03799"></a><span class="lineno"> 3799</span>       <span class="comment">! The pft average must be done here for output to history tape</span></div>
<div class="line"><a id="l03800" name="l03800"></a><span class="lineno"> 3800</span>       qflx_evap_tot_col(c) = qflx_evap_tot(p)</div>
<div class="line"><a id="l03801" name="l03801"></a><span class="lineno"> 3801</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03802" name="l03802"></a><span class="lineno"> 3802</span>    </div>
</div>
<div class="line"><a id="l03803" name="l03803"></a><span class="lineno"> 3803</span>  <span class="keyword">end subroutine </span>shallakehydrology</div>
<div class="line"><a id="l03804" name="l03804"></a><span class="lineno"> 3804</span> </div>
<div class="line"><a id="l03805" name="l03805"></a><span class="lineno"> 3805</span><span class="comment">! DESCRIPTION:</span><span class="comment"></span></div>
<div class="line"><a id="l03806" name="l03806"></a><span class="lineno"> 3806</span><span class="comment">!&gt; Computes saturation mixing ratio and the change in saturation</span></div>
<div class="line"><a id="l03807" name="l03807"></a><span class="lineno"> 3807</span><span class="comment">!! mixing ratio with respect to temperature.</span></div>
<div class="foldopen" id="foldopen03808" data-start="" data-end="">
<div class="line"><a id="l03808" name="l03808"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a437b2ee0be000163d1867e02d4adbb5e.html#a437b2ee0be000163d1867e02d4adbb5e"> 3808</a></span>  <span class="keyword">subroutine </span>qsat (T, p, es, esdT, qs, qsdT)</div>
<div class="line"><a id="l03809" name="l03809"></a><span class="lineno"> 3809</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03810" name="l03810"></a><span class="lineno"> 3810</span>    <span class="comment">! Reference:  Polynomial approximations from:</span></div>
<div class="line"><a id="l03811" name="l03811"></a><span class="lineno"> 3811</span>    <span class="comment">!             Piotr J. Flatau, et al.,1992:  Polynomial fits to saturation</span></div>
<div class="line"><a id="l03812" name="l03812"></a><span class="lineno"> 3812</span>    <span class="comment">!             vapor pressure.  Journal of Applied Meteorology, 31, 1507-1513.</span></div>
<div class="line"><a id="l03813" name="l03813"></a><span class="lineno"> 3813</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03814" name="l03814"></a><span class="lineno"> 3814</span>    <span class="comment">! USES:</span></div>
<div class="line"><a id="l03815" name="l03815"></a><span class="lineno"> 3815</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03816" name="l03816"></a><span class="lineno"> 3816</span>    <span class="comment">! ARGUMENTS:</span></div>
<div class="line"><a id="l03817" name="l03817"></a><span class="lineno"> 3817</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l03818" name="l03818"></a><span class="lineno"> 3818</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: T<span class="comment">        !&lt; temperature (K)</span></div>
<div class="line"><a id="l03819" name="l03819"></a><span class="lineno"> 3819</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: p<span class="comment">        !&lt; surface atmospheric pressure (pa)</span></div>
<div class="line"><a id="l03820" name="l03820"></a><span class="lineno"> 3820</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: es<span class="comment">       !&lt; vapor pressure (pa)</span></div>
<div class="line"><a id="l03821" name="l03821"></a><span class="lineno"> 3821</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: esdT<span class="comment">     !&lt; d(es)/d(T)</span></div>
<div class="line"><a id="l03822" name="l03822"></a><span class="lineno"> 3822</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qs<span class="comment">       !&lt; humidity (kg/kg)</span></div>
<div class="line"><a id="l03823" name="l03823"></a><span class="lineno"> 3823</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qsdT<span class="comment">     !&lt; d(qs)/d(T)</span></div>
<div class="line"><a id="l03824" name="l03824"></a><span class="lineno"> 3824</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03825" name="l03825"></a><span class="lineno"> 3825</span>    <span class="comment">! !CALLED FROM:</span></div>
<div class="line"><a id="l03826" name="l03826"></a><span class="lineno"> 3826</span>    <span class="comment">! subroutine Biogeophysics1 in module Biogeophysics1Mod</span></div>
<div class="line"><a id="l03827" name="l03827"></a><span class="lineno"> 3827</span>    <span class="comment">! subroutine BiogeophysicsLake in module BiogeophysicsLakeMod</span></div>
<div class="line"><a id="l03828" name="l03828"></a><span class="lineno"> 3828</span>    <span class="comment">! subroutine CanopyFluxesMod CanopyFluxesMod</span></div>
<div class="line"><a id="l03829" name="l03829"></a><span class="lineno"> 3829</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03830" name="l03830"></a><span class="lineno"> 3830</span>    <span class="comment">! !REVISION HISTORY:</span></div>
<div class="line"><a id="l03831" name="l03831"></a><span class="lineno"> 3831</span>    <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l03832" name="l03832"></a><span class="lineno"> 3832</span>    <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l03833" name="l03833"></a><span class="lineno"> 3833</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03834" name="l03834"></a><span class="lineno"> 3834</span>    <span class="comment">!EOP</span></div>
<div class="line"><a id="l03835" name="l03835"></a><span class="lineno"> 3835</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03836" name="l03836"></a><span class="lineno"> 3836</span>    <span class="comment">! !LOCAL VARIABLES:</span></div>
<div class="line"><a id="l03837" name="l03837"></a><span class="lineno"> 3837</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03838" name="l03838"></a><span class="lineno"> 3838</span><span class="keywordtype">    real</span>(kind_lake) :: T_limit</div>
<div class="line"><a id="l03839" name="l03839"></a><span class="lineno"> 3839</span><span class="keywordtype">    real</span>(kind_lake) :: td,vp,vp1,vp2</div>
<div class="line"><a id="l03840" name="l03840"></a><span class="lineno"> 3840</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03841" name="l03841"></a><span class="lineno"> 3841</span>    <span class="comment">! For water vapor (temperature range 0C-100C)</span></div>
<div class="line"><a id="l03842" name="l03842"></a><span class="lineno"> 3842</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03843" name="l03843"></a><span class="lineno"> 3843</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: a0 =  6.11213476</div>
<div class="line"><a id="l03844" name="l03844"></a><span class="lineno"> 3844</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: a1 =  0.444007856</div>
<div class="line"><a id="l03845" name="l03845"></a><span class="lineno"> 3845</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: a2 =  0.143064234e-01</div>
<div class="line"><a id="l03846" name="l03846"></a><span class="lineno"> 3846</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: a3 =  0.264461437e-03</div>
<div class="line"><a id="l03847" name="l03847"></a><span class="lineno"> 3847</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: a4 =  0.305903558e-05</div>
<div class="line"><a id="l03848" name="l03848"></a><span class="lineno"> 3848</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: a5 =  0.196237241e-07</div>
<div class="line"><a id="l03849" name="l03849"></a><span class="lineno"> 3849</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: a6 =  0.892344772e-10</div>
<div class="line"><a id="l03850" name="l03850"></a><span class="lineno"> 3850</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: a7 = -0.373208410e-12</div>
<div class="line"><a id="l03851" name="l03851"></a><span class="lineno"> 3851</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: a8 =  0.209339997e-15</div>
<div class="line"><a id="l03852" name="l03852"></a><span class="lineno"> 3852</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03853" name="l03853"></a><span class="lineno"> 3853</span>    <span class="comment">! For derivative:water vapor</span></div>
<div class="line"><a id="l03854" name="l03854"></a><span class="lineno"> 3854</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03855" name="l03855"></a><span class="lineno"> 3855</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: b0 =  0.444017302</div>
<div class="line"><a id="l03856" name="l03856"></a><span class="lineno"> 3856</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: b1 =  0.286064092e-01</div>
<div class="line"><a id="l03857" name="l03857"></a><span class="lineno"> 3857</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: b2 =  0.794683137e-03</div>
<div class="line"><a id="l03858" name="l03858"></a><span class="lineno"> 3858</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: b3 =  0.121211669e-04</div>
<div class="line"><a id="l03859" name="l03859"></a><span class="lineno"> 3859</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: b4 =  0.103354611e-06</div>
<div class="line"><a id="l03860" name="l03860"></a><span class="lineno"> 3860</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: b5 =  0.404125005e-09</div>
<div class="line"><a id="l03861" name="l03861"></a><span class="lineno"> 3861</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: b6 = -0.788037859e-12</div>
<div class="line"><a id="l03862" name="l03862"></a><span class="lineno"> 3862</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: b7 = -0.114596802e-13</div>
<div class="line"><a id="l03863" name="l03863"></a><span class="lineno"> 3863</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: b8 =  0.381294516e-16</div>
<div class="line"><a id="l03864" name="l03864"></a><span class="lineno"> 3864</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03865" name="l03865"></a><span class="lineno"> 3865</span>    <span class="comment">! For ice (temperature range -75C-0C)</span></div>
<div class="line"><a id="l03866" name="l03866"></a><span class="lineno"> 3866</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03867" name="l03867"></a><span class="lineno"> 3867</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c0 =  6.11123516</div>
<div class="line"><a id="l03868" name="l03868"></a><span class="lineno"> 3868</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c1 =  0.503109514</div>
<div class="line"><a id="l03869" name="l03869"></a><span class="lineno"> 3869</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c2 =  0.188369801e-01</div>
<div class="line"><a id="l03870" name="l03870"></a><span class="lineno"> 3870</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c3 =  0.420547422e-03</div>
<div class="line"><a id="l03871" name="l03871"></a><span class="lineno"> 3871</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c4 =  0.614396778e-05</div>
<div class="line"><a id="l03872" name="l03872"></a><span class="lineno"> 3872</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c5 =  0.602780717e-07</div>
<div class="line"><a id="l03873" name="l03873"></a><span class="lineno"> 3873</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c6 =  0.387940929e-09</div>
<div class="line"><a id="l03874" name="l03874"></a><span class="lineno"> 3874</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c7 =  0.149436277e-11</div>
<div class="line"><a id="l03875" name="l03875"></a><span class="lineno"> 3875</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c8 =  0.262655803e-14</div>
<div class="line"><a id="l03876" name="l03876"></a><span class="lineno"> 3876</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03877" name="l03877"></a><span class="lineno"> 3877</span>    <span class="comment">! For derivative:ice</span></div>
<div class="line"><a id="l03878" name="l03878"></a><span class="lineno"> 3878</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03879" name="l03879"></a><span class="lineno"> 3879</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: d0 =  0.503277922</div>
<div class="line"><a id="l03880" name="l03880"></a><span class="lineno"> 3880</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: d1 =  0.377289173e-01</div>
<div class="line"><a id="l03881" name="l03881"></a><span class="lineno"> 3881</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: d2 =  0.126801703e-02</div>
<div class="line"><a id="l03882" name="l03882"></a><span class="lineno"> 3882</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: d3 =  0.249468427e-04</div>
<div class="line"><a id="l03883" name="l03883"></a><span class="lineno"> 3883</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: d4 =  0.313703411e-06</div>
<div class="line"><a id="l03884" name="l03884"></a><span class="lineno"> 3884</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: d5 =  0.257180651e-08</div>
<div class="line"><a id="l03885" name="l03885"></a><span class="lineno"> 3885</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: d6 =  0.133268878e-10</div>
<div class="line"><a id="l03886" name="l03886"></a><span class="lineno"> 3886</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: d7 =  0.394116744e-13</div>
<div class="line"><a id="l03887" name="l03887"></a><span class="lineno"> 3887</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: d8 =  0.498070196e-16</div>
<div class="line"><a id="l03888" name="l03888"></a><span class="lineno"> 3888</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03889" name="l03889"></a><span class="lineno"> 3889</span> </div>
<div class="line"><a id="l03890" name="l03890"></a><span class="lineno"> 3890</span>    t_limit = t - tfrz</div>
<div class="line"><a id="l03891" name="l03891"></a><span class="lineno"> 3891</span>    <span class="keywordflow">if</span> (t_limit &gt; 100.0) t_limit=100.0</div>
<div class="line"><a id="l03892" name="l03892"></a><span class="lineno"> 3892</span>    <span class="keywordflow">if</span> (t_limit &lt; -75.0) t_limit=-75.0</div>
<div class="line"><a id="l03893" name="l03893"></a><span class="lineno"> 3893</span> </div>
<div class="line"><a id="l03894" name="l03894"></a><span class="lineno"> 3894</span>    td       = t_limit</div>
<div class="line"><a id="l03895" name="l03895"></a><span class="lineno"> 3895</span>    <span class="keywordflow">if</span> (td &gt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03896" name="l03896"></a><span class="lineno"> 3896</span>       es   = a0 + td*(a1 + td*(a2 + td*(a3 + td*(a4 &amp;</div>
<div class="line"><a id="l03897" name="l03897"></a><span class="lineno"> 3897</span>            + td*(a5 + td*(a6 + td*(a7 + td*a8)))))))</div>
<div class="line"><a id="l03898" name="l03898"></a><span class="lineno"> 3898</span>       esdt = b0 + td*(b1 + td*(b2 + td*(b3 + td*(b4 &amp;</div>
<div class="line"><a id="l03899" name="l03899"></a><span class="lineno"> 3899</span>            + td*(b5 + td*(b6 + td*(b7 + td*b8)))))))</div>
<div class="line"><a id="l03900" name="l03900"></a><span class="lineno"> 3900</span>    <span class="keywordflow">else</span></div>
<div class="line"><a id="l03901" name="l03901"></a><span class="lineno"> 3901</span>       es   = c0 + td*(c1 + td*(c2 + td*(c3 + td*(c4 &amp;</div>
<div class="line"><a id="l03902" name="l03902"></a><span class="lineno"> 3902</span>            + td*(c5 + td*(c6 + td*(c7 + td*c8)))))))</div>
<div class="line"><a id="l03903" name="l03903"></a><span class="lineno"> 3903</span>       esdt = d0 + td*(d1 + td*(d2 + td*(d3 + td*(d4 &amp;</div>
<div class="line"><a id="l03904" name="l03904"></a><span class="lineno"> 3904</span>            + td*(d5 + td*(d6 + td*(d7 + td*d8)))))))</div>
<div class="line"><a id="l03905" name="l03905"></a><span class="lineno"> 3905</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l03906" name="l03906"></a><span class="lineno"> 3906</span> </div>
<div class="line"><a id="l03907" name="l03907"></a><span class="lineno"> 3907</span>    es    = es    * 100.            <span class="comment">! pa</span></div>
<div class="line"><a id="l03908" name="l03908"></a><span class="lineno"> 3908</span>    esdt  = esdt  * 100.            <span class="comment">! pa/K</span></div>
<div class="line"><a id="l03909" name="l03909"></a><span class="lineno"> 3909</span> </div>
<div class="line"><a id="l03910" name="l03910"></a><span class="lineno"> 3910</span>    vp    = 1.0   / (p - one_minus_con_eps*es)</div>
<div class="line"><a id="l03911" name="l03911"></a><span class="lineno"> 3911</span>    vp1   = 0.622 * vp</div>
<div class="line"><a id="l03912" name="l03912"></a><span class="lineno"> 3912</span>    vp2   = vp1   * vp</div>
<div class="line"><a id="l03913" name="l03913"></a><span class="lineno"> 3913</span> </div>
<div class="line"><a id="l03914" name="l03914"></a><span class="lineno"> 3914</span>    qs    = es    * vp1             <span class="comment">! kg/kg</span></div>
<div class="line"><a id="l03915" name="l03915"></a><span class="lineno"> 3915</span>    qsdt  = esdt  * vp2 * p         <span class="comment">! 1 / K</span></div>
<div class="line"><a id="l03916" name="l03916"></a><span class="lineno"> 3916</span> </div>
</div>
<div class="line"><a id="l03917" name="l03917"></a><span class="lineno"> 3917</span>  <span class="keyword">end subroutine </span>qsat</div>
<div class="line"><a id="l03918" name="l03918"></a><span class="lineno"> 3918</span> </div>
<div class="line"><a id="l03919" name="l03919"></a><span class="lineno"> 3919</span> </div>
<div class="foldopen" id="foldopen03920" data-start="" data-end="">
<div class="line"><a id="l03920" name="l03920"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ada6f05d21d094d9d20ed6e0bd851a3fa.html#ada6f05d21d094d9d20ed6e0bd851a3fa"> 3920</a></span>  <span class="keyword">subroutine </span>tridiagonal (lbc, ubc, lbj, ubj, jtop, numf, filter, &amp;</div>
<div class="line"><a id="l03921" name="l03921"></a><span class="lineno"> 3921</span>                          a, b, c, r, u)</div>
<div class="line"><a id="l03922" name="l03922"></a><span class="lineno"> 3922</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03923" name="l03923"></a><span class="lineno"> 3923</span>    <span class="comment">! DESCRIPTION:</span></div>
<div class="line"><a id="l03924" name="l03924"></a><span class="lineno"> 3924</span>    <span class="comment">!&lt; Tridiagonal matrix solution</span></div>
<div class="line"><a id="l03925" name="l03925"></a><span class="lineno"> 3925</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03926" name="l03926"></a><span class="lineno"> 3926</span>    <span class="comment">! ARGUMENTS:</span></div>
<div class="line"><a id="l03927" name="l03927"></a><span class="lineno"> 3927</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l03928" name="l03928"></a><span class="lineno"> 3928</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span>    :: lbc, ubc<span class="comment">               !&lt; lbinning and ubing column indices</span></div>
<div class="line"><a id="l03929" name="l03929"></a><span class="lineno"> 3929</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span>    :: lbj, ubj<span class="comment">               !&lt; lbinning and ubing level indices</span></div>
<div class="line"><a id="l03930" name="l03930"></a><span class="lineno"> 3930</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span>    :: jtop(lbc:ubc)<span class="comment">          !&lt; top level for each column</span></div>
<div class="line"><a id="l03931" name="l03931"></a><span class="lineno"> 3931</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span>    :: numf<span class="comment">                   !&lt; filter dimension</span></div>
<div class="line"><a id="l03932" name="l03932"></a><span class="lineno"> 3932</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span>    :: filter(1:numf)<span class="comment">         !&lt; filter</span></div>
<div class="line"><a id="l03933" name="l03933"></a><span class="lineno"> 3933</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>    :: a(lbc:ubc, lbj:ubj)<span class="comment">    !&lt; &quot;a&quot; left off diagonal of tridiagonal matrix</span></div>
<div class="line"><a id="l03934" name="l03934"></a><span class="lineno"> 3934</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>    :: b(lbc:ubc, lbj:ubj)<span class="comment">    !&lt; &quot;b&quot; diagonal column for tridiagonal matrix</span></div>
<div class="line"><a id="l03935" name="l03935"></a><span class="lineno"> 3935</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>    :: c(lbc:ubc, lbj:ubj)<span class="comment">    !&lt; &quot;c&quot; right off diagonal tridiagonal matrix</span></div>
<div class="line"><a id="l03936" name="l03936"></a><span class="lineno"> 3936</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>    :: r(lbc:ubc, lbj:ubj)<span class="comment">    !&lt; &quot;r&quot; forcing term of tridiagonal matrix</span></div>
<div class="line"><a id="l03937" name="l03937"></a><span class="lineno"> 3937</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: u(lbc:ubc, lbj:ubj)<span class="comment">    !&lt; solution</span></div>
<div class="line"><a id="l03938" name="l03938"></a><span class="lineno"> 3938</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03939" name="l03939"></a><span class="lineno"> 3939</span>    <span class="comment">! !CALLED FROM:</span></div>
<div class="line"><a id="l03940" name="l03940"></a><span class="lineno"> 3940</span>    <span class="comment">! subroutine BiogeophysicsLake in module BiogeophysicsLakeMod</span></div>
<div class="line"><a id="l03941" name="l03941"></a><span class="lineno"> 3941</span>    <span class="comment">! subroutine SoilTemperature in module SoilTemperatureMod</span></div>
<div class="line"><a id="l03942" name="l03942"></a><span class="lineno"> 3942</span>    <span class="comment">! subroutine SoilWater in module HydrologyMod</span></div>
<div class="line"><a id="l03943" name="l03943"></a><span class="lineno"> 3943</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03944" name="l03944"></a><span class="lineno"> 3944</span>    <span class="comment">! !REVISION HISTORY:</span></div>
<div class="line"><a id="l03945" name="l03945"></a><span class="lineno"> 3945</span>    <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l03946" name="l03946"></a><span class="lineno"> 3946</span>    <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l03947" name="l03947"></a><span class="lineno"> 3947</span>    <span class="comment">!  1 July 2003: Mariana Vertenstein; modified for vectorization</span></div>
<div class="line"><a id="l03948" name="l03948"></a><span class="lineno"> 3948</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03949" name="l03949"></a><span class="lineno"> 3949</span>    <span class="comment">!EOP</span></div>
<div class="line"><a id="l03950" name="l03950"></a><span class="lineno"> 3950</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03951" name="l03951"></a><span class="lineno"> 3951</span>    <span class="comment">! !OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l03952" name="l03952"></a><span class="lineno"> 3952</span>    <span class="comment">!</span></div>
<div class="line"><a id="l03953" name="l03953"></a><span class="lineno"> 3953</span>    <span class="keywordtype">integer</span>  :: j,ci,fc                   <span class="comment">!indices</span></div>
<div class="line"><a id="l03954" name="l03954"></a><span class="lineno"> 3954</span><span class="keywordtype">    real</span>(kind_lake) :: gam(lbc:ubc,lbj:ubj)      <span class="comment">!temporary</span></div>
<div class="line"><a id="l03955" name="l03955"></a><span class="lineno"> 3955</span><span class="keywordtype">    real</span>(kind_lake) :: bet(lbc:ubc)              <span class="comment">!temporary</span></div>
<div class="line"><a id="l03956" name="l03956"></a><span class="lineno"> 3956</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l03957" name="l03957"></a><span class="lineno"> 3957</span> </div>
<div class="line"><a id="l03958" name="l03958"></a><span class="lineno"> 3958</span>    <span class="comment">! Solve the matrix</span></div>
<div class="line"><a id="l03959" name="l03959"></a><span class="lineno"> 3959</span> </div>
<div class="line"><a id="l03960" name="l03960"></a><span class="lineno"> 3960</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03961" name="l03961"></a><span class="lineno"> 3961</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03962" name="l03962"></a><span class="lineno"> 3962</span>    <span class="keywordflow">do</span> fc = 1,numf</div>
<div class="line"><a id="l03963" name="l03963"></a><span class="lineno"> 3963</span>       ci = filter(fc)</div>
<div class="line"><a id="l03964" name="l03964"></a><span class="lineno"> 3964</span>       bet(ci) = b(ci,jtop(ci))</div>
<div class="line"><a id="l03965" name="l03965"></a><span class="lineno"> 3965</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03966" name="l03966"></a><span class="lineno"> 3966</span> </div>
<div class="line"><a id="l03967" name="l03967"></a><span class="lineno"> 3967</span>    <span class="keywordflow">do</span> j = lbj, ubj</div>
<div class="line"><a id="l03968" name="l03968"></a><span class="lineno"> 3968</span>      <span class="comment">!dir$ prefervector</span></div>
<div class="line"><a id="l03969" name="l03969"></a><span class="lineno"> 3969</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03970" name="l03970"></a><span class="lineno"> 3970</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03971" name="l03971"></a><span class="lineno"> 3971</span>       <span class="keywordflow">do</span> fc = 1,numf</div>
<div class="line"><a id="l03972" name="l03972"></a><span class="lineno"> 3972</span>          ci = filter(fc)</div>
<div class="line"><a id="l03973" name="l03973"></a><span class="lineno"> 3973</span>          <span class="keywordflow">if</span> (j &gt;= jtop(ci)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03974" name="l03974"></a><span class="lineno"> 3974</span>             <span class="keywordflow">if</span> (j == jtop(ci)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03975" name="l03975"></a><span class="lineno"> 3975</span>                u(ci,j) = r(ci,j) / bet(ci)</div>
<div class="line"><a id="l03976" name="l03976"></a><span class="lineno"> 3976</span>             <span class="keywordflow">else</span></div>
<div class="line"><a id="l03977" name="l03977"></a><span class="lineno"> 3977</span>                gam(ci,j) = c(ci,j-1) / bet(ci)</div>
<div class="line"><a id="l03978" name="l03978"></a><span class="lineno"> 3978</span>                bet(ci) = b(ci,j) - a(ci,j) * gam(ci,j)</div>
<div class="line"><a id="l03979" name="l03979"></a><span class="lineno"> 3979</span>                u(ci,j) = (r(ci,j) - a(ci,j)*u(ci,j-1)) / bet(ci)</div>
<div class="line"><a id="l03980" name="l03980"></a><span class="lineno"> 3980</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l03981" name="l03981"></a><span class="lineno"> 3981</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03982" name="l03982"></a><span class="lineno"> 3982</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03983" name="l03983"></a><span class="lineno"> 3983</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03984" name="l03984"></a><span class="lineno"> 3984</span> </div>
<div class="line"><a id="l03985" name="l03985"></a><span class="lineno"> 3985</span>    <span class="comment">!Cray X1 unroll directive used here as work-around for compiler issue 2003/10/20</span></div>
<div class="line"><a id="l03986" name="l03986"></a><span class="lineno"> 3986</span>    <span class="comment">!dir$ unroll 0</span></div>
<div class="line"><a id="l03987" name="l03987"></a><span class="lineno"> 3987</span>    <span class="keywordflow">do</span> j = ubj-1,lbj,-1</div>
<div class="line"><a id="l03988" name="l03988"></a><span class="lineno"> 3988</span>      <span class="comment">!dir$ prefervector</span></div>
<div class="line"><a id="l03989" name="l03989"></a><span class="lineno"> 3989</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l03990" name="l03990"></a><span class="lineno"> 3990</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l03991" name="l03991"></a><span class="lineno"> 3991</span>       <span class="keywordflow">do</span> fc = 1,numf</div>
<div class="line"><a id="l03992" name="l03992"></a><span class="lineno"> 3992</span>          ci = filter(fc)</div>
<div class="line"><a id="l03993" name="l03993"></a><span class="lineno"> 3993</span>          <span class="keywordflow">if</span> (j &gt;= jtop(ci)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03994" name="l03994"></a><span class="lineno"> 3994</span>             u(ci,j) = u(ci,j) - gam(ci,j+1) * u(ci,j+1)</div>
<div class="line"><a id="l03995" name="l03995"></a><span class="lineno"> 3995</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l03996" name="l03996"></a><span class="lineno"> 3996</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l03997" name="l03997"></a><span class="lineno"> 3997</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l03998" name="l03998"></a><span class="lineno"> 3998</span> </div>
</div>
<div class="line"><a id="l03999" name="l03999"></a><span class="lineno"> 3999</span>  <span class="keyword">end subroutine </span>tridiagonal</div>
<div class="line"><a id="l04000" name="l04000"></a><span class="lineno"> 4000</span> </div>
<div class="line"><a id="l04001" name="l04001"></a><span class="lineno"> 4001</span> </div>
<div class="line"><a id="l04002" name="l04002"></a><span class="lineno"> 4002</span>    <span class="comment">! DESCRIPTION:</span><span class="comment"></span></div>
<div class="line"><a id="l04003" name="l04003"></a><span class="lineno"> 4003</span><span class="comment">    !&gt; Evaluate the change of snow mass and the snow water onto soil.</span></div>
<div class="line"><a id="l04004" name="l04004"></a><span class="lineno"> 4004</span><span class="comment">    !! Water flow within snow is computed by an explicit and non-physical</span></div>
<div class="line"><a id="l04005" name="l04005"></a><span class="lineno"> 4005</span><span class="comment">    !! based scheme, which permits a part of liquid water over the holding </span></div>
<div class="line"><a id="l04006" name="l04006"></a><span class="lineno"> 4006</span><span class="comment">    !! capacity (a tentative value is used, i.e. equal to 0.033*porosity) to</span></div>
<div class="line"><a id="l04007" name="l04007"></a><span class="lineno"> 4007</span><span class="comment">    !! percolate into the underlying layer.  Except for cases where the</span></div>
<div class="line"><a id="l04008" name="l04008"></a><span class="lineno"> 4008</span><span class="comment">    !! porosity of one of the two neighboring layers is less than 0.05, zero</span></div>
<div class="line"><a id="l04009" name="l04009"></a><span class="lineno"> 4009</span><span class="comment">    !! flow is assumed. The water flow out of the bottom of the snow pack will</span></div>
<div class="line"><a id="l04010" name="l04010"></a><span class="lineno"> 4010</span><span class="comment">    !! participate as the input of the soil water and runoff.  This subroutine</span></div>
<div class="line"><a id="l04011" name="l04011"></a><span class="lineno"> 4011</span><span class="comment">    !! uses a filter for columns containing snow which must be constructed prior</span></div>
<div class="line"><a id="l04012" name="l04012"></a><span class="lineno"> 4012</span><span class="comment">    !! to being called.</span></div>
<div class="foldopen" id="foldopen04013" data-start="" data-end="">
<div class="line"><a id="l04013" name="l04013"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a609169984304672f7d79d1548c1b1915.html#a609169984304672f7d79d1548c1b1915"> 4013</a></span>  <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah_m_p___l_s_m_ga8500bdb5fcc68e431512068da0d31cd5.html#ga8500bdb5fcc68e431512068da0d31cd5">snowwater</a>(lbc, ubc, num_snowc, filter_snowc,         &amp; !i</div>
<div class="line"><a id="l04014" name="l04014"></a><span class="lineno"> 4014</span>                   num_nosnowc, filter_nosnowc,               &amp; !i </div>
<div class="line"><a id="l04015" name="l04015"></a><span class="lineno"> 4015</span>                   snl,do_capsnow,qflx_snomelt,qflx_rain_grnd,            &amp; !i</div>
<div class="line"><a id="l04016" name="l04016"></a><span class="lineno"> 4016</span>                   qflx_sub_snow,qflx_evap_grnd,                          &amp; !i   </div>
<div class="line"><a id="l04017" name="l04017"></a><span class="lineno"> 4017</span>                   qflx_dew_snow,qflx_dew_grnd,dz,dtime,                  &amp; !i   </div>
<div class="line"><a id="l04018" name="l04018"></a><span class="lineno"> 4018</span>                   h2osoi_ice,h2osoi_liq,                                 &amp; !i&amp;o </div>
<div class="line"><a id="l04019" name="l04019"></a><span class="lineno"> 4019</span>                   qflx_top_soil)                                           <span class="comment">!o                        </span></div>
<div class="line"><a id="l04020" name="l04020"></a><span class="lineno"> 4020</span>    <span class="comment">!===============================================================================</span></div>
<div class="line"><a id="l04021" name="l04021"></a><span class="lineno"> 4021</span>    <span class="comment">! !REVISION HISTORY:</span></div>
<div class="line"><a id="l04022" name="l04022"></a><span class="lineno"> 4022</span>    <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l04023" name="l04023"></a><span class="lineno"> 4023</span>    <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l04024" name="l04024"></a><span class="lineno"> 4024</span>    <span class="comment">! 15 November 2000: Mariana Vertenstein</span></div>
<div class="line"><a id="l04025" name="l04025"></a><span class="lineno"> 4025</span>    <span class="comment">! 2/26/02, Peter Thornton: Migrated to new data structures.</span></div>
<div class="line"><a id="l04026" name="l04026"></a><span class="lineno"> 4026</span>    <span class="comment">!=============================================================================</span></div>
<div class="line"><a id="l04027" name="l04027"></a><span class="lineno"> 4027</span>    <span class="comment">! !USES:</span></div>
<div class="line"><a id="l04028" name="l04028"></a><span class="lineno"> 4028</span>    <span class="comment">!  use clmtype</span></div>
<div class="line"><a id="l04029" name="l04029"></a><span class="lineno"> 4029</span> </div>
<div class="line"><a id="l04030" name="l04030"></a><span class="lineno"> 4030</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l04031" name="l04031"></a><span class="lineno"> 4031</span> </div>
<div class="line"><a id="l04032" name="l04032"></a><span class="lineno"> 4032</span>    <span class="comment">!in:</span></div>
<div class="line"><a id="l04033" name="l04033"></a><span class="lineno"> 4033</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: lbc, ubc<span class="comment">                    !&lt; column bounds</span></div>
<div class="line"><a id="l04034" name="l04034"></a><span class="lineno"> 4034</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: num_snowc<span class="comment">                   !&lt; number of snow points in column filter</span></div>
<div class="line"><a id="l04035" name="l04035"></a><span class="lineno"> 4035</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: filter_snowc(ubc-lbc+1)<span class="comment">     !&lt; column filter for snow points</span></div>
<div class="line"><a id="l04036" name="l04036"></a><span class="lineno"> 4036</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: num_nosnowc<span class="comment">                 !&lt; number of non-snow points in column filter</span></div>
<div class="line"><a id="l04037" name="l04037"></a><span class="lineno"> 4037</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: filter_nosnowc(ubc-lbc+1)<span class="comment">   !&lt; column filter for non-snow points</span></div>
<div class="line"><a id="l04038" name="l04038"></a><span class="lineno"> 4038</span> </div>
<div class="line"><a id="l04039" name="l04039"></a><span class="lineno"> 4039</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span> :: snl(1)<span class="comment">              !&lt; number of snow layers</span></div>
<div class="line"><a id="l04040" name="l04040"></a><span class="lineno"> 4040</span>    <span class="keywordtype">logical</span> , <span class="keywordtype">intent(in)</span> :: do_capsnow(1)<span class="comment">       !&lt; true =&gt; do snow capping</span></div>
<div class="line"><a id="l04041" name="l04041"></a><span class="lineno"> 4041</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: dtime<span class="comment">               !&lt; timestep</span></div>
<div class="line"><a id="l04042" name="l04042"></a><span class="lineno"> 4042</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: qflx_snomelt(1)<span class="comment">     !&lt; snow melt (mm H2O /s)</span></div>
<div class="line"><a id="l04043" name="l04043"></a><span class="lineno"> 4043</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: qflx_rain_grnd(1)<span class="comment">   !&lt; rain on ground after interception (mm H2O/s) [+]</span></div>
<div class="line"><a id="l04044" name="l04044"></a><span class="lineno"> 4044</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: qflx_sub_snow(1)<span class="comment">    !&lt; sublimation rate from snow pack (mm H2O /s) [+]</span></div>
<div class="line"><a id="l04045" name="l04045"></a><span class="lineno"> 4045</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: qflx_evap_grnd(1)<span class="comment">   !&lt; ground surface evaporation rate (mm H2O/s) [+]</span></div>
<div class="line"><a id="l04046" name="l04046"></a><span class="lineno"> 4046</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: qflx_dew_snow(1)<span class="comment">    !&lt; surface dew added to snow pack (mm H2O /s) [+]</span></div>
<div class="line"><a id="l04047" name="l04047"></a><span class="lineno"> 4047</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: qflx_dew_grnd(1)<span class="comment">    !&lt; ground surface dew formation (mm H2O /s) [+]</span></div>
<div class="line"><a id="l04048" name="l04048"></a><span class="lineno"> 4048</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: dz(1,-nlevsnow+1:nlevsoil)<span class="comment">             !&lt; layer depth (m)</span></div>
<div class="line"><a id="l04049" name="l04049"></a><span class="lineno"> 4049</span> </div>
<div class="line"><a id="l04050" name="l04050"></a><span class="lineno"> 4050</span> </div>
<div class="line"><a id="l04051" name="l04051"></a><span class="lineno"> 4051</span>    <span class="comment">!inout: </span></div>
<div class="line"><a id="l04052" name="l04052"></a><span class="lineno"> 4052</span> </div>
<div class="line"><a id="l04053" name="l04053"></a><span class="lineno"> 4053</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osoi_ice(1,-nlevsnow+1:nlevsoil)<span class="comment">     !&lt; ice lens (kg/m2)</span></div>
<div class="line"><a id="l04054" name="l04054"></a><span class="lineno"> 4054</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osoi_liq(1,-nlevsnow+1:nlevsoil)<span class="comment">     !&lt; liquid water (kg/m2)</span></div>
<div class="line"><a id="l04055" name="l04055"></a><span class="lineno"> 4055</span>    </div>
<div class="line"><a id="l04056" name="l04056"></a><span class="lineno"> 4056</span>    <span class="comment">!out:</span></div>
<div class="line"><a id="l04057" name="l04057"></a><span class="lineno"> 4057</span>    </div>
<div class="line"><a id="l04058" name="l04058"></a><span class="lineno"> 4058</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: qflx_top_soil(1)<span class="comment">     !&lt; net water input into soil from top (mm/s)</span></div>
<div class="line"><a id="l04059" name="l04059"></a><span class="lineno"> 4059</span> </div>
<div class="line"><a id="l04060" name="l04060"></a><span class="lineno"> 4060</span> </div>
<div class="line"><a id="l04061" name="l04061"></a><span class="lineno"> 4061</span>    <span class="comment">! OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l04062" name="l04062"></a><span class="lineno"> 4062</span> </div>
<div class="line"><a id="l04063" name="l04063"></a><span class="lineno"> 4063</span>    <span class="keywordtype">integer</span>  :: c, j, fc                           <span class="comment">!do loop/array indices</span></div>
<div class="line"><a id="l04064" name="l04064"></a><span class="lineno"> 4064</span><span class="keywordtype">    real</span>(kind_lake) :: qin(lbc:ubc)                       <span class="comment">!water flow into the elmement (mm/s)</span></div>
<div class="line"><a id="l04065" name="l04065"></a><span class="lineno"> 4065</span><span class="keywordtype">    real</span>(kind_lake) :: qout(lbc:ubc)                      <span class="comment">!water flow out of the elmement (mm/s)</span></div>
<div class="line"><a id="l04066" name="l04066"></a><span class="lineno"> 4066</span><span class="keywordtype">    real</span>(kind_lake) :: wgdif                              <span class="comment">!ice mass after minus sublimation</span></div>
<div class="line"><a id="l04067" name="l04067"></a><span class="lineno"> 4067</span><span class="keywordtype">    real</span>(kind_lake) :: vol_liq(lbc:ubc,-nlevsnow+1:0)      <span class="comment">!partial volume of liquid water in layer</span></div>
<div class="line"><a id="l04068" name="l04068"></a><span class="lineno"> 4068</span><span class="keywordtype">    real</span>(kind_lake) :: vol_ice(lbc:ubc,-nlevsnow+1:0)      <span class="comment">!partial volume of ice lens in layer</span></div>
<div class="line"><a id="l04069" name="l04069"></a><span class="lineno"> 4069</span><span class="keywordtype">    real</span>(kind_lake) :: eff_porosity(lbc:ubc,-nlevsnow+1:0) <span class="comment">!effective porosity = porosity - vol_ice</span></div>
<div class="line"><a id="l04070" name="l04070"></a><span class="lineno"> 4070</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04071" name="l04071"></a><span class="lineno"> 4071</span>    <span class="comment">! Renew the mass of ice lens (h2osoi_ice) and liquid (h2osoi_liq) in the</span></div>
<div class="line"><a id="l04072" name="l04072"></a><span class="lineno"> 4072</span>    <span class="comment">! surface snow layer resulting from sublimation (frost) / evaporation (condense)</span></div>
<div class="line"><a id="l04073" name="l04073"></a><span class="lineno"> 4073</span> </div>
<div class="line"><a id="l04074" name="l04074"></a><span class="lineno"> 4074</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04075" name="l04075"></a><span class="lineno"> 4075</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04076" name="l04076"></a><span class="lineno"> 4076</span>    <span class="keywordflow">do</span> fc = 1,num_snowc</div>
<div class="line"><a id="l04077" name="l04077"></a><span class="lineno"> 4077</span>       c = filter_snowc(fc)</div>
<div class="line"><a id="l04078" name="l04078"></a><span class="lineno"> 4078</span>       <span class="keywordflow">if</span> (do_capsnow(c)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04079" name="l04079"></a><span class="lineno"> 4079</span>          wgdif = h2osoi_ice(c,snl(c)+1) - qflx_sub_snow(c)*dtime</div>
<div class="line"><a id="l04080" name="l04080"></a><span class="lineno"> 4080</span>          h2osoi_ice(c,snl(c)+1) = wgdif</div>
<div class="line"><a id="l04081" name="l04081"></a><span class="lineno"> 4081</span>          <span class="keywordflow">if</span> (wgdif &lt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04082" name="l04082"></a><span class="lineno"> 4082</span>             h2osoi_ice(c,snl(c)+1) = 0.</div>
<div class="line"><a id="l04083" name="l04083"></a><span class="lineno"> 4083</span>             h2osoi_liq(c,snl(c)+1) = h2osoi_liq(c,snl(c)+1) + wgdif</div>
<div class="line"><a id="l04084" name="l04084"></a><span class="lineno"> 4084</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04085" name="l04085"></a><span class="lineno"> 4085</span>          h2osoi_liq(c,snl(c)+1) = h2osoi_liq(c,snl(c)+1) - qflx_evap_grnd(c) * dtime</div>
<div class="line"><a id="l04086" name="l04086"></a><span class="lineno"> 4086</span>       <span class="keywordflow">else</span></div>
<div class="line"><a id="l04087" name="l04087"></a><span class="lineno"> 4087</span>          wgdif = h2osoi_ice(c,snl(c)+1) + (qflx_dew_snow(c) - qflx_sub_snow(c)) * dtime</div>
<div class="line"><a id="l04088" name="l04088"></a><span class="lineno"> 4088</span>          h2osoi_ice(c,snl(c)+1) = wgdif</div>
<div class="line"><a id="l04089" name="l04089"></a><span class="lineno"> 4089</span>          <span class="keywordflow">if</span> (wgdif &lt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04090" name="l04090"></a><span class="lineno"> 4090</span>             h2osoi_ice(c,snl(c)+1) = 0.</div>
<div class="line"><a id="l04091" name="l04091"></a><span class="lineno"> 4091</span>             h2osoi_liq(c,snl(c)+1) = h2osoi_liq(c,snl(c)+1) + wgdif</div>
<div class="line"><a id="l04092" name="l04092"></a><span class="lineno"> 4092</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04093" name="l04093"></a><span class="lineno"> 4093</span>          h2osoi_liq(c,snl(c)+1) = h2osoi_liq(c,snl(c)+1) +  &amp;</div>
<div class="line"><a id="l04094" name="l04094"></a><span class="lineno"> 4094</span>               (qflx_rain_grnd(c) + qflx_dew_grnd(c) - qflx_evap_grnd(c)) * dtime</div>
<div class="line"><a id="l04095" name="l04095"></a><span class="lineno"> 4095</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l04096" name="l04096"></a><span class="lineno"> 4096</span>       h2osoi_liq(c,snl(c)+1) = max(0._kind_lake, h2osoi_liq(c,snl(c)+1))</div>
<div class="line"><a id="l04097" name="l04097"></a><span class="lineno"> 4097</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04098" name="l04098"></a><span class="lineno"> 4098</span> </div>
<div class="line"><a id="l04099" name="l04099"></a><span class="lineno"> 4099</span>    <span class="comment">! Porosity and partial volume</span></div>
<div class="line"><a id="l04100" name="l04100"></a><span class="lineno"> 4100</span> </div>
<div class="line"><a id="l04101" name="l04101"></a><span class="lineno"> 4101</span>    <span class="keywordflow">do</span> j = -nlevsnow+1, 0</div>
<div class="line"><a id="l04102" name="l04102"></a><span class="lineno"> 4102</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04103" name="l04103"></a><span class="lineno"> 4103</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04104" name="l04104"></a><span class="lineno"> 4104</span>       <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04105" name="l04105"></a><span class="lineno"> 4105</span>          c = filter_snowc(fc)</div>
<div class="line"><a id="l04106" name="l04106"></a><span class="lineno"> 4106</span>          <span class="keywordflow">if</span> (j &gt;= snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04107" name="l04107"></a><span class="lineno"> 4107</span>             vol_ice(c,j) = min(1._kind_lake, h2osoi_ice(c,j)/(dz(c,j)*denice))</div>
<div class="line"><a id="l04108" name="l04108"></a><span class="lineno"> 4108</span>             eff_porosity(c,j) = 1. - vol_ice(c,j)</div>
<div class="line"><a id="l04109" name="l04109"></a><span class="lineno"> 4109</span>             vol_liq(c,j) = min(eff_porosity(c,j),h2osoi_liq(c,j)/(dz(c,j)*denh2o))</div>
<div class="line"><a id="l04110" name="l04110"></a><span class="lineno"> 4110</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04111" name="l04111"></a><span class="lineno"> 4111</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l04112" name="l04112"></a><span class="lineno"> 4112</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04113" name="l04113"></a><span class="lineno"> 4113</span> </div>
<div class="line"><a id="l04114" name="l04114"></a><span class="lineno"> 4114</span>    <span class="comment">! Capillary forces within snow are usually two or more orders of magnitude</span></div>
<div class="line"><a id="l04115" name="l04115"></a><span class="lineno"> 4115</span>    <span class="comment">! less than those of gravity. Only gravity terms are considered.</span></div>
<div class="line"><a id="l04116" name="l04116"></a><span class="lineno"> 4116</span>    <span class="comment">! the genernal expression for water flow is &quot;K * ss**3&quot;, however,</span></div>
<div class="line"><a id="l04117" name="l04117"></a><span class="lineno"> 4117</span>    <span class="comment">! no effective parameterization for &quot;K&quot;.  Thus, a very simple consideration</span></div>
<div class="line"><a id="l04118" name="l04118"></a><span class="lineno"> 4118</span>    <span class="comment">! (not physically based) is introduced:</span></div>
<div class="line"><a id="l04119" name="l04119"></a><span class="lineno"> 4119</span>    <span class="comment">! when the liquid water of layer exceeds the layer&#39;s holding</span></div>
<div class="line"><a id="l04120" name="l04120"></a><span class="lineno"> 4120</span>    <span class="comment">! capacity, the excess meltwater adds to the underlying neighbor layer.</span></div>
<div class="line"><a id="l04121" name="l04121"></a><span class="lineno"> 4121</span> </div>
<div class="line"><a id="l04122" name="l04122"></a><span class="lineno"> 4122</span>    qin(:) = 0._kind_lake</div>
<div class="line"><a id="l04123" name="l04123"></a><span class="lineno"> 4123</span> </div>
<div class="line"><a id="l04124" name="l04124"></a><span class="lineno"> 4124</span>    <span class="keywordflow">do</span> j = -nlevsnow+1, 0</div>
<div class="line"><a id="l04125" name="l04125"></a><span class="lineno"> 4125</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04126" name="l04126"></a><span class="lineno"> 4126</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04127" name="l04127"></a><span class="lineno"> 4127</span>       <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04128" name="l04128"></a><span class="lineno"> 4128</span>          c = filter_snowc(fc)</div>
<div class="line"><a id="l04129" name="l04129"></a><span class="lineno"> 4129</span>          <span class="keywordflow">if</span> (j &gt;= snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04130" name="l04130"></a><span class="lineno"> 4130</span>             h2osoi_liq(c,j) = h2osoi_liq(c,j) + qin(c)</div>
<div class="line"><a id="l04131" name="l04131"></a><span class="lineno"> 4131</span>             <span class="keywordflow">if</span> (j &lt;= -1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04132" name="l04132"></a><span class="lineno"> 4132</span>                <span class="comment">! No runoff over snow surface, just ponding on surface</span></div>
<div class="line"><a id="l04133" name="l04133"></a><span class="lineno"> 4133</span>                <span class="keywordflow">if</span> (eff_porosity(c,j) &lt; wimp .OR. eff_porosity(c,j+1) &lt; wimp) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04134" name="l04134"></a><span class="lineno"> 4134</span>                   qout(c) = 0._kind_lake</div>
<div class="line"><a id="l04135" name="l04135"></a><span class="lineno"> 4135</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l04136" name="l04136"></a><span class="lineno"> 4136</span>                   qout(c) = max(0._kind_lake,(vol_liq(c,j)-ssi*eff_porosity(c,j))*dz(c,j))</div>
<div class="line"><a id="l04137" name="l04137"></a><span class="lineno"> 4137</span>                   qout(c) = min(qout(c),(1.-vol_ice(c,j+1)-vol_liq(c,j+1))*dz(c,j+1))</div>
<div class="line"><a id="l04138" name="l04138"></a><span class="lineno"> 4138</span><span class="keywordflow">                end if</span></div>
<div class="line"><a id="l04139" name="l04139"></a><span class="lineno"> 4139</span>             <span class="keywordflow">else</span></div>
<div class="line"><a id="l04140" name="l04140"></a><span class="lineno"> 4140</span>                qout(c) = max(0._kind_lake,(vol_liq(c,j) - ssi*eff_porosity(c,j))*dz(c,j))</div>
<div class="line"><a id="l04141" name="l04141"></a><span class="lineno"> 4141</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l04142" name="l04142"></a><span class="lineno"> 4142</span>             qout(c) = qout(c)*1000.</div>
<div class="line"><a id="l04143" name="l04143"></a><span class="lineno"> 4143</span>             h2osoi_liq(c,j) = h2osoi_liq(c,j) - qout(c)</div>
<div class="line"><a id="l04144" name="l04144"></a><span class="lineno"> 4144</span>             qin(c) = qout(c)</div>
<div class="line"><a id="l04145" name="l04145"></a><span class="lineno"> 4145</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04146" name="l04146"></a><span class="lineno"> 4146</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l04147" name="l04147"></a><span class="lineno"> 4147</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04148" name="l04148"></a><span class="lineno"> 4148</span> </div>
<div class="line"><a id="l04149" name="l04149"></a><span class="lineno"> 4149</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04150" name="l04150"></a><span class="lineno"> 4150</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04151" name="l04151"></a><span class="lineno"> 4151</span>    <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04152" name="l04152"></a><span class="lineno"> 4152</span>       c = filter_snowc(fc)</div>
<div class="line"><a id="l04153" name="l04153"></a><span class="lineno"> 4153</span>       <span class="comment">! Qout from snow bottom</span></div>
<div class="line"><a id="l04154" name="l04154"></a><span class="lineno"> 4154</span>       qflx_top_soil(c) = qout(c) / dtime</div>
<div class="line"><a id="l04155" name="l04155"></a><span class="lineno"> 4155</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04156" name="l04156"></a><span class="lineno"> 4156</span> </div>
<div class="line"><a id="l04157" name="l04157"></a><span class="lineno"> 4157</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04158" name="l04158"></a><span class="lineno"> 4158</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04159" name="l04159"></a><span class="lineno"> 4159</span>    <span class="keywordflow">do</span> fc = 1, num_nosnowc</div>
<div class="line"><a id="l04160" name="l04160"></a><span class="lineno"> 4160</span>       c = filter_nosnowc(fc)</div>
<div class="line"><a id="l04161" name="l04161"></a><span class="lineno"> 4161</span>       qflx_top_soil(c) = qflx_rain_grnd(c) + qflx_snomelt(c)</div>
<div class="line"><a id="l04162" name="l04162"></a><span class="lineno"> 4162</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04163" name="l04163"></a><span class="lineno"> 4163</span> </div>
</div>
<div class="line"><a id="l04164" name="l04164"></a><span class="lineno"> 4164</span>  <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah_m_p___l_s_m_ga8500bdb5fcc68e431512068da0d31cd5.html#ga8500bdb5fcc68e431512068da0d31cd5">snowwater</a></div>
<div class="line"><a id="l04165" name="l04165"></a><span class="lineno"> 4165</span><span class="comment"></span> </div>
<div class="line"><a id="l04166" name="l04166"></a><span class="lineno"> 4166</span><span class="comment">!&gt; Determine the change in snow layer thickness due to compaction and</span></div>
<div class="line"><a id="l04167" name="l04167"></a><span class="lineno"> 4167</span><span class="comment">!! settling.</span></div>
<div class="line"><a id="l04168" name="l04168"></a><span class="lineno"> 4168</span><span class="comment">!! Three metamorphisms of changing snow characteristics are implemented,</span></div>
<div class="line"><a id="l04169" name="l04169"></a><span class="lineno"> 4169</span><span class="comment">!! i.e., destructive, overburden, and melt. The treatments of the former</span></div>
<div class="line"><a id="l04170" name="l04170"></a><span class="lineno"> 4170</span><span class="comment">!! two are from SNTHERM.89 and SNTHERM.99 (1991, 1999). The contribution</span></div>
<div class="line"><a id="l04171" name="l04171"></a><span class="lineno"> 4171</span><span class="comment">!! due to melt metamorphism is simply taken as a ratio of snow ice</span></div>
<div class="line"><a id="l04172" name="l04172"></a><span class="lineno"> 4172</span><span class="comment">!! fraction after the melting versus before the melting.</span></div>
<div class="foldopen" id="foldopen04173" data-start="" data-end="">
<div class="line"><a id="l04173" name="l04173"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a7e4351e30556eab9c9b6b1cdd4e4b0a1.html#a7e4351e30556eab9c9b6b1cdd4e4b0a1"> 4173</a></span>  <span class="keyword">subroutine </span>snowcompaction(lbc, ubc, num_snowc, filter_snowc,   &amp;!i  </div>
<div class="line"><a id="l04174" name="l04174"></a><span class="lineno"> 4174</span>                           snl,imelt,frac_iceold,t_soisno,                  &amp;!i  </div>
<div class="line"><a id="l04175" name="l04175"></a><span class="lineno"> 4175</span>                           h2osoi_ice,h2osoi_liq,dtime,                     &amp;!i  </div>
<div class="line"><a id="l04176" name="l04176"></a><span class="lineno"> 4176</span>                           dz)                                               <span class="comment">!i&amp;o   </span></div>
<div class="line"><a id="l04177" name="l04177"></a><span class="lineno"> 4177</span> </div>
<div class="line"><a id="l04178" name="l04178"></a><span class="lineno"> 4178</span>    </div>
<div class="line"><a id="l04179" name="l04179"></a><span class="lineno"> 4179</span>    <span class="comment">!================================================================================</span></div>
<div class="line"><a id="l04180" name="l04180"></a><span class="lineno"> 4180</span>    <span class="comment">! CALLED FROM:</span></div>
<div class="line"><a id="l04181" name="l04181"></a><span class="lineno"> 4181</span>    <span class="comment">! subroutine Hydrology2 in module Hydrology2Mod</span></div>
<div class="line"><a id="l04182" name="l04182"></a><span class="lineno"> 4182</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04183" name="l04183"></a><span class="lineno"> 4183</span>    <span class="comment">! REVISION HISTORY:</span></div>
<div class="line"><a id="l04184" name="l04184"></a><span class="lineno"> 4184</span>    <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l04185" name="l04185"></a><span class="lineno"> 4185</span>    <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l04186" name="l04186"></a><span class="lineno"> 4186</span>    <span class="comment">! 2/28/02, Peter Thornton: Migrated to new data structures</span></div>
<div class="line"><a id="l04187" name="l04187"></a><span class="lineno"> 4187</span>    <span class="comment">!==============================================================================</span></div>
<div class="line"><a id="l04188" name="l04188"></a><span class="lineno"> 4188</span>    <span class="comment">! USES:</span></div>
<div class="line"><a id="l04189" name="l04189"></a><span class="lineno"> 4189</span>    <span class="comment">!  use clmtype</span></div>
<div class="line"><a id="l04190" name="l04190"></a><span class="lineno"> 4190</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04191" name="l04191"></a><span class="lineno"> 4191</span>    <span class="comment">! !ARGUMENTS:</span></div>
<div class="line"><a id="l04192" name="l04192"></a><span class="lineno"> 4192</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l04193" name="l04193"></a><span class="lineno"> 4193</span> </div>
<div class="line"><a id="l04194" name="l04194"></a><span class="lineno"> 4194</span>    <span class="comment">!in:</span></div>
<div class="line"><a id="l04195" name="l04195"></a><span class="lineno"> 4195</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: lbc, ubc<span class="comment">                !&lt; column bounds</span></div>
<div class="line"><a id="l04196" name="l04196"></a><span class="lineno"> 4196</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: num_snowc<span class="comment">               !&lt; number of column snow points in column filter</span></div>
<div class="line"><a id="l04197" name="l04197"></a><span class="lineno"> 4197</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: filter_snowc(ubc-lbc+1)<span class="comment"> !&lt; column filter for snow points</span></div>
<div class="line"><a id="l04198" name="l04198"></a><span class="lineno"> 4198</span>    <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in)</span> :: snl(1)<span class="comment">             !&lt; number of snow layers</span></div>
<div class="line"><a id="l04199" name="l04199"></a><span class="lineno"> 4199</span>    <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in)</span> :: imelt(1,-nlevsnow+1:nlevsoil)<span class="comment">        !&lt; flag for melting (=1), freezing (=2), Not=0</span></div>
<div class="line"><a id="l04200" name="l04200"></a><span class="lineno"> 4200</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: dtime<span class="comment">                         !&lt;</span></div>
<div class="line"><a id="l04201" name="l04201"></a><span class="lineno"> 4201</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: frac_iceold(1,-nlevsnow+1:nlevsoil)<span class="comment">  !&lt; fraction of ice relative to the tot water</span></div>
<div class="line"><a id="l04202" name="l04202"></a><span class="lineno"> 4202</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: t_soisno(1,-nlevsnow+1:nlevsoil)<span class="comment">     !&lt; soil temperature (Kelvin)</span></div>
<div class="line"><a id="l04203" name="l04203"></a><span class="lineno"> 4203</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: h2osoi_ice(1,-nlevsnow+1:nlevsoil)<span class="comment">   !&lt; ice lens (kg/m2)</span></div>
<div class="line"><a id="l04204" name="l04204"></a><span class="lineno"> 4204</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: h2osoi_liq(1,-nlevsnow+1:nlevsoil)<span class="comment">   !&lt; liquid water (kg/m2)</span></div>
<div class="line"><a id="l04205" name="l04205"></a><span class="lineno"> 4205</span> </div>
<div class="line"><a id="l04206" name="l04206"></a><span class="lineno"> 4206</span>    <span class="comment">!inout:</span></div>
<div class="line"><a id="l04207" name="l04207"></a><span class="lineno"> 4207</span> </div>
<div class="line"><a id="l04208" name="l04208"></a><span class="lineno"> 4208</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: dz(1,-nlevsnow+1:nlevsoil)<span class="comment">           !&lt; layer depth (m)</span></div>
<div class="line"><a id="l04209" name="l04209"></a><span class="lineno"> 4209</span> </div>
<div class="line"><a id="l04210" name="l04210"></a><span class="lineno"> 4210</span>    <span class="comment">! OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l04211" name="l04211"></a><span class="lineno"> 4211</span> </div>
<div class="line"><a id="l04212" name="l04212"></a><span class="lineno"> 4212</span>    <span class="keywordtype">integer</span> :: j, c, fc                   <span class="comment">! indices</span></div>
<div class="line"><a id="l04213" name="l04213"></a><span class="lineno"> 4213</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c2 = 23.e-3    <span class="comment">! [m3/kg]</span></div>
<div class="line"><a id="l04214" name="l04214"></a><span class="lineno"> 4214</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c3 = 2.777e-6  <span class="comment">! [1/s]</span></div>
<div class="line"><a id="l04215" name="l04215"></a><span class="lineno"> 4215</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c4 = 0.04      <span class="comment">! [1/K]</span></div>
<div class="line"><a id="l04216" name="l04216"></a><span class="lineno"> 4216</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: c5 = 2.0       <span class="comment">!</span></div>
<div class="line"><a id="l04217" name="l04217"></a><span class="lineno"> 4217</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: dm = 100.0     <span class="comment">! Upper Limit on Destructive Metamorphism Compaction [kg/m3]</span></div>
<div class="line"><a id="l04218" name="l04218"></a><span class="lineno"> 4218</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: eta0 = 9.e+5   <span class="comment">! The Viscosity Coefficient Eta0 [kg-s/m2]</span></div>
<div class="line"><a id="l04219" name="l04219"></a><span class="lineno"> 4219</span><span class="keywordtype">    real</span>(kind_lake) :: burden(lbc:ubc) <span class="comment">! pressure of overlying snow [kg/m2]</span></div>
<div class="line"><a id="l04220" name="l04220"></a><span class="lineno"> 4220</span><span class="keywordtype">    real</span>(kind_lake) :: ddz1   <span class="comment">! Rate of settling of snowpack due to destructive metamorphism.</span></div>
<div class="line"><a id="l04221" name="l04221"></a><span class="lineno"> 4221</span><span class="keywordtype">    real</span>(kind_lake) :: ddz2   <span class="comment">! Rate of compaction of snowpack due to overburden.</span></div>
<div class="line"><a id="l04222" name="l04222"></a><span class="lineno"> 4222</span><span class="keywordtype">    real</span>(kind_lake) :: ddz3   <span class="comment">! Rate of compaction of snowpack due to melt [1/s]</span></div>
<div class="line"><a id="l04223" name="l04223"></a><span class="lineno"> 4223</span><span class="keywordtype">    real</span>(kind_lake) :: dexpf  <span class="comment">! expf=exp(-c4*(273.15-t_soisno)).</span></div>
<div class="line"><a id="l04224" name="l04224"></a><span class="lineno"> 4224</span><span class="keywordtype">    real</span>(kind_lake) :: fi     <span class="comment">! Fraction of ice relative to the total water content at current time step</span></div>
<div class="line"><a id="l04225" name="l04225"></a><span class="lineno"> 4225</span><span class="keywordtype">    real</span>(kind_lake) :: td     <span class="comment">! t_soisno - tfrz [K]</span></div>
<div class="line"><a id="l04226" name="l04226"></a><span class="lineno"> 4226</span><span class="keywordtype">    real</span>(kind_lake) :: pdzdtc <span class="comment">! Nodal rate of change in fractional-thickness due to compaction [fraction/s]</span></div>
<div class="line"><a id="l04227" name="l04227"></a><span class="lineno"> 4227</span><span class="keywordtype">    real</span>(kind_lake) :: void   <span class="comment">! void (1 - vol_ice - vol_liq)</span></div>
<div class="line"><a id="l04228" name="l04228"></a><span class="lineno"> 4228</span><span class="keywordtype">    real</span>(kind_lake) :: wx     <span class="comment">! water mass (ice+liquid) [kg/m2]</span></div>
<div class="line"><a id="l04229" name="l04229"></a><span class="lineno"> 4229</span><span class="keywordtype">    real</span>(kind_lake) :: bi     <span class="comment">! partial density of ice [kg/m3]</span></div>
<div class="line"><a id="l04230" name="l04230"></a><span class="lineno"> 4230</span> </div>
<div class="line"><a id="l04231" name="l04231"></a><span class="lineno"> 4231</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04232" name="l04232"></a><span class="lineno"> 4232</span> </div>
<div class="line"><a id="l04233" name="l04233"></a><span class="lineno"> 4233</span> </div>
<div class="line"><a id="l04234" name="l04234"></a><span class="lineno"> 4234</span>    <span class="comment">! Begin calculation - note that the following column loops are only invoked if snl(c) &lt; 0</span></div>
<div class="line"><a id="l04235" name="l04235"></a><span class="lineno"> 4235</span> </div>
<div class="line"><a id="l04236" name="l04236"></a><span class="lineno"> 4236</span>    burden(:) = 0._kind_lake</div>
<div class="line"><a id="l04237" name="l04237"></a><span class="lineno"> 4237</span> </div>
<div class="line"><a id="l04238" name="l04238"></a><span class="lineno"> 4238</span>    <span class="keywordflow">do</span> j = -nlevsnow+1, 0</div>
<div class="line"><a id="l04239" name="l04239"></a><span class="lineno"> 4239</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04240" name="l04240"></a><span class="lineno"> 4240</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04241" name="l04241"></a><span class="lineno"> 4241</span>       <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04242" name="l04242"></a><span class="lineno"> 4242</span>          c = filter_snowc(fc)</div>
<div class="line"><a id="l04243" name="l04243"></a><span class="lineno"> 4243</span>          <span class="keywordflow">if</span> (j &gt;= snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04244" name="l04244"></a><span class="lineno"> 4244</span> </div>
<div class="line"><a id="l04245" name="l04245"></a><span class="lineno"> 4245</span>             wx = h2osoi_ice(c,j) + h2osoi_liq(c,j)</div>
<div class="line"><a id="l04246" name="l04246"></a><span class="lineno"> 4246</span>             void = 1. - (h2osoi_ice(c,j)/denice + h2osoi_liq(c,j)/denh2o) / dz(c,j)</div>
<div class="line"><a id="l04247" name="l04247"></a><span class="lineno"> 4247</span> </div>
<div class="line"><a id="l04248" name="l04248"></a><span class="lineno"> 4248</span>             <span class="comment">! Allow compaction only for non-saturated node and higher ice lens node.</span></div>
<div class="line"><a id="l04249" name="l04249"></a><span class="lineno"> 4249</span>             <span class="keywordflow">if</span> (void &gt; 0.001 .and. h2osoi_ice(c,j) &gt; .1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04250" name="l04250"></a><span class="lineno"> 4250</span>                bi = h2osoi_ice(c,j) / dz(c,j)</div>
<div class="line"><a id="l04251" name="l04251"></a><span class="lineno"> 4251</span>                fi = h2osoi_ice(c,j) / wx</div>
<div class="line"><a id="l04252" name="l04252"></a><span class="lineno"> 4252</span>                td = tfrz-t_soisno(c,j)</div>
<div class="line"><a id="l04253" name="l04253"></a><span class="lineno"> 4253</span>                dexpf = exp(-c4*td)</div>
<div class="line"><a id="l04254" name="l04254"></a><span class="lineno"> 4254</span> </div>
<div class="line"><a id="l04255" name="l04255"></a><span class="lineno"> 4255</span>                <span class="comment">! Settling as a result of destructive metamorphism</span></div>
<div class="line"><a id="l04256" name="l04256"></a><span class="lineno"> 4256</span> </div>
<div class="line"><a id="l04257" name="l04257"></a><span class="lineno"> 4257</span>                ddz1 = -c3*dexpf</div>
<div class="line"><a id="l04258" name="l04258"></a><span class="lineno"> 4258</span>                <span class="keywordflow">if</span> (bi &gt; dm) ddz1 = ddz1*exp(-46.0e-3*(bi-dm))</div>
<div class="line"><a id="l04259" name="l04259"></a><span class="lineno"> 4259</span> </div>
<div class="line"><a id="l04260" name="l04260"></a><span class="lineno"> 4260</span>                <span class="comment">! Liquid water term</span></div>
<div class="line"><a id="l04261" name="l04261"></a><span class="lineno"> 4261</span> </div>
<div class="line"><a id="l04262" name="l04262"></a><span class="lineno"> 4262</span>                <span class="keywordflow">if</span> (h2osoi_liq(c,j) &gt; 0.01*dz(c,j)) ddz1=ddz1*c5</div>
<div class="line"><a id="l04263" name="l04263"></a><span class="lineno"> 4263</span> </div>
<div class="line"><a id="l04264" name="l04264"></a><span class="lineno"> 4264</span>                <span class="comment">! Compaction due to overburden</span></div>
<div class="line"><a id="l04265" name="l04265"></a><span class="lineno"> 4265</span> </div>
<div class="line"><a id="l04266" name="l04266"></a><span class="lineno"> 4266</span>                ddz2 = -burden(c)*exp(-0.08*td - c2*bi)/eta0</div>
<div class="line"><a id="l04267" name="l04267"></a><span class="lineno"> 4267</span> </div>
<div class="line"><a id="l04268" name="l04268"></a><span class="lineno"> 4268</span>                <span class="comment">! Compaction occurring during melt</span></div>
<div class="line"><a id="l04269" name="l04269"></a><span class="lineno"> 4269</span> </div>
<div class="line"><a id="l04270" name="l04270"></a><span class="lineno"> 4270</span>                <span class="keywordflow">if</span> (imelt(c,j) == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04271" name="l04271"></a><span class="lineno"> 4271</span>                   ddz3 = - 1./dtime * max(0._kind_lake,(frac_iceold(c,j) - fi)/frac_iceold(c,j))</div>
<div class="line"><a id="l04272" name="l04272"></a><span class="lineno"> 4272</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l04273" name="l04273"></a><span class="lineno"> 4273</span>                   ddz3 = 0._kind_lake</div>
<div class="line"><a id="l04274" name="l04274"></a><span class="lineno"> 4274</span><span class="keywordflow">                end if</span></div>
<div class="line"><a id="l04275" name="l04275"></a><span class="lineno"> 4275</span> </div>
<div class="line"><a id="l04276" name="l04276"></a><span class="lineno"> 4276</span>                <span class="comment">! Time rate of fractional change in dz (units of s-1)</span></div>
<div class="line"><a id="l04277" name="l04277"></a><span class="lineno"> 4277</span> </div>
<div class="line"><a id="l04278" name="l04278"></a><span class="lineno"> 4278</span>                pdzdtc = ddz1 + ddz2 + ddz3</div>
<div class="line"><a id="l04279" name="l04279"></a><span class="lineno"> 4279</span> </div>
<div class="line"><a id="l04280" name="l04280"></a><span class="lineno"> 4280</span>                <span class="comment">! The change in dz due to compaction</span></div>
<div class="line"><a id="l04281" name="l04281"></a><span class="lineno"> 4281</span> </div>
<div class="line"><a id="l04282" name="l04282"></a><span class="lineno"> 4282</span>                dz(c,j) = dz(c,j) * (1.+pdzdtc*dtime)</div>
<div class="line"><a id="l04283" name="l04283"></a><span class="lineno"> 4283</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l04284" name="l04284"></a><span class="lineno"> 4284</span> </div>
<div class="line"><a id="l04285" name="l04285"></a><span class="lineno"> 4285</span>             <span class="comment">! Pressure of overlying snow</span></div>
<div class="line"><a id="l04286" name="l04286"></a><span class="lineno"> 4286</span> </div>
<div class="line"><a id="l04287" name="l04287"></a><span class="lineno"> 4287</span>             burden(c) = burden(c) + wx</div>
<div class="line"><a id="l04288" name="l04288"></a><span class="lineno"> 4288</span> </div>
<div class="line"><a id="l04289" name="l04289"></a><span class="lineno"> 4289</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04290" name="l04290"></a><span class="lineno"> 4290</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l04291" name="l04291"></a><span class="lineno"> 4291</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04292" name="l04292"></a><span class="lineno"> 4292</span> </div>
</div>
<div class="line"><a id="l04293" name="l04293"></a><span class="lineno"> 4293</span>  <span class="keyword">end subroutine </span>snowcompaction</div>
<div class="line"><a id="l04294" name="l04294"></a><span class="lineno"> 4294</span><span class="comment"></span> </div>
<div class="line"><a id="l04295" name="l04295"></a><span class="lineno"> 4295</span><span class="comment">!&gt; Combine snow layers that are less than a minimum thickness or mass</span></div>
<div class="line"><a id="l04296" name="l04296"></a><span class="lineno"> 4296</span><span class="comment">!! If the snow element thickness or mass is less than a prescribed minimum,</span></div>
<div class="line"><a id="l04297" name="l04297"></a><span class="lineno"> 4297</span><span class="comment">!! then it is combined with a neighboring element.        </span></div>
<div class="foldopen" id="foldopen04298" data-start="" data-end="">
<div class="line"><a id="l04298" name="l04298"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ac447acc162cd004682d862ea627caf4d.html#ac447acc162cd004682d862ea627caf4d"> 4298</a></span>  <span class="keyword">subroutine </span>combinesnowlayers(lbc, ubc,                            &amp; !i</div>
<div class="line"><a id="l04299" name="l04299"></a><span class="lineno"> 4299</span>                              num_snowc, filter_snowc, &amp; !i&amp;o</div>
<div class="line"><a id="l04300" name="l04300"></a><span class="lineno"> 4300</span>                              snl,h2osno,snowdp,dz,zi,             &amp; !i&amp;o</div>
<div class="line"><a id="l04301" name="l04301"></a><span class="lineno"> 4301</span>                              t_soisno,h2osoi_ice,h2osoi_liq,      &amp; !i&amp;o</div>
<div class="line"><a id="l04302" name="l04302"></a><span class="lineno"> 4302</span>                              z)  <span class="comment">!o</span></div>
<div class="line"><a id="l04303" name="l04303"></a><span class="lineno"> 4303</span>    <span class="comment">!==========================================================================</span></div>
<div class="line"><a id="l04304" name="l04304"></a><span class="lineno"> 4304</span>    <span class="comment">! DESCRIPTION:</span></div>
<div class="line"><a id="l04305" name="l04305"></a><span class="lineno"> 4305</span>    <span class="comment">! Combine snow layers that are less than a minimum thickness or mass</span></div>
<div class="line"><a id="l04306" name="l04306"></a><span class="lineno"> 4306</span>    <span class="comment">! If the snow element thickness or mass is less than a prescribed minimum,</span></div>
<div class="line"><a id="l04307" name="l04307"></a><span class="lineno"> 4307</span>    <span class="comment">! then it is combined with a neighboring element.  The subroutine</span></div>
<div class="line"><a id="l04308" name="l04308"></a><span class="lineno"> 4308</span>    <span class="comment">! clm\_combo.f90 then executes the combination of mass and energy.</span></div>
<div class="line"><a id="l04309" name="l04309"></a><span class="lineno"> 4309</span>    <span class="comment">! CALLED FROM:</span></div>
<div class="line"><a id="l04310" name="l04310"></a><span class="lineno"> 4310</span>    <span class="comment">! subroutine Hydrology2 in module Hydrology2Mod</span></div>
<div class="line"><a id="l04311" name="l04311"></a><span class="lineno"> 4311</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04312" name="l04312"></a><span class="lineno"> 4312</span>    <span class="comment">! REVISION HISTORY:</span></div>
<div class="line"><a id="l04313" name="l04313"></a><span class="lineno"> 4313</span>    <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l04314" name="l04314"></a><span class="lineno"> 4314</span>    <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l04315" name="l04315"></a><span class="lineno"> 4315</span>    <span class="comment">! 2/28/02, Peter Thornton: Migrated to new data structures.</span></div>
<div class="line"><a id="l04316" name="l04316"></a><span class="lineno"> 4316</span>    <span class="comment">!=========================================================================</span></div>
<div class="line"><a id="l04317" name="l04317"></a><span class="lineno"> 4317</span>    <span class="comment">! !USES:</span></div>
<div class="line"><a id="l04318" name="l04318"></a><span class="lineno"> 4318</span>    <span class="comment">!  use clmtype</span></div>
<div class="line"><a id="l04319" name="l04319"></a><span class="lineno"> 4319</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04320" name="l04320"></a><span class="lineno"> 4320</span>    <span class="comment">! !ARGUMENTS:</span></div>
<div class="line"><a id="l04321" name="l04321"></a><span class="lineno"> 4321</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l04322" name="l04322"></a><span class="lineno"> 4322</span>    <span class="comment">!in:</span></div>
<div class="line"><a id="l04323" name="l04323"></a><span class="lineno"> 4323</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span>    :: lbc, ubc<span class="comment">                    !&lt; column bounds</span></div>
<div class="line"><a id="l04324" name="l04324"></a><span class="lineno"> 4324</span>   <span class="comment">! integer, intent(in) :: clandunit(1)       !landunit index for each column</span></div>
<div class="line"><a id="l04325" name="l04325"></a><span class="lineno"> 4325</span>   <span class="comment">! integer, intent(in) :: ityplun(1)         !landunit type</span></div>
<div class="line"><a id="l04326" name="l04326"></a><span class="lineno"> 4326</span> </div>
<div class="line"><a id="l04327" name="l04327"></a><span class="lineno"> 4327</span>    <span class="comment">!inout:</span></div>
<div class="line"><a id="l04328" name="l04328"></a><span class="lineno"> 4328</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: num_snowc<span class="comment">                   !&lt; number of column snow points in column filter</span></div>
<div class="line"><a id="l04329" name="l04329"></a><span class="lineno"> 4329</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: filter_snowc(ubc-lbc+1)<span class="comment">     !&lt; column filter for snow points</span></div>
<div class="line"><a id="l04330" name="l04330"></a><span class="lineno"> 4330</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(inout)</span> :: snl(1)<span class="comment">            !&lt; number of snow layers</span></div>
<div class="line"><a id="l04331" name="l04331"></a><span class="lineno"> 4331</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osno(1)<span class="comment">         !&lt; snow water (mm H2O)</span></div>
<div class="line"><a id="l04332" name="l04332"></a><span class="lineno"> 4332</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: snowdp(1)<span class="comment">         !&lt; snow height (m)</span></div>
<div class="line"><a id="l04333" name="l04333"></a><span class="lineno"> 4333</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: dz(1,-nlevsnow+1:nlevsoil)<span class="comment">           !&lt; layer depth (m)</span></div>
<div class="line"><a id="l04334" name="l04334"></a><span class="lineno"> 4334</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: zi(1,-nlevsnow+0:nlevsoil)<span class="comment">           !&lt; interface level below a &quot;z&quot; level (m)</span></div>
<div class="line"><a id="l04335" name="l04335"></a><span class="lineno"> 4335</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: t_soisno(1,-nlevsnow+1:nlevsoil)<span class="comment">     !&lt; soil temperature (Kelvin)</span></div>
<div class="line"><a id="l04336" name="l04336"></a><span class="lineno"> 4336</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osoi_ice(1,-nlevsnow+1:nlevsoil)<span class="comment">   !&lt; ice lens (kg/m2)</span></div>
<div class="line"><a id="l04337" name="l04337"></a><span class="lineno"> 4337</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osoi_liq(1,-nlevsnow+1:nlevsoil)<span class="comment">   !&lt; liquid water (kg/m2)</span></div>
<div class="line"><a id="l04338" name="l04338"></a><span class="lineno"> 4338</span> </div>
<div class="line"><a id="l04339" name="l04339"></a><span class="lineno"> 4339</span>    <span class="comment">!out:</span></div>
<div class="line"><a id="l04340" name="l04340"></a><span class="lineno"> 4340</span> </div>
<div class="line"><a id="l04341" name="l04341"></a><span class="lineno"> 4341</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: z(1,-nlevsnow+1:nlevsoil)<span class="comment">            !&lt; layer thickness (m)</span></div>
<div class="line"><a id="l04342" name="l04342"></a><span class="lineno"> 4342</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04343" name="l04343"></a><span class="lineno"> 4343</span>    <span class="comment">!EOP</span></div>
<div class="line"><a id="l04344" name="l04344"></a><span class="lineno"> 4344</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04345" name="l04345"></a><span class="lineno"> 4345</span>    <span class="comment">! !OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l04346" name="l04346"></a><span class="lineno"> 4346</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04347" name="l04347"></a><span class="lineno"> 4347</span>    <span class="keywordtype">integer</span> :: c, fc                 <span class="comment">! column indices</span></div>
<div class="line"><a id="l04348" name="l04348"></a><span class="lineno"> 4348</span>    <span class="keywordtype">integer</span> :: i,k                   <span class="comment">! loop indices</span></div>
<div class="line"><a id="l04349" name="l04349"></a><span class="lineno"> 4349</span>    <span class="keywordtype">integer</span> :: j,l                   <span class="comment">! node indices</span></div>
<div class="line"><a id="l04350" name="l04350"></a><span class="lineno"> 4350</span>    <span class="keywordtype">integer</span> :: msn_old(lbc:ubc)      <span class="comment">! number of top snow layer</span></div>
<div class="line"><a id="l04351" name="l04351"></a><span class="lineno"> 4351</span>    <span class="keywordtype">integer</span> :: mssi(lbc:ubc)         <span class="comment">! node index</span></div>
<div class="line"><a id="l04352" name="l04352"></a><span class="lineno"> 4352</span>    <span class="keywordtype">integer</span> :: neibor                <span class="comment">! adjacent node selected for combination</span></div>
<div class="line"><a id="l04353" name="l04353"></a><span class="lineno"> 4353</span><span class="keywordtype">    real</span>(kind_lake):: zwice(lbc:ubc)        <span class="comment">! total ice mass in snow</span></div>
<div class="line"><a id="l04354" name="l04354"></a><span class="lineno"> 4354</span><span class="keywordtype">    real</span>(kind_lake):: zwliq (lbc:ubc)       <span class="comment">! total liquid water in snow</span></div>
<div class="line"><a id="l04355" name="l04355"></a><span class="lineno"> 4355</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">parameter</span> :: dzmin(5) = &amp; <span class="comment">! minimum of top snow layer</span></div>
<div class="line"><a id="l04356" name="l04356"></a><span class="lineno"> 4356</span>         (/0.010, 0.015, 0.025, 0.055, 0.115/)</div>
<div class="line"><a id="l04357" name="l04357"></a><span class="lineno"> 4357</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04358" name="l04358"></a><span class="lineno"> 4358</span>    </div>
<div class="line"><a id="l04359" name="l04359"></a><span class="lineno"> 4359</span>    <span class="comment">! Check the mass of ice lens of snow, when the total is less than a small value,</span></div>
<div class="line"><a id="l04360" name="l04360"></a><span class="lineno"> 4360</span>    <span class="comment">! combine it with the underlying neighbor.</span></div>
<div class="line"><a id="l04361" name="l04361"></a><span class="lineno"> 4361</span>    </div>
<div class="line"><a id="l04362" name="l04362"></a><span class="lineno"> 4362</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04363" name="l04363"></a><span class="lineno"> 4363</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04364" name="l04364"></a><span class="lineno"> 4364</span>    <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04365" name="l04365"></a><span class="lineno"> 4365</span>       c = filter_snowc(fc)</div>
<div class="line"><a id="l04366" name="l04366"></a><span class="lineno"> 4366</span>       msn_old(c) = snl(c)</div>
<div class="line"><a id="l04367" name="l04367"></a><span class="lineno"> 4367</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04368" name="l04368"></a><span class="lineno"> 4368</span> </div>
<div class="line"><a id="l04369" name="l04369"></a><span class="lineno"> 4369</span>    <span class="comment">! The following loop is NOT VECTORIZED</span></div>
<div class="line"><a id="l04370" name="l04370"></a><span class="lineno"> 4370</span> </div>
<div class="line"><a id="l04371" name="l04371"></a><span class="lineno"> 4371</span>    <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04372" name="l04372"></a><span class="lineno"> 4372</span>       c = filter_snowc(fc)</div>
<div class="line"><a id="l04373" name="l04373"></a><span class="lineno"> 4373</span>   <span class="comment">!    l = clandunit(c)                                                    </span></div>
<div class="line"><a id="l04374" name="l04374"></a><span class="lineno"> 4374</span>       <span class="keywordflow">do</span> j = msn_old(c)+1,0</div>
<div class="line"><a id="l04375" name="l04375"></a><span class="lineno"> 4375</span>          <span class="keywordflow">if</span> (h2osoi_ice(c,j) &lt;= .1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04376" name="l04376"></a><span class="lineno"> 4376</span>           <span class="comment">!  if (ityplun(l) == istsoil) then                                </span></div>
<div class="line"><a id="l04377" name="l04377"></a><span class="lineno"> 4377</span>           <span class="comment">!     h2osoi_liq(c,j+1) = h2osoi_liq(c,j+1) + h2osoi_liq(c,j)        </span></div>
<div class="line"><a id="l04378" name="l04378"></a><span class="lineno"> 4378</span>           <span class="comment">!     h2osoi_ice(c,j+1) = h2osoi_ice(c,j+1) + h2osoi_ice(c,j)       </span></div>
<div class="line"><a id="l04379" name="l04379"></a><span class="lineno"> 4379</span>           <span class="comment">!  else if (ityplun(l) /= istsoil .and. j /= 0) then               </span></div>
<div class="line"><a id="l04380" name="l04380"></a><span class="lineno"> 4380</span>             h2osoi_liq(c,j+1) = h2osoi_liq(c,j+1) + h2osoi_liq(c,j)</div>
<div class="line"><a id="l04381" name="l04381"></a><span class="lineno"> 4381</span>             h2osoi_ice(c,j+1) = h2osoi_ice(c,j+1) + h2osoi_ice(c,j)</div>
<div class="line"><a id="l04382" name="l04382"></a><span class="lineno"> 4382</span>           <span class="comment">!  end if </span></div>
<div class="line"><a id="l04383" name="l04383"></a><span class="lineno"> 4383</span> </div>
<div class="line"><a id="l04384" name="l04384"></a><span class="lineno"> 4384</span>             <span class="comment">! shift all elements above this down one.</span></div>
<div class="line"><a id="l04385" name="l04385"></a><span class="lineno"> 4385</span>             <span class="keywordflow">if</span> (j &gt; snl(c)+1 .and. snl(c) &lt; -1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04386" name="l04386"></a><span class="lineno"> 4386</span>                <span class="keywordflow">do</span> i = j, snl(c)+2, -1</div>
<div class="line"><a id="l04387" name="l04387"></a><span class="lineno"> 4387</span>                   t_soisno(c,i)   = t_soisno(c,i-1)</div>
<div class="line"><a id="l04388" name="l04388"></a><span class="lineno"> 4388</span>                   h2osoi_liq(c,i) = h2osoi_liq(c,i-1)</div>
<div class="line"><a id="l04389" name="l04389"></a><span class="lineno"> 4389</span>                   h2osoi_ice(c,i) = h2osoi_ice(c,i-1)</div>
<div class="line"><a id="l04390" name="l04390"></a><span class="lineno"> 4390</span>                   dz(c,i)         = dz(c,i-1)</div>
<div class="line"><a id="l04391" name="l04391"></a><span class="lineno"> 4391</span><span class="keywordflow">                end do</span></div>
<div class="line"><a id="l04392" name="l04392"></a><span class="lineno"> 4392</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l04393" name="l04393"></a><span class="lineno"> 4393</span>             snl(c) = snl(c) + 1</div>
<div class="line"><a id="l04394" name="l04394"></a><span class="lineno"> 4394</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04395" name="l04395"></a><span class="lineno"> 4395</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l04396" name="l04396"></a><span class="lineno"> 4396</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04397" name="l04397"></a><span class="lineno"> 4397</span> </div>
<div class="line"><a id="l04398" name="l04398"></a><span class="lineno"> 4398</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04399" name="l04399"></a><span class="lineno"> 4399</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04400" name="l04400"></a><span class="lineno"> 4400</span>    <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04401" name="l04401"></a><span class="lineno"> 4401</span>       c = filter_snowc(fc)</div>
<div class="line"><a id="l04402" name="l04402"></a><span class="lineno"> 4402</span>       h2osno(c) = 0._kind_lake</div>
<div class="line"><a id="l04403" name="l04403"></a><span class="lineno"> 4403</span>       snowdp(c) = 0._kind_lake</div>
<div class="line"><a id="l04404" name="l04404"></a><span class="lineno"> 4404</span>       zwice(c)  = 0._kind_lake</div>
<div class="line"><a id="l04405" name="l04405"></a><span class="lineno"> 4405</span>       zwliq(c)  = 0._kind_lake</div>
<div class="line"><a id="l04406" name="l04406"></a><span class="lineno"> 4406</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04407" name="l04407"></a><span class="lineno"> 4407</span> </div>
<div class="line"><a id="l04408" name="l04408"></a><span class="lineno"> 4408</span>    <span class="keywordflow">do</span> j = -nlevsnow+1,0</div>
<div class="line"><a id="l04409" name="l04409"></a><span class="lineno"> 4409</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04410" name="l04410"></a><span class="lineno"> 4410</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04411" name="l04411"></a><span class="lineno"> 4411</span>      <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04412" name="l04412"></a><span class="lineno"> 4412</span>          c = filter_snowc(fc)</div>
<div class="line"><a id="l04413" name="l04413"></a><span class="lineno"> 4413</span>          <span class="keywordflow">if</span> (j &gt;= snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04414" name="l04414"></a><span class="lineno"> 4414</span>             h2osno(c) = h2osno(c) + h2osoi_ice(c,j) + h2osoi_liq(c,j)</div>
<div class="line"><a id="l04415" name="l04415"></a><span class="lineno"> 4415</span>             snowdp(c) = snowdp(c) + dz(c,j)</div>
<div class="line"><a id="l04416" name="l04416"></a><span class="lineno"> 4416</span>             zwice(c)  = zwice(c) + h2osoi_ice(c,j)</div>
<div class="line"><a id="l04417" name="l04417"></a><span class="lineno"> 4417</span>             zwliq(c)  = zwliq(c) + h2osoi_liq(c,j)</div>
<div class="line"><a id="l04418" name="l04418"></a><span class="lineno"> 4418</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04419" name="l04419"></a><span class="lineno"> 4419</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l04420" name="l04420"></a><span class="lineno"> 4420</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04421" name="l04421"></a><span class="lineno"> 4421</span> </div>
<div class="line"><a id="l04422" name="l04422"></a><span class="lineno"> 4422</span>    <span class="comment">! Check the snow depth - all snow gone</span></div>
<div class="line"><a id="l04423" name="l04423"></a><span class="lineno"> 4423</span>    <span class="comment">! The liquid water assumes ponding on soil surface.</span></div>
<div class="line"><a id="l04424" name="l04424"></a><span class="lineno"> 4424</span> </div>
<div class="line"><a id="l04425" name="l04425"></a><span class="lineno"> 4425</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04426" name="l04426"></a><span class="lineno"> 4426</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04427" name="l04427"></a><span class="lineno"> 4427</span>    <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04428" name="l04428"></a><span class="lineno"> 4428</span>       c = filter_snowc(fc)</div>
<div class="line"><a id="l04429" name="l04429"></a><span class="lineno"> 4429</span>      <span class="comment">! l = clandunit(c)                                         </span></div>
<div class="line"><a id="l04430" name="l04430"></a><span class="lineno"> 4430</span>       <span class="keywordflow">if</span> (snowdp(c) &lt; 0.01 .and. snowdp(c) &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04431" name="l04431"></a><span class="lineno"> 4431</span>          snl(c) = 0</div>
<div class="line"><a id="l04432" name="l04432"></a><span class="lineno"> 4432</span>          h2osno(c) = zwice(c)</div>
<div class="line"><a id="l04433" name="l04433"></a><span class="lineno"> 4433</span>          <span class="keywordflow">if</span> (h2osno(c) &lt;= 0.) snowdp(c) = 0._kind_lake</div>
<div class="line"><a id="l04434" name="l04434"></a><span class="lineno"> 4434</span>      <span class="comment">!    if (ityplun(l) == istsoil) h2osoi_liq(c,1) = h2osoi_liq(c,1) + zwliq(c)    !change by guhp</span></div>
<div class="line"><a id="l04435" name="l04435"></a><span class="lineno"> 4435</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l04436" name="l04436"></a><span class="lineno"> 4436</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04437" name="l04437"></a><span class="lineno"> 4437</span> </div>
<div class="line"><a id="l04438" name="l04438"></a><span class="lineno"> 4438</span>    <span class="comment">! Check the snow depth - snow layers combined</span></div>
<div class="line"><a id="l04439" name="l04439"></a><span class="lineno"> 4439</span>    <span class="comment">! The following loop IS NOT VECTORIZED</span></div>
<div class="line"><a id="l04440" name="l04440"></a><span class="lineno"> 4440</span> </div>
<div class="line"><a id="l04441" name="l04441"></a><span class="lineno"> 4441</span>    <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04442" name="l04442"></a><span class="lineno"> 4442</span>       c = filter_snowc(fc)</div>
<div class="line"><a id="l04443" name="l04443"></a><span class="lineno"> 4443</span> </div>
<div class="line"><a id="l04444" name="l04444"></a><span class="lineno"> 4444</span>       <span class="comment">! Two or more layers</span></div>
<div class="line"><a id="l04445" name="l04445"></a><span class="lineno"> 4445</span> </div>
<div class="line"><a id="l04446" name="l04446"></a><span class="lineno"> 4446</span>       <span class="keywordflow">if</span> (snl(c) &lt; -1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04447" name="l04447"></a><span class="lineno"> 4447</span> </div>
<div class="line"><a id="l04448" name="l04448"></a><span class="lineno"> 4448</span>          msn_old(c) = snl(c)</div>
<div class="line"><a id="l04449" name="l04449"></a><span class="lineno"> 4449</span>          mssi(c) = 1</div>
<div class="line"><a id="l04450" name="l04450"></a><span class="lineno"> 4450</span> </div>
<div class="line"><a id="l04451" name="l04451"></a><span class="lineno"> 4451</span>          <span class="keywordflow">do</span> i = msn_old(c)+1,0</div>
<div class="line"><a id="l04452" name="l04452"></a><span class="lineno"> 4452</span>             <span class="keywordflow">if</span> (dz(c,i) &lt; dzmin(mssi(c))) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04453" name="l04453"></a><span class="lineno"> 4453</span> </div>
<div class="line"><a id="l04454" name="l04454"></a><span class="lineno"> 4454</span>                <span class="keywordflow">if</span> (i == snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04455" name="l04455"></a><span class="lineno"> 4455</span>                   <span class="comment">! If top node is removed, combine with bottom neighbor.</span></div>
<div class="line"><a id="l04456" name="l04456"></a><span class="lineno"> 4456</span>                   neibor = i + 1</div>
<div class="line"><a id="l04457" name="l04457"></a><span class="lineno"> 4457</span>                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04458" name="l04458"></a><span class="lineno"> 4458</span>                   <span class="comment">! If the bottom neighbor is not snow, combine with the top neighbor.</span></div>
<div class="line"><a id="l04459" name="l04459"></a><span class="lineno"> 4459</span>                   neibor = i - 1</div>
<div class="line"><a id="l04460" name="l04460"></a><span class="lineno"> 4460</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l04461" name="l04461"></a><span class="lineno"> 4461</span>                   <span class="comment">! If none of the above special cases apply, combine with the thinnest neighbor</span></div>
<div class="line"><a id="l04462" name="l04462"></a><span class="lineno"> 4462</span>                   neibor = i + 1</div>
<div class="line"><a id="l04463" name="l04463"></a><span class="lineno"> 4463</span>                   <span class="keywordflow">if</span> ((dz(c,i-1)+dz(c,i)) &lt; (dz(c,i+1)+dz(c,i))) neibor = i-1</div>
<div class="line"><a id="l04464" name="l04464"></a><span class="lineno"> 4464</span><span class="keywordflow">                end if</span></div>
<div class="line"><a id="l04465" name="l04465"></a><span class="lineno"> 4465</span> </div>
<div class="line"><a id="l04466" name="l04466"></a><span class="lineno"> 4466</span>                <span class="comment">! Node l and j are combined and stored as node j.</span></div>
<div class="line"><a id="l04467" name="l04467"></a><span class="lineno"> 4467</span>                <span class="keywordflow">if</span> (neibor &gt; i) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04468" name="l04468"></a><span class="lineno"> 4468</span>                   j = neibor</div>
<div class="line"><a id="l04469" name="l04469"></a><span class="lineno"> 4469</span>                   l = i</div>
<div class="line"><a id="l04470" name="l04470"></a><span class="lineno"> 4470</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l04471" name="l04471"></a><span class="lineno"> 4471</span>                   j = i</div>
<div class="line"><a id="l04472" name="l04472"></a><span class="lineno"> 4472</span>                   l = neibor</div>
<div class="line"><a id="l04473" name="l04473"></a><span class="lineno"> 4473</span><span class="keywordflow">                end if</span></div>
<div class="line"><a id="l04474" name="l04474"></a><span class="lineno"> 4474</span> </div>
<div class="line"><a id="l04475" name="l04475"></a><span class="lineno"> 4475</span>                <span class="keyword">call </span><a class="code hl_function" href="group___noah_m_p___l_s_m_ga4804d8de40f7ea8a8cf4ed6e22ff4aa0.html#ga4804d8de40f7ea8a8cf4ed6e22ff4aa0">combo</a> (dz(c,j), h2osoi_liq(c,j), h2osoi_ice(c,j), &amp;</div>
<div class="line"><a id="l04476" name="l04476"></a><span class="lineno"> 4476</span>                   t_soisno(c,j), dz(c,l), h2osoi_liq(c,l), h2osoi_ice(c,l), t_soisno(c,l) )</div>
<div class="line"><a id="l04477" name="l04477"></a><span class="lineno"> 4477</span> </div>
<div class="line"><a id="l04478" name="l04478"></a><span class="lineno"> 4478</span>                <span class="comment">! Now shift all elements above this down one.</span></div>
<div class="line"><a id="l04479" name="l04479"></a><span class="lineno"> 4479</span>                <span class="keywordflow">if</span> (j-1 &gt; snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04480" name="l04480"></a><span class="lineno"> 4480</span>                   <span class="keywordflow">do</span> k = j-1, snl(c)+2, -1</div>
<div class="line"><a id="l04481" name="l04481"></a><span class="lineno"> 4481</span>                      t_soisno(c,k) = t_soisno(c,k-1)</div>
<div class="line"><a id="l04482" name="l04482"></a><span class="lineno"> 4482</span>                      h2osoi_ice(c,k) = h2osoi_ice(c,k-1)</div>
<div class="line"><a id="l04483" name="l04483"></a><span class="lineno"> 4483</span>                      h2osoi_liq(c,k) = h2osoi_liq(c,k-1)</div>
<div class="line"><a id="l04484" name="l04484"></a><span class="lineno"> 4484</span>                      dz(c,k) = dz(c,k-1)</div>
<div class="line"><a id="l04485" name="l04485"></a><span class="lineno"> 4485</span><span class="keywordflow">                   end do</span></div>
<div class="line"><a id="l04486" name="l04486"></a><span class="lineno"> 4486</span><span class="keywordflow">                end if</span></div>
<div class="line"><a id="l04487" name="l04487"></a><span class="lineno"> 4487</span> </div>
<div class="line"><a id="l04488" name="l04488"></a><span class="lineno"> 4488</span>                <span class="comment">! Decrease the number of snow layers</span></div>
<div class="line"><a id="l04489" name="l04489"></a><span class="lineno"> 4489</span>                snl(c) = snl(c) + 1</div>
<div class="line"><a id="l04490" name="l04490"></a><span class="lineno"> 4490</span>                <span class="keywordflow">if</span> (snl(c) &gt;= -1) <span class="keywordflow">EXIT</span></div>
<div class="line"><a id="l04491" name="l04491"></a><span class="lineno"> 4491</span> </div>
<div class="line"><a id="l04492" name="l04492"></a><span class="lineno"> 4492</span>             <span class="keywordflow">else</span></div>
<div class="line"><a id="l04493" name="l04493"></a><span class="lineno"> 4493</span> </div>
<div class="line"><a id="l04494" name="l04494"></a><span class="lineno"> 4494</span>                <span class="comment">! The layer thickness is greater than the prescribed minimum value</span></div>
<div class="line"><a id="l04495" name="l04495"></a><span class="lineno"> 4495</span>                mssi(c) = mssi(c) + 1</div>
<div class="line"><a id="l04496" name="l04496"></a><span class="lineno"> 4496</span> </div>
<div class="line"><a id="l04497" name="l04497"></a><span class="lineno"> 4497</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l04498" name="l04498"></a><span class="lineno"> 4498</span><span class="keywordflow">          end do</span></div>
<div class="line"><a id="l04499" name="l04499"></a><span class="lineno"> 4499</span> </div>
<div class="line"><a id="l04500" name="l04500"></a><span class="lineno"> 4500</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l04501" name="l04501"></a><span class="lineno"> 4501</span> </div>
<div class="line"><a id="l04502" name="l04502"></a><span class="lineno"> 4502</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04503" name="l04503"></a><span class="lineno"> 4503</span> </div>
<div class="line"><a id="l04504" name="l04504"></a><span class="lineno"> 4504</span>    <span class="comment">! Reset the node depth and the depth of layer interface</span></div>
<div class="line"><a id="l04505" name="l04505"></a><span class="lineno"> 4505</span> </div>
<div class="line"><a id="l04506" name="l04506"></a><span class="lineno"> 4506</span>    <span class="keywordflow">do</span> j = 0, -nlevsnow+1, -1</div>
<div class="line"><a id="l04507" name="l04507"></a><span class="lineno"> 4507</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04508" name="l04508"></a><span class="lineno"> 4508</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04509" name="l04509"></a><span class="lineno"> 4509</span>      <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04510" name="l04510"></a><span class="lineno"> 4510</span>          c = filter_snowc(fc)</div>
<div class="line"><a id="l04511" name="l04511"></a><span class="lineno"> 4511</span>          <span class="keywordflow">if</span> (j &gt;= snl(c) + 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04512" name="l04512"></a><span class="lineno"> 4512</span>             z(c,j) = zi(c,j) - 0.5*dz(c,j)</div>
<div class="line"><a id="l04513" name="l04513"></a><span class="lineno"> 4513</span>             zi(c,j-1) = zi(c,j) - dz(c,j)</div>
<div class="line"><a id="l04514" name="l04514"></a><span class="lineno"> 4514</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04515" name="l04515"></a><span class="lineno"> 4515</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l04516" name="l04516"></a><span class="lineno"> 4516</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04517" name="l04517"></a><span class="lineno"> 4517</span> </div>
</div>
<div class="line"><a id="l04518" name="l04518"></a><span class="lineno"> 4518</span>  <span class="keyword">end subroutine </span>combinesnowlayers</div>
<div class="line"><a id="l04519" name="l04519"></a><span class="lineno"> 4519</span> </div>
<div class="line"><a id="l04520" name="l04520"></a><span class="lineno"> 4520</span><span class="comment">! DESCRIPTION:</span><span class="comment"></span></div>
<div class="line"><a id="l04521" name="l04521"></a><span class="lineno"> 4521</span><span class="comment">!&gt; Subdivides snow layers if they exceed their prescribed maximum thickness.</span></div>
<div class="foldopen" id="foldopen04522" data-start="" data-end="">
<div class="line"><a id="l04522" name="l04522"></a><span class="lineno"><a class="line" href="namespaceclm__lake_acf8bb476b784cdc2fb82a0a387e3de9f.html#acf8bb476b784cdc2fb82a0a387e3de9f"> 4522</a></span>  <span class="keyword">subroutine </span>dividesnowlayers(lbc, ubc,                             &amp; !i</div>
<div class="line"><a id="l04523" name="l04523"></a><span class="lineno"> 4523</span>                             num_snowc, filter_snowc,  &amp; !i&amp;o</div>
<div class="line"><a id="l04524" name="l04524"></a><span class="lineno"> 4524</span>                             snl,dz,zi,t_soisno,                   &amp; !i&amp;o</div>
<div class="line"><a id="l04525" name="l04525"></a><span class="lineno"> 4525</span>                             h2osoi_ice,h2osoi_liq,                &amp; !i&amp;o</div>
<div class="line"><a id="l04526" name="l04526"></a><span class="lineno"> 4526</span>                             z)  <span class="comment">!o</span></div>
<div class="line"><a id="l04527" name="l04527"></a><span class="lineno"> 4527</span> </div>
<div class="line"><a id="l04528" name="l04528"></a><span class="lineno"> 4528</span> </div>
<div class="line"><a id="l04529" name="l04529"></a><span class="lineno"> 4529</span>    <span class="comment">!============================================================================</span></div>
<div class="line"><a id="l04530" name="l04530"></a><span class="lineno"> 4530</span>    <span class="comment">! !CALLED FROM:</span></div>
<div class="line"><a id="l04531" name="l04531"></a><span class="lineno"> 4531</span>    <span class="comment">! subroutine Hydrology2 in module Hydrology2Mod</span></div>
<div class="line"><a id="l04532" name="l04532"></a><span class="lineno"> 4532</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04533" name="l04533"></a><span class="lineno"> 4533</span>    <span class="comment">! !REVISION HISTORY:</span></div>
<div class="line"><a id="l04534" name="l04534"></a><span class="lineno"> 4534</span>    <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l04535" name="l04535"></a><span class="lineno"> 4535</span>    <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l04536" name="l04536"></a><span class="lineno"> 4536</span>    <span class="comment">! 2/28/02, Peter Thornton: Migrated to new data structures.</span></div>
<div class="line"><a id="l04537" name="l04537"></a><span class="lineno"> 4537</span>    <span class="comment">!============================================================================</span></div>
<div class="line"><a id="l04538" name="l04538"></a><span class="lineno"> 4538</span>    <span class="comment">! !USES:</span></div>
<div class="line"><a id="l04539" name="l04539"></a><span class="lineno"> 4539</span>    <span class="comment">!   use clmtype</span></div>
<div class="line"><a id="l04540" name="l04540"></a><span class="lineno"> 4540</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04541" name="l04541"></a><span class="lineno"> 4541</span>    <span class="comment">! !ARGUMENTS:</span></div>
<div class="line"><a id="l04542" name="l04542"></a><span class="lineno"> 4542</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l04543" name="l04543"></a><span class="lineno"> 4543</span> </div>
<div class="line"><a id="l04544" name="l04544"></a><span class="lineno"> 4544</span>    <span class="comment">!in:</span></div>
<div class="line"><a id="l04545" name="l04545"></a><span class="lineno"> 4545</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span>    :: lbc, ubc<span class="comment">                    !&lt; column bounds</span></div>
<div class="line"><a id="l04546" name="l04546"></a><span class="lineno"> 4546</span> </div>
<div class="line"><a id="l04547" name="l04547"></a><span class="lineno"> 4547</span>    <span class="comment">!inout:</span></div>
<div class="line"><a id="l04548" name="l04548"></a><span class="lineno"> 4548</span> </div>
<div class="line"><a id="l04549" name="l04549"></a><span class="lineno"> 4549</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: num_snowc<span class="comment">                   !&lt; number of column snow points in column filter</span></div>
<div class="line"><a id="l04550" name="l04550"></a><span class="lineno"> 4550</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: filter_snowc(ubc-lbc+1)<span class="comment">     !&lt; column filter for snow points</span></div>
<div class="line"><a id="l04551" name="l04551"></a><span class="lineno"> 4551</span>    <span class="keywordtype">integer</span> , <span class="keywordtype">intent(inout)</span> :: snl(1)<span class="comment">                     !&lt; number of snow layers</span></div>
<div class="line"><a id="l04552" name="l04552"></a><span class="lineno"> 4552</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: dz(1,-nlevsnow+1:nlevsoil)<span class="comment">           !&lt; layer depth (m)</span></div>
<div class="line"><a id="l04553" name="l04553"></a><span class="lineno"> 4553</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: zi(1,-nlevsnow+0:nlevsoil)<span class="comment">           !&lt; interface level below a &quot;z&quot; level (m)</span></div>
<div class="line"><a id="l04554" name="l04554"></a><span class="lineno"> 4554</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: t_soisno(1,-nlevsnow+1:nlevsoil)<span class="comment">     !&lt; soil temperature (Kelvin)</span></div>
<div class="line"><a id="l04555" name="l04555"></a><span class="lineno"> 4555</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osoi_ice(1,-nlevsnow+1:nlevsoil)<span class="comment">   !&lt; ice lens (kg/m2)</span></div>
<div class="line"><a id="l04556" name="l04556"></a><span class="lineno"> 4556</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: h2osoi_liq(1,-nlevsnow+1:nlevsoil)<span class="comment">   !&lt; liquid water (kg/m2)</span></div>
<div class="line"><a id="l04557" name="l04557"></a><span class="lineno"> 4557</span> </div>
<div class="line"><a id="l04558" name="l04558"></a><span class="lineno"> 4558</span>    <span class="comment">!out: </span></div>
<div class="line"><a id="l04559" name="l04559"></a><span class="lineno"> 4559</span> </div>
<div class="line"><a id="l04560" name="l04560"></a><span class="lineno"> 4560</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: z(1,-nlevsnow+1:nlevsoil)<span class="comment">            !&lt; layer thickness (m)</span></div>
<div class="line"><a id="l04561" name="l04561"></a><span class="lineno"> 4561</span> </div>
<div class="line"><a id="l04562" name="l04562"></a><span class="lineno"> 4562</span> </div>
<div class="line"><a id="l04563" name="l04563"></a><span class="lineno"> 4563</span> </div>
<div class="line"><a id="l04564" name="l04564"></a><span class="lineno"> 4564</span>    <span class="comment">! OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l04565" name="l04565"></a><span class="lineno"> 4565</span> </div>
<div class="line"><a id="l04566" name="l04566"></a><span class="lineno"> 4566</span>    <span class="keywordtype">integer</span>  :: j, c, fc               <span class="comment">! indices</span></div>
<div class="line"><a id="l04567" name="l04567"></a><span class="lineno"> 4567</span><span class="keywordtype">    real</span>(kind_lake) :: drr                    <span class="comment">! thickness of the combined [m]</span></div>
<div class="line"><a id="l04568" name="l04568"></a><span class="lineno"> 4568</span>    <span class="keywordtype">integer</span>  :: msno                   <span class="comment">! number of snow layer 1 (top) to msno (bottom)</span></div>
<div class="line"><a id="l04569" name="l04569"></a><span class="lineno"> 4569</span><span class="keywordtype">    real</span>(kind_lake) :: dzsno(lbc:ubc,nlevsnow) <span class="comment">! Snow layer thickness [m]</span></div>
<div class="line"><a id="l04570" name="l04570"></a><span class="lineno"> 4570</span><span class="keywordtype">    real</span>(kind_lake) :: swice(lbc:ubc,nlevsnow) <span class="comment">! Partial volume of ice [m3/m3]</span></div>
<div class="line"><a id="l04571" name="l04571"></a><span class="lineno"> 4571</span><span class="keywordtype">    real</span>(kind_lake) :: swliq(lbc:ubc,nlevsnow) <span class="comment">! Partial volume of liquid water [m3/m3]</span></div>
<div class="line"><a id="l04572" name="l04572"></a><span class="lineno"> 4572</span><span class="keywordtype">    real</span>(kind_lake) :: tsno(lbc:ubc ,nlevsnow) <span class="comment">! Nodel temperature [K]</span></div>
<div class="line"><a id="l04573" name="l04573"></a><span class="lineno"> 4573</span><span class="keywordtype">    real</span>(kind_lake) :: zwice                  <span class="comment">! temporary</span></div>
<div class="line"><a id="l04574" name="l04574"></a><span class="lineno"> 4574</span><span class="keywordtype">    real</span>(kind_lake) :: zwliq                  <span class="comment">! temporary</span></div>
<div class="line"><a id="l04575" name="l04575"></a><span class="lineno"> 4575</span><span class="keywordtype">    real</span>(kind_lake) :: propor                 <span class="comment">! temporary</span></div>
<div class="line"><a id="l04576" name="l04576"></a><span class="lineno"> 4576</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04577" name="l04577"></a><span class="lineno"> 4577</span> </div>
<div class="line"><a id="l04578" name="l04578"></a><span class="lineno"> 4578</span>    <span class="comment">! Begin calculation - note that the following column loops are only invoked</span></div>
<div class="line"><a id="l04579" name="l04579"></a><span class="lineno"> 4579</span>    <span class="comment">! for snow-covered columns</span></div>
<div class="line"><a id="l04580" name="l04580"></a><span class="lineno"> 4580</span> </div>
<div class="line"><a id="l04581" name="l04581"></a><span class="lineno"> 4581</span>    <span class="keywordflow">do</span> j = 1,nlevsnow</div>
<div class="line"><a id="l04582" name="l04582"></a><span class="lineno"> 4582</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04583" name="l04583"></a><span class="lineno"> 4583</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04584" name="l04584"></a><span class="lineno"> 4584</span>       <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04585" name="l04585"></a><span class="lineno"> 4585</span>          c = filter_snowc(fc)</div>
<div class="line"><a id="l04586" name="l04586"></a><span class="lineno"> 4586</span>          <span class="keywordflow">if</span> (j &lt;= abs(snl(c))) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04587" name="l04587"></a><span class="lineno"> 4587</span>             dzsno(c,j) = dz(c,j+snl(c))</div>
<div class="line"><a id="l04588" name="l04588"></a><span class="lineno"> 4588</span>             swice(c,j) = h2osoi_ice(c,j+snl(c))</div>
<div class="line"><a id="l04589" name="l04589"></a><span class="lineno"> 4589</span>             swliq(c,j) = h2osoi_liq(c,j+snl(c))</div>
<div class="line"><a id="l04590" name="l04590"></a><span class="lineno"> 4590</span>             tsno(c,j)  = t_soisno(c,j+snl(c))</div>
<div class="line"><a id="l04591" name="l04591"></a><span class="lineno"> 4591</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04592" name="l04592"></a><span class="lineno"> 4592</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l04593" name="l04593"></a><span class="lineno"> 4593</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04594" name="l04594"></a><span class="lineno"> 4594</span> </div>
<div class="line"><a id="l04595" name="l04595"></a><span class="lineno"> 4595</span>    <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04596" name="l04596"></a><span class="lineno"> 4596</span>    <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04597" name="l04597"></a><span class="lineno"> 4597</span>    <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04598" name="l04598"></a><span class="lineno"> 4598</span>       c = filter_snowc(fc)</div>
<div class="line"><a id="l04599" name="l04599"></a><span class="lineno"> 4599</span> </div>
<div class="line"><a id="l04600" name="l04600"></a><span class="lineno"> 4600</span>       msno = abs(snl(c))</div>
<div class="line"><a id="l04601" name="l04601"></a><span class="lineno"> 4601</span> </div>
<div class="line"><a id="l04602" name="l04602"></a><span class="lineno"> 4602</span>       <span class="keywordflow">if</span> (msno == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04603" name="l04603"></a><span class="lineno"> 4603</span>          <span class="comment">! Specify a new snow layer</span></div>
<div class="line"><a id="l04604" name="l04604"></a><span class="lineno"> 4604</span>          <span class="keywordflow">if</span> (dzsno(c,1) &gt; 0.03) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04605" name="l04605"></a><span class="lineno"> 4605</span>             msno = 2</div>
<div class="line"><a id="l04606" name="l04606"></a><span class="lineno"> 4606</span>             dzsno(c,1) = dzsno(c,1)*0.5</div>
<div class="line"><a id="l04607" name="l04607"></a><span class="lineno"> 4607</span>             swice(c,1) = swice(c,1)*0.5</div>
<div class="line"><a id="l04608" name="l04608"></a><span class="lineno"> 4608</span>             swliq(c,1) = swliq(c,1)*0.5</div>
<div class="line"><a id="l04609" name="l04609"></a><span class="lineno"> 4609</span>             dzsno(c,2) = dzsno(c,1)</div>
<div class="line"><a id="l04610" name="l04610"></a><span class="lineno"> 4610</span>             swice(c,2) = swice(c,1)</div>
<div class="line"><a id="l04611" name="l04611"></a><span class="lineno"> 4611</span>             swliq(c,2) = swliq(c,1)</div>
<div class="line"><a id="l04612" name="l04612"></a><span class="lineno"> 4612</span>             tsno(c,2)  = tsno(c,1)</div>
<div class="line"><a id="l04613" name="l04613"></a><span class="lineno"> 4613</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04614" name="l04614"></a><span class="lineno"> 4614</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l04615" name="l04615"></a><span class="lineno"> 4615</span> </div>
<div class="line"><a id="l04616" name="l04616"></a><span class="lineno"> 4616</span>       <span class="keywordflow">if</span> (msno &gt; 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04617" name="l04617"></a><span class="lineno"> 4617</span>          <span class="keywordflow">if</span> (dzsno(c,1) &gt; 0.02) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04618" name="l04618"></a><span class="lineno"> 4618</span>             drr = dzsno(c,1) - 0.02</div>
<div class="line"><a id="l04619" name="l04619"></a><span class="lineno"> 4619</span>             propor = drr/dzsno(c,1)</div>
<div class="line"><a id="l04620" name="l04620"></a><span class="lineno"> 4620</span>             zwice = propor*swice(c,1)</div>
<div class="line"><a id="l04621" name="l04621"></a><span class="lineno"> 4621</span>             zwliq = propor*swliq(c,1)</div>
<div class="line"><a id="l04622" name="l04622"></a><span class="lineno"> 4622</span>             propor = 0.02/dzsno(c,1)</div>
<div class="line"><a id="l04623" name="l04623"></a><span class="lineno"> 4623</span>             swice(c,1) = propor*swice(c,1)</div>
<div class="line"><a id="l04624" name="l04624"></a><span class="lineno"> 4624</span>             swliq(c,1) = propor*swliq(c,1)</div>
<div class="line"><a id="l04625" name="l04625"></a><span class="lineno"> 4625</span>             dzsno(c,1) = 0.02</div>
<div class="line"><a id="l04626" name="l04626"></a><span class="lineno"> 4626</span> </div>
<div class="line"><a id="l04627" name="l04627"></a><span class="lineno"> 4627</span>             <span class="keyword">call </span><a class="code hl_function" href="group___noah_m_p___l_s_m_ga4804d8de40f7ea8a8cf4ed6e22ff4aa0.html#ga4804d8de40f7ea8a8cf4ed6e22ff4aa0">combo</a> (dzsno(c,2), swliq(c,2), swice(c,2), tsno(c,2), drr, &amp;</div>
<div class="line"><a id="l04628" name="l04628"></a><span class="lineno"> 4628</span>                  zwliq, zwice, tsno(c,1))</div>
<div class="line"><a id="l04629" name="l04629"></a><span class="lineno"> 4629</span> </div>
<div class="line"><a id="l04630" name="l04630"></a><span class="lineno"> 4630</span>             <span class="comment">! Subdivide a new layer</span></div>
<div class="line"><a id="l04631" name="l04631"></a><span class="lineno"> 4631</span>             <span class="keywordflow">if</span> (msno &lt;= 2 .and. dzsno(c,2) &gt; 0.07) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04632" name="l04632"></a><span class="lineno"> 4632</span>                msno = 3</div>
<div class="line"><a id="l04633" name="l04633"></a><span class="lineno"> 4633</span>                dzsno(c,2) = dzsno(c,2)*0.5</div>
<div class="line"><a id="l04634" name="l04634"></a><span class="lineno"> 4634</span>                swice(c,2) = swice(c,2)*0.5</div>
<div class="line"><a id="l04635" name="l04635"></a><span class="lineno"> 4635</span>                swliq(c,2) = swliq(c,2)*0.5</div>
<div class="line"><a id="l04636" name="l04636"></a><span class="lineno"> 4636</span>                dzsno(c,3) = dzsno(c,2)</div>
<div class="line"><a id="l04637" name="l04637"></a><span class="lineno"> 4637</span>                swice(c,3) = swice(c,2)</div>
<div class="line"><a id="l04638" name="l04638"></a><span class="lineno"> 4638</span>                swliq(c,3) = swliq(c,2)</div>
<div class="line"><a id="l04639" name="l04639"></a><span class="lineno"> 4639</span>                tsno(c,3)  = tsno(c,2)</div>
<div class="line"><a id="l04640" name="l04640"></a><span class="lineno"> 4640</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l04641" name="l04641"></a><span class="lineno"> 4641</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04642" name="l04642"></a><span class="lineno"> 4642</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l04643" name="l04643"></a><span class="lineno"> 4643</span> </div>
<div class="line"><a id="l04644" name="l04644"></a><span class="lineno"> 4644</span>       <span class="keywordflow">if</span> (msno &gt; 2) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04645" name="l04645"></a><span class="lineno"> 4645</span>          <span class="keywordflow">if</span> (dzsno(c,2) &gt; 0.05) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04646" name="l04646"></a><span class="lineno"> 4646</span>             drr = dzsno(c,2) - 0.05</div>
<div class="line"><a id="l04647" name="l04647"></a><span class="lineno"> 4647</span>             propor = drr/dzsno(c,2)</div>
<div class="line"><a id="l04648" name="l04648"></a><span class="lineno"> 4648</span>             zwice = propor*swice(c,2)</div>
<div class="line"><a id="l04649" name="l04649"></a><span class="lineno"> 4649</span>             zwliq = propor*swliq(c,2)</div>
<div class="line"><a id="l04650" name="l04650"></a><span class="lineno"> 4650</span>             propor = 0.05/dzsno(c,2)</div>
<div class="line"><a id="l04651" name="l04651"></a><span class="lineno"> 4651</span>             swice(c,2) = propor*swice(c,2)</div>
<div class="line"><a id="l04652" name="l04652"></a><span class="lineno"> 4652</span>             swliq(c,2) = propor*swliq(c,2)</div>
<div class="line"><a id="l04653" name="l04653"></a><span class="lineno"> 4653</span>             dzsno(c,2) = 0.05</div>
<div class="line"><a id="l04654" name="l04654"></a><span class="lineno"> 4654</span> </div>
<div class="line"><a id="l04655" name="l04655"></a><span class="lineno"> 4655</span>             <span class="keyword">call </span><a class="code hl_function" href="group___noah_m_p___l_s_m_ga4804d8de40f7ea8a8cf4ed6e22ff4aa0.html#ga4804d8de40f7ea8a8cf4ed6e22ff4aa0">combo</a> (dzsno(c,3), swliq(c,3), swice(c,3), tsno(c,3), drr, &amp;</div>
<div class="line"><a id="l04656" name="l04656"></a><span class="lineno"> 4656</span>                  zwliq, zwice, tsno(c,2))</div>
<div class="line"><a id="l04657" name="l04657"></a><span class="lineno"> 4657</span> </div>
<div class="line"><a id="l04658" name="l04658"></a><span class="lineno"> 4658</span>             <span class="comment">! Subdivided a new layer</span></div>
<div class="line"><a id="l04659" name="l04659"></a><span class="lineno"> 4659</span>             <span class="keywordflow">if</span> (msno &lt;= 3 .and. dzsno(c,3) &gt; 0.18) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04660" name="l04660"></a><span class="lineno"> 4660</span>                msno =  4</div>
<div class="line"><a id="l04661" name="l04661"></a><span class="lineno"> 4661</span>                dzsno(c,3) = dzsno(c,3)*0.5</div>
<div class="line"><a id="l04662" name="l04662"></a><span class="lineno"> 4662</span>                swice(c,3) = swice(c,3)*0.5</div>
<div class="line"><a id="l04663" name="l04663"></a><span class="lineno"> 4663</span>                swliq(c,3) = swliq(c,3)*0.5</div>
<div class="line"><a id="l04664" name="l04664"></a><span class="lineno"> 4664</span>                dzsno(c,4) = dzsno(c,3)</div>
<div class="line"><a id="l04665" name="l04665"></a><span class="lineno"> 4665</span>                swice(c,4) = swice(c,3)</div>
<div class="line"><a id="l04666" name="l04666"></a><span class="lineno"> 4666</span>                swliq(c,4) = swliq(c,3)</div>
<div class="line"><a id="l04667" name="l04667"></a><span class="lineno"> 4667</span>                tsno(c,4)  = tsno(c,3)</div>
<div class="line"><a id="l04668" name="l04668"></a><span class="lineno"> 4668</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l04669" name="l04669"></a><span class="lineno"> 4669</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04670" name="l04670"></a><span class="lineno"> 4670</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l04671" name="l04671"></a><span class="lineno"> 4671</span> </div>
<div class="line"><a id="l04672" name="l04672"></a><span class="lineno"> 4672</span>       <span class="keywordflow">if</span> (msno &gt; 3) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04673" name="l04673"></a><span class="lineno"> 4673</span>          <span class="keywordflow">if</span> (dzsno(c,3) &gt; 0.11) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04674" name="l04674"></a><span class="lineno"> 4674</span>             drr = dzsno(c,3) - 0.11</div>
<div class="line"><a id="l04675" name="l04675"></a><span class="lineno"> 4675</span>             propor = drr/dzsno(c,3)</div>
<div class="line"><a id="l04676" name="l04676"></a><span class="lineno"> 4676</span>             zwice = propor*swice(c,3)</div>
<div class="line"><a id="l04677" name="l04677"></a><span class="lineno"> 4677</span>             zwliq = propor*swliq(c,3)</div>
<div class="line"><a id="l04678" name="l04678"></a><span class="lineno"> 4678</span>             propor = 0.11/dzsno(c,3)</div>
<div class="line"><a id="l04679" name="l04679"></a><span class="lineno"> 4679</span>             swice(c,3) = propor*swice(c,3)</div>
<div class="line"><a id="l04680" name="l04680"></a><span class="lineno"> 4680</span>             swliq(c,3) = propor*swliq(c,3)</div>
<div class="line"><a id="l04681" name="l04681"></a><span class="lineno"> 4681</span>             dzsno(c,3) = 0.11</div>
<div class="line"><a id="l04682" name="l04682"></a><span class="lineno"> 4682</span> </div>
<div class="line"><a id="l04683" name="l04683"></a><span class="lineno"> 4683</span>             <span class="keyword">call </span><a class="code hl_function" href="group___noah_m_p___l_s_m_ga4804d8de40f7ea8a8cf4ed6e22ff4aa0.html#ga4804d8de40f7ea8a8cf4ed6e22ff4aa0">combo</a> (dzsno(c,4), swliq(c,4), swice(c,4), tsno(c,4), drr, &amp;</div>
<div class="line"><a id="l04684" name="l04684"></a><span class="lineno"> 4684</span>                  zwliq, zwice, tsno(c,3))</div>
<div class="line"><a id="l04685" name="l04685"></a><span class="lineno"> 4685</span> </div>
<div class="line"><a id="l04686" name="l04686"></a><span class="lineno"> 4686</span>             <span class="comment">! Subdivided a new layer</span></div>
<div class="line"><a id="l04687" name="l04687"></a><span class="lineno"> 4687</span>             <span class="keywordflow">if</span> (msno &lt;= 4 .and. dzsno(c,4) &gt; 0.41) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04688" name="l04688"></a><span class="lineno"> 4688</span>                msno = 5</div>
<div class="line"><a id="l04689" name="l04689"></a><span class="lineno"> 4689</span>                dzsno(c,4) = dzsno(c,4)*0.5</div>
<div class="line"><a id="l04690" name="l04690"></a><span class="lineno"> 4690</span>                swice(c,4) = swice(c,4)*0.5</div>
<div class="line"><a id="l04691" name="l04691"></a><span class="lineno"> 4691</span>                swliq(c,4) = swliq(c,4)*0.5</div>
<div class="line"><a id="l04692" name="l04692"></a><span class="lineno"> 4692</span>                dzsno(c,5) = dzsno(c,4)</div>
<div class="line"><a id="l04693" name="l04693"></a><span class="lineno"> 4693</span>                swice(c,5) = swice(c,4)</div>
<div class="line"><a id="l04694" name="l04694"></a><span class="lineno"> 4694</span>                swliq(c,5) = swliq(c,4)</div>
<div class="line"><a id="l04695" name="l04695"></a><span class="lineno"> 4695</span>                tsno(c,5)  = tsno(c,4)</div>
<div class="line"><a id="l04696" name="l04696"></a><span class="lineno"> 4696</span><span class="keywordflow">             end if</span></div>
<div class="line"><a id="l04697" name="l04697"></a><span class="lineno"> 4697</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04698" name="l04698"></a><span class="lineno"> 4698</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l04699" name="l04699"></a><span class="lineno"> 4699</span> </div>
<div class="line"><a id="l04700" name="l04700"></a><span class="lineno"> 4700</span>       <span class="keywordflow">if</span> (msno &gt; 4) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04701" name="l04701"></a><span class="lineno"> 4701</span>          <span class="keywordflow">if</span> (dzsno(c,4) &gt; 0.23) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04702" name="l04702"></a><span class="lineno"> 4702</span>             drr = dzsno(c,4) - 0.23</div>
<div class="line"><a id="l04703" name="l04703"></a><span class="lineno"> 4703</span>             propor = drr/dzsno(c,4)</div>
<div class="line"><a id="l04704" name="l04704"></a><span class="lineno"> 4704</span>             zwice = propor*swice(c,4)</div>
<div class="line"><a id="l04705" name="l04705"></a><span class="lineno"> 4705</span>             zwliq = propor*swliq(c,4)</div>
<div class="line"><a id="l04706" name="l04706"></a><span class="lineno"> 4706</span>             propor = 0.23/dzsno(c,4)</div>
<div class="line"><a id="l04707" name="l04707"></a><span class="lineno"> 4707</span>             swice(c,4) = propor*swice(c,4)</div>
<div class="line"><a id="l04708" name="l04708"></a><span class="lineno"> 4708</span>             swliq(c,4) = propor*swliq(c,4)</div>
<div class="line"><a id="l04709" name="l04709"></a><span class="lineno"> 4709</span>             dzsno(c,4) = 0.23</div>
<div class="line"><a id="l04710" name="l04710"></a><span class="lineno"> 4710</span> </div>
<div class="line"><a id="l04711" name="l04711"></a><span class="lineno"> 4711</span>             <span class="keyword">call </span><a class="code hl_function" href="group___noah_m_p___l_s_m_ga4804d8de40f7ea8a8cf4ed6e22ff4aa0.html#ga4804d8de40f7ea8a8cf4ed6e22ff4aa0">combo</a> (dzsno(c,5), swliq(c,5), swice(c,5), tsno(c,5), drr, &amp;</div>
<div class="line"><a id="l04712" name="l04712"></a><span class="lineno"> 4712</span>                  zwliq, zwice, tsno(c,4))</div>
<div class="line"><a id="l04713" name="l04713"></a><span class="lineno"> 4713</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04714" name="l04714"></a><span class="lineno"> 4714</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l04715" name="l04715"></a><span class="lineno"> 4715</span> </div>
<div class="line"><a id="l04716" name="l04716"></a><span class="lineno"> 4716</span>       snl(c) = -msno</div>
<div class="line"><a id="l04717" name="l04717"></a><span class="lineno"> 4717</span> </div>
<div class="line"><a id="l04718" name="l04718"></a><span class="lineno"> 4718</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04719" name="l04719"></a><span class="lineno"> 4719</span> </div>
<div class="line"><a id="l04720" name="l04720"></a><span class="lineno"> 4720</span>    <span class="keywordflow">do</span> j = -nlevsnow+1,0</div>
<div class="line"><a id="l04721" name="l04721"></a><span class="lineno"> 4721</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04722" name="l04722"></a><span class="lineno"> 4722</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04723" name="l04723"></a><span class="lineno"> 4723</span>       <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04724" name="l04724"></a><span class="lineno"> 4724</span>          c = filter_snowc(fc)</div>
<div class="line"><a id="l04725" name="l04725"></a><span class="lineno"> 4725</span>          <span class="keywordflow">if</span> (j &gt;= snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04726" name="l04726"></a><span class="lineno"> 4726</span>             dz(c,j)         = dzsno(c,j-snl(c))</div>
<div class="line"><a id="l04727" name="l04727"></a><span class="lineno"> 4727</span>             h2osoi_ice(c,j) = swice(c,j-snl(c))</div>
<div class="line"><a id="l04728" name="l04728"></a><span class="lineno"> 4728</span>             h2osoi_liq(c,j) = swliq(c,j-snl(c))</div>
<div class="line"><a id="l04729" name="l04729"></a><span class="lineno"> 4729</span>             t_soisno(c,j)   = tsno(c,j-snl(c))</div>
<div class="line"><a id="l04730" name="l04730"></a><span class="lineno"> 4730</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04731" name="l04731"></a><span class="lineno"> 4731</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l04732" name="l04732"></a><span class="lineno"> 4732</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04733" name="l04733"></a><span class="lineno"> 4733</span> </div>
<div class="line"><a id="l04734" name="l04734"></a><span class="lineno"> 4734</span>    <span class="keywordflow">do</span> j = 0, -nlevsnow+1, -1</div>
<div class="line"><a id="l04735" name="l04735"></a><span class="lineno"> 4735</span>      <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04736" name="l04736"></a><span class="lineno"> 4736</span>      <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04737" name="l04737"></a><span class="lineno"> 4737</span>       <span class="keywordflow">do</span> fc = 1, num_snowc</div>
<div class="line"><a id="l04738" name="l04738"></a><span class="lineno"> 4738</span>          c = filter_snowc(fc)</div>
<div class="line"><a id="l04739" name="l04739"></a><span class="lineno"> 4739</span>          <span class="keywordflow">if</span> (j &gt;= snl(c)+1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04740" name="l04740"></a><span class="lineno"> 4740</span>             z(c,j)    = zi(c,j) - 0.5*dz(c,j)</div>
<div class="line"><a id="l04741" name="l04741"></a><span class="lineno"> 4741</span>             zi(c,j-1) = zi(c,j) - dz(c,j)</div>
<div class="line"><a id="l04742" name="l04742"></a><span class="lineno"> 4742</span><span class="keywordflow">          end if</span></div>
<div class="line"><a id="l04743" name="l04743"></a><span class="lineno"> 4743</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l04744" name="l04744"></a><span class="lineno"> 4744</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04745" name="l04745"></a><span class="lineno"> 4745</span> </div>
</div>
<div class="line"><a id="l04746" name="l04746"></a><span class="lineno"> 4746</span>  <span class="keyword">end subroutine </span>dividesnowlayers</div>
<div class="line"><a id="l04747" name="l04747"></a><span class="lineno"> 4747</span><span class="comment"></span> </div>
<div class="line"><a id="l04748" name="l04748"></a><span class="lineno"> 4748</span><span class="comment">!&gt; Combines two elements and returns the following combined</span></div>
<div class="line"><a id="l04749" name="l04749"></a><span class="lineno"> 4749</span><span class="comment">!! variables: dz, t, wliq, wice.</span></div>
<div class="foldopen" id="foldopen04750" data-start="" data-end="">
<div class="line"><a id="l04750" name="l04750"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ab2c7929acc83c14dffda15a02c6ad9ff.html#ab2c7929acc83c14dffda15a02c6ad9ff"> 4750</a></span>  <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah_m_p___l_s_m_ga4804d8de40f7ea8a8cf4ed6e22ff4aa0.html#ga4804d8de40f7ea8a8cf4ed6e22ff4aa0">combo</a>(dz,  wliq,  wice, t, dz2, wliq2, wice2, t2)</div>
<div class="line"><a id="l04751" name="l04751"></a><span class="lineno"> 4751</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04752" name="l04752"></a><span class="lineno"> 4752</span>    <span class="comment">! DESCRIPTION:</span><span class="comment"></span></div>
<div class="line"><a id="l04753" name="l04753"></a><span class="lineno"> 4753</span><span class="comment">    !&gt; Combines two elements and returns the following combined</span></div>
<div class="line"><a id="l04754" name="l04754"></a><span class="lineno"> 4754</span><span class="comment">    !! variables: dz, t, wliq, wice.</span></div>
<div class="line"><a id="l04755" name="l04755"></a><span class="lineno"> 4755</span>    <span class="comment">! The combined temperature is based on the equation:</span></div>
<div class="line"><a id="l04756" name="l04756"></a><span class="lineno"> 4756</span>    <span class="comment">! the sum of the enthalpies of the two elements =</span></div>
<div class="line"><a id="l04757" name="l04757"></a><span class="lineno"> 4757</span>    <span class="comment">! that of the combined element.</span></div>
<div class="line"><a id="l04758" name="l04758"></a><span class="lineno"> 4758</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04759" name="l04759"></a><span class="lineno"> 4759</span>    <span class="comment">! !USES:</span></div>
<div class="line"><a id="l04760" name="l04760"></a><span class="lineno"> 4760</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04761" name="l04761"></a><span class="lineno"> 4761</span>    <span class="comment">! !ARGUMENTS:</span></div>
<div class="line"><a id="l04762" name="l04762"></a><span class="lineno"> 4762</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l04763" name="l04763"></a><span class="lineno"> 4763</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>    :: dz2<span class="comment">   !&lt; nodal thickness of 2 elements being combined [m]</span></div>
<div class="line"><a id="l04764" name="l04764"></a><span class="lineno"> 4764</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>    :: wliq2<span class="comment"> !&lt; liquid water of element 2 [kg/m2]</span></div>
<div class="line"><a id="l04765" name="l04765"></a><span class="lineno"> 4765</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>    :: wice2<span class="comment"> !&lt; ice of element 2 [kg/m2]</span></div>
<div class="line"><a id="l04766" name="l04766"></a><span class="lineno"> 4766</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>    :: t2<span class="comment">    !&lt; nodal temperature of element 2 [K]</span></div>
<div class="line"><a id="l04767" name="l04767"></a><span class="lineno"> 4767</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: dz<span class="comment">    !&lt; nodal thickness of 1 elements being combined [m]</span></div>
<div class="line"><a id="l04768" name="l04768"></a><span class="lineno"> 4768</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: wliq<span class="comment">  !&lt; liquid water of element 1</span></div>
<div class="line"><a id="l04769" name="l04769"></a><span class="lineno"> 4769</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: wice<span class="comment">  !&lt; ice of element 1 [kg/m2]</span></div>
<div class="line"><a id="l04770" name="l04770"></a><span class="lineno"> 4770</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: t<span class="comment">     !&lt; nodel temperature of elment 1 [K]</span></div>
<div class="line"><a id="l04771" name="l04771"></a><span class="lineno"> 4771</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04772" name="l04772"></a><span class="lineno"> 4772</span>    <span class="comment">! !CALLED FROM:</span></div>
<div class="line"><a id="l04773" name="l04773"></a><span class="lineno"> 4773</span>    <span class="comment">! subroutine CombineSnowLayers in this module</span></div>
<div class="line"><a id="l04774" name="l04774"></a><span class="lineno"> 4774</span>    <span class="comment">! subroutine DivideSnowLayers in this module</span></div>
<div class="line"><a id="l04775" name="l04775"></a><span class="lineno"> 4775</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04776" name="l04776"></a><span class="lineno"> 4776</span>    <span class="comment">! !REVISION HISTORY:</span></div>
<div class="line"><a id="l04777" name="l04777"></a><span class="lineno"> 4777</span>    <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l04778" name="l04778"></a><span class="lineno"> 4778</span>    <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l04779" name="l04779"></a><span class="lineno"> 4779</span>    <span class="comment">! June 2022: Sam Trahan; modified for CCPP</span></div>
<div class="line"><a id="l04780" name="l04780"></a><span class="lineno"> 4780</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04781" name="l04781"></a><span class="lineno"> 4781</span>    <span class="comment">!EOP</span></div>
<div class="line"><a id="l04782" name="l04782"></a><span class="lineno"> 4782</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04783" name="l04783"></a><span class="lineno"> 4783</span>    <span class="comment">! !LOCAL VARIABLES:</span></div>
<div class="line"><a id="l04784" name="l04784"></a><span class="lineno"> 4784</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04785" name="l04785"></a><span class="lineno"> 4785</span><span class="keywordtype">    real</span>(kind_lake) :: dzc   <span class="comment">! Total thickness of nodes 1 and 2 (dzc=dz+dz2).</span></div>
<div class="line"><a id="l04786" name="l04786"></a><span class="lineno"> 4786</span><span class="keywordtype">    real</span>(kind_lake) :: wliqc <span class="comment">! Combined liquid water [kg/m2]</span></div>
<div class="line"><a id="l04787" name="l04787"></a><span class="lineno"> 4787</span><span class="keywordtype">    real</span>(kind_lake) :: wicec <span class="comment">! Combined ice [kg/m2]</span></div>
<div class="line"><a id="l04788" name="l04788"></a><span class="lineno"> 4788</span><span class="keywordtype">    real</span>(kind_lake) :: tc    <span class="comment">! Combined node temperature [K]</span></div>
<div class="line"><a id="l04789" name="l04789"></a><span class="lineno"> 4789</span><span class="keywordtype">    real</span>(kind_lake) :: h     <span class="comment">! enthalpy of element 1 [J/m2]</span></div>
<div class="line"><a id="l04790" name="l04790"></a><span class="lineno"> 4790</span><span class="keywordtype">    real</span>(kind_lake) :: h2    <span class="comment">! enthalpy of element 2 [J/m2]</span></div>
<div class="line"><a id="l04791" name="l04791"></a><span class="lineno"> 4791</span><span class="keywordtype">    real</span>(kind_lake) :: hc    <span class="comment">! temporary</span></div>
<div class="line"><a id="l04792" name="l04792"></a><span class="lineno"> 4792</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04793" name="l04793"></a><span class="lineno"> 4793</span> </div>
<div class="line"><a id="l04794" name="l04794"></a><span class="lineno"> 4794</span>    dzc = dz+dz2</div>
<div class="line"><a id="l04795" name="l04795"></a><span class="lineno"> 4795</span>    wicec = (wice+wice2)</div>
<div class="line"><a id="l04796" name="l04796"></a><span class="lineno"> 4796</span>    wliqc = (wliq+wliq2)</div>
<div class="line"><a id="l04797" name="l04797"></a><span class="lineno"> 4797</span>    h = (cpice*wice+cpliq*wliq) * (t-tfrz)+hfus*wliq</div>
<div class="line"><a id="l04798" name="l04798"></a><span class="lineno"> 4798</span>    h2= (cpice*wice2+cpliq*wliq2) * (t2-tfrz)+hfus*wliq2</div>
<div class="line"><a id="l04799" name="l04799"></a><span class="lineno"> 4799</span> </div>
<div class="line"><a id="l04800" name="l04800"></a><span class="lineno"> 4800</span>    hc = h + h2</div>
<div class="line"><a id="l04801" name="l04801"></a><span class="lineno"> 4801</span>    <span class="keywordflow">if</span>(hc &lt; 0.)<span class="keywordflow">then</span></div>
<div class="line"><a id="l04802" name="l04802"></a><span class="lineno"> 4802</span>       tc = tfrz + hc/(cpice*wicec + cpliq*wliqc)</div>
<div class="line"><a id="l04803" name="l04803"></a><span class="lineno"> 4803</span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hc.le.hfus*wliqc) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04804" name="l04804"></a><span class="lineno"> 4804</span>       tc = tfrz</div>
<div class="line"><a id="l04805" name="l04805"></a><span class="lineno"> 4805</span>    <span class="keywordflow">else</span></div>
<div class="line"><a id="l04806" name="l04806"></a><span class="lineno"> 4806</span>       tc = tfrz + (hc - hfus*wliqc) / (cpice*wicec + cpliq*wliqc)</div>
<div class="line"><a id="l04807" name="l04807"></a><span class="lineno"> 4807</span><span class="keywordflow">    end if</span></div>
<div class="line"><a id="l04808" name="l04808"></a><span class="lineno"> 4808</span> </div>
<div class="line"><a id="l04809" name="l04809"></a><span class="lineno"> 4809</span>    dz = dzc</div>
<div class="line"><a id="l04810" name="l04810"></a><span class="lineno"> 4810</span>    wice = wicec</div>
<div class="line"><a id="l04811" name="l04811"></a><span class="lineno"> 4811</span>    wliq = wliqc</div>
<div class="line"><a id="l04812" name="l04812"></a><span class="lineno"> 4812</span>    t = tc</div>
<div class="line"><a id="l04813" name="l04813"></a><span class="lineno"> 4813</span> </div>
</div>
<div class="line"><a id="l04814" name="l04814"></a><span class="lineno"> 4814</span>  <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah_m_p___l_s_m_ga4804d8de40f7ea8a8cf4ed6e22ff4aa0.html#ga4804d8de40f7ea8a8cf4ed6e22ff4aa0">combo</a></div>
<div class="line"><a id="l04815" name="l04815"></a><span class="lineno"> 4815</span><span class="comment"></span> </div>
<div class="line"><a id="l04816" name="l04816"></a><span class="lineno"> 4816</span><span class="comment">!&gt; Constructs snow filter for use in vectorized loops for snow hydrology.</span></div>
<div class="foldopen" id="foldopen04817" data-start="" data-end="">
<div class="line"><a id="l04817" name="l04817"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ae4e6f20236e7a2ac042d8886b118dcc5.html#ae4e6f20236e7a2ac042d8886b118dcc5"> 4817</a></span>  <span class="keyword">subroutine </span>buildsnowfilter(lbc, ubc, num_nolakec, filter_nolakec,snl, &amp; !i</div>
<div class="line"><a id="l04818" name="l04818"></a><span class="lineno"> 4818</span>                             num_snowc, filter_snowc, &amp;                   !o</div>
<div class="line"><a id="l04819" name="l04819"></a><span class="lineno"> 4819</span>                             num_nosnowc, filter_nosnowc)                 <span class="comment">!o</span></div>
<div class="line"><a id="l04820" name="l04820"></a><span class="lineno"> 4820</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04821" name="l04821"></a><span class="lineno"> 4821</span>    <span class="comment">! DESCRIPTION:</span><span class="comment"></span></div>
<div class="line"><a id="l04822" name="l04822"></a><span class="lineno"> 4822</span><span class="comment">    !&gt; Constructs snow filter for use in vectorized loops for snow hydrology.</span></div>
<div class="line"><a id="l04823" name="l04823"></a><span class="lineno"> 4823</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04824" name="l04824"></a><span class="lineno"> 4824</span>    <span class="comment">! !USES:</span></div>
<div class="line"><a id="l04825" name="l04825"></a><span class="lineno"> 4825</span>    <span class="comment">!    use clmtype</span></div>
<div class="line"><a id="l04826" name="l04826"></a><span class="lineno"> 4826</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04827" name="l04827"></a><span class="lineno"> 4827</span>    <span class="comment">! !ARGUMENTS:</span></div>
<div class="line"><a id="l04828" name="l04828"></a><span class="lineno"> 4828</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l04829" name="l04829"></a><span class="lineno"> 4829</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span>  :: lbc, ubc<span class="comment">                    !&lt; column bounds</span></div>
<div class="line"><a id="l04830" name="l04830"></a><span class="lineno"> 4830</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span>  :: num_nolakec<span class="comment">                 !&lt; number of column non-lake points in column filter</span></div>
<div class="line"><a id="l04831" name="l04831"></a><span class="lineno"> 4831</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span>  :: filter_nolakec(ubc-lbc+1)<span class="comment">   !&lt; column filter for non-lake points</span></div>
<div class="line"><a id="l04832" name="l04832"></a><span class="lineno"> 4832</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span>  :: snl(1)<span class="comment">                        !&lt; number of snow layers</span></div>
<div class="line"><a id="l04833" name="l04833"></a><span class="lineno"> 4833</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(out)</span> :: num_snowc<span class="comment">                   !&lt; number of column snow points in column filter</span></div>
<div class="line"><a id="l04834" name="l04834"></a><span class="lineno"> 4834</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(out)</span> :: filter_snowc(ubc-lbc+1)<span class="comment">     !&lt; column filter for snow points</span></div>
<div class="line"><a id="l04835" name="l04835"></a><span class="lineno"> 4835</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(out)</span> :: num_nosnowc<span class="comment">                 !&lt; number of column non-snow points in column filter</span></div>
<div class="line"><a id="l04836" name="l04836"></a><span class="lineno"> 4836</span>    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(out)</span> :: filter_nosnowc(ubc-lbc+1)<span class="comment">   !&lt; column filter for non-snow points</span></div>
<div class="line"><a id="l04837" name="l04837"></a><span class="lineno"> 4837</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04838" name="l04838"></a><span class="lineno"> 4838</span>    <span class="comment">! !CALLED FROM:</span></div>
<div class="line"><a id="l04839" name="l04839"></a><span class="lineno"> 4839</span>    <span class="comment">! subroutine Hydrology2 in Hydrology2Mod</span></div>
<div class="line"><a id="l04840" name="l04840"></a><span class="lineno"> 4840</span>    <span class="comment">! subroutine CombineSnowLayers in this module</span></div>
<div class="line"><a id="l04841" name="l04841"></a><span class="lineno"> 4841</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04842" name="l04842"></a><span class="lineno"> 4842</span>    <span class="comment">! !REVISION HISTORY:</span></div>
<div class="line"><a id="l04843" name="l04843"></a><span class="lineno"> 4843</span>    <span class="comment">! 2003 July 31: Forrest Hoffman</span></div>
<div class="line"><a id="l04844" name="l04844"></a><span class="lineno"> 4844</span>    <span class="comment">! 2022 June: Sam Trahan modified for CCPP</span></div>
<div class="line"><a id="l04845" name="l04845"></a><span class="lineno"> 4845</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04846" name="l04846"></a><span class="lineno"> 4846</span>    <span class="comment">! !LOCAL VARIABLES:</span></div>
<div class="line"><a id="l04847" name="l04847"></a><span class="lineno"> 4847</span>    <span class="comment">! local pointers to implicit in arguments</span></div>
<div class="line"><a id="l04848" name="l04848"></a><span class="lineno"> 4848</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04849" name="l04849"></a><span class="lineno"> 4849</span>    <span class="comment">!EOP</span></div>
<div class="line"><a id="l04850" name="l04850"></a><span class="lineno"> 4850</span>    <span class="comment">!</span></div>
<div class="line"><a id="l04851" name="l04851"></a><span class="lineno"> 4851</span>    <span class="comment">! !OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l04852" name="l04852"></a><span class="lineno"> 4852</span>    <span class="keywordtype">integer</span>  :: fc, c</div>
<div class="line"><a id="l04853" name="l04853"></a><span class="lineno"> 4853</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l04854" name="l04854"></a><span class="lineno"> 4854</span> </div>
<div class="line"><a id="l04855" name="l04855"></a><span class="lineno"> 4855</span> </div>
<div class="line"><a id="l04856" name="l04856"></a><span class="lineno"> 4856</span>    <span class="comment">! Build snow/no-snow filters for other subroutines</span></div>
<div class="line"><a id="l04857" name="l04857"></a><span class="lineno"> 4857</span> </div>
<div class="line"><a id="l04858" name="l04858"></a><span class="lineno"> 4858</span>    num_snowc = 0</div>
<div class="line"><a id="l04859" name="l04859"></a><span class="lineno"> 4859</span>    num_nosnowc = 0</div>
<div class="line"><a id="l04860" name="l04860"></a><span class="lineno"> 4860</span>    <span class="keywordflow">do</span> fc = 1, num_nolakec</div>
<div class="line"><a id="l04861" name="l04861"></a><span class="lineno"> 4861</span>       c = filter_nolakec(fc)</div>
<div class="line"><a id="l04862" name="l04862"></a><span class="lineno"> 4862</span>       <span class="keywordflow">if</span> (snl(c) &lt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04863" name="l04863"></a><span class="lineno"> 4863</span>          num_snowc = num_snowc + 1</div>
<div class="line"><a id="l04864" name="l04864"></a><span class="lineno"> 4864</span>          filter_snowc(num_snowc) = c</div>
<div class="line"><a id="l04865" name="l04865"></a><span class="lineno"> 4865</span>       <span class="keywordflow">else</span></div>
<div class="line"><a id="l04866" name="l04866"></a><span class="lineno"> 4866</span>          num_nosnowc = num_nosnowc + 1</div>
<div class="line"><a id="l04867" name="l04867"></a><span class="lineno"> 4867</span>          filter_nosnowc(num_nosnowc) = c</div>
<div class="line"><a id="l04868" name="l04868"></a><span class="lineno"> 4868</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l04869" name="l04869"></a><span class="lineno"> 4869</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l04870" name="l04870"></a><span class="lineno"> 4870</span> </div>
</div>
<div class="line"><a id="l04871" name="l04871"></a><span class="lineno"> 4871</span>  <span class="keyword">end subroutine </span>buildsnowfilter</div>
<div class="line"><a id="l04872" name="l04872"></a><span class="lineno"> 4872</span> </div>
<div class="line"><a id="l04873" name="l04873"></a><span class="lineno"> 4873</span> </div>
<div class="line"><a id="l04874" name="l04874"></a><span class="lineno"> 4874</span>  <span class="comment">! DESCRIPTION:               </span><span class="comment"></span></div>
<div class="line"><a id="l04875" name="l04875"></a><span class="lineno"> 4875</span><span class="comment">  !&gt; Calculation of the friction velocity, relation for potential</span></div>
<div class="line"><a id="l04876" name="l04876"></a><span class="lineno"> 4876</span><span class="comment">  !! temperature and humidity profiles of surface boundary layer.                </span></div>
<div class="line"><a id="l04877" name="l04877"></a><span class="lineno"> 4877</span><span class="comment">  !! The scheme is based on the work of Zeng et al. (1998):</span></div>
<div class="line"><a id="l04878" name="l04878"></a><span class="lineno"> 4878</span><span class="comment">  !! Intercomparison of bulk aerodynamic algorithms for the computation</span></div>
<div class="line"><a id="l04879" name="l04879"></a><span class="lineno"> 4879</span><span class="comment">  !! of sea surface fluxes using TOGA CORE and TAO data. J. Climate,</span></div>
<div class="line"><a id="l04880" name="l04880"></a><span class="lineno"> 4880</span><span class="comment">  !! Vol. 11, 2628-2644.       </span></div>
<div class="foldopen" id="foldopen04881" data-start="" data-end="">
<div class="line"><a id="l04881" name="l04881"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a3987b565385d60cb04d81ca3177463d6.html#a3987b565385d60cb04d81ca3177463d6"> 4881</a></span><span class="keyword">subroutine </span>frictionvelocity(pgridcell,forc_hgt,forc_hgt_u,        &amp; !i </div>
<div class="line"><a id="l04882" name="l04882"></a><span class="lineno"> 4882</span>                             forc_hgt_t,forc_hgt_q,                  &amp; !i </div>
<div class="line"><a id="l04883" name="l04883"></a><span class="lineno"> 4883</span>                             lbp, ubp, fn, filterp,                  &amp; !i </div>
<div class="line"><a id="l04884" name="l04884"></a><span class="lineno"> 4884</span>                             displa, z0m, z0h, z0q,                  &amp; !i </div>
<div class="line"><a id="l04885" name="l04885"></a><span class="lineno"> 4885</span>                             obu, iter, ur, um,                      &amp; !i </div>
<div class="line"><a id="l04886" name="l04886"></a><span class="lineno"> 4886</span>                             ustar,temp1, temp2, temp12m, temp22m,   &amp; !o </div>
<div class="line"><a id="l04887" name="l04887"></a><span class="lineno"> 4887</span>                             u10,fv,                                 &amp; !o </div>
<div class="line"><a id="l04888" name="l04888"></a><span class="lineno"> 4888</span>                             fm)  <span class="comment">!i&amp;o </span></div>
<div class="line"><a id="l04889" name="l04889"></a><span class="lineno"> 4889</span> </div>
<div class="line"><a id="l04890" name="l04890"></a><span class="lineno"> 4890</span>  <span class="comment">!=============================================================================</span></div>
<div class="line"><a id="l04891" name="l04891"></a><span class="lineno"> 4891</span>  <span class="comment">! REVISION HISTORY:</span></div>
<div class="line"><a id="l04892" name="l04892"></a><span class="lineno"> 4892</span>  <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l04893" name="l04893"></a><span class="lineno"> 4893</span>  <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l04894" name="l04894"></a><span class="lineno"> 4894</span>  <span class="comment">! 12/19/01, Peter Thornton</span></div>
<div class="line"><a id="l04895" name="l04895"></a><span class="lineno"> 4895</span>  <span class="comment">! Added arguments to eliminate passing clm derived type into this function.</span></div>
<div class="line"><a id="l04896" name="l04896"></a><span class="lineno"> 4896</span>  <span class="comment">! Created by Mariana Vertenstein</span></div>
<div class="line"><a id="l04897" name="l04897"></a><span class="lineno"> 4897</span>  <span class="comment">! June 2022: Sam Trahan modified for CCPP</span></div>
<div class="line"><a id="l04898" name="l04898"></a><span class="lineno"> 4898</span>  <span class="comment">!============================================================================</span></div>
<div class="line"><a id="l04899" name="l04899"></a><span class="lineno"> 4899</span>  <span class="comment">! !USES:</span></div>
<div class="line"><a id="l04900" name="l04900"></a><span class="lineno"> 4900</span>  <span class="comment">! use clmtype</span></div>
<div class="line"><a id="l04901" name="l04901"></a><span class="lineno"> 4901</span>  <span class="comment">!!use clm_atmlnd, only : clm_a2l</span></div>
<div class="line"><a id="l04902" name="l04902"></a><span class="lineno"> 4902</span>  <span class="comment">!</span></div>
<div class="line"><a id="l04903" name="l04903"></a><span class="lineno"> 4903</span>  <span class="comment">! !ARGUMENTS:</span></div>
<div class="line"><a id="l04904" name="l04904"></a><span class="lineno"> 4904</span>  <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l04905" name="l04905"></a><span class="lineno"> 4905</span> </div>
<div class="line"><a id="l04906" name="l04906"></a><span class="lineno"> 4906</span>  <span class="comment">!in:</span></div>
<div class="line"><a id="l04907" name="l04907"></a><span class="lineno"> 4907</span> </div>
<div class="line"><a id="l04908" name="l04908"></a><span class="lineno"> 4908</span>   <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span> :: pgridcell(1)<span class="comment">   !&lt; pft&#39;s gridcell index</span></div>
<div class="line"><a id="l04909" name="l04909"></a><span class="lineno"> 4909</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: forc_hgt(1)<span class="comment">    !&lt; atmospheric reference height (m)</span></div>
<div class="line"><a id="l04910" name="l04910"></a><span class="lineno"> 4910</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: forc_hgt_u(1)<span class="comment">  !&lt; observational height of wind [m]</span></div>
<div class="line"><a id="l04911" name="l04911"></a><span class="lineno"> 4911</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: forc_hgt_t(1)<span class="comment">  !&lt; observational height of temperature [m]</span></div>
<div class="line"><a id="l04912" name="l04912"></a><span class="lineno"> 4912</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: forc_hgt_q(1)<span class="comment">  !&lt; observational height of humidity [m]</span></div>
<div class="line"><a id="l04913" name="l04913"></a><span class="lineno"> 4913</span>   <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span>  :: lbp, ubp<span class="comment">         !&lt; pft array bounds</span></div>
<div class="line"><a id="l04914" name="l04914"></a><span class="lineno"> 4914</span>   <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span>  :: fn<span class="comment">               !&lt; number of filtered pft elements</span></div>
<div class="line"><a id="l04915" name="l04915"></a><span class="lineno"> 4915</span>   <span class="keywordtype">integer</span> , <span class="keywordtype">intent(in)</span>  :: filterp(fn)<span class="comment">      !&lt; pft filter</span></div>
<div class="line"><a id="l04916" name="l04916"></a><span class="lineno"> 4916</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: displa(lbp:ubp)<span class="comment">  !&lt; displacement height (m)</span></div>
<div class="line"><a id="l04917" name="l04917"></a><span class="lineno"> 4917</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: z0m(lbp:ubp)<span class="comment">     !&lt; roughness length over vegetation, momentum [m]</span></div>
<div class="line"><a id="l04918" name="l04918"></a><span class="lineno"> 4918</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: z0h(lbp:ubp)<span class="comment">     !&lt; roughness length over vegetation, sensible heat [m]</span></div>
<div class="line"><a id="l04919" name="l04919"></a><span class="lineno"> 4919</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: z0q(lbp:ubp)<span class="comment">     !&lt; roughness length over vegetation, latent heat [m]</span></div>
<div class="line"><a id="l04920" name="l04920"></a><span class="lineno"> 4920</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: obu(lbp:ubp)<span class="comment">     !&lt; monin-obukhov length (m)</span></div>
<div class="line"><a id="l04921" name="l04921"></a><span class="lineno"> 4921</span>   <span class="keywordtype">integer</span>,  <span class="keywordtype">intent(in)</span>  :: iter<span class="comment">             !&lt; iteration number</span></div>
<div class="line"><a id="l04922" name="l04922"></a><span class="lineno"> 4922</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: ur(lbp:ubp)<span class="comment">      !&lt; wind speed at reference height [m/s]</span></div>
<div class="line"><a id="l04923" name="l04923"></a><span class="lineno"> 4923</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: um(lbp:ubp)<span class="comment">      !&lt; wind speed including the stablity effect [m/s]</span></div>
<div class="line"><a id="l04924" name="l04924"></a><span class="lineno"> 4924</span> </div>
<div class="line"><a id="l04925" name="l04925"></a><span class="lineno"> 4925</span>   <span class="comment">!out:</span></div>
<div class="line"><a id="l04926" name="l04926"></a><span class="lineno"> 4926</span> </div>
<div class="line"><a id="l04927" name="l04927"></a><span class="lineno"> 4927</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: ustar(lbp:ubp)<span class="comment">   !&lt; friction velocity [m/s]</span></div>
<div class="line"><a id="l04928" name="l04928"></a><span class="lineno"> 4928</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: temp1(lbp:ubp)<span class="comment">   !&lt; relation for potential temperature profile</span></div>
<div class="line"><a id="l04929" name="l04929"></a><span class="lineno"> 4929</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: temp12m(lbp:ubp)<span class="comment"> !&lt; relation for potential temperature profile applied at 2-m</span></div>
<div class="line"><a id="l04930" name="l04930"></a><span class="lineno"> 4930</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: temp2(lbp:ubp)<span class="comment">   !&lt; relation for specific humidity profile</span></div>
<div class="line"><a id="l04931" name="l04931"></a><span class="lineno"> 4931</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: temp22m(lbp:ubp)<span class="comment"> !&lt; relation for specific humidity profile applied at 2-m</span></div>
<div class="line"><a id="l04932" name="l04932"></a><span class="lineno"> 4932</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: u10(1)<span class="comment">         !&lt; 10-m wind (m/s) (for dust model)</span></div>
<div class="line"><a id="l04933" name="l04933"></a><span class="lineno"> 4933</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: fv(1)<span class="comment">          !&lt; friction velocity (m/s) (for dust model)</span></div>
<div class="line"><a id="l04934" name="l04934"></a><span class="lineno"> 4934</span> </div>
<div class="line"><a id="l04935" name="l04935"></a><span class="lineno"> 4935</span>   <span class="comment">!inout:</span></div>
<div class="line"><a id="l04936" name="l04936"></a><span class="lineno"> 4936</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">intent(inout)</span> :: fm(lbp:ubp)<span class="comment">    !&lt; needed for DGVM only to diagnose 10m wind</span></div>
<div class="line"><a id="l04937" name="l04937"></a><span class="lineno"> 4937</span> </div>
<div class="line"><a id="l04938" name="l04938"></a><span class="lineno"> 4938</span>   <span class="comment">! OTHER LOCAL VARIABLES:</span></div>
<div class="line"><a id="l04939" name="l04939"></a><span class="lineno"> 4939</span> </div>
<div class="line"><a id="l04940" name="l04940"></a><span class="lineno"> 4940</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">parameter</span> :: zetam = 1.574_kind_lake <span class="comment">! transition point of flux-gradient relation (wind profile)</span></div>
<div class="line"><a id="l04941" name="l04941"></a><span class="lineno"> 4941</span><span class="keywordtype">   real</span>(kind_lake), <span class="keywordtype">parameter</span> :: zetat = 0.465_kind_lake <span class="comment">! transition point of flux-gradient relation (temp. profile)</span></div>
<div class="line"><a id="l04942" name="l04942"></a><span class="lineno"> 4942</span>   <span class="keywordtype">integer</span> :: f                         <span class="comment">! pft-filter index</span></div>
<div class="line"><a id="l04943" name="l04943"></a><span class="lineno"> 4943</span>   <span class="keywordtype">integer</span> :: p                         <span class="comment">! pft index</span></div>
<div class="line"><a id="l04944" name="l04944"></a><span class="lineno"> 4944</span>   <span class="keywordtype">integer</span> :: g                         <span class="comment">! gridcell index</span></div>
<div class="line"><a id="l04945" name="l04945"></a><span class="lineno"> 4945</span><span class="keywordtype">   real</span>(kind_lake):: zldis(lbp:ubp)            <span class="comment">! reference height &quot;minus&quot; zero displacement heght [m]</span></div>
<div class="line"><a id="l04946" name="l04946"></a><span class="lineno"> 4946</span><span class="keywordtype">   real</span>(kind_lake):: zeta(lbp:ubp)             <span class="comment">! dimensionless height used in Monin-Obukhov theory</span></div>
<div class="line"><a id="l04947" name="l04947"></a><span class="lineno"> 4947</span> </div>
<div class="line"><a id="l04948" name="l04948"></a><span class="lineno"> 4948</span>   <span class="comment">!------------------------------------------------------------------------------</span></div>
<div class="line"><a id="l04949" name="l04949"></a><span class="lineno"> 4949</span> </div>
<div class="line"><a id="l04950" name="l04950"></a><span class="lineno"> 4950</span> </div>
<div class="line"><a id="l04951" name="l04951"></a><span class="lineno"> 4951</span>   <span class="comment">! Adjustment factors for unstable (moz &lt; 0) or stable (moz &gt; 0) conditions.</span></div>
<div class="line"><a id="l04952" name="l04952"></a><span class="lineno"> 4952</span> </div>
<div class="line"><a id="l04953" name="l04953"></a><span class="lineno"> 4953</span>   if_not_pergro: <span class="keywordflow">if</span>(.not.pergro) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04954" name="l04954"></a><span class="lineno"> 4954</span> </div>
<div class="line"><a id="l04955" name="l04955"></a><span class="lineno"> 4955</span>   <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l04956" name="l04956"></a><span class="lineno"> 4956</span>   <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l04957" name="l04957"></a><span class="lineno"> 4957</span>   <span class="keywordflow">do</span> f = 1, fn</div>
<div class="line"><a id="l04958" name="l04958"></a><span class="lineno"> 4958</span>      p = filterp(f)</div>
<div class="line"><a id="l04959" name="l04959"></a><span class="lineno"> 4959</span>      g = pgridcell(p)</div>
<div class="line"><a id="l04960" name="l04960"></a><span class="lineno"> 4960</span> </div>
<div class="line"><a id="l04961" name="l04961"></a><span class="lineno"> 4961</span>      <span class="comment">! Wind profile</span></div>
<div class="line"><a id="l04962" name="l04962"></a><span class="lineno"> 4962</span> </div>
<div class="line"><a id="l04963" name="l04963"></a><span class="lineno"> 4963</span>      zldis(p) = forc_hgt_u(g)-displa(p)</div>
<div class="line"><a id="l04964" name="l04964"></a><span class="lineno"> 4964</span>      zeta(p) = zldis(p)/obu(p)</div>
<div class="line"><a id="l04965" name="l04965"></a><span class="lineno"> 4965</span>      <span class="keywordflow">if</span> (zeta(p) &lt; -zetam) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04966" name="l04966"></a><span class="lineno"> 4966</span>         ustar(p) = vkc*um(p)/(log(-zetam*obu(p)/z0m(p))&amp;</div>
<div class="line"><a id="l04967" name="l04967"></a><span class="lineno"> 4967</span>              - stabilityfunc1(-zetam) &amp;</div>
<div class="line"><a id="l04968" name="l04968"></a><span class="lineno"> 4968</span>              + stabilityfunc1(z0m(p)/obu(p)) &amp;</div>
<div class="line"><a id="l04969" name="l04969"></a><span class="lineno"> 4969</span>              + 1.14_kind_lake*((-zeta(p))**0.333_kind_lake-(zetam)**0.333_kind_lake))</div>
<div class="line"><a id="l04970" name="l04970"></a><span class="lineno"> 4970</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04971" name="l04971"></a><span class="lineno"> 4971</span>         ustar(p) = vkc*um(p)/(log(zldis(p)/z0m(p))&amp;</div>
<div class="line"><a id="l04972" name="l04972"></a><span class="lineno"> 4972</span>              - stabilityfunc1(zeta(p))&amp;</div>
<div class="line"><a id="l04973" name="l04973"></a><span class="lineno"> 4973</span>              + stabilityfunc1(z0m(p)/obu(p)))</div>
<div class="line"><a id="l04974" name="l04974"></a><span class="lineno"> 4974</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt;=  1._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04975" name="l04975"></a><span class="lineno"> 4975</span>         ustar(p) = vkc*um(p)/(log(zldis(p)/z0m(p)) + 5._kind_lake*zeta(p) -5._kind_lake*z0m(p)/obu(p))</div>
<div class="line"><a id="l04976" name="l04976"></a><span class="lineno"> 4976</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l04977" name="l04977"></a><span class="lineno"> 4977</span>         ustar(p) = vkc*um(p)/(log(obu(p)/z0m(p))+5._kind_lake-5._kind_lake*z0m(p)/obu(p) &amp;</div>
<div class="line"><a id="l04978" name="l04978"></a><span class="lineno"> 4978</span>              +(5._kind_lake*log(zeta(p))+zeta(p)-1._kind_lake))</div>
<div class="line"><a id="l04979" name="l04979"></a><span class="lineno"> 4979</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l04980" name="l04980"></a><span class="lineno"> 4980</span> </div>
<div class="line"><a id="l04981" name="l04981"></a><span class="lineno"> 4981</span>      <span class="comment">! Temperature profile</span></div>
<div class="line"><a id="l04982" name="l04982"></a><span class="lineno"> 4982</span> </div>
<div class="line"><a id="l04983" name="l04983"></a><span class="lineno"> 4983</span>      zldis(p) = forc_hgt_t(g)-displa(p)</div>
<div class="line"><a id="l04984" name="l04984"></a><span class="lineno"> 4984</span>      zeta(p) = zldis(p)/obu(p)</div>
<div class="line"><a id="l04985" name="l04985"></a><span class="lineno"> 4985</span>      <span class="keywordflow">if</span> (zeta(p) &lt; -zetat) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04986" name="l04986"></a><span class="lineno"> 4986</span>         temp1(p) = vkc/(log(-zetat*obu(p)/z0h(p))&amp;</div>
<div class="line"><a id="l04987" name="l04987"></a><span class="lineno"> 4987</span>              - stabilityfunc2(-zetat) &amp;</div>
<div class="line"><a id="l04988" name="l04988"></a><span class="lineno"> 4988</span>              + stabilityfunc2(z0h(p)/obu(p)) &amp;</div>
<div class="line"><a id="l04989" name="l04989"></a><span class="lineno"> 4989</span>              + 0.8_kind_lake*((zetat)**(-0.333_kind_lake)-(-zeta(p))**(-0.333_kind_lake)))</div>
<div class="line"><a id="l04990" name="l04990"></a><span class="lineno"> 4990</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04991" name="l04991"></a><span class="lineno"> 4991</span>         temp1(p) = vkc/(log(zldis(p)/z0h(p)) &amp;</div>
<div class="line"><a id="l04992" name="l04992"></a><span class="lineno"> 4992</span>              - stabilityfunc2(zeta(p)) &amp;</div>
<div class="line"><a id="l04993" name="l04993"></a><span class="lineno"> 4993</span>              + stabilityfunc2(z0h(p)/obu(p)))</div>
<div class="line"><a id="l04994" name="l04994"></a><span class="lineno"> 4994</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt;=  1._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04995" name="l04995"></a><span class="lineno"> 4995</span>         temp1(p) = vkc/(log(zldis(p)/z0h(p)) + 5._kind_lake*zeta(p) - 5._kind_lake*z0h(p)/obu(p))</div>
<div class="line"><a id="l04996" name="l04996"></a><span class="lineno"> 4996</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l04997" name="l04997"></a><span class="lineno"> 4997</span>         temp1(p) = vkc/(log(obu(p)/z0h(p)) + 5._kind_lake - 5._kind_lake*z0h(p)/obu(p) &amp;</div>
<div class="line"><a id="l04998" name="l04998"></a><span class="lineno"> 4998</span>              + (5._kind_lake*log(zeta(p))+zeta(p)-1._kind_lake))</div>
<div class="line"><a id="l04999" name="l04999"></a><span class="lineno"> 4999</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l05000" name="l05000"></a><span class="lineno"> 5000</span> </div>
<div class="line"><a id="l05001" name="l05001"></a><span class="lineno"> 5001</span>      <span class="comment">! Humidity profile</span></div>
<div class="line"><a id="l05002" name="l05002"></a><span class="lineno"> 5002</span> </div>
<div class="line"><a id="l05003" name="l05003"></a><span class="lineno"> 5003</span>      <span class="keywordflow">if</span> (forc_hgt_q(g) == forc_hgt_t(g) .and. z0q(p) == z0h(p)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05004" name="l05004"></a><span class="lineno"> 5004</span>         temp2(p) = temp1(p)</div>
<div class="line"><a id="l05005" name="l05005"></a><span class="lineno"> 5005</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05006" name="l05006"></a><span class="lineno"> 5006</span>         zldis(p) = forc_hgt_q(g)-displa(p)</div>
<div class="line"><a id="l05007" name="l05007"></a><span class="lineno"> 5007</span>         zeta(p) = zldis(p)/obu(p)</div>
<div class="line"><a id="l05008" name="l05008"></a><span class="lineno"> 5008</span>         <span class="keywordflow">if</span> (zeta(p) &lt; -zetat) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05009" name="l05009"></a><span class="lineno"> 5009</span>            temp2(p) = vkc/(log(-zetat*obu(p)/z0q(p)) &amp;</div>
<div class="line"><a id="l05010" name="l05010"></a><span class="lineno"> 5010</span>                 - stabilityfunc2(-zetat) &amp;</div>
<div class="line"><a id="l05011" name="l05011"></a><span class="lineno"> 5011</span>                 + stabilityfunc2(z0q(p)/obu(p)) &amp;</div>
<div class="line"><a id="l05012" name="l05012"></a><span class="lineno"> 5012</span>                 + 0.8_kind_lake*((zetat)**(-0.333_kind_lake)-(-zeta(p))**(-0.333_kind_lake)))</div>
<div class="line"><a id="l05013" name="l05013"></a><span class="lineno"> 5013</span>         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05014" name="l05014"></a><span class="lineno"> 5014</span>            temp2(p) = vkc/(log(zldis(p)/z0q(p)) &amp;</div>
<div class="line"><a id="l05015" name="l05015"></a><span class="lineno"> 5015</span>                 - stabilityfunc2(zeta(p)) &amp;</div>
<div class="line"><a id="l05016" name="l05016"></a><span class="lineno"> 5016</span>                 + stabilityfunc2(z0q(p)/obu(p)))</div>
<div class="line"><a id="l05017" name="l05017"></a><span class="lineno"> 5017</span>         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt;=  1._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05018" name="l05018"></a><span class="lineno"> 5018</span>            temp2(p) = vkc/(log(zldis(p)/z0q(p)) + 5._kind_lake*zeta(p)-5._kind_lake*z0q(p)/obu(p))</div>
<div class="line"><a id="l05019" name="l05019"></a><span class="lineno"> 5019</span>         <span class="keywordflow">else</span></div>
<div class="line"><a id="l05020" name="l05020"></a><span class="lineno"> 5020</span>            temp2(p) = vkc/(log(obu(p)/z0q(p)) + 5._kind_lake - 5._kind_lake*z0q(p)/obu(p) &amp;</div>
<div class="line"><a id="l05021" name="l05021"></a><span class="lineno"> 5021</span>                 + (5._kind_lake*log(zeta(p))+zeta(p)-1._kind_lake))</div>
<div class="line"><a id="l05022" name="l05022"></a><span class="lineno"> 5022</span><span class="keywordflow">         end if</span></div>
<div class="line"><a id="l05023" name="l05023"></a><span class="lineno"> 5023</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l05024" name="l05024"></a><span class="lineno"> 5024</span> </div>
<div class="line"><a id="l05025" name="l05025"></a><span class="lineno"> 5025</span>      <span class="comment">! Temperature profile applied at 2-m</span></div>
<div class="line"><a id="l05026" name="l05026"></a><span class="lineno"> 5026</span> </div>
<div class="line"><a id="l05027" name="l05027"></a><span class="lineno"> 5027</span>      zldis(p) = 2.0_kind_lake + z0h(p)</div>
<div class="line"><a id="l05028" name="l05028"></a><span class="lineno"> 5028</span>      zeta(p) = zldis(p)/obu(p)</div>
<div class="line"><a id="l05029" name="l05029"></a><span class="lineno"> 5029</span>      <span class="keywordflow">if</span> (zeta(p) &lt; -zetat) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05030" name="l05030"></a><span class="lineno"> 5030</span>         temp12m(p) = vkc/(log(-zetat*obu(p)/z0h(p))&amp;</div>
<div class="line"><a id="l05031" name="l05031"></a><span class="lineno"> 5031</span>              - stabilityfunc2(-zetat) &amp;</div>
<div class="line"><a id="l05032" name="l05032"></a><span class="lineno"> 5032</span>              + stabilityfunc2(z0h(p)/obu(p)) &amp;</div>
<div class="line"><a id="l05033" name="l05033"></a><span class="lineno"> 5033</span>              + 0.8_kind_lake*((zetat)**(-0.333_kind_lake)-(-zeta(p))**(-0.333_kind_lake)))</div>
<div class="line"><a id="l05034" name="l05034"></a><span class="lineno"> 5034</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05035" name="l05035"></a><span class="lineno"> 5035</span>         temp12m(p) = vkc/(log(zldis(p)/z0h(p)) &amp;</div>
<div class="line"><a id="l05036" name="l05036"></a><span class="lineno"> 5036</span>              - stabilityfunc2(zeta(p))  &amp;</div>
<div class="line"><a id="l05037" name="l05037"></a><span class="lineno"> 5037</span>              + stabilityfunc2(z0h(p)/obu(p)))</div>
<div class="line"><a id="l05038" name="l05038"></a><span class="lineno"> 5038</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt;=  1._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05039" name="l05039"></a><span class="lineno"> 5039</span>         temp12m(p) = vkc/(log(zldis(p)/z0h(p)) + 5._kind_lake*zeta(p) - 5._kind_lake*z0h(p)/obu(p))</div>
<div class="line"><a id="l05040" name="l05040"></a><span class="lineno"> 5040</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05041" name="l05041"></a><span class="lineno"> 5041</span>         temp12m(p) = vkc/(log(obu(p)/z0h(p)) + 5._kind_lake - 5._kind_lake*z0h(p)/obu(p) &amp;</div>
<div class="line"><a id="l05042" name="l05042"></a><span class="lineno"> 5042</span>              + (5._kind_lake*log(zeta(p))+zeta(p)-1._kind_lake))</div>
<div class="line"><a id="l05043" name="l05043"></a><span class="lineno"> 5043</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l05044" name="l05044"></a><span class="lineno"> 5044</span> </div>
<div class="line"><a id="l05045" name="l05045"></a><span class="lineno"> 5045</span>      <span class="comment">! Humidity profile applied at 2-m</span></div>
<div class="line"><a id="l05046" name="l05046"></a><span class="lineno"> 5046</span> </div>
<div class="line"><a id="l05047" name="l05047"></a><span class="lineno"> 5047</span>      <span class="keywordflow">if</span> (z0q(p) == z0h(p)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05048" name="l05048"></a><span class="lineno"> 5048</span>         temp22m(p) = temp12m(p)</div>
<div class="line"><a id="l05049" name="l05049"></a><span class="lineno"> 5049</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05050" name="l05050"></a><span class="lineno"> 5050</span>         zldis(p) = 2.0_kind_lake + z0q(p)</div>
<div class="line"><a id="l05051" name="l05051"></a><span class="lineno"> 5051</span>         zeta(p) = zldis(p)/obu(p)</div>
<div class="line"><a id="l05052" name="l05052"></a><span class="lineno"> 5052</span>         <span class="keywordflow">if</span> (zeta(p) &lt; -zetat) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05053" name="l05053"></a><span class="lineno"> 5053</span>            temp22m(p) = vkc/(log(-zetat*obu(p)/z0q(p)) - &amp;</div>
<div class="line"><a id="l05054" name="l05054"></a><span class="lineno"> 5054</span>                 stabilityfunc2(-zetat) + stabilityfunc2(z0q(p)/obu(p)) &amp;</div>
<div class="line"><a id="l05055" name="l05055"></a><span class="lineno"> 5055</span>                 + 0.8_kind_lake*((zetat)**(-0.333_kind_lake)-(-zeta(p))**(-0.333_kind_lake)))</div>
<div class="line"><a id="l05056" name="l05056"></a><span class="lineno"> 5056</span>         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05057" name="l05057"></a><span class="lineno"> 5057</span>            temp22m(p) = vkc/(log(zldis(p)/z0q(p)) - &amp;</div>
<div class="line"><a id="l05058" name="l05058"></a><span class="lineno"> 5058</span>                 stabilityfunc2(zeta(p))+stabilityfunc2(z0q(p)/obu(p)))</div>
<div class="line"><a id="l05059" name="l05059"></a><span class="lineno"> 5059</span>         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt;=  1._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05060" name="l05060"></a><span class="lineno"> 5060</span>            temp22m(p) = vkc/(log(zldis(p)/z0q(p)) + 5._kind_lake*zeta(p)-5._kind_lake*z0q(p)/obu(p))</div>
<div class="line"><a id="l05061" name="l05061"></a><span class="lineno"> 5061</span>         <span class="keywordflow">else</span></div>
<div class="line"><a id="l05062" name="l05062"></a><span class="lineno"> 5062</span>            temp22m(p) = vkc/(log(obu(p)/z0q(p)) + 5._kind_lake - 5._kind_lake*z0q(p)/obu(p) &amp;</div>
<div class="line"><a id="l05063" name="l05063"></a><span class="lineno"> 5063</span>                 + (5._kind_lake*log(zeta(p))+zeta(p)-1._kind_lake))</div>
<div class="line"><a id="l05064" name="l05064"></a><span class="lineno"> 5064</span><span class="keywordflow">         end if</span></div>
<div class="line"><a id="l05065" name="l05065"></a><span class="lineno"> 5065</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l05066" name="l05066"></a><span class="lineno"> 5066</span><span class="keywordflow">   end do</span></div>
<div class="line"><a id="l05067" name="l05067"></a><span class="lineno"> 5067</span><span class="keywordflow">   endif</span> if_not_pergro</div>
<div class="line"><a id="l05068" name="l05068"></a><span class="lineno"> 5068</span> </div>
<div class="line"><a id="l05069" name="l05069"></a><span class="lineno"> 5069</span> </div>
<div class="line"><a id="l05070" name="l05070"></a><span class="lineno"> 5070</span>if_pergro: <span class="keywordflow">if</span> (pergro) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05071" name="l05071"></a><span class="lineno"> 5071</span> </div>
<div class="line"><a id="l05072" name="l05072"></a><span class="lineno"> 5072</span>   <span class="comment">!===============================================================================</span></div>
<div class="line"><a id="l05073" name="l05073"></a><span class="lineno"> 5073</span>   <span class="comment">! The following only applies when PERGRO is defined</span></div>
<div class="line"><a id="l05074" name="l05074"></a><span class="lineno"> 5074</span>   <span class="comment">!===============================================================================</span></div>
<div class="line"><a id="l05075" name="l05075"></a><span class="lineno"> 5075</span> </div>
<div class="line"><a id="l05076" name="l05076"></a><span class="lineno"> 5076</span>   <span class="comment">!dir$ concurrent</span></div>
<div class="line"><a id="l05077" name="l05077"></a><span class="lineno"> 5077</span>   <span class="comment">!cdir nodep</span></div>
<div class="line"><a id="l05078" name="l05078"></a><span class="lineno"> 5078</span>   <span class="keywordflow">do</span> f = 1, fn</div>
<div class="line"><a id="l05079" name="l05079"></a><span class="lineno"> 5079</span>      p = filterp(f)</div>
<div class="line"><a id="l05080" name="l05080"></a><span class="lineno"> 5080</span>      g = pgridcell(p)</div>
<div class="line"><a id="l05081" name="l05081"></a><span class="lineno"> 5081</span> </div>
<div class="line"><a id="l05082" name="l05082"></a><span class="lineno"> 5082</span>      zldis(p) = forc_hgt_u(g)-displa(p)</div>
<div class="line"><a id="l05083" name="l05083"></a><span class="lineno"> 5083</span>      zeta(p) = zldis(p)/obu(p)</div>
<div class="line"><a id="l05084" name="l05084"></a><span class="lineno"> 5084</span>      <span class="keywordflow">if</span> (zeta(p) &lt; -zetam) <span class="keywordflow">then</span>           <span class="comment">! zeta &lt; -1</span></div>
<div class="line"><a id="l05085" name="l05085"></a><span class="lineno"> 5085</span>         ustar(p) = vkc * um(p) / log(-zetam*obu(p)/z0m(p))</div>
<div class="line"><a id="l05086" name="l05086"></a><span class="lineno"> 5086</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt; 0._kind_lake) <span class="keywordflow">then</span>         <span class="comment">! -1 &lt;= zeta &lt; 0</span></div>
<div class="line"><a id="l05087" name="l05087"></a><span class="lineno"> 5087</span>         ustar(p) = vkc * um(p) / log(zldis(p)/z0m(p))</div>
<div class="line"><a id="l05088" name="l05088"></a><span class="lineno"> 5088</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt;= 1._kind_lake) <span class="keywordflow">then</span>        <span class="comment">!  0 &lt;= ztea &lt;= 1</span></div>
<div class="line"><a id="l05089" name="l05089"></a><span class="lineno"> 5089</span>         ustar(p)=vkc * um(p)/log(zldis(p)/z0m(p))</div>
<div class="line"><a id="l05090" name="l05090"></a><span class="lineno"> 5090</span>      <span class="keywordflow">else</span>                             <span class="comment">!  1 &lt; zeta, phi=5+zeta</span></div>
<div class="line"><a id="l05091" name="l05091"></a><span class="lineno"> 5091</span>         ustar(p)=vkc * um(p)/log(obu(p)/z0m(p))</div>
<div class="line"><a id="l05092" name="l05092"></a><span class="lineno"> 5092</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l05093" name="l05093"></a><span class="lineno"> 5093</span> </div>
<div class="line"><a id="l05094" name="l05094"></a><span class="lineno"> 5094</span>      zldis(p) = forc_hgt_t(g)-displa(p)</div>
<div class="line"><a id="l05095" name="l05095"></a><span class="lineno"> 5095</span>      zeta(p) = zldis(p)/obu(p)</div>
<div class="line"><a id="l05096" name="l05096"></a><span class="lineno"> 5096</span>      <span class="keywordflow">if</span> (zeta(p) &lt; -zetat) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05097" name="l05097"></a><span class="lineno"> 5097</span>         temp1(p)=vkc/log(-zetat*obu(p)/z0h(p))</div>
<div class="line"><a id="l05098" name="l05098"></a><span class="lineno"> 5098</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05099" name="l05099"></a><span class="lineno"> 5099</span>         temp1(p)=vkc/log(zldis(p)/z0h(p))</div>
<div class="line"><a id="l05100" name="l05100"></a><span class="lineno"> 5100</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt;= 1._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05101" name="l05101"></a><span class="lineno"> 5101</span>         temp1(p)=vkc/log(zldis(p)/z0h(p))</div>
<div class="line"><a id="l05102" name="l05102"></a><span class="lineno"> 5102</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05103" name="l05103"></a><span class="lineno"> 5103</span>         temp1(p)=vkc/log(obu(p)/z0h(p))</div>
<div class="line"><a id="l05104" name="l05104"></a><span class="lineno"> 5104</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l05105" name="l05105"></a><span class="lineno"> 5105</span> </div>
<div class="line"><a id="l05106" name="l05106"></a><span class="lineno"> 5106</span>      zldis(p) = forc_hgt_q(g)-displa(p)</div>
<div class="line"><a id="l05107" name="l05107"></a><span class="lineno"> 5107</span>      zeta(p) = zldis(p)/obu(p)</div>
<div class="line"><a id="l05108" name="l05108"></a><span class="lineno"> 5108</span>      <span class="keywordflow">if</span> (zeta(p) &lt; -zetat) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05109" name="l05109"></a><span class="lineno"> 5109</span>         temp2(p)=vkc/log(-zetat*obu(p)/z0q(p))</div>
<div class="line"><a id="l05110" name="l05110"></a><span class="lineno"> 5110</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05111" name="l05111"></a><span class="lineno"> 5111</span>         temp2(p)=vkc/log(zldis(p)/z0q(p))</div>
<div class="line"><a id="l05112" name="l05112"></a><span class="lineno"> 5112</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt;= 1._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05113" name="l05113"></a><span class="lineno"> 5113</span>         temp2(p)=vkc/log(zldis(p)/z0q(p))</div>
<div class="line"><a id="l05114" name="l05114"></a><span class="lineno"> 5114</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05115" name="l05115"></a><span class="lineno"> 5115</span>         temp2(p)=vkc/log(obu(p)/z0q(p))</div>
<div class="line"><a id="l05116" name="l05116"></a><span class="lineno"> 5116</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l05117" name="l05117"></a><span class="lineno"> 5117</span> </div>
<div class="line"><a id="l05118" name="l05118"></a><span class="lineno"> 5118</span>      zldis(p) = 2.0_kind_lake + z0h(p)</div>
<div class="line"><a id="l05119" name="l05119"></a><span class="lineno"> 5119</span>      zeta(p) = zldis(p)/obu(p)</div>
<div class="line"><a id="l05120" name="l05120"></a><span class="lineno"> 5120</span>      <span class="keywordflow">if</span> (zeta(p) &lt; -zetat) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05121" name="l05121"></a><span class="lineno"> 5121</span>         temp12m(p)=vkc/log(-zetat*obu(p)/z0h(p))</div>
<div class="line"><a id="l05122" name="l05122"></a><span class="lineno"> 5122</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05123" name="l05123"></a><span class="lineno"> 5123</span>         temp12m(p)=vkc/log(zldis(p)/z0h(p))</div>
<div class="line"><a id="l05124" name="l05124"></a><span class="lineno"> 5124</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt;= 1._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05125" name="l05125"></a><span class="lineno"> 5125</span>         temp12m(p)=vkc/log(zldis(p)/z0h(p))</div>
<div class="line"><a id="l05126" name="l05126"></a><span class="lineno"> 5126</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05127" name="l05127"></a><span class="lineno"> 5127</span>         temp12m(p)=vkc/log(obu(p)/z0h(p))</div>
<div class="line"><a id="l05128" name="l05128"></a><span class="lineno"> 5128</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l05129" name="l05129"></a><span class="lineno"> 5129</span> </div>
<div class="line"><a id="l05130" name="l05130"></a><span class="lineno"> 5130</span>      zldis(p) = 2.0_kind_lake + z0q(p)</div>
<div class="line"><a id="l05131" name="l05131"></a><span class="lineno"> 5131</span>      zeta(p) = zldis(p)/obu(p)</div>
<div class="line"><a id="l05132" name="l05132"></a><span class="lineno"> 5132</span>      <span class="keywordflow">if</span> (zeta(p) &lt; -zetat) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05133" name="l05133"></a><span class="lineno"> 5133</span>         temp22m(p)=vkc/log(-zetat*obu(p)/z0q(p))</div>
<div class="line"><a id="l05134" name="l05134"></a><span class="lineno"> 5134</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt; 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05135" name="l05135"></a><span class="lineno"> 5135</span>         temp22m(p)=vkc/log(zldis(p)/z0q(p))</div>
<div class="line"><a id="l05136" name="l05136"></a><span class="lineno"> 5136</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (zeta(p) &lt;= 1._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05137" name="l05137"></a><span class="lineno"> 5137</span>         temp22m(p)=vkc/log(zldis(p)/z0q(p))</div>
<div class="line"><a id="l05138" name="l05138"></a><span class="lineno"> 5138</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05139" name="l05139"></a><span class="lineno"> 5139</span>         temp22m(p)=vkc/log(obu(p)/z0q(p))</div>
<div class="line"><a id="l05140" name="l05140"></a><span class="lineno"> 5140</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l05141" name="l05141"></a><span class="lineno"> 5141</span><span class="keywordflow">   end do</span></div>
<div class="line"><a id="l05142" name="l05142"></a><span class="lineno"> 5142</span> </div>
<div class="line"><a id="l05143" name="l05143"></a><span class="lineno"> 5143</span><span class="keywordflow">   endif</span> if_pergro</div>
<div class="line"><a id="l05144" name="l05144"></a><span class="lineno"> 5144</span> </div>
</div>
<div class="line"><a id="l05145" name="l05145"></a><span class="lineno"> 5145</span>   <span class="keyword">end subroutine </span>frictionvelocity</div>
<div class="line"><a id="l05146" name="l05146"></a><span class="lineno"> 5146</span> </div>
<div class="line"><a id="l05147" name="l05147"></a><span class="lineno"> 5147</span>   <span class="comment">! !IROUTINE: StabilityFunc</span></div>
<div class="line"><a id="l05148" name="l05148"></a><span class="lineno"> 5148</span>   <span class="comment">!</span></div>
<div class="line"><a id="l05149" name="l05149"></a><span class="lineno"> 5149</span>   <span class="comment">! !INTERFACE:</span></div>
<div class="foldopen" id="foldopen05150" data-start="" data-end="">
<div class="line"><a id="l05150" name="l05150"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a2218d0d821c15763c34a951747974aaa.html#a2218d0d821c15763c34a951747974aaa"> 5150</a></span><span class="keywordtype">   real</span>(kind_lake) function stabilityfunc1(zeta)</div>
<div class="line"><a id="l05151" name="l05151"></a><span class="lineno"> 5151</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05152" name="l05152"></a><span class="lineno"> 5152</span>     <span class="comment">! DESCRIPTION:</span><span class="comment"></span></div>
<div class="line"><a id="l05153" name="l05153"></a><span class="lineno"> 5153</span><span class="comment">     !&gt; Stability function for rib &lt; 0.</span></div>
<div class="line"><a id="l05154" name="l05154"></a><span class="lineno"> 5154</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05155" name="l05155"></a><span class="lineno"> 5155</span>     <span class="comment">! !USES:</span></div>
<div class="line"><a id="l05156" name="l05156"></a><span class="lineno"> 5156</span>     <span class="comment">!      use shr_const_mod, only: SHR_CONST_PI</span></div>
<div class="line"><a id="l05157" name="l05157"></a><span class="lineno"> 5157</span>     <span class="comment">!Zack Subin, 7/8/08</span></div>
<div class="line"><a id="l05158" name="l05158"></a><span class="lineno"> 5158</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05159" name="l05159"></a><span class="lineno"> 5159</span>     <span class="comment">! !ARGUMENTS:</span></div>
<div class="line"><a id="l05160" name="l05160"></a><span class="lineno"> 5160</span>     <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l05161" name="l05161"></a><span class="lineno"> 5161</span><span class="keywordtype">      real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: zeta<span class="comment">  !&lt; dimensionless height used in Monin-Obukhov theory</span></div>
<div class="line"><a id="l05162" name="l05162"></a><span class="lineno"> 5162</span>      <span class="comment">!</span></div>
<div class="line"><a id="l05163" name="l05163"></a><span class="lineno"> 5163</span>      <span class="comment">! !CALLED FROM:</span></div>
<div class="line"><a id="l05164" name="l05164"></a><span class="lineno"> 5164</span>      <span class="comment">! subroutine FrictionVelocity in this module</span></div>
<div class="line"><a id="l05165" name="l05165"></a><span class="lineno"> 5165</span>      <span class="comment">!</span></div>
<div class="line"><a id="l05166" name="l05166"></a><span class="lineno"> 5166</span>      <span class="comment">! !REVISION HISTORY:</span></div>
<div class="line"><a id="l05167" name="l05167"></a><span class="lineno"> 5167</span>      <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l05168" name="l05168"></a><span class="lineno"> 5168</span>      <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l05169" name="l05169"></a><span class="lineno"> 5169</span>      <span class="comment">! June 2022: Sam Trahan; modified for CCPP</span></div>
<div class="line"><a id="l05170" name="l05170"></a><span class="lineno"> 5170</span>      <span class="comment">!</span></div>
<div class="line"><a id="l05171" name="l05171"></a><span class="lineno"> 5171</span>      <span class="comment">!EOP</span></div>
<div class="line"><a id="l05172" name="l05172"></a><span class="lineno"> 5172</span>      <span class="comment">!</span></div>
<div class="line"><a id="l05173" name="l05173"></a><span class="lineno"> 5173</span>      <span class="comment">! !LOCAL VARIABLES:</span></div>
<div class="line"><a id="l05174" name="l05174"></a><span class="lineno"> 5174</span><span class="keywordtype">      real</span>(kind_lake) :: chik, chik2</div>
<div class="line"><a id="l05175" name="l05175"></a><span class="lineno"> 5175</span>      <span class="comment">!------------------------------------------------------------------------------</span></div>
<div class="line"><a id="l05176" name="l05176"></a><span class="lineno"> 5176</span> </div>
<div class="line"><a id="l05177" name="l05177"></a><span class="lineno"> 5177</span>      chik2 = sqrt(1._kind_lake-16._kind_lake*zeta)</div>
<div class="line"><a id="l05178" name="l05178"></a><span class="lineno"> 5178</span>      chik = sqrt(chik2)</div>
<div class="line"><a id="l05179" name="l05179"></a><span class="lineno"> 5179</span>      stabilityfunc1 = 2._kind_lake*log((1._kind_lake+chik)*0.5_kind_lake) &amp;</div>
<div class="line"><a id="l05180" name="l05180"></a><span class="lineno"> 5180</span>           <span class="comment">!Changed to pie, Zack Subin, 7/9/08</span></div>
<div class="line"><a id="l05181" name="l05181"></a><span class="lineno"> 5181</span>           <span class="comment">!Spelling corrected, changed to pi, Sam Trahan the Killjoy, 6/2/22</span></div>
<div class="line"><a id="l05182" name="l05182"></a><span class="lineno"> 5182</span>           + log((1._kind_lake+chik2)*0.5_kind_lake)-2._kind_lake*atan(chik)+pi*0.5_kind_lake</div>
<div class="line"><a id="l05183" name="l05183"></a><span class="lineno"> 5183</span> </div>
</div>
<div class="line"><a id="l05184" name="l05184"></a><span class="lineno"> 5184</span>    <span class="keyword">end function </span>stabilityfunc1</div>
<div class="line"><a id="l05185" name="l05185"></a><span class="lineno"> 5185</span> </div>
<div class="line"><a id="l05186" name="l05186"></a><span class="lineno"> 5186</span>    <span class="comment">!------------------------------------------------------------------------------</span></div>
<div class="line"><a id="l05187" name="l05187"></a><span class="lineno"> 5187</span>    <span class="comment">!BOP</span></div>
<div class="line"><a id="l05188" name="l05188"></a><span class="lineno"> 5188</span>    <span class="comment">!</span></div>
<div class="line"><a id="l05189" name="l05189"></a><span class="lineno"> 5189</span>    <span class="comment">! !IROUTINE: StabilityFunc2</span></div>
<div class="line"><a id="l05190" name="l05190"></a><span class="lineno"> 5190</span>    <span class="comment">!</span></div>
<div class="line"><a id="l05191" name="l05191"></a><span class="lineno"> 5191</span>    <span class="comment">! !INTERFACE:</span></div>
<div class="foldopen" id="foldopen05192" data-start="" data-end="">
<div class="line"><a id="l05192" name="l05192"></a><span class="lineno"><a class="line" href="namespaceclm__lake_a36af92623df1ef147db389224d077a92.html#a36af92623df1ef147db389224d077a92"> 5192</a></span><span class="keywordtype">   real</span>(kind_lake) function stabilityfunc2(zeta)</div>
<div class="line"><a id="l05193" name="l05193"></a><span class="lineno"> 5193</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05194" name="l05194"></a><span class="lineno"> 5194</span>     <span class="comment">! !DESCRIPTION:</span><span class="comment"></span></div>
<div class="line"><a id="l05195" name="l05195"></a><span class="lineno"> 5195</span><span class="comment">     !&gt; Stability function for rib &lt; 0.</span></div>
<div class="line"><a id="l05196" name="l05196"></a><span class="lineno"> 5196</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05197" name="l05197"></a><span class="lineno"> 5197</span>     <span class="comment">! !USES:</span></div>
<div class="line"><a id="l05198" name="l05198"></a><span class="lineno"> 5198</span>     <span class="comment">!Removed by Zack Subin, 7/9/08</span></div>
<div class="line"><a id="l05199" name="l05199"></a><span class="lineno"> 5199</span>     <span class="comment">!     use shr_const_mod, only: SHR_CONST_PI</span></div>
<div class="line"><a id="l05200" name="l05200"></a><span class="lineno"> 5200</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05201" name="l05201"></a><span class="lineno"> 5201</span>     <span class="comment">! !ARGUMENTS:</span></div>
<div class="line"><a id="l05202" name="l05202"></a><span class="lineno"> 5202</span>     <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l05203" name="l05203"></a><span class="lineno"> 5203</span><span class="keywordtype">     real</span>(kind_lake), <span class="keywordtype">intent(in)</span> :: zeta<span class="comment">  !&lt; dimensionless height used in Monin-Obukhov theory</span></div>
<div class="line"><a id="l05204" name="l05204"></a><span class="lineno"> 5204</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05205" name="l05205"></a><span class="lineno"> 5205</span>     <span class="comment">! !CALLED FROM:</span></div>
<div class="line"><a id="l05206" name="l05206"></a><span class="lineno"> 5206</span>     <span class="comment">! subroutine FrictionVelocity in this module</span></div>
<div class="line"><a id="l05207" name="l05207"></a><span class="lineno"> 5207</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05208" name="l05208"></a><span class="lineno"> 5208</span>     <span class="comment">! !REVISION HISTORY:</span></div>
<div class="line"><a id="l05209" name="l05209"></a><span class="lineno"> 5209</span>     <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l05210" name="l05210"></a><span class="lineno"> 5210</span>     <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l05211" name="l05211"></a><span class="lineno"> 5211</span>     <span class="comment">! June 2022: Sam Trahan modified for CCPP</span></div>
<div class="line"><a id="l05212" name="l05212"></a><span class="lineno"> 5212</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05213" name="l05213"></a><span class="lineno"> 5213</span>     <span class="comment">!EOP</span></div>
<div class="line"><a id="l05214" name="l05214"></a><span class="lineno"> 5214</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05215" name="l05215"></a><span class="lineno"> 5215</span>     <span class="comment">! !LOCAL VARIABLES:</span></div>
<div class="line"><a id="l05216" name="l05216"></a><span class="lineno"> 5216</span><span class="keywordtype">     real</span>(kind_lake) :: chik2</div>
<div class="line"><a id="l05217" name="l05217"></a><span class="lineno"> 5217</span>     <span class="comment">!------------------------------------------------------------------------------</span></div>
<div class="line"><a id="l05218" name="l05218"></a><span class="lineno"> 5218</span> </div>
<div class="line"><a id="l05219" name="l05219"></a><span class="lineno"> 5219</span>     chik2 = sqrt(1._kind_lake-16._kind_lake*zeta)</div>
<div class="line"><a id="l05220" name="l05220"></a><span class="lineno"> 5220</span>     stabilityfunc2 = 2._kind_lake*log((1._kind_lake+chik2)*0.5_kind_lake)</div>
<div class="line"><a id="l05221" name="l05221"></a><span class="lineno"> 5221</span> </div>
</div>
<div class="line"><a id="l05222" name="l05222"></a><span class="lineno"> 5222</span>   <span class="keyword">end function </span>stabilityfunc2</div>
<div class="line"><a id="l05223" name="l05223"></a><span class="lineno"> 5223</span> </div>
<div class="line"><a id="l05224" name="l05224"></a><span class="lineno"> 5224</span>   <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l05225" name="l05225"></a><span class="lineno"> 5225</span>   <span class="comment">!BOP</span></div>
<div class="line"><a id="l05226" name="l05226"></a><span class="lineno"> 5226</span>   <span class="comment">!</span></div>
<div class="line"><a id="l05227" name="l05227"></a><span class="lineno"> 5227</span>   <span class="comment">! !IROUTINE: MoninObukIni</span></div>
<div class="line"><a id="l05228" name="l05228"></a><span class="lineno"> 5228</span>   <span class="comment">!</span></div>
<div class="line"><a id="l05229" name="l05229"></a><span class="lineno"> 5229</span>   <span class="comment">! !INTERFACE:</span></div>
<div class="foldopen" id="foldopen05230" data-start="" data-end="">
<div class="line"><a id="l05230" name="l05230"></a><span class="lineno"><a class="line" href="namespaceclm__lake_ab4ca44b88aa24015f62195b9591aa8f3.html#ab4ca44b88aa24015f62195b9591aa8f3"> 5230</a></span>   <span class="keyword">subroutine </span>moninobukini (ur, thv, dthv, zldis, z0m, um, obu)</div>
<div class="line"><a id="l05231" name="l05231"></a><span class="lineno"> 5231</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05232" name="l05232"></a><span class="lineno"> 5232</span>     <span class="comment">! !DESCRIPTION:</span><span class="comment"></span></div>
<div class="line"><a id="l05233" name="l05233"></a><span class="lineno"> 5233</span><span class="comment">     !&gt; Initialization of the Monin-Obukhov length.</span></div>
<div class="line"><a id="l05234" name="l05234"></a><span class="lineno"> 5234</span><span class="comment">     !! The scheme is based on the work of Zeng et al. (1998):</span></div>
<div class="line"><a id="l05235" name="l05235"></a><span class="lineno"> 5235</span><span class="comment">     !! Intercomparison of bulk aerodynamic algorithms for the computation</span></div>
<div class="line"><a id="l05236" name="l05236"></a><span class="lineno"> 5236</span><span class="comment">     !! of sea surface fluxes using TOGA CORE and TAO data. J. Climate,</span></div>
<div class="line"><a id="l05237" name="l05237"></a><span class="lineno"> 5237</span><span class="comment">     !! Vol. 11, 2628-2644.</span></div>
<div class="line"><a id="l05238" name="l05238"></a><span class="lineno"> 5238</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05239" name="l05239"></a><span class="lineno"> 5239</span>     <span class="comment">! !USES:</span></div>
<div class="line"><a id="l05240" name="l05240"></a><span class="lineno"> 5240</span>     <span class="comment">!</span></div>
<div class="line"><a id="l05241" name="l05241"></a><span class="lineno"> 5241</span>     <span class="comment">! !ARGUMENTS:</span></div>
<div class="line"><a id="l05242" name="l05242"></a><span class="lineno"> 5242</span>     <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l05243" name="l05243"></a><span class="lineno"> 5243</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: ur<span class="comment">    !&lt; wind speed at reference height [m/s]</span></div>
<div class="line"><a id="l05244" name="l05244"></a><span class="lineno"> 5244</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: thv<span class="comment">   !&lt; virtual potential temperature (kelvin)</span></div>
<div class="line"><a id="l05245" name="l05245"></a><span class="lineno"> 5245</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: dthv<span class="comment">  !&lt; diff of vir. poten. temp. between ref. height and surface</span></div>
<div class="line"><a id="l05246" name="l05246"></a><span class="lineno"> 5246</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: zldis<span class="comment"> !&lt; reference height &quot;minus&quot; zero displacement heght [m]</span></div>
<div class="line"><a id="l05247" name="l05247"></a><span class="lineno"> 5247</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(in)</span>  :: z0m<span class="comment">   !&lt; roughness length, momentum [m]</span></div>
<div class="line"><a id="l05248" name="l05248"></a><span class="lineno"> 5248</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: um<span class="comment">    !&lt; wind speed including the stability effect [m/s]</span></div>
<div class="line"><a id="l05249" name="l05249"></a><span class="lineno"> 5249</span><span class="keywordtype">    real</span>(kind_lake), <span class="keywordtype">intent(out)</span> :: obu<span class="comment">   !&lt; monin-obukhov length (m)</span></div>
<div class="line"><a id="l05250" name="l05250"></a><span class="lineno"> 5250</span>    <span class="comment">!</span></div>
<div class="line"><a id="l05251" name="l05251"></a><span class="lineno"> 5251</span>    <span class="comment">! !CALLED FROM:</span></div>
<div class="line"><a id="l05252" name="l05252"></a><span class="lineno"> 5252</span>    <span class="comment">! subroutine BareGroundFluxes in module BareGroundFluxesMod.F90</span></div>
<div class="line"><a id="l05253" name="l05253"></a><span class="lineno"> 5253</span>    <span class="comment">! subroutine BiogeophysicsLake in module BiogeophysicsLakeMod.F90</span></div>
<div class="line"><a id="l05254" name="l05254"></a><span class="lineno"> 5254</span>    <span class="comment">! subroutine CanopyFluxes in module CanopyFluxesMod.F90</span></div>
<div class="line"><a id="l05255" name="l05255"></a><span class="lineno"> 5255</span>    <span class="comment">!</span></div>
<div class="line"><a id="l05256" name="l05256"></a><span class="lineno"> 5256</span>    <span class="comment">! !REVISION HISTORY:</span></div>
<div class="line"><a id="l05257" name="l05257"></a><span class="lineno"> 5257</span>    <span class="comment">! 15 September 1999: Yongjiu Dai; Initial code</span></div>
<div class="line"><a id="l05258" name="l05258"></a><span class="lineno"> 5258</span>    <span class="comment">! 15 December 1999:  Paul Houser and Jon Radakovich; F90 Revision</span></div>
<div class="line"><a id="l05259" name="l05259"></a><span class="lineno"> 5259</span>    <span class="comment">! June 2022: Sam Trahan modified for CCPP</span></div>
<div class="line"><a id="l05260" name="l05260"></a><span class="lineno"> 5260</span>    <span class="comment">!</span></div>
<div class="line"><a id="l05261" name="l05261"></a><span class="lineno"> 5261</span>    <span class="comment">!EOP</span></div>
<div class="line"><a id="l05262" name="l05262"></a><span class="lineno"> 5262</span>    <span class="comment">!</span></div>
<div class="line"><a id="l05263" name="l05263"></a><span class="lineno"> 5263</span>    <span class="comment">! !LOCAL VARIABLES:</span></div>
<div class="line"><a id="l05264" name="l05264"></a><span class="lineno"> 5264</span>    <span class="comment">!</span></div>
<div class="line"><a id="l05265" name="l05265"></a><span class="lineno"> 5265</span><span class="keywordtype">    real</span>(kind_lake) :: wc    <span class="comment">! convective velocity [m/s]</span></div>
<div class="line"><a id="l05266" name="l05266"></a><span class="lineno"> 5266</span><span class="keywordtype">    real</span>(kind_lake) :: rib   <span class="comment">! bulk Richardson number</span></div>
<div class="line"><a id="l05267" name="l05267"></a><span class="lineno"> 5267</span><span class="keywordtype">    real</span>(kind_lake) :: zeta  <span class="comment">! dimensionless height used in Monin-Obukhov theory</span></div>
<div class="line"><a id="l05268" name="l05268"></a><span class="lineno"> 5268</span><span class="keywordtype">    real</span>(kind_lake) :: ustar <span class="comment">! friction velocity [m/s]</span></div>
<div class="line"><a id="l05269" name="l05269"></a><span class="lineno"> 5269</span>    <span class="comment">!-----------------------------------------------------------------------</span></div>
<div class="line"><a id="l05270" name="l05270"></a><span class="lineno"> 5270</span> </div>
<div class="line"><a id="l05271" name="l05271"></a><span class="lineno"> 5271</span>    <span class="comment">! Initial values of u* and convective velocity</span></div>
<div class="line"><a id="l05272" name="l05272"></a><span class="lineno"> 5272</span> </div>
<div class="line"><a id="l05273" name="l05273"></a><span class="lineno"> 5273</span>    ustar=0.06_kind_lake</div>
<div class="line"><a id="l05274" name="l05274"></a><span class="lineno"> 5274</span>    wc=0.5_kind_lake</div>
<div class="line"><a id="l05275" name="l05275"></a><span class="lineno"> 5275</span>    <span class="keywordflow">if</span> (dthv &gt;= 0._kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05276" name="l05276"></a><span class="lineno"> 5276</span>       um=max(ur,0.1_kind_lake)</div>
<div class="line"><a id="l05277" name="l05277"></a><span class="lineno"> 5277</span>    <span class="keywordflow">else</span></div>
<div class="line"><a id="l05278" name="l05278"></a><span class="lineno"> 5278</span>       um=sqrt(ur*ur+wc*wc)</div>
<div class="line"><a id="l05279" name="l05279"></a><span class="lineno"> 5279</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l05280" name="l05280"></a><span class="lineno"> 5280</span> </div>
<div class="line"><a id="l05281" name="l05281"></a><span class="lineno"> 5281</span>    rib=grav*zldis*dthv/(thv*um*um)</div>
<div class="line"><a id="l05282" name="l05282"></a><span class="lineno"> 5282</span>    <span class="keywordflow">if</span> (pergro) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05283" name="l05283"></a><span class="lineno"> 5283</span>      rib = 0._kind_lake</div>
<div class="line"><a id="l05284" name="l05284"></a><span class="lineno"> 5284</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l05285" name="l05285"></a><span class="lineno"> 5285</span> </div>
<div class="line"><a id="l05286" name="l05286"></a><span class="lineno"> 5286</span>    <span class="keywordflow">if</span> (rib &gt;= 0._kind_lake) <span class="keywordflow">then</span>      <span class="comment">! neutral or stable</span></div>
<div class="line"><a id="l05287" name="l05287"></a><span class="lineno"> 5287</span>       zeta = rib*log(zldis/z0m)/(1._kind_lake-5._kind_lake*min(rib,0.19_kind_lake))</div>
<div class="line"><a id="l05288" name="l05288"></a><span class="lineno"> 5288</span>       zeta = min(2._kind_lake,max(zeta,0.01_kind_lake ))</div>
<div class="line"><a id="l05289" name="l05289"></a><span class="lineno"> 5289</span>    <span class="keywordflow">else</span>                     <span class="comment">! unstable</span></div>
<div class="line"><a id="l05290" name="l05290"></a><span class="lineno"> 5290</span>       zeta=rib*log(zldis/z0m)</div>
<div class="line"><a id="l05291" name="l05291"></a><span class="lineno"> 5291</span>       zeta = max(-100._kind_lake,min(zeta,-0.01_kind_lake ))</div>
<div class="line"><a id="l05292" name="l05292"></a><span class="lineno"> 5292</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l05293" name="l05293"></a><span class="lineno"> 5293</span> </div>
<div class="line"><a id="l05294" name="l05294"></a><span class="lineno"> 5294</span>    obu=zldis/zeta</div>
<div class="line"><a id="l05295" name="l05295"></a><span class="lineno"> 5295</span> </div>
</div>
<div class="line"><a id="l05296" name="l05296"></a><span class="lineno"> 5296</span>  <span class="keyword">end subroutine </span>moninobukini</div>
<div class="line"><a id="l05297" name="l05297"></a><span class="lineno"> 5297</span><span class="comment"></span> </div>
<div class="line"><a id="l05298" name="l05298"></a><span class="lineno"> 5298</span><span class="comment">  !&gt; \section arg_table_clm_lake_init Argument Table</span></div>
<div class="line"><a id="l05299" name="l05299"></a><span class="lineno"> 5299</span><span class="comment">  !! \htmlinclude clm_lake_init.html</span></div>
<div class="line"><a id="l05300" name="l05300"></a><span class="lineno"> 5300</span><span class="comment">  !!</span></div>
<div class="foldopen" id="foldopen05301" data-start="" data-end="">
<div class="line"><a id="l05301" name="l05301"></a><span class="lineno"><a class="line" href="namespaceclm__lake_accba76468de65c974e7c0fb920287014.html#accba76468de65c974e7c0fb920287014"> 5301</a></span>  <span class="keyword">subroutine </span>clm_lake_init(con_pi,karman,con_g,con_sbc,con_t0c,rhowater,con_csol,con_cliq, &amp;</div>
<div class="line"><a id="l05302" name="l05302"></a><span class="lineno"> 5302</span>                           con_hfus,con_hvap,con_rd,con_cp,rholakeice,clm_lake_debug, &amp;</div>
<div class="line"><a id="l05303" name="l05303"></a><span class="lineno"> 5303</span>                           clm_debug_print,con_eps_model,con_fvirt_model,errmsg,errflg)</div>
<div class="line"><a id="l05304" name="l05304"></a><span class="lineno"> 5304</span>    <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l05305" name="l05305"></a><span class="lineno"> 5305</span><span class="keywordtype">    real</span>(kind_phys), <span class="keywordtype">intent(in)</span> :: con_pi,karman,con_g,con_sbc,con_t0c, &amp;</div>
<div class="line"><a id="l05306" name="l05306"></a><span class="lineno"> 5306</span>         rhowater,con_csol,con_cliq, con_hfus,con_hvap,con_rd,con_cp, &amp;</div>
<div class="line"><a id="l05307" name="l05307"></a><span class="lineno"> 5307</span>         rholakeice,con_eps_model,con_fvirt_model</div>
<div class="line"><a id="l05308" name="l05308"></a><span class="lineno"> 5308</span>    <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(OUT)</span> :: errflg</div>
<div class="line"><a id="l05309" name="l05309"></a><span class="lineno"> 5309</span>    <span class="keywordtype">CHARACTER(*)</span>, <span class="keywordtype">INTENT(OUT)</span> :: errmsg</div>
<div class="line"><a id="l05310" name="l05310"></a><span class="lineno"> 5310</span>    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: clm_lake_debug,clm_debug_print</div>
<div class="line"><a id="l05311" name="l05311"></a><span class="lineno"> 5311</span>    <span class="keywordtype">integer</span> :: i, j</div>
<div class="line"><a id="l05312" name="l05312"></a><span class="lineno"> 5312</span> </div>
<div class="line"><a id="l05313" name="l05313"></a><span class="lineno"> 5313</span>    lakedebug = clm_lake_debug</div>
<div class="line"><a id="l05314" name="l05314"></a><span class="lineno"> 5314</span>    debug_print = clm_debug_print</div>
<div class="line"><a id="l05315" name="l05315"></a><span class="lineno"> 5315</span>    <span class="keywordflow">if</span>(debug_print) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05316" name="l05316"></a><span class="lineno"> 5316</span>      <span class="keyword">write</span>(0,*) <span class="stringliteral">&#39;clm_lake_init&#39;</span></div>
<div class="line"><a id="l05317" name="l05317"></a><span class="lineno"> 5317</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l05318" name="l05318"></a><span class="lineno"> 5318</span> </div>
<div class="line"><a id="l05319" name="l05319"></a><span class="lineno"> 5319</span>    errflg=0</div>
<div class="line"><a id="l05320" name="l05320"></a><span class="lineno"> 5320</span>    errmsg=<span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a id="l05321" name="l05321"></a><span class="lineno"> 5321</span> </div>
<div class="line"><a id="l05322" name="l05322"></a><span class="lineno"> 5322</span>    pi = con_pi</div>
<div class="line"><a id="l05323" name="l05323"></a><span class="lineno"> 5323</span>    vkc = karman</div>
<div class="line"><a id="l05324" name="l05324"></a><span class="lineno"> 5324</span>    grav = con_g</div>
<div class="line"><a id="l05325" name="l05325"></a><span class="lineno"> 5325</span>    sb = con_sbc</div>
<div class="line"><a id="l05326" name="l05326"></a><span class="lineno"> 5326</span>    tfrz = con_t0c</div>
<div class="line"><a id="l05327" name="l05327"></a><span class="lineno"> 5327</span>    denh2o = rhowater</div>
<div class="line"><a id="l05328" name="l05328"></a><span class="lineno"> 5328</span>    denice = rholakeice</div>
<div class="line"><a id="l05329" name="l05329"></a><span class="lineno"> 5329</span>    cpice = con_csol</div>
<div class="line"><a id="l05330" name="l05330"></a><span class="lineno"> 5330</span>    cpliq = con_cliq</div>
<div class="line"><a id="l05331" name="l05331"></a><span class="lineno"> 5331</span>    hfus = con_hfus</div>
<div class="line"><a id="l05332" name="l05332"></a><span class="lineno"> 5332</span>    hvap = con_hvap</div>
<div class="line"><a id="l05333" name="l05333"></a><span class="lineno"> 5333</span>    hsub = con_hfus+con_hvap</div>
<div class="line"><a id="l05334" name="l05334"></a><span class="lineno"> 5334</span>    invhvap = 1._kind_lake/hvap</div>
<div class="line"><a id="l05335" name="l05335"></a><span class="lineno"> 5335</span>    invhsub = 1._kind_lake/hsub</div>
<div class="line"><a id="l05336" name="l05336"></a><span class="lineno"> 5336</span>    rair = con_rd</div>
<div class="line"><a id="l05337" name="l05337"></a><span class="lineno"> 5337</span>    cpair = con_cp</div>
<div class="line"><a id="l05338" name="l05338"></a><span class="lineno"> 5338</span>    con_eps = con_eps_model</div>
<div class="line"><a id="l05339" name="l05339"></a><span class="lineno"> 5339</span>    con_fvirt = con_fvirt_model</div>
<div class="line"><a id="l05340" name="l05340"></a><span class="lineno"> 5340</span>    one_minus_con_eps = 1.0_kind_lake - con_eps</div>
<div class="line"><a id="l05341" name="l05341"></a><span class="lineno"> 5341</span> </div>
<div class="line"><a id="l05342" name="l05342"></a><span class="lineno"> 5342</span>    <span class="comment">!  dzlak(1) = 0.1_kind_lake</span></div>
<div class="line"><a id="l05343" name="l05343"></a><span class="lineno"> 5343</span>    <span class="comment">!  dzlak(2) = 1._kind_lake</span></div>
<div class="line"><a id="l05344" name="l05344"></a><span class="lineno"> 5344</span>    <span class="comment">!  dzlak(3) = 2._kind_lake</span></div>
<div class="line"><a id="l05345" name="l05345"></a><span class="lineno"> 5345</span>    <span class="comment">!  dzlak(4) = 3._kind_lake</span></div>
<div class="line"><a id="l05346" name="l05346"></a><span class="lineno"> 5346</span>    <span class="comment">!  dzlak(5) = 4._kind_lake</span></div>
<div class="line"><a id="l05347" name="l05347"></a><span class="lineno"> 5347</span>    <span class="comment">!  dzlak(6) = 5._kind_lake</span></div>
<div class="line"><a id="l05348" name="l05348"></a><span class="lineno"> 5348</span>    <span class="comment">!  dzlak(7) = 7._kind_lake</span></div>
<div class="line"><a id="l05349" name="l05349"></a><span class="lineno"> 5349</span>    <span class="comment">!  dzlak(8) = 7._kind_lake</span></div>
<div class="line"><a id="l05350" name="l05350"></a><span class="lineno"> 5350</span>    <span class="comment">!  dzlak(9) = 10.45_kind_lake</span></div>
<div class="line"><a id="l05351" name="l05351"></a><span class="lineno"> 5351</span>    <span class="comment">!  dzlak(10)= 10.45_kind_lake</span></div>
<div class="line"><a id="l05352" name="l05352"></a><span class="lineno"> 5352</span>    <span class="comment">!</span></div>
<div class="line"><a id="l05353" name="l05353"></a><span class="lineno"> 5353</span>    <span class="comment">!  zlak(1) =  0.05_kind_lake</span></div>
<div class="line"><a id="l05354" name="l05354"></a><span class="lineno"> 5354</span>    <span class="comment">!  zlak(2) =  0.6_kind_lake</span></div>
<div class="line"><a id="l05355" name="l05355"></a><span class="lineno"> 5355</span>    <span class="comment">!  zlak(3) =  2.1_kind_lake</span></div>
<div class="line"><a id="l05356" name="l05356"></a><span class="lineno"> 5356</span>    <span class="comment">!  zlak(4) =  4.6_kind_lake</span></div>
<div class="line"><a id="l05357" name="l05357"></a><span class="lineno"> 5357</span>    <span class="comment">!  zlak(5) =  8.1_kind_lake</span></div>
<div class="line"><a id="l05358" name="l05358"></a><span class="lineno"> 5358</span>    <span class="comment">!  zlak(6) = 12.6_kind_lake</span></div>
<div class="line"><a id="l05359" name="l05359"></a><span class="lineno"> 5359</span>    <span class="comment">!  zlak(7) = 18.6_kind_lake</span></div>
<div class="line"><a id="l05360" name="l05360"></a><span class="lineno"> 5360</span>    <span class="comment">!  zlak(8) = 25.6_kind_lake</span></div>
<div class="line"><a id="l05361" name="l05361"></a><span class="lineno"> 5361</span>    <span class="comment">!  zlak(9) = 34.325_kind_lake</span></div>
<div class="line"><a id="l05362" name="l05362"></a><span class="lineno"> 5362</span>    <span class="comment">!  zlak(10)= 44.775_kind_lake</span></div>
<div class="line"><a id="l05363" name="l05363"></a><span class="lineno"> 5363</span>    dzlak(1) = 0.1_kind_lake</div>
<div class="line"><a id="l05364" name="l05364"></a><span class="lineno"> 5364</span>    dzlak(2) = 0.1_kind_lake</div>
<div class="line"><a id="l05365" name="l05365"></a><span class="lineno"> 5365</span>    dzlak(3) = 0.1_kind_lake</div>
<div class="line"><a id="l05366" name="l05366"></a><span class="lineno"> 5366</span>    dzlak(4) = 0.1_kind_lake</div>
<div class="line"><a id="l05367" name="l05367"></a><span class="lineno"> 5367</span>    dzlak(5) = 0.1_kind_lake</div>
<div class="line"><a id="l05368" name="l05368"></a><span class="lineno"> 5368</span>    dzlak(6) = 0.1_kind_lake</div>
<div class="line"><a id="l05369" name="l05369"></a><span class="lineno"> 5369</span>    dzlak(7) = 0.1_kind_lake</div>
<div class="line"><a id="l05370" name="l05370"></a><span class="lineno"> 5370</span>    dzlak(8) = 0.1_kind_lake</div>
<div class="line"><a id="l05371" name="l05371"></a><span class="lineno"> 5371</span>    dzlak(9) = 0.1_kind_lake</div>
<div class="line"><a id="l05372" name="l05372"></a><span class="lineno"> 5372</span>    dzlak(10)= 0.1_kind_lake</div>
<div class="line"><a id="l05373" name="l05373"></a><span class="lineno"> 5373</span>    </div>
<div class="line"><a id="l05374" name="l05374"></a><span class="lineno"> 5374</span>    zlak(1) =  0.05_kind_lake</div>
<div class="line"><a id="l05375" name="l05375"></a><span class="lineno"> 5375</span>    zlak(2) =  0.15_kind_lake</div>
<div class="line"><a id="l05376" name="l05376"></a><span class="lineno"> 5376</span>    zlak(3) =  0.25_kind_lake</div>
<div class="line"><a id="l05377" name="l05377"></a><span class="lineno"> 5377</span>    zlak(4) =  0.35_kind_lake</div>
<div class="line"><a id="l05378" name="l05378"></a><span class="lineno"> 5378</span>    zlak(5) =  0.45_kind_lake</div>
<div class="line"><a id="l05379" name="l05379"></a><span class="lineno"> 5379</span>    zlak(6) = 0.55_kind_lake</div>
<div class="line"><a id="l05380" name="l05380"></a><span class="lineno"> 5380</span>    zlak(7) = 0.65_kind_lake</div>
<div class="line"><a id="l05381" name="l05381"></a><span class="lineno"> 5381</span>    zlak(8) = 0.75_kind_lake</div>
<div class="line"><a id="l05382" name="l05382"></a><span class="lineno"> 5382</span>    zlak(9) = 0.85_kind_lake</div>
<div class="line"><a id="l05383" name="l05383"></a><span class="lineno"> 5383</span>    zlak(10)= 0.95_kind_lake</div>
<div class="line"><a id="l05384" name="l05384"></a><span class="lineno"> 5384</span> </div>
<div class="line"><a id="l05385" name="l05385"></a><span class="lineno"> 5385</span>   <span class="comment">! &quot;0&quot; refers to soil surface and &quot;nlevsoil&quot; refers to the bottom of model soil</span></div>
<div class="line"><a id="l05386" name="l05386"></a><span class="lineno"> 5386</span> </div>
<div class="line"><a id="l05387" name="l05387"></a><span class="lineno"> 5387</span>   <span class="keywordflow">do</span> j = 1, nlevsoil</div>
<div class="line"><a id="l05388" name="l05388"></a><span class="lineno"> 5388</span>      zsoi(j) = scalez*(exp(0.5_kind_lake*(j-0.5_kind_lake))-1._kind_lake)    <span class="comment">!node depths</span></div>
<div class="line"><a id="l05389" name="l05389"></a><span class="lineno"> 5389</span><span class="keywordflow">   enddo</span></div>
<div class="line"><a id="l05390" name="l05390"></a><span class="lineno"> 5390</span> </div>
<div class="line"><a id="l05391" name="l05391"></a><span class="lineno"> 5391</span>   dzsoi(1) = 0.5_kind_lake*(zsoi(1)+zsoi(2))             <span class="comment">!thickness b/n two interfaces</span></div>
<div class="line"><a id="l05392" name="l05392"></a><span class="lineno"> 5392</span>   <span class="keywordflow">do</span> j = 2,nlevsoil-1</div>
<div class="line"><a id="l05393" name="l05393"></a><span class="lineno"> 5393</span>      dzsoi(j)= 0.5_kind_lake*(zsoi(j+1)-zsoi(j-1))</div>
<div class="line"><a id="l05394" name="l05394"></a><span class="lineno"> 5394</span><span class="keywordflow">   enddo</span></div>
<div class="line"><a id="l05395" name="l05395"></a><span class="lineno"> 5395</span>   dzsoi(nlevsoil) = zsoi(nlevsoil)-zsoi(nlevsoil-1)</div>
<div class="line"><a id="l05396" name="l05396"></a><span class="lineno"> 5396</span> </div>
<div class="line"><a id="l05397" name="l05397"></a><span class="lineno"> 5397</span>   zisoi(0) = 0._kind_lake</div>
<div class="line"><a id="l05398" name="l05398"></a><span class="lineno"> 5398</span>   <span class="keywordflow">do</span> j = 1, nlevsoil-1</div>
<div class="line"><a id="l05399" name="l05399"></a><span class="lineno"> 5399</span>      zisoi(j) = 0.5_kind_lake*(zsoi(j)+zsoi(j+1))         <span class="comment">!interface depths</span></div>
<div class="line"><a id="l05400" name="l05400"></a><span class="lineno"> 5400</span><span class="keywordflow">   enddo</span></div>
<div class="line"><a id="l05401" name="l05401"></a><span class="lineno"> 5401</span>   zisoi(nlevsoil) = zsoi(nlevsoil) + 0.5_kind_lake*dzsoi(nlevsoil)</div>
<div class="line"><a id="l05402" name="l05402"></a><span class="lineno"> 5402</span> </div>
</div>
<div class="line"><a id="l05403" name="l05403"></a><span class="lineno"> 5403</span>  <span class="keyword">end subroutine </span>clm_lake_init</div>
<div class="line"><a id="l05404" name="l05404"></a><span class="lineno"> 5404</span> </div>
<div class="foldopen" id="foldopen05405" data-start="" data-end="">
<div class="line"><a id="l05405" name="l05405"></a><span class="lineno"><a class="line" href="namespaceclm__lake_aeb141e2eb715942fd77069893b4bdbff.html#aeb141e2eb715942fd77069893b4bdbff"> 5405</a></span> <span class="keyword">SUBROUTINE </span>lakeini(kdt,            ISLTYP,          gt0,             snowd,          &amp; !i</div>
<div class="line"><a id="l05406" name="l05406"></a><span class="lineno"> 5406</span>                    weasd,                           lakedepth_default,  fhour,       &amp;</div>
<div class="line"><a id="l05407" name="l05407"></a><span class="lineno"> 5407</span>                    oro_lakedepth,  savedtke12d,     snowdp2d,        h2osno2d,       &amp; !o</div>
<div class="line"><a id="l05408" name="l05408"></a><span class="lineno"> 5408</span>                    snl2d,          t_grnd2d,        t_lake3d,        lake_icefrac3d, &amp;</div>
<div class="line"><a id="l05409" name="l05409"></a><span class="lineno"> 5409</span>                                                     t_soisno3d,      h2osoi_ice3d,   &amp;</div>
<div class="line"><a id="l05410" name="l05410"></a><span class="lineno"> 5410</span>                    h2osoi_liq3d,   h2osoi_vol3d,    z3d,             dz3d,           &amp;</div>
<div class="line"><a id="l05411" name="l05411"></a><span class="lineno"> 5411</span>                    zi3d,                                                             &amp;</div>
<div class="line"><a id="l05412" name="l05412"></a><span class="lineno"> 5412</span>                    fice,           hice,            min_lakeice,     tsfc,           &amp;</div>
<div class="line"><a id="l05413" name="l05413"></a><span class="lineno"> 5413</span>                    use_lake_model, use_lakedepth,                                    &amp;</div>
<div class="line"><a id="l05414" name="l05414"></a><span class="lineno"> 5414</span>                                                     im,              prsi,           &amp;</div>
<div class="line"><a id="l05415" name="l05415"></a><span class="lineno"> 5415</span>                    xlat_d,         xlon_d,          clm_lake_initialized,            &amp;</div>
<div class="line"><a id="l05416" name="l05416"></a><span class="lineno"> 5416</span>                    input_lakedepth,                 tg3,             clm_lakedepth,  &amp;</div>
<div class="line"><a id="l05417" name="l05417"></a><span class="lineno"> 5417</span>                    km,   me,       master,          errmsg,          errflg)</div>
<div class="line"><a id="l05418" name="l05418"></a><span class="lineno"> 5418</span><span class="comment"></span> </div>
<div class="line"><a id="l05419" name="l05419"></a><span class="lineno"> 5419</span><span class="comment">   !&gt; Some fields in lakeini are not available during initialization,</span></div>
<div class="line"><a id="l05420" name="l05420"></a><span class="lineno"> 5420</span><span class="comment">   !! so clm_lake_init cannot complete the initialization. What is not</span></div>
<div class="line"><a id="l05421" name="l05421"></a><span class="lineno"> 5421</span><span class="comment">   !! in clm_lake_init, is initialized in lakeini on points where</span></div>
<div class="line"><a id="l05422" name="l05422"></a><span class="lineno"> 5422</span><span class="comment">   !! use_lake_model(i)&gt;0. The clm_lake_initialized(i) guards against</span></div>
<div class="line"><a id="l05423" name="l05423"></a><span class="lineno"> 5423</span><span class="comment">   !! initializing a point twice.  For that to work,</span></div>
<div class="line"><a id="l05424" name="l05424"></a><span class="lineno"> 5424</span><span class="comment">   !! clm_lake_initialized must be a restart variable.</span></div>
<div class="line"><a id="l05425" name="l05425"></a><span class="lineno"> 5425</span> </div>
<div class="line"><a id="l05426" name="l05426"></a><span class="lineno"> 5426</span>   <span class="comment">!==============================================================================</span></div>
<div class="line"><a id="l05427" name="l05427"></a><span class="lineno"> 5427</span>   <span class="comment">! This subroutine was first edited by Hongping Gu for coupling</span></div>
<div class="line"><a id="l05428" name="l05428"></a><span class="lineno"> 5428</span>   <span class="comment">! 07/20/2010</span></div>
<div class="line"><a id="l05429" name="l05429"></a><span class="lineno"> 5429</span>   <span class="comment">! Long after, in June 2022, Sam Trahan updated it for CCPP</span></div>
<div class="line"><a id="l05430" name="l05430"></a><span class="lineno"> 5430</span>   <span class="comment">!==============================================================================</span></div>
<div class="line"><a id="l05431" name="l05431"></a><span class="lineno"> 5431</span> </div>
<div class="line"><a id="l05432" name="l05432"></a><span class="lineno"> 5432</span>  <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l05433" name="l05433"></a><span class="lineno"> 5433</span> </div>
<div class="line"><a id="l05434" name="l05434"></a><span class="lineno"> 5434</span>  <span class="keywordtype">INTEGER</span>, <span class="keywordtype">INTENT(OUT)</span> :: errflg</div>
<div class="line"><a id="l05435" name="l05435"></a><span class="lineno"> 5435</span>  <span class="keywordtype">CHARACTER(*)</span>, <span class="keywordtype">INTENT(OUT)</span> :: errmsg</div>
<div class="line"><a id="l05436" name="l05436"></a><span class="lineno"> 5436</span> </div>
<div class="line"><a id="l05437" name="l05437"></a><span class="lineno"> 5437</span>  <span class="keywordtype">INTEGER</span> , <span class="keywordtype">INTENT (IN)</span>    :: im, me, master, km, kdt</div>
<div class="line"><a id="l05438" name="l05438"></a><span class="lineno"> 5438</span><span class="keywordtype">  REAL</span>(KIND_PHYS),     <span class="keywordtype">INTENT(IN)</span>  :: min_lakeice, fhour</div>
<div class="line"><a id="l05439" name="l05439"></a><span class="lineno"> 5439</span><span class="keywordtype">  REAL</span>(KIND_PHYS), <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(INOUT)</span>::   FICE, hice</div>
<div class="line"><a id="l05440" name="l05440"></a><span class="lineno"> 5440</span><span class="keywordtype">  REAL</span>(KIND_PHYS), <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(IN)</span>::   TG3, xlat_d, xlon_d</div>
<div class="line"><a id="l05441" name="l05441"></a><span class="lineno"> 5441</span><span class="keywordtype">  REAL</span>(KIND_PHYS), <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(IN)</span>::     tsfc</div>
<div class="line"><a id="l05442" name="l05442"></a><span class="lineno"> 5442</span><span class="keywordtype">  REAL</span>(KIND_PHYS), <span class="keywordtype">DIMENSION(:)</span>  ,<span class="keywordtype">INTENT(INOUT)</span>  :: clm_lake_initialized</div>
<div class="line"><a id="l05443" name="l05443"></a><span class="lineno"> 5443</span>  <span class="keywordtype">integer</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span> :: use_lake_model</div>
<div class="line"><a id="l05444" name="l05444"></a><span class="lineno"> 5444</span>  <span class="keywordtype">LOGICAL</span>, <span class="keywordtype">INTENT (IN)</span> ::   use_lakedepth</div>
<div class="line"><a id="l05445" name="l05445"></a><span class="lineno"> 5445</span> </div>
<div class="line"><a id="l05446" name="l05446"></a><span class="lineno"> 5446</span>  <span class="keywordtype">INTEGER</span>, <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(IN)</span>       :: ISLTYP</div>
<div class="line"><a id="l05447" name="l05447"></a><span class="lineno"> 5447</span><span class="keywordtype">  REAL</span>(KIND_PHYS),    <span class="keywordtype">DIMENSION(:)</span>, <span class="keywordtype">INTENT(INOUT)</span>    :: snowd,weasd</div>
<div class="line"><a id="l05448" name="l05448"></a><span class="lineno"> 5448</span><span class="keywordtype">  REAL</span>(kind_phys),    <span class="keywordtype">DIMENSION(:,:)</span>, <span class="keywordtype">INTENT(IN)</span>       :: gt0</div>
<div class="line"><a id="l05449" name="l05449"></a><span class="lineno"> 5449</span><span class="keywordtype">  REAL</span>(kind_phys),    <span class="keywordtype">DIMENSION(:,:)</span>, <span class="keywordtype">INTENT(IN)</span>     :: prsi</div>
<div class="line"><a id="l05450" name="l05450"></a><span class="lineno"> 5450</span><span class="keywordtype">  real</span>(kind_phys),    <span class="keywordtype">intent(in)</span>                                      :: lakedepth_default</div>
<div class="line"><a id="l05451" name="l05451"></a><span class="lineno"> 5451</span> </div>
<div class="line"><a id="l05452" name="l05452"></a><span class="lineno"> 5452</span><span class="keywordtype">  real</span>(kind_phys),    <span class="keywordtype">dimension(:)</span>,<span class="keywordtype">intent(inout)</span>                          :: clm_lakedepth</div>
<div class="line"><a id="l05453" name="l05453"></a><span class="lineno"> 5453</span><span class="keywordtype">  real</span>(kind_phys),    <span class="keywordtype">dimension(:)</span>,<span class="keywordtype">intent(inout)</span>                          :: input_lakedepth</div>
<div class="line"><a id="l05454" name="l05454"></a><span class="lineno"> 5454</span><span class="keywordtype">  real</span>(kind_phys),    <span class="keywordtype">dimension(:)</span>,<span class="keywordtype">intent(in)</span>                             :: oro_lakedepth</div>
<div class="line"><a id="l05455" name="l05455"></a><span class="lineno"> 5455</span><span class="keywordtype">  real</span>(kind_phys),    <span class="keywordtype">dimension(:)</span>,<span class="keywordtype">intent(out)</span>                            :: savedtke12d</div>
<div class="line"><a id="l05456" name="l05456"></a><span class="lineno"> 5456</span><span class="keywordtype">  real</span>(kind_phys),    <span class="keywordtype">dimension(:)</span>,<span class="keywordtype">intent(out)</span>                            :: snowdp2d,       &amp;</div>
<div class="line"><a id="l05457" name="l05457"></a><span class="lineno"> 5457</span>                                                                             h2osno2d,       &amp;</div>
<div class="line"><a id="l05458" name="l05458"></a><span class="lineno"> 5458</span>                                                                             snl2d,          &amp;</div>
<div class="line"><a id="l05459" name="l05459"></a><span class="lineno"> 5459</span>                                                                             t_grnd2d</div>
<div class="line"><a id="l05460" name="l05460"></a><span class="lineno"> 5460</span>                                                                              </div>
<div class="line"><a id="l05461" name="l05461"></a><span class="lineno"> 5461</span><span class="keywordtype">  real</span>(kind_phys),    <span class="keywordtype">dimension(:,:)</span>,<span class="keywordtype">INTENT(out)</span>                          :: t_lake3d,       &amp;</div>
<div class="line"><a id="l05462" name="l05462"></a><span class="lineno"> 5462</span>                                                                             lake_icefrac3d</div>
<div class="line"><a id="l05463" name="l05463"></a><span class="lineno"> 5463</span><span class="keywordtype">  real</span>(kind_phys),    <span class="keywordtype">dimension(:,-nlevsnow+1:)</span>,<span class="keywordtype">INTENT(out)</span>               :: t_soisno3d,     &amp;</div>
<div class="line"><a id="l05464" name="l05464"></a><span class="lineno"> 5464</span>                                                                             h2osoi_ice3d,   &amp;</div>
<div class="line"><a id="l05465" name="l05465"></a><span class="lineno"> 5465</span>                                                                             h2osoi_liq3d,   &amp;</div>
<div class="line"><a id="l05466" name="l05466"></a><span class="lineno"> 5466</span>                                                                             h2osoi_vol3d,   &amp;</div>
<div class="line"><a id="l05467" name="l05467"></a><span class="lineno"> 5467</span>                                                                             z3d,            &amp;</div>
<div class="line"><a id="l05468" name="l05468"></a><span class="lineno"> 5468</span>                                                                             dz3d</div>
<div class="line"><a id="l05469" name="l05469"></a><span class="lineno"> 5469</span> </div>
<div class="line"><a id="l05470" name="l05470"></a><span class="lineno"> 5470</span><span class="keywordtype">  real</span>(kind_phys),    <span class="keywordtype">dimension(:,-nlevsnow+0:)</span>,<span class="keywordtype">INTENT(out)</span>   :: zi3d            </div>
<div class="line"><a id="l05471" name="l05471"></a><span class="lineno"> 5471</span> </div>
<div class="line"><a id="l05472" name="l05472"></a><span class="lineno"> 5472</span> </div>
<div class="line"><a id="l05473" name="l05473"></a><span class="lineno"> 5473</span>  <span class="keywordtype">integer</span>  :: n,i,j,k,ib,lev,bottom      <span class="comment">! indices</span></div>
<div class="line"><a id="l05474" name="l05474"></a><span class="lineno"> 5474</span><span class="keywordtype">  real</span>(kind_lake),<span class="keywordtype">dimension(1:im )</span>    :: bd2d               <span class="comment">! bulk density of dry soil material [kg/m^3]</span></div>
<div class="line"><a id="l05475" name="l05475"></a><span class="lineno"> 5475</span><span class="keywordtype">  real</span>(kind_lake),<span class="keywordtype">dimension(1:im )</span>    :: tkm2d              <span class="comment">! mineral conductivity</span></div>
<div class="line"><a id="l05476" name="l05476"></a><span class="lineno"> 5476</span><span class="keywordtype">  real</span>(kind_lake),<span class="keywordtype">dimension(1:im )</span>    :: xksat2d            <span class="comment">! maximum hydraulic conductivity of soil [mm/s]</span></div>
<div class="line"><a id="l05477" name="l05477"></a><span class="lineno"> 5477</span><span class="keywordtype">  real</span>(kind_lake),<span class="keywordtype">dimension(1:im )</span>    :: depthratio2d       <span class="comment">! ratio of lake depth to standard deep lake depth </span></div>
<div class="line"><a id="l05478" name="l05478"></a><span class="lineno"> 5478</span> </div>
<div class="line"><a id="l05479" name="l05479"></a><span class="lineno"> 5479</span>  <span class="keywordtype">logical</span>,<span class="keywordtype">parameter</span>        :: arbinit = .false.</div>
<div class="line"><a id="l05480" name="l05480"></a><span class="lineno"> 5480</span><span class="keywordtype">  real</span>(kind_lake),<span class="keywordtype">parameter</span>           :: defval  = -999.0</div>
<div class="line"><a id="l05481" name="l05481"></a><span class="lineno"> 5481</span>  <span class="keywordtype">integer</span>                  :: isl</div>
<div class="line"><a id="l05482" name="l05482"></a><span class="lineno"> 5482</span>  <span class="keywordtype">integer</span>                  :: numb_lak    <span class="comment">! for debug</span></div>
<div class="line"><a id="l05483" name="l05483"></a><span class="lineno"> 5483</span>  <span class="keywordtype">character*256</span> :: message</div>
<div class="line"><a id="l05484" name="l05484"></a><span class="lineno"> 5484</span><span class="keywordtype">  real</span>(kind_lake) :: ht</div>
<div class="line"><a id="l05485" name="l05485"></a><span class="lineno"> 5485</span><span class="keywordtype">  real</span>(kind_lake) :: rhosn</div>
<div class="line"><a id="l05486" name="l05486"></a><span class="lineno"> 5486</span><span class="keywordtype">  real</span>(kind_lake) :: depth, lakedepth</div>
<div class="line"><a id="l05487" name="l05487"></a><span class="lineno"> 5487</span> </div>
<div class="line"><a id="l05488" name="l05488"></a><span class="lineno"> 5488</span>  <span class="keywordtype">logical</span> :: climatology_limits</div>
<div class="line"><a id="l05489" name="l05489"></a><span class="lineno"> 5489</span> </div>
<div class="line"><a id="l05490" name="l05490"></a><span class="lineno"> 5490</span><span class="keywordtype">  real</span>(kind_lake)  :: z_lake(nlevlake)  <span class="comment">! layer depth for lake (m)</span></div>
<div class="line"><a id="l05491" name="l05491"></a><span class="lineno"> 5491</span><span class="keywordtype">  real</span>(kind_lake)  :: dz_lake(nlevlake)                  <span class="comment">! layer thickness for lake (m)</span></div>
<div class="line"><a id="l05492" name="l05492"></a><span class="lineno"> 5492</span> </div>
<div class="line"><a id="l05493" name="l05493"></a><span class="lineno"> 5493</span>  <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: xcheck=38</div>
<div class="line"><a id="l05494" name="l05494"></a><span class="lineno"> 5494</span>  <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span> :: ycheck=92</div>
<div class="line"><a id="l05495" name="l05495"></a><span class="lineno"> 5495</span> </div>
<div class="line"><a id="l05496" name="l05496"></a><span class="lineno"> 5496</span>  <span class="keywordtype">integer</span> :: used_lakedepth_default, init_points, month, julday</div>
<div class="line"><a id="l05497" name="l05497"></a><span class="lineno"> 5497</span>  <span class="keywordtype">integer</span> :: mon, iday, num2, num1, juld, day2, day1, wght1, wght2</div>
<div class="line"><a id="l05498" name="l05498"></a><span class="lineno"> 5498</span><span class="keywordtype">  real</span>(kind_lake) :: Tclim, watsat</div>
<div class="line"><a id="l05499" name="l05499"></a><span class="lineno"> 5499</span> </div>
<div class="line"><a id="l05500" name="l05500"></a><span class="lineno"> 5500</span>  used_lakedepth_default=0</div>
<div class="line"><a id="l05501" name="l05501"></a><span class="lineno"> 5501</span> </div>
<div class="line"><a id="l05502" name="l05502"></a><span class="lineno"> 5502</span>  errmsg = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a id="l05503" name="l05503"></a><span class="lineno"> 5503</span>  errflg = 0</div>
<div class="line"><a id="l05504" name="l05504"></a><span class="lineno"> 5504</span> </div>
<div class="line"><a id="l05505" name="l05505"></a><span class="lineno"> 5505</span>  <span class="comment">!!!!!!!!!!!!!!!!!!begin to initialize lake variables!!!!!!!!!!!!!!!!!!</span></div>
<div class="line"><a id="l05506" name="l05506"></a><span class="lineno"> 5506</span> </div>
<div class="line"><a id="l05507" name="l05507"></a><span class="lineno"> 5507</span>  init_points=0</div>
<div class="line"><a id="l05508" name="l05508"></a><span class="lineno"> 5508</span>  do_init: <span class="keywordflow">DO</span> i=1,im</div>
<div class="line"><a id="l05509" name="l05509"></a><span class="lineno"> 5509</span>    <span class="keywordflow">if</span>(use_lake_model(i)==0 .or. clm_lake_initialized(i)&gt;0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05510" name="l05510"></a><span class="lineno"> 5510</span>      cycle</div>
<div class="line"><a id="l05511" name="l05511"></a><span class="lineno"> 5511</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l05512" name="l05512"></a><span class="lineno"> 5512</span> </div>
<div class="line"><a id="l05513" name="l05513"></a><span class="lineno"> 5513</span>      <span class="comment">! To handle cold-start with bad lakedepth2d</span></div>
<div class="line"><a id="l05514" name="l05514"></a><span class="lineno"> 5514</span>      <span class="keywordflow">if</span> ( use_lakedepth ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05515" name="l05515"></a><span class="lineno"> 5515</span>        <span class="keywordflow">if</span> (oro_lakedepth(i) == 10.0 .or. oro_lakedepth(i) &lt;= 0.) <span class="keywordflow">then</span> </div>
<div class="line"><a id="l05516" name="l05516"></a><span class="lineno"> 5516</span>          <span class="comment">!- 10.0 is the fill value for lake depth, in this case set to default value</span></div>
<div class="line"><a id="l05517" name="l05517"></a><span class="lineno"> 5517</span>          clm_lakedepth(i)   = lakedepth_default</div>
<div class="line"><a id="l05518" name="l05518"></a><span class="lineno"> 5518</span>          used_lakedepth_default = used_lakedepth_default+1</div>
<div class="line"><a id="l05519" name="l05519"></a><span class="lineno"> 5519</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l05520" name="l05520"></a><span class="lineno"> 5520</span>          clm_lakedepth(i) = oro_lakedepth(i)</div>
<div class="line"><a id="l05521" name="l05521"></a><span class="lineno"> 5521</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l05522" name="l05522"></a><span class="lineno"> 5522</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05523" name="l05523"></a><span class="lineno"> 5523</span>        <span class="comment">!- all lakes are initialized with the default lake depth</span></div>
<div class="line"><a id="l05524" name="l05524"></a><span class="lineno"> 5524</span>        clm_lakedepth(i)   = lakedepth_default</div>
<div class="line"><a id="l05525" name="l05525"></a><span class="lineno"> 5525</span>        used_lakedepth_default = used_lakedepth_default+1</div>
<div class="line"><a id="l05526" name="l05526"></a><span class="lineno"> 5526</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l05527" name="l05527"></a><span class="lineno"> 5527</span>    </div>
<div class="line"><a id="l05528" name="l05528"></a><span class="lineno"> 5528</span>    <span class="keywordflow">if</span>(clm_lake_initialized(i)&gt;0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05529" name="l05529"></a><span class="lineno"> 5529</span>      cycle</div>
<div class="line"><a id="l05530" name="l05530"></a><span class="lineno"> 5530</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l05531" name="l05531"></a><span class="lineno"> 5531</span> </div>
<div class="line"><a id="l05532" name="l05532"></a><span class="lineno"> 5532</span>    input_lakedepth=clm_lakedepth</div>
<div class="line"><a id="l05533" name="l05533"></a><span class="lineno"> 5533</span> </div>
<div class="line"><a id="l05534" name="l05534"></a><span class="lineno"> 5534</span>    snl2d(i)                   = defval</div>
<div class="line"><a id="l05535" name="l05535"></a><span class="lineno"> 5535</span>    <span class="keywordflow">do</span> k = -nlevsnow+1,nlevsoil</div>
<div class="line"><a id="l05536" name="l05536"></a><span class="lineno"> 5536</span>        h2osoi_liq3d(i,k)      = defval</div>
<div class="line"><a id="l05537" name="l05537"></a><span class="lineno"> 5537</span>        h2osoi_ice3d(i,k)      = defval</div>
<div class="line"><a id="l05538" name="l05538"></a><span class="lineno"> 5538</span>        h2osoi_vol3d(i,k)      = defval</div>
<div class="line"><a id="l05539" name="l05539"></a><span class="lineno"> 5539</span>        t_soisno3d(i,k)        = defval</div>
<div class="line"><a id="l05540" name="l05540"></a><span class="lineno"> 5540</span>        z3d(i,k)               = defval </div>
<div class="line"><a id="l05541" name="l05541"></a><span class="lineno"> 5541</span>        dz3d(i,k)              = defval                           </div>
<div class="line"><a id="l05542" name="l05542"></a><span class="lineno"> 5542</span><span class="keywordflow">    enddo</span></div>
<div class="line"><a id="l05543" name="l05543"></a><span class="lineno"> 5543</span>    <span class="keywordflow">do</span> k = 1,nlevlake </div>
<div class="line"><a id="l05544" name="l05544"></a><span class="lineno"> 5544</span>        t_lake3d(i,k)          = defval</div>
<div class="line"><a id="l05545" name="l05545"></a><span class="lineno"> 5545</span>        lake_icefrac3d(i,k)    = defval</div>
<div class="line"><a id="l05546" name="l05546"></a><span class="lineno"> 5546</span><span class="keywordflow">    enddo</span></div>
<div class="line"><a id="l05547" name="l05547"></a><span class="lineno"> 5547</span>    </div>
<div class="line"><a id="l05548" name="l05548"></a><span class="lineno"> 5548</span>    <span class="keywordflow">if</span> (use_lake_model(i) == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05549" name="l05549"></a><span class="lineno"> 5549</span>    <span class="comment">!  for lake points only</span></div>
<div class="line"><a id="l05550" name="l05550"></a><span class="lineno"> 5550</span>      z3d(i,:)             = 0.0</div>
<div class="line"><a id="l05551" name="l05551"></a><span class="lineno"> 5551</span>      dz3d(i,:)            = 0.0</div>
<div class="line"><a id="l05552" name="l05552"></a><span class="lineno"> 5552</span>      zi3d(i,:)            = 0.0</div>
<div class="line"><a id="l05553" name="l05553"></a><span class="lineno"> 5553</span>      h2osoi_liq3d(i,:)    = 0.0</div>
<div class="line"><a id="l05554" name="l05554"></a><span class="lineno"> 5554</span>      h2osoi_ice3d(i,:)    = 0.0</div>
<div class="line"><a id="l05555" name="l05555"></a><span class="lineno"> 5555</span>      lake_icefrac3d(i,:)  = 0.0</div>
<div class="line"><a id="l05556" name="l05556"></a><span class="lineno"> 5556</span>      h2osoi_vol3d(i,:)    = 0.0</div>
<div class="line"><a id="l05557" name="l05557"></a><span class="lineno"> 5557</span>      snl2d(i)             = 0.0</div>
<div class="line"><a id="l05558" name="l05558"></a><span class="lineno"> 5558</span> </div>
<div class="line"><a id="l05559" name="l05559"></a><span class="lineno"> 5559</span>      <span class="keywordflow">if</span>(fice(i)&gt;min_lakeice) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05560" name="l05560"></a><span class="lineno"> 5560</span>        lake_icefrac3d(i,1) = fice(i)</div>
<div class="line"><a id="l05561" name="l05561"></a><span class="lineno"> 5561</span>        snowdp2d(i)         = snowd(i)*1e-3   <span class="comment">! SNOW in kg/m^2 and snowdp in m</span></div>
<div class="line"><a id="l05562" name="l05562"></a><span class="lineno"> 5562</span>        h2osno2d(i)         = weasd(i)   <span class="comment">! mm </span></div>
<div class="line"><a id="l05563" name="l05563"></a><span class="lineno"> 5563</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05564" name="l05564"></a><span class="lineno"> 5564</span>        fice(i)             = 0.</div>
<div class="line"><a id="l05565" name="l05565"></a><span class="lineno"> 5565</span>        snowd(i)            = 0.</div>
<div class="line"><a id="l05566" name="l05566"></a><span class="lineno"> 5566</span>        weasd(i)            = 0.</div>
<div class="line"><a id="l05567" name="l05567"></a><span class="lineno"> 5567</span>        snowdp2d(i)         = 0.</div>
<div class="line"><a id="l05568" name="l05568"></a><span class="lineno"> 5568</span>        h2osno2d(i)         = 0.</div>
<div class="line"><a id="l05569" name="l05569"></a><span class="lineno"> 5569</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l05570" name="l05570"></a><span class="lineno"> 5570</span>    </div>
<div class="line"><a id="l05571" name="l05571"></a><span class="lineno"> 5571</span>    <span class="comment">! Soil hydraulic and thermal properties</span></div>
<div class="line"><a id="l05572" name="l05572"></a><span class="lineno"> 5572</span>    isl = isltyp(i)   </div>
<div class="line"><a id="l05573" name="l05573"></a><span class="lineno"> 5573</span>    <span class="keywordflow">if</span> (isl == 0  ) isl = 14</div>
<div class="line"><a id="l05574" name="l05574"></a><span class="lineno"> 5574</span>    <span class="keywordflow">if</span> (isl == 14 ) isl = isl + 1 </div>
<div class="line"><a id="l05575" name="l05575"></a><span class="lineno"> 5575</span> </div>
<div class="line"><a id="l05576" name="l05576"></a><span class="lineno"> 5576</span>    <span class="keyword">call </span>calculate_z_dz_lake(i,input_lakedepth,clm_lakedepth,z_lake,dz_lake)</div>
<div class="line"><a id="l05577" name="l05577"></a><span class="lineno"> 5577</span> </div>
<div class="line"><a id="l05578" name="l05578"></a><span class="lineno"> 5578</span>    z3d(i,1:nlevsoil) = zsoi(1:nlevsoil)</div>
<div class="line"><a id="l05579" name="l05579"></a><span class="lineno"> 5579</span>    zi3d(i,0:nlevsoil) = zisoi(0:nlevsoil)</div>
<div class="line"><a id="l05580" name="l05580"></a><span class="lineno"> 5580</span>    dz3d(i,1:nlevsoil) = dzsoi(1:nlevsoil)</div>
<div class="line"><a id="l05581" name="l05581"></a><span class="lineno"> 5581</span>    savedtke12d(i) = tkwat <span class="comment">! Initialize for first timestep.</span></div>
<div class="line"><a id="l05582" name="l05582"></a><span class="lineno"> 5582</span> </div>
<div class="line"><a id="l05583" name="l05583"></a><span class="lineno"> 5583</span> </div>
<div class="line"><a id="l05584" name="l05584"></a><span class="lineno"> 5584</span>    <span class="keywordflow">if</span> (snowdp2d(i) &lt; 0.01_kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05585" name="l05585"></a><span class="lineno"> 5585</span>      snl2d(i) = 0</div>
<div class="line"><a id="l05586" name="l05586"></a><span class="lineno"> 5586</span>      dz3d(i,-nlevsnow+1:0) = 0._kind_lake</div>
<div class="line"><a id="l05587" name="l05587"></a><span class="lineno"> 5587</span>      z3d(i,-nlevsnow+1:0) = 0._kind_lake</div>
<div class="line"><a id="l05588" name="l05588"></a><span class="lineno"> 5588</span>      zi3d(i,-nlevsnow+0:0) = 0._kind_lake</div>
<div class="line"><a id="l05589" name="l05589"></a><span class="lineno"> 5589</span>    <span class="keywordflow">else</span></div>
<div class="line"><a id="l05590" name="l05590"></a><span class="lineno"> 5590</span>      <span class="keywordflow">if</span> ((snowdp2d(i) &gt;= 0.01_kind_lake) .and. (snowdp2d(i) &lt;= 0.03_kind_lake)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05591" name="l05591"></a><span class="lineno"> 5591</span>        snl2d(i) = -1</div>
<div class="line"><a id="l05592" name="l05592"></a><span class="lineno"> 5592</span>        dz3d(i,0)  = snowdp2d(i)</div>
<div class="line"><a id="l05593" name="l05593"></a><span class="lineno"> 5593</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((snowdp2d(i) &gt; 0.03_kind_lake) .and. (snowdp2d(i) &lt;= 0.04_kind_lake)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05594" name="l05594"></a><span class="lineno"> 5594</span>        snl2d(i) = -2</div>
<div class="line"><a id="l05595" name="l05595"></a><span class="lineno"> 5595</span>        dz3d(i,-1) = snowdp2d(i)*0.5_kind_lake</div>
<div class="line"><a id="l05596" name="l05596"></a><span class="lineno"> 5596</span>        dz3d(i, 0) = dz3d(i,-1)</div>
<div class="line"><a id="l05597" name="l05597"></a><span class="lineno"> 5597</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((snowdp2d(i) &gt; 0.04_kind_lake) .and. (snowdp2d(i) &lt;= 0.07_kind_lake)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05598" name="l05598"></a><span class="lineno"> 5598</span>        snl2d(i) = -2</div>
<div class="line"><a id="l05599" name="l05599"></a><span class="lineno"> 5599</span>        dz3d(i,-1) = 0.02_kind_lake</div>
<div class="line"><a id="l05600" name="l05600"></a><span class="lineno"> 5600</span>        dz3d(i, 0) = snowdp2d(i) - dz3d(i,-1)</div>
<div class="line"><a id="l05601" name="l05601"></a><span class="lineno"> 5601</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((snowdp2d(i) &gt; 0.07_kind_lake) .and. (snowdp2d(i) &lt;= 0.12_kind_lake)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05602" name="l05602"></a><span class="lineno"> 5602</span>        snl2d(i) = -3</div>
<div class="line"><a id="l05603" name="l05603"></a><span class="lineno"> 5603</span>        dz3d(i,-2) = 0.02_kind_lake</div>
<div class="line"><a id="l05604" name="l05604"></a><span class="lineno"> 5604</span>        dz3d(i,-1) = (snowdp2d(i) - 0.02_kind_lake)*0.5_kind_lake</div>
<div class="line"><a id="l05605" name="l05605"></a><span class="lineno"> 5605</span>        dz3d(i, 0) = dz3d(i,-1)</div>
<div class="line"><a id="l05606" name="l05606"></a><span class="lineno"> 5606</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((snowdp2d(i) &gt; 0.12_kind_lake) .and. (snowdp2d(i) &lt;= 0.18_kind_lake)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05607" name="l05607"></a><span class="lineno"> 5607</span>        snl2d(i) = -3</div>
<div class="line"><a id="l05608" name="l05608"></a><span class="lineno"> 5608</span>        dz3d(i,-2) = 0.02_kind_lake</div>
<div class="line"><a id="l05609" name="l05609"></a><span class="lineno"> 5609</span>        dz3d(i,-1) = 0.05_kind_lake</div>
<div class="line"><a id="l05610" name="l05610"></a><span class="lineno"> 5610</span>        dz3d(i, 0) = snowdp2d(i) - dz3d(i,-2) - dz3d(i,-1)</div>
<div class="line"><a id="l05611" name="l05611"></a><span class="lineno"> 5611</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((snowdp2d(i) &gt; 0.18_kind_lake) .and. (snowdp2d(i) &lt;= 0.29_kind_lake)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05612" name="l05612"></a><span class="lineno"> 5612</span>        snl2d(i) = -4</div>
<div class="line"><a id="l05613" name="l05613"></a><span class="lineno"> 5613</span>        dz3d(i,-3) = 0.02_kind_lake</div>
<div class="line"><a id="l05614" name="l05614"></a><span class="lineno"> 5614</span>        dz3d(i,-2) = 0.05_kind_lake</div>
<div class="line"><a id="l05615" name="l05615"></a><span class="lineno"> 5615</span>        dz3d(i,-1) = (snowdp2d(i) - dz3d(i,-3) - dz3d(i,-2))*0.5_kind_lake</div>
<div class="line"><a id="l05616" name="l05616"></a><span class="lineno"> 5616</span>        dz3d(i, 0) = dz3d(i,-1)</div>
<div class="line"><a id="l05617" name="l05617"></a><span class="lineno"> 5617</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((snowdp2d(i) &gt; 0.29_kind_lake) .and. (snowdp2d(i) &lt;= 0.41_kind_lake)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05618" name="l05618"></a><span class="lineno"> 5618</span>        snl2d(i) = -4</div>
<div class="line"><a id="l05619" name="l05619"></a><span class="lineno"> 5619</span>        dz3d(i,-3) = 0.02_kind_lake</div>
<div class="line"><a id="l05620" name="l05620"></a><span class="lineno"> 5620</span>        dz3d(i,-2) = 0.05_kind_lake</div>
<div class="line"><a id="l05621" name="l05621"></a><span class="lineno"> 5621</span>        dz3d(i,-1) = 0.11_kind_lake</div>
<div class="line"><a id="l05622" name="l05622"></a><span class="lineno"> 5622</span>        dz3d(i, 0) = snowdp2d(i) - dz3d(i,-3) - dz3d(i,-2) - dz3d(i,-1)</div>
<div class="line"><a id="l05623" name="l05623"></a><span class="lineno"> 5623</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((snowdp2d(i) &gt; 0.41_kind_lake) .and. (snowdp2d(i) &lt;= 0.64_kind_lake)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05624" name="l05624"></a><span class="lineno"> 5624</span>        snl2d(i) = -5</div>
<div class="line"><a id="l05625" name="l05625"></a><span class="lineno"> 5625</span>        dz3d(i,-4) = 0.02_kind_lake</div>
<div class="line"><a id="l05626" name="l05626"></a><span class="lineno"> 5626</span>        dz3d(i,-3) = 0.05_kind_lake</div>
<div class="line"><a id="l05627" name="l05627"></a><span class="lineno"> 5627</span>        dz3d(i,-2) = 0.11_kind_lake</div>
<div class="line"><a id="l05628" name="l05628"></a><span class="lineno"> 5628</span>        dz3d(i,-1) = (snowdp2d(i) - dz3d(i,-4) - dz3d(i,-3) - dz3d(i,-2))*0.5_kind_lake</div>
<div class="line"><a id="l05629" name="l05629"></a><span class="lineno"> 5629</span>        dz3d(i, 0) = dz3d(i,-1)</div>
<div class="line"><a id="l05630" name="l05630"></a><span class="lineno"> 5630</span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (snowdp2d(i) &gt; 0.64_kind_lake) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05631" name="l05631"></a><span class="lineno"> 5631</span>        snl2d(i) = -5</div>
<div class="line"><a id="l05632" name="l05632"></a><span class="lineno"> 5632</span>        dz3d(i,-4) = 0.02_kind_lake</div>
<div class="line"><a id="l05633" name="l05633"></a><span class="lineno"> 5633</span>        dz3d(i,-3) = 0.05_kind_lake</div>
<div class="line"><a id="l05634" name="l05634"></a><span class="lineno"> 5634</span>        dz3d(i,-2) = 0.11_kind_lake</div>
<div class="line"><a id="l05635" name="l05635"></a><span class="lineno"> 5635</span>        dz3d(i,-1) = 0.23_kind_lake</div>
<div class="line"><a id="l05636" name="l05636"></a><span class="lineno"> 5636</span>        dz3d(i, 0)=snowdp2d(i)-dz3d(i,-4)-dz3d(i,-3)-dz3d(i,-2)-dz3d(i,-1)</div>
<div class="line"><a id="l05637" name="l05637"></a><span class="lineno"> 5637</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l05638" name="l05638"></a><span class="lineno"> 5638</span><span class="keywordflow">    end if</span></div>
<div class="line"><a id="l05639" name="l05639"></a><span class="lineno"> 5639</span> </div>
<div class="line"><a id="l05640" name="l05640"></a><span class="lineno"> 5640</span>    <span class="keywordflow">do</span> k = 0, nint(snl2d(i)+1), -1</div>
<div class="line"><a id="l05641" name="l05641"></a><span class="lineno"> 5641</span>      z3d(i,k)    = zi3d(i,k) - 0.5_kind_lake*dz3d(i,k)</div>
<div class="line"><a id="l05642" name="l05642"></a><span class="lineno"> 5642</span>      zi3d(i,k-1) = zi3d(i,k) - dz3d(i,k)</div>
<div class="line"><a id="l05643" name="l05643"></a><span class="lineno"> 5643</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l05644" name="l05644"></a><span class="lineno"> 5644</span> </div>
<div class="line"><a id="l05645" name="l05645"></a><span class="lineno"> 5645</span>    <span class="comment">! 3:subroutine makearbinit</span></div>
<div class="line"><a id="l05646" name="l05646"></a><span class="lineno"> 5646</span> </div>
<div class="line"><a id="l05647" name="l05647"></a><span class="lineno"> 5647</span>     <span class="comment">! initial t_lake3d here</span></div>
<div class="line"><a id="l05648" name="l05648"></a><span class="lineno"> 5648</span>     <span class="keywordflow">if</span>(tsfc(i)&lt;160) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05649" name="l05649"></a><span class="lineno"> 5649</span>       <span class="keyword">write</span>(errmsg,<span class="stringliteral">&#39;(A,F20.12,A)&#39;</span>) <span class="stringliteral">&#39;Invalid tsfc value &#39;</span>,tsfc(i),<span class="stringliteral">&#39; found. Was tsfc not initialized?&#39;</span></div>
<div class="line"><a id="l05650" name="l05650"></a><span class="lineno"> 5650</span>       <span class="keyword">write</span>(0,<span class="stringliteral">&#39;(A)&#39;</span>) trim(errmsg)</div>
<div class="line"><a id="l05651" name="l05651"></a><span class="lineno"> 5651</span>       errflg=1</div>
<div class="line"><a id="l05652" name="l05652"></a><span class="lineno"> 5652</span>       <span class="keywordflow">return</span></div>
<div class="line"><a id="l05653" name="l05653"></a><span class="lineno"> 5653</span><span class="keywordflow">     endif</span></div>
<div class="line"><a id="l05654" name="l05654"></a><span class="lineno"> 5654</span> </div>
<div class="line"><a id="l05655" name="l05655"></a><span class="lineno"> 5655</span>     <span class="keywordflow">if</span>(lake_icefrac3d(i,1) &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05656" name="l05656"></a><span class="lineno"> 5656</span>       depth = 0.</div>
<div class="line"><a id="l05657" name="l05657"></a><span class="lineno"> 5657</span>       <span class="keywordflow">do</span> k=2,nlevlake</div>
<div class="line"><a id="l05658" name="l05658"></a><span class="lineno"> 5658</span>         depth = depth + dz_lake(k)</div>
<div class="line"><a id="l05659" name="l05659"></a><span class="lineno"> 5659</span>         <span class="keywordflow">if</span>(hice(i) &gt;= depth) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05660" name="l05660"></a><span class="lineno"> 5660</span>           lake_icefrac3d(i,k) = max(0.,lake_icefrac3d(i,1)+(0.-lake_icefrac3d(i,1))/z_lake(nlevlake)*depth)</div>
<div class="line"><a id="l05661" name="l05661"></a><span class="lineno"> 5661</span>         <span class="keywordflow">else</span></div>
<div class="line"><a id="l05662" name="l05662"></a><span class="lineno"> 5662</span>           lake_icefrac3d(i,k) = 0.</div>
<div class="line"><a id="l05663" name="l05663"></a><span class="lineno"> 5663</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l05664" name="l05664"></a><span class="lineno"> 5664</span><span class="keywordflow">       end do</span></div>
<div class="line"><a id="l05665" name="l05665"></a><span class="lineno"> 5665</span><span class="keywordflow">     endif</span></div>
<div class="line"><a id="l05666" name="l05666"></a><span class="lineno"> 5666</span> </div>
<div class="line"><a id="l05667" name="l05667"></a><span class="lineno"> 5667</span>     t_lake3d(i,1)        = tsfc(i)</div>
<div class="line"><a id="l05668" name="l05668"></a><span class="lineno"> 5668</span>     t_grnd2d(i)          = tsfc(i)</div>
<div class="line"><a id="l05669" name="l05669"></a><span class="lineno"> 5669</span>     <span class="keywordflow">if</span> (lake_icefrac3d(i,1) &lt;= 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05670" name="l05670"></a><span class="lineno"> 5670</span>       t_lake3d(i,1)        = max(tfrz,tsfc(i))</div>
<div class="line"><a id="l05671" name="l05671"></a><span class="lineno"> 5671</span>       t_grnd2d(i)          = max(tfrz,tsfc(i))</div>
<div class="line"><a id="l05672" name="l05672"></a><span class="lineno"> 5672</span><span class="keywordflow">     endif</span></div>
<div class="line"><a id="l05673" name="l05673"></a><span class="lineno"> 5673</span>     <span class="keywordflow">do</span> k = 2, nlevlake</div>
<div class="line"><a id="l05674" name="l05674"></a><span class="lineno"> 5674</span>       <span class="keywordflow">if</span>(z_lake(k).le.depth_c) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05675" name="l05675"></a><span class="lineno"> 5675</span>         t_lake3d(i,k) = tsfc(i)+(277.2_kind_lake-tsfc(i))/depth_c*z_lake(k)</div>
<div class="line"><a id="l05676" name="l05676"></a><span class="lineno"> 5676</span>       <span class="keywordflow">else</span></div>
<div class="line"><a id="l05677" name="l05677"></a><span class="lineno"> 5677</span>         t_lake3d(i,k) = 277.2_kind_lake</div>
<div class="line"><a id="l05678" name="l05678"></a><span class="lineno"> 5678</span><span class="keywordflow">       end if</span></div>
<div class="line"><a id="l05679" name="l05679"></a><span class="lineno"> 5679</span>       <span class="keywordflow">if</span> (lake_icefrac3d(i,k) &lt;= 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05680" name="l05680"></a><span class="lineno"> 5680</span>         t_lake3d(i,k) = max(tfrz,t_lake3d(i,k))</div>
<div class="line"><a id="l05681" name="l05681"></a><span class="lineno"> 5681</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l05682" name="l05682"></a><span class="lineno"> 5682</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l05683" name="l05683"></a><span class="lineno"> 5683</span> </div>
<div class="line"><a id="l05684" name="l05684"></a><span class="lineno"> 5684</span>     <span class="comment">! initial t_soisno3d</span></div>
<div class="line"><a id="l05685" name="l05685"></a><span class="lineno"> 5685</span>     <span class="comment">! in snow</span></div>
<div class="line"><a id="l05686" name="l05686"></a><span class="lineno"> 5686</span>     <span class="keywordflow">if</span>(snowdp2d(i) &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05687" name="l05687"></a><span class="lineno"> 5687</span>       <span class="keywordflow">do</span> k = nint(snl2d(i))+1, 0</div>
<div class="line"><a id="l05688" name="l05688"></a><span class="lineno"> 5688</span>         t_soisno3d(i,k) =min(tfrz,tsfc(i))</div>
<div class="line"><a id="l05689" name="l05689"></a><span class="lineno"> 5689</span><span class="keywordflow">       enddo</span></div>
<div class="line"><a id="l05690" name="l05690"></a><span class="lineno"> 5690</span><span class="keywordflow">     endif</span></div>
<div class="line"><a id="l05691" name="l05691"></a><span class="lineno"> 5691</span> </div>
<div class="line"><a id="l05692" name="l05692"></a><span class="lineno"> 5692</span>     <span class="comment">! in soil</span></div>
<div class="line"><a id="l05693" name="l05693"></a><span class="lineno"> 5693</span>     t_soisno3d(i,1)        = t_lake3d(i,nlevlake)</div>
<div class="line"><a id="l05694" name="l05694"></a><span class="lineno"> 5694</span>     t_soisno3d(i,nlevsoil) = tg3(i)</div>
<div class="line"><a id="l05695" name="l05695"></a><span class="lineno"> 5695</span>     <span class="keywordflow">do</span> k = 2, nlevsoil-1</div>
<div class="line"><a id="l05696" name="l05696"></a><span class="lineno"> 5696</span>        t_soisno3d(i,k)=t_soisno3d(i,1)+(t_soisno3d(i,nlevsoil)-t_soisno3d(i,1))*dzsoi(k)</div>
<div class="line"><a id="l05697" name="l05697"></a><span class="lineno"> 5697</span><span class="keywordflow">     enddo</span></div>
<div class="line"><a id="l05698" name="l05698"></a><span class="lineno"> 5698</span> </div>
<div class="line"><a id="l05699" name="l05699"></a><span class="lineno"> 5699</span>    <span class="keywordflow">if</span> (snl2d(i) &lt; 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05700" name="l05700"></a><span class="lineno"> 5700</span>      <span class="keywordflow">do</span> k = nint(snl2d(i)+1), 0</div>
<div class="line"><a id="l05701" name="l05701"></a><span class="lineno"> 5701</span>        <span class="comment">! Be careful because there may be new snow layers with bad temperatures like 0 even if</span></div>
<div class="line"><a id="l05702" name="l05702"></a><span class="lineno"> 5702</span>        <span class="comment">! coming from init. con. file.</span></div>
<div class="line"><a id="l05703" name="l05703"></a><span class="lineno"> 5703</span>        <span class="keywordflow">if</span>(t_soisno3d(i,k) &gt; 300 .or. t_soisno3d(i,k) &lt; 200) t_soisno3d(i,k) = min(tfrz,tsfc(i))</div>
<div class="line"><a id="l05704" name="l05704"></a><span class="lineno"> 5704</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l05705" name="l05705"></a><span class="lineno"> 5705</span><span class="keywordflow">    end if</span></div>
<div class="line"><a id="l05706" name="l05706"></a><span class="lineno"> 5706</span> </div>
<div class="line"><a id="l05707" name="l05707"></a><span class="lineno"> 5707</span>    <span class="keywordflow">do</span> k = 1,nlevsoil</div>
<div class="line"><a id="l05708" name="l05708"></a><span class="lineno"> 5708</span>       h2osoi_vol3d(i,k) = 1.0_kind_lake</div>
<div class="line"><a id="l05709" name="l05709"></a><span class="lineno"> 5709</span>       watsat = 0.489_kind_lake - 0.00126_kind_lake*sand(isl)</div>
<div class="line"><a id="l05710" name="l05710"></a><span class="lineno"> 5710</span>       h2osoi_vol3d(i,k) = min(h2osoi_vol3d(i,k),watsat)</div>
<div class="line"><a id="l05711" name="l05711"></a><span class="lineno"> 5711</span> </div>
<div class="line"><a id="l05712" name="l05712"></a><span class="lineno"> 5712</span>      <span class="comment">! soil layers</span></div>
<div class="line"><a id="l05713" name="l05713"></a><span class="lineno"> 5713</span>      <span class="keywordflow">if</span> (t_soisno3d(i,k) &lt;= tfrz) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05714" name="l05714"></a><span class="lineno"> 5714</span>        h2osoi_ice3d(i,k)  = dz3d(i,k)*denice*h2osoi_vol3d(i,k)</div>
<div class="line"><a id="l05715" name="l05715"></a><span class="lineno"> 5715</span>        h2osoi_liq3d(i,k) = 0._kind_lake</div>
<div class="line"><a id="l05716" name="l05716"></a><span class="lineno"> 5716</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05717" name="l05717"></a><span class="lineno"> 5717</span>        h2osoi_ice3d(i,k) = 0._kind_lake</div>
<div class="line"><a id="l05718" name="l05718"></a><span class="lineno"> 5718</span>        h2osoi_liq3d(i,k) = dz3d(i,k)*denh2o*h2osoi_vol3d(i,k)</div>
<div class="line"><a id="l05719" name="l05719"></a><span class="lineno"> 5719</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l05720" name="l05720"></a><span class="lineno"> 5720</span><span class="keywordflow">    enddo</span></div>
<div class="line"><a id="l05721" name="l05721"></a><span class="lineno"> 5721</span> </div>
<div class="line"><a id="l05722" name="l05722"></a><span class="lineno"> 5722</span>    <span class="comment">!tgs - in RAP and HRRR applications with cycled snow depth and snow</span></div>
<div class="line"><a id="l05723" name="l05723"></a><span class="lineno"> 5723</span>    <span class="comment">!water equivalent, the actual snow density could be computed. This is</span></div>
<div class="line"><a id="l05724" name="l05724"></a><span class="lineno"> 5724</span>    <span class="comment">!not used for now for consistency with the main Lake subroutine, where</span></div>
<div class="line"><a id="l05725" name="l05725"></a><span class="lineno"> 5725</span>    <span class="comment">!constant snow density (250.) is used.</span></div>
<div class="line"><a id="l05726" name="l05726"></a><span class="lineno"> 5726</span>    <span class="keywordflow">if</span>(h2osno2d(i).gt.0. .and. snowdp2d(i).gt.0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05727" name="l05727"></a><span class="lineno"> 5727</span>       rhosn = h2osno2d(i)/snowdp2d(i)</div>
<div class="line"><a id="l05728" name="l05728"></a><span class="lineno"> 5728</span>    <span class="keywordflow">else</span></div>
<div class="line"><a id="l05729" name="l05729"></a><span class="lineno"> 5729</span>       rhosn = snow_bd <span class="comment">! bdsno=250.</span></div>
<div class="line"><a id="l05730" name="l05730"></a><span class="lineno"> 5730</span><span class="keywordflow">    endif</span></div>
<div class="line"><a id="l05731" name="l05731"></a><span class="lineno"> 5731</span> </div>
<div class="line"><a id="l05732" name="l05732"></a><span class="lineno"> 5732</span> </div>
<div class="line"><a id="l05733" name="l05733"></a><span class="lineno"> 5733</span>    <span class="keywordflow">do</span> k = -nlevsnow+1, 0</div>
<div class="line"><a id="l05734" name="l05734"></a><span class="lineno"> 5734</span>      <span class="keywordflow">if</span> (k &gt; snl2d(i)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05735" name="l05735"></a><span class="lineno"> 5735</span>        h2osoi_ice3d(i,k) = dz3d(i,k)*snow_bd</div>
<div class="line"><a id="l05736" name="l05736"></a><span class="lineno"> 5736</span>        h2osoi_liq3d(i,k) = 0._kind_lake</div>
<div class="line"><a id="l05737" name="l05737"></a><span class="lineno"> 5737</span><span class="keywordflow">      end if</span></div>
<div class="line"><a id="l05738" name="l05738"></a><span class="lineno"> 5738</span><span class="keywordflow">    end do</span></div>
<div class="line"><a id="l05739" name="l05739"></a><span class="lineno"> 5739</span> </div>
<div class="line"><a id="l05740" name="l05740"></a><span class="lineno"> 5740</span>    clm_lake_initialized(i) = 1</div>
<div class="line"><a id="l05741" name="l05741"></a><span class="lineno"> 5741</span> </div>
<div class="line"><a id="l05742" name="l05742"></a><span class="lineno"> 5742</span><span class="keywordflow">    endif</span>  <span class="comment">!if ( use_lakedepth ) then</span></div>
<div class="line"><a id="l05743" name="l05743"></a><span class="lineno"> 5743</span><span class="keywordflow">  ENDDO</span> do_init</div>
<div class="line"><a id="l05744" name="l05744"></a><span class="lineno"> 5744</span> </div>
<div class="line"><a id="l05745" name="l05745"></a><span class="lineno"> 5745</span> </div>
<div class="line"><a id="l05746" name="l05746"></a><span class="lineno"> 5746</span>  <span class="keywordflow">if</span>(debug_print .and. init_points&gt;0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05747" name="l05747"></a><span class="lineno"> 5747</span>    print *,<span class="stringliteral">&#39;points initialized in clm_lake&#39;</span>,init_points</div>
<div class="line"><a id="l05748" name="l05748"></a><span class="lineno"> 5748</span><span class="keywordflow">  end if</span></div>
<div class="line"><a id="l05749" name="l05749"></a><span class="lineno"> 5749</span> </div>
</div>
<div class="line"><a id="l05750" name="l05750"></a><span class="lineno"> 5750</span><span class="keyword">END SUBROUTINE </span>lakeini</div>
<div class="line"><a id="l05751" name="l05751"></a><span class="lineno"> 5751</span> </div>
<div class="line"><a id="l05752" name="l05752"></a><span class="lineno"> 5752</span><span class="keyword">END MODULE </span><a class="code hl_namespace" href="namespaceclm__lake.html">clm_lake</a></div>
<div class="ttc" id="agroup___noah_m_p___l_s_m_ga4804d8de40f7ea8a8cf4ed6e22ff4aa0_html_ga4804d8de40f7ea8a8cf4ed6e22ff4aa0"><div class="ttname"><a href="group___noah_m_p___l_s_m_ga4804d8de40f7ea8a8cf4ed6e22ff4aa0.html#ga4804d8de40f7ea8a8cf4ed6e22ff4aa0">combo</a></div><div class="ttdeci">subroutine combo(parameters, dz, wliq, wice, t, dz2, wliq2, wice2, t2)</div><div class="ttdef"><b>Definition</b> <a href="module__sf__noahmplsm_8_f90_source.html#l07931">module_sf_noahmplsm.F90:7932</a></div></div>
<div class="ttc" id="agroup___noah_m_p___l_s_m_ga8500bdb5fcc68e431512068da0d31cd5_html_ga8500bdb5fcc68e431512068da0d31cd5"><div class="ttname"><a href="group___noah_m_p___l_s_m_ga8500bdb5fcc68e431512068da0d31cd5.html#ga8500bdb5fcc68e431512068da0d31cd5">snowwater</a></div><div class="ttdeci">subroutine snowwater(parameters, nsnow, nsoil, imelt, dt, zsoil, sfctmp, snowhin, qsnow, qsnfro, qsnsub, qrain, ficeold, iloc, jloc, isnow, snowh, sneqv, snice, snliq, sh2o, sice, stc, zsnso, dzsnso, qsnbot, snoflow, ponding1, ponding2)</div><div class="ttdef"><b>Definition</b> <a href="module__sf__noahmplsm_8_f90_source.html#l07401">module_sf_noahmplsm.F90:7407</a></div></div>
<div class="ttc" id="agroup___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1_html_ga9d5adb20aca5b72a7e126136088e20d1"><div class="ttname"><a href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a></div><div class="ttdeci">subroutine albedo(parameters, vegtyp, ist, ice, nsoil, dt, cosz, fage, elai, esai, tg, tv, snowh, fsno, fwet, smc, sneqvo, sneqv, qsnow, fveg, iloc, jloc, albold, tauss, albgrd, albgri, albd, albi, fabd, fabi, ftdd, ftid, ftii, fsun, frevi, frevd, fregd, fregi, bgap, wgap, albsnd, albsni)</div><div class="ttdoc">surface albedos. also fluxes (per unit incoming direct and diffuse radiation) reflected,...</div><div class="ttdef"><b>Definition</b> <a href="module__sf__noahmplsm_8_f90_source.html#l02908">module_sf_noahmplsm.F90:2918</a></div></div>
<div class="ttc" id="anamespaceclm__lake_html"><div class="ttname"><a href="namespaceclm__lake.html">clm_lake</a></div><div class="ttdoc">This module contains the CLM Lake model.</div><div class="ttdef"><b>Definition</b> <a href="#l00022">clm_lake.f90:22</a></div></div>
<div class="ttc" id="anamespacemachine_html"><div class="ttname"><a href="namespacemachine.html">machine</a></div><div class="ttdef"><b>Definition</b> <a href="machine_8_f90_source.html#l00001">machine.F90:1</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="dir_8793a1d86eabfbf136477319f12c7204.html">SFC_Models</a></li><li class="navelem"><a href="dir_39714b4ead30bfa55ba3ef7446aa4029.html">Lake</a></li><li class="navelem"><a href="dir_3df857126bdf45c84be75a2311a6398a.html">CLM</a></li><li class="navelem"><b>clm_lake.f90</b></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.16.1 </li>
  </ul>
</div>
<script type="text/javascript">
  $(function() {
    toggleButton = document.createElement('doxygen-awesome-dark-mode-toggle')
    toggleButton.title = "Toggle Light/Dark Mode"
    $(document).ready(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
    // every resize will remove the button, which is why it has to be added again:
    $(window).resize(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
  })
</script>
</body>
</html>
