<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.16.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="CCPP SciDoc" />
<meta property="og:image" content="https://repository-images.githubusercontent.com/348492097/4f16df80-88fb-11eb-9d31-4015ff22c452" />
<meta property="og:description" content="CCPP Scientific Documentation" />
<meta property="og:url" content="https://github.com/ufs-community/ccpp-physics" />
<!-- END opengraph metadata -->
<title>CCPP SciDoc v7.0.0: /Users/man.zhang/github_doxygen/ccpp-physics/physics/SFC_Models/Land/Noah/sflx.f Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" type="image/svg+xml" href="logo.drawio.svg"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript" src="toggle-alternative-theme.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-ccpp.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- https://tholman.com/github-corners/ -->
<a href="https://github.com/ufs-community/ccpp-physics" class="github-corner" title="View source on GitHub" target="_blank" rel="noopener noreferrer">
    <svg viewBox="0 0 250 250" width="60" height="60" style="position: absolute; top: 0; border: 0; right: 0; z-index: 99;" aria-hidden="true">
    <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="dtc_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CCPP SciDoc v7.0.0
   &#160;<span id="projectnumber">v7.0.0</span>
   </div>
   <div id="projectbrief">Common Community Physics Package Developed at DTC</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect" class="search-icon" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"><span class="search-icon-dropdown"></span></span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><div id="MSearchCloseImg" class="close-icon"></div></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.16.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('sflx_8f_source.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">sflx.f</div></div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="comment">!&gt;\file sflx.f</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="comment">!!</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="comment"></span> </div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="comment">!&gt; This module contains the entity of GFS Noah LSM Model(Version 2.7).</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno"><a class="line" href="namespacesflx.html">    5</a></span>      <span class="keyword">module</span> <a class="code hl_namespace" href="namespacesflx.html">sflx</a></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span>      <span class="keyword">contains</span><span class="comment"></span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="comment">!!\brief This is the entity of GFS Noah LSM model of physics subroutines.</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="comment">!! It is a soil/veg/snowpack land-surface model to update soil moisture, soil</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="comment">!! ice, soil temperature, skin temperature, snowpack water content, snowdepth,</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="comment">!! and all terms of the surface energy balance and surface water balance</span></div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="comment">!! (excluding input atmospheric forcings of downward radiation and </span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="comment">!! precipitation).</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="comment">!!</span></div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="comment">!! The land-surface model component was substantially upgraded from the Oregon</span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="comment">!! State University (OSU) land surface model to EMC&#39;s new Noah Land Surface Model</span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="comment">!! (Noah LSM) during the major implementation in the NCEP Global Forecast System</span></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="comment">!! (GFS) on May 31, 2005. Forecast System (GFS). The Noah LSM embodies about 10</span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span><span class="comment">!! years of upgrades (see \cite chen_et_al_1996, \cite koren_et_al_1999, </span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="comment">!! \cite ek_et_al_2003) to its ancestor, the OSU LSM.  The Noah LSM upgrade includes:</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span><span class="comment">!!  - An increase from two (10, 190 cm thick) to four soil layers (10, 30, 60, 100 cm thick)</span></div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span><span class="comment">!!  - Addition of frozen soil physics</span></div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span><span class="comment">!!  - Add glacial ice treatment</span></div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span><span class="comment">!!  - Two snowpack states (SWE, density)</span></div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span><span class="comment">!!  - New  formulations for infiltration and runoff account for sub-grid variability in precipitation and soil moisture</span></div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span><span class="comment">!!  - Revised physics of the snowpack and its influence on surface heat fluxes and albedo</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span><span class="comment">!!  - Higher canopy resistance</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span><span class="comment">!!  - Spatially  varying root depth</span></div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span><span class="comment">!!  - Surface fluxes weighted by snow cover fraction</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span><span class="comment">!!  - Improved thermal conduction in soil/snow</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span><span class="comment">!!  - Improved seasonality of green vegetation cover.</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span><span class="comment">!!  - Improved evaporation treatment over bare soil and snowpack</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span><span class="comment">!!</span></div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span><span class="comment">!!\param[in] nsoil        integer, number of soil layers (&gt;=2 but &lt;=nsold)</span></div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span><span class="comment">!!\param[in] couple       integer, =0:uncoupled (land model only),</span></div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span><span class="comment">!!                                 =1:coupled with parent atmos model</span></div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span><span class="comment">!!\param[in] icein        integer, sea-ice flag (=1: sea-ice, =0: land)</span></div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span><span class="comment">!!\param[in] ffrozp       real, flag for snow-rain detection (1.=snow, 0.=rain)</span></div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span><span class="comment">!!\param[in] dt           real, time step (&lt;3600 sec)</span></div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span><span class="comment">!!\param[in] zlvl         real, height abv atmos ground forcing vars (\f$m\f$)</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span><span class="comment">!!\param[in] sldpth       real, thickness of each soil layer (\f$m\f$), nsoil</span></div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span><span class="comment">!!\param[in] swdn         real, downward SW radiation flux (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span><span class="comment">!!\param[in] swnet        real, downward SW net (dn-up) flux (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span><span class="comment">!!\param[in] lwdn         real, downward LW radiation flux (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span><span class="comment">!!\param[in] sfcems       real, sfc LW emissivity (fractional)</span></div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span><span class="comment">!!\param[in] sfcprs       real, pressure at height zlvl above ground(\f$Pa\f$)</span></div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span><span class="comment">!!\param[in] sfctmp       real, air temp at height zlvl above ground (\f$K\f$)</span></div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span><span class="comment">!!\param[in] sfcspd       real, wind speed at height zlvl above ground (\f$m s^{-1}\f$)</span></div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span><span class="comment">!!\param[in] prcp         real, precipitation rate (\f$kgm^{-2}s^{-1}\f$)</span></div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span><span class="comment">!!\param[in] q2           real, mixing ratio at hght zlvl above ground (\f$kgkg^{-1}\f$)</span></div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span><span class="comment">!!\param[in] q2sat        real, sat mixing ratio at zlvl above ground (\f$kgkg^{-1}\f$)</span></div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span><span class="comment">!!\param[in] dqsdt2       real, slope of sat specific humidity curve at t=sfctmp (\f$kgkg^{-1}k^{-1}\f$)</span></div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span><span class="comment">!!\param[in] th2          real, air potential temperature at zlvl above ground (\f$K\f$)</span></div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span><span class="comment">!!\param[in] ivegsrc      integer, sfc veg type data source UMD or IGBP</span></div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span><span class="comment">!!\param[in] vegtyp       integer, vegetation type (integer index)</span></div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span><span class="comment">!!\param[in] soiltyp      integer, soil type (integer index)</span></div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span><span class="comment">!!\param[in] slopetyp     integer, class of sfc slope (integer index)</span></div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span><span class="comment">!!\param[in] shdmin       real, min areal coverage of green veg (fraction)</span></div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span><span class="comment">!!\param[in] alb          real, background snow-free sfc albedo (fraction)</span></div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span><span class="comment">!!\param[in] snoalb       real, max albedo over deep snow (fraction)</span></div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span><span class="comment">!!\param[in] bexpp        real, perturbation of soil type &quot;b&quot; parameter (perturbation)</span></div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span><span class="comment">!!\param[in] xlaip        real, perturbation of leave area index (perturbation)</span></div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span><span class="comment">!!\param[in] lheatstrg    logical, flag for canopy heat storage parameterization </span></div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span><span class="comment">!!\param[in,out] tbot     real, bottom soil temp (\f$K\f$) (local yearly-mean sfc air temp)</span></div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span><span class="comment">!!\param[in,out] cmc      real, canopy moisture content (\f$m\f$)</span></div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span><span class="comment">!!\param[in,out] t1       real, ground/canopy/snowpack eff skin temp (\f$K\f$)</span></div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span><span class="comment">!!\param[in,out] stc      real, soil temp (\f$K\f$)</span></div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span><span class="comment">!!\param[in,out] smc      real, total soil moisture (vol fraction)</span></div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span><span class="comment">!!\param[in,out] sh2o     real, unfrozen soil moisture (vol fraction), note: frozen part = smc-sh2o</span></div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span><span class="comment">!!\param[in,out] sneqv    real, water-equivalent snow depth (\f$m\f$), note: snow density = snwqv/snowh</span></div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span><span class="comment">!!\param[in,out] ch       real, sfc exchange coeff for heat &amp; moisture (\f$ms^{-1}\f$),</span></div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span><span class="comment">!! note: conductance since it&#39;s been mult by wind</span></div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span><span class="comment">!!\param[in,out] cm       real, sfc exchange coeff for momentum</span></div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span><span class="comment">!! (\f$ms^{-1}\f$), note: conductance since it&#39;s been mult by wind</span></div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span><span class="comment">!!\param[in,out] z0       real, roughness length (\f$m\f$)</span></div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span><span class="comment">!!\param[out] nroot       integer, number of root layers</span></div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span><span class="comment">!!\param[out] shdfac      real, aeral coverage of green veg (fraction)</span></div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span><span class="comment">!!\param[out] snowh       real, snow depth (\f$m\f$)</span></div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span><span class="comment">!!\param[out] albedo      real, sfc albedo incl snow effect (fraction)</span></div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span><span class="comment">!!\param[out] eta         real, downward latent heat flux (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span><span class="comment">!!\param[out] sheat       real, downward sensible heat flux (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span><span class="comment">!!\param[out] ec          real, canopy water evaporation (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span><span class="comment">!!\param[out] edir        real, direct soil evaporation (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span><span class="comment">!!\param[out] et          real, plant transpiration (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span><span class="comment">!!\param[out] ett         real, total plant transpiration (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span><span class="comment">!!\param[out] esnow       real, sublimation from snowpack (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span><span class="comment">!!\param[out] drip        real, through-fall of precip and/or dew in</span></div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span><span class="comment">!! excess of canopy water-holding capacity (\f$m\f$)</span></div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span><span class="comment">!!\param[out] dew         real, dewfall (or frostfall for t&lt;273.15) (\f$m\f$)</span></div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span><span class="comment">!!\param[out] beta        real, ratio of actual/potential evap</span></div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span><span class="comment">!!\param[out] etp         real, potential evaporation (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span><span class="comment">!!\param[out] ssoil       real, upward soil heat flux (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span><span class="comment">!!\param[out] flx1        real, precip-snow sfc flux  (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span><span class="comment">!!\param[out] flx2        real, freezing rain latent heat flux (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span><span class="comment">!!\param[out] flx3        real, phase-change heat flux from snowmelt (\f$W/m^2\f$)</span></div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span><span class="comment">!!\param[out] runoff1     real, surface runoff (\f$ms^{-1}\f$) not infiltrating sfc</span></div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span><span class="comment">!!\param[out] runoff2     real, sub sfc runoff (\f$ms^{-1}\f$) (baseflow)</span></div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span><span class="comment">!!\param[out] runoff3     real, excess of porosity for a given soil layer</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span><span class="comment">!!\param[out] snomlt      real, snow melt (\f$m\f$) (water equivalent)</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span><span class="comment">!!\param[out] sncovr      real, fractional snow cover</span></div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span><span class="comment">!!\param[out] rc          real, canopy resistance (s/m)</span></div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span><span class="comment">!!\param[out] pc          real, plant coeff (fraction) where pc*etp=transpi</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span><span class="comment">!!\param[out] rsmin       real, minimum canopy resistance (s/m)</span></div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span><span class="comment">!!\param[out] xlai        real, leaf area index  (dimensionless)</span></div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span><span class="comment">!!\param[out] rcs         real, incoming solar rc factor (dimensionless)</span></div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span><span class="comment">!!\param[out] rct         real, air temperature rc factor (dimensionless)</span></div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span><span class="comment">!!\param[out] rcq         real, atoms vapor press deficit rc factor</span></div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span><span class="comment">!!\param[out] rcsoil      real, soil moisture rc factor (dimensionless)</span></div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span><span class="comment">!!\param[out] soilw       real, available soil moisture in root zone</span></div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span><span class="comment">!!\param[out] soilm       real, total soil column moisture (frozen+unfrozen) (\f$m\f$)</span></div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span><span class="comment">!!\param[out] smcwlt      real, wilting point (volumetric)</span></div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span><span class="comment">!!\param[out] smcdry      real, dry soil moisture threshold (volumetric)</span></div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span><span class="comment">!!\param[out] smcref      real, soil moisture threshold (volumetric)</span></div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span><span class="comment">!!\param[out] smcmax      real, porosity (sat val of soil mois)</span></div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span><span class="comment">!&gt;\section general_sflx GFS Noah LSM General Algorithm</span></div>
<div class="foldopen" id="foldopen00116" data-start="" data-end="">
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga36e98f3ac91f839b816fd167eab30901.html#ga36e98f3ac91f839b816fd167eab30901">  116</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga36e98f3ac91f839b816fd167eab30901.html#ga36e98f3ac91f839b816fd167eab30901">gfssflx</a>                                                &amp;<span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>     &amp;     ( nsoil, couple, icein, ffrozp, dt, zlvl, sldpth,            &amp;</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>     &amp;       swdn, swnet, lwdn, sfcems, sfcprs, sfctmp,                 &amp;</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>     &amp;       sfcspd, prcp, q2, q2sat, dqsdt2, th2, ivegsrc,             &amp;</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>     &amp;       vegtyp, soiltyp, slopetyp, shdmin, alb, snoalb,            &amp;</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>     &amp;       rhonewsn, exticeden,                                       &amp;</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>     &amp;       bexpp, xlaip,                                              &amp; <span class="comment">!  sfc-perts, mgehne</span></div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>     &amp;       lheatstrg,                                                 &amp;<span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>     &amp;       tbot, cmc, t1, stc, smc, sh2o, sneqv, ch, cm,z0,           &amp;<span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>     &amp;       nroot, shdfac, snowh, <a class="code hl_function" href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a>, eta, sheat, ec,              &amp;</div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>     &amp;       edir, et, ett, esnow, drip, dew, beta, etp, ssoil,         &amp;</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>     &amp;       flx1, flx2, flx3, runoff1, runoff2, runoff3,               &amp;</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>     &amp;       snomlt, sncovr, rc, pc, rsmin, xlai, rcs, rct, rcq,        &amp;</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>     &amp;       rcsoil, soilw, soilm, smcwlt, smcdry, smcref, smcmax,      &amp;</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>     &amp;       errmsg, errflg )</div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span> </div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span><span class="comment">!  subroutine sflx - version 2.7:                                       !</span></div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span><span class="comment">!  sub-driver for &quot;noah/osu lsm&quot; family of physics subroutines for a    !</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span><span class="comment">!  soil/veg/snowpack land-surface model to update soil moisture, soil   !</span></div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span><span class="comment">!  ice, soil temperature, skin temperature, snowpack water content,     !</span></div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span><span class="comment">!  snowdepth, and all terms of the surface energy balance and surface   !</span></div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span><span class="comment">!  water balance (excluding input atmospheric forcings of downward      !</span></div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span><span class="comment">!  radiation and precip)                                                !</span></div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span><span class="comment">!  usage:                                                               !</span></div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span><span class="comment">!      call sflx                                                        !</span></div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span><span class="comment">!          ( nsoil, couple, icein, ffrozp, dt, zlvl, sldpth,            !</span></div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span><span class="comment">!            swdn, swnet, lwdn, sfcems, sfcprs, sfctmp,                 !</span></div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span><span class="comment">!            sfcspd, prcp, q2, q2sat, dqsdt2, th2,ivegsrc,              !</span></div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span><span class="comment">!            vegtyp, soiltyp, slopetyp, shdmin, alb, snoalb,            !</span></div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span><span class="comment">!  ---  input/outputs:                                                  !</span></div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span><span class="comment">!            tbot, cmc, t1, stc, smc, sh2o, sneqv, ch, cm,              !</span></div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span><span class="comment">!  ---  outputs:                                                        !</span></div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span><span class="comment">!            nroot, shdfac, snowh, albedo, eta, sheat, ec,              !</span></div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span><span class="comment">!            edir, et, ett, esnow, drip, dew, beta, etp, ssoil,         !</span></div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span><span class="comment">!            flx1, flx2, flx3, runoff1, runoff2, runoff3,               !</span></div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span><span class="comment">!            snomlt, sncovr, rc, pc, rsmin, xlai, rcs, rct, rcq,        !</span></div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span><span class="comment">!            rcsoil, soilw, soilm, smcwlt, smcdry, smcref, smcmax )     !</span></div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span><span class="comment">!  subprograms called:  redprm, snow_new, csnow, snfrac, alcalc,        !</span></div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span><span class="comment">!            tdfcnd, snowz0, sfcdif, penman, canres, nopac, snopac.     !</span></div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span><span class="comment">!  program history log:                                                 !</span></div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span><span class="comment">!    jun  2003  -- k. mitchell et. al -- created version 2.7            !</span></div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span><span class="comment">!         200x  -- sarah lu    modified the code including:             !</span></div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span><span class="comment">!                       added passing argument, couple; replaced soldn  !</span></div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span><span class="comment">!                       and solnet by radflx; call sfcdif if couple=0;  !</span></div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span><span class="comment">!                       apply time filter to stc and tskin; and the     !</span></div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span><span class="comment">!                       way of namelist inport.                         !</span></div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span><span class="comment">!    feb  2004 -- m. ek noah v2.7.1 non-linear weighting of snow vs     !</span></div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span><span class="comment">!                       non-snow covered portions of gridbox            !</span></div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span><span class="comment">!    apr  2009  -- y.-t. hou   added lw surface emissivity effect,      !</span></div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span><span class="comment">!                       streamlined and reformatted the code, and       !</span></div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span><span class="comment">!                       consolidated constents/parameters by using      !</span></div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span><span class="comment">!                       module physcons, and added program documentation!</span></div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span><span class="comment">!    sep  2009 -- s. moorthi minor fixes                                !</span></div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span><span class="comment">!     nsoil    - integer, number of soil layers (&gt;=2 but &lt;=nsold)  1    !</span></div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span><span class="comment">!     couple   - integer, =0:uncoupled (land model only)           1    !</span></div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span><span class="comment">!                         =1:coupled with parent atmos model            !</span></div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span><span class="comment">!     icein    - integer, sea-ice flag (=1: sea-ice, =0: land)     1    !</span></div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span><span class="comment">!     ffrozp   - real, fractional snow/rain                        1    !</span></div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span><span class="comment">!     dt       - real, time step (&lt;3600 sec)                       1    !</span></div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span><span class="comment">!     zlvl     - real, height abv atmos ground forcing vars (m)    1    !</span></div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span><span class="comment">!     sldpth   - real, thickness of each soil layer (m)          nsoil  !</span></div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span><span class="comment">!     swdn     - real, downward sw radiation flux (w/m**2)         1    !</span></div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span><span class="comment">!     swnet    - real, downward sw net (dn-up) flux (w/m**2)       1    !</span></div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span><span class="comment">!     lwdn     - real, downward lw radiation flux (w/m**2)         1    !</span></div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span><span class="comment">!     sfcems   - real, sfc lw emissivity (fractional)              1    !</span></div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span><span class="comment">!     sfcprs   - real, pressure at height zlvl abv ground(pascals) 1    !</span></div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span><span class="comment">!     sfctmp   - real, air temp at height zlvl abv ground (k)      1    !</span></div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span><span class="comment">!     sfcspd   - real, wind speed at height zlvl abv ground (m/s)  1    !</span></div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span><span class="comment">!     prcp     - real, precip rate (kg m-2 s-1)                    1    !</span></div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span><span class="comment">!     q2       - real, mixing ratio at hght zlvl abv grnd (kg/kg)  1    !</span></div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span><span class="comment">!     q2sat    - real, sat mixing ratio at zlvl abv grnd (kg/kg)   1    !</span></div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span><span class="comment">!     dqsdt2   - real, slope of sat specific humidity curve at     1    !</span></div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span><span class="comment">!                      t=sfctmp (kg kg-1 k-1)                           !</span></div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span><span class="comment">!     th2      - real, air potential temp at zlvl abv grnd (k)     1    !</span></div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span><span class="comment">!     ivegsrc  - integer, sfc veg type data source umd or igbp          !</span></div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span><span class="comment">!     vegtyp   - integer, vegetation type (integer index)          1    !</span></div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span><span class="comment">!     soiltyp  - integer, soil type (integer index)                1    !</span></div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span><span class="comment">!     slopetyp - integer, class of sfc slope (integer index)       1    !</span></div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span><span class="comment">!     shdmin   - real, min areal coverage of green veg (fraction)  1    !</span></div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span><span class="comment">!     alb      - real, bkground snow-free sfc albedo (fraction)    1    !</span></div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span><span class="comment">!     snoalb   - real, max albedo over deep snow     (fraction)    1    !</span></div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span><span class="comment">!     lheatstrg- logical, flag for canopy heat storage             1    !</span></div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span><span class="comment">!                         parameterization                              !</span></div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span><span class="comment">!  input/outputs:                                                       !</span></div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span><span class="comment">!     tbot     - real, bottom soil temp (k)                        1    !</span></div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span><span class="comment">!                      (local yearly-mean sfc air temp)                 !</span></div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span><span class="comment">!     cmc      - real, canopy moisture content (m)                 1    !</span></div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span><span class="comment">!     t1       - real, ground/canopy/snowpack eff skin temp (k)    1    !</span></div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span><span class="comment">!     stc      - real, soil temp (k)                             nsoil  !</span></div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span><span class="comment">!     smc      - real, total soil moisture (vol fraction)        nsoil  !</span></div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span><span class="comment">!     sh2o     - real, unfrozen soil moisture (vol fraction)     nsoil  !</span></div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span><span class="comment">!                      note: frozen part = smc-sh2o                     !</span></div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span><span class="comment">!     sneqv    - real, water-equivalent snow depth (m)             1    !</span></div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span><span class="comment">!                      note: snow density = snwqv/snowh                 !</span></div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span><span class="comment">!     ch       - real, sfc exchange coeff for heat &amp; moisture (m/s)1    !</span></div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span><span class="comment">!                      note: conductance since it&#39;s been mult by wind   !</span></div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span><span class="comment">!     cm       - real, sfc exchange coeff for momentum (m/s)       1    !</span></div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span><span class="comment">!                      note: conductance since it&#39;s been mult by wind   !</span></div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span><span class="comment">!     nroot    - integer, number of root layers                    1    !</span></div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span><span class="comment">!     shdfac   - real, aeral coverage of green veg (fraction)      1    !</span></div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span><span class="comment">!     snowh    - real, snow depth (m)                              1    !</span></div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span><span class="comment">!     albedo   - real, sfc albedo incl snow effect (fraction)      1    !</span></div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span><span class="comment">!     eta      - real, downward latent heat flux (w/m2)            1    !</span></div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span><span class="comment">!     sheat    - real, downward sensible heat flux (w/m2)          1    !</span></div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span><span class="comment">!     ec       - real, canopy water evaporation (w/m2)             1    !</span></div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span><span class="comment">!     edir     - real, direct soil evaporation (w/m2)              1    !</span></div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span><span class="comment">!     et       - real, plant transpiration     (w/m2)            nsoil  !</span></div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span><span class="comment">!     ett      - real, total plant transpiration (w/m2)            1    !</span></div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span><span class="comment">!     esnow    - real, sublimation from snowpack (w/m2)            1    !</span></div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span><span class="comment">!     drip     - real, through-fall of precip and/or dew in excess 1    !</span></div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span><span class="comment">!                      of canopy water-holding capacity (m)             !</span></div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span><span class="comment">!     dew      - real, dewfall (or frostfall for t&lt;273.15) (m)     1    !</span></div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span><span class="comment">!     beta     - real, ratio of actual/potential evap              1    !</span></div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span><span class="comment">!     etp      - real, potential evaporation (w/m2)                1    !</span></div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span><span class="comment">!     ssoil    - real, upward soil heat flux (w/m2)                1    !</span></div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span><span class="comment">!     flx1     - real, precip-snow sfc flux  (w/m2)                1    !</span></div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span><span class="comment">!     flx2     - real, freezing rain latent heat flux (w/m2)       1    !</span></div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span><span class="comment">!     flx3     - real, phase-change heat flux from snowmelt (w/m2) 1    !</span></div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span><span class="comment">!     snomlt   - real, snow melt (m) (water equivalent)            1    !</span></div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span><span class="comment">!     sncovr   - real, fractional snow cover                       1    !</span></div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span><span class="comment">!     runoff1  - real, surface runoff (m/s) not infiltrating sfc   1    !</span></div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span><span class="comment">!     runoff2  - real, sub sfc runoff (m/s) (baseflow)             1    !</span></div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span><span class="comment">!     runoff3  - real, excess of porosity for a given soil layer   1    !</span></div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span><span class="comment">!     rc       - real, canopy resistance (s/m)                     1    !</span></div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span><span class="comment">!     pc       - real, plant coeff (fraction) where pc*etp=transpi 1    !</span></div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span><span class="comment">!     rsmin    - real, minimum canopy resistance (s/m)             1    !</span></div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span><span class="comment">!     xlai     - real, leaf area index  (dimensionless)            1    !</span></div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span><span class="comment">!     rcs      - real, incoming solar rc factor  (dimensionless)   1    !</span></div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span><span class="comment">!     rct      - real, air temp rc factor        (dimensionless)   1    !</span></div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span><span class="comment">!     rcq      - real, atoms vapor press deficit rc factor         1    !</span></div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span><span class="comment">!     rcsoil   - real, soil moisture rc factor   (dimensionless)   1    !</span></div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span><span class="comment">!     soilw    - real, available soil mois in root zone            1    !</span></div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span><span class="comment">!     soilm    - real, total soil column mois (frozen+unfrozen) (m)1    !</span></div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span><span class="comment">!     smcwlt   - real, wilting point (volumetric)                  1    !</span></div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span><span class="comment">!     smcdry   - real, dry soil mois threshold (volumetric)        1    !</span></div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span><span class="comment">!     smcref   - real, soil mois threshold     (volumetric)        1    !</span></div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span><span class="comment">!     smcmax   - real, porosity (sat val of soil mois)             1    !</span></div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span><span class="comment">!</span></div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span>      <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacemachine.html">machine</a> ,   <span class="keywordtype">only</span> : kind_phys</div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span><span class="comment">!</span></div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>      <span class="keywordtype">use </span>physcons,   <span class="keywordtype">only</span> : con_cp, con_rd, con_t0c, con_g, con_pi,    &amp;</div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span>     &amp;                       con_cliq, con_csol, con_hvap, con_hfus,    &amp;</div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span>     &amp;                       con_sbc</div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span><span class="comment">!</span></div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>      <span class="keywordtype">implicit none</span></div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span> </div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span><span class="comment">!  ---  constant parameters:</span></div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span><span class="comment">!      *** note: some of the constants are different in subprograms and need to</span></div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span><span class="comment">!          be consolidated with the standard def in module physcons at sometime</span></div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span><span class="comment">!          at the present time, those diverse values are kept temperately to</span></div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span><span class="comment">!          provide the same result as the original codes.  -- y.t.h.  may09</span></div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span> </div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span>      <span class="keywordtype">integer</span>,               <span class="keywordtype">parameter</span> :: nsold   = 4<span class="comment">           !&lt; max soil layers</span></div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span> </div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span><span class="comment">!     real (kind=kind_phys), parameter :: gs      = con_g       !&lt; con_g   =9.80665</span></div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: gs1     = 9.8         <span class="comment">!&lt; con_g in sfcdif</span></div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: gs2     = 9.81        <span class="comment">!&lt; con_g in snowpack, frh2o</span></div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: tfreez  = con_t0c     <span class="comment">!&lt; con_t0c =273.16</span></div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: lsubc   = 2.501e+6    <span class="comment">!&lt; con_hvap=2.5000e+6</span></div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: lsubf   = 3.335e5     <span class="comment">!&lt; con_hfus=3.3358e+5</span></div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: lsubs   = 2.83e+6     <span class="comment">! ? in sflx, snopac</span></div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: elcp    = 2.4888e+3   <span class="comment">! ? in penman</span></div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span><span class="comment">!     real (kind=kind_phys), parameter :: rd      = con_rd      ! con_rd  =287.05</span></div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: rd1     = 287.04      <span class="comment">! con_rd in sflx, penman, canres</span></div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: cp      = con_cp      <span class="comment">! con_cp  =1004.6</span></div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: cp1     = 1004.5      <span class="comment">! con_cp in sflx, canres</span></div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: cp2     = 1004.0      <span class="comment">! con_cp in htr</span></div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span><span class="comment">!     real (kind=kind_phys), parameter :: cph2o   = con_cliq    ! con_cliq=4.1855e+3</span></div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: cph2o1  = 4.218e+3    <span class="comment">! con_cliq in penman, snopac</span></div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: cph2o2  = 4.2e6       <span class="comment">! con_cliq in hrt *unit diff!</span></div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: cpice   = con_csol    <span class="comment">! con_csol=2.106e+3</span></div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: cpice1  = 2.106e6     <span class="comment">! con_csol in hrt *unit diff!</span></div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span><span class="comment">!     real (kind=kind_phys), parameter :: sigma   = con_sbc     ! con_sbc=5.6704e-8</span></div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: sigma1  = 5.67e-8     <span class="comment">! con_sbc in penman, nopac, snopac</span></div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span> </div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil, couple, icein, vegtyp, soiltyp,     &amp;</div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>     &amp;       slopetyp, ivegsrc</div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span> </div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: ffrozp, dt, zlvl, lwdn,      &amp;</div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span>     &amp;       sldpth(nsoil), swdn, swnet, sfcems, sfcprs, sfctmp,        &amp;</div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>     &amp;       sfcspd, prcp, q2, q2sat, dqsdt2, th2, shdmin, alb, snoalb, &amp;</div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>     &amp;       bexpp, xlaip, rhonewsn                                     &amp; <span class="comment">!sfc-perts, mgehne</span></div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span> </div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>      <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: lheatstrg, exticeden</div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span> </div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(inout)</span> :: tbot, cmc, t1, sneqv,     &amp;</div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span>     &amp;       stc(nsoil), smc(nsoil), sh2o(nsoil), ch, cm</div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span> </div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(out)</span> :: nroot</div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span> </div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: shdfac, snowh, <a class="code hl_function" href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a>,      &amp;</div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>     &amp;       eta, sheat, ec, edir, et(nsoil), ett, esnow, drip, dew,    &amp;</div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>     &amp;       beta, etp, ssoil, flx1, flx2, flx3, snomlt, sncovr,        &amp;</div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>     &amp;       runoff1, runoff2, runoff3, rc, pc, rsmin, xlai, rcs,       &amp;</div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span>     &amp;       rct, rcq, rcsoil, soilw, soilm, smcwlt, smcdry, smcref,    &amp;</div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span>     &amp;       smcmax</div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span>      <span class="keywordtype">character(len=*)</span>,     <span class="keywordtype">intent(out)</span> :: errmsg</div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span>      <span class="keywordtype">integer</span>,              <span class="keywordtype">intent(out)</span> :: errflg</div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span> </div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span><span class="comment">!     real (kind=kind_phys) ::  df1h,</span></div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span><span class="keywordtype">      real</span> (kind=kind_phys) ::  bexp, cfactr, cmcmax, csoil, czil,      &amp;</div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span>     &amp;       df1, df1a, dksat, dwsat, dsoil, dtot, frcsno,              &amp;</div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span>     &amp;       frcsoi, epsca, fdown, f1, fxexp, frzx, hs, kdt, prcp1,     &amp;</div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>     &amp;       psisat, quartz, rch, refkdt, rr, rgl, rsmax, sndens,       &amp;</div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>     &amp;       sncond, sbeta, sn_new, slope, snup, salp, soilwm, soilww,  &amp;</div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>     &amp;       t1v, t24, t2v, th2v, topt, tsnow, zbot, z0</div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>      </div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span><span class="keywordtype">      real</span> (kind=kind_phys) ::  shdfac0</div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">dimension(nsold)</span> :: rtdis, zsoil</div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span> </div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span>      <span class="keywordtype">logical</span> :: frzgra, snowng</div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span> </div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>      <span class="keywordtype">integer</span> :: ice, k, kz</div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span><span class="comment">!</span></div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span><span class="comment">!</span></div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span><span class="comment">! Initialize CCPP error-handling</span></div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>      errflg = 0</div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>      errmsg = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span> </div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span><span class="comment">!  --- ...  initialization</span></div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span> </div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>      runoff1 = 0.0</div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span>      runoff2 = 0.0</div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>      runoff3 = 0.0</div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span>      snomlt  = 0.0</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span>      rc      = 0.0</div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span> </div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span><span class="comment">!  --- ...  define local variable ice to achieve:</span></div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span><span class="comment">!             sea-ice case,          ice =  1</span></div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span><span class="comment">!             non-glacial land,      ice =  0</span></div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span><span class="comment">!             glacial-ice land,      ice = -1</span></div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span><span class="comment">!             if vegtype=15 (glacial-ice), re-set ice flag = -1 (glacial-ice)</span></div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span><span class="comment">!    note - for open-sea, sflx should *not* have been called. set green</span></div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span><span class="comment">!           vegetation fraction (shdfac) = 0.</span></div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span><span class="comment"></span> </div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span><span class="comment">!&gt; - Set ice = -1 and green vegetation fraction (shdfac) = 0 for glacial-ice land.</span></div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span>      shdfac0 = shdfac</div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>      ice = icein</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span> </div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>      <span class="keywordflow">if</span>(ivegsrc == 2) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>       <span class="keywordflow">if</span> (vegtyp == 13) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>        ice = -1</div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>        shdfac = 0.0</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span> </div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span>      <span class="keywordflow">if</span>(ivegsrc == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>       <span class="keywordflow">if</span> (vegtyp == 15) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>        ice = -1</div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>        shdfac = 0.0</div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span><span class="comment"></span> </div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span><span class="comment">!&gt; - Calculate soil layer depth below ground.</span></div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span>      <span class="keywordflow">if</span> (ice == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span> </div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span>        shdfac = 0.0</div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span><span class="comment"></span> </div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span><span class="comment">!&gt;  - For ice, set green vegetation fraction (shdfac) = 0.</span></div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span><span class="comment">!! and set sea-ice layers of equal thickness and sum to 3 meters</span></div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span> </div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span>        <span class="keywordflow">do</span> kz = 1, nsoil</div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span>          zsoil(kz) = -3.0 * float(kz) / float(nsoil)</div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span> </div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span><span class="comment"></span> </div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span><span class="comment">!&gt;  - Otherwise, calculate depth (negative) below ground from top skin sfc to </span></div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span><span class="comment">!! bottom of each soil layer.</span></div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span><span class="comment">!    note - sign of zsoil is negative (denoting below ground)</span></div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span> </div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span>        zsoil(1) = -sldpth(1)</div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span>        <span class="keywordflow">do</span> kz = 2, nsoil</div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>          zsoil(kz) = -sldpth(kz) + zsoil(kz-1)</div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span><span class="keywordflow">        end do</span></div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span> </div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_ice_block</span></div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span> </div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span><span class="comment">!  --- ...  next is crucial call to set the land-surface parameters,</span></div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span><span class="comment">!           including soil-type and veg-type dependent parameters.</span></div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span><span class="comment">!           set shdfac=0.0 for bare soil surfaces</span></div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span><span class="comment"></span> </div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span><span class="comment">!&gt; - Call redprm() to set the land-surface paramters,</span></div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span><span class="comment">!! including soil-type and veg-type dependent parameters.</span></div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span>      <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga1c19b4bae5de2a391c019b6778a58dad.html#ga1c19b4bae5de2a391c019b6778a58dad">redprm</a>(errmsg, errflg)</div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span>      <span class="keywordflow">if</span>(errflg/=0) <span class="keywordflow">return</span></div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span> </div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span>        <span class="keywordflow">if</span>(ivegsrc == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span><span class="comment">!only igbp type has urban</span></div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span><span class="comment">!urban</span></div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span>         <span class="keywordflow">if</span>(vegtyp == 13)<span class="keywordflow">then</span></div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span><span class="comment">!             shdfac=0.05</span></div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span><span class="comment">!             rsmin=400.0</span></div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span><span class="comment">!             smcmax = 0.45</span></div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span><span class="comment">!             smcref = 0.42</span></div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span><span class="comment">!             smcwlt = 0.40</span></div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span><span class="comment">!             smcdry = 0.40</span></div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span>              rsmin=400.0*(1-shdfac0)+40.0*shdfac0   <span class="comment">! gvf</span></div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span>              shdfac=shdfac0                         <span class="comment">! gvf</span></div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>              smcmax = 0.45*(1-shdfac0)+smcmax*shdfac0</div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span>              smcref = 0.42*(1-shdfac0)+smcref*shdfac0</div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>              smcwlt = 0.40*(1-shdfac0)+smcwlt*shdfac0</div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>              smcdry = 0.40*(1-shdfac0)+smcdry*shdfac0</div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span> </div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span><span class="comment">!  ---  inputs:                                                            !</span></div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span><span class="comment">!          ( nsoil, vegtyp, soiltyp, slopetyp, sldpth, zsoil,              !</span></div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span><span class="comment">!  ---  outputs:                                                           !</span></div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span><span class="comment">!            cfactr, cmcmax, rsmin, rsmax, topt, refkdt, kdt,              !</span></div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span><span class="comment">!            sbeta, shdfac, rgl, hs, zbot, frzx, psisat, slope,            !</span></div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span><span class="comment">!            snup, salp, bexp, dksat, dwsat, smcmax, smcwlt,               !</span></div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span><span class="comment">!            smcref, smcdry, f1, quartz, fxexp, rtdis, nroot,              !</span></div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span><span class="comment">!            z0, czil, xlai, csoil )                                       !</span></div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span> </div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span><span class="comment">!  --- ...  bexp sfc-perts, mgehne</span><span class="comment"></span></div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span><span class="comment">!&gt; - Calculate perturbated soil type &quot;b&quot; parameter.</span></div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span><span class="comment">!! Following Gehne et al. (2019) \cite Gehne_2019 , a perturbation of LAI</span></div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span><span class="comment">!! &quot;leaf area index&quot; (xlaip) and a perturbation of the empirical exponent parameter</span></div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span><span class="comment">!! b in the soil hydraulic conductivity calculation (bexpp) are added to account for</span></div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span><span class="comment">!! the uncertainties of LAI and b associated with different vegetation types and soil </span></div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span><span class="comment">!! types using a linear scaling. The spatial pattern of xlaip is drawn from a normal </span></div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span><span class="comment">!! distribution with a standard deviation of 0.25 while makes the LAI between 0 and 8.</span></div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span><span class="comment">!! The spatial pattern of bexpp is drawn from a normal distribution with a standard </span></div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span><span class="comment">!! deviation of 0.4, and is bounded between -1 and 1.</span></div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span> </div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span>      <span class="keywordflow">if</span>( bexpp &lt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span>         bexp = bexp * max(1.+bexpp, 0.)</div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span>      <span class="keywordflow">if</span>( bexpp &gt;= 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span>         bexp = bexp * min(1.+bexpp, 2.)</div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span><span class="comment">!  --- ...  lai sfc-perts, mgehne</span><span class="comment"></span></div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span><span class="comment">!&gt; - Calculate perturbated leaf area index.</span></div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span>      xlai = xlai * (1.+xlaip)</div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span>      xlai = max(xlai, .75)</div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span><span class="comment"></span> </div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span><span class="comment">!&gt; - Initialize precipitation logicals.</span></div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span> </div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span>      snowng = .false.</div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span>      frzgra = .false.</div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span><span class="comment"></span> </div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span><span class="comment">!&gt; - Over sea-ice or glacial-ice, if water-equivalent snow depth (\a sneqv) below threshold</span></div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span><span class="comment">!! lower bound (0.01 m for sea-ice, 0.10 m for glacial-ice), then</span></div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span><span class="comment">!! set at lower bound and store the source increment in subsurface</span></div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span><span class="comment">!! runoff/baseflow (runoff2).</span></div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span><span class="comment">!    note - runoff2 is then a negative value (as a flag) over sea-ice or</span></div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span><span class="comment">!           glacial-ice, in order to achieve water balance.</span></div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span> </div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span>      <span class="keywordflow">if</span> (ice == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span> </div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span>        <span class="keywordflow">if</span> (sneqv &lt; 0.01) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span>          sneqv = 0.01</div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span>          snowh = 0.10</div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span><span class="comment">!         snowh = sneqv / sndens</span></div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span> </div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>      <span class="keywordflow">elseif</span> (ice == -1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span> </div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span>        <span class="keywordflow">if</span> (sneqv &lt; 0.10) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span><span class="comment">!         sndens = sneqv / snowh</span></div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span><span class="comment">!         runoff2 = -(0.10 - sneqv) / dt</span></div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>          sneqv = 0.10</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span>          snowh = 1.00</div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span><span class="comment">!         snowh = sneqv / sndens</span></div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span> </div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_ice_block</span></div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span><span class="comment"></span> </div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span><span class="comment">!&gt; - For sea-ice and glacial-ice cases, set smc and sh2o values = 1.0</span></div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span><span class="comment">!! as a flag for non-soil medium.</span></div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span> </div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>      <span class="keywordflow">if</span> (ice /= 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span>        <span class="keywordflow">do</span> kz = 1, nsoil</div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span>          smc(kz) = 1.0</div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>          sh2o(kz) = 1.0</div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span><span class="comment"></span> </div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span><span class="comment">!&gt; - If input snowpack (\a sneqv) is nonzero, then call csnow() to compute</span></div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span><span class="comment">!! snow density (\a sndens) and snow thermal conductivity (\a sncond).</span></div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span><span class="comment">! (note that csnow is a function subroutine)</span></div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span> </div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span>      <span class="keywordflow">if</span> (sneqv .eq. 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span>        sndens = 0.0</div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span>        snowh = 0.0</div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span>        sncond = 1.0</div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span>        sndens = sneqv / snowh</div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span>        sndens = max( 0.0, min( 1.0, sndens ))   <span class="comment">! added by moorthi</span></div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span> </div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga028fc448a3afe77726222a337008ffa4.html#ga028fc448a3afe77726222a337008ffa4">csnow</a></div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span><span class="comment">!          ( sndens,                                                    !</span></div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span><span class="comment">!  ---  outputs:                                                        !</span></div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span><span class="comment">!            sncond )                                                   !</span></div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span> </div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span><span class="comment"></span> </div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span><span class="comment">!&gt; - Determine if it&#39;s precipitating and what kind of precipitation it is.</span></div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span><span class="comment">!! if it&#39;s precipitating and the air temperature is colder than \f$0^oC\f$,</span></div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span><span class="comment">!! it&#39;s snowing! if it&#39;s precipitating and the air temperature is warmer than</span></div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span><span class="comment">!! \f$0^oC\f$, but the ground temperature is colder than \f$0^oC\f$, freezing</span></div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span><span class="comment">!! rain is presumed to be falling.</span></div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno">  544</span> </div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span>      <span class="keywordflow">if</span> (prcp &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span>        <span class="keywordflow">if</span> (ffrozp &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span>          snowng = .true.</div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span>          <span class="keywordflow">if</span> (t1 &lt;= tfreez) frzgra = .true.</div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span><span class="comment"></span> </div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span><span class="comment">!&gt; - If either precipitation flag (\a snowng, \a frzgra) is set as true:</span></div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span><span class="comment">! determine new snowfall (converting precipitation rate from</span></div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span><span class="comment">! \f$kg m^{-2} s^{-1}\f$ to a liquid equiv snow depth in meters)</span></div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span><span class="comment">!  and add it to the existing snowpack.</span><span class="comment"></span></div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span><span class="comment">!&gt;  - Since all precip is added to snowpack, no precip infiltrates</span></div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span><span class="comment">!! into the soil so that \a prcp1 is set to zero.</span></div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span> </div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span>      <span class="keywordflow">if</span> (snowng .or. frzgra) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span> </div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span><span class="comment">!   snowfall</span></div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span>       <span class="keywordflow">if</span> (snowng) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span>        sn_new = ffrozp*prcp * dt * 0.001</div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span>        sneqv = sneqv + sn_new</div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span>        prcp1 = (1.-ffrozp)*prcp</div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span><span class="comment">!    freezing rain</span></div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span>       <span class="keywordflow">if</span> (frzgra) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span>        sn_new = prcp * dt * 0.001</div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span>        sneqv = sneqv + sn_new</div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span>        prcp1 = 0.0</div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span><span class="comment"></span> </div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span><span class="comment">!&gt;  - Call snow_new() to update snow density based on new snowfall,</span></div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span><span class="comment">!! using old and new snow.</span></div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gab816dbe84c4db91178251b08553c6d02.html#gab816dbe84c4db91178251b08553c6d02">snow_new</a></div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span><span class="comment">!          ( sfctmp, sn_new, rhonewsn, exticeden,                       !</span></div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span><span class="comment">!  ---  input/outputs:                                                  !</span></div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span><span class="comment">!            snowh, sndens )                                            !</span></div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span><span class="comment"></span> </div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span><span class="comment">!&gt;  - Call csnow() to update snow thermal conductivity.</span></div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga028fc448a3afe77726222a337008ffa4.html#ga028fc448a3afe77726222a337008ffa4">csnow</a></div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span><span class="comment">!          ( sndens,                                                    !</span></div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span><span class="comment">!  ---  outputs:                                                        !</span></div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span><span class="comment">!            sncond )                                                   !</span></div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span> </div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span><span class="comment"></span> </div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span><span class="comment">!&gt; - If precipitation is liquid (rain), hence save in the precip variable</span></div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span><span class="comment">!! that later can wholely or partially infiltrate the soil (along</span></div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span><span class="comment">!! with any canopy &quot;drip&quot; added to this later).</span></div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span> </div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span>        prcp1 = prcp</div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span> </div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_snowng_block</span></div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span><span class="comment"></span> </div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span><span class="comment">!&gt; - Determine snowcover fraction and albedo fraction over sea-ice, </span></div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span><span class="comment">!! glacial-ice, and land.</span></div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span> </div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span>      <span class="keywordflow">if</span> (ice /= 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span> </div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span><span class="comment">!  --- ...  snow cover, albedo over sea-ice, glacial-ice</span></div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span> </div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span>        sncovr = 1.0</div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span>        <a class="code hl_function" href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a> = 0.65</div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span> </div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span> </div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span><span class="comment">!  --- ...  non-glacial land</span></div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span><span class="comment">!           if snow depth=0, set snowcover fraction=0, albedo=snow free albedo.</span></div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span> </div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span>        <span class="keywordflow">if</span> (sneqv == 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno">  616</span> </div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>          sncovr = 0.0</div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span>          <a class="code hl_function" href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a> = alb</div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span> </div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span> </div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span><span class="comment">!  --- ...  determine snow fraction cover.</span></div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span><span class="comment">!           determine surface albedo modification due to snowdepth state.</span><span class="comment"></span></div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span><span class="comment">!&gt;  - Call snfrac() to calculate snow fraction cover.</span></div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gafca324f1a0f2bcca12116291bfc8ad68.html#gafca324f1a0f2bcca12116291bfc8ad68">snfrac</a></div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span><span class="comment">!          ( sneqv, snup, salp, snowh,                                  !</span></div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span><span class="comment">!  ---  outputs:                                                        !</span></div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span><span class="comment">!            sncovr )                                                   !</span></div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span><span class="comment"></span> </div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span><span class="comment">!&gt;  - Call alcalc() to calculate surface albedo modification due to snowdepth</span></div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span><span class="comment">!! state.</span></div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga18a0f02e4a1a32b6cde35cbe67b09908.html#ga18a0f02e4a1a32b6cde35cbe67b09908">alcalc</a></div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno">  635</span><span class="comment">!          ( alb, snoalb, shdfac, shdmin, sncovr, tsnow,                !</span></div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span><span class="comment">!  ---  outputs:                                                        !</span></div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span><span class="comment">!            albedo )                                                   !</span></div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span> </div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_sneqv_block</span></div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span> </div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_ice_block</span></div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span> </div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno">  643</span><span class="comment">!  --- ...  thermal conductivity for sea-ice case, glacial-ice case</span><span class="comment"></span></div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span><span class="comment">!&gt; - Calculate thermal diffusivity (\a df1):</span></div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span><span class="comment">!&gt;  - For sea-ice case and glacial-ice case, this is constant(\f$df1=2.2\f$).</span></div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span> </div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span>      <span class="keywordflow">if</span> (ice /= 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span> </div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span>        df1 = 2.2</div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span> </div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span>      <span class="keywordflow">else</span><span class="comment"></span></div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span><span class="comment">!&gt;  - For non-glacial land case, call tdfcnd() to calculate the thermal</span></div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span><span class="comment">!! diffusivity of top soil layer (\cite peters-lidard_et_al_1998).</span></div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span> </div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span><span class="comment">!  --- ...  next calculate the subsurface heat flux, which first requires</span></div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span><span class="comment">!           calculation of the thermal diffusivity.  treatment of the</span></div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span><span class="comment">!           latter follows that on pages 148-149 from &quot;heat transfer in</span></div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span><span class="comment">!           cold climates&quot;, by v. j. lunardini (published in 1981</span></div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span><span class="comment">!           by van nostrand reinhold co.) i.e. treatment of two contiguous</span></div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span><span class="comment">!           &quot;plane parallel&quot; mediums (namely here the first soil layer</span></div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span><span class="comment">!           and the snowpack layer, if any). this diffusivity treatment</span></div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span><span class="comment">!           behaves well for both zero and nonzero snowpack, including the</span></div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span><span class="comment">!           limit of very thin snowpack.  this treatment also eliminates</span></div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span><span class="comment">!           the need to impose an arbitrary upper bound on subsurface</span></div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span><span class="comment">!           heat flux when the snowpack becomes extremely thin.</span></div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span> </div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span><span class="comment">!  --- ...   first calculate thermal diffusivity of top soil layer, using</span></div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span><span class="comment">!            both the frozen and liquid soil moisture, following the</span></div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span><span class="comment">!            soil thermal diffusivity function of peters-lidard et al.</span></div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span><span class="comment">!            (1998,jas, vol 55, 1209-1224), which requires the specifying</span></div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span><span class="comment">!            the quartz content of the given soil class (see routine redprm)</span></div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span> </div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga8bc3154096e6364c5fcddf884c003bef.html#ga8bc3154096e6364c5fcddf884c003bef">tdfcnd</a>                                                     &amp;</div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span>     &amp;     ( smc(1), quartz, smcmax, sh2o(1),                           &amp;</div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span>     &amp;       df1                                                        &amp;</div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span>     &amp;     )</div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno">  679</span><span class="comment">!       if(ivegsrc == 1) then</span></div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span><span class="comment">!only igbp type has urban</span></div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span><span class="comment">!urban</span></div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span><span class="comment">!           if ( vegtyp == 13 ) df1=3.24</span></div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span><span class="comment">!       endif</span></div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span><span class="comment"></span> </div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span><span class="comment">!&gt;   - Add subsurface heat flux reduction effect from the</span></div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span><span class="comment">!!  overlying green canopy, adapted from section 2.1.2 of</span></div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span><span class="comment">!!  \cite peters-lidard_et_al_1997.</span></div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span><span class="comment">!wz only urban for igbp type</span></div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span><span class="comment">!</span></div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span><span class="comment">!jhan urban canopy heat storage effect is included in pbl scheme</span></div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span><span class="comment">!</span></div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span>        <span class="keywordflow">if</span>((.not.lheatstrg) .and.                                       &amp;</div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span>     &amp;      (ivegsrc == 1 .and. vegtyp == 13)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span>          df1 = 3.24*(1.-shdfac) + shdfac*df1*exp(sbeta*shdfac)</div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span>          df1 = df1 * exp( sbeta*shdfac )</div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span> </div>
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno">  699</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_ice_block</span></div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span> </div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span><span class="comment">!  --- ...  finally &quot;plane parallel&quot; snowpack effect following</span></div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span><span class="comment">!           v.j. linardini reference cited above. note that dtot is</span></div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span><span class="comment">!           combined depth of snowdepth and thickness of first soil layer</span></div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span> </div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span>      dsoil = -0.5 * zsoil(1)</div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span> </div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span>      <span class="keywordflow">if</span> (sneqv == 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span> </div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span>        ssoil = df1 * (t1 - stc(1)) / dsoil</div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span> </div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span> </div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span>        dtot = snowh + dsoil</div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span>        frcsno = snowh / dtot</div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span>        frcsoi = dsoil / dtot</div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span> </div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span><span class="comment">!  --- ...  1. harmonic mean (series flow)</span></div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span> </div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span><span class="comment">!       df1  = (sncond*df1) / (frcsoi*sncond + frcsno*df1)</span></div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span><span class="comment">!       df1h = (sncond*df1) / (frcsoi*sncond + frcsno*df1)</span></div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span> </div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span><span class="comment">!  --- ...  2. arithmetic mean (parallel flow)</span></div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span> </div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span><span class="comment">!       df1  = frcsno*sncond + frcsoi*df1</span></div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span>        df1a = frcsno*sncond + frcsoi*df1</div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span> </div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span><span class="comment">!  --- ...  3. geometric mean (intermediate between harmonic and arithmetic mean)</span></div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span> </div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span><span class="comment">!       df1 = (sncond**frcsno) * (df1**frcsoi)</span></div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span><span class="comment">!       df1 = df1h*sncovr + df1a*(1.0-sncovr)</span></div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span><span class="comment">!       df1 = df1h*sncovr + df1 *(1.0-sncovr)</span></div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>        df1 = df1a*sncovr + df1 *(1.0-sncovr)</div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span><span class="comment"></span> </div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span><span class="comment">!&gt; - Calculate subsurface heat flux, \a ssoil, from final thermal</span></div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span><span class="comment">!! diffusivity of surface mediums,\a df1 above, and skin</span></div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span><span class="comment">!! temperature and top mid-layer soil temperature.</span></div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span> </div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span>        ssoil = df1 * (t1 - stc(1)) / dtot</div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span> </div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_sneqv_block</span></div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span><span class="comment"></span> </div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span><span class="comment">!&gt; - For uncoupled mode, call snowz0() to calculate surface roughness</span></div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span><span class="comment">!! (\a z0) over snowpack using snow condition from the previous timestep.</span></div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span> </div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span><span class="comment">!     if (couple == 0) then            ! uncoupled mode</span></div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span>        <span class="keywordflow">if</span> (sncovr &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span> </div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga95d889f436d70014fe640fa1b2420545.html#ga95d889f436d70014fe640fa1b2420545">snowz0</a></div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span><span class="comment">!          ( sncovr,                                                    !</span></div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span><span class="comment">!  ---  input/outputs:                                                  !</span></div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span><span class="comment">!            z0 )                                                       !</span></div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span> </div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span><span class="comment">!     endif</span></div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span><span class="comment"></span> </div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span><span class="comment">!&gt; - Calculate virtual temps and virtual potential temps needed by</span></div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span><span class="comment">!!           subroutines sfcdif and penman.</span></div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span> </div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span>      t2v = sfctmp * (1.0 + 0.61*q2)</div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno">  761</span> </div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno">  762</span><span class="comment">!  --- ...  next call routine sfcdif to calculate the sfc exchange coef (ch)</span></div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span><span class="comment">!           for heat and moisture.</span></div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span><span class="comment">!    note - comment out call sfcdif, if sfcdif already called in calling</span></div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span><span class="comment">!           program (such as in coupled atmospheric model).</span></div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span><span class="comment">!         - do not call sfcdif until after above call to redprm, in case</span></div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span><span class="comment">!           alternative values of roughness length (z0) and zilintinkevich</span></div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span><span class="comment">!           coef (czil) are set there via namelist i/o.</span></div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span><span class="comment">!         - routine sfcdif returns a ch that represents the wind spd times</span></div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span><span class="comment">!           the &quot;original&quot; nondimensional &quot;ch&quot; typical in literature.  hence</span></div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span><span class="comment">!           the ch returned from sfcdif has units of m/s.  the important</span></div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span><span class="comment">!           companion coefficient of ch, carried here as &quot;rch&quot;, is the ch</span></div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span><span class="comment">!           from sfcdif times air density and parameter &quot;cp&quot;.  &quot;rch&quot; is</span></div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span><span class="comment">!           computed in &quot;call penman&quot;. rch rather than ch is the coeff</span></div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span><span class="comment">!           usually invoked later in eqns.</span></div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span><span class="comment">!         - sfcdif also returns the surface exchange coefficient for momentum,</span></div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span><span class="comment">!           cm, also known as the surface drage coefficient, but cm is not</span></div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span><span class="comment">!           used here.</span></div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span> </div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span><span class="comment">!  --- ...  key required radiation term is the total downward radiation</span></div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span><span class="comment">!           (fdown) = net solar (swnet) + downward longwave (lwdn),</span></div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span><span class="comment">!           for use in penman ep calculation (penman) and other surface</span></div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span><span class="comment">!           energy budget calcuations.  also need downward solar (swdn)</span></div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span><span class="comment">!           for canopy resistance routine (canres).</span></div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span><span class="comment">!    note - fdown, swdn are derived differently in the uncoupled and</span></div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span><span class="comment">!           coupled modes.</span></div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span><span class="comment"></span> </div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span><span class="comment">!&gt; - Calculate the total downward radiation (\a fdown) = net solar (\a swnet) +</span></div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span><span class="comment">!!  downward longwave (\a lwdn) as input of penman() and other surface</span></div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span><span class="comment">!! energy budget calculations.</span></div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span> </div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span>      <span class="keywordflow">if</span> (couple == 0) <span class="keywordflow">then</span>                      <span class="comment">!......uncoupled mode</span></div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno">  793</span> </div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span><span class="comment">!  --- ...  uncoupled mode:</span></div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span><span class="comment">!           compute surface exchange coefficients</span></div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span> </div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>        t1v  = t1  * (1.0 + 0.61 * q2)</div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span>        th2v = th2 * (1.0 + 0.61 * q2)</div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span> </div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gafdc2dc9815673befca7228be47616e41.html#gafdc2dc9815673befca7228be47616e41">sfcdif</a></div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span><span class="comment">!          ( zlvl, z0, t1v, th2v, sfcspd, czil,                         !</span></div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span><span class="comment">!  ---  input/outputs:                                                  !</span></div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span><span class="comment">!            cm, ch )                                                   !</span></div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span> </div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span><span class="comment">!     swnet = net solar radiation into the ground (w/m2; dn-up) from input</span></div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span><span class="comment">!     fdown  = net solar + downward lw flux at sfc (w/m2)</span></div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span> </div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span>        fdown = swnet + lwdn</div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span> </div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span>      <span class="keywordflow">else</span>                                       <span class="comment">!......coupled mode</span></div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span> </div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span><span class="comment">!  --- ...  coupled mode (couple .ne. 0):</span></div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span><span class="comment">!           surface exchange coefficients computed externally and passed in,</span></div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span><span class="comment">!           hence subroutine sfcdif not called.</span></div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span> </div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span><span class="comment">!     swnet = net solar radiation into the ground (w/m2; dn-up) from input</span></div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno">  818</span><span class="comment">!     fdown  = net solar + downward lw flux at sfc (w/m2)</span></div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span> </div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span>        fdown = swnet + lwdn</div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span> </div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_couple_block</span></div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span><span class="comment"></span> </div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span><span class="comment">!&gt; - Call penman() to calculate potential evaporation (\a etp),</span></div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span><span class="comment">!! and other partial products and sums for later</span></div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span><span class="comment">!! calculations.</span></div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span> </div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span>      <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga25b90f8a8049eb17cc6cb6a3fecf3fdc.html#ga25b90f8a8049eb17cc6cb6a3fecf3fdc">penman</a></div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span><span class="comment">!          ( sfctmp, sfcprs, sfcems, ch, t2v, th2, prcp, fdown,         !</span></div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span><span class="comment">!            ssoil, q2, q2sat, dqsdt2, snowng, frzgra,                  !</span></div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span><span class="comment">!  ---  outputs:                                                        !</span></div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span><span class="comment">!            t24, etp, rch, epsca, rr, flx2 )                           !</span></div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span><span class="comment"></span> </div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span><span class="comment">!&gt; - Call canres() to calculate the canopy resistance and convert it</span></div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span><span class="comment">!! into pc if nonzero greenness fraction.</span></div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span> </div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>      <span class="keywordflow">if</span> (shdfac &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span> </div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span><span class="comment">!  --- ...  frozen ground extension: total soil water &quot;smc&quot; was replaced</span></div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span><span class="comment">!           by unfrozen soil water &quot;sh2o&quot; in call to canres below</span></div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span> </div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gaa292bfa0bd38e58ab9389cb38e4d09c0.html#gaa292bfa0bd38e58ab9389cb38e4d09c0">canres</a></div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span><span class="comment">!          ( nsoil, nroot, swdn, ch, q2, q2sat, dqsdt2, sfctmp,         !</span></div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span><span class="comment">!            sfcprs, sfcems, sh2o, smcwlt, smcref, zsoil, rsmin,        !</span></div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span><span class="comment">!            rsmax, topt, rgl, hs, xlai,                                !</span></div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span><span class="comment">!  ---  outputs:                                                        !</span></div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span><span class="comment">!            rc, pc, rcs, rct, rcq, rcsoil )                            !</span></div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span> </div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span><span class="comment"></span> </div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span><span class="comment">!&gt; - Now decide major pathway branch to take depending on whether</span></div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span><span class="comment">!!           snowpack exists or not:</span></div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno">  855</span> </div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>      esnow = 0.0</div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span> </div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>      <span class="keywordflow">if</span> (sneqv .eq. 0.0) <span class="keywordflow">then</span><span class="comment"></span></div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span><span class="comment">!&gt;  - For no snowpack is present, call nopac() to calculate soil moisture</span></div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span><span class="comment">!! and heat flux values and update soil moisture contant and soil heat</span></div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span><span class="comment">!! content values.</span></div>
<div class="line"><a id="l00862" name="l00862"></a><span class="lineno">  862</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga92994e4737ecfd692a6704778558c9c2.html#ga92994e4737ecfd692a6704778558c9c2">nopac</a></div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span><span class="comment">!          ( nsoil, nroot, etp, prcp, smcmax, smcwlt, smcref,           !</span></div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno">  865</span><span class="comment">!            smcdry, cmcmax, dt, shdfac, sbeta, sfctmp, sfcems,         !</span></div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span><span class="comment">!            t24, th2, fdown, epsca, bexp, pc, rch, rr, cfactr,         !</span></div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span><span class="comment">!            slope, kdt, frzx, psisat, zsoil, dksat, dwsat,             !</span></div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span><span class="comment">!            zbot, ice, rtdis, quartz, fxexp, csoil, lheatstrg,         !</span></div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span><span class="comment">!  ---  input/outputs:                                                  !</span></div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span><span class="comment">!            cmc, t1, stc, sh2o, tbot,                                  !</span></div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span><span class="comment">!  ---  outputs:                                                        !</span></div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span><span class="comment">!            eta, smc, ssoil, runoff1, runoff2, runoff3, edir,          !</span></div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span><span class="comment">!            ec, et, ett, beta, drip, dew, flx1, flx3 )                 !</span></div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span> </div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span><span class="comment"></span> </div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span><span class="comment">!&gt;  - For a snowpack is present, call snopac().</span></div>
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno">  878</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gad65a889bf3f431ade2a312674671ab41.html#gad65a889bf3f431ade2a312674671ab41">snopac</a></div>
<div class="line"><a id="l00879" name="l00879"></a><span class="lineno">  879</span><span class="comment">!  ---  inputs:                                                         !</span></div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span><span class="comment">!          ( nsoil, nroot, etp, prcp, smcmax, smcwlt, smcref, smcdry,   !</span></div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span><span class="comment">!            cmcmax, dt, df1, sfcems, sfctmp, t24, th2, fdown, epsca,   !</span></div>
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno">  882</span><span class="comment">!            bexp, pc, rch, rr, cfactr, slope, kdt, frzx, psisat,       !</span></div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span><span class="comment">!            zsoil, dwsat, dksat, zbot, shdfac, ice, rtdis, quartz,     !</span></div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span><span class="comment">!            fxexp, csoil, flx2, snowng, lheatstrg,                     !</span></div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span><span class="comment">!  ---  input/outputs:                                                  !</span></div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span><span class="comment">!            prcp1, cmc, t1, stc, sncovr, sneqv, sndens, snowh,         !</span></div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno">  887</span><span class="comment">!            sh2o, tbot, beta,                                          !</span></div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span><span class="comment">!  ---  outputs:                                                        !</span></div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span><span class="comment">!            smc, ssoil, runoff1, runoff2, runoff3, edir, ec, et,       !</span></div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span><span class="comment">!            ett, snomlt, drip, dew, flx1, flx3, esnow )                !</span></div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span> </div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span><span class="comment">!  run-total accumulated snow based on snowfall and snowmelt in [m]</span></div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span> </div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span> </div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span><span class="comment"></span> </div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span><span class="comment">!&gt; - Noah LSM post-processing:</span></div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span><span class="comment">!&gt;  - Calculate sensible heat (h) for return to parent model.</span></div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span> </div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span>      sheat = -(ch*cp1*sfcprs) / (rd1*t2v) * (th2 - t1)</div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span><span class="comment"></span> </div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span><span class="comment">!&gt;  - Convert units and/or sign of total evap (eta), potential evap (etp),</span></div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span><span class="comment">!!  subsurface heat flux (s), and runoffs for what parent model expects.</span></div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span><span class="comment">!   convert eta from kg m-2 s-1 to w m-2</span></div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span><span class="comment">!     eta = eta * lsubc</span></div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span><span class="comment">!     etp = etp * lsubc</span></div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span> </div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span>      edir = edir * lsubc</div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span>      ec = ec * lsubc</div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span> </div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span>      <span class="keywordflow">do</span> k = 1, 4</div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span>        et(k) = et(k) * lsubc</div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span> </div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span>      ett = ett * lsubc</div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span>      esnow = esnow * lsubs</div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span>      etp = etp * ((1.0 - sncovr)*lsubc + sncovr*lsubs)</div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span> </div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span>      <span class="keywordflow">if</span> (etp &gt; 0.) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span>        eta = edir + ec + ett + esnow</div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span>        eta = etp</div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span> </div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span>      <span class="keywordflow">if</span> (etp == 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span>        beta = 0.0</div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span>        beta = eta/etp</div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span><span class="comment"></span> </div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span><span class="comment">!&gt;  - Convert the sign of soil heat flux so that:</span></div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span><span class="comment">!!   -  ssoil&gt;0: warm the surface  (night time)</span></div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span><span class="comment">!!   -  ssoil&lt;0: cool the surface  (day time)</span></div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span> </div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span>      ssoil = -1.0 * ssoil</div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span> </div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span>      <span class="keywordflow">if</span> (ice == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span><span class="comment"></span> </div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span><span class="comment">!&gt;  - For the case of land (but not glacial-ice):</span></div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span><span class="comment">!!  convert runoff3 (internal layer runoff from supersat) from \f$m\f$</span></div>
<div class="line"><a id="l00941" name="l00941"></a><span class="lineno">  941</span><span class="comment">!!  to \f$ms^-1\f$ and add to subsurface runoff/baseflow (runoff2).</span></div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span><span class="comment">!!  runoff2 is already a rate at this point.</span></div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span> </div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span>        runoff3 = runoff3 / dt</div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span>        runoff2 = runoff2 + runoff3</div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span> </div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span><span class="comment"></span> </div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span><span class="comment">!&gt;  - For the case of sea-ice (ice=1) or glacial-ice (ice=-1), add any</span></div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span><span class="comment">!! snowmelt directly to surface runoff (runoff1) since there is no</span></div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span><span class="comment">!! soil medium, and thus no call to subroutine smflx (for soil</span></div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span><span class="comment">!! moisture tendency).</span></div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span> </div>
<div class="line"><a id="l00954" name="l00954"></a><span class="lineno">  954</span>        runoff1 = snomlt / dt</div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span><span class="comment"></span> </div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span><span class="comment">!&gt;  - Calculate total column soil moisture in meters (soilm) and root-zone</span></div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span><span class="comment">!! soil moisture availability (fraction) relative to porosity/saturation.</span></div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span> </div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span>      soilm = -1.0 * smc(1) * zsoil(1)</div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span>      <span class="keywordflow">do</span> k = 2, nsoil</div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span>        soilm = soilm + smc(k)*(zsoil(k-1) - zsoil(k))</div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span> </div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span>      soilwm = -1.0 * (smcmax - smcwlt) * zsoil(1)</div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span>      soilww = -1.0 * (smc(1) - smcwlt) * zsoil(1)</div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span>      <span class="keywordflow">do</span> k = 2, nroot</div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span>        soilwm = soilwm + (smcmax - smcwlt) * (zsoil(k-1) - zsoil(k))</div>
<div class="line"><a id="l00969" name="l00969"></a><span class="lineno">  969</span>        soilww = soilww + (smc(k) - smcwlt) * (zsoil(k-1) - zsoil(k))</div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span> </div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span>      soilw = soilww / soilwm</div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span><span class="comment">!</span></div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span>      <span class="keywordflow">return</span></div>
<div class="line"><a id="l00975" name="l00975"></a><span class="lineno">  975</span> </div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span> </div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span><span class="comment">! =================</span></div>
<div class="line"><a id="l00978" name="l00978"></a><span class="lineno">  978</span>      <span class="keyword">contains</span></div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span><span class="comment">! =================</span></div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span> </div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span><span class="comment">!*************************************!</span></div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span><span class="comment">!  section-1  1st level subprograms   !</span></div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span><span class="comment">!*************************************!</span></div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span> </div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span><span class="comment">!&gt; This subroutine calculates albedo including snow effect (0 -&gt; 1).</span></div>
<div class="foldopen" id="foldopen00988" data-start="" data-end="">
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga18a0f02e4a1a32b6cde35cbe67b09908.html#ga18a0f02e4a1a32b6cde35cbe67b09908">  988</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga18a0f02e4a1a32b6cde35cbe67b09908.html#ga18a0f02e4a1a32b6cde35cbe67b09908">alcalc</a></div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span><span class="comment">!...................................</span></div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span><span class="comment">!    &amp;     ( alb, snoalb, shdfac, shdmin, sncovr, tsnow,                &amp;</span></div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span><span class="comment">!    &amp;       albedo                                                     &amp;</span></div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span><span class="comment">!    &amp;     )</span></div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span> </div>
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno">  996</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span><span class="comment">!  subroutine alcalc calculates albedo including snow effect (0 -&gt; 1)   !</span></div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span><span class="comment">!  inputs from calling program:                                  size   !</span></div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span><span class="comment">!     alb      - real, snowfree albedo                             1    !</span></div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span><span class="comment">!     snoalb   - real, maximum (deep) snow albedo                  1    !</span></div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span><span class="comment">!     shdfac   - real, areal fractional coverage of green veg.     1    !</span></div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span><span class="comment">!     shdmin   - real, minimum areal coverage of green veg.        1    !</span></div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span><span class="comment">!     sncovr   - real, fractional snow cover                       1    !</span></div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span><span class="comment">!     tsnow    - real, snow surface temperature (k)                1    !</span></div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"> 1014</span><span class="comment">!  outputs to calling program:                                          !</span></div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span><span class="comment">!     albedo   - real, surface albedo including snow effect        1    !</span></div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l01018" name="l01018"></a><span class="lineno"> 1018</span><span class="comment">!</span></div>
<div class="line"><a id="l01019" name="l01019"></a><span class="lineno"> 1019</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01020" name="l01020"></a><span class="lineno"> 1020</span><span class="comment">!     real (kind=kind_phys), intent(in) :: alb, snoalb, shdfac,         &amp;</span></div>
<div class="line"><a id="l01021" name="l01021"></a><span class="lineno"> 1021</span><span class="comment">!    &amp;       shdmin, sncovr, tsnow</span></div>
<div class="line"><a id="l01022" name="l01022"></a><span class="lineno"> 1022</span> </div>
<div class="line"><a id="l01023" name="l01023"></a><span class="lineno"> 1023</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01024" name="l01024"></a><span class="lineno"> 1024</span><span class="comment">!     real (kind=kind_phys), intent(out) :: albedo</span></div>
<div class="line"><a id="l01025" name="l01025"></a><span class="lineno"> 1025</span> </div>
<div class="line"><a id="l01026" name="l01026"></a><span class="lineno"> 1026</span><span class="comment">!  ---  locals: (none)</span></div>
<div class="line"><a id="l01027" name="l01027"></a><span class="lineno"> 1027</span> </div>
<div class="line"><a id="l01028" name="l01028"></a><span class="lineno"> 1028</span><span class="comment">!</span></div>
<div class="line"><a id="l01029" name="l01029"></a><span class="lineno"> 1029</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l01030" name="l01030"></a><span class="lineno"> 1030</span><span class="comment">!</span></div>
<div class="line"><a id="l01031" name="l01031"></a><span class="lineno"> 1031</span><span class="comment">!  --- ...  snoalb is argument representing maximum albedo over deep snow,</span></div>
<div class="line"><a id="l01032" name="l01032"></a><span class="lineno"> 1032</span><span class="comment">!           as passed into sflx, and adapted from the satellite-based</span></div>
<div class="line"><a id="l01033" name="l01033"></a><span class="lineno"> 1033</span><span class="comment">!           maximum snow albedo fields provided by d. robinson and g. kukla</span></div>
<div class="line"><a id="l01034" name="l01034"></a><span class="lineno"> 1034</span><span class="comment">!           (1985, jcam, vol 24, 402-411)</span></div>
<div class="line"><a id="l01035" name="l01035"></a><span class="lineno"> 1035</span> </div>
<div class="line"><a id="l01036" name="l01036"></a><span class="lineno"> 1036</span><span class="comment">!         albedo = alb + (1.0-(shdfac-shdmin))*sncovr*(snoalb-alb)</span></div>
<div class="line"><a id="l01037" name="l01037"></a><span class="lineno"> 1037</span>          <a class="code hl_function" href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a> = alb + sncovr*(snoalb - alb)</div>
<div class="line"><a id="l01038" name="l01038"></a><span class="lineno"> 1038</span> </div>
<div class="line"><a id="l01039" name="l01039"></a><span class="lineno"> 1039</span>          <span class="keywordflow">if</span> (<a class="code hl_function" href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a> &gt; snoalb) <a class="code hl_function" href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a> = snoalb</div>
<div class="line"><a id="l01040" name="l01040"></a><span class="lineno"> 1040</span> </div>
<div class="line"><a id="l01041" name="l01041"></a><span class="lineno"> 1041</span><span class="comment">!  --- ...  base formulation (dickinson et al., 1986, cogley et al., 1990)</span></div>
<div class="line"><a id="l01042" name="l01042"></a><span class="lineno"> 1042</span> </div>
<div class="line"><a id="l01043" name="l01043"></a><span class="lineno"> 1043</span><span class="comment">!     if (tsnow &lt;= 263.16) then</span></div>
<div class="line"><a id="l01044" name="l01044"></a><span class="lineno"> 1044</span><span class="comment">!       albedo = snoalb</span></div>
<div class="line"><a id="l01045" name="l01045"></a><span class="lineno"> 1045</span><span class="comment">!     else</span></div>
<div class="line"><a id="l01046" name="l01046"></a><span class="lineno"> 1046</span><span class="comment">!       if (tsnow &lt; 273.16) then</span></div>
<div class="line"><a id="l01047" name="l01047"></a><span class="lineno"> 1047</span><span class="comment">!         tm = 0.1 * (tsnow - 263.16)</span></div>
<div class="line"><a id="l01048" name="l01048"></a><span class="lineno"> 1048</span><span class="comment">!         albedo = 0.5 * ((0.9 - 0.2*(tm**3)) + (0.8 - 0.16*(tm**3)))</span></div>
<div class="line"><a id="l01049" name="l01049"></a><span class="lineno"> 1049</span><span class="comment">!       else</span></div>
<div class="line"><a id="l01050" name="l01050"></a><span class="lineno"> 1050</span><span class="comment">!         albedo = 0.67</span></div>
<div class="line"><a id="l01051" name="l01051"></a><span class="lineno"> 1051</span><span class="comment">!       endif</span></div>
<div class="line"><a id="l01052" name="l01052"></a><span class="lineno"> 1052</span><span class="comment">!     endif</span></div>
<div class="line"><a id="l01053" name="l01053"></a><span class="lineno"> 1053</span> </div>
<div class="line"><a id="l01054" name="l01054"></a><span class="lineno"> 1054</span><span class="comment">!  --- ...  isba formulation (verseghy, 1991; baker et al., 1990)</span></div>
<div class="line"><a id="l01055" name="l01055"></a><span class="lineno"> 1055</span> </div>
<div class="line"><a id="l01056" name="l01056"></a><span class="lineno"> 1056</span><span class="comment">!     if (tsnow &lt; 273.16) then</span></div>
<div class="line"><a id="l01057" name="l01057"></a><span class="lineno"> 1057</span><span class="comment">!       albedo = snoalb - 0.008*dt/86400</span></div>
<div class="line"><a id="l01058" name="l01058"></a><span class="lineno"> 1058</span><span class="comment">!     else</span></div>
<div class="line"><a id="l01059" name="l01059"></a><span class="lineno"> 1059</span><span class="comment">!       albedo = (snoalb - 0.5) * exp( -0.24*dt/86400 ) + 0.5</span></div>
<div class="line"><a id="l01060" name="l01060"></a><span class="lineno"> 1060</span><span class="comment">!     endif</span></div>
<div class="line"><a id="l01061" name="l01061"></a><span class="lineno"> 1061</span> </div>
<div class="line"><a id="l01062" name="l01062"></a><span class="lineno"> 1062</span><span class="comment">!</span></div>
<div class="line"><a id="l01063" name="l01063"></a><span class="lineno"> 1063</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l01064" name="l01064"></a><span class="lineno"> 1064</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga18a0f02e4a1a32b6cde35cbe67b09908.html#ga18a0f02e4a1a32b6cde35cbe67b09908">alcalc</a></div>
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"> 1065</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l01066" name="l01066"></a><span class="lineno"> 1066</span> </div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span> </div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"> 1068</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span><span class="comment">!&gt; This subroutine calculates canopy resistance which depends on incoming</span></div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span><span class="comment">!! solar radiation, air temperature, atmospheric water vapor pressure</span></div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span><span class="comment">!! deficit at the lowest model level, and soil moisture (preferably unfrozen</span></div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span><span class="comment">!! soil moisture rather than total).</span></div>
<div class="foldopen" id="foldopen01074" data-start="" data-end="">
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gaa292bfa0bd38e58ab9389cb38e4d09c0.html#gaa292bfa0bd38e58ab9389cb38e4d09c0"> 1074</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gaa292bfa0bd38e58ab9389cb38e4d09c0.html#gaa292bfa0bd38e58ab9389cb38e4d09c0">canres</a></div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span><span class="comment">!    &amp;     ( nsoil, nroot, swdn, ch, q2, q2sat, dqsdt2, sfctmp,         &amp;</span></div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span><span class="comment">!    &amp;       sfcprs, sfcems, sh2o, smcwlt, smcref, zsoil, rsmin,        &amp;</span></div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span><span class="comment">!    &amp;       rsmax, topt, rgl, hs, xlai,                                &amp;</span></div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span><span class="comment">!    &amp;       rc, pc, rcs, rct, rcq, rcsoil                              &amp;</span></div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span><span class="comment">!    &amp;     )</span></div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"> 1082</span> </div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span><span class="comment">!  subroutine canres calculates canopy resistance which depends on      !</span></div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span><span class="comment">!  incoming solar radiation, air temperature, atmospheric water vapor   !</span></div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span><span class="comment">!  pressure deficit at the lowest model level, and soil moisture        !</span></div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span><span class="comment">!  (preferably unfrozen soil moisture rather than total)                !</span></div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span><span class="comment">!  source:   jarvis (1976), noilhan and planton (1989, mwr), jacquemin  !</span></div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span><span class="comment">!            and noilhan (1990, blm)                                    !</span></div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span><span class="comment">!  see also: chen et al (1996, jgr, vol 101(d3), 7251-7268), eqns       !</span></div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span><span class="comment">!            12-14 and table 2 of sec. 3.1.2                            !</span></div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"> 1096</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span><span class="comment">!  inputs from calling program:                                  size   !</span></div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span><span class="comment">!     nsoil    - integer, no. of soil layers                       1    !</span></div>
<div class="line"><a id="l01103" name="l01103"></a><span class="lineno"> 1103</span><span class="comment">!     nroot    - integer, no. of soil layers in root zone (&lt;nsoil) 1    !</span></div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span><span class="comment">!     swdn     - real, incoming solar radiation                    1    !</span></div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span><span class="comment">!     ch       - real, sfc exchange coeff for heat and moisture    1    !</span></div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span><span class="comment">!     q2       - real, air humidity at 1st level above ground      1    !</span></div>
<div class="line"><a id="l01107" name="l01107"></a><span class="lineno"> 1107</span><span class="comment">!     q2sat    - real, sat. air humidity at 1st level abv ground   1    !</span></div>
<div class="line"><a id="l01108" name="l01108"></a><span class="lineno"> 1108</span><span class="comment">!     dqsdt2   - real, slope of sat. humidity function wrt temp    1    !</span></div>
<div class="line"><a id="l01109" name="l01109"></a><span class="lineno"> 1109</span><span class="comment">!     sfctmp   - real, sfc temperature at 1st level above ground   1    !</span></div>
<div class="line"><a id="l01110" name="l01110"></a><span class="lineno"> 1110</span><span class="comment">!     sfcprs   - real, sfc pressure                                1    !</span></div>
<div class="line"><a id="l01111" name="l01111"></a><span class="lineno"> 1111</span><span class="comment">!     sfcems   - real, sfc emissivity for lw radiation             1    !</span></div>
<div class="line"><a id="l01112" name="l01112"></a><span class="lineno"> 1112</span><span class="comment">!     sh2o     - real, volumetric soil moisture                  nsoil  !</span></div>
<div class="line"><a id="l01113" name="l01113"></a><span class="lineno"> 1113</span><span class="comment">!     smcwlt   - real, wilting point                               1    !</span></div>
<div class="line"><a id="l01114" name="l01114"></a><span class="lineno"> 1114</span><span class="comment">!     smcref   - real, reference soil moisture                     1    !</span></div>
<div class="line"><a id="l01115" name="l01115"></a><span class="lineno"> 1115</span><span class="comment">!     zsoil    - real, soil depth (negative sign, as below grd)  nsoil  !</span></div>
<div class="line"><a id="l01116" name="l01116"></a><span class="lineno"> 1116</span><span class="comment">!     rsmin    - real, mimimum stomatal resistance                 1    !</span></div>
<div class="line"><a id="l01117" name="l01117"></a><span class="lineno"> 1117</span><span class="comment">!     rsmax    - real, maximum stomatal resistance                 1    !</span></div>
<div class="line"><a id="l01118" name="l01118"></a><span class="lineno"> 1118</span><span class="comment">!     topt     - real, optimum transpiration air temperature       1    !</span></div>
<div class="line"><a id="l01119" name="l01119"></a><span class="lineno"> 1119</span><span class="comment">!     rgl      - real, canopy resistance func (in solar rad term)  1    !</span></div>
<div class="line"><a id="l01120" name="l01120"></a><span class="lineno"> 1120</span><span class="comment">!     hs       - real, canopy resistance func (vapor deficit term) 1    !</span></div>
<div class="line"><a id="l01121" name="l01121"></a><span class="lineno"> 1121</span><span class="comment">!     xlai     - real, leaf area index                             1    !</span></div>
<div class="line"><a id="l01122" name="l01122"></a><span class="lineno"> 1122</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01123" name="l01123"></a><span class="lineno"> 1123</span><span class="comment">!  outputs to calling program:                                          !</span></div>
<div class="line"><a id="l01124" name="l01124"></a><span class="lineno"> 1124</span><span class="comment">!     rc       - real, canopy resistance                           1    !</span></div>
<div class="line"><a id="l01125" name="l01125"></a><span class="lineno"> 1125</span><span class="comment">!     pc       - real, plant coefficient                           1    !</span></div>
<div class="line"><a id="l01126" name="l01126"></a><span class="lineno"> 1126</span><span class="comment">!     rcs      - real, incoming solar rc factor                    1    !</span></div>
<div class="line"><a id="l01127" name="l01127"></a><span class="lineno"> 1127</span><span class="comment">!     rct      - real, air temp rc factor                          1    !</span></div>
<div class="line"><a id="l01128" name="l01128"></a><span class="lineno"> 1128</span><span class="comment">!     rcq      - real, atoms vapor press deficit rc factor         1    !</span></div>
<div class="line"><a id="l01129" name="l01129"></a><span class="lineno"> 1129</span><span class="comment">!     rcsoil   - real, soil moisture rc factor                     1    !</span></div>
<div class="line"><a id="l01130" name="l01130"></a><span class="lineno"> 1130</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01131" name="l01131"></a><span class="lineno"> 1131</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l01132" name="l01132"></a><span class="lineno"> 1132</span><span class="comment">!</span></div>
<div class="line"><a id="l01133" name="l01133"></a><span class="lineno"> 1133</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01134" name="l01134"></a><span class="lineno"> 1134</span><span class="comment">!     integer, intent(in) :: nsoil, nroot</span></div>
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"> 1135</span> </div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span><span class="comment">!     real (kind=kind_phys), intent(in) :: swdn, ch, q2, q2sat,         &amp;</span></div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span><span class="comment">!    &amp;       dqsdt2, sfctmp, sfcprs, sfcems, smcwlt, smcref, rsmin,     &amp;</span></div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span><span class="comment">!    &amp;       rsmax, topt, rgl, hs, xlai, sh2o(nsoil), zsoil(nsoil)</span></div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span> </div>
<div class="line"><a id="l01140" name="l01140"></a><span class="lineno"> 1140</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01141" name="l01141"></a><span class="lineno"> 1141</span><span class="comment">!     real (kind=kind_phys), intent(out) :: rc, pc, rcs, rct, rcq,      &amp;</span></div>
<div class="line"><a id="l01142" name="l01142"></a><span class="lineno"> 1142</span><span class="comment">!    &amp;       rcsoil</span></div>
<div class="line"><a id="l01143" name="l01143"></a><span class="lineno"> 1143</span> </div>
<div class="line"><a id="l01144" name="l01144"></a><span class="lineno"> 1144</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l01145" name="l01145"></a><span class="lineno"> 1145</span><span class="keywordtype">      real</span> (kind=kind_phys) :: delta, ff, gx, rr, part(nsold)</div>
<div class="line"><a id="l01146" name="l01146"></a><span class="lineno"> 1146</span> </div>
<div class="line"><a id="l01147" name="l01147"></a><span class="lineno"> 1147</span>      <span class="keywordtype">integer</span> :: k</div>
<div class="line"><a id="l01148" name="l01148"></a><span class="lineno"> 1148</span> </div>
<div class="line"><a id="l01149" name="l01149"></a><span class="lineno"> 1149</span><span class="comment">!</span></div>
<div class="line"><a id="l01150" name="l01150"></a><span class="lineno"> 1150</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l01151" name="l01151"></a><span class="lineno"> 1151</span><span class="comment">!</span></div>
<div class="line"><a id="l01152" name="l01152"></a><span class="lineno"> 1152</span><span class="comment">!  --- ...  initialize canopy resistance multiplier terms.</span></div>
<div class="line"><a id="l01153" name="l01153"></a><span class="lineno"> 1153</span> </div>
<div class="line"><a id="l01154" name="l01154"></a><span class="lineno"> 1154</span>      rcs = 0.0</div>
<div class="line"><a id="l01155" name="l01155"></a><span class="lineno"> 1155</span>      rct = 0.0</div>
<div class="line"><a id="l01156" name="l01156"></a><span class="lineno"> 1156</span>      rcq = 0.0</div>
<div class="line"><a id="l01157" name="l01157"></a><span class="lineno"> 1157</span>      rcsoil = 0.0</div>
<div class="line"><a id="l01158" name="l01158"></a><span class="lineno"> 1158</span>      rc = 0.0</div>
<div class="line"><a id="l01159" name="l01159"></a><span class="lineno"> 1159</span> </div>
<div class="line"><a id="l01160" name="l01160"></a><span class="lineno"> 1160</span><span class="comment">!  --- ...  contribution due to incoming solar radiation</span></div>
<div class="line"><a id="l01161" name="l01161"></a><span class="lineno"> 1161</span> </div>
<div class="line"><a id="l01162" name="l01162"></a><span class="lineno"> 1162</span>      ff = 0.55 * 2.0 * swdn / (rgl*xlai)</div>
<div class="line"><a id="l01163" name="l01163"></a><span class="lineno"> 1163</span>      rcs = (ff + rsmin/rsmax) / (1.0 + ff)</div>
<div class="line"><a id="l01164" name="l01164"></a><span class="lineno"> 1164</span>      rcs = max( rcs, 0.0001 )</div>
<div class="line"><a id="l01165" name="l01165"></a><span class="lineno"> 1165</span> </div>
<div class="line"><a id="l01166" name="l01166"></a><span class="lineno"> 1166</span><span class="comment">!  --- ...  contribution due to air temperature at first model level above ground</span></div>
<div class="line"><a id="l01167" name="l01167"></a><span class="lineno"> 1167</span><span class="comment">!           rct expression from noilhan and planton (1989, mwr).</span></div>
<div class="line"><a id="l01168" name="l01168"></a><span class="lineno"> 1168</span> </div>
<div class="line"><a id="l01169" name="l01169"></a><span class="lineno"> 1169</span>      rct = 1.0 - 0.0016 * (topt - sfctmp)**2.0</div>
<div class="line"><a id="l01170" name="l01170"></a><span class="lineno"> 1170</span>      rct = max( rct, 0.0001 )</div>
<div class="line"><a id="l01171" name="l01171"></a><span class="lineno"> 1171</span> </div>
<div class="line"><a id="l01172" name="l01172"></a><span class="lineno"> 1172</span><span class="comment">!  --- ...  contribution due to vapor pressure deficit at first model level.</span></div>
<div class="line"><a id="l01173" name="l01173"></a><span class="lineno"> 1173</span><span class="comment">!           rcq expression from ssib</span></div>
<div class="line"><a id="l01174" name="l01174"></a><span class="lineno"> 1174</span> </div>
<div class="line"><a id="l01175" name="l01175"></a><span class="lineno"> 1175</span>      rcq = 1.0 / (1.0 + hs*(q2sat-q2))</div>
<div class="line"><a id="l01176" name="l01176"></a><span class="lineno"> 1176</span>      rcq = max( rcq, 0.01 )</div>
<div class="line"><a id="l01177" name="l01177"></a><span class="lineno"> 1177</span> </div>
<div class="line"><a id="l01178" name="l01178"></a><span class="lineno"> 1178</span><span class="comment">!  --- ...  contribution due to soil moisture availability.</span></div>
<div class="line"><a id="l01179" name="l01179"></a><span class="lineno"> 1179</span><span class="comment">!           determine contribution from each soil layer, then add them up.</span></div>
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"> 1180</span> </div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span>      gx = (sh2o(1) - smcwlt) / (smcref - smcwlt)</div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span>      gx = max( 0.0, min( 1.0, gx ) )</div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span> </div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span><span class="comment">!  --- ...  use soil depth as weighting factor</span></div>
<div class="line"><a id="l01185" name="l01185"></a><span class="lineno"> 1185</span>      part(1) = (zsoil(1)/zsoil(nroot)) * gx</div>
<div class="line"><a id="l01186" name="l01186"></a><span class="lineno"> 1186</span> </div>
<div class="line"><a id="l01187" name="l01187"></a><span class="lineno"> 1187</span><span class="comment">!  --- ...  use root distribution as weighting factor</span></div>
<div class="line"><a id="l01188" name="l01188"></a><span class="lineno"> 1188</span><span class="comment">!     part(1) = rtdis(1) * gx</span></div>
<div class="line"><a id="l01189" name="l01189"></a><span class="lineno"> 1189</span> </div>
<div class="line"><a id="l01190" name="l01190"></a><span class="lineno"> 1190</span>      <span class="keywordflow">do</span> k = 2, nroot</div>
<div class="line"><a id="l01191" name="l01191"></a><span class="lineno"> 1191</span> </div>
<div class="line"><a id="l01192" name="l01192"></a><span class="lineno"> 1192</span>        gx = (sh2o(k) - smcwlt) / (smcref - smcwlt)</div>
<div class="line"><a id="l01193" name="l01193"></a><span class="lineno"> 1193</span>        gx = max( 0.0, min( 1.0, gx ) )</div>
<div class="line"><a id="l01194" name="l01194"></a><span class="lineno"> 1194</span> </div>
<div class="line"><a id="l01195" name="l01195"></a><span class="lineno"> 1195</span><span class="comment">!  --- ...  use soil depth as weighting factor</span></div>
<div class="line"><a id="l01196" name="l01196"></a><span class="lineno"> 1196</span>        part(k) = ((zsoil(k) - zsoil(k-1)) / zsoil(nroot)) * gx</div>
<div class="line"><a id="l01197" name="l01197"></a><span class="lineno"> 1197</span> </div>
<div class="line"><a id="l01198" name="l01198"></a><span class="lineno"> 1198</span><span class="comment">!  --- ...  use root distribution as weighting factor</span></div>
<div class="line"><a id="l01199" name="l01199"></a><span class="lineno"> 1199</span><span class="comment">!       part(k) = rtdis(k) * gx</span></div>
<div class="line"><a id="l01200" name="l01200"></a><span class="lineno"> 1200</span> </div>
<div class="line"><a id="l01201" name="l01201"></a><span class="lineno"> 1201</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l01202" name="l01202"></a><span class="lineno"> 1202</span> </div>
<div class="line"><a id="l01203" name="l01203"></a><span class="lineno"> 1203</span>      <span class="keywordflow">do</span> k = 1, nroot</div>
<div class="line"><a id="l01204" name="l01204"></a><span class="lineno"> 1204</span>        rcsoil = rcsoil + part(k)</div>
<div class="line"><a id="l01205" name="l01205"></a><span class="lineno"> 1205</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l01206" name="l01206"></a><span class="lineno"> 1206</span>      rcsoil = max( rcsoil, 0.0001 )</div>
<div class="line"><a id="l01207" name="l01207"></a><span class="lineno"> 1207</span> </div>
<div class="line"><a id="l01208" name="l01208"></a><span class="lineno"> 1208</span><span class="comment">!  --- ...  determine canopy resistance due to all factors.  convert canopy</span></div>
<div class="line"><a id="l01209" name="l01209"></a><span class="lineno"> 1209</span><span class="comment">!           resistance (rc) to plant coefficient (pc) to be used with</span></div>
<div class="line"><a id="l01210" name="l01210"></a><span class="lineno"> 1210</span><span class="comment">!           potential evap in determining actual evap.  pc is determined by:</span></div>
<div class="line"><a id="l01211" name="l01211"></a><span class="lineno"> 1211</span><span class="comment">!           pc * linerized penman potential evap = penman-monteith actual</span></div>
<div class="line"><a id="l01212" name="l01212"></a><span class="lineno"> 1212</span><span class="comment">!           evaporation (containing rc term).</span></div>
<div class="line"><a id="l01213" name="l01213"></a><span class="lineno"> 1213</span> </div>
<div class="line"><a id="l01214" name="l01214"></a><span class="lineno"> 1214</span>      rc = rsmin / (xlai*rcs*rct*rcq*rcsoil)</div>
<div class="line"><a id="l01215" name="l01215"></a><span class="lineno"> 1215</span>      rr = (4.0*sfcems*sigma1*rd1/cp1) * (sfctmp**4.0)/(sfcprs*ch) + 1.0</div>
<div class="line"><a id="l01216" name="l01216"></a><span class="lineno"> 1216</span>      delta = (lsubc/cp1) * dqsdt2</div>
<div class="line"><a id="l01217" name="l01217"></a><span class="lineno"> 1217</span> </div>
<div class="line"><a id="l01218" name="l01218"></a><span class="lineno"> 1218</span>      pc = (rr + delta) / (rr*(1.0 + rc*ch) + delta)</div>
<div class="line"><a id="l01219" name="l01219"></a><span class="lineno"> 1219</span><span class="comment">!</span></div>
<div class="line"><a id="l01220" name="l01220"></a><span class="lineno"> 1220</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l01221" name="l01221"></a><span class="lineno"> 1221</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gaa292bfa0bd38e58ab9389cb38e4d09c0.html#gaa292bfa0bd38e58ab9389cb38e4d09c0">canres</a></div>
<div class="line"><a id="l01222" name="l01222"></a><span class="lineno"> 1222</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l01223" name="l01223"></a><span class="lineno"> 1223</span> </div>
<div class="line"><a id="l01224" name="l01224"></a><span class="lineno"> 1224</span> </div>
<div class="line"><a id="l01225" name="l01225"></a><span class="lineno"> 1225</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l01226" name="l01226"></a><span class="lineno"> 1226</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l01227" name="l01227"></a><span class="lineno"> 1227</span><span class="comment">!&gt; This subroutine calculates snow termal conductivity</span></div>
<div class="foldopen" id="foldopen01228" data-start="" data-end="">
<div class="line"><a id="l01228" name="l01228"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga028fc448a3afe77726222a337008ffa4.html#ga028fc448a3afe77726222a337008ffa4"> 1228</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga028fc448a3afe77726222a337008ffa4.html#ga028fc448a3afe77726222a337008ffa4">csnow</a></div>
<div class="line"><a id="l01229" name="l01229"></a><span class="lineno"> 1229</span><span class="comment">!...................................</span></div>
<div class="line"><a id="l01230" name="l01230"></a><span class="lineno"> 1230</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01231" name="l01231"></a><span class="lineno"> 1231</span><span class="comment">!    &amp;     ( sndens,                                                    &amp;</span></div>
<div class="line"><a id="l01232" name="l01232"></a><span class="lineno"> 1232</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01233" name="l01233"></a><span class="lineno"> 1233</span><span class="comment">!    &amp;       sncond                                                     &amp;</span></div>
<div class="line"><a id="l01234" name="l01234"></a><span class="lineno"> 1234</span><span class="comment">!    &amp;     )</span></div>
<div class="line"><a id="l01235" name="l01235"></a><span class="lineno"> 1235</span> </div>
<div class="line"><a id="l01236" name="l01236"></a><span class="lineno"> 1236</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"> 1237</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span><span class="comment">!  subroutine csnow calculates snow termal conductivity                 !</span></div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"> 1240</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span><span class="comment">!  inputs from the calling program:                              size   !</span></div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span><span class="comment">!     sndens   - real, snow density                                1    !</span></div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span><span class="comment">!  outputs to the calling program:                                      !</span></div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span><span class="comment">!     sncond   - real, snow termal conductivity                    1    !</span></div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span><span class="comment">!</span></div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span><span class="comment">!  ---  constant parameters:</span></div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: unit = 0.11631</div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span> </div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span><span class="comment">!     real (kind=kind_phys), intent(in) :: sndens</span></div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span> </div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span><span class="comment">!     real (kind=kind_phys), intent(out) :: sncond</span></div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span> </div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span><span class="keywordtype">      real</span> (kind=kind_phys) :: c</div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span> </div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span><span class="comment">!</span></div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l01267" name="l01267"></a><span class="lineno"> 1267</span><span class="comment">!</span></div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"> 1268</span><span class="comment">!  --- ...  sncond in units of cal/(cm*hr*c), returned in w/(m*c)</span></div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span><span class="comment">!           basic version is dyachkova equation (1960), for range 0.1-0.4</span></div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span> </div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span>      c = 0.328 * 10**(2.25*sndens)</div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span>      sncond = unit * c</div>
<div class="line"><a id="l01273" name="l01273"></a><span class="lineno"> 1273</span> </div>
<div class="line"><a id="l01274" name="l01274"></a><span class="lineno"> 1274</span><span class="comment">!  --- ...  de vaux equation (1933), in range 0.1-0.6</span></div>
<div class="line"><a id="l01275" name="l01275"></a><span class="lineno"> 1275</span> </div>
<div class="line"><a id="l01276" name="l01276"></a><span class="lineno"> 1276</span><span class="comment">!      sncond = 0.0293 * (1.0 + 100.0*sndens**2)</span></div>
<div class="line"><a id="l01277" name="l01277"></a><span class="lineno"> 1277</span> </div>
<div class="line"><a id="l01278" name="l01278"></a><span class="lineno"> 1278</span><span class="comment">!  --- ...  e. andersen from flerchinger</span></div>
<div class="line"><a id="l01279" name="l01279"></a><span class="lineno"> 1279</span> </div>
<div class="line"><a id="l01280" name="l01280"></a><span class="lineno"> 1280</span><span class="comment">!      sncond = 0.021 + 2.51 * sndens**2</span></div>
<div class="line"><a id="l01281" name="l01281"></a><span class="lineno"> 1281</span><span class="comment">!</span></div>
<div class="line"><a id="l01282" name="l01282"></a><span class="lineno"> 1282</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l01283" name="l01283"></a><span class="lineno"> 1283</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga028fc448a3afe77726222a337008ffa4.html#ga028fc448a3afe77726222a337008ffa4">csnow</a></div>
<div class="line"><a id="l01284" name="l01284"></a><span class="lineno"> 1284</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l01285" name="l01285"></a><span class="lineno"> 1285</span> </div>
<div class="line"><a id="l01286" name="l01286"></a><span class="lineno"> 1286</span> </div>
<div class="line"><a id="l01287" name="l01287"></a><span class="lineno"> 1287</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l01288" name="l01288"></a><span class="lineno"> 1288</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l01289" name="l01289"></a><span class="lineno"> 1289</span><span class="comment">!&gt; This subroutine calculates soil moisture and heat flux values and</span></div>
<div class="line"><a id="l01290" name="l01290"></a><span class="lineno"> 1290</span><span class="comment">!! update soil moisture content and soil heat content values for the</span></div>
<div class="line"><a id="l01291" name="l01291"></a><span class="lineno"> 1291</span><span class="comment">!! case when no snow pack is present.</span></div>
<div class="foldopen" id="foldopen01292" data-start="" data-end="">
<div class="line"><a id="l01292" name="l01292"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga92994e4737ecfd692a6704778558c9c2.html#ga92994e4737ecfd692a6704778558c9c2"> 1292</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga92994e4737ecfd692a6704778558c9c2.html#ga92994e4737ecfd692a6704778558c9c2">nopac</a></div>
<div class="line"><a id="l01293" name="l01293"></a><span class="lineno"> 1293</span><span class="comment">!...................................</span></div>
<div class="line"><a id="l01294" name="l01294"></a><span class="lineno"> 1294</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01295" name="l01295"></a><span class="lineno"> 1295</span><span class="comment">!    &amp;     ( nsoil, nroot, etp, prcp, smcmax, smcwlt, smcref,           &amp;</span></div>
<div class="line"><a id="l01296" name="l01296"></a><span class="lineno"> 1296</span><span class="comment">!    &amp;       smcdry, cmcmax, dt, shdfac, sbeta, sfctmp, sfcems,         &amp;</span></div>
<div class="line"><a id="l01297" name="l01297"></a><span class="lineno"> 1297</span><span class="comment">!    &amp;       t24, th2, fdown, epsca, bexp, pc, rch, rr, cfactr,         &amp;</span></div>
<div class="line"><a id="l01298" name="l01298"></a><span class="lineno"> 1298</span><span class="comment">!    &amp;       slope, kdt, frzx, psisat, zsoil, dksat, dwsat,             &amp;</span></div>
<div class="line"><a id="l01299" name="l01299"></a><span class="lineno"> 1299</span><span class="comment">!    &amp;       zbot, ice, rtdis, quartz, fxexp, csoil, lheatstrg,         &amp;</span></div>
<div class="line"><a id="l01300" name="l01300"></a><span class="lineno"> 1300</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l01301" name="l01301"></a><span class="lineno"> 1301</span><span class="comment">!    &amp;       cmc, t1, stc, sh2o, tbot,                                  &amp;</span></div>
<div class="line"><a id="l01302" name="l01302"></a><span class="lineno"> 1302</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01303" name="l01303"></a><span class="lineno"> 1303</span><span class="comment">!    &amp;       eta, smc, ssoil, runoff1, runoff2, runoff3, edir,          &amp;</span></div>
<div class="line"><a id="l01304" name="l01304"></a><span class="lineno"> 1304</span><span class="comment">!    &amp;       ec, et, ett, beta, drip, dew, flx1, flx3                   &amp;</span></div>
<div class="line"><a id="l01305" name="l01305"></a><span class="lineno"> 1305</span><span class="comment">!    &amp;     )</span></div>
<div class="line"><a id="l01306" name="l01306"></a><span class="lineno"> 1306</span> </div>
<div class="line"><a id="l01307" name="l01307"></a><span class="lineno"> 1307</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l01308" name="l01308"></a><span class="lineno"> 1308</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l01309" name="l01309"></a><span class="lineno"> 1309</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01310" name="l01310"></a><span class="lineno"> 1310</span><span class="comment">!  subroutine nopac calculates soil moisture and heat flux values and   !</span></div>
<div class="line"><a id="l01311" name="l01311"></a><span class="lineno"> 1311</span><span class="comment">!  update soil moisture content and soil heat content values for the    !</span></div>
<div class="line"><a id="l01312" name="l01312"></a><span class="lineno"> 1312</span><span class="comment">!  case when no snow pack is present.                                   !</span></div>
<div class="line"><a id="l01313" name="l01313"></a><span class="lineno"> 1313</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01314" name="l01314"></a><span class="lineno"> 1314</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01315" name="l01315"></a><span class="lineno"> 1315</span><span class="comment">!  subprograms called:  evapo, smflx, tdfcnd, shflx                     !</span></div>
<div class="line"><a id="l01316" name="l01316"></a><span class="lineno"> 1316</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01317" name="l01317"></a><span class="lineno"> 1317</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l01318" name="l01318"></a><span class="lineno"> 1318</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01319" name="l01319"></a><span class="lineno"> 1319</span><span class="comment">!  inputs from calling program:                                  size   !</span></div>
<div class="line"><a id="l01320" name="l01320"></a><span class="lineno"> 1320</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l01321" name="l01321"></a><span class="lineno"> 1321</span><span class="comment">!     nroot    - integer, number of root layers                    1    !</span></div>
<div class="line"><a id="l01322" name="l01322"></a><span class="lineno"> 1322</span><span class="comment">!     etp      - real, potential evaporation                       1    !</span></div>
<div class="line"><a id="l01323" name="l01323"></a><span class="lineno"> 1323</span><span class="comment">!     prcp     - real, precip rate                                 1    !</span></div>
<div class="line"><a id="l01324" name="l01324"></a><span class="lineno"> 1324</span><span class="comment">!     smcmax   - real, porosity (sat val of soil mois)             1    !</span></div>
<div class="line"><a id="l01325" name="l01325"></a><span class="lineno"> 1325</span><span class="comment">!     smcwlt   - real, wilting point                               1    !</span></div>
<div class="line"><a id="l01326" name="l01326"></a><span class="lineno"> 1326</span><span class="comment">!     smcref   - real, soil mois threshold                         1    !</span></div>
<div class="line"><a id="l01327" name="l01327"></a><span class="lineno"> 1327</span><span class="comment">!     smcdry   - real, dry soil mois threshold                     1    !</span></div>
<div class="line"><a id="l01328" name="l01328"></a><span class="lineno"> 1328</span><span class="comment">!     cmcmax   - real, maximum canopy water parameters             1    !</span></div>
<div class="line"><a id="l01329" name="l01329"></a><span class="lineno"> 1329</span><span class="comment">!     dt       - real, time step                                   1    !</span></div>
<div class="line"><a id="l01330" name="l01330"></a><span class="lineno"> 1330</span><span class="comment">!     shdfac   - real, aeral coverage of green veg                 1    !</span></div>
<div class="line"><a id="l01331" name="l01331"></a><span class="lineno"> 1331</span><span class="comment">!     sbeta    - real, param to cal veg effect on soil heat flux   1    !</span></div>
<div class="line"><a id="l01332" name="l01332"></a><span class="lineno"> 1332</span><span class="comment">!     sfctmp   - real, air temp at height zlvl abv ground          1    !</span></div>
<div class="line"><a id="l01333" name="l01333"></a><span class="lineno"> 1333</span><span class="comment">!     sfcems   - real, sfc lw emissivity                           1    !</span></div>
<div class="line"><a id="l01334" name="l01334"></a><span class="lineno"> 1334</span><span class="comment">!     t24      - real, sfctmp**4                                   1    !</span></div>
<div class="line"><a id="l01335" name="l01335"></a><span class="lineno"> 1335</span><span class="comment">!     th2      - real, air potential temp at zlvl abv grnd         1    !</span></div>
<div class="line"><a id="l01336" name="l01336"></a><span class="lineno"> 1336</span><span class="comment">!     fdown    - real, net solar + downward lw flux at sfc         1    !</span></div>
<div class="line"><a id="l01337" name="l01337"></a><span class="lineno"> 1337</span><span class="comment">!     epsca    - real,                                             1    !</span></div>
<div class="line"><a id="l01338" name="l01338"></a><span class="lineno"> 1338</span><span class="comment">!     bexp     - real, soil type &quot;b&quot; parameter                     1    !</span></div>
<div class="line"><a id="l01339" name="l01339"></a><span class="lineno"> 1339</span><span class="comment">!     pc       - real, plant coeff                                 1    !</span></div>
<div class="line"><a id="l01340" name="l01340"></a><span class="lineno"> 1340</span><span class="comment">!     rch      - real, companion coefficient of ch                 1    !</span></div>
<div class="line"><a id="l01341" name="l01341"></a><span class="lineno"> 1341</span><span class="comment">!     rr       - real,                                             1    !</span></div>
<div class="line"><a id="l01342" name="l01342"></a><span class="lineno"> 1342</span><span class="comment">!     cfactr   - real, canopy water parameters                     1    !</span></div>
<div class="line"><a id="l01343" name="l01343"></a><span class="lineno"> 1343</span><span class="comment">!     slope    - real, linear reservoir coefficient                1    !</span></div>
<div class="line"><a id="l01344" name="l01344"></a><span class="lineno"> 1344</span><span class="comment">!     kdt      - real,                                             1    !</span></div>
<div class="line"><a id="l01345" name="l01345"></a><span class="lineno"> 1345</span><span class="comment">!     frzx     - real, frozen ground parameter                     1    !</span></div>
<div class="line"><a id="l01346" name="l01346"></a><span class="lineno"> 1346</span><span class="comment">!     psisat   - real, saturated soil potential                    1    !</span></div>
<div class="line"><a id="l01347" name="l01347"></a><span class="lineno"> 1347</span><span class="comment">!     zsoil    - real, soil layer depth below ground (negative)  nsoil  !</span></div>
<div class="line"><a id="l01348" name="l01348"></a><span class="lineno"> 1348</span><span class="comment">!     dksat    - real, saturated soil hydraulic conductivity       1    !</span></div>
<div class="line"><a id="l01349" name="l01349"></a><span class="lineno"> 1349</span><span class="comment">!     dwsat    - real, saturated soil diffusivity                  1    !</span></div>
<div class="line"><a id="l01350" name="l01350"></a><span class="lineno"> 1350</span><span class="comment">!     zbot     - real, specify depth of lower bd soil              1    !</span></div>
<div class="line"><a id="l01351" name="l01351"></a><span class="lineno"> 1351</span><span class="comment">!     ice      - integer, sea-ice flag (=1: sea-ice, =0: land)     1    !</span></div>
<div class="line"><a id="l01352" name="l01352"></a><span class="lineno"> 1352</span><span class="comment">!     rtdis    - real, root distribution                         nsoil  !</span></div>
<div class="line"><a id="l01353" name="l01353"></a><span class="lineno"> 1353</span><span class="comment">!     quartz   - real, soil quartz content                         1    !</span></div>
<div class="line"><a id="l01354" name="l01354"></a><span class="lineno"> 1354</span><span class="comment">!     fxexp    - real, bare soil evaporation exponent              1    !</span></div>
<div class="line"><a id="l01355" name="l01355"></a><span class="lineno"> 1355</span><span class="comment">!     csoil    - real, soil heat capacity                          1    !</span></div>
<div class="line"><a id="l01356" name="l01356"></a><span class="lineno"> 1356</span><span class="comment">!     lheatstrg- logical, flag for canopy heat storage             1    !</span></div>
<div class="line"><a id="l01357" name="l01357"></a><span class="lineno"> 1357</span><span class="comment">!                         parameterization                              !</span></div>
<div class="line"><a id="l01358" name="l01358"></a><span class="lineno"> 1358</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01359" name="l01359"></a><span class="lineno"> 1359</span><span class="comment">!  input/outputs from and to the calling program:                       !</span></div>
<div class="line"><a id="l01360" name="l01360"></a><span class="lineno"> 1360</span><span class="comment">!     cmc      - real, canopy moisture content                     1    !</span></div>
<div class="line"><a id="l01361" name="l01361"></a><span class="lineno"> 1361</span><span class="comment">!     t1       - real, ground/canopy/snowpack eff skin temp        1    !</span></div>
<div class="line"><a id="l01362" name="l01362"></a><span class="lineno"> 1362</span><span class="comment">!     stc      - real, soil temp                                 nsoil  !</span></div>
<div class="line"><a id="l01363" name="l01363"></a><span class="lineno"> 1363</span><span class="comment">!     sh2o     - real, unfrozen soil moisture                    nsoil  !</span></div>
<div class="line"><a id="l01364" name="l01364"></a><span class="lineno"> 1364</span><span class="comment">!     tbot     - real, bottom soil temp                            1    !</span></div>
<div class="line"><a id="l01365" name="l01365"></a><span class="lineno"> 1365</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01366" name="l01366"></a><span class="lineno"> 1366</span><span class="comment">!  outputs to the calling program:                                      !</span></div>
<div class="line"><a id="l01367" name="l01367"></a><span class="lineno"> 1367</span><span class="comment">!     eta      - real, downward latent heat flux                   1    !</span></div>
<div class="line"><a id="l01368" name="l01368"></a><span class="lineno"> 1368</span><span class="comment">!     smc      - real, total soil moisture                       nsoil  !</span></div>
<div class="line"><a id="l01369" name="l01369"></a><span class="lineno"> 1369</span><span class="comment">!     ssoil    - real, upward soil heat flux                       1    !</span></div>
<div class="line"><a id="l01370" name="l01370"></a><span class="lineno"> 1370</span><span class="comment">!     runoff1  - real, surface runoff not infiltrating sfc         1    !</span></div>
<div class="line"><a id="l01371" name="l01371"></a><span class="lineno"> 1371</span><span class="comment">!     runoff2  - real, sub surface runoff (baseflow)               1    !</span></div>
<div class="line"><a id="l01372" name="l01372"></a><span class="lineno"> 1372</span><span class="comment">!     runoff3  - real, excess of porosity                          1    !</span></div>
<div class="line"><a id="l01373" name="l01373"></a><span class="lineno"> 1373</span><span class="comment">!     edir     - real, direct soil evaporation                     1    !</span></div>
<div class="line"><a id="l01374" name="l01374"></a><span class="lineno"> 1374</span><span class="comment">!     ec       - real, canopy water evaporation                    1    !</span></div>
<div class="line"><a id="l01375" name="l01375"></a><span class="lineno"> 1375</span><span class="comment">!     et       - real, plant transpiration                       nsoil  !</span></div>
<div class="line"><a id="l01376" name="l01376"></a><span class="lineno"> 1376</span><span class="comment">!     ett      - real, total plant transpiration                   1    !</span></div>
<div class="line"><a id="l01377" name="l01377"></a><span class="lineno"> 1377</span><span class="comment">!     beta     - real, ratio of actual/potential evap              1    !</span></div>
<div class="line"><a id="l01378" name="l01378"></a><span class="lineno"> 1378</span><span class="comment">!     drip     - real, through-fall of precip and/or dew           1    !</span></div>
<div class="line"><a id="l01379" name="l01379"></a><span class="lineno"> 1379</span><span class="comment">!     dew      - real, dewfall (or frostfall)                      1    !</span></div>
<div class="line"><a id="l01380" name="l01380"></a><span class="lineno"> 1380</span><span class="comment">!     flx1     - real, precip-snow sfc flux                        1    !</span></div>
<div class="line"><a id="l01381" name="l01381"></a><span class="lineno"> 1381</span><span class="comment">!     flx3     - real, phase-change heat flux from snowmelt        1    !</span></div>
<div class="line"><a id="l01382" name="l01382"></a><span class="lineno"> 1382</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01383" name="l01383"></a><span class="lineno"> 1383</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l01384" name="l01384"></a><span class="lineno"> 1384</span><span class="comment">!</span></div>
<div class="line"><a id="l01385" name="l01385"></a><span class="lineno"> 1385</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01386" name="l01386"></a><span class="lineno"> 1386</span><span class="comment">!     integer, intent(in) :: nsoil, nroot, ice</span></div>
<div class="line"><a id="l01387" name="l01387"></a><span class="lineno"> 1387</span> </div>
<div class="line"><a id="l01388" name="l01388"></a><span class="lineno"> 1388</span><span class="comment">!     real (kind=kind_phys), intent(in) :: etp, prcp, smcmax,           &amp;</span></div>
<div class="line"><a id="l01389" name="l01389"></a><span class="lineno"> 1389</span><span class="comment">!    &amp;       smcwlt, smcref, smcdry, cmcmax, dt, shdfac, sbeta,         &amp;</span></div>
<div class="line"><a id="l01390" name="l01390"></a><span class="lineno"> 1390</span><span class="comment">!    &amp;       sfctmp, sfcems, t24, th2, fdown, epsca, bexp, pc,          &amp;</span></div>
<div class="line"><a id="l01391" name="l01391"></a><span class="lineno"> 1391</span><span class="comment">!    &amp;       rch, rr, cfactr, slope, kdt, frzx, psisat,                 &amp;</span></div>
<div class="line"><a id="l01392" name="l01392"></a><span class="lineno"> 1392</span><span class="comment">!    &amp;       zsoil(nsoil), dksat, dwsat, zbot, rtdis(nsoil),            &amp;</span></div>
<div class="line"><a id="l01393" name="l01393"></a><span class="lineno"> 1393</span><span class="comment">!    &amp;       quartz, fxexp, csoil</span></div>
<div class="line"><a id="l01394" name="l01394"></a><span class="lineno"> 1394</span> </div>
<div class="line"><a id="l01395" name="l01395"></a><span class="lineno"> 1395</span><span class="comment">!     logical, intent(in) :: lheatstrg</span></div>
<div class="line"><a id="l01396" name="l01396"></a><span class="lineno"> 1396</span> </div>
<div class="line"><a id="l01397" name="l01397"></a><span class="lineno"> 1397</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l01398" name="l01398"></a><span class="lineno"> 1398</span><span class="comment">!     real (kind=kind_phys), intent(inout) :: cmc, t1, stc(nsoil),      &amp;</span></div>
<div class="line"><a id="l01399" name="l01399"></a><span class="lineno"> 1399</span><span class="comment">!    &amp;       sh2o(nsoil), tbot</span></div>
<div class="line"><a id="l01400" name="l01400"></a><span class="lineno"> 1400</span> </div>
<div class="line"><a id="l01401" name="l01401"></a><span class="lineno"> 1401</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01402" name="l01402"></a><span class="lineno"> 1402</span><span class="comment">!     real (kind=kind_phys), intent(out) :: eta, smc(nsoil), ssoil,     &amp;</span></div>
<div class="line"><a id="l01403" name="l01403"></a><span class="lineno"> 1403</span><span class="comment">!    &amp;       runoff1, runoff2, runoff3, edir, ec, et(nsoil), ett,       &amp;</span></div>
<div class="line"><a id="l01404" name="l01404"></a><span class="lineno"> 1404</span><span class="comment">!    &amp;       beta, drip, dew, flx1, flx3</span></div>
<div class="line"><a id="l01405" name="l01405"></a><span class="lineno"> 1405</span> </div>
<div class="line"><a id="l01406" name="l01406"></a><span class="lineno"> 1406</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l01407" name="l01407"></a><span class="lineno"> 1407</span><span class="keywordtype">      real</span> (kind=kind_phys) :: df1, eta1, etp1, prcp1, yy, yynum,       &amp;</div>
<div class="line"><a id="l01408" name="l01408"></a><span class="lineno"> 1408</span>     &amp;       zz1, ec1, edir1, et1(nsoil), ett1</div>
<div class="line"><a id="l01409" name="l01409"></a><span class="lineno"> 1409</span> </div>
<div class="line"><a id="l01410" name="l01410"></a><span class="lineno"> 1410</span>      <span class="keywordtype">integer</span> :: k</div>
<div class="line"><a id="l01411" name="l01411"></a><span class="lineno"> 1411</span> </div>
<div class="line"><a id="l01412" name="l01412"></a><span class="lineno"> 1412</span><span class="comment">!</span></div>
<div class="line"><a id="l01413" name="l01413"></a><span class="lineno"> 1413</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l01414" name="l01414"></a><span class="lineno"> 1414</span><span class="comment">!</span></div>
<div class="line"><a id="l01415" name="l01415"></a><span class="lineno"> 1415</span><span class="comment">!  --- ...  convert etp from kg m-2 s-1 to ms-1 and initialize dew.</span></div>
<div class="line"><a id="l01416" name="l01416"></a><span class="lineno"> 1416</span> </div>
<div class="line"><a id="l01417" name="l01417"></a><span class="lineno"> 1417</span>      prcp1= prcp * 0.001</div>
<div class="line"><a id="l01418" name="l01418"></a><span class="lineno"> 1418</span>      etp1 = etp  * 0.001</div>
<div class="line"><a id="l01419" name="l01419"></a><span class="lineno"> 1419</span>      dew  = 0.0</div>
<div class="line"><a id="l01420" name="l01420"></a><span class="lineno"> 1420</span>      edir = 0.0</div>
<div class="line"><a id="l01421" name="l01421"></a><span class="lineno"> 1421</span>      edir1= 0.0</div>
<div class="line"><a id="l01422" name="l01422"></a><span class="lineno"> 1422</span>      ec   = 0.0</div>
<div class="line"><a id="l01423" name="l01423"></a><span class="lineno"> 1423</span>      ec1  = 0.0</div>
<div class="line"><a id="l01424" name="l01424"></a><span class="lineno"> 1424</span> </div>
<div class="line"><a id="l01425" name="l01425"></a><span class="lineno"> 1425</span>      <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l01426" name="l01426"></a><span class="lineno"> 1426</span>        et(k) = 0.0</div>
<div class="line"><a id="l01427" name="l01427"></a><span class="lineno"> 1427</span>        et1(k) = 0.0</div>
<div class="line"><a id="l01428" name="l01428"></a><span class="lineno"> 1428</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l01429" name="l01429"></a><span class="lineno"> 1429</span> </div>
<div class="line"><a id="l01430" name="l01430"></a><span class="lineno"> 1430</span>      ett  = 0.0</div>
<div class="line"><a id="l01431" name="l01431"></a><span class="lineno"> 1431</span>      ett1 = 0.0</div>
<div class="line"><a id="l01432" name="l01432"></a><span class="lineno"> 1432</span> </div>
<div class="line"><a id="l01433" name="l01433"></a><span class="lineno"> 1433</span>      <span class="keywordflow">if</span> (etp &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01434" name="l01434"></a><span class="lineno"> 1434</span> </div>
<div class="line"><a id="l01435" name="l01435"></a><span class="lineno"> 1435</span><span class="comment">!  --- ...  convert prcp from &#39;kg m-2 s-1&#39; to &#39;m s-1&#39;.</span></div>
<div class="line"><a id="l01436" name="l01436"></a><span class="lineno"> 1436</span> </div>
<div class="line"><a id="l01437" name="l01437"></a><span class="lineno"> 1437</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga4af741ecc120ddb0d7282f78df4136a5.html#ga4af741ecc120ddb0d7282f78df4136a5">evapo</a>                                                      &amp;</div>
<div class="line"><a id="l01438" name="l01438"></a><span class="lineno"> 1438</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01439" name="l01439"></a><span class="lineno"> 1439</span>     &amp;     ( nsoil, nroot, cmc, cmcmax, etp1, dt, zsoil,                &amp;</div>
<div class="line"><a id="l01440" name="l01440"></a><span class="lineno"> 1440</span>     &amp;       sh2o, smcmax, smcwlt, smcref, smcdry, pc,                  &amp;</div>
<div class="line"><a id="l01441" name="l01441"></a><span class="lineno"> 1441</span>     &amp;       shdfac, cfactr, rtdis, fxexp,                              &amp;</div>
<div class="line"><a id="l01442" name="l01442"></a><span class="lineno"> 1442</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01443" name="l01443"></a><span class="lineno"> 1443</span>     &amp;       eta1, edir1, ec1, et1, ett1                                &amp;</div>
<div class="line"><a id="l01444" name="l01444"></a><span class="lineno"> 1444</span>     &amp;     )</div>
<div class="line"><a id="l01445" name="l01445"></a><span class="lineno"> 1445</span> </div>
<div class="line"><a id="l01446" name="l01446"></a><span class="lineno"> 1446</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gafa3e5637e56746e2539ef2567836defa.html#gafa3e5637e56746e2539ef2567836defa">smflx</a>                                                      &amp;</div>
<div class="line"><a id="l01447" name="l01447"></a><span class="lineno"> 1447</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01448" name="l01448"></a><span class="lineno"> 1448</span>     &amp;     ( nsoil, dt, kdt, smcmax, smcwlt, cmcmax, prcp1,             &amp;</div>
<div class="line"><a id="l01449" name="l01449"></a><span class="lineno"> 1449</span>     &amp;       zsoil, slope, frzx, bexp, dksat, dwsat, shdfac,            &amp;</div>
<div class="line"><a id="l01450" name="l01450"></a><span class="lineno"> 1450</span>     &amp;       edir1, ec1, et1,                                           &amp;</div>
<div class="line"><a id="l01451" name="l01451"></a><span class="lineno"> 1451</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l01452" name="l01452"></a><span class="lineno"> 1452</span>     &amp;       cmc, sh2o, smc,                                            &amp;</div>
<div class="line"><a id="l01453" name="l01453"></a><span class="lineno"> 1453</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01454" name="l01454"></a><span class="lineno"> 1454</span>     &amp;       runoff1, runoff2, runoff3, drip                            &amp;</div>
<div class="line"><a id="l01455" name="l01455"></a><span class="lineno"> 1455</span>     &amp;     )</div>
<div class="line"><a id="l01456" name="l01456"></a><span class="lineno"> 1456</span> </div>
<div class="line"><a id="l01457" name="l01457"></a><span class="lineno"> 1457</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l01458" name="l01458"></a><span class="lineno"> 1458</span> </div>
<div class="line"><a id="l01459" name="l01459"></a><span class="lineno"> 1459</span><span class="comment">!  --- ...  if etp &lt; 0, assume dew forms (transform etp1 into dew and</span></div>
<div class="line"><a id="l01460" name="l01460"></a><span class="lineno"> 1460</span><span class="comment">!           reinitialize etp1 to zero).</span></div>
<div class="line"><a id="l01461" name="l01461"></a><span class="lineno"> 1461</span> </div>
<div class="line"><a id="l01462" name="l01462"></a><span class="lineno"> 1462</span>        eta1 = 0.0</div>
<div class="line"><a id="l01463" name="l01463"></a><span class="lineno"> 1463</span>        dew  = -etp1</div>
<div class="line"><a id="l01464" name="l01464"></a><span class="lineno"> 1464</span> </div>
<div class="line"><a id="l01465" name="l01465"></a><span class="lineno"> 1465</span><span class="comment">!  --- ...  convert prcp from &#39;kg m-2 s-1&#39; to &#39;m s-1&#39; and add dew amount.</span></div>
<div class="line"><a id="l01466" name="l01466"></a><span class="lineno"> 1466</span> </div>
<div class="line"><a id="l01467" name="l01467"></a><span class="lineno"> 1467</span>        prcp1 = prcp1 + dew</div>
<div class="line"><a id="l01468" name="l01468"></a><span class="lineno"> 1468</span> </div>
<div class="line"><a id="l01469" name="l01469"></a><span class="lineno"> 1469</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gafa3e5637e56746e2539ef2567836defa.html#gafa3e5637e56746e2539ef2567836defa">smflx</a>                                                      &amp;</div>
<div class="line"><a id="l01470" name="l01470"></a><span class="lineno"> 1470</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01471" name="l01471"></a><span class="lineno"> 1471</span>     &amp;     ( nsoil, dt, kdt, smcmax, smcwlt, cmcmax, prcp1,             &amp;</div>
<div class="line"><a id="l01472" name="l01472"></a><span class="lineno"> 1472</span>     &amp;       zsoil, slope, frzx, bexp, dksat, dwsat, shdfac,            &amp;</div>
<div class="line"><a id="l01473" name="l01473"></a><span class="lineno"> 1473</span>     &amp;       edir1, ec1, et1,                                           &amp;</div>
<div class="line"><a id="l01474" name="l01474"></a><span class="lineno"> 1474</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l01475" name="l01475"></a><span class="lineno"> 1475</span>     &amp;       cmc, sh2o, smc,                                            &amp;</div>
<div class="line"><a id="l01476" name="l01476"></a><span class="lineno"> 1476</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01477" name="l01477"></a><span class="lineno"> 1477</span>     &amp;       runoff1, runoff2, runoff3, drip                            &amp;</div>
<div class="line"><a id="l01478" name="l01478"></a><span class="lineno"> 1478</span>     &amp;     )</div>
<div class="line"><a id="l01479" name="l01479"></a><span class="lineno"> 1479</span> </div>
<div class="line"><a id="l01480" name="l01480"></a><span class="lineno"> 1480</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_etp_block</span></div>
<div class="line"><a id="l01481" name="l01481"></a><span class="lineno"> 1481</span> </div>
<div class="line"><a id="l01482" name="l01482"></a><span class="lineno"> 1482</span><span class="comment">!  --- ...  convert modeled evapotranspiration fm  m s-1  to  kg m-2 s-1</span></div>
<div class="line"><a id="l01483" name="l01483"></a><span class="lineno"> 1483</span> </div>
<div class="line"><a id="l01484" name="l01484"></a><span class="lineno"> 1484</span>      eta  = eta1 * 1000.0</div>
<div class="line"><a id="l01485" name="l01485"></a><span class="lineno"> 1485</span>      edir = edir1 * 1000.0</div>
<div class="line"><a id="l01486" name="l01486"></a><span class="lineno"> 1486</span>      ec   = ec1 * 1000.0</div>
<div class="line"><a id="l01487" name="l01487"></a><span class="lineno"> 1487</span> </div>
<div class="line"><a id="l01488" name="l01488"></a><span class="lineno"> 1488</span>      <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l01489" name="l01489"></a><span class="lineno"> 1489</span>        et(k) = et1(k) * 1000.0</div>
<div class="line"><a id="l01490" name="l01490"></a><span class="lineno"> 1490</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l01491" name="l01491"></a><span class="lineno"> 1491</span> </div>
<div class="line"><a id="l01492" name="l01492"></a><span class="lineno"> 1492</span>      ett = ett1 * 1000.0</div>
<div class="line"><a id="l01493" name="l01493"></a><span class="lineno"> 1493</span> </div>
<div class="line"><a id="l01494" name="l01494"></a><span class="lineno"> 1494</span><span class="comment">!  --- ...  based on etp and e values, determine beta</span></div>
<div class="line"><a id="l01495" name="l01495"></a><span class="lineno"> 1495</span> </div>
<div class="line"><a id="l01496" name="l01496"></a><span class="lineno"> 1496</span>      <span class="keywordflow">if</span> ( etp &lt;= 0.0 ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01497" name="l01497"></a><span class="lineno"> 1497</span>        beta = 0.0</div>
<div class="line"><a id="l01498" name="l01498"></a><span class="lineno"> 1498</span>        <span class="keywordflow">if</span> ( etp &lt; 0.0 ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01499" name="l01499"></a><span class="lineno"> 1499</span>          beta = 1.0</div>
<div class="line"><a id="l01500" name="l01500"></a><span class="lineno"> 1500</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l01501" name="l01501"></a><span class="lineno"> 1501</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l01502" name="l01502"></a><span class="lineno"> 1502</span>        beta = eta / etp</div>
<div class="line"><a id="l01503" name="l01503"></a><span class="lineno"> 1503</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l01504" name="l01504"></a><span class="lineno"> 1504</span> </div>
<div class="line"><a id="l01505" name="l01505"></a><span class="lineno"> 1505</span><span class="comment">!  --- ...  get soil thermal diffuxivity/conductivity for top soil lyr,</span></div>
<div class="line"><a id="l01506" name="l01506"></a><span class="lineno"> 1506</span><span class="comment">!           calc. adjusted top lyr soil temp and adjusted soil flux, then</span></div>
<div class="line"><a id="l01507" name="l01507"></a><span class="lineno"> 1507</span><span class="comment">!           call shflx to compute/update soil heat flux and soil temps.</span></div>
<div class="line"><a id="l01508" name="l01508"></a><span class="lineno"> 1508</span> </div>
<div class="line"><a id="l01509" name="l01509"></a><span class="lineno"> 1509</span>      <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga8bc3154096e6364c5fcddf884c003bef.html#ga8bc3154096e6364c5fcddf884c003bef">tdfcnd</a>                                                       &amp;</div>
<div class="line"><a id="l01510" name="l01510"></a><span class="lineno"> 1510</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01511" name="l01511"></a><span class="lineno"> 1511</span>     &amp;     ( smc(1), quartz, smcmax, sh2o(1),                           &amp;</div>
<div class="line"><a id="l01512" name="l01512"></a><span class="lineno"> 1512</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01513" name="l01513"></a><span class="lineno"> 1513</span>     &amp;       df1                                                        &amp;</div>
<div class="line"><a id="l01514" name="l01514"></a><span class="lineno"> 1514</span>     &amp;     )</div>
<div class="line"><a id="l01515" name="l01515"></a><span class="lineno"> 1515</span><span class="comment">!      if(ivegsrc == 1) then</span></div>
<div class="line"><a id="l01516" name="l01516"></a><span class="lineno"> 1516</span><span class="comment">!urban</span></div>
<div class="line"><a id="l01517" name="l01517"></a><span class="lineno"> 1517</span><span class="comment">!        if ( vegtyp == 13 ) df1=3.24</span></div>
<div class="line"><a id="l01518" name="l01518"></a><span class="lineno"> 1518</span><span class="comment">!      endif</span></div>
<div class="line"><a id="l01519" name="l01519"></a><span class="lineno"> 1519</span> </div>
<div class="line"><a id="l01520" name="l01520"></a><span class="lineno"> 1520</span><span class="comment">!  --- ... vegetation greenness fraction reduction in subsurface heat</span></div>
<div class="line"><a id="l01521" name="l01521"></a><span class="lineno"> 1521</span><span class="comment">!          flux via reduction factor, which is convenient to apply here</span></div>
<div class="line"><a id="l01522" name="l01522"></a><span class="lineno"> 1522</span><span class="comment">!          to thermal diffusivity that is later used in hrt to compute</span></div>
<div class="line"><a id="l01523" name="l01523"></a><span class="lineno"> 1523</span><span class="comment">!          sub sfc heat flux (see additional comments on veg effect</span></div>
<div class="line"><a id="l01524" name="l01524"></a><span class="lineno"> 1524</span><span class="comment">!          sub-sfc heat flx in routine sflx)</span></div>
<div class="line"><a id="l01525" name="l01525"></a><span class="lineno"> 1525</span><span class="comment">!wz only urban for igbp type</span></div>
<div class="line"><a id="l01526" name="l01526"></a><span class="lineno"> 1526</span><span class="comment">!</span></div>
<div class="line"><a id="l01527" name="l01527"></a><span class="lineno"> 1527</span><span class="comment">!jhan urban canopy heat storage effect is included in pbl scheme</span></div>
<div class="line"><a id="l01528" name="l01528"></a><span class="lineno"> 1528</span><span class="comment">!</span></div>
<div class="line"><a id="l01529" name="l01529"></a><span class="lineno"> 1529</span>        <span class="keywordflow">if</span>((.not.lheatstrg) .and.                                       &amp;</div>
<div class="line"><a id="l01530" name="l01530"></a><span class="lineno"> 1530</span>     &amp;      (ivegsrc == 1 .and. vegtyp == 13)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01531" name="l01531"></a><span class="lineno"> 1531</span>          df1 = 3.24*(1.-shdfac) + shdfac*df1*exp(sbeta*shdfac)</div>
<div class="line"><a id="l01532" name="l01532"></a><span class="lineno"> 1532</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l01533" name="l01533"></a><span class="lineno"> 1533</span>          df1 = df1 * exp( sbeta*shdfac )</div>
<div class="line"><a id="l01534" name="l01534"></a><span class="lineno"> 1534</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l01535" name="l01535"></a><span class="lineno"> 1535</span> </div>
<div class="line"><a id="l01536" name="l01536"></a><span class="lineno"> 1536</span><span class="comment">!  --- ...  compute intermediate terms passed to routine hrt (via routine</span></div>
<div class="line"><a id="l01537" name="l01537"></a><span class="lineno"> 1537</span><span class="comment">!           shflx below) for use in computing subsurface heat flux in hrt</span></div>
<div class="line"><a id="l01538" name="l01538"></a><span class="lineno"> 1538</span> </div>
<div class="line"><a id="l01539" name="l01539"></a><span class="lineno"> 1539</span>      yynum = fdown - sfcems*sigma1*t24</div>
<div class="line"><a id="l01540" name="l01540"></a><span class="lineno"> 1540</span>      yy = sfctmp + (yynum/rch + th2 - sfctmp - beta*epsca)/rr</div>
<div class="line"><a id="l01541" name="l01541"></a><span class="lineno"> 1541</span>      zz1 = df1/(-0.5*zsoil(1)*rch*rr) + 1.0</div>
<div class="line"><a id="l01542" name="l01542"></a><span class="lineno"> 1542</span> </div>
<div class="line"><a id="l01543" name="l01543"></a><span class="lineno"> 1543</span>      <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga977daabf4ff68b28fc5ccd8796d815cd.html#ga977daabf4ff68b28fc5ccd8796d815cd">shflx</a>                                                        &amp;</div>
<div class="line"><a id="l01544" name="l01544"></a><span class="lineno"> 1544</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01545" name="l01545"></a><span class="lineno"> 1545</span>     &amp;     ( nsoil, smc, smcmax, dt, yy, zz1, zsoil, zbot,              &amp;</div>
<div class="line"><a id="l01546" name="l01546"></a><span class="lineno"> 1546</span>     &amp;       psisat, bexp, df1, ice, quartz, csoil, vegtyp,             &amp;</div>
<div class="line"><a id="l01547" name="l01547"></a><span class="lineno"> 1547</span>     &amp;       shdfac, lheatstrg,                                         &amp;</div>
<div class="line"><a id="l01548" name="l01548"></a><span class="lineno"> 1548</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l01549" name="l01549"></a><span class="lineno"> 1549</span>     &amp;       stc, t1, tbot, sh2o,                                       &amp;</div>
<div class="line"><a id="l01550" name="l01550"></a><span class="lineno"> 1550</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01551" name="l01551"></a><span class="lineno"> 1551</span>     &amp;       ssoil                                                      &amp;</div>
<div class="line"><a id="l01552" name="l01552"></a><span class="lineno"> 1552</span>     &amp;     )</div>
<div class="line"><a id="l01553" name="l01553"></a><span class="lineno"> 1553</span> </div>
<div class="line"><a id="l01554" name="l01554"></a><span class="lineno"> 1554</span><span class="comment">!  --- ...  set flx1 and flx3 (snopack phase change heat fluxes) to zero since</span></div>
<div class="line"><a id="l01555" name="l01555"></a><span class="lineno"> 1555</span><span class="comment">!           they are not used here in snopac.  flx2 (freezing rain heat flux)</span></div>
<div class="line"><a id="l01556" name="l01556"></a><span class="lineno"> 1556</span><span class="comment">!           was similarly initialized in the penman routine.</span></div>
<div class="line"><a id="l01557" name="l01557"></a><span class="lineno"> 1557</span> </div>
<div class="line"><a id="l01558" name="l01558"></a><span class="lineno"> 1558</span>      flx1 = 0.0</div>
<div class="line"><a id="l01559" name="l01559"></a><span class="lineno"> 1559</span>      flx3 = 0.0</div>
<div class="line"><a id="l01560" name="l01560"></a><span class="lineno"> 1560</span><span class="comment">!</span></div>
<div class="line"><a id="l01561" name="l01561"></a><span class="lineno"> 1561</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l01562" name="l01562"></a><span class="lineno"> 1562</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga92994e4737ecfd692a6704778558c9c2.html#ga92994e4737ecfd692a6704778558c9c2">nopac</a></div>
<div class="line"><a id="l01563" name="l01563"></a><span class="lineno"> 1563</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l01564" name="l01564"></a><span class="lineno"> 1564</span> </div>
<div class="line"><a id="l01565" name="l01565"></a><span class="lineno"> 1565</span> </div>
<div class="line"><a id="l01566" name="l01566"></a><span class="lineno"> 1566</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l01567" name="l01567"></a><span class="lineno"> 1567</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l01568" name="l01568"></a><span class="lineno"> 1568</span><span class="comment">!&gt; This subroutine calculates potential evaporation for the current point.</span></div>
<div class="line"><a id="l01569" name="l01569"></a><span class="lineno"> 1569</span><span class="comment">!! various partial sums/products are also calculated and passed back</span></div>
<div class="line"><a id="l01570" name="l01570"></a><span class="lineno"> 1570</span><span class="comment">!! to the calling routine for later use</span></div>
<div class="foldopen" id="foldopen01571" data-start="" data-end="">
<div class="line"><a id="l01571" name="l01571"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga25b90f8a8049eb17cc6cb6a3fecf3fdc.html#ga25b90f8a8049eb17cc6cb6a3fecf3fdc"> 1571</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga25b90f8a8049eb17cc6cb6a3fecf3fdc.html#ga25b90f8a8049eb17cc6cb6a3fecf3fdc">penman</a></div>
<div class="line"><a id="l01572" name="l01572"></a><span class="lineno"> 1572</span><span class="comment">!...................................</span></div>
<div class="line"><a id="l01573" name="l01573"></a><span class="lineno"> 1573</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01574" name="l01574"></a><span class="lineno"> 1574</span><span class="comment">!    &amp;     ( sfctmp, sfcprs, sfcems, ch, t2v, th2, prcp, fdown,         &amp;</span></div>
<div class="line"><a id="l01575" name="l01575"></a><span class="lineno"> 1575</span><span class="comment">!    &amp;       ssoil, q2, q2sat, dqsdt2, snowng, frzgra,                  &amp;</span></div>
<div class="line"><a id="l01576" name="l01576"></a><span class="lineno"> 1576</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01577" name="l01577"></a><span class="lineno"> 1577</span><span class="comment">!    &amp;       t24, etp, rch, epsca, rr, flx2                             &amp;</span></div>
<div class="line"><a id="l01578" name="l01578"></a><span class="lineno"> 1578</span><span class="comment">!    &amp;     )</span></div>
<div class="line"><a id="l01579" name="l01579"></a><span class="lineno"> 1579</span> </div>
<div class="line"><a id="l01580" name="l01580"></a><span class="lineno"> 1580</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l01581" name="l01581"></a><span class="lineno"> 1581</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l01582" name="l01582"></a><span class="lineno"> 1582</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01583" name="l01583"></a><span class="lineno"> 1583</span><span class="comment">!  subroutine penman calculates potential evaporation for the current   !</span></div>
<div class="line"><a id="l01584" name="l01584"></a><span class="lineno"> 1584</span><span class="comment">!  point.  various partial sums/products are also calculated and passed !</span></div>
<div class="line"><a id="l01585" name="l01585"></a><span class="lineno"> 1585</span><span class="comment">!  back to the calling routine for later use.                           !</span></div>
<div class="line"><a id="l01586" name="l01586"></a><span class="lineno"> 1586</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01587" name="l01587"></a><span class="lineno"> 1587</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01588" name="l01588"></a><span class="lineno"> 1588</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l01589" name="l01589"></a><span class="lineno"> 1589</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01590" name="l01590"></a><span class="lineno"> 1590</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l01591" name="l01591"></a><span class="lineno"> 1591</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01592" name="l01592"></a><span class="lineno"> 1592</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l01593" name="l01593"></a><span class="lineno"> 1593</span><span class="comment">!     sfctmp   - real, sfc temperature at 1st level above ground   1    !</span></div>
<div class="line"><a id="l01594" name="l01594"></a><span class="lineno"> 1594</span><span class="comment">!     sfcprs   - real, sfc pressure                                1    !</span></div>
<div class="line"><a id="l01595" name="l01595"></a><span class="lineno"> 1595</span><span class="comment">!     sfcems   - real, sfc emissivity for lw radiation             1    !</span></div>
<div class="line"><a id="l01596" name="l01596"></a><span class="lineno"> 1596</span><span class="comment">!     ch       - real, sfc exchange coeff for heat &amp; moisture      1    !</span></div>
<div class="line"><a id="l01597" name="l01597"></a><span class="lineno"> 1597</span><span class="comment">!     t2v      - real, sfc virtual temperature                     1    !</span></div>
<div class="line"><a id="l01598" name="l01598"></a><span class="lineno"> 1598</span><span class="comment">!     th2      - real, air potential temp at zlvl abv grnd         1    !</span></div>
<div class="line"><a id="l01599" name="l01599"></a><span class="lineno"> 1599</span><span class="comment">!     prcp     - real, precip rate                                 1    !</span></div>
<div class="line"><a id="l01600" name="l01600"></a><span class="lineno"> 1600</span><span class="comment">!     fdown    - real, net solar + downward lw flux at sfc         1    !</span></div>
<div class="line"><a id="l01601" name="l01601"></a><span class="lineno"> 1601</span><span class="comment">!     ssoil    - real, upward soil heat flux                       1    !</span></div>
<div class="line"><a id="l01602" name="l01602"></a><span class="lineno"> 1602</span><span class="comment">!     q2       - real, mixing ratio at hght zlvl abv ground        1    !</span></div>
<div class="line"><a id="l01603" name="l01603"></a><span class="lineno"> 1603</span><span class="comment">!     q2sat    - real, sat mixing ratio at zlvl abv ground         1    !</span></div>
<div class="line"><a id="l01604" name="l01604"></a><span class="lineno"> 1604</span><span class="comment">!     dqsdt2   - real, slope of sat specific humidity curve        1    !</span></div>
<div class="line"><a id="l01605" name="l01605"></a><span class="lineno"> 1605</span><span class="comment">!     snowng   - logical, snow flag                                1    !</span></div>
<div class="line"><a id="l01606" name="l01606"></a><span class="lineno"> 1606</span><span class="comment">!     frzgra   - logical, freezing rain flag                       1    !</span></div>
<div class="line"><a id="l01607" name="l01607"></a><span class="lineno"> 1607</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01608" name="l01608"></a><span class="lineno"> 1608</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l01609" name="l01609"></a><span class="lineno"> 1609</span><span class="comment">!     t24      - real, sfctmp**4                                   1    !</span></div>
<div class="line"><a id="l01610" name="l01610"></a><span class="lineno"> 1610</span><span class="comment">!     etp      - real, potential evaporation                       1    !</span></div>
<div class="line"><a id="l01611" name="l01611"></a><span class="lineno"> 1611</span><span class="comment">!     rch      - real, companion coefficient of ch                 1    !</span></div>
<div class="line"><a id="l01612" name="l01612"></a><span class="lineno"> 1612</span><span class="comment">!     epsca    - real,                                             1    !</span></div>
<div class="line"><a id="l01613" name="l01613"></a><span class="lineno"> 1613</span><span class="comment">!     rr       - real,                                             1    !</span></div>
<div class="line"><a id="l01614" name="l01614"></a><span class="lineno"> 1614</span><span class="comment">!     flx2     - real, freezing rain latent heat flux              1    !</span></div>
<div class="line"><a id="l01615" name="l01615"></a><span class="lineno"> 1615</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01616" name="l01616"></a><span class="lineno"> 1616</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l01617" name="l01617"></a><span class="lineno"> 1617</span><span class="comment">!</span></div>
<div class="line"><a id="l01618" name="l01618"></a><span class="lineno"> 1618</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01619" name="l01619"></a><span class="lineno"> 1619</span><span class="comment">!     real (kind=kind_phys), intent(in) :: sfctmp, sfcprs, sfcems,      &amp;</span></div>
<div class="line"><a id="l01620" name="l01620"></a><span class="lineno"> 1620</span><span class="comment">!    &amp;       ch, t2v, th2, prcp, fdown, ssoil, q2, q2sat, dqsdt2</span></div>
<div class="line"><a id="l01621" name="l01621"></a><span class="lineno"> 1621</span> </div>
<div class="line"><a id="l01622" name="l01622"></a><span class="lineno"> 1622</span><span class="comment">!     logical, intent(in) :: snowng, frzgra</span></div>
<div class="line"><a id="l01623" name="l01623"></a><span class="lineno"> 1623</span> </div>
<div class="line"><a id="l01624" name="l01624"></a><span class="lineno"> 1624</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01625" name="l01625"></a><span class="lineno"> 1625</span><span class="comment">!     real (kind=kind_phys), intent(out) :: t24, etp, rch, epsca,       &amp;</span></div>
<div class="line"><a id="l01626" name="l01626"></a><span class="lineno"> 1626</span><span class="comment">!    &amp;       rr, flx2</span></div>
<div class="line"><a id="l01627" name="l01627"></a><span class="lineno"> 1627</span> </div>
<div class="line"><a id="l01628" name="l01628"></a><span class="lineno"> 1628</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l01629" name="l01629"></a><span class="lineno"> 1629</span><span class="keywordtype">      real</span> (kind=kind_phys) :: a, delta, fnet, rad, rho</div>
<div class="line"><a id="l01630" name="l01630"></a><span class="lineno"> 1630</span> </div>
<div class="line"><a id="l01631" name="l01631"></a><span class="lineno"> 1631</span><span class="comment">!</span></div>
<div class="line"><a id="l01632" name="l01632"></a><span class="lineno"> 1632</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l01633" name="l01633"></a><span class="lineno"> 1633</span><span class="comment">!</span></div>
<div class="line"><a id="l01634" name="l01634"></a><span class="lineno"> 1634</span>      flx2 = 0.0</div>
<div class="line"><a id="l01635" name="l01635"></a><span class="lineno"> 1635</span> </div>
<div class="line"><a id="l01636" name="l01636"></a><span class="lineno"> 1636</span><span class="comment">!  --- ...  prepare partial quantities for penman equation.</span></div>
<div class="line"><a id="l01637" name="l01637"></a><span class="lineno"> 1637</span> </div>
<div class="line"><a id="l01638" name="l01638"></a><span class="lineno"> 1638</span>      delta = elcp * dqsdt2</div>
<div class="line"><a id="l01639" name="l01639"></a><span class="lineno"> 1639</span>      t24 = sfctmp * sfctmp * sfctmp * sfctmp</div>
<div class="line"><a id="l01640" name="l01640"></a><span class="lineno"> 1640</span>      rr  = t24 * 6.48e-8 / (sfcprs*ch) + 1.0</div>
<div class="line"><a id="l01641" name="l01641"></a><span class="lineno"> 1641</span>      rho = sfcprs / (rd1*t2v)</div>
<div class="line"><a id="l01642" name="l01642"></a><span class="lineno"> 1642</span>      rch = rho * cp * ch</div>
<div class="line"><a id="l01643" name="l01643"></a><span class="lineno"> 1643</span> </div>
<div class="line"><a id="l01644" name="l01644"></a><span class="lineno"> 1644</span><span class="comment">!  --- ...  adjust the partial sums / products with the latent heat</span></div>
<div class="line"><a id="l01645" name="l01645"></a><span class="lineno"> 1645</span><span class="comment">!           effects caused by falling precipitation.</span></div>
<div class="line"><a id="l01646" name="l01646"></a><span class="lineno"> 1646</span> </div>
<div class="line"><a id="l01647" name="l01647"></a><span class="lineno"> 1647</span>      <span class="keywordflow">if</span> (.not. snowng) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01648" name="l01648"></a><span class="lineno"> 1648</span>        <span class="keywordflow">if</span> (prcp &gt; 0.0)  rr = rr + cph2o1*prcp/rch</div>
<div class="line"><a id="l01649" name="l01649"></a><span class="lineno"> 1649</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l01650" name="l01650"></a><span class="lineno"> 1650</span><span class="comment">! ---- ...  fractional snowfall/rainfall</span></div>
<div class="line"><a id="l01651" name="l01651"></a><span class="lineno"> 1651</span>        rr = rr + (cpice*ffrozp+cph2o1*(1.-ffrozp))                      &amp;</div>
<div class="line"><a id="l01652" name="l01652"></a><span class="lineno"> 1652</span>     &amp;       *prcp/rch</div>
<div class="line"><a id="l01653" name="l01653"></a><span class="lineno"> 1653</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l01654" name="l01654"></a><span class="lineno"> 1654</span> </div>
<div class="line"><a id="l01655" name="l01655"></a><span class="lineno"> 1655</span>      fnet = fdown - sfcems*sigma1*t24 - ssoil</div>
<div class="line"><a id="l01656" name="l01656"></a><span class="lineno"> 1656</span> </div>
<div class="line"><a id="l01657" name="l01657"></a><span class="lineno"> 1657</span><span class="comment">!  --- ...  include the latent heat effects of frzng rain converting to ice</span></div>
<div class="line"><a id="l01658" name="l01658"></a><span class="lineno"> 1658</span><span class="comment">!           on impact in the calculation of flx2 and fnet.</span></div>
<div class="line"><a id="l01659" name="l01659"></a><span class="lineno"> 1659</span> </div>
<div class="line"><a id="l01660" name="l01660"></a><span class="lineno"> 1660</span>      <span class="keywordflow">if</span> (frzgra) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01661" name="l01661"></a><span class="lineno"> 1661</span>        flx2 = -lsubf * prcp</div>
<div class="line"><a id="l01662" name="l01662"></a><span class="lineno"> 1662</span>        fnet = fnet - flx2</div>
<div class="line"><a id="l01663" name="l01663"></a><span class="lineno"> 1663</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l01664" name="l01664"></a><span class="lineno"> 1664</span> </div>
<div class="line"><a id="l01665" name="l01665"></a><span class="lineno"> 1665</span><span class="comment">!  --- ...  finish penman equation calculations.</span></div>
<div class="line"><a id="l01666" name="l01666"></a><span class="lineno"> 1666</span> </div>
<div class="line"><a id="l01667" name="l01667"></a><span class="lineno"> 1667</span>      rad = fnet/rch + th2 - sfctmp</div>
<div class="line"><a id="l01668" name="l01668"></a><span class="lineno"> 1668</span>      a = elcp * (q2sat - q2)</div>
<div class="line"><a id="l01669" name="l01669"></a><span class="lineno"> 1669</span>      epsca = (a*rr + rad*delta) / (delta + rr)</div>
<div class="line"><a id="l01670" name="l01670"></a><span class="lineno"> 1670</span>      etp = epsca * rch / lsubc</div>
<div class="line"><a id="l01671" name="l01671"></a><span class="lineno"> 1671</span><span class="comment">!</span></div>
<div class="line"><a id="l01672" name="l01672"></a><span class="lineno"> 1672</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l01673" name="l01673"></a><span class="lineno"> 1673</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga25b90f8a8049eb17cc6cb6a3fecf3fdc.html#ga25b90f8a8049eb17cc6cb6a3fecf3fdc">penman</a></div>
<div class="line"><a id="l01674" name="l01674"></a><span class="lineno"> 1674</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l01675" name="l01675"></a><span class="lineno"> 1675</span> </div>
<div class="line"><a id="l01676" name="l01676"></a><span class="lineno"> 1676</span> </div>
<div class="line"><a id="l01677" name="l01677"></a><span class="lineno"> 1677</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l01678" name="l01678"></a><span class="lineno"> 1678</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l01679" name="l01679"></a><span class="lineno"> 1679</span><span class="comment">!&gt; This subroutine internally sets default values or optionally read-in</span></div>
<div class="line"><a id="l01680" name="l01680"></a><span class="lineno"> 1680</span><span class="comment">!! via namelist i/o, all soil and vegetation parateters requied for the execusion</span></div>
<div class="line"><a id="l01681" name="l01681"></a><span class="lineno"> 1681</span><span class="comment">!! of the Noah LSM.</span></div>
<div class="foldopen" id="foldopen01682" data-start="" data-end="">
<div class="line"><a id="l01682" name="l01682"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga1c19b4bae5de2a391c019b6778a58dad.html#ga1c19b4bae5de2a391c019b6778a58dad"> 1682</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga1c19b4bae5de2a391c019b6778a58dad.html#ga1c19b4bae5de2a391c019b6778a58dad">redprm</a>(errmsg, errflg)</div>
<div class="line"><a id="l01683" name="l01683"></a><span class="lineno"> 1683</span><span class="comment">!...................................</span></div>
<div class="line"><a id="l01684" name="l01684"></a><span class="lineno"> 1684</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01685" name="l01685"></a><span class="lineno"> 1685</span><span class="comment">!    &amp;     ( nsoil, vegtyp, soiltyp, slopetyp, sldpth, zsoil,              &amp;</span></div>
<div class="line"><a id="l01686" name="l01686"></a><span class="lineno"> 1686</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01687" name="l01687"></a><span class="lineno"> 1687</span><span class="comment">!    &amp;       cfactr, cmcmax, rsmin, rsmax, topt, refkdt, kdt,              &amp;</span></div>
<div class="line"><a id="l01688" name="l01688"></a><span class="lineno"> 1688</span><span class="comment">!    &amp;       sbeta, shdfac, rgl, hs, zbot, frzx, psisat, slope,            &amp;</span></div>
<div class="line"><a id="l01689" name="l01689"></a><span class="lineno"> 1689</span><span class="comment">!    &amp;       snup, salp, bexp, dksat, dwsat, smcmax, smcwlt,               &amp;</span></div>
<div class="line"><a id="l01690" name="l01690"></a><span class="lineno"> 1690</span><span class="comment">!    &amp;       smcref, smcdry, f1, quartz, fxexp, rtdis, nroot,              &amp;</span></div>
<div class="line"><a id="l01691" name="l01691"></a><span class="lineno"> 1691</span><span class="comment">!    &amp;       z0, czil, xlai, csoil                                         &amp;</span></div>
<div class="line"><a id="l01692" name="l01692"></a><span class="lineno"> 1692</span><span class="comment">!    &amp;     )</span></div>
<div class="line"><a id="l01693" name="l01693"></a><span class="lineno"> 1693</span> </div>
<div class="line"><a id="l01694" name="l01694"></a><span class="lineno"> 1694</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l01695" name="l01695"></a><span class="lineno"> 1695</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l01696" name="l01696"></a><span class="lineno"> 1696</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01697" name="l01697"></a><span class="lineno"> 1697</span><span class="comment">!  subroutine redprm internally sets(default valuess), or optionally    !</span></div>
<div class="line"><a id="l01698" name="l01698"></a><span class="lineno"> 1698</span><span class="comment">!  read-in via namelist i/o, all soil and vegetation parameters         !</span></div>
<div class="line"><a id="l01699" name="l01699"></a><span class="lineno"> 1699</span><span class="comment">!  required for the execusion of the noah lsm.                          !</span></div>
<div class="line"><a id="l01700" name="l01700"></a><span class="lineno"> 1700</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01701" name="l01701"></a><span class="lineno"> 1701</span><span class="comment">!  optional non-default parameters can be read in, accommodating up to  !</span></div>
<div class="line"><a id="l01702" name="l01702"></a><span class="lineno"> 1702</span><span class="comment">!  30 soil, veg, or slope classes, if the default max number of soil,   !</span></div>
<div class="line"><a id="l01703" name="l01703"></a><span class="lineno"> 1703</span><span class="comment">!  veg, and/or slope types is reset.                                    !</span></div>
<div class="line"><a id="l01704" name="l01704"></a><span class="lineno"> 1704</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01705" name="l01705"></a><span class="lineno"> 1705</span><span class="comment">!  future upgrades of routine redprm must expand to incorporate some    !</span></div>
<div class="line"><a id="l01706" name="l01706"></a><span class="lineno"> 1706</span><span class="comment">!  of the empirical parameters of the frozen soil and snowpack physics  !</span></div>
<div class="line"><a id="l01707" name="l01707"></a><span class="lineno"> 1707</span><span class="comment">!  (such as in routines frh2o, snowpack, and snow_new) not yet set in   !</span></div>
<div class="line"><a id="l01708" name="l01708"></a><span class="lineno"> 1708</span><span class="comment">!  this redprm routine, but rather set in lower level subroutines.      !</span></div>
<div class="line"><a id="l01709" name="l01709"></a><span class="lineno"> 1709</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01710" name="l01710"></a><span class="lineno"> 1710</span><span class="comment">!  all soil, veg, slope, and universal parameters values are defined    !</span></div>
<div class="line"><a id="l01711" name="l01711"></a><span class="lineno"> 1711</span><span class="comment">!  externally (in subroutine &quot;set_soilveg.f&quot;) and then accessed via     !</span></div>
<div class="line"><a id="l01712" name="l01712"></a><span class="lineno"> 1712</span><span class="comment">!  &quot;use namelist_soilveg&quot; (below) and then set here.                    !</span></div>
<div class="line"><a id="l01713" name="l01713"></a><span class="lineno"> 1713</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01714" name="l01714"></a><span class="lineno"> 1714</span><span class="comment">!  soil types   zobler (1986)      cosby et al (1984) (quartz cont.(1)) !</span></div>
<div class="line"><a id="l01715" name="l01715"></a><span class="lineno"> 1715</span><span class="comment">!      1         coarse            loamy sand            (0.82)         !</span></div>
<div class="line"><a id="l01716" name="l01716"></a><span class="lineno"> 1716</span><span class="comment">!      2         medium            silty clay loam       (0.10)         !</span></div>
<div class="line"><a id="l01717" name="l01717"></a><span class="lineno"> 1717</span><span class="comment">!      3         fine              light clay            (0.25)         !</span></div>
<div class="line"><a id="l01718" name="l01718"></a><span class="lineno"> 1718</span><span class="comment">!      4         coarse-medium     sandy loam            (0.60)         !</span></div>
<div class="line"><a id="l01719" name="l01719"></a><span class="lineno"> 1719</span><span class="comment">!      5         coarse-fine       sandy clay            (0.52)         !</span></div>
<div class="line"><a id="l01720" name="l01720"></a><span class="lineno"> 1720</span><span class="comment">!      6         medium-fine       clay loam             (0.35)         !</span></div>
<div class="line"><a id="l01721" name="l01721"></a><span class="lineno"> 1721</span><span class="comment">!      7         coarse-med-fine   sandy clay loam       (0.60)         !</span></div>
<div class="line"><a id="l01722" name="l01722"></a><span class="lineno"> 1722</span><span class="comment">!      8         organic           loam                  (0.40)         !</span></div>
<div class="line"><a id="l01723" name="l01723"></a><span class="lineno"> 1723</span><span class="comment">!      9         glacial land ice  loamy sand            (na using 0.82)!</span></div>
<div class="line"><a id="l01724" name="l01724"></a><span class="lineno"> 1724</span><span class="comment">!     13: &lt;old&gt;- glacial land ice -&lt;old&gt;                                !</span></div>
<div class="line"><a id="l01725" name="l01725"></a><span class="lineno"> 1725</span><span class="comment">!     13:        glacial-ice (no longer use these parameters), now      !</span></div>
<div class="line"><a id="l01726" name="l01726"></a><span class="lineno"> 1726</span><span class="comment">!                treated as ice-only surface and sub-surface            !</span></div>
<div class="line"><a id="l01727" name="l01727"></a><span class="lineno"> 1727</span><span class="comment">!                (in subroutine hrtice)                                 !</span></div>
<div class="line"><a id="l01728" name="l01728"></a><span class="lineno"> 1728</span><span class="comment">!  upgraded to statsgo (19-type)</span></div>
<div class="line"><a id="l01729" name="l01729"></a><span class="lineno"> 1729</span><span class="comment">!     1: sand</span></div>
<div class="line"><a id="l01730" name="l01730"></a><span class="lineno"> 1730</span><span class="comment">!     2: loamy sand</span></div>
<div class="line"><a id="l01731" name="l01731"></a><span class="lineno"> 1731</span><span class="comment">!     3: sandy loam</span></div>
<div class="line"><a id="l01732" name="l01732"></a><span class="lineno"> 1732</span><span class="comment">!     4: silt loam</span></div>
<div class="line"><a id="l01733" name="l01733"></a><span class="lineno"> 1733</span><span class="comment">!     5: silt</span></div>
<div class="line"><a id="l01734" name="l01734"></a><span class="lineno"> 1734</span><span class="comment">!     6:loam</span></div>
<div class="line"><a id="l01735" name="l01735"></a><span class="lineno"> 1735</span><span class="comment">!     7:sandy clay loam</span></div>
<div class="line"><a id="l01736" name="l01736"></a><span class="lineno"> 1736</span><span class="comment">!     8:silty clay loam</span></div>
<div class="line"><a id="l01737" name="l01737"></a><span class="lineno"> 1737</span><span class="comment">!     9:clay loam</span></div>
<div class="line"><a id="l01738" name="l01738"></a><span class="lineno"> 1738</span><span class="comment">!     10:sandy clay</span></div>
<div class="line"><a id="l01739" name="l01739"></a><span class="lineno"> 1739</span><span class="comment">!     11: silty clay</span></div>
<div class="line"><a id="l01740" name="l01740"></a><span class="lineno"> 1740</span><span class="comment">!     12: clay</span></div>
<div class="line"><a id="l01741" name="l01741"></a><span class="lineno"> 1741</span><span class="comment">!     13: organic material</span></div>
<div class="line"><a id="l01742" name="l01742"></a><span class="lineno"> 1742</span><span class="comment">!     14: water</span></div>
<div class="line"><a id="l01743" name="l01743"></a><span class="lineno"> 1743</span><span class="comment">!     15: bedrock</span></div>
<div class="line"><a id="l01744" name="l01744"></a><span class="lineno"> 1744</span><span class="comment">!     16: other (land-ice)</span></div>
<div class="line"><a id="l01745" name="l01745"></a><span class="lineno"> 1745</span><span class="comment">!     17: playa</span></div>
<div class="line"><a id="l01746" name="l01746"></a><span class="lineno"> 1746</span><span class="comment">!     18: lava</span></div>
<div class="line"><a id="l01747" name="l01747"></a><span class="lineno"> 1747</span><span class="comment">!     19: white sand</span></div>
<div class="line"><a id="l01748" name="l01748"></a><span class="lineno"> 1748</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01749" name="l01749"></a><span class="lineno"> 1749</span><span class="comment">!  ssib vegetation types (dorman and sellers, 1989; jam)                !</span></div>
<div class="line"><a id="l01750" name="l01750"></a><span class="lineno"> 1750</span><span class="comment">!      1:  broadleaf-evergreen trees  (tropical forest)                 !</span></div>
<div class="line"><a id="l01751" name="l01751"></a><span class="lineno"> 1751</span><span class="comment">!      2:  broadleaf-deciduous trees                                    !</span></div>
<div class="line"><a id="l01752" name="l01752"></a><span class="lineno"> 1752</span><span class="comment">!      3:  broadleaf and needleleaf trees (mixed forest)                !</span></div>
<div class="line"><a id="l01753" name="l01753"></a><span class="lineno"> 1753</span><span class="comment">!      4:  needleleaf-evergreen trees                                   !</span></div>
<div class="line"><a id="l01754" name="l01754"></a><span class="lineno"> 1754</span><span class="comment">!      5:  needleleaf-deciduous trees (larch)                           !</span></div>
<div class="line"><a id="l01755" name="l01755"></a><span class="lineno"> 1755</span><span class="comment">!      6:  broadleaf trees with groundcover (savanna)                   !</span></div>
<div class="line"><a id="l01756" name="l01756"></a><span class="lineno"> 1756</span><span class="comment">!      7:  groundcover only (perennial)                                 !</span></div>
<div class="line"><a id="l01757" name="l01757"></a><span class="lineno"> 1757</span><span class="comment">!      8:  broadleaf shrubs with perennial groundcover                  !</span></div>
<div class="line"><a id="l01758" name="l01758"></a><span class="lineno"> 1758</span><span class="comment">!      9:  broadleaf shrubs with bare soil                              !</span></div>
<div class="line"><a id="l01759" name="l01759"></a><span class="lineno"> 1759</span><span class="comment">!     10:  dwarf trees and shrubs with groundcover (tundra)             !</span></div>
<div class="line"><a id="l01760" name="l01760"></a><span class="lineno"> 1760</span><span class="comment">!     11:  bare soil                                                    !</span></div>
<div class="line"><a id="l01761" name="l01761"></a><span class="lineno"> 1761</span><span class="comment">!     12:  cultivations (the same parameters as for type 7)             !</span></div>
<div class="line"><a id="l01762" name="l01762"></a><span class="lineno"> 1762</span><span class="comment">!     13: &lt;old&gt;- glacial (the same parameters as for type 11) -&lt;old&gt;    !</span></div>
<div class="line"><a id="l01763" name="l01763"></a><span class="lineno"> 1763</span><span class="comment">!     13:  glacial-ice (no longer use these parameters), now treated as !</span></div>
<div class="line"><a id="l01764" name="l01764"></a><span class="lineno"> 1764</span><span class="comment">!          ice-only surface and sub-surface (in subroutine hrtice)      !</span></div>
<div class="line"><a id="l01765" name="l01765"></a><span class="lineno"> 1765</span><span class="comment">!  upgraded to IGBP (20-type)</span></div>
<div class="line"><a id="l01766" name="l01766"></a><span class="lineno"> 1766</span><span class="comment">!      1:Evergreen Needleleaf Forest</span></div>
<div class="line"><a id="l01767" name="l01767"></a><span class="lineno"> 1767</span><span class="comment">!      2:Evergreen Broadleaf Forest</span></div>
<div class="line"><a id="l01768" name="l01768"></a><span class="lineno"> 1768</span><span class="comment">!      3:Deciduous Needleleaf Forest</span></div>
<div class="line"><a id="l01769" name="l01769"></a><span class="lineno"> 1769</span><span class="comment">!      4:Deciduous Broadleaf Forest</span></div>
<div class="line"><a id="l01770" name="l01770"></a><span class="lineno"> 1770</span><span class="comment">!      5:Mixed Forests</span></div>
<div class="line"><a id="l01771" name="l01771"></a><span class="lineno"> 1771</span><span class="comment">!      6:Closed Shrublands</span></div>
<div class="line"><a id="l01772" name="l01772"></a><span class="lineno"> 1772</span><span class="comment">!      7:Open Shrublands</span></div>
<div class="line"><a id="l01773" name="l01773"></a><span class="lineno"> 1773</span><span class="comment">!      8:Woody Savannas</span></div>
<div class="line"><a id="l01774" name="l01774"></a><span class="lineno"> 1774</span><span class="comment">!      9:Savannas</span></div>
<div class="line"><a id="l01775" name="l01775"></a><span class="lineno"> 1775</span><span class="comment">!      10:Grasslands</span></div>
<div class="line"><a id="l01776" name="l01776"></a><span class="lineno"> 1776</span><span class="comment">!      11:Permanent wetlands</span></div>
<div class="line"><a id="l01777" name="l01777"></a><span class="lineno"> 1777</span><span class="comment">!      12:Croplands</span></div>
<div class="line"><a id="l01778" name="l01778"></a><span class="lineno"> 1778</span><span class="comment">!      13:Urban and Built-Up</span></div>
<div class="line"><a id="l01779" name="l01779"></a><span class="lineno"> 1779</span><span class="comment">!      14:Cropland/natural vegetation mosaic</span></div>
<div class="line"><a id="l01780" name="l01780"></a><span class="lineno"> 1780</span><span class="comment">!      15:Snow and Ice</span></div>
<div class="line"><a id="l01781" name="l01781"></a><span class="lineno"> 1781</span><span class="comment">!      16:Barren or Sparsely Vegetated</span></div>
<div class="line"><a id="l01782" name="l01782"></a><span class="lineno"> 1782</span><span class="comment">!      17:Water</span></div>
<div class="line"><a id="l01783" name="l01783"></a><span class="lineno"> 1783</span><span class="comment">!      18:Wooded Tundra</span></div>
<div class="line"><a id="l01784" name="l01784"></a><span class="lineno"> 1784</span><span class="comment">!      19:Mixed Tundra</span></div>
<div class="line"><a id="l01785" name="l01785"></a><span class="lineno"> 1785</span><span class="comment">!      20:Bare Ground Tundra</span></div>
<div class="line"><a id="l01786" name="l01786"></a><span class="lineno"> 1786</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01787" name="l01787"></a><span class="lineno"> 1787</span><span class="comment">!  slopetyp is to estimate linear reservoir coefficient slope to the    !</span></div>
<div class="line"><a id="l01788" name="l01788"></a><span class="lineno"> 1788</span><span class="comment">!  baseflow runoff out of the bottom layer. lowest class (slopetyp=0)   !</span></div>
<div class="line"><a id="l01789" name="l01789"></a><span class="lineno"> 1789</span><span class="comment">!  means highest slope parameter = 1.                                   !</span></div>
<div class="line"><a id="l01790" name="l01790"></a><span class="lineno"> 1790</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01791" name="l01791"></a><span class="lineno"> 1791</span><span class="comment">!  slope class       percent slope                                      !</span></div>
<div class="line"><a id="l01792" name="l01792"></a><span class="lineno"> 1792</span><span class="comment">!      1                0-8                                             !</span></div>
<div class="line"><a id="l01793" name="l01793"></a><span class="lineno"> 1793</span><span class="comment">!      2                8-30                                            !</span></div>
<div class="line"><a id="l01794" name="l01794"></a><span class="lineno"> 1794</span><span class="comment">!      3                &gt; 30                                            !</span></div>
<div class="line"><a id="l01795" name="l01795"></a><span class="lineno"> 1795</span><span class="comment">!      4                0-30                                            !</span></div>
<div class="line"><a id="l01796" name="l01796"></a><span class="lineno"> 1796</span><span class="comment">!      5                0-8 &amp; &gt; 30                                      !</span></div>
<div class="line"><a id="l01797" name="l01797"></a><span class="lineno"> 1797</span><span class="comment">!      6                8-30 &amp; &gt; 30                                     !</span></div>
<div class="line"><a id="l01798" name="l01798"></a><span class="lineno"> 1798</span><span class="comment">!      7                0-8, 8-30, &gt; 30                                 !</span></div>
<div class="line"><a id="l01799" name="l01799"></a><span class="lineno"> 1799</span><span class="comment">!      9                glacial ice                                     !</span></div>
<div class="line"><a id="l01800" name="l01800"></a><span class="lineno"> 1800</span><span class="comment">!    blank              ocean/sea                                       !</span></div>
<div class="line"><a id="l01801" name="l01801"></a><span class="lineno"> 1801</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01802" name="l01802"></a><span class="lineno"> 1802</span><span class="comment">!  note: class 9 from zobler file should be replaced by 8 and &#39;blank&#39; 9 !</span></div>
<div class="line"><a id="l01803" name="l01803"></a><span class="lineno"> 1803</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01804" name="l01804"></a><span class="lineno"> 1804</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01805" name="l01805"></a><span class="lineno"> 1805</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l01806" name="l01806"></a><span class="lineno"> 1806</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01807" name="l01807"></a><span class="lineno"> 1807</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l01808" name="l01808"></a><span class="lineno"> 1808</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01809" name="l01809"></a><span class="lineno"> 1809</span><span class="comment">!  inputs from calling program:                                  size   !</span></div>
<div class="line"><a id="l01810" name="l01810"></a><span class="lineno"> 1810</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l01811" name="l01811"></a><span class="lineno"> 1811</span><span class="comment">!     vegtyp   - integer, vegetation type (integer index)          1    !</span></div>
<div class="line"><a id="l01812" name="l01812"></a><span class="lineno"> 1812</span><span class="comment">!     soiltyp  - integer, soil type (integer index)                1    !</span></div>
<div class="line"><a id="l01813" name="l01813"></a><span class="lineno"> 1813</span><span class="comment">!     slopetyp - integer, class of sfc slope (integer index)       1    !</span></div>
<div class="line"><a id="l01814" name="l01814"></a><span class="lineno"> 1814</span><span class="comment">!     sldpth   - integer, thickness of each soil layer (m)       nsoil  !</span></div>
<div class="line"><a id="l01815" name="l01815"></a><span class="lineno"> 1815</span><span class="comment">!     zsoil    - integer, soil depth (negative sign) (m)         nsoil  !</span></div>
<div class="line"><a id="l01816" name="l01816"></a><span class="lineno"> 1816</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01817" name="l01817"></a><span class="lineno"> 1817</span><span class="comment">!  outputs to the calling program:                                      !</span></div>
<div class="line"><a id="l01818" name="l01818"></a><span class="lineno"> 1818</span><span class="comment">!     cfactr   - real, canopy water parameters                     1    !</span></div>
<div class="line"><a id="l01819" name="l01819"></a><span class="lineno"> 1819</span><span class="comment">!     cmcmax   - real, maximum canopy water parameters             1    !</span></div>
<div class="line"><a id="l01820" name="l01820"></a><span class="lineno"> 1820</span><span class="comment">!     rsmin    - real, mimimum stomatal resistance                 1    !</span></div>
<div class="line"><a id="l01821" name="l01821"></a><span class="lineno"> 1821</span><span class="comment">!     rsmax    - real, maximum stomatal resistance                 1    !</span></div>
<div class="line"><a id="l01822" name="l01822"></a><span class="lineno"> 1822</span><span class="comment">!     topt     - real, optimum transpiration air temperature       1    !</span></div>
<div class="line"><a id="l01823" name="l01823"></a><span class="lineno"> 1823</span><span class="comment">!     refkdt   - real, =2.e-6 the sat. dk. val for soil type 2     1    !</span></div>
<div class="line"><a id="l01824" name="l01824"></a><span class="lineno"> 1824</span><span class="comment">!     kdt      - real,                                             1    !</span></div>
<div class="line"><a id="l01825" name="l01825"></a><span class="lineno"> 1825</span><span class="comment">!     sbeta    - real, param to cal veg effect on soil heat flux   1    !</span></div>
<div class="line"><a id="l01826" name="l01826"></a><span class="lineno"> 1826</span><span class="comment">!     shdfac   - real, vegetation greenness fraction               1    !</span></div>
<div class="line"><a id="l01827" name="l01827"></a><span class="lineno"> 1827</span><span class="comment">!     rgl      - real, canopy resistance func (in solar rad term)  1    !</span></div>
<div class="line"><a id="l01828" name="l01828"></a><span class="lineno"> 1828</span><span class="comment">!     hs       - real, canopy resistance func (vapor deficit term) 1    !</span></div>
<div class="line"><a id="l01829" name="l01829"></a><span class="lineno"> 1829</span><span class="comment">!     zbot     - real, specify depth of lower bd soil temp (m)     1    !</span></div>
<div class="line"><a id="l01830" name="l01830"></a><span class="lineno"> 1830</span><span class="comment">!     frzx     - real, frozen ground parameter, ice content        1    !</span></div>
<div class="line"><a id="l01831" name="l01831"></a><span class="lineno"> 1831</span><span class="comment">!                      threshold above which frozen soil is impermeable !</span></div>
<div class="line"><a id="l01832" name="l01832"></a><span class="lineno"> 1832</span><span class="comment">!     psisat   - real, saturated soil potential                    1    !</span></div>
<div class="line"><a id="l01833" name="l01833"></a><span class="lineno"> 1833</span><span class="comment">!     slope    - real, linear reservoir coefficient                1    !</span></div>
<div class="line"><a id="l01834" name="l01834"></a><span class="lineno"> 1834</span><span class="comment">!     snup     - real, threshold snow depth (water equi m)         1    !</span></div>
<div class="line"><a id="l01835" name="l01835"></a><span class="lineno"> 1835</span><span class="comment">!     salp     - real, snow cover shape parameter                  1    !</span></div>
<div class="line"><a id="l01836" name="l01836"></a><span class="lineno"> 1836</span><span class="comment">!                      from anderson&#39;s hydro-17 best fit salp = 2.6     !</span></div>
<div class="line"><a id="l01837" name="l01837"></a><span class="lineno"> 1837</span><span class="comment">!     bexp     - real, the &#39;b&#39; parameter                           1    !</span></div>
<div class="line"><a id="l01838" name="l01838"></a><span class="lineno"> 1838</span><span class="comment">!     dksat    - real, saturated soil hydraulic conductivity       1    !</span></div>
<div class="line"><a id="l01839" name="l01839"></a><span class="lineno"> 1839</span><span class="comment">!     dwsat    - real, saturated soil diffusivity                  1    !</span></div>
<div class="line"><a id="l01840" name="l01840"></a><span class="lineno"> 1840</span><span class="comment">!     smcmax   - real, max soil moisture content (porosity)        1    !</span></div>
<div class="line"><a id="l01841" name="l01841"></a><span class="lineno"> 1841</span><span class="comment">!     smcwlt   - real, wilting pt soil moisture contents           1    !</span></div>
<div class="line"><a id="l01842" name="l01842"></a><span class="lineno"> 1842</span><span class="comment">!     smcref   - real, reference soil moisture (onset stress)      1    !</span></div>
<div class="line"><a id="l01843" name="l01843"></a><span class="lineno"> 1843</span><span class="comment">!     smcdry   - real, air dry soil moist content limits           1    !</span></div>
<div class="line"><a id="l01844" name="l01844"></a><span class="lineno"> 1844</span><span class="comment">!     f1       - real, used to comp soil diffusivity/conductivity  1    !</span></div>
<div class="line"><a id="l01845" name="l01845"></a><span class="lineno"> 1845</span><span class="comment">!     quartz   - real, soil quartz content                         1    !</span></div>
<div class="line"><a id="l01846" name="l01846"></a><span class="lineno"> 1846</span><span class="comment">!     fxexp    - real, bare soil evaporation exponent              1    !</span></div>
<div class="line"><a id="l01847" name="l01847"></a><span class="lineno"> 1847</span><span class="comment">!     rtdis    - real, root distribution                         nsoil  !</span></div>
<div class="line"><a id="l01848" name="l01848"></a><span class="lineno"> 1848</span><span class="comment">!     nroot    - integer, number of root layers                    1    !</span></div>
<div class="line"><a id="l01849" name="l01849"></a><span class="lineno"> 1849</span><span class="comment">!     z0       - real, roughness length (m)                        1    !</span></div>
<div class="line"><a id="l01850" name="l01850"></a><span class="lineno"> 1850</span><span class="comment">!     czil     - real, param to cal roughness length of heat       1    !</span></div>
<div class="line"><a id="l01851" name="l01851"></a><span class="lineno"> 1851</span><span class="comment">!     xlai     - real, leaf area index                             1    !</span></div>
<div class="line"><a id="l01852" name="l01852"></a><span class="lineno"> 1852</span><span class="comment">!     csoil    - real, soil heat capacity (j m-3 k-1)              1    !</span></div>
<div class="line"><a id="l01853" name="l01853"></a><span class="lineno"> 1853</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01854" name="l01854"></a><span class="lineno"> 1854</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l01855" name="l01855"></a><span class="lineno"> 1855</span><span class="comment">!</span></div>
<div class="line"><a id="l01856" name="l01856"></a><span class="lineno"> 1856</span>      <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacenamelist__soilveg.html">namelist_soilveg</a></div>
<div class="line"><a id="l01857" name="l01857"></a><span class="lineno"> 1857</span> </div>
<div class="line"><a id="l01858" name="l01858"></a><span class="lineno"> 1858</span><span class="comment">!  ---  input:</span></div>
<div class="line"><a id="l01859" name="l01859"></a><span class="lineno"> 1859</span><span class="comment">!     integer, intent(in) :: nsoil, vegtyp, soiltyp, slopetyp</span></div>
<div class="line"><a id="l01860" name="l01860"></a><span class="lineno"> 1860</span> </div>
<div class="line"><a id="l01861" name="l01861"></a><span class="lineno"> 1861</span><span class="comment">!     real (kind=kind_phys), intent(in) :: sldpth(nsoil), zsoil(nsoil)</span></div>
<div class="line"><a id="l01862" name="l01862"></a><span class="lineno"> 1862</span> </div>
<div class="line"><a id="l01863" name="l01863"></a><span class="lineno"> 1863</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l01864" name="l01864"></a><span class="lineno"> 1864</span><span class="comment">!     real (kind=kind_phys), intent(out) :: cfactr, cmcmax, rsmin,      &amp;</span></div>
<div class="line"><a id="l01865" name="l01865"></a><span class="lineno"> 1865</span><span class="comment">!    &amp;       rsmax, topt, refkdt, kdt, sbeta, shdfac, rgl, hs, zbot,    &amp;</span></div>
<div class="line"><a id="l01866" name="l01866"></a><span class="lineno"> 1866</span><span class="comment">!    &amp;       frzx, psisat, slope, snup, salp, bexp, dksat, dwsat,       &amp;</span></div>
<div class="line"><a id="l01867" name="l01867"></a><span class="lineno"> 1867</span><span class="comment">!    &amp;       smcmax, smcwlt, smcref, smcdry, f1, quartz, fxexp, z0,     &amp;</span></div>
<div class="line"><a id="l01868" name="l01868"></a><span class="lineno"> 1868</span><span class="comment">!    &amp;       czil, xlai, csoil, rtdis(nsoil)</span></div>
<div class="line"><a id="l01869" name="l01869"></a><span class="lineno"> 1869</span>      <span class="keywordtype">character(len=*)</span>,     <span class="keywordtype">intent(out)</span> :: errmsg</div>
<div class="line"><a id="l01870" name="l01870"></a><span class="lineno"> 1870</span>      <span class="keywordtype">integer</span>,              <span class="keywordtype">intent(out)</span> :: errflg</div>
<div class="line"><a id="l01871" name="l01871"></a><span class="lineno"> 1871</span><span class="comment">!     integer, intent(out) :: nroot</span></div>
<div class="line"><a id="l01872" name="l01872"></a><span class="lineno"> 1872</span> </div>
<div class="line"><a id="l01873" name="l01873"></a><span class="lineno"> 1873</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l01874" name="l01874"></a><span class="lineno"> 1874</span><span class="keywordtype">      real</span> (kind=kind_phys) :: frzfact, frzk, refdk</div>
<div class="line"><a id="l01875" name="l01875"></a><span class="lineno"> 1875</span> </div>
<div class="line"><a id="l01876" name="l01876"></a><span class="lineno"> 1876</span>      <span class="keywordtype">integer</span> :: i</div>
<div class="line"><a id="l01877" name="l01877"></a><span class="lineno"> 1877</span> </div>
<div class="line"><a id="l01878" name="l01878"></a><span class="lineno"> 1878</span><span class="comment">!</span></div>
<div class="line"><a id="l01879" name="l01879"></a><span class="lineno"> 1879</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l01880" name="l01880"></a><span class="lineno"> 1880</span><span class="comment">!</span></div>
<div class="line"><a id="l01881" name="l01881"></a><span class="lineno"> 1881</span><span class="comment">! Initialize CCPP error-handling</span></div>
<div class="line"><a id="l01882" name="l01882"></a><span class="lineno"> 1882</span>      errflg = 0</div>
<div class="line"><a id="l01883" name="l01883"></a><span class="lineno"> 1883</span>      errmsg = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a id="l01884" name="l01884"></a><span class="lineno"> 1884</span> </div>
<div class="line"><a id="l01885" name="l01885"></a><span class="lineno"> 1885</span>      <span class="keywordflow">if</span> (soiltyp &gt; defined_soil) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01886" name="l01886"></a><span class="lineno"> 1886</span>        <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;warning: too many soil types,soiltyp=&#39;</span>,soiltyp,     &amp;</div>
<div class="line"><a id="l01887" name="l01887"></a><span class="lineno"> 1887</span>     &amp;   <span class="stringliteral">&#39;defined_soil=&#39;</span>,defined_soil</div>
<div class="line"><a id="l01888" name="l01888"></a><span class="lineno"> 1888</span>        errflg = 1</div>
<div class="line"><a id="l01889" name="l01889"></a><span class="lineno"> 1889</span>        errmsg = <span class="stringliteral">&#39;ERROR(sflx.f): too many soil types&#39;</span></div>
<div class="line"><a id="l01890" name="l01890"></a><span class="lineno"> 1890</span>        <span class="keywordflow">return</span></div>
<div class="line"><a id="l01891" name="l01891"></a><span class="lineno"> 1891</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l01892" name="l01892"></a><span class="lineno"> 1892</span> </div>
<div class="line"><a id="l01893" name="l01893"></a><span class="lineno"> 1893</span>      <span class="keywordflow">if</span> (vegtyp &gt; defined_veg) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01894" name="l01894"></a><span class="lineno"> 1894</span>        <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;warning: too many veg types&#39;</span></div>
<div class="line"><a id="l01895" name="l01895"></a><span class="lineno"> 1895</span>        errflg = 1</div>
<div class="line"><a id="l01896" name="l01896"></a><span class="lineno"> 1896</span>        errmsg = <span class="stringliteral">&#39;ERROR(sflx.f): too many veg types&#39;</span></div>
<div class="line"><a id="l01897" name="l01897"></a><span class="lineno"> 1897</span>        <span class="keywordflow">return</span></div>
<div class="line"><a id="l01898" name="l01898"></a><span class="lineno"> 1898</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l01899" name="l01899"></a><span class="lineno"> 1899</span> </div>
<div class="line"><a id="l01900" name="l01900"></a><span class="lineno"> 1900</span>      <span class="keywordflow">if</span> (slopetyp &gt; defined_slope) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01901" name="l01901"></a><span class="lineno"> 1901</span>        <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;warning: too many slope types&#39;</span></div>
<div class="line"><a id="l01902" name="l01902"></a><span class="lineno"> 1902</span>        errflg = 1</div>
<div class="line"><a id="l01903" name="l01903"></a><span class="lineno"> 1903</span>        errmsg = <span class="stringliteral">&#39;ERROR(sflx.f): too many slope types&#39;</span></div>
<div class="line"><a id="l01904" name="l01904"></a><span class="lineno"> 1904</span>        <span class="keywordflow">return</span></div>
<div class="line"><a id="l01905" name="l01905"></a><span class="lineno"> 1905</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l01906" name="l01906"></a><span class="lineno"> 1906</span> </div>
<div class="line"><a id="l01907" name="l01907"></a><span class="lineno"> 1907</span><span class="comment">!  --- ...  set-up universal parameters (not dependent on soiltyp, vegtyp</span></div>
<div class="line"><a id="l01908" name="l01908"></a><span class="lineno"> 1908</span><span class="comment">!           or slopetyp)</span></div>
<div class="line"><a id="l01909" name="l01909"></a><span class="lineno"> 1909</span> </div>
<div class="line"><a id="l01910" name="l01910"></a><span class="lineno"> 1910</span>      zbot   = zbot_data</div>
<div class="line"><a id="l01911" name="l01911"></a><span class="lineno"> 1911</span>      salp   = salp_data</div>
<div class="line"><a id="l01912" name="l01912"></a><span class="lineno"> 1912</span>      cfactr = cfactr_data</div>
<div class="line"><a id="l01913" name="l01913"></a><span class="lineno"> 1913</span>      cmcmax = cmcmax_data</div>
<div class="line"><a id="l01914" name="l01914"></a><span class="lineno"> 1914</span>      sbeta  = sbeta_data</div>
<div class="line"><a id="l01915" name="l01915"></a><span class="lineno"> 1915</span>      rsmax  = rsmax_data</div>
<div class="line"><a id="l01916" name="l01916"></a><span class="lineno"> 1916</span>      topt   = topt_data</div>
<div class="line"><a id="l01917" name="l01917"></a><span class="lineno"> 1917</span>      refdk  = refdk_data</div>
<div class="line"><a id="l01918" name="l01918"></a><span class="lineno"> 1918</span>      frzk   = frzk_data</div>
<div class="line"><a id="l01919" name="l01919"></a><span class="lineno"> 1919</span>      fxexp  = fxexp_data</div>
<div class="line"><a id="l01920" name="l01920"></a><span class="lineno"> 1920</span>      refkdt = refkdt_data</div>
<div class="line"><a id="l01921" name="l01921"></a><span class="lineno"> 1921</span>      czil   = czil_data</div>
<div class="line"><a id="l01922" name="l01922"></a><span class="lineno"> 1922</span>      csoil  = csoil_data</div>
<div class="line"><a id="l01923" name="l01923"></a><span class="lineno"> 1923</span> </div>
<div class="line"><a id="l01924" name="l01924"></a><span class="lineno"> 1924</span><span class="comment">!  --- ...  set-up soil parameters</span></div>
<div class="line"><a id="l01925" name="l01925"></a><span class="lineno"> 1925</span> </div>
<div class="line"><a id="l01926" name="l01926"></a><span class="lineno"> 1926</span>      bexp  = bb(soiltyp)</div>
<div class="line"><a id="l01927" name="l01927"></a><span class="lineno"> 1927</span>      dksat = satdk(soiltyp)</div>
<div class="line"><a id="l01928" name="l01928"></a><span class="lineno"> 1928</span>      dwsat = satdw(soiltyp)</div>
<div class="line"><a id="l01929" name="l01929"></a><span class="lineno"> 1929</span>      f1    = f11(soiltyp)</div>
<div class="line"><a id="l01930" name="l01930"></a><span class="lineno"> 1930</span>      kdt   = refkdt * dksat / refdk</div>
<div class="line"><a id="l01931" name="l01931"></a><span class="lineno"> 1931</span> </div>
<div class="line"><a id="l01932" name="l01932"></a><span class="lineno"> 1932</span>      psisat = satpsi(soiltyp)</div>
<div class="line"><a id="l01933" name="l01933"></a><span class="lineno"> 1933</span>      quartz = qtz(soiltyp)</div>
<div class="line"><a id="l01934" name="l01934"></a><span class="lineno"> 1934</span>      smcdry = drysmc(soiltyp)</div>
<div class="line"><a id="l01935" name="l01935"></a><span class="lineno"> 1935</span>      smcmax = maxsmc(soiltyp)</div>
<div class="line"><a id="l01936" name="l01936"></a><span class="lineno"> 1936</span>      smcref = refsmc(soiltyp)</div>
<div class="line"><a id="l01937" name="l01937"></a><span class="lineno"> 1937</span>      smcwlt = wltsmc(soiltyp)</div>
<div class="line"><a id="l01938" name="l01938"></a><span class="lineno"> 1938</span> </div>
<div class="line"><a id="l01939" name="l01939"></a><span class="lineno"> 1939</span>      frzfact = (smcmax / smcref) * (0.412 / 0.468)</div>
<div class="line"><a id="l01940" name="l01940"></a><span class="lineno"> 1940</span> </div>
<div class="line"><a id="l01941" name="l01941"></a><span class="lineno"> 1941</span><span class="comment">!  --- ...  to adjust frzk parameter to actual soil type: frzk * frzfact</span></div>
<div class="line"><a id="l01942" name="l01942"></a><span class="lineno"> 1942</span> </div>
<div class="line"><a id="l01943" name="l01943"></a><span class="lineno"> 1943</span>      frzx = frzk * frzfact</div>
<div class="line"><a id="l01944" name="l01944"></a><span class="lineno"> 1944</span> </div>
<div class="line"><a id="l01945" name="l01945"></a><span class="lineno"> 1945</span><span class="comment">!  --- ...  set-up vegetation parameters</span></div>
<div class="line"><a id="l01946" name="l01946"></a><span class="lineno"> 1946</span> </div>
<div class="line"><a id="l01947" name="l01947"></a><span class="lineno"> 1947</span>      nroot = nroot_data(vegtyp)</div>
<div class="line"><a id="l01948" name="l01948"></a><span class="lineno"> 1948</span>      snup  = snupx(vegtyp)</div>
<div class="line"><a id="l01949" name="l01949"></a><span class="lineno"> 1949</span>      rsmin = rsmtbl(vegtyp)</div>
<div class="line"><a id="l01950" name="l01950"></a><span class="lineno"> 1950</span> </div>
<div class="line"><a id="l01951" name="l01951"></a><span class="lineno"> 1951</span>      rgl = rgltbl(vegtyp)</div>
<div class="line"><a id="l01952" name="l01952"></a><span class="lineno"> 1952</span>      hs  = hstbl(vegtyp)</div>
<div class="line"><a id="l01953" name="l01953"></a><span class="lineno"> 1953</span><span class="comment">! roughness lengthe is defined in sfcsub</span></div>
<div class="line"><a id="l01954" name="l01954"></a><span class="lineno"> 1954</span><span class="comment">!     z0  = z0_data(vegtyp)</span></div>
<div class="line"><a id="l01955" name="l01955"></a><span class="lineno"> 1955</span>      xlai= lai_data(vegtyp)</div>
<div class="line"><a id="l01956" name="l01956"></a><span class="lineno"> 1956</span> </div>
<div class="line"><a id="l01957" name="l01957"></a><span class="lineno"> 1957</span>      <span class="keywordflow">if</span> (vegtyp == bare) shdfac = 0.0</div>
<div class="line"><a id="l01958" name="l01958"></a><span class="lineno"> 1958</span> </div>
<div class="line"><a id="l01959" name="l01959"></a><span class="lineno"> 1959</span>      <span class="keywordflow">if</span> (nroot &gt; nsoil) <span class="keywordflow">then</span></div>
<div class="line"><a id="l01960" name="l01960"></a><span class="lineno"> 1960</span>        errflg = 1</div>
<div class="line"><a id="l01961" name="l01961"></a><span class="lineno"> 1961</span>        errmsg = <span class="stringliteral">&#39;ERROR(sflx.f): too many root layers&#39;</span></div>
<div class="line"><a id="l01962" name="l01962"></a><span class="lineno"> 1962</span>        <span class="keywordflow">return</span></div>
<div class="line"><a id="l01963" name="l01963"></a><span class="lineno"> 1963</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l01964" name="l01964"></a><span class="lineno"> 1964</span> </div>
<div class="line"><a id="l01965" name="l01965"></a><span class="lineno"> 1965</span><span class="comment">!  --- ...  calculate root distribution.  present version assumes uniform</span></div>
<div class="line"><a id="l01966" name="l01966"></a><span class="lineno"> 1966</span><span class="comment">!           distribution based on soil layer depths.</span></div>
<div class="line"><a id="l01967" name="l01967"></a><span class="lineno"> 1967</span> </div>
<div class="line"><a id="l01968" name="l01968"></a><span class="lineno"> 1968</span>      <span class="keywordflow">do</span> i = 1, nroot</div>
<div class="line"><a id="l01969" name="l01969"></a><span class="lineno"> 1969</span>        rtdis(i) = -sldpth(i) / zsoil(nroot)</div>
<div class="line"><a id="l01970" name="l01970"></a><span class="lineno"> 1970</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l01971" name="l01971"></a><span class="lineno"> 1971</span> </div>
<div class="line"><a id="l01972" name="l01972"></a><span class="lineno"> 1972</span><span class="comment">!  --- ...  set-up slope parameter</span></div>
<div class="line"><a id="l01973" name="l01973"></a><span class="lineno"> 1973</span> </div>
<div class="line"><a id="l01974" name="l01974"></a><span class="lineno"> 1974</span>      slope = slope_data(slopetyp)</div>
<div class="line"><a id="l01975" name="l01975"></a><span class="lineno"> 1975</span><span class="comment">!</span></div>
<div class="line"><a id="l01976" name="l01976"></a><span class="lineno"> 1976</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l01977" name="l01977"></a><span class="lineno"> 1977</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga1c19b4bae5de2a391c019b6778a58dad.html#ga1c19b4bae5de2a391c019b6778a58dad">redprm</a></div>
<div class="line"><a id="l01978" name="l01978"></a><span class="lineno"> 1978</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l01979" name="l01979"></a><span class="lineno"> 1979</span> </div>
<div class="line"><a id="l01980" name="l01980"></a><span class="lineno"> 1980</span> </div>
<div class="line"><a id="l01981" name="l01981"></a><span class="lineno"> 1981</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l01982" name="l01982"></a><span class="lineno"> 1982</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l01983" name="l01983"></a><span class="lineno"> 1983</span><span class="comment">!&gt; This subroutine calculates surface layer exchange coefficients</span></div>
<div class="line"><a id="l01984" name="l01984"></a><span class="lineno"> 1984</span><span class="comment">!! via iterative process(see Chen et al.(1997) \cite chen_et_al_1997).</span></div>
<div class="foldopen" id="foldopen01985" data-start="" data-end="">
<div class="line"><a id="l01985" name="l01985"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gafdc2dc9815673befca7228be47616e41.html#gafdc2dc9815673befca7228be47616e41"> 1985</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gafdc2dc9815673befca7228be47616e41.html#gafdc2dc9815673befca7228be47616e41">sfcdif</a></div>
<div class="line"><a id="l01986" name="l01986"></a><span class="lineno"> 1986</span><span class="comment">!...................................</span></div>
<div class="line"><a id="l01987" name="l01987"></a><span class="lineno"> 1987</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l01988" name="l01988"></a><span class="lineno"> 1988</span><span class="comment">!    &amp;     ( zlvl, z0, t1v, th2v, sfcspd, czil,                         &amp;</span></div>
<div class="line"><a id="l01989" name="l01989"></a><span class="lineno"> 1989</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l01990" name="l01990"></a><span class="lineno"> 1990</span><span class="comment">!    &amp;       cm, ch                                                     &amp;</span></div>
<div class="line"><a id="l01991" name="l01991"></a><span class="lineno"> 1991</span><span class="comment">!    &amp;     )</span></div>
<div class="line"><a id="l01992" name="l01992"></a><span class="lineno"> 1992</span> </div>
<div class="line"><a id="l01993" name="l01993"></a><span class="lineno"> 1993</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l01994" name="l01994"></a><span class="lineno"> 1994</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l01995" name="l01995"></a><span class="lineno"> 1995</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01996" name="l01996"></a><span class="lineno"> 1996</span><span class="comment">!  subroutine sfcdif calculates surface layer exchange coefficients     !</span></div>
<div class="line"><a id="l01997" name="l01997"></a><span class="lineno"> 1997</span><span class="comment">!  via iterative process. see chen et al (1997, blm)                    !</span></div>
<div class="line"><a id="l01998" name="l01998"></a><span class="lineno"> 1998</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l01999" name="l01999"></a><span class="lineno"> 1999</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l02000" name="l02000"></a><span class="lineno"> 2000</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02001" name="l02001"></a><span class="lineno"> 2001</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02002" name="l02002"></a><span class="lineno"> 2002</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l02003" name="l02003"></a><span class="lineno"> 2003</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02004" name="l02004"></a><span class="lineno"> 2004</span><span class="comment">!  inputs from the calling program:                              size   !</span></div>
<div class="line"><a id="l02005" name="l02005"></a><span class="lineno"> 2005</span><span class="comment">!     zlvl     - real, height abv atmos ground forcing vars (m)    1    !</span></div>
<div class="line"><a id="l02006" name="l02006"></a><span class="lineno"> 2006</span><span class="comment">!     z0       - real, roughness length (m)                        1    !</span></div>
<div class="line"><a id="l02007" name="l02007"></a><span class="lineno"> 2007</span><span class="comment">!     t1v      - real, surface exchange coefficient                1    !</span></div>
<div class="line"><a id="l02008" name="l02008"></a><span class="lineno"> 2008</span><span class="comment">!     th2v     - real, surface exchange coefficient                1    !</span></div>
<div class="line"><a id="l02009" name="l02009"></a><span class="lineno"> 2009</span><span class="comment">!     sfcspd   - real, wind speed at height zlvl abv ground (m/s)  1    !</span></div>
<div class="line"><a id="l02010" name="l02010"></a><span class="lineno"> 2010</span><span class="comment">!     czil     - real, param to cal roughness length of heat       1    !</span></div>
<div class="line"><a id="l02011" name="l02011"></a><span class="lineno"> 2011</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02012" name="l02012"></a><span class="lineno"> 2012</span><span class="comment">!  input/outputs from and to the calling program:                       !</span></div>
<div class="line"><a id="l02013" name="l02013"></a><span class="lineno"> 2013</span><span class="comment">!     cm       - real, sfc exchange coeff for momentum (m/s)       1    !</span></div>
<div class="line"><a id="l02014" name="l02014"></a><span class="lineno"> 2014</span><span class="comment">!     ch       - real, sfc exchange coeff for heat &amp; moisture (m/s)1    !</span></div>
<div class="line"><a id="l02015" name="l02015"></a><span class="lineno"> 2015</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02016" name="l02016"></a><span class="lineno"> 2016</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l02017" name="l02017"></a><span class="lineno"> 2017</span><span class="comment">!</span></div>
<div class="line"><a id="l02018" name="l02018"></a><span class="lineno"> 2018</span><span class="comment">!  --- constant parameters:</span></div>
<div class="line"><a id="l02019" name="l02019"></a><span class="lineno"> 2019</span>      <span class="keywordtype">integer</span>,               <span class="keywordtype">parameter</span> :: itrmx  = 5</div>
<div class="line"><a id="l02020" name="l02020"></a><span class="lineno"> 2020</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: wwst   = 1.2</div>
<div class="line"><a id="l02021" name="l02021"></a><span class="lineno"> 2021</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: wwst2  = wwst*wwst</div>
<div class="line"><a id="l02022" name="l02022"></a><span class="lineno"> 2022</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: vkrm   = 0.40</div>
<div class="line"><a id="l02023" name="l02023"></a><span class="lineno"> 2023</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: excm   = 0.001</div>
<div class="line"><a id="l02024" name="l02024"></a><span class="lineno"> 2024</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: beta   = 1.0/270.0</div>
<div class="line"><a id="l02025" name="l02025"></a><span class="lineno"> 2025</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: btg    = beta*gs1</div>
<div class="line"><a id="l02026" name="l02026"></a><span class="lineno"> 2026</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: elfc   = vkrm*btg</div>
<div class="line"><a id="l02027" name="l02027"></a><span class="lineno"> 2027</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: wold   = 0.15</div>
<div class="line"><a id="l02028" name="l02028"></a><span class="lineno"> 2028</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: wnew   = 1.0-wold</div>
<div class="line"><a id="l02029" name="l02029"></a><span class="lineno"> 2029</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: pihf   = 3.14159265/2.0  <span class="comment">! con_pi/2.0</span></div>
<div class="line"><a id="l02030" name="l02030"></a><span class="lineno"> 2030</span> </div>
<div class="line"><a id="l02031" name="l02031"></a><span class="lineno"> 2031</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: epsu2  = 1.e-4</div>
<div class="line"><a id="l02032" name="l02032"></a><span class="lineno"> 2032</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: epsust = 0.07</div>
<div class="line"><a id="l02033" name="l02033"></a><span class="lineno"> 2033</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: ztmin  = -5.0</div>
<div class="line"><a id="l02034" name="l02034"></a><span class="lineno"> 2034</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: ztmax  = 1.0</div>
<div class="line"><a id="l02035" name="l02035"></a><span class="lineno"> 2035</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: hpbl   = 1000.0</div>
<div class="line"><a id="l02036" name="l02036"></a><span class="lineno"> 2036</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: sqvisc = 258.2</div>
<div class="line"><a id="l02037" name="l02037"></a><span class="lineno"> 2037</span> </div>
<div class="line"><a id="l02038" name="l02038"></a><span class="lineno"> 2038</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: ric    = 0.183</div>
<div class="line"><a id="l02039" name="l02039"></a><span class="lineno"> 2039</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: rric   = 1.0/ric</div>
<div class="line"><a id="l02040" name="l02040"></a><span class="lineno"> 2040</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: fhneu  = 0.8</div>
<div class="line"><a id="l02041" name="l02041"></a><span class="lineno"> 2041</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: rfc    = 0.191</div>
<div class="line"><a id="l02042" name="l02042"></a><span class="lineno"> 2042</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: rfac   = ric/(fhneu*rfc*rfc)</div>
<div class="line"><a id="l02043" name="l02043"></a><span class="lineno"> 2043</span> </div>
<div class="line"><a id="l02044" name="l02044"></a><span class="lineno"> 2044</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02045" name="l02045"></a><span class="lineno"> 2045</span><span class="comment">!     real (kind=kind_phys),  intent(in) :: zlvl, z0, t1v, th2v,        &amp;</span></div>
<div class="line"><a id="l02046" name="l02046"></a><span class="lineno"> 2046</span><span class="comment">!    &amp;       sfcspd, czil</span></div>
<div class="line"><a id="l02047" name="l02047"></a><span class="lineno"> 2047</span> </div>
<div class="line"><a id="l02048" name="l02048"></a><span class="lineno"> 2048</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02049" name="l02049"></a><span class="lineno"> 2049</span><span class="comment">!     real (kind=kind_phys),  intent(inout) :: cm, ch</span></div>
<div class="line"><a id="l02050" name="l02050"></a><span class="lineno"> 2050</span> </div>
<div class="line"><a id="l02051" name="l02051"></a><span class="lineno"> 2051</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l02052" name="l02052"></a><span class="lineno"> 2052</span><span class="keywordtype">      real</span> (kind=kind_phys) :: zilfc, zu, zt, rdz, cxch, dthv, du2,     &amp;</div>
<div class="line"><a id="l02053" name="l02053"></a><span class="lineno"> 2053</span>     &amp;       btgh, wstar2, ustar, zslu, zslt, rlogu, rlogt, rlmo,       &amp;</div>
<div class="line"><a id="l02054" name="l02054"></a><span class="lineno"> 2054</span>     &amp;       zetalt, zetalu, zetau, zetat, xlu4, xlt4, xu4, xt4,        &amp;</div>
<div class="line"><a id="l02055" name="l02055"></a><span class="lineno"> 2055</span>     &amp;       xlu, xlt, xu, xt, psmz, simm, pshz, simh, ustark,          &amp;</div>
<div class="line"><a id="l02056" name="l02056"></a><span class="lineno"> 2056</span>     &amp;       rlmn, rlma</div>
<div class="line"><a id="l02057" name="l02057"></a><span class="lineno"> 2057</span> </div>
<div class="line"><a id="l02058" name="l02058"></a><span class="lineno"> 2058</span>      <span class="keywordtype">integer</span> :: ilech, itr</div>
<div class="line"><a id="l02059" name="l02059"></a><span class="lineno"> 2059</span> </div>
<div class="line"><a id="l02060" name="l02060"></a><span class="lineno"> 2060</span><span class="comment">!  ---  define local in-line functions:</span></div>
<div class="line"><a id="l02061" name="l02061"></a><span class="lineno"> 2061</span> </div>
<div class="line"><a id="l02062" name="l02062"></a><span class="lineno"> 2062</span><span class="keywordtype">      real</span> (kind=kind_phys) :: pslmu, pslms, pslhu, pslhs, zz</div>
<div class="line"><a id="l02063" name="l02063"></a><span class="lineno"> 2063</span><span class="keywordtype">      real</span> (kind=kind_phys) :: pspmu, pspms, psphu, psphs, xx, yy</div>
<div class="line"><a id="l02064" name="l02064"></a><span class="lineno"> 2064</span> </div>
<div class="line"><a id="l02065" name="l02065"></a><span class="lineno"> 2065</span><span class="comment">!  ...  1) lech&#39;s surface functions</span></div>
<div class="line"><a id="l02066" name="l02066"></a><span class="lineno"> 2066</span> </div>
<div class="line"><a id="l02067" name="l02067"></a><span class="lineno"> 2067</span>      pslmu( zz ) = -0.96 * log( 1.0-4.5*zz )</div>
<div class="line"><a id="l02068" name="l02068"></a><span class="lineno"> 2068</span>      pslms( zz ) = zz*rric - 2.076*(1.0 - 1.0/(zz + 1.0))</div>
<div class="line"><a id="l02069" name="l02069"></a><span class="lineno"> 2069</span>      pslhu( zz ) = -0.96 * log( 1.0-4.5*zz )</div>
<div class="line"><a id="l02070" name="l02070"></a><span class="lineno"> 2070</span>      pslhs( zz ) = zz*rfac - 2.076*(1.0 - 1.0/(zz + 1.0))</div>
<div class="line"><a id="l02071" name="l02071"></a><span class="lineno"> 2071</span> </div>
<div class="line"><a id="l02072" name="l02072"></a><span class="lineno"> 2072</span><span class="comment">!  ...  2) paulson&#39;s surface functions</span></div>
<div class="line"><a id="l02073" name="l02073"></a><span class="lineno"> 2073</span> </div>
<div class="line"><a id="l02074" name="l02074"></a><span class="lineno"> 2074</span>      pspmu( xx ) = -2.0 * log( (xx + 1.0)*0.5 )                        &amp;</div>
<div class="line"><a id="l02075" name="l02075"></a><span class="lineno"> 2075</span>     &amp;            - log( (xx*xx + 1.0)*0.5 ) + 2.0*atan(xx) - pihf</div>
<div class="line"><a id="l02076" name="l02076"></a><span class="lineno"> 2076</span>      pspms( yy ) = 5.0 * yy</div>
<div class="line"><a id="l02077" name="l02077"></a><span class="lineno"> 2077</span>      psphu( xx ) = -2.0 * log( (xx*xx + 1.0)*0.5 )</div>
<div class="line"><a id="l02078" name="l02078"></a><span class="lineno"> 2078</span>      psphs( yy ) = 5.0 * yy</div>
<div class="line"><a id="l02079" name="l02079"></a><span class="lineno"> 2079</span> </div>
<div class="line"><a id="l02080" name="l02080"></a><span class="lineno"> 2080</span><span class="comment">!</span></div>
<div class="line"><a id="l02081" name="l02081"></a><span class="lineno"> 2081</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l02082" name="l02082"></a><span class="lineno"> 2082</span><span class="comment">!</span></div>
<div class="line"><a id="l02083" name="l02083"></a><span class="lineno"> 2083</span><span class="comment">!  --- ...  this routine sfcdif can handle both over open water (sea, ocean) and</span></div>
<div class="line"><a id="l02084" name="l02084"></a><span class="lineno"> 2084</span><span class="comment">!           over solid surface (land, sea-ice).</span></div>
<div class="line"><a id="l02085" name="l02085"></a><span class="lineno"> 2085</span> </div>
<div class="line"><a id="l02086" name="l02086"></a><span class="lineno"> 2086</span>      ilech = 0</div>
<div class="line"><a id="l02087" name="l02087"></a><span class="lineno"> 2087</span> </div>
<div class="line"><a id="l02088" name="l02088"></a><span class="lineno"> 2088</span><span class="comment">!   --- ...  ztfc: ratio of zoh/zom  less or equal than 1</span></div>
<div class="line"><a id="l02089" name="l02089"></a><span class="lineno"> 2089</span><span class="comment">!            czil: constant c in zilitinkevich, s. s.1995,:note about zt</span></div>
<div class="line"><a id="l02090" name="l02090"></a><span class="lineno"> 2090</span> </div>
<div class="line"><a id="l02091" name="l02091"></a><span class="lineno"> 2091</span>      zilfc = -czil * vkrm * sqvisc</div>
<div class="line"><a id="l02092" name="l02092"></a><span class="lineno"> 2092</span> </div>
<div class="line"><a id="l02093" name="l02093"></a><span class="lineno"> 2093</span>      zu = z0</div>
<div class="line"><a id="l02094" name="l02094"></a><span class="lineno"> 2094</span> </div>
<div class="line"><a id="l02095" name="l02095"></a><span class="lineno"> 2095</span>      rdz = 1.0 / zlvl</div>
<div class="line"><a id="l02096" name="l02096"></a><span class="lineno"> 2096</span>      cxch = excm * rdz</div>
<div class="line"><a id="l02097" name="l02097"></a><span class="lineno"> 2097</span>      dthv = th2v - t1v</div>
<div class="line"><a id="l02098" name="l02098"></a><span class="lineno"> 2098</span>      du2 = max( sfcspd*sfcspd, epsu2 )</div>
<div class="line"><a id="l02099" name="l02099"></a><span class="lineno"> 2099</span> </div>
<div class="line"><a id="l02100" name="l02100"></a><span class="lineno"> 2100</span><span class="comment">!  --- ...  beljars correction of ustar</span></div>
<div class="line"><a id="l02101" name="l02101"></a><span class="lineno"> 2101</span> </div>
<div class="line"><a id="l02102" name="l02102"></a><span class="lineno"> 2102</span>      btgh = btg * hpbl</div>
<div class="line"><a id="l02103" name="l02103"></a><span class="lineno"> 2103</span> </div>
<div class="line"><a id="l02104" name="l02104"></a><span class="lineno"> 2104</span><span class="comment">!  --- ...  if statements to avoid tangent linear problems near zero</span></div>
<div class="line"><a id="l02105" name="l02105"></a><span class="lineno"> 2105</span>      <span class="keywordflow">if</span> (btgh*ch*dthv /= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02106" name="l02106"></a><span class="lineno"> 2106</span>        wstar2 = wwst2 * abs( btgh*ch*dthv )**(2.0/3.0)</div>
<div class="line"><a id="l02107" name="l02107"></a><span class="lineno"> 2107</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l02108" name="l02108"></a><span class="lineno"> 2108</span>        wstar2 = 0.0</div>
<div class="line"><a id="l02109" name="l02109"></a><span class="lineno"> 2109</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l02110" name="l02110"></a><span class="lineno"> 2110</span> </div>
<div class="line"><a id="l02111" name="l02111"></a><span class="lineno"> 2111</span>      ustar = max( sqrt( cm*sqrt( du2+wstar2 ) ), epsust )</div>
<div class="line"><a id="l02112" name="l02112"></a><span class="lineno"> 2112</span> </div>
<div class="line"><a id="l02113" name="l02113"></a><span class="lineno"> 2113</span><span class="comment">!  --- ...  zilitinkevitch approach for zt</span></div>
<div class="line"><a id="l02114" name="l02114"></a><span class="lineno"> 2114</span> </div>
<div class="line"><a id="l02115" name="l02115"></a><span class="lineno"> 2115</span>      zt = exp( zilfc*sqrt( ustar*z0 ) ) * z0</div>
<div class="line"><a id="l02116" name="l02116"></a><span class="lineno"> 2116</span> </div>
<div class="line"><a id="l02117" name="l02117"></a><span class="lineno"> 2117</span>      zslu = zlvl + zu</div>
<div class="line"><a id="l02118" name="l02118"></a><span class="lineno"> 2118</span>      zslt = zlvl + zt</div>
<div class="line"><a id="l02119" name="l02119"></a><span class="lineno"> 2119</span> </div>
<div class="line"><a id="l02120" name="l02120"></a><span class="lineno"> 2120</span><span class="comment">!     print*,&#39;zslt=&#39;,zslt</span></div>
<div class="line"><a id="l02121" name="l02121"></a><span class="lineno"> 2121</span><span class="comment">!     print*,&#39;zlvl=&#39;,zvll</span></div>
<div class="line"><a id="l02122" name="l02122"></a><span class="lineno"> 2122</span><span class="comment">!     print*,&#39;zt=&#39;,zt</span></div>
<div class="line"><a id="l02123" name="l02123"></a><span class="lineno"> 2123</span> </div>
<div class="line"><a id="l02124" name="l02124"></a><span class="lineno"> 2124</span>      rlogu = log( zslu/zu )</div>
<div class="line"><a id="l02125" name="l02125"></a><span class="lineno"> 2125</span>      rlogt = log( zslt/zt )</div>
<div class="line"><a id="l02126" name="l02126"></a><span class="lineno"> 2126</span> </div>
<div class="line"><a id="l02127" name="l02127"></a><span class="lineno"> 2127</span>      rlmo = elfc*ch*dthv / ustar**3</div>
<div class="line"><a id="l02128" name="l02128"></a><span class="lineno"> 2128</span> </div>
<div class="line"><a id="l02129" name="l02129"></a><span class="lineno"> 2129</span><span class="comment">!     print*,&#39;rlmo=&#39;,rlmo</span></div>
<div class="line"><a id="l02130" name="l02130"></a><span class="lineno"> 2130</span><span class="comment">!     print*,&#39;elfc=&#39;,elfc</span></div>
<div class="line"><a id="l02131" name="l02131"></a><span class="lineno"> 2131</span><span class="comment">!     print*,&#39;ch=&#39;,ch</span></div>
<div class="line"><a id="l02132" name="l02132"></a><span class="lineno"> 2132</span><span class="comment">!     print*,&#39;dthv=&#39;,dthv</span></div>
<div class="line"><a id="l02133" name="l02133"></a><span class="lineno"> 2133</span><span class="comment">!     print*,&#39;ustar=&#39;,ustar</span></div>
<div class="line"><a id="l02134" name="l02134"></a><span class="lineno"> 2134</span> </div>
<div class="line"><a id="l02135" name="l02135"></a><span class="lineno"> 2135</span>      <span class="keywordflow">do</span> itr = 1, itrmx</div>
<div class="line"><a id="l02136" name="l02136"></a><span class="lineno"> 2136</span> </div>
<div class="line"><a id="l02137" name="l02137"></a><span class="lineno"> 2137</span><span class="comment">!  --- ...  1./ monin-obukkhov length-scale</span></div>
<div class="line"><a id="l02138" name="l02138"></a><span class="lineno"> 2138</span> </div>
<div class="line"><a id="l02139" name="l02139"></a><span class="lineno"> 2139</span>        zetalt = max( zslt*rlmo, ztmin )</div>
<div class="line"><a id="l02140" name="l02140"></a><span class="lineno"> 2140</span>        rlmo   = zetalt / zslt</div>
<div class="line"><a id="l02141" name="l02141"></a><span class="lineno"> 2141</span>        zetalu = zslu * rlmo</div>
<div class="line"><a id="l02142" name="l02142"></a><span class="lineno"> 2142</span>        zetau  = zu * rlmo</div>
<div class="line"><a id="l02143" name="l02143"></a><span class="lineno"> 2143</span>        zetat  = zt * rlmo</div>
<div class="line"><a id="l02144" name="l02144"></a><span class="lineno"> 2144</span> </div>
<div class="line"><a id="l02145" name="l02145"></a><span class="lineno"> 2145</span>        <span class="keywordflow">if</span> (ilech == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02146" name="l02146"></a><span class="lineno"> 2146</span> </div>
<div class="line"><a id="l02147" name="l02147"></a><span class="lineno"> 2147</span>          <span class="keywordflow">if</span> (rlmo &lt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02148" name="l02148"></a><span class="lineno"> 2148</span>            xlu4 = 1.0 - 16.0 * zetalu</div>
<div class="line"><a id="l02149" name="l02149"></a><span class="lineno"> 2149</span>            xlt4 = 1.0 - 16.0 * zetalt</div>
<div class="line"><a id="l02150" name="l02150"></a><span class="lineno"> 2150</span>            xu4  = 1.0 - 16.0 * zetau</div>
<div class="line"><a id="l02151" name="l02151"></a><span class="lineno"> 2151</span>            xt4  = 1.0 - 16.0* zetat</div>
<div class="line"><a id="l02152" name="l02152"></a><span class="lineno"> 2152</span> </div>
<div class="line"><a id="l02153" name="l02153"></a><span class="lineno"> 2153</span>            xlu = sqrt( sqrt( xlu4 ) )</div>
<div class="line"><a id="l02154" name="l02154"></a><span class="lineno"> 2154</span>            xlt = sqrt( sqrt( xlt4 ) )</div>
<div class="line"><a id="l02155" name="l02155"></a><span class="lineno"> 2155</span>            xu  = sqrt( sqrt( xu4  ) )</div>
<div class="line"><a id="l02156" name="l02156"></a><span class="lineno"> 2156</span>            xt  = sqrt( sqrt( xt4  ) )</div>
<div class="line"><a id="l02157" name="l02157"></a><span class="lineno"> 2157</span> </div>
<div class="line"><a id="l02158" name="l02158"></a><span class="lineno"> 2158</span>            psmz = pspmu(xu)</div>
<div class="line"><a id="l02159" name="l02159"></a><span class="lineno"> 2159</span> </div>
<div class="line"><a id="l02160" name="l02160"></a><span class="lineno"> 2160</span><span class="comment">!           print*,&#39;-----------1------------&#39;</span></div>
<div class="line"><a id="l02161" name="l02161"></a><span class="lineno"> 2161</span><span class="comment">!           print*,&#39;psmz=&#39;,psmz</span></div>
<div class="line"><a id="l02162" name="l02162"></a><span class="lineno"> 2162</span><span class="comment">!           print*,&#39;pspmu(zetau)=&#39;,pspmu( zetau )</span></div>
<div class="line"><a id="l02163" name="l02163"></a><span class="lineno"> 2163</span><span class="comment">!           print*,&#39;xu=&#39;,xu</span></div>
<div class="line"><a id="l02164" name="l02164"></a><span class="lineno"> 2164</span><span class="comment">!           print*,&#39;------------------------&#39;</span></div>
<div class="line"><a id="l02165" name="l02165"></a><span class="lineno"> 2165</span> </div>
<div class="line"><a id="l02166" name="l02166"></a><span class="lineno"> 2166</span>            simm = pspmu( xlu ) - psmz + rlogu</div>
<div class="line"><a id="l02167" name="l02167"></a><span class="lineno"> 2167</span>            pshz = psphu( xt  )</div>
<div class="line"><a id="l02168" name="l02168"></a><span class="lineno"> 2168</span>            simh = psphu( xlt ) - pshz + rlogt</div>
<div class="line"><a id="l02169" name="l02169"></a><span class="lineno"> 2169</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l02170" name="l02170"></a><span class="lineno"> 2170</span>            zetalu = min( zetalu, ztmax )</div>
<div class="line"><a id="l02171" name="l02171"></a><span class="lineno"> 2171</span>            zetalt = min( zetalt, ztmax )</div>
<div class="line"><a id="l02172" name="l02172"></a><span class="lineno"> 2172</span>            psmz = pspms( zetau )</div>
<div class="line"><a id="l02173" name="l02173"></a><span class="lineno"> 2173</span> </div>
<div class="line"><a id="l02174" name="l02174"></a><span class="lineno"> 2174</span><span class="comment">!           print*,&#39;-----------2------------&#39;</span></div>
<div class="line"><a id="l02175" name="l02175"></a><span class="lineno"> 2175</span><span class="comment">!           print*,&#39;psmz=&#39;,psmz</span></div>
<div class="line"><a id="l02176" name="l02176"></a><span class="lineno"> 2176</span><span class="comment">!           print*,&#39;pspms(zetau)=&#39;,pspms( zetau )</span></div>
<div class="line"><a id="l02177" name="l02177"></a><span class="lineno"> 2177</span><span class="comment">!           print*,&#39;zetau=&#39;,zetau</span></div>
<div class="line"><a id="l02178" name="l02178"></a><span class="lineno"> 2178</span><span class="comment">!           print*,&#39;------------------------&#39;</span></div>
<div class="line"><a id="l02179" name="l02179"></a><span class="lineno"> 2179</span> </div>
<div class="line"><a id="l02180" name="l02180"></a><span class="lineno"> 2180</span>            simm = pspms( zetalu ) - psmz + rlogu</div>
<div class="line"><a id="l02181" name="l02181"></a><span class="lineno"> 2181</span>            pshz = psphs( zetat  )</div>
<div class="line"><a id="l02182" name="l02182"></a><span class="lineno"> 2182</span>            simh = psphs( zetalt ) - pshz + rlogt</div>
<div class="line"><a id="l02183" name="l02183"></a><span class="lineno"> 2183</span><span class="keywordflow">          endif</span>   <span class="comment">! end if_rlmo_block</span></div>
<div class="line"><a id="l02184" name="l02184"></a><span class="lineno"> 2184</span> </div>
<div class="line"><a id="l02185" name="l02185"></a><span class="lineno"> 2185</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l02186" name="l02186"></a><span class="lineno"> 2186</span> </div>
<div class="line"><a id="l02187" name="l02187"></a><span class="lineno"> 2187</span><span class="comment">!  --- ...  lech&#39;s functions</span></div>
<div class="line"><a id="l02188" name="l02188"></a><span class="lineno"> 2188</span> </div>
<div class="line"><a id="l02189" name="l02189"></a><span class="lineno"> 2189</span>          <span class="keywordflow">if</span> (rlmo &lt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02190" name="l02190"></a><span class="lineno"> 2190</span>            psmz = pslmu( zetau )</div>
<div class="line"><a id="l02191" name="l02191"></a><span class="lineno"> 2191</span> </div>
<div class="line"><a id="l02192" name="l02192"></a><span class="lineno"> 2192</span><span class="comment">!           print*,&#39;-----------3------------&#39;</span></div>
<div class="line"><a id="l02193" name="l02193"></a><span class="lineno"> 2193</span><span class="comment">!           print*,&#39;psmz=&#39;,psmz</span></div>
<div class="line"><a id="l02194" name="l02194"></a><span class="lineno"> 2194</span><span class="comment">!           print*,&#39;pslmu(zetau)=&#39;,pslmu( zetau )</span></div>
<div class="line"><a id="l02195" name="l02195"></a><span class="lineno"> 2195</span><span class="comment">!           print*,&#39;zetau=&#39;,zetau</span></div>
<div class="line"><a id="l02196" name="l02196"></a><span class="lineno"> 2196</span><span class="comment">!           print*,&#39;------------------------&#39;</span></div>
<div class="line"><a id="l02197" name="l02197"></a><span class="lineno"> 2197</span> </div>
<div class="line"><a id="l02198" name="l02198"></a><span class="lineno"> 2198</span>            simm = pslmu( zetalu ) - psmz + rlogu</div>
<div class="line"><a id="l02199" name="l02199"></a><span class="lineno"> 2199</span>            pshz = pslhu( zetat  )</div>
<div class="line"><a id="l02200" name="l02200"></a><span class="lineno"> 2200</span>            simh = pslhu( zetalt ) - pshz + rlogt</div>
<div class="line"><a id="l02201" name="l02201"></a><span class="lineno"> 2201</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l02202" name="l02202"></a><span class="lineno"> 2202</span>            zetalu = min( zetalu, ztmax )</div>
<div class="line"><a id="l02203" name="l02203"></a><span class="lineno"> 2203</span>            zetalt = min( zetalt, ztmax )</div>
<div class="line"><a id="l02204" name="l02204"></a><span class="lineno"> 2204</span> </div>
<div class="line"><a id="l02205" name="l02205"></a><span class="lineno"> 2205</span>            psmz = pslms( zetau  )</div>
<div class="line"><a id="l02206" name="l02206"></a><span class="lineno"> 2206</span> </div>
<div class="line"><a id="l02207" name="l02207"></a><span class="lineno"> 2207</span><span class="comment">!           print*,&#39;-----------4------------&#39;</span></div>
<div class="line"><a id="l02208" name="l02208"></a><span class="lineno"> 2208</span><span class="comment">!           print*,&#39;psmz=&#39;,psmz</span></div>
<div class="line"><a id="l02209" name="l02209"></a><span class="lineno"> 2209</span><span class="comment">!           print*,&#39;pslms(zetau)=&#39;,pslms( zetau )</span></div>
<div class="line"><a id="l02210" name="l02210"></a><span class="lineno"> 2210</span><span class="comment">!           print*,&#39;zetau=&#39;,zetau</span></div>
<div class="line"><a id="l02211" name="l02211"></a><span class="lineno"> 2211</span><span class="comment">!           print*,&#39;------------------------&#39;</span></div>
<div class="line"><a id="l02212" name="l02212"></a><span class="lineno"> 2212</span> </div>
<div class="line"><a id="l02213" name="l02213"></a><span class="lineno"> 2213</span>            simm = pslms( zetalu ) - psmz + rlogu</div>
<div class="line"><a id="l02214" name="l02214"></a><span class="lineno"> 2214</span>            pshz = pslhs( zetat  )</div>
<div class="line"><a id="l02215" name="l02215"></a><span class="lineno"> 2215</span>            simh = pslhs( zetalt ) - pshz + rlogt</div>
<div class="line"><a id="l02216" name="l02216"></a><span class="lineno"> 2216</span><span class="keywordflow">          endif</span>   <span class="comment">! end if_rlmo_block</span></div>
<div class="line"><a id="l02217" name="l02217"></a><span class="lineno"> 2217</span> </div>
<div class="line"><a id="l02218" name="l02218"></a><span class="lineno"> 2218</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_ilech_block</span></div>
<div class="line"><a id="l02219" name="l02219"></a><span class="lineno"> 2219</span> </div>
<div class="line"><a id="l02220" name="l02220"></a><span class="lineno"> 2220</span><span class="comment">!  --- ...  beljaars correction for ustar</span></div>
<div class="line"><a id="l02221" name="l02221"></a><span class="lineno"> 2221</span> </div>
<div class="line"><a id="l02222" name="l02222"></a><span class="lineno"> 2222</span>        ustar = max( sqrt( cm*sqrt( du2+wstar2 ) ), epsust )</div>
<div class="line"><a id="l02223" name="l02223"></a><span class="lineno"> 2223</span> </div>
<div class="line"><a id="l02224" name="l02224"></a><span class="lineno"> 2224</span><span class="comment">!  --- ...  zilitinkevitch fix for zt</span></div>
<div class="line"><a id="l02225" name="l02225"></a><span class="lineno"> 2225</span> </div>
<div class="line"><a id="l02226" name="l02226"></a><span class="lineno"> 2226</span>        zt = exp( zilfc*sqrt( ustar*z0 ) ) * z0</div>
<div class="line"><a id="l02227" name="l02227"></a><span class="lineno"> 2227</span> </div>
<div class="line"><a id="l02228" name="l02228"></a><span class="lineno"> 2228</span>        zslt = zlvl + zt</div>
<div class="line"><a id="l02229" name="l02229"></a><span class="lineno"> 2229</span>        rlogt = log( zslt/zt )</div>
<div class="line"><a id="l02230" name="l02230"></a><span class="lineno"> 2230</span> </div>
<div class="line"><a id="l02231" name="l02231"></a><span class="lineno"> 2231</span>        ustark = ustar * vkrm</div>
<div class="line"><a id="l02232" name="l02232"></a><span class="lineno"> 2232</span>        cm = max( ustark/simm, cxch )</div>
<div class="line"><a id="l02233" name="l02233"></a><span class="lineno"> 2233</span>        ch = max( ustark/simh, cxch )</div>
<div class="line"><a id="l02234" name="l02234"></a><span class="lineno"> 2234</span> </div>
<div class="line"><a id="l02235" name="l02235"></a><span class="lineno"> 2235</span><span class="comment">!  --- ...  if statements to avoid tangent linear problems near zero</span></div>
<div class="line"><a id="l02236" name="l02236"></a><span class="lineno"> 2236</span> </div>
<div class="line"><a id="l02237" name="l02237"></a><span class="lineno"> 2237</span>        <span class="keywordflow">if</span> (btgh*ch*dthv /= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02238" name="l02238"></a><span class="lineno"> 2238</span>          wstar2 = wwst2 * abs(btgh*ch*dthv) ** (2.0/3.0)</div>
<div class="line"><a id="l02239" name="l02239"></a><span class="lineno"> 2239</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l02240" name="l02240"></a><span class="lineno"> 2240</span>          wstar2 = 0.0</div>
<div class="line"><a id="l02241" name="l02241"></a><span class="lineno"> 2241</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l02242" name="l02242"></a><span class="lineno"> 2242</span> </div>
<div class="line"><a id="l02243" name="l02243"></a><span class="lineno"> 2243</span>        rlmn = elfc*ch*dthv / ustar**3</div>
<div class="line"><a id="l02244" name="l02244"></a><span class="lineno"> 2244</span>        rlma = rlmo*wold + rlmn*wnew</div>
<div class="line"><a id="l02245" name="l02245"></a><span class="lineno"> 2245</span> </div>
<div class="line"><a id="l02246" name="l02246"></a><span class="lineno"> 2246</span>        rlmo = rlma</div>
<div class="line"><a id="l02247" name="l02247"></a><span class="lineno"> 2247</span> </div>
<div class="line"><a id="l02248" name="l02248"></a><span class="lineno"> 2248</span><span class="keywordflow">      enddo</span>   <span class="comment">! end do_itr_loop</span></div>
<div class="line"><a id="l02249" name="l02249"></a><span class="lineno"> 2249</span> </div>
<div class="line"><a id="l02250" name="l02250"></a><span class="lineno"> 2250</span><span class="comment">!     print*,&#39;----------------------------&#39;</span></div>
<div class="line"><a id="l02251" name="l02251"></a><span class="lineno"> 2251</span><span class="comment">!     print*,&#39;sfcdif output !  ! ! ! ! ! ! ! !  !   !    !&#39;</span></div>
<div class="line"><a id="l02252" name="l02252"></a><span class="lineno"> 2252</span><span class="comment">!</span></div>
<div class="line"><a id="l02253" name="l02253"></a><span class="lineno"> 2253</span><span class="comment">!     print*,&#39;zlvl=&#39;,zlvl</span></div>
<div class="line"><a id="l02254" name="l02254"></a><span class="lineno"> 2254</span><span class="comment">!     print*,&#39;z0=&#39;,z0</span></div>
<div class="line"><a id="l02255" name="l02255"></a><span class="lineno"> 2255</span><span class="comment">!     print*,&#39;t1v=&#39;,t1v</span></div>
<div class="line"><a id="l02256" name="l02256"></a><span class="lineno"> 2256</span><span class="comment">!     print*,&#39;th2v=&#39;,th2v</span></div>
<div class="line"><a id="l02257" name="l02257"></a><span class="lineno"> 2257</span><span class="comment">!     print*,&#39;sfcspd=&#39;,sfcspd</span></div>
<div class="line"><a id="l02258" name="l02258"></a><span class="lineno"> 2258</span><span class="comment">!     print*,&#39;czil=&#39;,czil</span></div>
<div class="line"><a id="l02259" name="l02259"></a><span class="lineno"> 2259</span><span class="comment">!     print*,&#39;cm=&#39;,cm</span></div>
<div class="line"><a id="l02260" name="l02260"></a><span class="lineno"> 2260</span><span class="comment">!     print*,&#39;ch=&#39;,ch</span></div>
<div class="line"><a id="l02261" name="l02261"></a><span class="lineno"> 2261</span><span class="comment">!     print*,&#39;----------------------------&#39;</span></div>
<div class="line"><a id="l02262" name="l02262"></a><span class="lineno"> 2262</span><span class="comment">!</span></div>
<div class="line"><a id="l02263" name="l02263"></a><span class="lineno"> 2263</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l02264" name="l02264"></a><span class="lineno"> 2264</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gafdc2dc9815673befca7228be47616e41.html#gafdc2dc9815673befca7228be47616e41">sfcdif</a></div>
<div class="line"><a id="l02265" name="l02265"></a><span class="lineno"> 2265</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l02266" name="l02266"></a><span class="lineno"> 2266</span> </div>
<div class="line"><a id="l02267" name="l02267"></a><span class="lineno"> 2267</span> </div>
<div class="line"><a id="l02268" name="l02268"></a><span class="lineno"> 2268</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l02269" name="l02269"></a><span class="lineno"> 2269</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l02270" name="l02270"></a><span class="lineno"> 2270</span><span class="comment">!&gt; This subroutine calculates snow fraction (0-&gt;1).</span></div>
<div class="foldopen" id="foldopen02271" data-start="" data-end="">
<div class="line"><a id="l02271" name="l02271"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gafca324f1a0f2bcca12116291bfc8ad68.html#gafca324f1a0f2bcca12116291bfc8ad68"> 2271</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gafca324f1a0f2bcca12116291bfc8ad68.html#gafca324f1a0f2bcca12116291bfc8ad68">snfrac</a></div>
<div class="line"><a id="l02272" name="l02272"></a><span class="lineno"> 2272</span><span class="comment">!...................................</span></div>
<div class="line"><a id="l02273" name="l02273"></a><span class="lineno"> 2273</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02274" name="l02274"></a><span class="lineno"> 2274</span><span class="comment">!    &amp;     ( sneqv, snup, salp, snowh,                                  &amp;</span></div>
<div class="line"><a id="l02275" name="l02275"></a><span class="lineno"> 2275</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l02276" name="l02276"></a><span class="lineno"> 2276</span><span class="comment">!    &amp;       sncovr                                                     &amp;</span></div>
<div class="line"><a id="l02277" name="l02277"></a><span class="lineno"> 2277</span><span class="comment">!    &amp;     )</span></div>
<div class="line"><a id="l02278" name="l02278"></a><span class="lineno"> 2278</span> </div>
<div class="line"><a id="l02279" name="l02279"></a><span class="lineno"> 2279</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l02280" name="l02280"></a><span class="lineno"> 2280</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l02281" name="l02281"></a><span class="lineno"> 2281</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02282" name="l02282"></a><span class="lineno"> 2282</span><span class="comment">!  subroutine snfrac calculatexsnow fraction (0 -&gt; 1)                   !</span></div>
<div class="line"><a id="l02283" name="l02283"></a><span class="lineno"> 2283</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02284" name="l02284"></a><span class="lineno"> 2284</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l02285" name="l02285"></a><span class="lineno"> 2285</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02286" name="l02286"></a><span class="lineno"> 2286</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02287" name="l02287"></a><span class="lineno"> 2287</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l02288" name="l02288"></a><span class="lineno"> 2288</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02289" name="l02289"></a><span class="lineno"> 2289</span><span class="comment">!  inputs from the calling program:                              size   !</span></div>
<div class="line"><a id="l02290" name="l02290"></a><span class="lineno"> 2290</span><span class="comment">!     sneqv    - real, snow water equivalent (m)                   1    !</span></div>
<div class="line"><a id="l02291" name="l02291"></a><span class="lineno"> 2291</span><span class="comment">!     snup     - real, threshold sneqv depth above which sncovr=1  1    !</span></div>
<div class="line"><a id="l02292" name="l02292"></a><span class="lineno"> 2292</span><span class="comment">!     salp     - real, tuning parameter                            1    !</span></div>
<div class="line"><a id="l02293" name="l02293"></a><span class="lineno"> 2293</span><span class="comment">!     snowh    - real, snow depth (m)                              1    !</span></div>
<div class="line"><a id="l02294" name="l02294"></a><span class="lineno"> 2294</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02295" name="l02295"></a><span class="lineno"> 2295</span><span class="comment">!  outputs to the calling program:                                      !</span></div>
<div class="line"><a id="l02296" name="l02296"></a><span class="lineno"> 2296</span><span class="comment">!     sncovr   - real, fractional snow cover                       1    !</span></div>
<div class="line"><a id="l02297" name="l02297"></a><span class="lineno"> 2297</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02298" name="l02298"></a><span class="lineno"> 2298</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l02299" name="l02299"></a><span class="lineno"> 2299</span><span class="comment">!</span></div>
<div class="line"><a id="l02300" name="l02300"></a><span class="lineno"> 2300</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02301" name="l02301"></a><span class="lineno"> 2301</span><span class="comment">!     real (kind=kind_phys),  intent(in) :: sneqv, snup, salp, snowh</span></div>
<div class="line"><a id="l02302" name="l02302"></a><span class="lineno"> 2302</span> </div>
<div class="line"><a id="l02303" name="l02303"></a><span class="lineno"> 2303</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l02304" name="l02304"></a><span class="lineno"> 2304</span><span class="comment">!     real (kind=kind_phys),  intent(out) :: sncovr</span></div>
<div class="line"><a id="l02305" name="l02305"></a><span class="lineno"> 2305</span> </div>
<div class="line"><a id="l02306" name="l02306"></a><span class="lineno"> 2306</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l02307" name="l02307"></a><span class="lineno"> 2307</span><span class="keywordtype">      real</span> (kind=kind_phys) :: rsnow, z0n</div>
<div class="line"><a id="l02308" name="l02308"></a><span class="lineno"> 2308</span> </div>
<div class="line"><a id="l02309" name="l02309"></a><span class="lineno"> 2309</span><span class="comment">!</span></div>
<div class="line"><a id="l02310" name="l02310"></a><span class="lineno"> 2310</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l02311" name="l02311"></a><span class="lineno"> 2311</span><span class="comment">!</span></div>
<div class="line"><a id="l02312" name="l02312"></a><span class="lineno"> 2312</span><span class="comment">!  --- ...  snup is veg-class dependent snowdepth threshhold (set in routine</span></div>
<div class="line"><a id="l02313" name="l02313"></a><span class="lineno"> 2313</span><span class="comment">!           redprm) above which snocvr=1.</span></div>
<div class="line"><a id="l02314" name="l02314"></a><span class="lineno"> 2314</span> </div>
<div class="line"><a id="l02315" name="l02315"></a><span class="lineno"> 2315</span>          <span class="keywordflow">if</span> (sneqv &lt; snup) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02316" name="l02316"></a><span class="lineno"> 2316</span>            rsnow = sneqv / snup</div>
<div class="line"><a id="l02317" name="l02317"></a><span class="lineno"> 2317</span>            sncovr = 1.0 - (exp(-salp*rsnow) - rsnow*exp(-salp))</div>
<div class="line"><a id="l02318" name="l02318"></a><span class="lineno"> 2318</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l02319" name="l02319"></a><span class="lineno"> 2319</span>            sncovr = 1.0</div>
<div class="line"><a id="l02320" name="l02320"></a><span class="lineno"> 2320</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l02321" name="l02321"></a><span class="lineno"> 2321</span> </div>
<div class="line"><a id="l02322" name="l02322"></a><span class="lineno"> 2322</span>          z0n = 0.035</div>
<div class="line"><a id="l02323" name="l02323"></a><span class="lineno"> 2323</span> </div>
<div class="line"><a id="l02324" name="l02324"></a><span class="lineno"> 2324</span><span class="comment">!  --- ...  formulation of dickinson et al. 1986</span></div>
<div class="line"><a id="l02325" name="l02325"></a><span class="lineno"> 2325</span> </div>
<div class="line"><a id="l02326" name="l02326"></a><span class="lineno"> 2326</span><span class="comment">!       sncovr = snowh / (snowh + 5.0*z0n)</span></div>
<div class="line"><a id="l02327" name="l02327"></a><span class="lineno"> 2327</span> </div>
<div class="line"><a id="l02328" name="l02328"></a><span class="lineno"> 2328</span><span class="comment">!  --- ...  formulation of marshall et al. 1994</span></div>
<div class="line"><a id="l02329" name="l02329"></a><span class="lineno"> 2329</span> </div>
<div class="line"><a id="l02330" name="l02330"></a><span class="lineno"> 2330</span><span class="comment">!       sncovr = sneqv / (sneqv + 2.0*z0n)</span></div>
<div class="line"><a id="l02331" name="l02331"></a><span class="lineno"> 2331</span> </div>
<div class="line"><a id="l02332" name="l02332"></a><span class="lineno"> 2332</span><span class="comment">!</span></div>
<div class="line"><a id="l02333" name="l02333"></a><span class="lineno"> 2333</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l02334" name="l02334"></a><span class="lineno"> 2334</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gafca324f1a0f2bcca12116291bfc8ad68.html#gafca324f1a0f2bcca12116291bfc8ad68">snfrac</a></div>
<div class="line"><a id="l02335" name="l02335"></a><span class="lineno"> 2335</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l02336" name="l02336"></a><span class="lineno"> 2336</span> </div>
<div class="line"><a id="l02337" name="l02337"></a><span class="lineno"> 2337</span> </div>
<div class="line"><a id="l02338" name="l02338"></a><span class="lineno"> 2338</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l02339" name="l02339"></a><span class="lineno"> 2339</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l02340" name="l02340"></a><span class="lineno"> 2340</span><span class="comment">!&gt; This subroutine calculates soil moisture and heat flux values and</span></div>
<div class="line"><a id="l02341" name="l02341"></a><span class="lineno"> 2341</span><span class="comment">!! update soil moisture content and soil heat content values for the</span></div>
<div class="line"><a id="l02342" name="l02342"></a><span class="lineno"> 2342</span><span class="comment">!! case when a snow pack is present.</span></div>
<div class="foldopen" id="foldopen02343" data-start="" data-end="">
<div class="line"><a id="l02343" name="l02343"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gad65a889bf3f431ade2a312674671ab41.html#gad65a889bf3f431ade2a312674671ab41"> 2343</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gad65a889bf3f431ade2a312674671ab41.html#gad65a889bf3f431ade2a312674671ab41">snopac</a></div>
<div class="line"><a id="l02344" name="l02344"></a><span class="lineno"> 2344</span><span class="comment">!...................................</span></div>
<div class="line"><a id="l02345" name="l02345"></a><span class="lineno"> 2345</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02346" name="l02346"></a><span class="lineno"> 2346</span><span class="comment">!    &amp;     ( nsoil, nroot, etp, prcp, smcmax, smcwlt, smcref, smcdry,   &amp;</span></div>
<div class="line"><a id="l02347" name="l02347"></a><span class="lineno"> 2347</span><span class="comment">!    &amp;       cmcmax, dt, df1, sfcems, sfctmp, t24, th2, fdown, epsca,   &amp;</span></div>
<div class="line"><a id="l02348" name="l02348"></a><span class="lineno"> 2348</span><span class="comment">!    &amp;       bexp, pc, rch, rr, cfactr, slope, kdt, frzx, psisat,       &amp;</span></div>
<div class="line"><a id="l02349" name="l02349"></a><span class="lineno"> 2349</span><span class="comment">!    &amp;       zsoil, dwsat, dksat, zbot, shdfac, ice, rtdis, quartz,     &amp;</span></div>
<div class="line"><a id="l02350" name="l02350"></a><span class="lineno"> 2350</span><span class="comment">!    &amp;       fxexp, csoil, flx2, snowng, lheatstrg,                     &amp;</span></div>
<div class="line"><a id="l02351" name="l02351"></a><span class="lineno"> 2351</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02352" name="l02352"></a><span class="lineno"> 2352</span><span class="comment">!    &amp;       prcp1, cmc, t1, stc, sncovr, sneqv, sndens, snowh,         &amp;</span></div>
<div class="line"><a id="l02353" name="l02353"></a><span class="lineno"> 2353</span><span class="comment">!    &amp;       sh2o, tbot, beta,                                          &amp;</span></div>
<div class="line"><a id="l02354" name="l02354"></a><span class="lineno"> 2354</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l02355" name="l02355"></a><span class="lineno"> 2355</span><span class="comment">!    &amp;       smc, ssoil, runoff1, runoff2, runoff3, edir, ec, et,       &amp;</span></div>
<div class="line"><a id="l02356" name="l02356"></a><span class="lineno"> 2356</span><span class="comment">!    &amp;       ett, snomlt, drip, dew, flx1, flx3, esnow                  &amp;</span></div>
<div class="line"><a id="l02357" name="l02357"></a><span class="lineno"> 2357</span><span class="comment">!    &amp;     )</span></div>
<div class="line"><a id="l02358" name="l02358"></a><span class="lineno"> 2358</span> </div>
<div class="line"><a id="l02359" name="l02359"></a><span class="lineno"> 2359</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l02360" name="l02360"></a><span class="lineno"> 2360</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l02361" name="l02361"></a><span class="lineno"> 2361</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02362" name="l02362"></a><span class="lineno"> 2362</span><span class="comment">!  subroutine snopac calculates soil moisture and heat flux values and  !</span></div>
<div class="line"><a id="l02363" name="l02363"></a><span class="lineno"> 2363</span><span class="comment">!  update soil moisture content and soil heat content values for the    !</span></div>
<div class="line"><a id="l02364" name="l02364"></a><span class="lineno"> 2364</span><span class="comment">!  case when a snow pack is present.                                    !</span></div>
<div class="line"><a id="l02365" name="l02365"></a><span class="lineno"> 2365</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02366" name="l02366"></a><span class="lineno"> 2366</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02367" name="l02367"></a><span class="lineno"> 2367</span><span class="comment">!  subprograms called:  evapo, smflx, shflx, snowpack</span></div>
<div class="line"><a id="l02368" name="l02368"></a><span class="lineno"> 2368</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02369" name="l02369"></a><span class="lineno"> 2369</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l02370" name="l02370"></a><span class="lineno"> 2370</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02371" name="l02371"></a><span class="lineno"> 2371</span><span class="comment">!  inputs from the calling program:                              size   !</span></div>
<div class="line"><a id="l02372" name="l02372"></a><span class="lineno"> 2372</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l02373" name="l02373"></a><span class="lineno"> 2373</span><span class="comment">!     nroot    - integer, number of root layers                    1    !</span></div>
<div class="line"><a id="l02374" name="l02374"></a><span class="lineno"> 2374</span><span class="comment">!     etp      - real, potential evaporation                       1    !</span></div>
<div class="line"><a id="l02375" name="l02375"></a><span class="lineno"> 2375</span><span class="comment">!     prcp     - real, precip rate                                 1    !</span></div>
<div class="line"><a id="l02376" name="l02376"></a><span class="lineno"> 2376</span><span class="comment">!     smcmax   - real, porosity                                    1    !</span></div>
<div class="line"><a id="l02377" name="l02377"></a><span class="lineno"> 2377</span><span class="comment">!     smcwlt   - real, wilting point                               1    !</span></div>
<div class="line"><a id="l02378" name="l02378"></a><span class="lineno"> 2378</span><span class="comment">!     smcref   - real, soil mois threshold                         1    !</span></div>
<div class="line"><a id="l02379" name="l02379"></a><span class="lineno"> 2379</span><span class="comment">!     smcdry   - real, dry soil mois threshold                     1    !</span></div>
<div class="line"><a id="l02380" name="l02380"></a><span class="lineno"> 2380</span><span class="comment">!     cmcmax   - real, maximum canopy water parameters             1    !</span></div>
<div class="line"><a id="l02381" name="l02381"></a><span class="lineno"> 2381</span><span class="comment">!     dt       - real, time step                                   1    !</span></div>
<div class="line"><a id="l02382" name="l02382"></a><span class="lineno"> 2382</span><span class="comment">!     df1      - real, thermal diffusivity                         m    !</span></div>
<div class="line"><a id="l02383" name="l02383"></a><span class="lineno"> 2383</span><span class="comment">!     sfcems   - real, lw surface emissivity                       1    !</span></div>
<div class="line"><a id="l02384" name="l02384"></a><span class="lineno"> 2384</span><span class="comment">!     sfctmp   - real, sfc temperature                             1    !</span></div>
<div class="line"><a id="l02385" name="l02385"></a><span class="lineno"> 2385</span><span class="comment">!     t24      - real, sfctmp**4                                   1    !</span></div>
<div class="line"><a id="l02386" name="l02386"></a><span class="lineno"> 2386</span><span class="comment">!     th2      - real, sfc air potential temperature               1    !</span></div>
<div class="line"><a id="l02387" name="l02387"></a><span class="lineno"> 2387</span><span class="comment">!     fdown    - real, net solar + downward lw flux at sfc         1    !</span></div>
<div class="line"><a id="l02388" name="l02388"></a><span class="lineno"> 2388</span><span class="comment">!     epsca    - real,                                             1    !</span></div>
<div class="line"><a id="l02389" name="l02389"></a><span class="lineno"> 2389</span><span class="comment">!     bexp     - real, soil type &quot;b&quot; parameter                     1    !</span></div>
<div class="line"><a id="l02390" name="l02390"></a><span class="lineno"> 2390</span><span class="comment">!     pc       - real, plant coeff                                 1    !</span></div>
<div class="line"><a id="l02391" name="l02391"></a><span class="lineno"> 2391</span><span class="comment">!     rch      - real, companion coefficient of ch                 1    !</span></div>
<div class="line"><a id="l02392" name="l02392"></a><span class="lineno"> 2392</span><span class="comment">!     rr       - real,                                             1    !</span></div>
<div class="line"><a id="l02393" name="l02393"></a><span class="lineno"> 2393</span><span class="comment">!     cfactr   - real, canopy water parameters                     1    !</span></div>
<div class="line"><a id="l02394" name="l02394"></a><span class="lineno"> 2394</span><span class="comment">!     slope    - real, linear reservoir coefficient                1    !</span></div>
<div class="line"><a id="l02395" name="l02395"></a><span class="lineno"> 2395</span><span class="comment">!     kdt      - real,                                             1    !</span></div>
<div class="line"><a id="l02396" name="l02396"></a><span class="lineno"> 2396</span><span class="comment">!     frzx     - real, frozen ground parameter                     1    !</span></div>
<div class="line"><a id="l02397" name="l02397"></a><span class="lineno"> 2397</span><span class="comment">!     psisat   - real, saturated soil potential                    1    !</span></div>
<div class="line"><a id="l02398" name="l02398"></a><span class="lineno"> 2398</span><span class="comment">!     zsoil    - real, soil layer depth below ground (negative)  nsoil  !</span></div>
<div class="line"><a id="l02399" name="l02399"></a><span class="lineno"> 2399</span><span class="comment">!     dwsat    - real, saturated soil diffusivity                  1    !</span></div>
<div class="line"><a id="l02400" name="l02400"></a><span class="lineno"> 2400</span><span class="comment">!     dksat    - real, saturated soil hydraulic conductivity       1    !</span></div>
<div class="line"><a id="l02401" name="l02401"></a><span class="lineno"> 2401</span><span class="comment">!     zbot     - real, specify depth of lower bd soil              1    !</span></div>
<div class="line"><a id="l02402" name="l02402"></a><span class="lineno"> 2402</span><span class="comment">!     shdfac   - real, aeral coverage of green vegetation          1    !</span></div>
<div class="line"><a id="l02403" name="l02403"></a><span class="lineno"> 2403</span><span class="comment">!     ice      - integer, sea-ice flag (=1: sea-ice, =0: land)     1    !</span></div>
<div class="line"><a id="l02404" name="l02404"></a><span class="lineno"> 2404</span><span class="comment">!     rtdis    - real, root distribution                         nsoil  !</span></div>
<div class="line"><a id="l02405" name="l02405"></a><span class="lineno"> 2405</span><span class="comment">!     quartz   - real, soil quartz content                         1    !</span></div>
<div class="line"><a id="l02406" name="l02406"></a><span class="lineno"> 2406</span><span class="comment">!     fxexp    - real, bare soil evaporation exponent              1    !</span></div>
<div class="line"><a id="l02407" name="l02407"></a><span class="lineno"> 2407</span><span class="comment">!     csoil    - real, soil heat capacity                          1    !</span></div>
<div class="line"><a id="l02408" name="l02408"></a><span class="lineno"> 2408</span><span class="comment">!     flx2     - real, freezing rain latent heat flux              1    !</span></div>
<div class="line"><a id="l02409" name="l02409"></a><span class="lineno"> 2409</span><span class="comment">!     snowng   - logical, snow flag                                1    !</span></div>
<div class="line"><a id="l02410" name="l02410"></a><span class="lineno"> 2410</span><span class="comment">!     lheatstrg- logical, flag for canopy heat storage             1    !</span></div>
<div class="line"><a id="l02411" name="l02411"></a><span class="lineno"> 2411</span><span class="comment">!                         parameterization                              !</span></div>
<div class="line"><a id="l02412" name="l02412"></a><span class="lineno"> 2412</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02413" name="l02413"></a><span class="lineno"> 2413</span><span class="comment">!  input/outputs from and to the calling program:                       !</span></div>
<div class="line"><a id="l02414" name="l02414"></a><span class="lineno"> 2414</span><span class="comment">!     prcp1    - real, effective precip                            1    !</span></div>
<div class="line"><a id="l02415" name="l02415"></a><span class="lineno"> 2415</span><span class="comment">!     cmc      - real, canopy moisture content                     1    !</span></div>
<div class="line"><a id="l02416" name="l02416"></a><span class="lineno"> 2416</span><span class="comment">!     t1       - real, ground/canopy/snowpack eff skin temp        1    !</span></div>
<div class="line"><a id="l02417" name="l02417"></a><span class="lineno"> 2417</span><span class="comment">!     stc      - real, soil temperature                          nsoil  !</span></div>
<div class="line"><a id="l02418" name="l02418"></a><span class="lineno"> 2418</span><span class="comment">!     sncovr   - real, snow cover                                  1    !</span></div>
<div class="line"><a id="l02419" name="l02419"></a><span class="lineno"> 2419</span><span class="comment">!     sneqv    - real, water-equivalent snow depth                 1    !</span></div>
<div class="line"><a id="l02420" name="l02420"></a><span class="lineno"> 2420</span><span class="comment">!     sndens   - real, snow density                                1    !</span></div>
<div class="line"><a id="l02421" name="l02421"></a><span class="lineno"> 2421</span><span class="comment">!     snowh    - real, snow depth                                  1    !</span></div>
<div class="line"><a id="l02422" name="l02422"></a><span class="lineno"> 2422</span><span class="comment">!     sh2o     - real, unfrozen soil moisture                    nsoil  !</span></div>
<div class="line"><a id="l02423" name="l02423"></a><span class="lineno"> 2423</span><span class="comment">!     tbot     - real, bottom soil temperature                     1    !</span></div>
<div class="line"><a id="l02424" name="l02424"></a><span class="lineno"> 2424</span><span class="comment">!     beta     - real, ratio of actual/potential evap              1    !</span></div>
<div class="line"><a id="l02425" name="l02425"></a><span class="lineno"> 2425</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02426" name="l02426"></a><span class="lineno"> 2426</span><span class="comment">!  outputs to the calling program:                                      !</span></div>
<div class="line"><a id="l02427" name="l02427"></a><span class="lineno"> 2427</span><span class="comment">!     smc      - real, total soil moisture                       nsoil  !</span></div>
<div class="line"><a id="l02428" name="l02428"></a><span class="lineno"> 2428</span><span class="comment">!     ssoil    - real, upward soil heat flux                       1    !</span></div>
<div class="line"><a id="l02429" name="l02429"></a><span class="lineno"> 2429</span><span class="comment">!     runoff1  - real, surface runoff not infiltrating sfc         1    !</span></div>
<div class="line"><a id="l02430" name="l02430"></a><span class="lineno"> 2430</span><span class="comment">!     runoff2  - real, sub surface runoff                          1    !</span></div>
<div class="line"><a id="l02431" name="l02431"></a><span class="lineno"> 2431</span><span class="comment">!     runoff3  - real, excess of porosity for a given soil layer   1    !</span></div>
<div class="line"><a id="l02432" name="l02432"></a><span class="lineno"> 2432</span><span class="comment">!     edir     - real, direct soil evaporation                     1    !</span></div>
<div class="line"><a id="l02433" name="l02433"></a><span class="lineno"> 2433</span><span class="comment">!     ec       - real, canopy water evaporation                    1    !</span></div>
<div class="line"><a id="l02434" name="l02434"></a><span class="lineno"> 2434</span><span class="comment">!     et       - real, plant transpiration                       nsoil  !</span></div>
<div class="line"><a id="l02435" name="l02435"></a><span class="lineno"> 2435</span><span class="comment">!     ett      - real, total plant transpiration                   1    !</span></div>
<div class="line"><a id="l02436" name="l02436"></a><span class="lineno"> 2436</span><span class="comment">!     snomlt   - real, snow melt water equivalent                  1    !</span></div>
<div class="line"><a id="l02437" name="l02437"></a><span class="lineno"> 2437</span><span class="comment">!     drip     - real, through-fall of precip                      1    !</span></div>
<div class="line"><a id="l02438" name="l02438"></a><span class="lineno"> 2438</span><span class="comment">!     dew      - real, dewfall (or frostfall)                      1    !</span></div>
<div class="line"><a id="l02439" name="l02439"></a><span class="lineno"> 2439</span><span class="comment">!     flx1     - real, precip-snow sfc flux                        1    !</span></div>
<div class="line"><a id="l02440" name="l02440"></a><span class="lineno"> 2440</span><span class="comment">!     flx3     - real, phase-change heat flux from snowmelt        1    !</span></div>
<div class="line"><a id="l02441" name="l02441"></a><span class="lineno"> 2441</span><span class="comment">!     esnow    - real, sublimation from snowpack                   1    !</span></div>
<div class="line"><a id="l02442" name="l02442"></a><span class="lineno"> 2442</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02443" name="l02443"></a><span class="lineno"> 2443</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l02444" name="l02444"></a><span class="lineno"> 2444</span><span class="comment">!</span></div>
<div class="line"><a id="l02445" name="l02445"></a><span class="lineno"> 2445</span><span class="comment">!  ---  constant parameters:</span></div>
<div class="line"><a id="l02446" name="l02446"></a><span class="lineno"> 2446</span><span class="keywordtype">      real</span>, <span class="keywordtype">parameter</span> :: esdmin = 1.e-6</div>
<div class="line"><a id="l02447" name="l02447"></a><span class="lineno"> 2447</span> </div>
<div class="line"><a id="l02448" name="l02448"></a><span class="lineno"> 2448</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02449" name="l02449"></a><span class="lineno"> 2449</span><span class="comment">!     integer, intent(in) :: nsoil, nroot, ice</span></div>
<div class="line"><a id="l02450" name="l02450"></a><span class="lineno"> 2450</span> </div>
<div class="line"><a id="l02451" name="l02451"></a><span class="lineno"> 2451</span><span class="comment">!     real (kind=kind_phys), intent(in) :: etp, prcp, smcmax, smcref,   &amp;</span></div>
<div class="line"><a id="l02452" name="l02452"></a><span class="lineno"> 2452</span><span class="comment">!    &amp;       smcwlt, smcdry, cmcmax, dt, df1, sfcems, sfctmp, t24,      &amp;</span></div>
<div class="line"><a id="l02453" name="l02453"></a><span class="lineno"> 2453</span><span class="comment">!    &amp;       th2, fdown, epsca, bexp, pc, rch, rr, cfactr, slope, kdt,  &amp;</span></div>
<div class="line"><a id="l02454" name="l02454"></a><span class="lineno"> 2454</span><span class="comment">!    &amp;       frzx, psisat, dwsat, dksat, zbot, shdfac, quartz,          &amp;</span></div>
<div class="line"><a id="l02455" name="l02455"></a><span class="lineno"> 2455</span><span class="comment">!    &amp;       csoil, fxexp, flx2, zsoil(nsoil), rtdis(nsoil)</span></div>
<div class="line"><a id="l02456" name="l02456"></a><span class="lineno"> 2456</span> </div>
<div class="line"><a id="l02457" name="l02457"></a><span class="lineno"> 2457</span><span class="comment">!     logical, intent(in) :: snowng</span></div>
<div class="line"><a id="l02458" name="l02458"></a><span class="lineno"> 2458</span><span class="comment">!</span></div>
<div class="line"><a id="l02459" name="l02459"></a><span class="lineno"> 2459</span><span class="comment">!     logical, intent(in) :: lheatstrg</span></div>
<div class="line"><a id="l02460" name="l02460"></a><span class="lineno"> 2460</span><span class="comment">!</span></div>
<div class="line"><a id="l02461" name="l02461"></a><span class="lineno"> 2461</span> </div>
<div class="line"><a id="l02462" name="l02462"></a><span class="lineno"> 2462</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02463" name="l02463"></a><span class="lineno"> 2463</span><span class="comment">!     real (kind=kind_phys), intent(inout) :: prcp1, t1, sncovr, sneqv, &amp;</span></div>
<div class="line"><a id="l02464" name="l02464"></a><span class="lineno"> 2464</span><span class="comment">!    &amp;       sndens, snowh, cmc, tbot, beta, sh2o(nsoil), stc(nsoil)</span></div>
<div class="line"><a id="l02465" name="l02465"></a><span class="lineno"> 2465</span> </div>
<div class="line"><a id="l02466" name="l02466"></a><span class="lineno"> 2466</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l02467" name="l02467"></a><span class="lineno"> 2467</span><span class="comment">!     real (kind=kind_phys), intent(out) :: ssoil, runoff1, runoff2,    &amp;</span></div>
<div class="line"><a id="l02468" name="l02468"></a><span class="lineno"> 2468</span><span class="comment">!    &amp;       runoff3, edir, ec, et(nsoil), ett, snomlt, drip, dew,      &amp;</span></div>
<div class="line"><a id="l02469" name="l02469"></a><span class="lineno"> 2469</span><span class="comment">!    &amp;       flx1, flx3, esnow, smc(nsoil)</span></div>
<div class="line"><a id="l02470" name="l02470"></a><span class="lineno"> 2470</span> </div>
<div class="line"><a id="l02471" name="l02471"></a><span class="lineno"> 2471</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l02472" name="l02472"></a><span class="lineno"> 2472</span><span class="keywordtype">      real</span> (kind=kind_phys):: denom, dsoil, dtot, etp1, ssoil1,         &amp;</div>
<div class="line"><a id="l02473" name="l02473"></a><span class="lineno"> 2473</span>     &amp;       snoexp, ex, t11, t12, t12a, t12b, yy, zz1, seh, t14,       &amp;</div>
<div class="line"><a id="l02474" name="l02474"></a><span class="lineno"> 2474</span>     &amp;       ec1, edir1, ett1, etns, etns1, esnow1, esnow2, etanrg,     &amp;</div>
<div class="line"><a id="l02475" name="l02475"></a><span class="lineno"> 2475</span>     &amp;       et1(nsoil)</div>
<div class="line"><a id="l02476" name="l02476"></a><span class="lineno"> 2476</span> </div>
<div class="line"><a id="l02477" name="l02477"></a><span class="lineno"> 2477</span>      <span class="keywordtype">integer</span> k</div>
<div class="line"><a id="l02478" name="l02478"></a><span class="lineno"> 2478</span> </div>
<div class="line"><a id="l02479" name="l02479"></a><span class="lineno"> 2479</span><span class="comment">!     data snoexp /1.0/    !!! &lt;----- for noah v2.7</span></div>
<div class="line"><a id="l02480" name="l02480"></a><span class="lineno"> 2480</span>      <span class="keyword">data</span> snoexp /2.0/    <span class="comment">!!! &lt;----- for noah v2.7.1</span></div>
<div class="line"><a id="l02481" name="l02481"></a><span class="lineno"> 2481</span> </div>
<div class="line"><a id="l02482" name="l02482"></a><span class="lineno"> 2482</span><span class="comment">!  --- ...  convert potential evap (etp) from kg m-2 s-1 to m s-1 and then to an</span></div>
<div class="line"><a id="l02483" name="l02483"></a><span class="lineno"> 2483</span><span class="comment">!           amount (m) given timestep (dt) and call it an effective snowpack</span></div>
<div class="line"><a id="l02484" name="l02484"></a><span class="lineno"> 2484</span><span class="comment">!           reduction amount, esnow2 (m) for a snowcover fraction = 1.0.  this is</span></div>
<div class="line"><a id="l02485" name="l02485"></a><span class="lineno"> 2485</span><span class="comment">!           the amount the snowpack would be reduced due to sublimation from the</span></div>
<div class="line"><a id="l02486" name="l02486"></a><span class="lineno"> 2486</span><span class="comment">!           snow sfc during the timestep.  sublimation will proceed at the</span></div>
<div class="line"><a id="l02487" name="l02487"></a><span class="lineno"> 2487</span><span class="comment">!           potential rate unless the snow depth is less than the expected</span></div>
<div class="line"><a id="l02488" name="l02488"></a><span class="lineno"> 2488</span><span class="comment">!           snowpack reduction.  for snowcover fraction = 1.0, 0=edir=et=ec, and</span></div>
<div class="line"><a id="l02489" name="l02489"></a><span class="lineno"> 2489</span><span class="comment">!           hence total evap = esnow = sublimation (potential evap rate)</span></div>
<div class="line"><a id="l02490" name="l02490"></a><span class="lineno"> 2490</span> </div>
<div class="line"><a id="l02491" name="l02491"></a><span class="lineno"> 2491</span><span class="comment">!  --- ...  if sea-ice (ice=1) or glacial-ice (ice=-1), snowcover fraction = 1.0,</span></div>
<div class="line"><a id="l02492" name="l02492"></a><span class="lineno"> 2492</span><span class="comment">!           and sublimation is at the potential rate.</span></div>
<div class="line"><a id="l02493" name="l02493"></a><span class="lineno"> 2493</span><span class="comment">!           for non-glacial land (ice=0), if snowcover fraction &lt; 1.0, total</span></div>
<div class="line"><a id="l02494" name="l02494"></a><span class="lineno"> 2494</span><span class="comment">!           evaporation &lt; potential due to non-potential contribution from</span></div>
<div class="line"><a id="l02495" name="l02495"></a><span class="lineno"> 2495</span><span class="comment">!           non-snow covered fraction.</span></div>
<div class="line"><a id="l02496" name="l02496"></a><span class="lineno"> 2496</span> </div>
<div class="line"><a id="l02497" name="l02497"></a><span class="lineno"> 2497</span>      prcp1 = prcp1 * 0.001</div>
<div class="line"><a id="l02498" name="l02498"></a><span class="lineno"> 2498</span> </div>
<div class="line"><a id="l02499" name="l02499"></a><span class="lineno"> 2499</span>      edir  = 0.0</div>
<div class="line"><a id="l02500" name="l02500"></a><span class="lineno"> 2500</span>      edir1 = 0.0</div>
<div class="line"><a id="l02501" name="l02501"></a><span class="lineno"> 2501</span> </div>
<div class="line"><a id="l02502" name="l02502"></a><span class="lineno"> 2502</span>      ec  = 0.0</div>
<div class="line"><a id="l02503" name="l02503"></a><span class="lineno"> 2503</span>      ec1 = 0.0</div>
<div class="line"><a id="l02504" name="l02504"></a><span class="lineno"> 2504</span> </div>
<div class="line"><a id="l02505" name="l02505"></a><span class="lineno"> 2505</span>      <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l02506" name="l02506"></a><span class="lineno"> 2506</span>        et(k) = 0.0</div>
<div class="line"><a id="l02507" name="l02507"></a><span class="lineno"> 2507</span>        et1(k) = 0.0</div>
<div class="line"><a id="l02508" name="l02508"></a><span class="lineno"> 2508</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l02509" name="l02509"></a><span class="lineno"> 2509</span> </div>
<div class="line"><a id="l02510" name="l02510"></a><span class="lineno"> 2510</span>      ett   = 0.0</div>
<div class="line"><a id="l02511" name="l02511"></a><span class="lineno"> 2511</span>      ett1  = 0.0</div>
<div class="line"><a id="l02512" name="l02512"></a><span class="lineno"> 2512</span>      etns  = 0.0</div>
<div class="line"><a id="l02513" name="l02513"></a><span class="lineno"> 2513</span>      etns1 = 0.0</div>
<div class="line"><a id="l02514" name="l02514"></a><span class="lineno"> 2514</span>      esnow = 0.0</div>
<div class="line"><a id="l02515" name="l02515"></a><span class="lineno"> 2515</span>      esnow1= 0.0</div>
<div class="line"><a id="l02516" name="l02516"></a><span class="lineno"> 2516</span>      esnow2= 0.0</div>
<div class="line"><a id="l02517" name="l02517"></a><span class="lineno"> 2517</span> </div>
<div class="line"><a id="l02518" name="l02518"></a><span class="lineno"> 2518</span>      dew = 0.0</div>
<div class="line"><a id="l02519" name="l02519"></a><span class="lineno"> 2519</span>      etp1 = etp * 0.001</div>
<div class="line"><a id="l02520" name="l02520"></a><span class="lineno"> 2520</span> </div>
<div class="line"><a id="l02521" name="l02521"></a><span class="lineno"> 2521</span>      <span class="keywordflow">if</span> (etp &lt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02522" name="l02522"></a><span class="lineno"> 2522</span> </div>
<div class="line"><a id="l02523" name="l02523"></a><span class="lineno"> 2523</span><span class="comment">!  --- ...  if etp&lt;0 (downward) then dewfall (=frostfall in this case).</span></div>
<div class="line"><a id="l02524" name="l02524"></a><span class="lineno"> 2524</span> </div>
<div class="line"><a id="l02525" name="l02525"></a><span class="lineno"> 2525</span>        dew = -etp1</div>
<div class="line"><a id="l02526" name="l02526"></a><span class="lineno"> 2526</span>        esnow2 = etp1 * dt</div>
<div class="line"><a id="l02527" name="l02527"></a><span class="lineno"> 2527</span>        etanrg = etp * ((1.0-sncovr)*lsubc + sncovr*lsubs)</div>
<div class="line"><a id="l02528" name="l02528"></a><span class="lineno"> 2528</span> </div>
<div class="line"><a id="l02529" name="l02529"></a><span class="lineno"> 2529</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l02530" name="l02530"></a><span class="lineno"> 2530</span> </div>
<div class="line"><a id="l02531" name="l02531"></a><span class="lineno"> 2531</span><span class="comment">!  --- ...  etp &gt;= 0, upward moisture flux</span></div>
<div class="line"><a id="l02532" name="l02532"></a><span class="lineno"> 2532</span> </div>
<div class="line"><a id="l02533" name="l02533"></a><span class="lineno"> 2533</span>        <span class="keywordflow">if</span> (ice /= 0) <span class="keywordflow">then</span>           <span class="comment">! for sea-ice and glacial-ice case</span></div>
<div class="line"><a id="l02534" name="l02534"></a><span class="lineno"> 2534</span> </div>
<div class="line"><a id="l02535" name="l02535"></a><span class="lineno"> 2535</span>          esnow = etp</div>
<div class="line"><a id="l02536" name="l02536"></a><span class="lineno"> 2536</span>          esnow1 = esnow * 0.001</div>
<div class="line"><a id="l02537" name="l02537"></a><span class="lineno"> 2537</span>          esnow2 = esnow1 * dt</div>
<div class="line"><a id="l02538" name="l02538"></a><span class="lineno"> 2538</span>          etanrg = esnow * lsubs</div>
<div class="line"><a id="l02539" name="l02539"></a><span class="lineno"> 2539</span> </div>
<div class="line"><a id="l02540" name="l02540"></a><span class="lineno"> 2540</span>        <span class="keywordflow">else</span>                         <span class="comment">! for non-glacial land case</span></div>
<div class="line"><a id="l02541" name="l02541"></a><span class="lineno"> 2541</span> </div>
<div class="line"><a id="l02542" name="l02542"></a><span class="lineno"> 2542</span>          <span class="keywordflow">if</span> (sncovr &lt; 1.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02543" name="l02543"></a><span class="lineno"> 2543</span> </div>
<div class="line"><a id="l02544" name="l02544"></a><span class="lineno"> 2544</span>            <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga4af741ecc120ddb0d7282f78df4136a5.html#ga4af741ecc120ddb0d7282f78df4136a5">evapo</a>                                                  &amp;</div>
<div class="line"><a id="l02545" name="l02545"></a><span class="lineno"> 2545</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02546" name="l02546"></a><span class="lineno"> 2546</span>     &amp;     ( nsoil, nroot, cmc, cmcmax, etp1, dt, zsoil,                &amp;</div>
<div class="line"><a id="l02547" name="l02547"></a><span class="lineno"> 2547</span>     &amp;       sh2o, smcmax, smcwlt, smcref, smcdry, pc,                  &amp;</div>
<div class="line"><a id="l02548" name="l02548"></a><span class="lineno"> 2548</span>     &amp;       shdfac, cfactr, rtdis, fxexp,                              &amp;</div>
<div class="line"><a id="l02549" name="l02549"></a><span class="lineno"> 2549</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l02550" name="l02550"></a><span class="lineno"> 2550</span>     &amp;       etns1, edir1, ec1, et1, ett1                               &amp;</div>
<div class="line"><a id="l02551" name="l02551"></a><span class="lineno"> 2551</span>     &amp;     )</div>
<div class="line"><a id="l02552" name="l02552"></a><span class="lineno"> 2552</span> </div>
<div class="line"><a id="l02553" name="l02553"></a><span class="lineno"> 2553</span>            edir1 = edir1 * (1.0 - sncovr)</div>
<div class="line"><a id="l02554" name="l02554"></a><span class="lineno"> 2554</span>            ec1 = ec1 * (1.0 - sncovr)</div>
<div class="line"><a id="l02555" name="l02555"></a><span class="lineno"> 2555</span> </div>
<div class="line"><a id="l02556" name="l02556"></a><span class="lineno"> 2556</span>            <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l02557" name="l02557"></a><span class="lineno"> 2557</span>              et1(k) = et1(k) * (1.0 - sncovr)</div>
<div class="line"><a id="l02558" name="l02558"></a><span class="lineno"> 2558</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l02559" name="l02559"></a><span class="lineno"> 2559</span> </div>
<div class="line"><a id="l02560" name="l02560"></a><span class="lineno"> 2560</span>            ett1  = ett1  * (1.0 - sncovr)</div>
<div class="line"><a id="l02561" name="l02561"></a><span class="lineno"> 2561</span>            etns1 = etns1 * (1.0 - sncovr)</div>
<div class="line"><a id="l02562" name="l02562"></a><span class="lineno"> 2562</span> </div>
<div class="line"><a id="l02563" name="l02563"></a><span class="lineno"> 2563</span>            edir = edir1 * 1000.0</div>
<div class="line"><a id="l02564" name="l02564"></a><span class="lineno"> 2564</span>            ec = ec1 * 1000.0</div>
<div class="line"><a id="l02565" name="l02565"></a><span class="lineno"> 2565</span> </div>
<div class="line"><a id="l02566" name="l02566"></a><span class="lineno"> 2566</span>            <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l02567" name="l02567"></a><span class="lineno"> 2567</span>              et(k) = et1(k) * 1000.0</div>
<div class="line"><a id="l02568" name="l02568"></a><span class="lineno"> 2568</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l02569" name="l02569"></a><span class="lineno"> 2569</span> </div>
<div class="line"><a id="l02570" name="l02570"></a><span class="lineno"> 2570</span>            ett = ett1 * 1000.0</div>
<div class="line"><a id="l02571" name="l02571"></a><span class="lineno"> 2571</span>            etns = etns1 * 1000.0</div>
<div class="line"><a id="l02572" name="l02572"></a><span class="lineno"> 2572</span> </div>
<div class="line"><a id="l02573" name="l02573"></a><span class="lineno"> 2573</span><span class="keywordflow">          endif</span>   <span class="comment">! end if_sncovr_block</span></div>
<div class="line"><a id="l02574" name="l02574"></a><span class="lineno"> 2574</span> </div>
<div class="line"><a id="l02575" name="l02575"></a><span class="lineno"> 2575</span>          esnow = etp * sncovr</div>
<div class="line"><a id="l02576" name="l02576"></a><span class="lineno"> 2576</span><span class="comment">!         esnow1 = etp * 0.001</span></div>
<div class="line"><a id="l02577" name="l02577"></a><span class="lineno"> 2577</span>          esnow1 = esnow * 0.001</div>
<div class="line"><a id="l02578" name="l02578"></a><span class="lineno"> 2578</span>          esnow2 = esnow1 * dt</div>
<div class="line"><a id="l02579" name="l02579"></a><span class="lineno"> 2579</span>          etanrg = esnow*lsubs + etns*lsubc</div>
<div class="line"><a id="l02580" name="l02580"></a><span class="lineno"> 2580</span> </div>
<div class="line"><a id="l02581" name="l02581"></a><span class="lineno"> 2581</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_ice_block</span></div>
<div class="line"><a id="l02582" name="l02582"></a><span class="lineno"> 2582</span> </div>
<div class="line"><a id="l02583" name="l02583"></a><span class="lineno"> 2583</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_etp_block</span></div>
<div class="line"><a id="l02584" name="l02584"></a><span class="lineno"> 2584</span> </div>
<div class="line"><a id="l02585" name="l02585"></a><span class="lineno"> 2585</span><span class="comment">!  --- ...  if precip is falling, calculate heat flux from snow sfc to newly</span></div>
<div class="line"><a id="l02586" name="l02586"></a><span class="lineno"> 2586</span><span class="comment">!           accumulating precip.  note that this reflects the flux appropriate for</span></div>
<div class="line"><a id="l02587" name="l02587"></a><span class="lineno"> 2587</span><span class="comment">!           the not-yet-updated skin temperature (t1).  assumes temperature of the</span></div>
<div class="line"><a id="l02588" name="l02588"></a><span class="lineno"> 2588</span><span class="comment">!           snowfall striking the gound is =sfctmp (lowest model level air temp).</span></div>
<div class="line"><a id="l02589" name="l02589"></a><span class="lineno"> 2589</span> </div>
<div class="line"><a id="l02590" name="l02590"></a><span class="lineno"> 2590</span>      flx1 = 0.0</div>
<div class="line"><a id="l02591" name="l02591"></a><span class="lineno"> 2591</span>      <span class="keywordflow">if</span> ( snowng ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02592" name="l02592"></a><span class="lineno"> 2592</span><span class="comment">!  --- ... fractional snowfall/rainfall</span></div>
<div class="line"><a id="l02593" name="l02593"></a><span class="lineno"> 2593</span>        flx1 = (cpice* ffrozp + cph2o1*(1.-ffrozp))                     &amp;</div>
<div class="line"><a id="l02594" name="l02594"></a><span class="lineno"> 2594</span>     &amp;         * prcp * (t1 - sfctmp)</div>
<div class="line"><a id="l02595" name="l02595"></a><span class="lineno"> 2595</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l02596" name="l02596"></a><span class="lineno"> 2596</span>        <span class="keywordflow">if</span> (prcp &gt; 0.0) flx1 = cph2o1 * prcp * (t1 - sfctmp)</div>
<div class="line"><a id="l02597" name="l02597"></a><span class="lineno"> 2597</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l02598" name="l02598"></a><span class="lineno"> 2598</span> </div>
<div class="line"><a id="l02599" name="l02599"></a><span class="lineno"> 2599</span><span class="comment">!  --- ...  calculate an &#39;effective snow-grnd sfc temp&#39; (t12) based on heat</span></div>
<div class="line"><a id="l02600" name="l02600"></a><span class="lineno"> 2600</span><span class="comment">!           fluxes between the snow pack and the soil and on net radiation.</span></div>
<div class="line"><a id="l02601" name="l02601"></a><span class="lineno"> 2601</span><span class="comment">!           include flx1 (precip-snow sfc) and flx2 (freezing rain latent</span></div>
<div class="line"><a id="l02602" name="l02602"></a><span class="lineno"> 2602</span><span class="comment">!           heat) fluxes.</span></div>
<div class="line"><a id="l02603" name="l02603"></a><span class="lineno"> 2603</span><span class="comment">!           flx2 reflects freezing rain latent heat flux using t1 calculated</span></div>
<div class="line"><a id="l02604" name="l02604"></a><span class="lineno"> 2604</span><span class="comment">!           in penman.</span></div>
<div class="line"><a id="l02605" name="l02605"></a><span class="lineno"> 2605</span> </div>
<div class="line"><a id="l02606" name="l02606"></a><span class="lineno"> 2606</span>      dsoil = -0.5 * zsoil(1)</div>
<div class="line"><a id="l02607" name="l02607"></a><span class="lineno"> 2607</span>      dtot = snowh + dsoil</div>
<div class="line"><a id="l02608" name="l02608"></a><span class="lineno"> 2608</span>      denom = 1.0 + df1 / (dtot * rr * rch)</div>
<div class="line"><a id="l02609" name="l02609"></a><span class="lineno"> 2609</span> </div>
<div class="line"><a id="l02610" name="l02610"></a><span class="lineno"> 2610</span><span class="comment">!     t12a = ( (fdown - flx1 - flx2 - sigma1*t24) / rch                 &amp;</span></div>
<div class="line"><a id="l02611" name="l02611"></a><span class="lineno"> 2611</span><span class="comment">!    &amp;     + th2 - sfctmp - beta*epsca ) / rr</span></div>
<div class="line"><a id="l02612" name="l02612"></a><span class="lineno"> 2612</span>      t12a = ( (fdown - flx1 - flx2 - sfcems*sigma1*t24) / rch          &amp;</div>
<div class="line"><a id="l02613" name="l02613"></a><span class="lineno"> 2613</span>     &amp;     + th2 - sfctmp - etanrg/rch ) / rr</div>
<div class="line"><a id="l02614" name="l02614"></a><span class="lineno"> 2614</span> </div>
<div class="line"><a id="l02615" name="l02615"></a><span class="lineno"> 2615</span>      t12b = df1 * stc(1) / (dtot * rr * rch)</div>
<div class="line"><a id="l02616" name="l02616"></a><span class="lineno"> 2616</span>      t12 = (sfctmp + t12a + t12b) / denom</div>
<div class="line"><a id="l02617" name="l02617"></a><span class="lineno"> 2617</span> </div>
<div class="line"><a id="l02618" name="l02618"></a><span class="lineno"> 2618</span><span class="comment">!  --- ...  if the &#39;effective snow-grnd sfc temp&#39; is at or below freezing, no snow</span></div>
<div class="line"><a id="l02619" name="l02619"></a><span class="lineno"> 2619</span><span class="comment">!           melt will occur.  set the skin temp to this effective temp.  reduce</span></div>
<div class="line"><a id="l02620" name="l02620"></a><span class="lineno"> 2620</span><span class="comment">!           (by sublimination ) or increase (by frost) the depth of the snowpack,</span></div>
<div class="line"><a id="l02621" name="l02621"></a><span class="lineno"> 2621</span><span class="comment">!           depending on sign of etp.</span></div>
<div class="line"><a id="l02622" name="l02622"></a><span class="lineno"> 2622</span><span class="comment">!           update soil heat flux (ssoil) using new skin temperature (t1)</span></div>
<div class="line"><a id="l02623" name="l02623"></a><span class="lineno"> 2623</span><span class="comment">!           since no snowmelt, set accumulated snowmelt to zero, set &#39;effective&#39;</span></div>
<div class="line"><a id="l02624" name="l02624"></a><span class="lineno"> 2624</span><span class="comment">!           precip from snowmelt to zero, set phase-change heat flux from snowmelt</span></div>
<div class="line"><a id="l02625" name="l02625"></a><span class="lineno"> 2625</span><span class="comment">!           to zero.</span></div>
<div class="line"><a id="l02626" name="l02626"></a><span class="lineno"> 2626</span> </div>
<div class="line"><a id="l02627" name="l02627"></a><span class="lineno"> 2627</span>      <span class="keywordflow">if</span> (t12 &lt;= tfreez) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02628" name="l02628"></a><span class="lineno"> 2628</span> </div>
<div class="line"><a id="l02629" name="l02629"></a><span class="lineno"> 2629</span>        t1 = t12</div>
<div class="line"><a id="l02630" name="l02630"></a><span class="lineno"> 2630</span>        ssoil = df1 * (t1 - stc(1)) / dtot</div>
<div class="line"><a id="l02631" name="l02631"></a><span class="lineno"> 2631</span><span class="comment">!wz     ssoil = (t1 - stc (1)) * max(7.0, df1/dtot)</span></div>
<div class="line"><a id="l02632" name="l02632"></a><span class="lineno"> 2632</span>        sneqv = max(0.0, sneqv-esnow2)</div>
<div class="line"><a id="l02633" name="l02633"></a><span class="lineno"> 2633</span>        flx3 = 0.0</div>
<div class="line"><a id="l02634" name="l02634"></a><span class="lineno"> 2634</span>        ex = 0.0</div>
<div class="line"><a id="l02635" name="l02635"></a><span class="lineno"> 2635</span>        snomlt = 0.0</div>
<div class="line"><a id="l02636" name="l02636"></a><span class="lineno"> 2636</span> </div>
<div class="line"><a id="l02637" name="l02637"></a><span class="lineno"> 2637</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l02638" name="l02638"></a><span class="lineno"> 2638</span> </div>
<div class="line"><a id="l02639" name="l02639"></a><span class="lineno"> 2639</span><span class="comment">!  --- ...  if the &#39;effective snow-grnd sfc temp&#39; is above freezing, snow melt</span></div>
<div class="line"><a id="l02640" name="l02640"></a><span class="lineno"> 2640</span><span class="comment">!           will occur.  call the snow melt rate,ex and amt, snomlt.  revise the</span></div>
<div class="line"><a id="l02641" name="l02641"></a><span class="lineno"> 2641</span><span class="comment">!           effective snow depth.  revise the skin temp because it would have chgd</span></div>
<div class="line"><a id="l02642" name="l02642"></a><span class="lineno"> 2642</span><span class="comment">!           due to the latent heat released by the melting. calc the latent heat</span></div>
<div class="line"><a id="l02643" name="l02643"></a><span class="lineno"> 2643</span><span class="comment">!           released, flx3. set the effective precip, prcp1 to the snow melt rate,</span></div>
<div class="line"><a id="l02644" name="l02644"></a><span class="lineno"> 2644</span><span class="comment">!           ex for use in smflx.  adjustment to t1 to account for snow patches.</span></div>
<div class="line"><a id="l02645" name="l02645"></a><span class="lineno"> 2645</span><span class="comment">!           calculate qsat valid at freezing point.  note that esat (saturation</span></div>
<div class="line"><a id="l02646" name="l02646"></a><span class="lineno"> 2646</span><span class="comment">!           vapor pressure) value of 6.11e+2 used here is that valid at frzzing</span></div>
<div class="line"><a id="l02647" name="l02647"></a><span class="lineno"> 2647</span><span class="comment">!           point.  note that etp from call penman in sflx is ignored here in</span></div>
<div class="line"><a id="l02648" name="l02648"></a><span class="lineno"> 2648</span><span class="comment">!           favor of bulk etp over &#39;open water&#39; at freezing temp.</span></div>
<div class="line"><a id="l02649" name="l02649"></a><span class="lineno"> 2649</span><span class="comment">!           update soil heat flux (s) using new skin temperature (t1)</span></div>
<div class="line"><a id="l02650" name="l02650"></a><span class="lineno"> 2650</span> </div>
<div class="line"><a id="l02651" name="l02651"></a><span class="lineno"> 2651</span><span class="comment">!  --- ...  noah v2.7.1   mek feb2004</span></div>
<div class="line"><a id="l02652" name="l02652"></a><span class="lineno"> 2652</span><span class="comment">!           non-linear weighting of snow vs non-snow covered portions of gridbox</span></div>
<div class="line"><a id="l02653" name="l02653"></a><span class="lineno"> 2653</span><span class="comment">!           so with snoexp = 2.0 (&gt;1), surface skin temperature is higher than</span></div>
<div class="line"><a id="l02654" name="l02654"></a><span class="lineno"> 2654</span><span class="comment">!           for the linear case (snoexp = 1).</span></div>
<div class="line"><a id="l02655" name="l02655"></a><span class="lineno"> 2655</span> </div>
<div class="line"><a id="l02656" name="l02656"></a><span class="lineno"> 2656</span><span class="comment">!       t1 = tfreez * sncovr**snoexp + t12 * (1.0 - sncovr**snoexp)</span></div>
<div class="line"><a id="l02657" name="l02657"></a><span class="lineno"> 2657</span>        t1 = tfreez * max(0.01,sncovr**snoexp) +                          &amp;</div>
<div class="line"><a id="l02658" name="l02658"></a><span class="lineno"> 2658</span>     &amp;          t12 * (1.0 - max(0.01,sncovr**snoexp))</div>
<div class="line"><a id="l02659" name="l02659"></a><span class="lineno"> 2659</span> </div>
<div class="line"><a id="l02660" name="l02660"></a><span class="lineno"> 2660</span>        beta = 1.0</div>
<div class="line"><a id="l02661" name="l02661"></a><span class="lineno"> 2661</span>        ssoil = df1 * (t1 - stc(1)) / dtot</div>
<div class="line"><a id="l02662" name="l02662"></a><span class="lineno"> 2662</span> </div>
<div class="line"><a id="l02663" name="l02663"></a><span class="lineno"> 2663</span><span class="comment">!  --- ...  if potential evap (sublimation) greater than depth of snowpack.</span></div>
<div class="line"><a id="l02664" name="l02664"></a><span class="lineno"> 2664</span><span class="comment">!           beta&lt;1</span></div>
<div class="line"><a id="l02665" name="l02665"></a><span class="lineno"> 2665</span><span class="comment">!           snowpack has sublimated away, set depth to zero.</span></div>
<div class="line"><a id="l02666" name="l02666"></a><span class="lineno"> 2666</span> </div>
<div class="line"><a id="l02667" name="l02667"></a><span class="lineno"> 2667</span>        <span class="keywordflow">if</span> (sneqv-esnow2 &lt;= esdmin) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02668" name="l02668"></a><span class="lineno"> 2668</span> </div>
<div class="line"><a id="l02669" name="l02669"></a><span class="lineno"> 2669</span>          sneqv = 0.0</div>
<div class="line"><a id="l02670" name="l02670"></a><span class="lineno"> 2670</span>          ex = 0.0</div>
<div class="line"><a id="l02671" name="l02671"></a><span class="lineno"> 2671</span>          snomlt = 0.0</div>
<div class="line"><a id="l02672" name="l02672"></a><span class="lineno"> 2672</span>          flx3 = 0.0</div>
<div class="line"><a id="l02673" name="l02673"></a><span class="lineno"> 2673</span> </div>
<div class="line"><a id="l02674" name="l02674"></a><span class="lineno"> 2674</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l02675" name="l02675"></a><span class="lineno"> 2675</span> </div>
<div class="line"><a id="l02676" name="l02676"></a><span class="lineno"> 2676</span><span class="comment">!  --- ...  potential evap (sublimation) less than depth of snowpack, retain</span></div>
<div class="line"><a id="l02677" name="l02677"></a><span class="lineno"> 2677</span><span class="comment">!           beta=1.</span></div>
<div class="line"><a id="l02678" name="l02678"></a><span class="lineno"> 2678</span> </div>
<div class="line"><a id="l02679" name="l02679"></a><span class="lineno"> 2679</span>          sneqv = sneqv - esnow2</div>
<div class="line"><a id="l02680" name="l02680"></a><span class="lineno"> 2680</span>          seh = rch * (t1 - th2)</div>
<div class="line"><a id="l02681" name="l02681"></a><span class="lineno"> 2681</span> </div>
<div class="line"><a id="l02682" name="l02682"></a><span class="lineno"> 2682</span>          t14 = t1 * t1</div>
<div class="line"><a id="l02683" name="l02683"></a><span class="lineno"> 2683</span>          t14 = t14 * t14</div>
<div class="line"><a id="l02684" name="l02684"></a><span class="lineno"> 2684</span> </div>
<div class="line"><a id="l02685" name="l02685"></a><span class="lineno"> 2685</span>          flx3 = fdown - flx1 - flx2 - sfcems*sigma1*t14                &amp;</div>
<div class="line"><a id="l02686" name="l02686"></a><span class="lineno"> 2686</span>     &amp;         - ssoil - seh - etanrg</div>
<div class="line"><a id="l02687" name="l02687"></a><span class="lineno"> 2687</span>          <span class="keywordflow">if</span> (flx3 &lt;= 0.0) flx3 = 0.0</div>
<div class="line"><a id="l02688" name="l02688"></a><span class="lineno"> 2688</span> </div>
<div class="line"><a id="l02689" name="l02689"></a><span class="lineno"> 2689</span>          ex = flx3 * 0.001 / lsubf</div>
<div class="line"><a id="l02690" name="l02690"></a><span class="lineno"> 2690</span> </div>
<div class="line"><a id="l02691" name="l02691"></a><span class="lineno"> 2691</span><span class="comment">!  --- ...  snowmelt reduction depending on snow cover</span></div>
<div class="line"><a id="l02692" name="l02692"></a><span class="lineno"> 2692</span><span class="comment">!           if snow cover less than 5% no snowmelt reduction</span></div>
<div class="line"><a id="l02693" name="l02693"></a><span class="lineno"> 2693</span><span class="comment">!     note: does &#39;if&#39; below fail to match the melt water with the melt</span></div>
<div class="line"><a id="l02694" name="l02694"></a><span class="lineno"> 2694</span><span class="comment">!           energy?</span></div>
<div class="line"><a id="l02695" name="l02695"></a><span class="lineno"> 2695</span> </div>
<div class="line"><a id="l02696" name="l02696"></a><span class="lineno"> 2696</span><span class="comment">!         if (sncovr &gt; 0.05) ex = ex * sncovr</span></div>
<div class="line"><a id="l02697" name="l02697"></a><span class="lineno"> 2697</span>          snomlt = ex * dt</div>
<div class="line"><a id="l02698" name="l02698"></a><span class="lineno"> 2698</span> </div>
<div class="line"><a id="l02699" name="l02699"></a><span class="lineno"> 2699</span><span class="comment">!  --- ...  esdmin represents a snowpack depth threshold value below which we</span></div>
<div class="line"><a id="l02700" name="l02700"></a><span class="lineno"> 2700</span><span class="comment">!           choose not to retain any snowpack, and instead include it in snowmelt.</span></div>
<div class="line"><a id="l02701" name="l02701"></a><span class="lineno"> 2701</span> </div>
<div class="line"><a id="l02702" name="l02702"></a><span class="lineno"> 2702</span>          <span class="keywordflow">if</span> (sneqv-snomlt &gt;= esdmin) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02703" name="l02703"></a><span class="lineno"> 2703</span> </div>
<div class="line"><a id="l02704" name="l02704"></a><span class="lineno"> 2704</span>            sneqv = sneqv - snomlt</div>
<div class="line"><a id="l02705" name="l02705"></a><span class="lineno"> 2705</span> </div>
<div class="line"><a id="l02706" name="l02706"></a><span class="lineno"> 2706</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l02707" name="l02707"></a><span class="lineno"> 2707</span> </div>
<div class="line"><a id="l02708" name="l02708"></a><span class="lineno"> 2708</span><span class="comment">!  --- ...  snowmelt exceeds snow depth</span></div>
<div class="line"><a id="l02709" name="l02709"></a><span class="lineno"> 2709</span> </div>
<div class="line"><a id="l02710" name="l02710"></a><span class="lineno"> 2710</span>            ex = sneqv / dt</div>
<div class="line"><a id="l02711" name="l02711"></a><span class="lineno"> 2711</span>            flx3 = ex * 1000.0 * lsubf</div>
<div class="line"><a id="l02712" name="l02712"></a><span class="lineno"> 2712</span>            snomlt = sneqv</div>
<div class="line"><a id="l02713" name="l02713"></a><span class="lineno"> 2713</span>            sneqv = 0.0</div>
<div class="line"><a id="l02714" name="l02714"></a><span class="lineno"> 2714</span> </div>
<div class="line"><a id="l02715" name="l02715"></a><span class="lineno"> 2715</span><span class="keywordflow">          endif</span>   <span class="comment">! end if_sneqv-snomlt_block</span></div>
<div class="line"><a id="l02716" name="l02716"></a><span class="lineno"> 2716</span> </div>
<div class="line"><a id="l02717" name="l02717"></a><span class="lineno"> 2717</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_sneqv-esnow2_block</span></div>
<div class="line"><a id="l02718" name="l02718"></a><span class="lineno"> 2718</span> </div>
<div class="line"><a id="l02719" name="l02719"></a><span class="lineno"> 2719</span><span class="comment">!       prcp1 = prcp1 + ex</span></div>
<div class="line"><a id="l02720" name="l02720"></a><span class="lineno"> 2720</span> </div>
<div class="line"><a id="l02721" name="l02721"></a><span class="lineno"> 2721</span><span class="comment">!  --- ...  if non-glacial land, add snowmelt rate (ex) to precip rate to be used</span></div>
<div class="line"><a id="l02722" name="l02722"></a><span class="lineno"> 2722</span><span class="comment">!           in subroutine smflx (soil moisture evolution) via infiltration.</span></div>
<div class="line"><a id="l02723" name="l02723"></a><span class="lineno"> 2723</span> </div>
<div class="line"><a id="l02724" name="l02724"></a><span class="lineno"> 2724</span><span class="comment">!  --- ...  for sea-ice and glacial-ice, the snowmelt will be added to subsurface</span></div>
<div class="line"><a id="l02725" name="l02725"></a><span class="lineno"> 2725</span><span class="comment">!           runoff/baseflow later near the end of sflx (after return from call to</span></div>
<div class="line"><a id="l02726" name="l02726"></a><span class="lineno"> 2726</span><span class="comment">!           subroutine snopac)</span></div>
<div class="line"><a id="l02727" name="l02727"></a><span class="lineno"> 2727</span> </div>
<div class="line"><a id="l02728" name="l02728"></a><span class="lineno"> 2728</span>        <span class="keywordflow">if</span> (ice == 0) prcp1 = prcp1 + ex</div>
<div class="line"><a id="l02729" name="l02729"></a><span class="lineno"> 2729</span> </div>
<div class="line"><a id="l02730" name="l02730"></a><span class="lineno"> 2730</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_t12&lt;=tfreez_block</span></div>
<div class="line"><a id="l02731" name="l02731"></a><span class="lineno"> 2731</span> </div>
<div class="line"><a id="l02732" name="l02732"></a><span class="lineno"> 2732</span><span class="comment">!  --- ...  final beta now in hand, so compute evaporation.  evap equals etp</span></div>
<div class="line"><a id="l02733" name="l02733"></a><span class="lineno"> 2733</span><span class="comment">!           unless beta&lt;1.</span></div>
<div class="line"><a id="l02734" name="l02734"></a><span class="lineno"> 2734</span> </div>
<div class="line"><a id="l02735" name="l02735"></a><span class="lineno"> 2735</span><span class="comment">!      eta = beta * etp</span></div>
<div class="line"><a id="l02736" name="l02736"></a><span class="lineno"> 2736</span> </div>
<div class="line"><a id="l02737" name="l02737"></a><span class="lineno"> 2737</span><span class="comment">!  --- ...  smflx returns updated soil moisture values for non-glacial land.</span></div>
<div class="line"><a id="l02738" name="l02738"></a><span class="lineno"> 2738</span><span class="comment">!           if sea-ice (ice=1) or glacial-ice (ice=-1), skip call to smflx, since</span></div>
<div class="line"><a id="l02739" name="l02739"></a><span class="lineno"> 2739</span><span class="comment">!           no soil medium for sea-ice or glacial-ice</span></div>
<div class="line"><a id="l02740" name="l02740"></a><span class="lineno"> 2740</span> </div>
<div class="line"><a id="l02741" name="l02741"></a><span class="lineno"> 2741</span>      <span class="keywordflow">if</span> (ice == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02742" name="l02742"></a><span class="lineno"> 2742</span> </div>
<div class="line"><a id="l02743" name="l02743"></a><span class="lineno"> 2743</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gafa3e5637e56746e2539ef2567836defa.html#gafa3e5637e56746e2539ef2567836defa">smflx</a>                                                        &amp;</div>
<div class="line"><a id="l02744" name="l02744"></a><span class="lineno"> 2744</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02745" name="l02745"></a><span class="lineno"> 2745</span>     &amp;     ( nsoil, dt, kdt, smcmax, smcwlt, cmcmax, prcp1,               &amp;</div>
<div class="line"><a id="l02746" name="l02746"></a><span class="lineno"> 2746</span>     &amp;       zsoil, slope, frzx, bexp, dksat, dwsat, shdfac,              &amp;</div>
<div class="line"><a id="l02747" name="l02747"></a><span class="lineno"> 2747</span>     &amp;       edir1, ec1, et1,                                             &amp;</div>
<div class="line"><a id="l02748" name="l02748"></a><span class="lineno"> 2748</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02749" name="l02749"></a><span class="lineno"> 2749</span>     &amp;       cmc, sh2o, smc,                                              &amp;</div>
<div class="line"><a id="l02750" name="l02750"></a><span class="lineno"> 2750</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l02751" name="l02751"></a><span class="lineno"> 2751</span>     &amp;       runoff1, runoff2, runoff3, drip                              &amp;</div>
<div class="line"><a id="l02752" name="l02752"></a><span class="lineno"> 2752</span>     &amp;     )</div>
<div class="line"><a id="l02753" name="l02753"></a><span class="lineno"> 2753</span> </div>
<div class="line"><a id="l02754" name="l02754"></a><span class="lineno"> 2754</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l02755" name="l02755"></a><span class="lineno"> 2755</span> </div>
<div class="line"><a id="l02756" name="l02756"></a><span class="lineno"> 2756</span><span class="comment">!  --- ...  before call shflx in this snowpack case, set zz1 and yy arguments to</span></div>
<div class="line"><a id="l02757" name="l02757"></a><span class="lineno"> 2757</span><span class="comment">!           special values that ensure that ground heat flux calculated in shflx</span></div>
<div class="line"><a id="l02758" name="l02758"></a><span class="lineno"> 2758</span><span class="comment">!           matches that already computed for below the snowpack, thus the sfc</span></div>
<div class="line"><a id="l02759" name="l02759"></a><span class="lineno"> 2759</span><span class="comment">!           heat flux to be computed in shflx will effectively be the flux at the</span></div>
<div class="line"><a id="l02760" name="l02760"></a><span class="lineno"> 2760</span><span class="comment">!           snow top surface.  t11 is a dummy arguement so we will not use the</span></div>
<div class="line"><a id="l02761" name="l02761"></a><span class="lineno"> 2761</span><span class="comment">!           skin temp value as revised by shflx.</span></div>
<div class="line"><a id="l02762" name="l02762"></a><span class="lineno"> 2762</span> </div>
<div class="line"><a id="l02763" name="l02763"></a><span class="lineno"> 2763</span>      zz1 = 1.0</div>
<div class="line"><a id="l02764" name="l02764"></a><span class="lineno"> 2764</span>      yy  = stc(1) - 0.5*ssoil*zsoil(1)*zz1 / df1</div>
<div class="line"><a id="l02765" name="l02765"></a><span class="lineno"> 2765</span>      t11 = t1</div>
<div class="line"><a id="l02766" name="l02766"></a><span class="lineno"> 2766</span> </div>
<div class="line"><a id="l02767" name="l02767"></a><span class="lineno"> 2767</span><span class="comment">!  --- ...  shflx will calc/update the soil temps.  note:  the sub-sfc heat flux</span></div>
<div class="line"><a id="l02768" name="l02768"></a><span class="lineno"> 2768</span><span class="comment">!           (ssoil1) and the skin temp (t11) output from this shflx call are not</span></div>
<div class="line"><a id="l02769" name="l02769"></a><span class="lineno"> 2769</span><span class="comment">!           used  in any subsequent calculations. rather, they are dummy variables</span></div>
<div class="line"><a id="l02770" name="l02770"></a><span class="lineno"> 2770</span><span class="comment">!           here in the snopac case, since the skin temp and sub-sfc heat flux are</span></div>
<div class="line"><a id="l02771" name="l02771"></a><span class="lineno"> 2771</span><span class="comment">!           updated instead near the beginning of the call to snopac.</span></div>
<div class="line"><a id="l02772" name="l02772"></a><span class="lineno"> 2772</span> </div>
<div class="line"><a id="l02773" name="l02773"></a><span class="lineno"> 2773</span>      <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga977daabf4ff68b28fc5ccd8796d815cd.html#ga977daabf4ff68b28fc5ccd8796d815cd">shflx</a>                                                        &amp;</div>
<div class="line"><a id="l02774" name="l02774"></a><span class="lineno"> 2774</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02775" name="l02775"></a><span class="lineno"> 2775</span>     &amp;     ( nsoil, smc, smcmax, dt, yy, zz1, zsoil, zbot,              &amp;</div>
<div class="line"><a id="l02776" name="l02776"></a><span class="lineno"> 2776</span>     &amp;       psisat, bexp, df1, ice, quartz, csoil, vegtyp,             &amp;</div>
<div class="line"><a id="l02777" name="l02777"></a><span class="lineno"> 2777</span>     &amp;       shdfac, lheatstrg,                                         &amp;</div>
<div class="line"><a id="l02778" name="l02778"></a><span class="lineno"> 2778</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02779" name="l02779"></a><span class="lineno"> 2779</span>     &amp;       stc, t11, tbot, sh2o,                                      &amp;</div>
<div class="line"><a id="l02780" name="l02780"></a><span class="lineno"> 2780</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l02781" name="l02781"></a><span class="lineno"> 2781</span>     &amp;       ssoil1                                                     &amp;</div>
<div class="line"><a id="l02782" name="l02782"></a><span class="lineno"> 2782</span>     &amp;     )</div>
<div class="line"><a id="l02783" name="l02783"></a><span class="lineno"> 2783</span> </div>
<div class="line"><a id="l02784" name="l02784"></a><span class="lineno"> 2784</span><span class="comment">!  --- ...  snow depth and density adjustment based on snow compaction.  yy is</span></div>
<div class="line"><a id="l02785" name="l02785"></a><span class="lineno"> 2785</span><span class="comment">!           assumed to be the soil temperture at the top of the soil column.</span></div>
<div class="line"><a id="l02786" name="l02786"></a><span class="lineno"> 2786</span> </div>
<div class="line"><a id="l02787" name="l02787"></a><span class="lineno"> 2787</span>      <span class="keywordflow">if</span> (ice == 0) <span class="keywordflow">then</span>              <span class="comment">! for non-glacial land</span></div>
<div class="line"><a id="l02788" name="l02788"></a><span class="lineno"> 2788</span> </div>
<div class="line"><a id="l02789" name="l02789"></a><span class="lineno"> 2789</span>        <span class="keywordflow">if</span> (sneqv &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02790" name="l02790"></a><span class="lineno"> 2790</span> </div>
<div class="line"><a id="l02791" name="l02791"></a><span class="lineno"> 2791</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gab5149f309f4e291435f75dd63d4a97ac.html#gab5149f309f4e291435f75dd63d4a97ac">snowpack</a>                                                 &amp;</div>
<div class="line"><a id="l02792" name="l02792"></a><span class="lineno"> 2792</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02793" name="l02793"></a><span class="lineno"> 2793</span>     &amp;     ( sneqv, dt, t1, yy,                                         &amp;</div>
<div class="line"><a id="l02794" name="l02794"></a><span class="lineno"> 2794</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02795" name="l02795"></a><span class="lineno"> 2795</span>     &amp;       snowh, sndens                                              &amp;</div>
<div class="line"><a id="l02796" name="l02796"></a><span class="lineno"> 2796</span>     &amp;     )</div>
<div class="line"><a id="l02797" name="l02797"></a><span class="lineno"> 2797</span> </div>
<div class="line"><a id="l02798" name="l02798"></a><span class="lineno"> 2798</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l02799" name="l02799"></a><span class="lineno"> 2799</span> </div>
<div class="line"><a id="l02800" name="l02800"></a><span class="lineno"> 2800</span>          sneqv = 0.0</div>
<div class="line"><a id="l02801" name="l02801"></a><span class="lineno"> 2801</span>          snowh = 0.0</div>
<div class="line"><a id="l02802" name="l02802"></a><span class="lineno"> 2802</span>          sndens = 0.0</div>
<div class="line"><a id="l02803" name="l02803"></a><span class="lineno"> 2803</span><span class="comment">!         sncond = 1.0</span></div>
<div class="line"><a id="l02804" name="l02804"></a><span class="lineno"> 2804</span>          sncovr = 0.0</div>
<div class="line"><a id="l02805" name="l02805"></a><span class="lineno"> 2805</span> </div>
<div class="line"><a id="l02806" name="l02806"></a><span class="lineno"> 2806</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_sneqv_block</span></div>
<div class="line"><a id="l02807" name="l02807"></a><span class="lineno"> 2807</span> </div>
<div class="line"><a id="l02808" name="l02808"></a><span class="lineno"> 2808</span><span class="comment">!  --- ...  over sea-ice or glacial-ice, if s.w.e. (sneqv) below threshold lower</span></div>
<div class="line"><a id="l02809" name="l02809"></a><span class="lineno"> 2809</span><span class="comment">!           bound (0.01 m for sea-ice, 0.10 m for glacial-ice), then set at</span></div>
<div class="line"><a id="l02810" name="l02810"></a><span class="lineno"> 2810</span><span class="comment">!           lower bound and store the source increment in subsurface runoff/</span></div>
<div class="line"><a id="l02811" name="l02811"></a><span class="lineno"> 2811</span><span class="comment">!           baseflow (runoff2).  note:  runoff2 is then a negative value (as</span></div>
<div class="line"><a id="l02812" name="l02812"></a><span class="lineno"> 2812</span><span class="comment">!           a flag) over sea-ice or glacial-ice, in order to achieve water balance.</span></div>
<div class="line"><a id="l02813" name="l02813"></a><span class="lineno"> 2813</span> </div>
<div class="line"><a id="l02814" name="l02814"></a><span class="lineno"> 2814</span>      <span class="keywordflow">elseif</span> (ice == 1) <span class="keywordflow">then</span>          <span class="comment">! for sea-ice</span></div>
<div class="line"><a id="l02815" name="l02815"></a><span class="lineno"> 2815</span> </div>
<div class="line"><a id="l02816" name="l02816"></a><span class="lineno"> 2816</span>        <span class="keywordflow">if</span> (sneqv &gt;= 0.01) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02817" name="l02817"></a><span class="lineno"> 2817</span> </div>
<div class="line"><a id="l02818" name="l02818"></a><span class="lineno"> 2818</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gab5149f309f4e291435f75dd63d4a97ac.html#gab5149f309f4e291435f75dd63d4a97ac">snowpack</a>                                                 &amp;</div>
<div class="line"><a id="l02819" name="l02819"></a><span class="lineno"> 2819</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02820" name="l02820"></a><span class="lineno"> 2820</span>     &amp;     ( sneqv, dt, t1, yy,                                         &amp;</div>
<div class="line"><a id="l02821" name="l02821"></a><span class="lineno"> 2821</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02822" name="l02822"></a><span class="lineno"> 2822</span>     &amp;       snowh, sndens                                              &amp;</div>
<div class="line"><a id="l02823" name="l02823"></a><span class="lineno"> 2823</span>     &amp;     )</div>
<div class="line"><a id="l02824" name="l02824"></a><span class="lineno"> 2824</span> </div>
<div class="line"><a id="l02825" name="l02825"></a><span class="lineno"> 2825</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l02826" name="l02826"></a><span class="lineno"> 2826</span> </div>
<div class="line"><a id="l02827" name="l02827"></a><span class="lineno"> 2827</span><span class="comment">!         sndens = sneqv / snowh</span></div>
<div class="line"><a id="l02828" name="l02828"></a><span class="lineno"> 2828</span><span class="comment">!         runoff2 = -(0.01 - sneqv) / dt</span></div>
<div class="line"><a id="l02829" name="l02829"></a><span class="lineno"> 2829</span>          sneqv = 0.01</div>
<div class="line"><a id="l02830" name="l02830"></a><span class="lineno"> 2830</span>          snowh = 0.05</div>
<div class="line"><a id="l02831" name="l02831"></a><span class="lineno"> 2831</span>          sncovr = 1.0</div>
<div class="line"><a id="l02832" name="l02832"></a><span class="lineno"> 2832</span><span class="comment">!         snowh = sneqv / sndens</span></div>
<div class="line"><a id="l02833" name="l02833"></a><span class="lineno"> 2833</span> </div>
<div class="line"><a id="l02834" name="l02834"></a><span class="lineno"> 2834</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_sneqv_block</span></div>
<div class="line"><a id="l02835" name="l02835"></a><span class="lineno"> 2835</span> </div>
<div class="line"><a id="l02836" name="l02836"></a><span class="lineno"> 2836</span>      <span class="keywordflow">else</span>                            <span class="comment">! for glacial-ice</span></div>
<div class="line"><a id="l02837" name="l02837"></a><span class="lineno"> 2837</span> </div>
<div class="line"><a id="l02838" name="l02838"></a><span class="lineno"> 2838</span>        <span class="keywordflow">if</span> (sneqv &gt;= 0.10) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02839" name="l02839"></a><span class="lineno"> 2839</span> </div>
<div class="line"><a id="l02840" name="l02840"></a><span class="lineno"> 2840</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gab5149f309f4e291435f75dd63d4a97ac.html#gab5149f309f4e291435f75dd63d4a97ac">snowpack</a>                                                 &amp;</div>
<div class="line"><a id="l02841" name="l02841"></a><span class="lineno"> 2841</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02842" name="l02842"></a><span class="lineno"> 2842</span>     &amp;     ( sneqv, dt, t1, yy,                                         &amp;</div>
<div class="line"><a id="l02843" name="l02843"></a><span class="lineno"> 2843</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02844" name="l02844"></a><span class="lineno"> 2844</span>     &amp;       snowh, sndens                                              &amp;</div>
<div class="line"><a id="l02845" name="l02845"></a><span class="lineno"> 2845</span>     &amp;     )</div>
<div class="line"><a id="l02846" name="l02846"></a><span class="lineno"> 2846</span> </div>
<div class="line"><a id="l02847" name="l02847"></a><span class="lineno"> 2847</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l02848" name="l02848"></a><span class="lineno"> 2848</span> </div>
<div class="line"><a id="l02849" name="l02849"></a><span class="lineno"> 2849</span><span class="comment">!         sndens = sneqv / snowh</span></div>
<div class="line"><a id="l02850" name="l02850"></a><span class="lineno"> 2850</span><span class="comment">!         runoff2 = -(0.10 - sneqv) / dt</span></div>
<div class="line"><a id="l02851" name="l02851"></a><span class="lineno"> 2851</span>          sneqv = 0.10</div>
<div class="line"><a id="l02852" name="l02852"></a><span class="lineno"> 2852</span>          snowh = 0.50</div>
<div class="line"><a id="l02853" name="l02853"></a><span class="lineno"> 2853</span>          sncovr = 1.0</div>
<div class="line"><a id="l02854" name="l02854"></a><span class="lineno"> 2854</span><span class="comment">!         snowh = sneqv / sndens</span></div>
<div class="line"><a id="l02855" name="l02855"></a><span class="lineno"> 2855</span> </div>
<div class="line"><a id="l02856" name="l02856"></a><span class="lineno"> 2856</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_sneqv_block</span></div>
<div class="line"><a id="l02857" name="l02857"></a><span class="lineno"> 2857</span> </div>
<div class="line"><a id="l02858" name="l02858"></a><span class="lineno"> 2858</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_ice_block</span></div>
<div class="line"><a id="l02859" name="l02859"></a><span class="lineno"> 2859</span> </div>
<div class="line"><a id="l02860" name="l02860"></a><span class="lineno"> 2860</span><span class="comment">!</span></div>
<div class="line"><a id="l02861" name="l02861"></a><span class="lineno"> 2861</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l02862" name="l02862"></a><span class="lineno"> 2862</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gad65a889bf3f431ade2a312674671ab41.html#gad65a889bf3f431ade2a312674671ab41">snopac</a></div>
<div class="line"><a id="l02863" name="l02863"></a><span class="lineno"> 2863</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l02864" name="l02864"></a><span class="lineno"> 2864</span> </div>
<div class="line"><a id="l02865" name="l02865"></a><span class="lineno"> 2865</span> </div>
<div class="line"><a id="l02866" name="l02866"></a><span class="lineno"> 2866</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l02867" name="l02867"></a><span class="lineno"> 2867</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l02868" name="l02868"></a><span class="lineno"> 2868</span><span class="comment">!&gt; This subroutine calculates snow depth and densitity to account</span></div>
<div class="line"><a id="l02869" name="l02869"></a><span class="lineno"> 2869</span><span class="comment">!! for the new snowfall. new values of snow depth &amp; density returned.</span></div>
<div class="foldopen" id="foldopen02870" data-start="" data-end="">
<div class="line"><a id="l02870" name="l02870"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gab816dbe84c4db91178251b08553c6d02.html#gab816dbe84c4db91178251b08553c6d02"> 2870</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gab816dbe84c4db91178251b08553c6d02.html#gab816dbe84c4db91178251b08553c6d02">snow_new</a></div>
<div class="line"><a id="l02871" name="l02871"></a><span class="lineno"> 2871</span><span class="comment">!...................................</span></div>
<div class="line"><a id="l02872" name="l02872"></a><span class="lineno"> 2872</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02873" name="l02873"></a><span class="lineno"> 2873</span><span class="comment">!    &amp;     ( sfctmp, sn_new, rhonewsn, exticeden,                       &amp;</span></div>
<div class="line"><a id="l02874" name="l02874"></a><span class="lineno"> 2874</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02875" name="l02875"></a><span class="lineno"> 2875</span><span class="comment">!    &amp;       snowh, sndens                                              &amp;</span></div>
<div class="line"><a id="l02876" name="l02876"></a><span class="lineno"> 2876</span><span class="comment">!    &amp;     )</span></div>
<div class="line"><a id="l02877" name="l02877"></a><span class="lineno"> 2877</span> </div>
<div class="line"><a id="l02878" name="l02878"></a><span class="lineno"> 2878</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l02879" name="l02879"></a><span class="lineno"> 2879</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l02880" name="l02880"></a><span class="lineno"> 2880</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02881" name="l02881"></a><span class="lineno"> 2881</span><span class="comment">!    subroutine snow_new calculates snow depth and densitity to account !</span></div>
<div class="line"><a id="l02882" name="l02882"></a><span class="lineno"> 2882</span><span class="comment">!    for the new snowfall. new values of snow depth &amp; density returned. !</span></div>
<div class="line"><a id="l02883" name="l02883"></a><span class="lineno"> 2883</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02884" name="l02884"></a><span class="lineno"> 2884</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l02885" name="l02885"></a><span class="lineno"> 2885</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02886" name="l02886"></a><span class="lineno"> 2886</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l02887" name="l02887"></a><span class="lineno"> 2887</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02888" name="l02888"></a><span class="lineno"> 2888</span><span class="comment">!  inputs from the calling program:                              size   !</span></div>
<div class="line"><a id="l02889" name="l02889"></a><span class="lineno"> 2889</span><span class="comment">!     sfctmp   - real, surface air temperature (k)                 1    !</span></div>
<div class="line"><a id="l02890" name="l02890"></a><span class="lineno"> 2890</span><span class="comment">!     sn_new   - real, new snowfall (m)                            1    !</span></div>
<div class="line"><a id="l02891" name="l02891"></a><span class="lineno"> 2891</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02892" name="l02892"></a><span class="lineno"> 2892</span><span class="comment">!  input/outputs from and to the calling program:                       !</span></div>
<div class="line"><a id="l02893" name="l02893"></a><span class="lineno"> 2893</span><span class="comment">!     snowh    - real, snow depth (m)                              1    !</span></div>
<div class="line"><a id="l02894" name="l02894"></a><span class="lineno"> 2894</span><span class="comment">!     sndens   - real, snow density                                1    !</span></div>
<div class="line"><a id="l02895" name="l02895"></a><span class="lineno"> 2895</span><span class="comment">!                      (g/cm3=dimensionless fraction of h2o density)    !</span></div>
<div class="line"><a id="l02896" name="l02896"></a><span class="lineno"> 2896</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02897" name="l02897"></a><span class="lineno"> 2897</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l02898" name="l02898"></a><span class="lineno"> 2898</span><span class="comment">!</span></div>
<div class="line"><a id="l02899" name="l02899"></a><span class="lineno"> 2899</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02900" name="l02900"></a><span class="lineno"> 2900</span><span class="comment">!     real(kind=kind_phys), intent(in) :: sfctmp, sn_new</span></div>
<div class="line"><a id="l02901" name="l02901"></a><span class="lineno"> 2901</span> </div>
<div class="line"><a id="l02902" name="l02902"></a><span class="lineno"> 2902</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02903" name="l02903"></a><span class="lineno"> 2903</span><span class="comment">!     real(kind=kind_phys), intent(inout) :: snowh, sndens</span></div>
<div class="line"><a id="l02904" name="l02904"></a><span class="lineno"> 2904</span> </div>
<div class="line"><a id="l02905" name="l02905"></a><span class="lineno"> 2905</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l02906" name="l02906"></a><span class="lineno"> 2906</span><span class="keywordtype">      real</span>(kind=kind_phys) :: dsnew, snowhc, hnewc, newsnc, tempc</div>
<div class="line"><a id="l02907" name="l02907"></a><span class="lineno"> 2907</span> </div>
<div class="line"><a id="l02908" name="l02908"></a><span class="lineno"> 2908</span><span class="comment">!</span></div>
<div class="line"><a id="l02909" name="l02909"></a><span class="lineno"> 2909</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l02910" name="l02910"></a><span class="lineno"> 2910</span><span class="comment">!</span></div>
<div class="line"><a id="l02911" name="l02911"></a><span class="lineno"> 2911</span><span class="comment">!  --- ...  conversion into simulation units</span></div>
<div class="line"><a id="l02912" name="l02912"></a><span class="lineno"> 2912</span> </div>
<div class="line"><a id="l02913" name="l02913"></a><span class="lineno"> 2913</span>      snowhc = snowh * 100.0</div>
<div class="line"><a id="l02914" name="l02914"></a><span class="lineno"> 2914</span>      newsnc = sn_new * 100.0</div>
<div class="line"><a id="l02915" name="l02915"></a><span class="lineno"> 2915</span>      tempc  = sfctmp - tfreez</div>
<div class="line"><a id="l02916" name="l02916"></a><span class="lineno"> 2916</span> </div>
<div class="line"><a id="l02917" name="l02917"></a><span class="lineno"> 2917</span><span class="comment">!  --- ...  calculating new snowfall density depending on temperature</span></div>
<div class="line"><a id="l02918" name="l02918"></a><span class="lineno"> 2918</span><span class="comment">!           equation from gottlib l. &#39;a general runoff model for</span></div>
<div class="line"><a id="l02919" name="l02919"></a><span class="lineno"> 2919</span><span class="comment">!           snowcovered and glacierized basin&#39;, 6th nordic hydrological</span></div>
<div class="line"><a id="l02920" name="l02920"></a><span class="lineno"> 2920</span><span class="comment">!           conference, vemadolen, sweden, 1980, 172-177pp.</span></div>
<div class="line"><a id="l02921" name="l02921"></a><span class="lineno"> 2921</span> </div>
<div class="line"><a id="l02922" name="l02922"></a><span class="lineno"> 2922</span>      <span class="keywordflow">if</span>(.not. exticeden) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02923" name="l02923"></a><span class="lineno"> 2923</span>         <span class="keywordflow">if</span> (tempc &lt;= -15.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l02924" name="l02924"></a><span class="lineno"> 2924</span>            dsnew = 0.05</div>
<div class="line"><a id="l02925" name="l02925"></a><span class="lineno"> 2925</span>         <span class="keywordflow">else</span></div>
<div class="line"><a id="l02926" name="l02926"></a><span class="lineno"> 2926</span>            dsnew = 0.05 + 0.0017*(tempc + 15.0)**1.5</div>
<div class="line"><a id="l02927" name="l02927"></a><span class="lineno"> 2927</span><span class="keywordflow">         endif</span></div>
<div class="line"><a id="l02928" name="l02928"></a><span class="lineno"> 2928</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l02929" name="l02929"></a><span class="lineno"> 2929</span>         dsnew = rhonewsn*0.001</div>
<div class="line"><a id="l02930" name="l02930"></a><span class="lineno"> 2930</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l02931" name="l02931"></a><span class="lineno"> 2931</span> </div>
<div class="line"><a id="l02932" name="l02932"></a><span class="lineno"> 2932</span><span class="comment">!  --- ...  adjustment of snow density depending on new snowfall</span></div>
<div class="line"><a id="l02933" name="l02933"></a><span class="lineno"> 2933</span> </div>
<div class="line"><a id="l02934" name="l02934"></a><span class="lineno"> 2934</span>      hnewc  = newsnc / dsnew</div>
<div class="line"><a id="l02935" name="l02935"></a><span class="lineno"> 2935</span>      sndens = (snowhc*sndens + hnewc*dsnew) / (snowhc + hnewc)</div>
<div class="line"><a id="l02936" name="l02936"></a><span class="lineno"> 2936</span>      snowhc = snowhc + hnewc</div>
<div class="line"><a id="l02937" name="l02937"></a><span class="lineno"> 2937</span>      snowh  = snowhc * 0.01</div>
<div class="line"><a id="l02938" name="l02938"></a><span class="lineno"> 2938</span><span class="comment">!</span></div>
<div class="line"><a id="l02939" name="l02939"></a><span class="lineno"> 2939</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l02940" name="l02940"></a><span class="lineno"> 2940</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gab816dbe84c4db91178251b08553c6d02.html#gab816dbe84c4db91178251b08553c6d02">snow_new</a></div>
<div class="line"><a id="l02941" name="l02941"></a><span class="lineno"> 2941</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l02942" name="l02942"></a><span class="lineno"> 2942</span> </div>
<div class="line"><a id="l02943" name="l02943"></a><span class="lineno"> 2943</span> </div>
<div class="line"><a id="l02944" name="l02944"></a><span class="lineno"> 2944</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l02945" name="l02945"></a><span class="lineno"> 2945</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l02946" name="l02946"></a><span class="lineno"> 2946</span><span class="comment">!&gt; This subroutine calculates total roughness length over snow.</span></div>
<div class="foldopen" id="foldopen02947" data-start="" data-end="">
<div class="line"><a id="l02947" name="l02947"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga95d889f436d70014fe640fa1b2420545.html#ga95d889f436d70014fe640fa1b2420545"> 2947</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga95d889f436d70014fe640fa1b2420545.html#ga95d889f436d70014fe640fa1b2420545">snowz0</a></div>
<div class="line"><a id="l02948" name="l02948"></a><span class="lineno"> 2948</span><span class="comment">!...................................</span></div>
<div class="line"><a id="l02949" name="l02949"></a><span class="lineno"> 2949</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02950" name="l02950"></a><span class="lineno"> 2950</span><span class="comment">!    &amp;     ( sncovr,                                                    &amp;</span></div>
<div class="line"><a id="l02951" name="l02951"></a><span class="lineno"> 2951</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02952" name="l02952"></a><span class="lineno"> 2952</span><span class="comment">!    &amp;       z0                                                         &amp;</span></div>
<div class="line"><a id="l02953" name="l02953"></a><span class="lineno"> 2953</span><span class="comment">!    &amp;     )</span></div>
<div class="line"><a id="l02954" name="l02954"></a><span class="lineno"> 2954</span> </div>
<div class="line"><a id="l02955" name="l02955"></a><span class="lineno"> 2955</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l02956" name="l02956"></a><span class="lineno"> 2956</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l02957" name="l02957"></a><span class="lineno"> 2957</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02958" name="l02958"></a><span class="lineno"> 2958</span><span class="comment">!    subroutine snowz0 calculates total roughness length over snow      !</span></div>
<div class="line"><a id="l02959" name="l02959"></a><span class="lineno"> 2959</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02960" name="l02960"></a><span class="lineno"> 2960</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l02961" name="l02961"></a><span class="lineno"> 2961</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02962" name="l02962"></a><span class="lineno"> 2962</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l02963" name="l02963"></a><span class="lineno"> 2963</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02964" name="l02964"></a><span class="lineno"> 2964</span><span class="comment">!  inputs from the calling program:                              size   !</span></div>
<div class="line"><a id="l02965" name="l02965"></a><span class="lineno"> 2965</span><span class="comment">!     sncovr   - real, fractional snow cover                       1    !</span></div>
<div class="line"><a id="l02966" name="l02966"></a><span class="lineno"> 2966</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02967" name="l02967"></a><span class="lineno"> 2967</span><span class="comment">!  input/outputs from and to the calling program:                       !</span></div>
<div class="line"><a id="l02968" name="l02968"></a><span class="lineno"> 2968</span><span class="comment">!     z0       - real, roughness length (m)                        1    !</span></div>
<div class="line"><a id="l02969" name="l02969"></a><span class="lineno"> 2969</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l02970" name="l02970"></a><span class="lineno"> 2970</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l02971" name="l02971"></a><span class="lineno"> 2971</span><span class="comment">!</span></div>
<div class="line"><a id="l02972" name="l02972"></a><span class="lineno"> 2972</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l02973" name="l02973"></a><span class="lineno"> 2973</span><span class="comment">!     real(kind=kind_phys), intent(in) :: sncovr</span></div>
<div class="line"><a id="l02974" name="l02974"></a><span class="lineno"> 2974</span> </div>
<div class="line"><a id="l02975" name="l02975"></a><span class="lineno"> 2975</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l02976" name="l02976"></a><span class="lineno"> 2976</span><span class="comment">!     real(kind=kind_phys), intent(inout) :: z0</span></div>
<div class="line"><a id="l02977" name="l02977"></a><span class="lineno"> 2977</span> </div>
<div class="line"><a id="l02978" name="l02978"></a><span class="lineno"> 2978</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l02979" name="l02979"></a><span class="lineno"> 2979</span><span class="keywordtype">      real</span>(kind=kind_phys) :: z0s</div>
<div class="line"><a id="l02980" name="l02980"></a><span class="lineno"> 2980</span><span class="comment">!</span></div>
<div class="line"><a id="l02981" name="l02981"></a><span class="lineno"> 2981</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l02982" name="l02982"></a><span class="lineno"> 2982</span><span class="comment">!</span></div>
<div class="line"><a id="l02983" name="l02983"></a><span class="lineno"> 2983</span><span class="comment">!     z0s = 0.001                     ! snow roughness length:=0.001 (m)</span></div>
<div class="line"><a id="l02984" name="l02984"></a><span class="lineno"> 2984</span><span class="comment">!  --- ...  current noah lsm condition - mbek, 09-oct-2001</span></div>
<div class="line"><a id="l02985" name="l02985"></a><span class="lineno"> 2985</span>      z0s = z0</div>
<div class="line"><a id="l02986" name="l02986"></a><span class="lineno"> 2986</span> </div>
<div class="line"><a id="l02987" name="l02987"></a><span class="lineno"> 2987</span>      z0 = (1.0 - sncovr)*z0 + sncovr*z0s</div>
<div class="line"><a id="l02988" name="l02988"></a><span class="lineno"> 2988</span> </div>
<div class="line"><a id="l02989" name="l02989"></a><span class="lineno"> 2989</span><span class="comment">!</span></div>
<div class="line"><a id="l02990" name="l02990"></a><span class="lineno"> 2990</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l02991" name="l02991"></a><span class="lineno"> 2991</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga95d889f436d70014fe640fa1b2420545.html#ga95d889f436d70014fe640fa1b2420545">snowz0</a></div>
<div class="line"><a id="l02992" name="l02992"></a><span class="lineno"> 2992</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l02993" name="l02993"></a><span class="lineno"> 2993</span> </div>
<div class="line"><a id="l02994" name="l02994"></a><span class="lineno"> 2994</span> </div>
<div class="line"><a id="l02995" name="l02995"></a><span class="lineno"> 2995</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l02996" name="l02996"></a><span class="lineno"> 2996</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l02997" name="l02997"></a><span class="lineno"> 2997</span><span class="comment">!&gt; This subroutine calculates thermal diffusivity and conductivity</span></div>
<div class="line"><a id="l02998" name="l02998"></a><span class="lineno"> 2998</span><span class="comment">!! of the soil for a given point and time.</span></div>
<div class="foldopen" id="foldopen02999" data-start="" data-end="">
<div class="line"><a id="l02999" name="l02999"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga8bc3154096e6364c5fcddf884c003bef.html#ga8bc3154096e6364c5fcddf884c003bef"> 2999</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga8bc3154096e6364c5fcddf884c003bef.html#ga8bc3154096e6364c5fcddf884c003bef">tdfcnd</a>                                                 &amp;</div>
<div class="line"><a id="l03000" name="l03000"></a><span class="lineno"> 3000</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03001" name="l03001"></a><span class="lineno"> 3001</span>     &amp;     ( smc, qz, smcmax, sh2o,                                     &amp;</div>
<div class="line"><a id="l03002" name="l03002"></a><span class="lineno"> 3002</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03003" name="l03003"></a><span class="lineno"> 3003</span>     &amp;       df                                                         &amp;</div>
<div class="line"><a id="l03004" name="l03004"></a><span class="lineno"> 3004</span>     &amp;     )</div>
<div class="line"><a id="l03005" name="l03005"></a><span class="lineno"> 3005</span> </div>
<div class="line"><a id="l03006" name="l03006"></a><span class="lineno"> 3006</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l03007" name="l03007"></a><span class="lineno"> 3007</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l03008" name="l03008"></a><span class="lineno"> 3008</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03009" name="l03009"></a><span class="lineno"> 3009</span><span class="comment">!    subroutine tdfcnd calculates thermal diffusivity and conductivity  !</span></div>
<div class="line"><a id="l03010" name="l03010"></a><span class="lineno"> 3010</span><span class="comment">!    of the soil for a given point and time.                            !</span></div>
<div class="line"><a id="l03011" name="l03011"></a><span class="lineno"> 3011</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03012" name="l03012"></a><span class="lineno"> 3012</span><span class="comment">!    peters-lidard approach (peters-lidard et al., 1998)                !</span></div>
<div class="line"><a id="l03013" name="l03013"></a><span class="lineno"> 3013</span><span class="comment">!    june 2001 changes: frozen soil condition.                          !</span></div>
<div class="line"><a id="l03014" name="l03014"></a><span class="lineno"> 3014</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03015" name="l03015"></a><span class="lineno"> 3015</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l03016" name="l03016"></a><span class="lineno"> 3016</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03017" name="l03017"></a><span class="lineno"> 3017</span><span class="comment">!  use as in peters-lidard, 1998 (modif. from johansen, 1975).          !</span></div>
<div class="line"><a id="l03018" name="l03018"></a><span class="lineno"> 3018</span><span class="comment">!                                 pablo grunmann, 08/17/98              !</span></div>
<div class="line"><a id="l03019" name="l03019"></a><span class="lineno"> 3019</span><span class="comment">!  refs.:                                                               !</span></div>
<div class="line"><a id="l03020" name="l03020"></a><span class="lineno"> 3020</span><span class="comment">!    farouki, o.t.,1986: thermal properties of soils. series on rock    !</span></div>
<div class="line"><a id="l03021" name="l03021"></a><span class="lineno"> 3021</span><span class="comment">!             and soil mechanics, vol. 11, trans tech, 136 pp.          !</span></div>
<div class="line"><a id="l03022" name="l03022"></a><span class="lineno"> 3022</span><span class="comment">!    johansen, o., 1975: thermal conductivity of soils. ph.d. thesis,   !</span></div>
<div class="line"><a id="l03023" name="l03023"></a><span class="lineno"> 3023</span><span class="comment">!             university of trondheim,                                  !</span></div>
<div class="line"><a id="l03024" name="l03024"></a><span class="lineno"> 3024</span><span class="comment">!    peters-lidard, c. d., et al., 1998: the effect of soil thermal     !</span></div>
<div class="line"><a id="l03025" name="l03025"></a><span class="lineno"> 3025</span><span class="comment">!             conductivity parameterization on surface energy fluxes    !</span></div>
<div class="line"><a id="l03026" name="l03026"></a><span class="lineno"> 3026</span><span class="comment">!             and temperatures. journal of the atmospheric sciences,    !</span></div>
<div class="line"><a id="l03027" name="l03027"></a><span class="lineno"> 3027</span><span class="comment">!             vol. 55, pp. 1209-1224.                                   !</span></div>
<div class="line"><a id="l03028" name="l03028"></a><span class="lineno"> 3028</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03029" name="l03029"></a><span class="lineno"> 3029</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l03030" name="l03030"></a><span class="lineno"> 3030</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03031" name="l03031"></a><span class="lineno"> 3031</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l03032" name="l03032"></a><span class="lineno"> 3032</span><span class="comment">!     smc      - real, top layer total soil moisture               1    !</span></div>
<div class="line"><a id="l03033" name="l03033"></a><span class="lineno"> 3033</span><span class="comment">!     qz       - real, quartz content (soil type dependent)        1    !</span></div>
<div class="line"><a id="l03034" name="l03034"></a><span class="lineno"> 3034</span><span class="comment">!     smcmax   - real, porosity                                    1    !</span></div>
<div class="line"><a id="l03035" name="l03035"></a><span class="lineno"> 3035</span><span class="comment">!     sh2o     - real, top layer unfrozen soil moisture            1    !</span></div>
<div class="line"><a id="l03036" name="l03036"></a><span class="lineno"> 3036</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03037" name="l03037"></a><span class="lineno"> 3037</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l03038" name="l03038"></a><span class="lineno"> 3038</span><span class="comment">!     df       - real, soil thermal diffusivity and conductivity   1    !</span></div>
<div class="line"><a id="l03039" name="l03039"></a><span class="lineno"> 3039</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03040" name="l03040"></a><span class="lineno"> 3040</span><span class="comment">!  locals:                                                              !</span></div>
<div class="line"><a id="l03041" name="l03041"></a><span class="lineno"> 3041</span><span class="comment">!     thkw     - water thermal conductivity                        1    !</span></div>
<div class="line"><a id="l03042" name="l03042"></a><span class="lineno"> 3042</span><span class="comment">!     thkqtz   - thermal conductivity for quartz                   1    !</span></div>
<div class="line"><a id="l03043" name="l03043"></a><span class="lineno"> 3043</span><span class="comment">!     thko     - thermal conductivity for other soil components    1    !</span></div>
<div class="line"><a id="l03044" name="l03044"></a><span class="lineno"> 3044</span><span class="comment">!     thkqtz   - thermal conductivity for the solids combined      1    !</span></div>
<div class="line"><a id="l03045" name="l03045"></a><span class="lineno"> 3045</span><span class="comment">!     thkice   - ice thermal conductivity                          1    !</span></div>
<div class="line"><a id="l03046" name="l03046"></a><span class="lineno"> 3046</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03047" name="l03047"></a><span class="lineno"> 3047</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03048" name="l03048"></a><span class="lineno"> 3048</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l03049" name="l03049"></a><span class="lineno"> 3049</span><span class="comment">!</span></div>
<div class="line"><a id="l03050" name="l03050"></a><span class="lineno"> 3050</span><span class="comment">!  ---  input:</span></div>
<div class="line"><a id="l03051" name="l03051"></a><span class="lineno"> 3051</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: smc, qz, smcmax, sh2o</div>
<div class="line"><a id="l03052" name="l03052"></a><span class="lineno"> 3052</span> </div>
<div class="line"><a id="l03053" name="l03053"></a><span class="lineno"> 3053</span><span class="comment">!  ---  output:</span></div>
<div class="line"><a id="l03054" name="l03054"></a><span class="lineno"> 3054</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: df</div>
<div class="line"><a id="l03055" name="l03055"></a><span class="lineno"> 3055</span> </div>
<div class="line"><a id="l03056" name="l03056"></a><span class="lineno"> 3056</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l03057" name="l03057"></a><span class="lineno"> 3057</span><span class="keywordtype">      real</span> (kind=kind_phys) :: gammd, thkdry, ake, thkice, thko,        &amp;</div>
<div class="line"><a id="l03058" name="l03058"></a><span class="lineno"> 3058</span>     &amp;       thkqtz, thksat, thks, thkw, satratio, xu, xunfroz</div>
<div class="line"><a id="l03059" name="l03059"></a><span class="lineno"> 3059</span><span class="comment">!</span></div>
<div class="line"><a id="l03060" name="l03060"></a><span class="lineno"> 3060</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l03061" name="l03061"></a><span class="lineno"> 3061</span><span class="comment">!</span></div>
<div class="line"><a id="l03062" name="l03062"></a><span class="lineno"> 3062</span><span class="comment">!  --- ...  if the soil has any moisture content compute a partial sum/product</span></div>
<div class="line"><a id="l03063" name="l03063"></a><span class="lineno"> 3063</span><span class="comment">!           otherwise use a constant value which works well with most soils</span></div>
<div class="line"><a id="l03064" name="l03064"></a><span class="lineno"> 3064</span> </div>
<div class="line"><a id="l03065" name="l03065"></a><span class="lineno"> 3065</span><span class="comment">!  --- ...  saturation ratio:</span></div>
<div class="line"><a id="l03066" name="l03066"></a><span class="lineno"> 3066</span> </div>
<div class="line"><a id="l03067" name="l03067"></a><span class="lineno"> 3067</span>      satratio = smc / smcmax</div>
<div class="line"><a id="l03068" name="l03068"></a><span class="lineno"> 3068</span> </div>
<div class="line"><a id="l03069" name="l03069"></a><span class="lineno"> 3069</span><span class="comment">!  --- ...  parameters  w/(m.k)</span></div>
<div class="line"><a id="l03070" name="l03070"></a><span class="lineno"> 3070</span>      thkice = 2.2</div>
<div class="line"><a id="l03071" name="l03071"></a><span class="lineno"> 3071</span>      thkw   = 0.57</div>
<div class="line"><a id="l03072" name="l03072"></a><span class="lineno"> 3072</span>      thko   = 2.0</div>
<div class="line"><a id="l03073" name="l03073"></a><span class="lineno"> 3073</span><span class="comment">!     if (qz &lt;= 0.2) thko = 3.0</span></div>
<div class="line"><a id="l03074" name="l03074"></a><span class="lineno"> 3074</span>      thkqtz = 7.7</div>
<div class="line"><a id="l03075" name="l03075"></a><span class="lineno"> 3075</span> </div>
<div class="line"><a id="l03076" name="l03076"></a><span class="lineno"> 3076</span><span class="comment">!  --- ...  solids&#39; conductivity</span></div>
<div class="line"><a id="l03077" name="l03077"></a><span class="lineno"> 3077</span> </div>
<div class="line"><a id="l03078" name="l03078"></a><span class="lineno"> 3078</span>      thks = (thkqtz**qz) * (thko**(1.0-qz))</div>
<div class="line"><a id="l03079" name="l03079"></a><span class="lineno"> 3079</span> </div>
<div class="line"><a id="l03080" name="l03080"></a><span class="lineno"> 3080</span><span class="comment">!  --- ...  unfrozen fraction (from 1., i.e., 100%liquid, to 0. (100% frozen))</span></div>
<div class="line"><a id="l03081" name="l03081"></a><span class="lineno"> 3081</span> </div>
<div class="line"><a id="l03082" name="l03082"></a><span class="lineno"> 3082</span>      xunfroz = (sh2o + 1.e-9) / (smc + 1.e-9)</div>
<div class="line"><a id="l03083" name="l03083"></a><span class="lineno"> 3083</span> </div>
<div class="line"><a id="l03084" name="l03084"></a><span class="lineno"> 3084</span><span class="comment">!  --- ...  unfrozen volume for saturation (porosity*xunfroz)</span></div>
<div class="line"><a id="l03085" name="l03085"></a><span class="lineno"> 3085</span> </div>
<div class="line"><a id="l03086" name="l03086"></a><span class="lineno"> 3086</span>      xu=xunfroz*smcmax</div>
<div class="line"><a id="l03087" name="l03087"></a><span class="lineno"> 3087</span> </div>
<div class="line"><a id="l03088" name="l03088"></a><span class="lineno"> 3088</span><span class="comment">!  --- ...  saturated thermal conductivity</span></div>
<div class="line"><a id="l03089" name="l03089"></a><span class="lineno"> 3089</span> </div>
<div class="line"><a id="l03090" name="l03090"></a><span class="lineno"> 3090</span>      thksat = thks**(1.-smcmax) * thkice**(smcmax-xu) * thkw**(xu)</div>
<div class="line"><a id="l03091" name="l03091"></a><span class="lineno"> 3091</span> </div>
<div class="line"><a id="l03092" name="l03092"></a><span class="lineno"> 3092</span><span class="comment">!  --- ...  dry density in kg/m3</span></div>
<div class="line"><a id="l03093" name="l03093"></a><span class="lineno"> 3093</span> </div>
<div class="line"><a id="l03094" name="l03094"></a><span class="lineno"> 3094</span>      gammd = (1.0 - smcmax) * 2700.0</div>
<div class="line"><a id="l03095" name="l03095"></a><span class="lineno"> 3095</span> </div>
<div class="line"><a id="l03096" name="l03096"></a><span class="lineno"> 3096</span><span class="comment">!  --- ...  dry thermal conductivity in w.m-1.k-1</span></div>
<div class="line"><a id="l03097" name="l03097"></a><span class="lineno"> 3097</span> </div>
<div class="line"><a id="l03098" name="l03098"></a><span class="lineno"> 3098</span>      thkdry = (0.135*gammd + 64.7) / (2700.0 - 0.947*gammd)</div>
<div class="line"><a id="l03099" name="l03099"></a><span class="lineno"> 3099</span> </div>
<div class="line"><a id="l03100" name="l03100"></a><span class="lineno"> 3100</span>      <span class="keywordflow">if</span> ( sh2o+0.0005 &lt; smc ) <span class="keywordflow">then</span>         <span class="comment">! frozen</span></div>
<div class="line"><a id="l03101" name="l03101"></a><span class="lineno"> 3101</span> </div>
<div class="line"><a id="l03102" name="l03102"></a><span class="lineno"> 3102</span>        ake = satratio</div>
<div class="line"><a id="l03103" name="l03103"></a><span class="lineno"> 3103</span> </div>
<div class="line"><a id="l03104" name="l03104"></a><span class="lineno"> 3104</span>      <span class="keywordflow">else</span>                                  <span class="comment">! unfrozen</span></div>
<div class="line"><a id="l03105" name="l03105"></a><span class="lineno"> 3105</span> </div>
<div class="line"><a id="l03106" name="l03106"></a><span class="lineno"> 3106</span><span class="comment">!  --- ...  range of validity for the kersten number (ake)</span></div>
<div class="line"><a id="l03107" name="l03107"></a><span class="lineno"> 3107</span>        <span class="keywordflow">if</span> ( satratio &gt; 0.1 ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03108" name="l03108"></a><span class="lineno"> 3108</span> </div>
<div class="line"><a id="l03109" name="l03109"></a><span class="lineno"> 3109</span><span class="comment">!  --- ...  kersten number (using &quot;fine&quot; formula, valid for soils containing</span></div>
<div class="line"><a id="l03110" name="l03110"></a><span class="lineno"> 3110</span><span class="comment">!           at least 5% of particles with diameter less than 2.e-6 meters.)</span></div>
<div class="line"><a id="l03111" name="l03111"></a><span class="lineno"> 3111</span><span class="comment">!           (for &quot;coarse&quot; formula, see peters-lidard et al., 1998).</span></div>
<div class="line"><a id="l03112" name="l03112"></a><span class="lineno"> 3112</span> </div>
<div class="line"><a id="l03113" name="l03113"></a><span class="lineno"> 3113</span>          ake = log10( satratio ) + 1.0</div>
<div class="line"><a id="l03114" name="l03114"></a><span class="lineno"> 3114</span> </div>
<div class="line"><a id="l03115" name="l03115"></a><span class="lineno"> 3115</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l03116" name="l03116"></a><span class="lineno"> 3116</span> </div>
<div class="line"><a id="l03117" name="l03117"></a><span class="lineno"> 3117</span><span class="comment">!  --- ...  use k = kdry</span></div>
<div class="line"><a id="l03118" name="l03118"></a><span class="lineno"> 3118</span>          ake = 0.0</div>
<div class="line"><a id="l03119" name="l03119"></a><span class="lineno"> 3119</span> </div>
<div class="line"><a id="l03120" name="l03120"></a><span class="lineno"> 3120</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_satratio_block</span></div>
<div class="line"><a id="l03121" name="l03121"></a><span class="lineno"> 3121</span> </div>
<div class="line"><a id="l03122" name="l03122"></a><span class="lineno"> 3122</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_sh2o+0.0005_block</span></div>
<div class="line"><a id="l03123" name="l03123"></a><span class="lineno"> 3123</span> </div>
<div class="line"><a id="l03124" name="l03124"></a><span class="lineno"> 3124</span><span class="comment">!  --- ...  thermal conductivity</span></div>
<div class="line"><a id="l03125" name="l03125"></a><span class="lineno"> 3125</span> </div>
<div class="line"><a id="l03126" name="l03126"></a><span class="lineno"> 3126</span>      df = ake * (thksat - thkdry) + thkdry</div>
<div class="line"><a id="l03127" name="l03127"></a><span class="lineno"> 3127</span><span class="comment">!</span></div>
<div class="line"><a id="l03128" name="l03128"></a><span class="lineno"> 3128</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l03129" name="l03129"></a><span class="lineno"> 3129</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga8bc3154096e6364c5fcddf884c003bef.html#ga8bc3154096e6364c5fcddf884c003bef">tdfcnd</a></div>
<div class="line"><a id="l03130" name="l03130"></a><span class="lineno"> 3130</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l03131" name="l03131"></a><span class="lineno"> 3131</span> </div>
<div class="line"><a id="l03132" name="l03132"></a><span class="lineno"> 3132</span> </div>
<div class="line"><a id="l03133" name="l03133"></a><span class="lineno"> 3133</span><span class="comment">!*********************************************!</span></div>
<div class="line"><a id="l03134" name="l03134"></a><span class="lineno"> 3134</span><span class="comment">!  section-2  2nd level subprograms           !</span></div>
<div class="line"><a id="l03135" name="l03135"></a><span class="lineno"> 3135</span><span class="comment">!*********************************************!</span></div>
<div class="line"><a id="l03136" name="l03136"></a><span class="lineno"> 3136</span> </div>
<div class="line"><a id="l03137" name="l03137"></a><span class="lineno"> 3137</span> </div>
<div class="line"><a id="l03138" name="l03138"></a><span class="lineno"> 3138</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l03139" name="l03139"></a><span class="lineno"> 3139</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l03140" name="l03140"></a><span class="lineno"> 3140</span><span class="comment">!&gt; This subroutine calculates soil moisture flux. The soil moisture</span></div>
<div class="line"><a id="l03141" name="l03141"></a><span class="lineno"> 3141</span><span class="comment">!! content (smc - a per unit volume measurement) is a dependent variable</span></div>
<div class="line"><a id="l03142" name="l03142"></a><span class="lineno"> 3142</span><span class="comment">!! that is updated with prognostic equations. The canopy moisture content</span></div>
<div class="line"><a id="l03143" name="l03143"></a><span class="lineno"> 3143</span><span class="comment">!! (cmc) is also updated. Frozen ground version: new states added: sh2o,</span></div>
<div class="line"><a id="l03144" name="l03144"></a><span class="lineno"> 3144</span><span class="comment">!! and frozen ground correction factor, frzfact and paramter slope.</span></div>
<div class="foldopen" id="foldopen03145" data-start="" data-end="">
<div class="line"><a id="l03145" name="l03145"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga4af741ecc120ddb0d7282f78df4136a5.html#ga4af741ecc120ddb0d7282f78df4136a5"> 3145</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga4af741ecc120ddb0d7282f78df4136a5.html#ga4af741ecc120ddb0d7282f78df4136a5">evapo</a>                                                  &amp;</div>
<div class="line"><a id="l03146" name="l03146"></a><span class="lineno"> 3146</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03147" name="l03147"></a><span class="lineno"> 3147</span>     &amp;     ( nsoil, nroot, cmc, cmcmax, etp1, dt, zsoil,                &amp;</div>
<div class="line"><a id="l03148" name="l03148"></a><span class="lineno"> 3148</span>     &amp;       sh2o, smcmax, smcwlt, smcref, smcdry, pc,                  &amp;</div>
<div class="line"><a id="l03149" name="l03149"></a><span class="lineno"> 3149</span>     &amp;       shdfac, cfactr, rtdis, fxexp,                              &amp;</div>
<div class="line"><a id="l03150" name="l03150"></a><span class="lineno"> 3150</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03151" name="l03151"></a><span class="lineno"> 3151</span>     &amp;       eta1, edir1, ec1, et1, ett1                                &amp;</div>
<div class="line"><a id="l03152" name="l03152"></a><span class="lineno"> 3152</span>     &amp;     )</div>
<div class="line"><a id="l03153" name="l03153"></a><span class="lineno"> 3153</span> </div>
<div class="line"><a id="l03154" name="l03154"></a><span class="lineno"> 3154</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l03155" name="l03155"></a><span class="lineno"> 3155</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l03156" name="l03156"></a><span class="lineno"> 3156</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03157" name="l03157"></a><span class="lineno"> 3157</span><span class="comment">!  subroutine evapo calculates soil moisture flux.  the soil moisture   !</span></div>
<div class="line"><a id="l03158" name="l03158"></a><span class="lineno"> 3158</span><span class="comment">!  content (smc - a per unit volume measurement) is a dependent variable!</span></div>
<div class="line"><a id="l03159" name="l03159"></a><span class="lineno"> 3159</span><span class="comment">!  that is updated with prognostic eqns. the canopy moisture content    !</span></div>
<div class="line"><a id="l03160" name="l03160"></a><span class="lineno"> 3160</span><span class="comment">!  (cmc) is also updated. frozen ground version:  new states added:     !</span></div>
<div class="line"><a id="l03161" name="l03161"></a><span class="lineno"> 3161</span><span class="comment">!  sh2o, and frozen ground correction factor, frzfact and parameter     !</span></div>
<div class="line"><a id="l03162" name="l03162"></a><span class="lineno"> 3162</span><span class="comment">!  slope.                                                               !</span></div>
<div class="line"><a id="l03163" name="l03163"></a><span class="lineno"> 3163</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03164" name="l03164"></a><span class="lineno"> 3164</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03165" name="l03165"></a><span class="lineno"> 3165</span><span class="comment">!  subprogram called:  devap, transp                                    !</span></div>
<div class="line"><a id="l03166" name="l03166"></a><span class="lineno"> 3166</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03167" name="l03167"></a><span class="lineno"> 3167</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l03168" name="l03168"></a><span class="lineno"> 3168</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03169" name="l03169"></a><span class="lineno"> 3169</span><span class="comment">!  inputs from calling program:                                  size   !</span></div>
<div class="line"><a id="l03170" name="l03170"></a><span class="lineno"> 3170</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l03171" name="l03171"></a><span class="lineno"> 3171</span><span class="comment">!     nroot    - integer, number of root layers                    1    !</span></div>
<div class="line"><a id="l03172" name="l03172"></a><span class="lineno"> 3172</span><span class="comment">!     cmc      - real, canopy moisture content                     1    !</span></div>
<div class="line"><a id="l03173" name="l03173"></a><span class="lineno"> 3173</span><span class="comment">!     cmcmax   - real, maximum canopy water parameters             1    !</span></div>
<div class="line"><a id="l03174" name="l03174"></a><span class="lineno"> 3174</span><span class="comment">!     etp1     - real, potential evaporation                       1    !</span></div>
<div class="line"><a id="l03175" name="l03175"></a><span class="lineno"> 3175</span><span class="comment">!     dt       - real, time step                                   1    !</span></div>
<div class="line"><a id="l03176" name="l03176"></a><span class="lineno"> 3176</span><span class="comment">!     zsoil    - real, soil layer depth below ground             nsoil  !</span></div>
<div class="line"><a id="l03177" name="l03177"></a><span class="lineno"> 3177</span><span class="comment">!     sh2o     - real, unfrozen soil moisture                    nsoil  !</span></div>
<div class="line"><a id="l03178" name="l03178"></a><span class="lineno"> 3178</span><span class="comment">!     smcmax   - real, porosity                                    1    !</span></div>
<div class="line"><a id="l03179" name="l03179"></a><span class="lineno"> 3179</span><span class="comment">!     smcwlt   - real, wilting point                               1    !</span></div>
<div class="line"><a id="l03180" name="l03180"></a><span class="lineno"> 3180</span><span class="comment">!     smcref   - real, soil mois threshold                         1    !</span></div>
<div class="line"><a id="l03181" name="l03181"></a><span class="lineno"> 3181</span><span class="comment">!     smcdry   - real, dry soil mois threshold                     1    !</span></div>
<div class="line"><a id="l03182" name="l03182"></a><span class="lineno"> 3182</span><span class="comment">!     pc       - real, plant coeff                                 1    !</span></div>
<div class="line"><a id="l03183" name="l03183"></a><span class="lineno"> 3183</span><span class="comment">!     cfactr   - real, canopy water parameters                     1    !</span></div>
<div class="line"><a id="l03184" name="l03184"></a><span class="lineno"> 3184</span><span class="comment">!     rtdis    - real, root distribution                         nsoil  !</span></div>
<div class="line"><a id="l03185" name="l03185"></a><span class="lineno"> 3185</span><span class="comment">!     fxexp    - real, bare soil evaporation exponent              1    !</span></div>
<div class="line"><a id="l03186" name="l03186"></a><span class="lineno"> 3186</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03187" name="l03187"></a><span class="lineno"> 3187</span><span class="comment">!  outputs to calling program:                                          !</span></div>
<div class="line"><a id="l03188" name="l03188"></a><span class="lineno"> 3188</span><span class="comment">!     eta1     - real, latent heat flux                            1    !</span></div>
<div class="line"><a id="l03189" name="l03189"></a><span class="lineno"> 3189</span><span class="comment">!     edir1    - real, direct soil evaporation                     1    !</span></div>
<div class="line"><a id="l03190" name="l03190"></a><span class="lineno"> 3190</span><span class="comment">!     ec1      - real, canopy water evaporation                    1    !</span></div>
<div class="line"><a id="l03191" name="l03191"></a><span class="lineno"> 3191</span><span class="comment">!     et1      - real, plant transpiration                       nsoil  !</span></div>
<div class="line"><a id="l03192" name="l03192"></a><span class="lineno"> 3192</span><span class="comment">!     ett1     - real, total plant transpiration                   1    !</span></div>
<div class="line"><a id="l03193" name="l03193"></a><span class="lineno"> 3193</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03194" name="l03194"></a><span class="lineno"> 3194</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l03195" name="l03195"></a><span class="lineno"> 3195</span><span class="comment">!</span></div>
<div class="line"><a id="l03196" name="l03196"></a><span class="lineno"> 3196</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03197" name="l03197"></a><span class="lineno"> 3197</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil, nroot</div>
<div class="line"><a id="l03198" name="l03198"></a><span class="lineno"> 3198</span> </div>
<div class="line"><a id="l03199" name="l03199"></a><span class="lineno"> 3199</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">intent(in)</span> :: cmc, cmcmax, etp1, dt, pc,  &amp;</div>
<div class="line"><a id="l03200" name="l03200"></a><span class="lineno"> 3200</span>     &amp;       smcmax, smcwlt, smcref, smcdry, shdfac, cfactr, fxexp,     &amp;</div>
<div class="line"><a id="l03201" name="l03201"></a><span class="lineno"> 3201</span>     &amp;       zsoil(nsoil), sh2o(nsoil), rtdis(nsoil)</div>
<div class="line"><a id="l03202" name="l03202"></a><span class="lineno"> 3202</span> </div>
<div class="line"><a id="l03203" name="l03203"></a><span class="lineno"> 3203</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03204" name="l03204"></a><span class="lineno"> 3204</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">intent(out)</span> :: eta1, edir1, ec1, ett1,    &amp;</div>
<div class="line"><a id="l03205" name="l03205"></a><span class="lineno"> 3205</span>     &amp;       et1(nsoil)</div>
<div class="line"><a id="l03206" name="l03206"></a><span class="lineno"> 3206</span> </div>
<div class="line"><a id="l03207" name="l03207"></a><span class="lineno"> 3207</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l03208" name="l03208"></a><span class="lineno"> 3208</span><span class="keywordtype">      real</span> (kind=kind_phys) :: cmc2ms</div>
<div class="line"><a id="l03209" name="l03209"></a><span class="lineno"> 3209</span> </div>
<div class="line"><a id="l03210" name="l03210"></a><span class="lineno"> 3210</span>      <span class="keywordtype">integer</span> :: i, k</div>
<div class="line"><a id="l03211" name="l03211"></a><span class="lineno"> 3211</span> </div>
<div class="line"><a id="l03212" name="l03212"></a><span class="lineno"> 3212</span><span class="comment">!</span></div>
<div class="line"><a id="l03213" name="l03213"></a><span class="lineno"> 3213</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l03214" name="l03214"></a><span class="lineno"> 3214</span><span class="comment">!</span></div>
<div class="line"><a id="l03215" name="l03215"></a><span class="lineno"> 3215</span><span class="comment">!  --- ...  executable code begins here if the potential evapotranspiration</span></div>
<div class="line"><a id="l03216" name="l03216"></a><span class="lineno"> 3216</span><span class="comment">!           is greater than zero.</span></div>
<div class="line"><a id="l03217" name="l03217"></a><span class="lineno"> 3217</span> </div>
<div class="line"><a id="l03218" name="l03218"></a><span class="lineno"> 3218</span>      edir1 = 0.0</div>
<div class="line"><a id="l03219" name="l03219"></a><span class="lineno"> 3219</span>      ec1 = 0.0</div>
<div class="line"><a id="l03220" name="l03220"></a><span class="lineno"> 3220</span> </div>
<div class="line"><a id="l03221" name="l03221"></a><span class="lineno"> 3221</span>      <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l03222" name="l03222"></a><span class="lineno"> 3222</span>        et1(k) = 0.0</div>
<div class="line"><a id="l03223" name="l03223"></a><span class="lineno"> 3223</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l03224" name="l03224"></a><span class="lineno"> 3224</span>      ett1 = 0.0</div>
<div class="line"><a id="l03225" name="l03225"></a><span class="lineno"> 3225</span> </div>
<div class="line"><a id="l03226" name="l03226"></a><span class="lineno"> 3226</span>      <span class="keywordflow">if</span> (etp1 &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03227" name="l03227"></a><span class="lineno"> 3227</span> </div>
<div class="line"><a id="l03228" name="l03228"></a><span class="lineno"> 3228</span><span class="comment">!  --- ...  retrieve direct evaporation from soil surface.  call this function</span></div>
<div class="line"><a id="l03229" name="l03229"></a><span class="lineno"> 3229</span><span class="comment">!           only if veg cover not complete.</span></div>
<div class="line"><a id="l03230" name="l03230"></a><span class="lineno"> 3230</span><span class="comment">!           frozen ground version:  sh2o states replace smc states.</span></div>
<div class="line"><a id="l03231" name="l03231"></a><span class="lineno"> 3231</span> </div>
<div class="line"><a id="l03232" name="l03232"></a><span class="lineno"> 3232</span>        <span class="keywordflow">if</span> (shdfac &lt; 1.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03233" name="l03233"></a><span class="lineno"> 3233</span> </div>
<div class="line"><a id="l03234" name="l03234"></a><span class="lineno"> 3234</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gabf8ee2c002871d95bc356e2058f49a92.html#gabf8ee2c002871d95bc356e2058f49a92">devap</a>                                                    &amp;</div>
<div class="line"><a id="l03235" name="l03235"></a><span class="lineno"> 3235</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03236" name="l03236"></a><span class="lineno"> 3236</span>     &amp;     ( etp1, sh2o(1), shdfac, smcmax, smcdry, fxexp,              &amp;</div>
<div class="line"><a id="l03237" name="l03237"></a><span class="lineno"> 3237</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03238" name="l03238"></a><span class="lineno"> 3238</span>     &amp;       edir1                                                      &amp;</div>
<div class="line"><a id="l03239" name="l03239"></a><span class="lineno"> 3239</span>     &amp;     )</div>
<div class="line"><a id="l03240" name="l03240"></a><span class="lineno"> 3240</span> </div>
<div class="line"><a id="l03241" name="l03241"></a><span class="lineno"> 3241</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l03242" name="l03242"></a><span class="lineno"> 3242</span> </div>
<div class="line"><a id="l03243" name="l03243"></a><span class="lineno"> 3243</span><span class="comment">!  --- ...  initialize plant total transpiration, retrieve plant transpiration,</span></div>
<div class="line"><a id="l03244" name="l03244"></a><span class="lineno"> 3244</span><span class="comment">!           and accumulate it for all soil layers.</span></div>
<div class="line"><a id="l03245" name="l03245"></a><span class="lineno"> 3245</span> </div>
<div class="line"><a id="l03246" name="l03246"></a><span class="lineno"> 3246</span>        <span class="keywordflow">if</span> (shdfac &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03247" name="l03247"></a><span class="lineno"> 3247</span> </div>
<div class="line"><a id="l03248" name="l03248"></a><span class="lineno"> 3248</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga4bf7fbbf861a5c232da14ca6b74cdd4f.html#ga4bf7fbbf861a5c232da14ca6b74cdd4f">transp</a>                                                   &amp;</div>
<div class="line"><a id="l03249" name="l03249"></a><span class="lineno"> 3249</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03250" name="l03250"></a><span class="lineno"> 3250</span>     &amp;     ( nsoil, nroot, etp1, sh2o, smcwlt, smcref,                   &amp;</div>
<div class="line"><a id="l03251" name="l03251"></a><span class="lineno"> 3251</span>     &amp;       cmc, cmcmax, zsoil, shdfac, pc, cfactr, rtdis,             &amp;</div>
<div class="line"><a id="l03252" name="l03252"></a><span class="lineno"> 3252</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03253" name="l03253"></a><span class="lineno"> 3253</span>     &amp;       et1                                                        &amp;</div>
<div class="line"><a id="l03254" name="l03254"></a><span class="lineno"> 3254</span>     &amp;     )</div>
<div class="line"><a id="l03255" name="l03255"></a><span class="lineno"> 3255</span> </div>
<div class="line"><a id="l03256" name="l03256"></a><span class="lineno"> 3256</span>          <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l03257" name="l03257"></a><span class="lineno"> 3257</span>            ett1 = ett1 + et1(k)</div>
<div class="line"><a id="l03258" name="l03258"></a><span class="lineno"> 3258</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l03259" name="l03259"></a><span class="lineno"> 3259</span> </div>
<div class="line"><a id="l03260" name="l03260"></a><span class="lineno"> 3260</span><span class="comment">!  --- ...  calculate canopy evaporation.</span></div>
<div class="line"><a id="l03261" name="l03261"></a><span class="lineno"> 3261</span><span class="comment">!           if statements to avoid tangent linear problems near cmc=0.0.</span></div>
<div class="line"><a id="l03262" name="l03262"></a><span class="lineno"> 3262</span> </div>
<div class="line"><a id="l03263" name="l03263"></a><span class="lineno"> 3263</span>          <span class="keywordflow">if</span> (cmc &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03264" name="l03264"></a><span class="lineno"> 3264</span>            ec1 = shdfac * ( (cmc/cmcmax)**cfactr ) * etp1</div>
<div class="line"><a id="l03265" name="l03265"></a><span class="lineno"> 3265</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l03266" name="l03266"></a><span class="lineno"> 3266</span>            ec1 = 0.0</div>
<div class="line"><a id="l03267" name="l03267"></a><span class="lineno"> 3267</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l03268" name="l03268"></a><span class="lineno"> 3268</span> </div>
<div class="line"><a id="l03269" name="l03269"></a><span class="lineno"> 3269</span><span class="comment">!  --- ...  ec should be limited by the total amount of available water</span></div>
<div class="line"><a id="l03270" name="l03270"></a><span class="lineno"> 3270</span><span class="comment">!           on the canopy.  -f.chen, 18-oct-1994</span></div>
<div class="line"><a id="l03271" name="l03271"></a><span class="lineno"> 3271</span> </div>
<div class="line"><a id="l03272" name="l03272"></a><span class="lineno"> 3272</span>          cmc2ms = cmc / dt</div>
<div class="line"><a id="l03273" name="l03273"></a><span class="lineno"> 3273</span>          ec1 = min( cmc2ms, ec1 )</div>
<div class="line"><a id="l03274" name="l03274"></a><span class="lineno"> 3274</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l03275" name="l03275"></a><span class="lineno"> 3275</span> </div>
<div class="line"><a id="l03276" name="l03276"></a><span class="lineno"> 3276</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_etp1_block</span></div>
<div class="line"><a id="l03277" name="l03277"></a><span class="lineno"> 3277</span> </div>
<div class="line"><a id="l03278" name="l03278"></a><span class="lineno"> 3278</span><span class="comment">!  --- ...  total up evap and transp types to obtain actual evapotransp</span></div>
<div class="line"><a id="l03279" name="l03279"></a><span class="lineno"> 3279</span> </div>
<div class="line"><a id="l03280" name="l03280"></a><span class="lineno"> 3280</span>      eta1 = edir1 + ett1 + ec1</div>
<div class="line"><a id="l03281" name="l03281"></a><span class="lineno"> 3281</span> </div>
<div class="line"><a id="l03282" name="l03282"></a><span class="lineno"> 3282</span><span class="comment">!</span></div>
<div class="line"><a id="l03283" name="l03283"></a><span class="lineno"> 3283</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l03284" name="l03284"></a><span class="lineno"> 3284</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga4af741ecc120ddb0d7282f78df4136a5.html#ga4af741ecc120ddb0d7282f78df4136a5">evapo</a></div>
<div class="line"><a id="l03285" name="l03285"></a><span class="lineno"> 3285</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l03286" name="l03286"></a><span class="lineno"> 3286</span> </div>
<div class="line"><a id="l03287" name="l03287"></a><span class="lineno"> 3287</span> </div>
<div class="line"><a id="l03288" name="l03288"></a><span class="lineno"> 3288</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l03289" name="l03289"></a><span class="lineno"> 3289</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l03290" name="l03290"></a><span class="lineno"> 3290</span><span class="comment">!&gt; This subroutine updates the temperature state of the soil column</span></div>
<div class="line"><a id="l03291" name="l03291"></a><span class="lineno"> 3291</span><span class="comment">!! based on the thermal diffusion equation and update the frozen soil</span></div>
<div class="line"><a id="l03292" name="l03292"></a><span class="lineno"> 3292</span><span class="comment">!! moisture content based on the temperature.</span></div>
<div class="foldopen" id="foldopen03293" data-start="" data-end="">
<div class="line"><a id="l03293" name="l03293"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga977daabf4ff68b28fc5ccd8796d815cd.html#ga977daabf4ff68b28fc5ccd8796d815cd"> 3293</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga977daabf4ff68b28fc5ccd8796d815cd.html#ga977daabf4ff68b28fc5ccd8796d815cd">shflx</a>                                                  &amp;</div>
<div class="line"><a id="l03294" name="l03294"></a><span class="lineno"> 3294</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03295" name="l03295"></a><span class="lineno"> 3295</span>     &amp;     ( nsoil, smc, smcmax, dt, yy, zz1, zsoil, zbot,              &amp;</div>
<div class="line"><a id="l03296" name="l03296"></a><span class="lineno"> 3296</span>     &amp;       psisat, bexp, df1, ice, quartz, csoil, vegtyp,             &amp;</div>
<div class="line"><a id="l03297" name="l03297"></a><span class="lineno"> 3297</span>     &amp;       shdfac, lheatstrg,                                         &amp;</div>
<div class="line"><a id="l03298" name="l03298"></a><span class="lineno"> 3298</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03299" name="l03299"></a><span class="lineno"> 3299</span>     &amp;       stc, t1, tbot, sh2o,                                       &amp;</div>
<div class="line"><a id="l03300" name="l03300"></a><span class="lineno"> 3300</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03301" name="l03301"></a><span class="lineno"> 3301</span>     &amp;       ssoil                                                      &amp;</div>
<div class="line"><a id="l03302" name="l03302"></a><span class="lineno"> 3302</span>     &amp;     )</div>
<div class="line"><a id="l03303" name="l03303"></a><span class="lineno"> 3303</span> </div>
<div class="line"><a id="l03304" name="l03304"></a><span class="lineno"> 3304</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l03305" name="l03305"></a><span class="lineno"> 3305</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l03306" name="l03306"></a><span class="lineno"> 3306</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03307" name="l03307"></a><span class="lineno"> 3307</span><span class="comment">!  subroutine shflx updates the temperature state of the soil column    !</span></div>
<div class="line"><a id="l03308" name="l03308"></a><span class="lineno"> 3308</span><span class="comment">!  based on the thermal diffusion equation and update the frozen soil   !</span></div>
<div class="line"><a id="l03309" name="l03309"></a><span class="lineno"> 3309</span><span class="comment">!  moisture content based on the temperature.                           !</span></div>
<div class="line"><a id="l03310" name="l03310"></a><span class="lineno"> 3310</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03311" name="l03311"></a><span class="lineno"> 3311</span><span class="comment">!  subprogram called:  hstep, hrtice, hrt                               !</span></div>
<div class="line"><a id="l03312" name="l03312"></a><span class="lineno"> 3312</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03313" name="l03313"></a><span class="lineno"> 3313</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03314" name="l03314"></a><span class="lineno"> 3314</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l03315" name="l03315"></a><span class="lineno"> 3315</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03316" name="l03316"></a><span class="lineno"> 3316</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l03317" name="l03317"></a><span class="lineno"> 3317</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l03318" name="l03318"></a><span class="lineno"> 3318</span><span class="comment">!     smc      - real, total soil moisture                       nsoil  !</span></div>
<div class="line"><a id="l03319" name="l03319"></a><span class="lineno"> 3319</span><span class="comment">!     smcmax   - real, porosity (sat val of soil mois)             1    !</span></div>
<div class="line"><a id="l03320" name="l03320"></a><span class="lineno"> 3320</span><span class="comment">!     dt       - real, time step                                   1    !</span></div>
<div class="line"><a id="l03321" name="l03321"></a><span class="lineno"> 3321</span><span class="comment">!     yy       - real, soil temperature at the top of column       1    !</span></div>
<div class="line"><a id="l03322" name="l03322"></a><span class="lineno"> 3322</span><span class="comment">!     zz1      - real,                                             1    !</span></div>
<div class="line"><a id="l03323" name="l03323"></a><span class="lineno"> 3323</span><span class="comment">!     zsoil    - real, soil layer depth below ground (negative)  nsoil  !</span></div>
<div class="line"><a id="l03324" name="l03324"></a><span class="lineno"> 3324</span><span class="comment">!     zbot     - real, specify depth of lower bd soil              1    !</span></div>
<div class="line"><a id="l03325" name="l03325"></a><span class="lineno"> 3325</span><span class="comment">!     psisat   - real, saturated soil potential                    1    !</span></div>
<div class="line"><a id="l03326" name="l03326"></a><span class="lineno"> 3326</span><span class="comment">!     bexp     - real, soil type &quot;b&quot; parameter                     1    !</span></div>
<div class="line"><a id="l03327" name="l03327"></a><span class="lineno"> 3327</span><span class="comment">!     df1      - real, thermal diffusivity and conductivity        1    !</span></div>
<div class="line"><a id="l03328" name="l03328"></a><span class="lineno"> 3328</span><span class="comment">!     ice      - integer, sea-ice flag (=1: sea-ice, =0: land)     1    !</span></div>
<div class="line"><a id="l03329" name="l03329"></a><span class="lineno"> 3329</span><span class="comment">!     quartz   - real, soil quartz content                         1    !</span></div>
<div class="line"><a id="l03330" name="l03330"></a><span class="lineno"> 3330</span><span class="comment">!     csoil    - real, soil heat capacity                          1    !</span></div>
<div class="line"><a id="l03331" name="l03331"></a><span class="lineno"> 3331</span><span class="comment">!     vegtyp   - integer, vegtation type                           1    !</span></div>
<div class="line"><a id="l03332" name="l03332"></a><span class="lineno"> 3332</span><span class="comment">!     shdfac   - real, aeral coverage of green vegetation          1    !</span></div>
<div class="line"><a id="l03333" name="l03333"></a><span class="lineno"> 3333</span><span class="comment">!     lheatstrg- logical, flag for canopy heat storage             1    ! </span></div>
<div class="line"><a id="l03334" name="l03334"></a><span class="lineno"> 3334</span><span class="comment">!                         parameterization                              !</span></div>
<div class="line"><a id="l03335" name="l03335"></a><span class="lineno"> 3335</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03336" name="l03336"></a><span class="lineno"> 3336</span><span class="comment">!  input/outputs:                                                       !</span></div>
<div class="line"><a id="l03337" name="l03337"></a><span class="lineno"> 3337</span><span class="comment">!     stc      - real, soil temp                                 nsoil  !</span></div>
<div class="line"><a id="l03338" name="l03338"></a><span class="lineno"> 3338</span><span class="comment">!     t1       - real, ground/canopy/snowpack eff skin temp        1    !</span></div>
<div class="line"><a id="l03339" name="l03339"></a><span class="lineno"> 3339</span><span class="comment">!     tbot     - real, bottom soil temp                            1    !</span></div>
<div class="line"><a id="l03340" name="l03340"></a><span class="lineno"> 3340</span><span class="comment">!     sh2o     - real, unfrozen soil moisture                    nsoil  !</span></div>
<div class="line"><a id="l03341" name="l03341"></a><span class="lineno"> 3341</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03342" name="l03342"></a><span class="lineno"> 3342</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l03343" name="l03343"></a><span class="lineno"> 3343</span><span class="comment">!     ssoil    - real, upward soil heat flux                       1    !</span></div>
<div class="line"><a id="l03344" name="l03344"></a><span class="lineno"> 3344</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03345" name="l03345"></a><span class="lineno"> 3345</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l03346" name="l03346"></a><span class="lineno"> 3346</span><span class="comment">!</span></div>
<div class="line"><a id="l03347" name="l03347"></a><span class="lineno"> 3347</span><span class="comment">!  ---  parameter constants:</span></div>
<div class="line"><a id="l03348" name="l03348"></a><span class="lineno"> 3348</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: ctfil1 = 0.5</div>
<div class="line"><a id="l03349" name="l03349"></a><span class="lineno"> 3349</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: ctfil2 = 1.0 - ctfil1</div>
<div class="line"><a id="l03350" name="l03350"></a><span class="lineno"> 3350</span> </div>
<div class="line"><a id="l03351" name="l03351"></a><span class="lineno"> 3351</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03352" name="l03352"></a><span class="lineno"> 3352</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil, ice, vegtyp</div>
<div class="line"><a id="l03353" name="l03353"></a><span class="lineno"> 3353</span> </div>
<div class="line"><a id="l03354" name="l03354"></a><span class="lineno"> 3354</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: smc(nsoil), smcmax, dt, yy,  &amp;</div>
<div class="line"><a id="l03355" name="l03355"></a><span class="lineno"> 3355</span>     &amp;       zz1, zsoil(nsoil), zbot, psisat, bexp, df1, quartz, csoil, &amp;</div>
<div class="line"><a id="l03356" name="l03356"></a><span class="lineno"> 3356</span>     &amp;       shdfac</div>
<div class="line"><a id="l03357" name="l03357"></a><span class="lineno"> 3357</span> </div>
<div class="line"><a id="l03358" name="l03358"></a><span class="lineno"> 3358</span>      <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: lheatstrg</div>
<div class="line"><a id="l03359" name="l03359"></a><span class="lineno"> 3359</span> </div>
<div class="line"><a id="l03360" name="l03360"></a><span class="lineno"> 3360</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03361" name="l03361"></a><span class="lineno"> 3361</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(inout)</span> :: stc(nsoil), t1, tbot,     &amp;</div>
<div class="line"><a id="l03362" name="l03362"></a><span class="lineno"> 3362</span>     &amp;       sh2o(nsoil)</div>
<div class="line"><a id="l03363" name="l03363"></a><span class="lineno"> 3363</span> </div>
<div class="line"><a id="l03364" name="l03364"></a><span class="lineno"> 3364</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03365" name="l03365"></a><span class="lineno"> 3365</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: ssoil</div>
<div class="line"><a id="l03366" name="l03366"></a><span class="lineno"> 3366</span> </div>
<div class="line"><a id="l03367" name="l03367"></a><span class="lineno"> 3367</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l03368" name="l03368"></a><span class="lineno"> 3368</span><span class="keywordtype">      real</span> (kind=kind_phys) :: ai(nsold), bi(nsold), ci(nsold), oldt1,  &amp;</div>
<div class="line"><a id="l03369" name="l03369"></a><span class="lineno"> 3369</span>     &amp;       rhsts(nsold), stcf(nsold), stsoil(nsoil)</div>
<div class="line"><a id="l03370" name="l03370"></a><span class="lineno"> 3370</span> </div>
<div class="line"><a id="l03371" name="l03371"></a><span class="lineno"> 3371</span>      <span class="keywordtype">integer</span> :: i</div>
<div class="line"><a id="l03372" name="l03372"></a><span class="lineno"> 3372</span> </div>
<div class="line"><a id="l03373" name="l03373"></a><span class="lineno"> 3373</span><span class="comment">!</span></div>
<div class="line"><a id="l03374" name="l03374"></a><span class="lineno"> 3374</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l03375" name="l03375"></a><span class="lineno"> 3375</span><span class="comment">!</span></div>
<div class="line"><a id="l03376" name="l03376"></a><span class="lineno"> 3376</span>      oldt1 = t1</div>
<div class="line"><a id="l03377" name="l03377"></a><span class="lineno"> 3377</span>      <span class="keywordflow">do</span> i = 1, nsoil</div>
<div class="line"><a id="l03378" name="l03378"></a><span class="lineno"> 3378</span>         stsoil(i) = stc(i)</div>
<div class="line"><a id="l03379" name="l03379"></a><span class="lineno"> 3379</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l03380" name="l03380"></a><span class="lineno"> 3380</span> </div>
<div class="line"><a id="l03381" name="l03381"></a><span class="lineno"> 3381</span><span class="comment">!  --- ...  hrt routine calcs the right hand side of the soil temp dif eqn</span></div>
<div class="line"><a id="l03382" name="l03382"></a><span class="lineno"> 3382</span> </div>
<div class="line"><a id="l03383" name="l03383"></a><span class="lineno"> 3383</span>      <span class="keywordflow">if</span> (ice /= 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03384" name="l03384"></a><span class="lineno"> 3384</span> </div>
<div class="line"><a id="l03385" name="l03385"></a><span class="lineno"> 3385</span><span class="comment">!  --- ...  sea-ice case, glacial-ice case</span></div>
<div class="line"><a id="l03386" name="l03386"></a><span class="lineno"> 3386</span> </div>
<div class="line"><a id="l03387" name="l03387"></a><span class="lineno"> 3387</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga32e89df3740f968f500900125ae9633d.html#ga32e89df3740f968f500900125ae9633d">hrtice</a>                                                     &amp;</div>
<div class="line"><a id="l03388" name="l03388"></a><span class="lineno"> 3388</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03389" name="l03389"></a><span class="lineno"> 3389</span>     &amp;     ( nsoil, stc, zsoil, yy, zz1, df1, ice,                      &amp;</div>
<div class="line"><a id="l03390" name="l03390"></a><span class="lineno"> 3390</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03391" name="l03391"></a><span class="lineno"> 3391</span>     &amp;       tbot,                                                      &amp;</div>
<div class="line"><a id="l03392" name="l03392"></a><span class="lineno"> 3392</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03393" name="l03393"></a><span class="lineno"> 3393</span>     &amp;       rhsts, ai, bi, ci                                          &amp;</div>
<div class="line"><a id="l03394" name="l03394"></a><span class="lineno"> 3394</span>     &amp;     )</div>
<div class="line"><a id="l03395" name="l03395"></a><span class="lineno"> 3395</span> </div>
<div class="line"><a id="l03396" name="l03396"></a><span class="lineno"> 3396</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gacb79bab20ee25c57918575949c15de73.html#gacb79bab20ee25c57918575949c15de73">hstep</a>                                                      &amp;</div>
<div class="line"><a id="l03397" name="l03397"></a><span class="lineno"> 3397</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03398" name="l03398"></a><span class="lineno"> 3398</span>     &amp;     ( nsoil, stc, dt,                                            &amp;</div>
<div class="line"><a id="l03399" name="l03399"></a><span class="lineno"> 3399</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03400" name="l03400"></a><span class="lineno"> 3400</span>     &amp;       rhsts, ai, bi, ci,                                         &amp;</div>
<div class="line"><a id="l03401" name="l03401"></a><span class="lineno"> 3401</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03402" name="l03402"></a><span class="lineno"> 3402</span>     &amp;       stcf                                                       &amp;</div>
<div class="line"><a id="l03403" name="l03403"></a><span class="lineno"> 3403</span>     &amp;     )</div>
<div class="line"><a id="l03404" name="l03404"></a><span class="lineno"> 3404</span> </div>
<div class="line"><a id="l03405" name="l03405"></a><span class="lineno"> 3405</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l03406" name="l03406"></a><span class="lineno"> 3406</span> </div>
<div class="line"><a id="l03407" name="l03407"></a><span class="lineno"> 3407</span><span class="comment">!  --- ...  land-mass case</span></div>
<div class="line"><a id="l03408" name="l03408"></a><span class="lineno"> 3408</span> </div>
<div class="line"><a id="l03409" name="l03409"></a><span class="lineno"> 3409</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gabb602c2b09396e2f94c9556259f5bae4.html#gabb602c2b09396e2f94c9556259f5bae4">hrt</a>                                                        &amp;</div>
<div class="line"><a id="l03410" name="l03410"></a><span class="lineno"> 3410</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03411" name="l03411"></a><span class="lineno"> 3411</span>     &amp;     ( nsoil, stc, smc, smcmax, zsoil, yy, zz1, tbot,             &amp;</div>
<div class="line"><a id="l03412" name="l03412"></a><span class="lineno"> 3412</span>     &amp;       zbot, psisat, dt, bexp, df1, quartz, csoil,vegtyp,         &amp;</div>
<div class="line"><a id="l03413" name="l03413"></a><span class="lineno"> 3413</span>     &amp;       shdfac, lheatstrg,                                         &amp;</div>
<div class="line"><a id="l03414" name="l03414"></a><span class="lineno"> 3414</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03415" name="l03415"></a><span class="lineno"> 3415</span>     &amp;       sh2o,                                                      &amp;</div>
<div class="line"><a id="l03416" name="l03416"></a><span class="lineno"> 3416</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03417" name="l03417"></a><span class="lineno"> 3417</span>     &amp;       rhsts, ai, bi, ci                                          &amp;</div>
<div class="line"><a id="l03418" name="l03418"></a><span class="lineno"> 3418</span>     &amp;     )</div>
<div class="line"><a id="l03419" name="l03419"></a><span class="lineno"> 3419</span> </div>
<div class="line"><a id="l03420" name="l03420"></a><span class="lineno"> 3420</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gacb79bab20ee25c57918575949c15de73.html#gacb79bab20ee25c57918575949c15de73">hstep</a>                                                      &amp;</div>
<div class="line"><a id="l03421" name="l03421"></a><span class="lineno"> 3421</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03422" name="l03422"></a><span class="lineno"> 3422</span>     &amp;     ( nsoil, stc, dt,                                            &amp;</div>
<div class="line"><a id="l03423" name="l03423"></a><span class="lineno"> 3423</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03424" name="l03424"></a><span class="lineno"> 3424</span>     &amp;       rhsts, ai, bi, ci,                                         &amp;</div>
<div class="line"><a id="l03425" name="l03425"></a><span class="lineno"> 3425</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03426" name="l03426"></a><span class="lineno"> 3426</span>     &amp;       stcf                                                       &amp;</div>
<div class="line"><a id="l03427" name="l03427"></a><span class="lineno"> 3427</span>     &amp;     )</div>
<div class="line"><a id="l03428" name="l03428"></a><span class="lineno"> 3428</span> </div>
<div class="line"><a id="l03429" name="l03429"></a><span class="lineno"> 3429</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l03430" name="l03430"></a><span class="lineno"> 3430</span> </div>
<div class="line"><a id="l03431" name="l03431"></a><span class="lineno"> 3431</span>      <span class="keywordflow">do</span> i = 1, nsoil</div>
<div class="line"><a id="l03432" name="l03432"></a><span class="lineno"> 3432</span>         stc(i) = stcf(i)</div>
<div class="line"><a id="l03433" name="l03433"></a><span class="lineno"> 3433</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l03434" name="l03434"></a><span class="lineno"> 3434</span> </div>
<div class="line"><a id="l03435" name="l03435"></a><span class="lineno"> 3435</span><span class="comment">!  --- ...  in the no snowpack case (via routine nopac branch,) update the grnd</span></div>
<div class="line"><a id="l03436" name="l03436"></a><span class="lineno"> 3436</span><span class="comment">!           (skin) temperature here in response to the updated soil temperature</span></div>
<div class="line"><a id="l03437" name="l03437"></a><span class="lineno"> 3437</span><span class="comment">!           profile above.  (note: inspection of routine snopac shows that t1</span></div>
<div class="line"><a id="l03438" name="l03438"></a><span class="lineno"> 3438</span><span class="comment">!           below is a dummy variable only, as skin temperature is updated</span></div>
<div class="line"><a id="l03439" name="l03439"></a><span class="lineno"> 3439</span><span class="comment">!           differently in routine snopac)</span></div>
<div class="line"><a id="l03440" name="l03440"></a><span class="lineno"> 3440</span> </div>
<div class="line"><a id="l03441" name="l03441"></a><span class="lineno"> 3441</span>      t1 = (yy + (zz1 - 1.0)*stc(1)) / zz1</div>
<div class="line"><a id="l03442" name="l03442"></a><span class="lineno"> 3442</span>      t1 = ctfil1*t1 + ctfil2*oldt1</div>
<div class="line"><a id="l03443" name="l03443"></a><span class="lineno"> 3443</span> </div>
<div class="line"><a id="l03444" name="l03444"></a><span class="lineno"> 3444</span>      <span class="keywordflow">do</span> i = 1, nsoil</div>
<div class="line"><a id="l03445" name="l03445"></a><span class="lineno"> 3445</span>        stc(i) = ctfil1*stc(i) + ctfil2*stsoil(i)</div>
<div class="line"><a id="l03446" name="l03446"></a><span class="lineno"> 3446</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l03447" name="l03447"></a><span class="lineno"> 3447</span> </div>
<div class="line"><a id="l03448" name="l03448"></a><span class="lineno"> 3448</span><span class="comment">!  --- ...  calculate surface soil heat flux</span></div>
<div class="line"><a id="l03449" name="l03449"></a><span class="lineno"> 3449</span> </div>
<div class="line"><a id="l03450" name="l03450"></a><span class="lineno"> 3450</span>      ssoil = df1*(stc(1) - t1) / (0.5*zsoil(1))</div>
<div class="line"><a id="l03451" name="l03451"></a><span class="lineno"> 3451</span> </div>
<div class="line"><a id="l03452" name="l03452"></a><span class="lineno"> 3452</span><span class="comment">!</span></div>
<div class="line"><a id="l03453" name="l03453"></a><span class="lineno"> 3453</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l03454" name="l03454"></a><span class="lineno"> 3454</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga977daabf4ff68b28fc5ccd8796d815cd.html#ga977daabf4ff68b28fc5ccd8796d815cd">shflx</a></div>
<div class="line"><a id="l03455" name="l03455"></a><span class="lineno"> 3455</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l03456" name="l03456"></a><span class="lineno"> 3456</span> </div>
<div class="line"><a id="l03457" name="l03457"></a><span class="lineno"> 3457</span> </div>
<div class="line"><a id="l03458" name="l03458"></a><span class="lineno"> 3458</span> </div>
<div class="line"><a id="l03459" name="l03459"></a><span class="lineno"> 3459</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l03460" name="l03460"></a><span class="lineno"> 3460</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l03461" name="l03461"></a><span class="lineno"> 3461</span><span class="comment">!&gt; This subroutine calculates soil moisture flux. The soil moisture</span></div>
<div class="line"><a id="l03462" name="l03462"></a><span class="lineno"> 3462</span><span class="comment">!! content (smc - a per unit vulume measurement) is a dependent variable</span></div>
<div class="line"><a id="l03463" name="l03463"></a><span class="lineno"> 3463</span><span class="comment">!! that is updated with prognostic equations. The canopy moisture content</span></div>
<div class="line"><a id="l03464" name="l03464"></a><span class="lineno"> 3464</span><span class="comment">!! (cmc) is also updated. Frozen ground version: new states added: sh2o and</span></div>
<div class="line"><a id="l03465" name="l03465"></a><span class="lineno"> 3465</span><span class="comment">!! frozen ground correction factor, frzx and parameter slope.</span></div>
<div class="foldopen" id="foldopen03466" data-start="" data-end="">
<div class="line"><a id="l03466" name="l03466"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gafa3e5637e56746e2539ef2567836defa.html#gafa3e5637e56746e2539ef2567836defa"> 3466</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gafa3e5637e56746e2539ef2567836defa.html#gafa3e5637e56746e2539ef2567836defa">smflx</a>                                                    &amp;</div>
<div class="line"><a id="l03467" name="l03467"></a><span class="lineno"> 3467</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03468" name="l03468"></a><span class="lineno"> 3468</span>     &amp;     ( nsoil, dt, kdt, smcmax, smcwlt, cmcmax, prcp1,               &amp;</div>
<div class="line"><a id="l03469" name="l03469"></a><span class="lineno"> 3469</span>     &amp;       zsoil, slope, frzx, bexp, dksat, dwsat, shdfac,              &amp;</div>
<div class="line"><a id="l03470" name="l03470"></a><span class="lineno"> 3470</span>     &amp;       edir1, ec1, et1,                                             &amp;</div>
<div class="line"><a id="l03471" name="l03471"></a><span class="lineno"> 3471</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03472" name="l03472"></a><span class="lineno"> 3472</span>     &amp;       cmc, sh2o, smc,                                              &amp;</div>
<div class="line"><a id="l03473" name="l03473"></a><span class="lineno"> 3473</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03474" name="l03474"></a><span class="lineno"> 3474</span>     &amp;       runoff1, runoff2, runoff3, drip                              &amp;</div>
<div class="line"><a id="l03475" name="l03475"></a><span class="lineno"> 3475</span>     &amp;     )</div>
<div class="line"><a id="l03476" name="l03476"></a><span class="lineno"> 3476</span> </div>
<div class="line"><a id="l03477" name="l03477"></a><span class="lineno"> 3477</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l03478" name="l03478"></a><span class="lineno"> 3478</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l03479" name="l03479"></a><span class="lineno"> 3479</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03480" name="l03480"></a><span class="lineno"> 3480</span><span class="comment">!  subroutine smflx calculates soil moisture flux.  the soil moisture   !</span></div>
<div class="line"><a id="l03481" name="l03481"></a><span class="lineno"> 3481</span><span class="comment">!  content (smc - a per unit volume measurement) is a dependent variable!</span></div>
<div class="line"><a id="l03482" name="l03482"></a><span class="lineno"> 3482</span><span class="comment">!  that is updated with prognostic eqns. the canopy moisture content    !</span></div>
<div class="line"><a id="l03483" name="l03483"></a><span class="lineno"> 3483</span><span class="comment">!  (cmc) is also updated. frozen ground version:  new states added: sh2o!</span></div>
<div class="line"><a id="l03484" name="l03484"></a><span class="lineno"> 3484</span><span class="comment">!  and frozen ground correction factor, frzx and parameter slope.       !</span></div>
<div class="line"><a id="l03485" name="l03485"></a><span class="lineno"> 3485</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03486" name="l03486"></a><span class="lineno"> 3486</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03487" name="l03487"></a><span class="lineno"> 3487</span><span class="comment">!  subprogram called:  srt, sstep                                       !</span></div>
<div class="line"><a id="l03488" name="l03488"></a><span class="lineno"> 3488</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03489" name="l03489"></a><span class="lineno"> 3489</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l03490" name="l03490"></a><span class="lineno"> 3490</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03491" name="l03491"></a><span class="lineno"> 3491</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l03492" name="l03492"></a><span class="lineno"> 3492</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l03493" name="l03493"></a><span class="lineno"> 3493</span><span class="comment">!     dt       - real, time step                                   1    !</span></div>
<div class="line"><a id="l03494" name="l03494"></a><span class="lineno"> 3494</span><span class="comment">!     kdt      - real,                                             1    !</span></div>
<div class="line"><a id="l03495" name="l03495"></a><span class="lineno"> 3495</span><span class="comment">!     smcmax   - real, porosity                                    1    !</span></div>
<div class="line"><a id="l03496" name="l03496"></a><span class="lineno"> 3496</span><span class="comment">!     smcwlt   - real, wilting point                               1    !</span></div>
<div class="line"><a id="l03497" name="l03497"></a><span class="lineno"> 3497</span><span class="comment">!     cmcmax   - real, maximum canopy water parameters             1    !</span></div>
<div class="line"><a id="l03498" name="l03498"></a><span class="lineno"> 3498</span><span class="comment">!     prcp1    - real, effective precip                            1    !</span></div>
<div class="line"><a id="l03499" name="l03499"></a><span class="lineno"> 3499</span><span class="comment">!     zsoil    - real, soil layer depth below ground (negative)  nsoil  !</span></div>
<div class="line"><a id="l03500" name="l03500"></a><span class="lineno"> 3500</span><span class="comment">!     slope    - real, linear reservoir coefficient                1    !</span></div>
<div class="line"><a id="l03501" name="l03501"></a><span class="lineno"> 3501</span><span class="comment">!     frzx     - real, frozen ground parameter                     1    !</span></div>
<div class="line"><a id="l03502" name="l03502"></a><span class="lineno"> 3502</span><span class="comment">!     bexp     - real, soil type &quot;b&quot; parameter                     1    !</span></div>
<div class="line"><a id="l03503" name="l03503"></a><span class="lineno"> 3503</span><span class="comment">!     dksat    - real, saturated soil hydraulic conductivity       1    !</span></div>
<div class="line"><a id="l03504" name="l03504"></a><span class="lineno"> 3504</span><span class="comment">!     dwsat    - real, saturated soil diffusivity                  1    !</span></div>
<div class="line"><a id="l03505" name="l03505"></a><span class="lineno"> 3505</span><span class="comment">!     shdfac   - real, aeral coverage of green veg                 1    !</span></div>
<div class="line"><a id="l03506" name="l03506"></a><span class="lineno"> 3506</span><span class="comment">!     edir1    - real, direct soil evaporation                     1    !</span></div>
<div class="line"><a id="l03507" name="l03507"></a><span class="lineno"> 3507</span><span class="comment">!     ec1      - real, canopy water evaporation                    1    !</span></div>
<div class="line"><a id="l03508" name="l03508"></a><span class="lineno"> 3508</span><span class="comment">!     et1      - real, plant transpiration                       nsoil  !</span></div>
<div class="line"><a id="l03509" name="l03509"></a><span class="lineno"> 3509</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03510" name="l03510"></a><span class="lineno"> 3510</span><span class="comment">!  input/outputs:                                                       !</span></div>
<div class="line"><a id="l03511" name="l03511"></a><span class="lineno"> 3511</span><span class="comment">!     cmc      - real, canopy moisture content                     1    !</span></div>
<div class="line"><a id="l03512" name="l03512"></a><span class="lineno"> 3512</span><span class="comment">!     sh2o     - real, unfrozen soil moisture                    nsoil  !</span></div>
<div class="line"><a id="l03513" name="l03513"></a><span class="lineno"> 3513</span><span class="comment">!     smc      - real, total soil moisture                       nsoil  !</span></div>
<div class="line"><a id="l03514" name="l03514"></a><span class="lineno"> 3514</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03515" name="l03515"></a><span class="lineno"> 3515</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l03516" name="l03516"></a><span class="lineno"> 3516</span><span class="comment">!     runoff1  - real, surface runoff not infiltrating sfc         1    !</span></div>
<div class="line"><a id="l03517" name="l03517"></a><span class="lineno"> 3517</span><span class="comment">!     runoff2  - real, sub surface runoff (baseflow)               1    !</span></div>
<div class="line"><a id="l03518" name="l03518"></a><span class="lineno"> 3518</span><span class="comment">!     runoff3  - real, excess of porosity                          1    !</span></div>
<div class="line"><a id="l03519" name="l03519"></a><span class="lineno"> 3519</span><span class="comment">!     drip     - real, through-fall of precip and/or dew           1    !</span></div>
<div class="line"><a id="l03520" name="l03520"></a><span class="lineno"> 3520</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03521" name="l03521"></a><span class="lineno"> 3521</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l03522" name="l03522"></a><span class="lineno"> 3522</span><span class="comment">!</span></div>
<div class="line"><a id="l03523" name="l03523"></a><span class="lineno"> 3523</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03524" name="l03524"></a><span class="lineno"> 3524</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil</div>
<div class="line"><a id="l03525" name="l03525"></a><span class="lineno"> 3525</span> </div>
<div class="line"><a id="l03526" name="l03526"></a><span class="lineno"> 3526</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">intent(in)</span> :: dt, kdt, smcmax, smcwlt,    &amp;</div>
<div class="line"><a id="l03527" name="l03527"></a><span class="lineno"> 3527</span>     &amp;       cmcmax, prcp1, slope, frzx, bexp, dksat, dwsat, shdfac,    &amp;</div>
<div class="line"><a id="l03528" name="l03528"></a><span class="lineno"> 3528</span>     &amp;       edir1, ec1, et1(nsoil), zsoil(nsoil)</div>
<div class="line"><a id="l03529" name="l03529"></a><span class="lineno"> 3529</span> </div>
<div class="line"><a id="l03530" name="l03530"></a><span class="lineno"> 3530</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03531" name="l03531"></a><span class="lineno"> 3531</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">intent(inout)</span> :: cmc, sh2o(nsoil),        &amp;</div>
<div class="line"><a id="l03532" name="l03532"></a><span class="lineno"> 3532</span>     &amp;       smc(nsoil)</div>
<div class="line"><a id="l03533" name="l03533"></a><span class="lineno"> 3533</span> </div>
<div class="line"><a id="l03534" name="l03534"></a><span class="lineno"> 3534</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03535" name="l03535"></a><span class="lineno"> 3535</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">intent(out)</span> :: runoff1, runoff2,          &amp;</div>
<div class="line"><a id="l03536" name="l03536"></a><span class="lineno"> 3536</span>     &amp;       runoff3, drip</div>
<div class="line"><a id="l03537" name="l03537"></a><span class="lineno"> 3537</span> </div>
<div class="line"><a id="l03538" name="l03538"></a><span class="lineno"> 3538</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l03539" name="l03539"></a><span class="lineno"> 3539</span><span class="keywordtype">      real</span> (kind=kind_phys) :: dummy, excess, pcpdrp, rhsct, trhsct,    &amp;</div>
<div class="line"><a id="l03540" name="l03540"></a><span class="lineno"> 3540</span>     &amp;       rhstt(nsold), sice(nsold), sh2oa(nsold), sh2ofg(nsold),    &amp;</div>
<div class="line"><a id="l03541" name="l03541"></a><span class="lineno"> 3541</span>     &amp;       ai(nsold), bi(nsold), ci(nsold)</div>
<div class="line"><a id="l03542" name="l03542"></a><span class="lineno"> 3542</span> </div>
<div class="line"><a id="l03543" name="l03543"></a><span class="lineno"> 3543</span>      <span class="keywordtype">integer</span> :: i, k</div>
<div class="line"><a id="l03544" name="l03544"></a><span class="lineno"> 3544</span><span class="comment">!</span></div>
<div class="line"><a id="l03545" name="l03545"></a><span class="lineno"> 3545</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l03546" name="l03546"></a><span class="lineno"> 3546</span><span class="comment">!</span></div>
<div class="line"><a id="l03547" name="l03547"></a><span class="lineno"> 3547</span><span class="comment">!  --- ...  executable code begins here.</span></div>
<div class="line"><a id="l03548" name="l03548"></a><span class="lineno"> 3548</span> </div>
<div class="line"><a id="l03549" name="l03549"></a><span class="lineno"> 3549</span>      dummy = 0.0</div>
<div class="line"><a id="l03550" name="l03550"></a><span class="lineno"> 3550</span> </div>
<div class="line"><a id="l03551" name="l03551"></a><span class="lineno"> 3551</span><span class="comment">!  --- ...  compute the right hand side of the canopy eqn term ( rhsct )</span></div>
<div class="line"><a id="l03552" name="l03552"></a><span class="lineno"> 3552</span> </div>
<div class="line"><a id="l03553" name="l03553"></a><span class="lineno"> 3553</span>      rhsct = shdfac*prcp1 - ec1</div>
<div class="line"><a id="l03554" name="l03554"></a><span class="lineno"> 3554</span> </div>
<div class="line"><a id="l03555" name="l03555"></a><span class="lineno"> 3555</span><span class="comment">!  --- ...  convert rhsct (a rate) to trhsct (an amount) and add it to</span></div>
<div class="line"><a id="l03556" name="l03556"></a><span class="lineno"> 3556</span><span class="comment">!           existing cmc.  if resulting amt exceeds max capacity, it becomes</span></div>
<div class="line"><a id="l03557" name="l03557"></a><span class="lineno"> 3557</span><span class="comment">!           drip and will fall to the grnd.</span></div>
<div class="line"><a id="l03558" name="l03558"></a><span class="lineno"> 3558</span> </div>
<div class="line"><a id="l03559" name="l03559"></a><span class="lineno"> 3559</span>      drip = 0.0</div>
<div class="line"><a id="l03560" name="l03560"></a><span class="lineno"> 3560</span>      trhsct = dt * rhsct</div>
<div class="line"><a id="l03561" name="l03561"></a><span class="lineno"> 3561</span>      excess = cmc + trhsct</div>
<div class="line"><a id="l03562" name="l03562"></a><span class="lineno"> 3562</span> </div>
<div class="line"><a id="l03563" name="l03563"></a><span class="lineno"> 3563</span>      <span class="keywordflow">if</span> (excess &gt; cmcmax) drip = excess - cmcmax</div>
<div class="line"><a id="l03564" name="l03564"></a><span class="lineno"> 3564</span> </div>
<div class="line"><a id="l03565" name="l03565"></a><span class="lineno"> 3565</span><span class="comment">!  --- ...  pcpdrp is the combined prcp1 and drip (from cmc) that goes into</span></div>
<div class="line"><a id="l03566" name="l03566"></a><span class="lineno"> 3566</span><span class="comment">!           the soil</span></div>
<div class="line"><a id="l03567" name="l03567"></a><span class="lineno"> 3567</span> </div>
<div class="line"><a id="l03568" name="l03568"></a><span class="lineno"> 3568</span>      pcpdrp = (1.0 - shdfac)*prcp1 + drip/dt</div>
<div class="line"><a id="l03569" name="l03569"></a><span class="lineno"> 3569</span> </div>
<div class="line"><a id="l03570" name="l03570"></a><span class="lineno"> 3570</span><span class="comment">!  --- ...  store ice content at each soil layer before calling srt &amp; sstep</span></div>
<div class="line"><a id="l03571" name="l03571"></a><span class="lineno"> 3571</span> </div>
<div class="line"><a id="l03572" name="l03572"></a><span class="lineno"> 3572</span>      <span class="keywordflow">do</span> i = 1, nsoil</div>
<div class="line"><a id="l03573" name="l03573"></a><span class="lineno"> 3573</span>        sice(i) = smc(i) - sh2o(i)</div>
<div class="line"><a id="l03574" name="l03574"></a><span class="lineno"> 3574</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l03575" name="l03575"></a><span class="lineno"> 3575</span> </div>
<div class="line"><a id="l03576" name="l03576"></a><span class="lineno"> 3576</span><span class="comment">!  --- ...  call subroutines srt and sstep to solve the soil moisture</span></div>
<div class="line"><a id="l03577" name="l03577"></a><span class="lineno"> 3577</span><span class="comment">!           tendency equations.</span></div>
<div class="line"><a id="l03578" name="l03578"></a><span class="lineno"> 3578</span> </div>
<div class="line"><a id="l03579" name="l03579"></a><span class="lineno"> 3579</span><span class="comment">!  ---  if the infiltrating precip rate is nontrivial,</span></div>
<div class="line"><a id="l03580" name="l03580"></a><span class="lineno"> 3580</span><span class="comment">!         (we consider nontrivial to be a precip total over the time step</span></div>
<div class="line"><a id="l03581" name="l03581"></a><span class="lineno"> 3581</span><span class="comment">!         exceeding one one-thousandth of the water holding capacity of</span></div>
<div class="line"><a id="l03582" name="l03582"></a><span class="lineno"> 3582</span><span class="comment">!         the first soil layer)</span></div>
<div class="line"><a id="l03583" name="l03583"></a><span class="lineno"> 3583</span><span class="comment">!       then call the srt/sstep subroutine pair twice in the manner of</span></div>
<div class="line"><a id="l03584" name="l03584"></a><span class="lineno"> 3584</span><span class="comment">!         time scheme &quot;f&quot; (implicit state, averaged coefficient)</span></div>
<div class="line"><a id="l03585" name="l03585"></a><span class="lineno"> 3585</span><span class="comment">!         of section 2 of kalnay and kanamitsu (1988, mwr, vol 116,</span></div>
<div class="line"><a id="l03586" name="l03586"></a><span class="lineno"> 3586</span><span class="comment">!         pages 1945-1958)to minimize 2-delta-t oscillations in the</span></div>
<div class="line"><a id="l03587" name="l03587"></a><span class="lineno"> 3587</span><span class="comment">!         soil moisture value of the top soil layer that can arise because</span></div>
<div class="line"><a id="l03588" name="l03588"></a><span class="lineno"> 3588</span><span class="comment">!         of the extreme nonlinear dependence of the soil hydraulic</span></div>
<div class="line"><a id="l03589" name="l03589"></a><span class="lineno"> 3589</span><span class="comment">!         diffusivity coefficient and the hydraulic conductivity on the</span></div>
<div class="line"><a id="l03590" name="l03590"></a><span class="lineno"> 3590</span><span class="comment">!         soil moisture state</span></div>
<div class="line"><a id="l03591" name="l03591"></a><span class="lineno"> 3591</span><span class="comment">!       otherwise call the srt/sstep subroutine pair once in the manner of</span></div>
<div class="line"><a id="l03592" name="l03592"></a><span class="lineno"> 3592</span><span class="comment">!         time scheme &quot;d&quot; (implicit state, explicit coefficient)</span></div>
<div class="line"><a id="l03593" name="l03593"></a><span class="lineno"> 3593</span><span class="comment">!         of section 2 of kalnay and kanamitsu</span></div>
<div class="line"><a id="l03594" name="l03594"></a><span class="lineno"> 3594</span><span class="comment">!       pcpdrp is units of kg/m**2/s or mm/s, zsoil is negative depth in m</span></div>
<div class="line"><a id="l03595" name="l03595"></a><span class="lineno"> 3595</span> </div>
<div class="line"><a id="l03596" name="l03596"></a><span class="lineno"> 3596</span><span class="comment">!     if ( pcpdrp .gt. 0.0 ) then</span></div>
<div class="line"><a id="l03597" name="l03597"></a><span class="lineno"> 3597</span>      <span class="keywordflow">if</span> ( (pcpdrp*dt) &gt; (0.001*1000.0*(-zsoil(1))*smcmax) ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03598" name="l03598"></a><span class="lineno"> 3598</span> </div>
<div class="line"><a id="l03599" name="l03599"></a><span class="lineno"> 3599</span><span class="comment">!  --- ...  frozen ground version:</span></div>
<div class="line"><a id="l03600" name="l03600"></a><span class="lineno"> 3600</span><span class="comment">!           smc states replaced by sh2o states in srt subr.  sh2o &amp; sice states</span></div>
<div class="line"><a id="l03601" name="l03601"></a><span class="lineno"> 3601</span><span class="comment">!           included in sstep subr.  frozen ground correction factor, frzx</span></div>
<div class="line"><a id="l03602" name="l03602"></a><span class="lineno"> 3602</span><span class="comment">!           added.  all water balance calculations using unfrozen water</span></div>
<div class="line"><a id="l03603" name="l03603"></a><span class="lineno"> 3603</span> </div>
<div class="line"><a id="l03604" name="l03604"></a><span class="lineno"> 3604</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gaf59c85cce3b10eaa0ffeb366de9d5304.html#gaf59c85cce3b10eaa0ffeb366de9d5304">srt</a>                                                        &amp;</div>
<div class="line"><a id="l03605" name="l03605"></a><span class="lineno"> 3605</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03606" name="l03606"></a><span class="lineno"> 3606</span>     &amp;     ( nsoil, edir1, et1, sh2o, sh2o, pcpdrp, zsoil, dwsat,       &amp;</div>
<div class="line"><a id="l03607" name="l03607"></a><span class="lineno"> 3607</span>     &amp;       dksat, smcmax, bexp, dt, smcwlt, slope, kdt, frzx, sice,   &amp;</div>
<div class="line"><a id="l03608" name="l03608"></a><span class="lineno"> 3608</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03609" name="l03609"></a><span class="lineno"> 3609</span>     &amp;       rhstt, runoff1, runoff2, ai, bi, ci                        &amp;</div>
<div class="line"><a id="l03610" name="l03610"></a><span class="lineno"> 3610</span>     &amp;     )</div>
<div class="line"><a id="l03611" name="l03611"></a><span class="lineno"> 3611</span> </div>
<div class="line"><a id="l03612" name="l03612"></a><span class="lineno"> 3612</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga22b00b15c1b261126ec2d15719cb3aa4.html#ga22b00b15c1b261126ec2d15719cb3aa4">sstep</a>                                                      &amp;</div>
<div class="line"><a id="l03613" name="l03613"></a><span class="lineno"> 3613</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03614" name="l03614"></a><span class="lineno"> 3614</span>     &amp;     ( nsoil, sh2o, rhsct, dt, smcmax, cmcmax, zsoil, sice,       &amp;</div>
<div class="line"><a id="l03615" name="l03615"></a><span class="lineno"> 3615</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03616" name="l03616"></a><span class="lineno"> 3616</span>     &amp;       dummy, rhstt, ai, bi, ci,                                  &amp;</div>
<div class="line"><a id="l03617" name="l03617"></a><span class="lineno"> 3617</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03618" name="l03618"></a><span class="lineno"> 3618</span>     &amp;       sh2ofg, runoff3, smc                                       &amp;</div>
<div class="line"><a id="l03619" name="l03619"></a><span class="lineno"> 3619</span>     &amp;     )</div>
<div class="line"><a id="l03620" name="l03620"></a><span class="lineno"> 3620</span> </div>
<div class="line"><a id="l03621" name="l03621"></a><span class="lineno"> 3621</span>        <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l03622" name="l03622"></a><span class="lineno"> 3622</span>          sh2oa(k) = (sh2o(k) + sh2ofg(k)) * 0.5</div>
<div class="line"><a id="l03623" name="l03623"></a><span class="lineno"> 3623</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l03624" name="l03624"></a><span class="lineno"> 3624</span> </div>
<div class="line"><a id="l03625" name="l03625"></a><span class="lineno"> 3625</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gaf59c85cce3b10eaa0ffeb366de9d5304.html#gaf59c85cce3b10eaa0ffeb366de9d5304">srt</a>                                                        &amp;</div>
<div class="line"><a id="l03626" name="l03626"></a><span class="lineno"> 3626</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03627" name="l03627"></a><span class="lineno"> 3627</span>     &amp;     ( nsoil, edir1, et1, sh2o, sh2oa, pcpdrp, zsoil, dwsat,      &amp;</div>
<div class="line"><a id="l03628" name="l03628"></a><span class="lineno"> 3628</span>     &amp;       dksat, smcmax, bexp, dt, smcwlt, slope, kdt, frzx, sice,   &amp;</div>
<div class="line"><a id="l03629" name="l03629"></a><span class="lineno"> 3629</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03630" name="l03630"></a><span class="lineno"> 3630</span>     &amp;       rhstt, runoff1, runoff2, ai, bi, ci                        &amp;</div>
<div class="line"><a id="l03631" name="l03631"></a><span class="lineno"> 3631</span>     &amp;     )</div>
<div class="line"><a id="l03632" name="l03632"></a><span class="lineno"> 3632</span> </div>
<div class="line"><a id="l03633" name="l03633"></a><span class="lineno"> 3633</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga22b00b15c1b261126ec2d15719cb3aa4.html#ga22b00b15c1b261126ec2d15719cb3aa4">sstep</a>                                                      &amp;</div>
<div class="line"><a id="l03634" name="l03634"></a><span class="lineno"> 3634</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03635" name="l03635"></a><span class="lineno"> 3635</span>     &amp;     ( nsoil, sh2o, rhsct, dt, smcmax, cmcmax, zsoil, sice,       &amp;</div>
<div class="line"><a id="l03636" name="l03636"></a><span class="lineno"> 3636</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03637" name="l03637"></a><span class="lineno"> 3637</span>     &amp;       cmc, rhstt, ai, bi, ci,                                    &amp;</div>
<div class="line"><a id="l03638" name="l03638"></a><span class="lineno"> 3638</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03639" name="l03639"></a><span class="lineno"> 3639</span>     &amp;       sh2o, runoff3, smc                                         &amp;</div>
<div class="line"><a id="l03640" name="l03640"></a><span class="lineno"> 3640</span>     &amp;     )</div>
<div class="line"><a id="l03641" name="l03641"></a><span class="lineno"> 3641</span> </div>
<div class="line"><a id="l03642" name="l03642"></a><span class="lineno"> 3642</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l03643" name="l03643"></a><span class="lineno"> 3643</span> </div>
<div class="line"><a id="l03644" name="l03644"></a><span class="lineno"> 3644</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gaf59c85cce3b10eaa0ffeb366de9d5304.html#gaf59c85cce3b10eaa0ffeb366de9d5304">srt</a>                                                        &amp;</div>
<div class="line"><a id="l03645" name="l03645"></a><span class="lineno"> 3645</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03646" name="l03646"></a><span class="lineno"> 3646</span>     &amp;     ( nsoil, edir1, et1, sh2o, sh2o, pcpdrp, zsoil, dwsat,       &amp;</div>
<div class="line"><a id="l03647" name="l03647"></a><span class="lineno"> 3647</span>     &amp;       dksat, smcmax, bexp, dt, smcwlt, slope, kdt, frzx, sice,   &amp;</div>
<div class="line"><a id="l03648" name="l03648"></a><span class="lineno"> 3648</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03649" name="l03649"></a><span class="lineno"> 3649</span>     &amp;       rhstt, runoff1, runoff2, ai, bi, ci                        &amp;</div>
<div class="line"><a id="l03650" name="l03650"></a><span class="lineno"> 3650</span>     &amp;     )</div>
<div class="line"><a id="l03651" name="l03651"></a><span class="lineno"> 3651</span> </div>
<div class="line"><a id="l03652" name="l03652"></a><span class="lineno"> 3652</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga22b00b15c1b261126ec2d15719cb3aa4.html#ga22b00b15c1b261126ec2d15719cb3aa4">sstep</a>                                                      &amp;</div>
<div class="line"><a id="l03653" name="l03653"></a><span class="lineno"> 3653</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03654" name="l03654"></a><span class="lineno"> 3654</span>     &amp;     ( nsoil, sh2o, rhsct, dt, smcmax, cmcmax, zsoil, sice,       &amp;</div>
<div class="line"><a id="l03655" name="l03655"></a><span class="lineno"> 3655</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03656" name="l03656"></a><span class="lineno"> 3656</span>     &amp;       cmc, rhstt, ai, bi, ci,                                    &amp;</div>
<div class="line"><a id="l03657" name="l03657"></a><span class="lineno"> 3657</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03658" name="l03658"></a><span class="lineno"> 3658</span>     &amp;       sh2o, runoff3, smc                                         &amp;</div>
<div class="line"><a id="l03659" name="l03659"></a><span class="lineno"> 3659</span>     &amp;     )</div>
<div class="line"><a id="l03660" name="l03660"></a><span class="lineno"> 3660</span> </div>
<div class="line"><a id="l03661" name="l03661"></a><span class="lineno"> 3661</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l03662" name="l03662"></a><span class="lineno"> 3662</span> </div>
<div class="line"><a id="l03663" name="l03663"></a><span class="lineno"> 3663</span><span class="comment">!     runof = runoff</span></div>
<div class="line"><a id="l03664" name="l03664"></a><span class="lineno"> 3664</span><span class="comment">!</span></div>
<div class="line"><a id="l03665" name="l03665"></a><span class="lineno"> 3665</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l03666" name="l03666"></a><span class="lineno"> 3666</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gafa3e5637e56746e2539ef2567836defa.html#gafa3e5637e56746e2539ef2567836defa">smflx</a></div>
<div class="line"><a id="l03667" name="l03667"></a><span class="lineno"> 3667</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l03668" name="l03668"></a><span class="lineno"> 3668</span> </div>
<div class="line"><a id="l03669" name="l03669"></a><span class="lineno"> 3669</span> </div>
<div class="line"><a id="l03670" name="l03670"></a><span class="lineno"> 3670</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l03671" name="l03671"></a><span class="lineno"> 3671</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l03672" name="l03672"></a><span class="lineno"> 3672</span><span class="comment">!&gt; This subroutine calculates compaction of a snowpack under conditions of</span></div>
<div class="line"><a id="l03673" name="l03673"></a><span class="lineno"> 3673</span><span class="comment">!! increasing snow density, as obtained from an approximate solution of</span></div>
<div class="line"><a id="l03674" name="l03674"></a><span class="lineno"> 3674</span><span class="comment">!! E. Anderson&#39;s differential equation (3.29),NOAA technical report NWS 19,</span></div>
<div class="line"><a id="l03675" name="l03675"></a><span class="lineno"> 3675</span><span class="comment">!! by Victor Koren, 03/25/95. subroutine will return new values of \a snowh</span></div>
<div class="line"><a id="l03676" name="l03676"></a><span class="lineno"> 3676</span><span class="comment">!! and \a sndens .</span></div>
<div class="foldopen" id="foldopen03677" data-start="" data-end="">
<div class="line"><a id="l03677" name="l03677"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gab5149f309f4e291435f75dd63d4a97ac.html#gab5149f309f4e291435f75dd63d4a97ac"> 3677</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gab5149f309f4e291435f75dd63d4a97ac.html#gab5149f309f4e291435f75dd63d4a97ac">snowpack</a>                                               &amp;</div>
<div class="line"><a id="l03678" name="l03678"></a><span class="lineno"> 3678</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03679" name="l03679"></a><span class="lineno"> 3679</span>     &amp;     ( esd, dtsec, tsnow, tsoil,                                  &amp;</div>
<div class="line"><a id="l03680" name="l03680"></a><span class="lineno"> 3680</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03681" name="l03681"></a><span class="lineno"> 3681</span>     &amp;       snowh, sndens                                              &amp;</div>
<div class="line"><a id="l03682" name="l03682"></a><span class="lineno"> 3682</span>     &amp;     )</div>
<div class="line"><a id="l03683" name="l03683"></a><span class="lineno"> 3683</span> </div>
<div class="line"><a id="l03684" name="l03684"></a><span class="lineno"> 3684</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l03685" name="l03685"></a><span class="lineno"> 3685</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l03686" name="l03686"></a><span class="lineno"> 3686</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03687" name="l03687"></a><span class="lineno"> 3687</span><span class="comment">!    subroutine snowpack calculates compaction of snowpack under        !</span></div>
<div class="line"><a id="l03688" name="l03688"></a><span class="lineno"> 3688</span><span class="comment">!    conditions of increasing snow density, as obtained from an         !</span></div>
<div class="line"><a id="l03689" name="l03689"></a><span class="lineno"> 3689</span><span class="comment">!    approximate solution of e. anderson&#39;s differential equation (3.29),!</span></div>
<div class="line"><a id="l03690" name="l03690"></a><span class="lineno"> 3690</span><span class="comment">!    noaa technical report nws 19, by victor koren, 03/25/95.           !</span></div>
<div class="line"><a id="l03691" name="l03691"></a><span class="lineno"> 3691</span><span class="comment">!    subroutine will return new values of snowh and sndens              !</span></div>
<div class="line"><a id="l03692" name="l03692"></a><span class="lineno"> 3692</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03693" name="l03693"></a><span class="lineno"> 3693</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03694" name="l03694"></a><span class="lineno"> 3694</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l03695" name="l03695"></a><span class="lineno"> 3695</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03696" name="l03696"></a><span class="lineno"> 3696</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03697" name="l03697"></a><span class="lineno"> 3697</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l03698" name="l03698"></a><span class="lineno"> 3698</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03699" name="l03699"></a><span class="lineno"> 3699</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l03700" name="l03700"></a><span class="lineno"> 3700</span><span class="comment">!     esd      - real, water equivalent of snow (m)                1    !</span></div>
<div class="line"><a id="l03701" name="l03701"></a><span class="lineno"> 3701</span><span class="comment">!     dtsec    - real, time step (sec)                             1    !</span></div>
<div class="line"><a id="l03702" name="l03702"></a><span class="lineno"> 3702</span><span class="comment">!     tsnow    - real, snow surface temperature (k)                1    !</span></div>
<div class="line"><a id="l03703" name="l03703"></a><span class="lineno"> 3703</span><span class="comment">!     tsoil    - real, soil surface temperature (k)                1    !</span></div>
<div class="line"><a id="l03704" name="l03704"></a><span class="lineno"> 3704</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03705" name="l03705"></a><span class="lineno"> 3705</span><span class="comment">!  input/outputs:                                                       !</span></div>
<div class="line"><a id="l03706" name="l03706"></a><span class="lineno"> 3706</span><span class="comment">!     snowh    - real, snow depth (m)                              1    !</span></div>
<div class="line"><a id="l03707" name="l03707"></a><span class="lineno"> 3707</span><span class="comment">!     sndens   - real, snow density                                1    !</span></div>
<div class="line"><a id="l03708" name="l03708"></a><span class="lineno"> 3708</span><span class="comment">!                      (g/cm3=dimensionless fraction of h2o density)    !</span></div>
<div class="line"><a id="l03709" name="l03709"></a><span class="lineno"> 3709</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03710" name="l03710"></a><span class="lineno"> 3710</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l03711" name="l03711"></a><span class="lineno"> 3711</span><span class="comment">!</span></div>
<div class="line"><a id="l03712" name="l03712"></a><span class="lineno"> 3712</span><span class="comment">!  ---  parameter constants:</span></div>
<div class="line"><a id="l03713" name="l03713"></a><span class="lineno"> 3713</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: c1 = 0.01</div>
<div class="line"><a id="l03714" name="l03714"></a><span class="lineno"> 3714</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: c2 = 21.0</div>
<div class="line"><a id="l03715" name="l03715"></a><span class="lineno"> 3715</span> </div>
<div class="line"><a id="l03716" name="l03716"></a><span class="lineno"> 3716</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03717" name="l03717"></a><span class="lineno"> 3717</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: esd, dtsec, tsnow, tsoil</div>
<div class="line"><a id="l03718" name="l03718"></a><span class="lineno"> 3718</span> </div>
<div class="line"><a id="l03719" name="l03719"></a><span class="lineno"> 3719</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l03720" name="l03720"></a><span class="lineno"> 3720</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(inout)</span> :: snowh, sndens</div>
<div class="line"><a id="l03721" name="l03721"></a><span class="lineno"> 3721</span> </div>
<div class="line"><a id="l03722" name="l03722"></a><span class="lineno"> 3722</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l03723" name="l03723"></a><span class="lineno"> 3723</span><span class="keywordtype">      real</span> (kind=kind_phys) :: bfac, dsx, dthr, dw, snowhc, pexp,       &amp;</div>
<div class="line"><a id="l03724" name="l03724"></a><span class="lineno"> 3724</span>     &amp;       tavgc, tsnowc, tsoilc, esdc, esdcx</div>
<div class="line"><a id="l03725" name="l03725"></a><span class="lineno"> 3725</span> </div>
<div class="line"><a id="l03726" name="l03726"></a><span class="lineno"> 3726</span>      <span class="keywordtype">integer</span> :: ipol, j</div>
<div class="line"><a id="l03727" name="l03727"></a><span class="lineno"> 3727</span><span class="comment">!</span></div>
<div class="line"><a id="l03728" name="l03728"></a><span class="lineno"> 3728</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l03729" name="l03729"></a><span class="lineno"> 3729</span><span class="comment">!</span></div>
<div class="line"><a id="l03730" name="l03730"></a><span class="lineno"> 3730</span><span class="comment">!  --- ...  conversion into simulation units</span></div>
<div class="line"><a id="l03731" name="l03731"></a><span class="lineno"> 3731</span> </div>
<div class="line"><a id="l03732" name="l03732"></a><span class="lineno"> 3732</span>      snowhc = snowh * 100.0</div>
<div class="line"><a id="l03733" name="l03733"></a><span class="lineno"> 3733</span>      esdc   = esd * 100.0</div>
<div class="line"><a id="l03734" name="l03734"></a><span class="lineno"> 3734</span>      dthr   = dtsec / 3600.0</div>
<div class="line"><a id="l03735" name="l03735"></a><span class="lineno"> 3735</span>      tsnowc = tsnow - tfreez</div>
<div class="line"><a id="l03736" name="l03736"></a><span class="lineno"> 3736</span>      tsoilc = tsoil - tfreez</div>
<div class="line"><a id="l03737" name="l03737"></a><span class="lineno"> 3737</span> </div>
<div class="line"><a id="l03738" name="l03738"></a><span class="lineno"> 3738</span><span class="comment">!  --- ...  calculating of average temperature of snow pack</span></div>
<div class="line"><a id="l03739" name="l03739"></a><span class="lineno"> 3739</span> </div>
<div class="line"><a id="l03740" name="l03740"></a><span class="lineno"> 3740</span>      tavgc = 0.5 * (tsnowc + tsoilc)</div>
<div class="line"><a id="l03741" name="l03741"></a><span class="lineno"> 3741</span> </div>
<div class="line"><a id="l03742" name="l03742"></a><span class="lineno"> 3742</span><span class="comment">!  --- ...  calculating of snow depth and density as a result of compaction</span></div>
<div class="line"><a id="l03743" name="l03743"></a><span class="lineno"> 3743</span><span class="comment">!           sndens=ds0*(exp(bfac*esd)-1.)/(bfac*esd)</span></div>
<div class="line"><a id="l03744" name="l03744"></a><span class="lineno"> 3744</span><span class="comment">!           bfac=dthr*c1*exp(0.08*tavgc-c2*ds0)</span></div>
<div class="line"><a id="l03745" name="l03745"></a><span class="lineno"> 3745</span><span class="comment">!     note: bfac*esd in sndens eqn above has to be carefully treated</span></div>
<div class="line"><a id="l03746" name="l03746"></a><span class="lineno"> 3746</span><span class="comment">!           numerically below:</span></div>
<div class="line"><a id="l03747" name="l03747"></a><span class="lineno"> 3747</span><span class="comment">!        c1 is the fractional increase in density (1/(cm*hr))</span></div>
<div class="line"><a id="l03748" name="l03748"></a><span class="lineno"> 3748</span><span class="comment">!        c2 is a constant (cm3/g) kojima estimated as 21 cms/g</span></div>
<div class="line"><a id="l03749" name="l03749"></a><span class="lineno"> 3749</span> </div>
<div class="line"><a id="l03750" name="l03750"></a><span class="lineno"> 3750</span>      <span class="keywordflow">if</span> (esdc &gt; 1.e-2) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03751" name="l03751"></a><span class="lineno"> 3751</span>        esdcx = esdc</div>
<div class="line"><a id="l03752" name="l03752"></a><span class="lineno"> 3752</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l03753" name="l03753"></a><span class="lineno"> 3753</span>        esdcx = 1.e-2</div>
<div class="line"><a id="l03754" name="l03754"></a><span class="lineno"> 3754</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l03755" name="l03755"></a><span class="lineno"> 3755</span> </div>
<div class="line"><a id="l03756" name="l03756"></a><span class="lineno"> 3756</span>      bfac = dthr*c1 * exp(0.08*tavgc - c2*sndens)</div>
<div class="line"><a id="l03757" name="l03757"></a><span class="lineno"> 3757</span> </div>
<div class="line"><a id="l03758" name="l03758"></a><span class="lineno"> 3758</span><span class="comment">!     dsx = sndens * ((dexp(bfac*esdc)-1.0) / (bfac*esdc))</span></div>
<div class="line"><a id="l03759" name="l03759"></a><span class="lineno"> 3759</span> </div>
<div class="line"><a id="l03760" name="l03760"></a><span class="lineno"> 3760</span><span class="comment">!  --- ...  the function of the form (e**x-1)/x imbedded in above expression</span></div>
<div class="line"><a id="l03761" name="l03761"></a><span class="lineno"> 3761</span><span class="comment">!           for dsx was causing numerical difficulties when the denominator &quot;x&quot;</span></div>
<div class="line"><a id="l03762" name="l03762"></a><span class="lineno"> 3762</span><span class="comment">!           (i.e. bfac*esdc) became zero or approached zero (despite the fact</span></div>
<div class="line"><a id="l03763" name="l03763"></a><span class="lineno"> 3763</span><span class="comment">!           that the analytical function (e**x-1)/x has a well defined limit</span></div>
<div class="line"><a id="l03764" name="l03764"></a><span class="lineno"> 3764</span><span class="comment">!           as &quot;x&quot; approaches zero), hence below we replace the (e**x-1)/x</span></div>
<div class="line"><a id="l03765" name="l03765"></a><span class="lineno"> 3765</span><span class="comment">!           expression with an equivalent, numerically well-behaved</span></div>
<div class="line"><a id="l03766" name="l03766"></a><span class="lineno"> 3766</span><span class="comment">!           polynomial expansion.</span></div>
<div class="line"><a id="l03767" name="l03767"></a><span class="lineno"> 3767</span> </div>
<div class="line"><a id="l03768" name="l03768"></a><span class="lineno"> 3768</span><span class="comment">!  --- ...  number of terms of polynomial expansion, and hence its accuracy,</span></div>
<div class="line"><a id="l03769" name="l03769"></a><span class="lineno"> 3769</span><span class="comment">!           is governed by iteration limit &quot;ipol&quot;.</span></div>
<div class="line"><a id="l03770" name="l03770"></a><span class="lineno"> 3770</span><span class="comment">!           ipol greater than 9 only makes a difference on double</span></div>
<div class="line"><a id="l03771" name="l03771"></a><span class="lineno"> 3771</span><span class="comment">!           precision (relative errors given in percent %).</span></div>
<div class="line"><a id="l03772" name="l03772"></a><span class="lineno"> 3772</span><span class="comment">!       ipol=9, for rel.error &lt;~ 1.6 e-6 % (8 significant digits)</span></div>
<div class="line"><a id="l03773" name="l03773"></a><span class="lineno"> 3773</span><span class="comment">!       ipol=8, for rel.error &lt;~ 1.8 e-5 % (7 significant digits)</span></div>
<div class="line"><a id="l03774" name="l03774"></a><span class="lineno"> 3774</span><span class="comment">!       ipol=7, for rel.error &lt;~ 1.8 e-4 % ...</span></div>
<div class="line"><a id="l03775" name="l03775"></a><span class="lineno"> 3775</span> </div>
<div class="line"><a id="l03776" name="l03776"></a><span class="lineno"> 3776</span>      ipol = 4</div>
<div class="line"><a id="l03777" name="l03777"></a><span class="lineno"> 3777</span>      pexp = 0.0</div>
<div class="line"><a id="l03778" name="l03778"></a><span class="lineno"> 3778</span> </div>
<div class="line"><a id="l03779" name="l03779"></a><span class="lineno"> 3779</span>      <span class="keywordflow">do</span> j = ipol, 1, -1</div>
<div class="line"><a id="l03780" name="l03780"></a><span class="lineno"> 3780</span><span class="comment">!       pexp = (1.0 + pexp)*bfac*esdc /real(j+1)</span></div>
<div class="line"><a id="l03781" name="l03781"></a><span class="lineno"> 3781</span>        pexp = (1.0 + pexp)*bfac*esdcx/real(j+1)</div>
<div class="line"><a id="l03782" name="l03782"></a><span class="lineno"> 3782</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l03783" name="l03783"></a><span class="lineno"> 3783</span>      pexp = pexp + 1.</div>
<div class="line"><a id="l03784" name="l03784"></a><span class="lineno"> 3784</span> </div>
<div class="line"><a id="l03785" name="l03785"></a><span class="lineno"> 3785</span>      dsx = sndens * pexp</div>
<div class="line"><a id="l03786" name="l03786"></a><span class="lineno"> 3786</span> </div>
<div class="line"><a id="l03787" name="l03787"></a><span class="lineno"> 3787</span><span class="comment">!  --- ...  above line ends polynomial substitution</span></div>
<div class="line"><a id="l03788" name="l03788"></a><span class="lineno"> 3788</span><span class="comment">!           end of koren formulation</span></div>
<div class="line"><a id="l03789" name="l03789"></a><span class="lineno"> 3789</span> </div>
<div class="line"><a id="l03790" name="l03790"></a><span class="lineno"> 3790</span><span class="comment">!! --- ...  base formulation (cogley et al., 1990)</span></div>
<div class="line"><a id="l03791" name="l03791"></a><span class="lineno"> 3791</span><span class="comment">!           convert density from g/cm3 to kg/m3</span></div>
<div class="line"><a id="l03792" name="l03792"></a><span class="lineno"> 3792</span> </div>
<div class="line"><a id="l03793" name="l03793"></a><span class="lineno"> 3793</span><span class="comment">!!      dsm = sndens * 1000.0</span></div>
<div class="line"><a id="l03794" name="l03794"></a><span class="lineno"> 3794</span> </div>
<div class="line"><a id="l03795" name="l03795"></a><span class="lineno"> 3795</span><span class="comment">!!      dsx = dsm + dtsec*0.5*dsm*gs2*esd /                             &amp;</span></div>
<div class="line"><a id="l03796" name="l03796"></a><span class="lineno"> 3796</span><span class="comment">!!   &amp;        (1.e7*exp(-0.02*dsm + kn/(tavgc+273.16)-14.643))</span></div>
<div class="line"><a id="l03797" name="l03797"></a><span class="lineno"> 3797</span> </div>
<div class="line"><a id="l03798" name="l03798"></a><span class="lineno"> 3798</span><span class="comment">!! --- ...  convert density from kg/m3 to g/cm3</span></div>
<div class="line"><a id="l03799" name="l03799"></a><span class="lineno"> 3799</span> </div>
<div class="line"><a id="l03800" name="l03800"></a><span class="lineno"> 3800</span><span class="comment">!!      dsx = dsx / 1000.0</span></div>
<div class="line"><a id="l03801" name="l03801"></a><span class="lineno"> 3801</span> </div>
<div class="line"><a id="l03802" name="l03802"></a><span class="lineno"> 3802</span><span class="comment">!! --- ...  end of cogley et al. formulation</span></div>
<div class="line"><a id="l03803" name="l03803"></a><span class="lineno"> 3803</span> </div>
<div class="line"><a id="l03804" name="l03804"></a><span class="lineno"> 3804</span><span class="comment">!  --- ...  set upper/lower limit on snow density</span></div>
<div class="line"><a id="l03805" name="l03805"></a><span class="lineno"> 3805</span> </div>
<div class="line"><a id="l03806" name="l03806"></a><span class="lineno"> 3806</span>      dsx = max( min( dsx, 0.40 ), 0.05 )</div>
<div class="line"><a id="l03807" name="l03807"></a><span class="lineno"> 3807</span>      sndens = dsx</div>
<div class="line"><a id="l03808" name="l03808"></a><span class="lineno"> 3808</span> </div>
<div class="line"><a id="l03809" name="l03809"></a><span class="lineno"> 3809</span><span class="comment">!  --- ...  update of snow depth and density depending on liquid water</span></div>
<div class="line"><a id="l03810" name="l03810"></a><span class="lineno"> 3810</span><span class="comment">!           during snowmelt.  assumed that 13% of liquid water can be</span></div>
<div class="line"><a id="l03811" name="l03811"></a><span class="lineno"> 3811</span><span class="comment">!           stored in snow per day during snowmelt till snow density 0.40.</span></div>
<div class="line"><a id="l03812" name="l03812"></a><span class="lineno"> 3812</span> </div>
<div class="line"><a id="l03813" name="l03813"></a><span class="lineno"> 3813</span>      <span class="keywordflow">if</span> (tsnowc &gt;= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03814" name="l03814"></a><span class="lineno"> 3814</span>        dw = 0.13 * dthr / 24.0</div>
<div class="line"><a id="l03815" name="l03815"></a><span class="lineno"> 3815</span>        sndens = sndens*(1.0 - dw) + dw</div>
<div class="line"><a id="l03816" name="l03816"></a><span class="lineno"> 3816</span>        <span class="keywordflow">if</span> (sndens &gt; 0.40) sndens = 0.40</div>
<div class="line"><a id="l03817" name="l03817"></a><span class="lineno"> 3817</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l03818" name="l03818"></a><span class="lineno"> 3818</span> </div>
<div class="line"><a id="l03819" name="l03819"></a><span class="lineno"> 3819</span><span class="comment">!  --- ...  calculate snow depth (cm) from snow water equivalent and snow</span></div>
<div class="line"><a id="l03820" name="l03820"></a><span class="lineno"> 3820</span><span class="comment">!           density. change snow depth units to meters</span></div>
<div class="line"><a id="l03821" name="l03821"></a><span class="lineno"> 3821</span> </div>
<div class="line"><a id="l03822" name="l03822"></a><span class="lineno"> 3822</span>      snowhc = esdc / sndens</div>
<div class="line"><a id="l03823" name="l03823"></a><span class="lineno"> 3823</span>      snowh  = snowhc * 0.01</div>
<div class="line"><a id="l03824" name="l03824"></a><span class="lineno"> 3824</span> </div>
<div class="line"><a id="l03825" name="l03825"></a><span class="lineno"> 3825</span><span class="comment">!</span></div>
<div class="line"><a id="l03826" name="l03826"></a><span class="lineno"> 3826</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l03827" name="l03827"></a><span class="lineno"> 3827</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gab5149f309f4e291435f75dd63d4a97ac.html#gab5149f309f4e291435f75dd63d4a97ac">snowpack</a></div>
<div class="line"><a id="l03828" name="l03828"></a><span class="lineno"> 3828</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l03829" name="l03829"></a><span class="lineno"> 3829</span> </div>
<div class="line"><a id="l03830" name="l03830"></a><span class="lineno"> 3830</span> </div>
<div class="line"><a id="l03831" name="l03831"></a><span class="lineno"> 3831</span><span class="comment">!*********************************************!</span></div>
<div class="line"><a id="l03832" name="l03832"></a><span class="lineno"> 3832</span><span class="comment">!  section-3  3rd or lower level subprograms  !</span></div>
<div class="line"><a id="l03833" name="l03833"></a><span class="lineno"> 3833</span><span class="comment">!*********************************************!</span></div>
<div class="line"><a id="l03834" name="l03834"></a><span class="lineno"> 3834</span> </div>
<div class="line"><a id="l03835" name="l03835"></a><span class="lineno"> 3835</span> </div>
<div class="line"><a id="l03836" name="l03836"></a><span class="lineno"> 3836</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l03837" name="l03837"></a><span class="lineno"> 3837</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l03838" name="l03838"></a><span class="lineno"> 3838</span><span class="comment">!&gt; This subrtouine calculates direct soil evaporation.</span></div>
<div class="foldopen" id="foldopen03839" data-start="" data-end="">
<div class="line"><a id="l03839" name="l03839"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gabf8ee2c002871d95bc356e2058f49a92.html#gabf8ee2c002871d95bc356e2058f49a92"> 3839</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gabf8ee2c002871d95bc356e2058f49a92.html#gabf8ee2c002871d95bc356e2058f49a92">devap</a>                                                  &amp;</div>
<div class="line"><a id="l03840" name="l03840"></a><span class="lineno"> 3840</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03841" name="l03841"></a><span class="lineno"> 3841</span>     &amp;     ( etp1, smc, shdfac, smcmax, smcdry, fxexp,                  &amp;</div>
<div class="line"><a id="l03842" name="l03842"></a><span class="lineno"> 3842</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03843" name="l03843"></a><span class="lineno"> 3843</span>     &amp;       edir1                                                      &amp;</div>
<div class="line"><a id="l03844" name="l03844"></a><span class="lineno"> 3844</span>     &amp;     )</div>
<div class="line"><a id="l03845" name="l03845"></a><span class="lineno"> 3845</span> </div>
<div class="line"><a id="l03846" name="l03846"></a><span class="lineno"> 3846</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l03847" name="l03847"></a><span class="lineno"> 3847</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l03848" name="l03848"></a><span class="lineno"> 3848</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03849" name="l03849"></a><span class="lineno"> 3849</span><span class="comment">!  subroutine devap calculates direct soil evaporation                  !</span></div>
<div class="line"><a id="l03850" name="l03850"></a><span class="lineno"> 3850</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03851" name="l03851"></a><span class="lineno"> 3851</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03852" name="l03852"></a><span class="lineno"> 3852</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l03853" name="l03853"></a><span class="lineno"> 3853</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03854" name="l03854"></a><span class="lineno"> 3854</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03855" name="l03855"></a><span class="lineno"> 3855</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l03856" name="l03856"></a><span class="lineno"> 3856</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03857" name="l03857"></a><span class="lineno"> 3857</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l03858" name="l03858"></a><span class="lineno"> 3858</span><span class="comment">!     etp1     - real, potential evaporation                       1    !</span></div>
<div class="line"><a id="l03859" name="l03859"></a><span class="lineno"> 3859</span><span class="comment">!     smc      - real, unfrozen soil moisture                      1    !</span></div>
<div class="line"><a id="l03860" name="l03860"></a><span class="lineno"> 3860</span><span class="comment">!     shdfac   - real, aeral coverage of green vegetation          1    !</span></div>
<div class="line"><a id="l03861" name="l03861"></a><span class="lineno"> 3861</span><span class="comment">!     smcmax   - real, porosity (sat val of soil mois)             1    !</span></div>
<div class="line"><a id="l03862" name="l03862"></a><span class="lineno"> 3862</span><span class="comment">!     smcdry   - real, dry soil mois threshold                     1    !</span></div>
<div class="line"><a id="l03863" name="l03863"></a><span class="lineno"> 3863</span><span class="comment">!     fxexp    - real, bare soil evaporation exponent              1    !</span></div>
<div class="line"><a id="l03864" name="l03864"></a><span class="lineno"> 3864</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03865" name="l03865"></a><span class="lineno"> 3865</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l03866" name="l03866"></a><span class="lineno"> 3866</span><span class="comment">!     edir1    - real, direct soil evaporation                     1    !</span></div>
<div class="line"><a id="l03867" name="l03867"></a><span class="lineno"> 3867</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03868" name="l03868"></a><span class="lineno"> 3868</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l03869" name="l03869"></a><span class="lineno"> 3869</span><span class="comment">!</span></div>
<div class="line"><a id="l03870" name="l03870"></a><span class="lineno"> 3870</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03871" name="l03871"></a><span class="lineno"> 3871</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: etp1, smc, shdfac, smcmax,   &amp;</div>
<div class="line"><a id="l03872" name="l03872"></a><span class="lineno"> 3872</span>     &amp;       smcdry, fxexp</div>
<div class="line"><a id="l03873" name="l03873"></a><span class="lineno"> 3873</span> </div>
<div class="line"><a id="l03874" name="l03874"></a><span class="lineno"> 3874</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03875" name="l03875"></a><span class="lineno"> 3875</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: edir1</div>
<div class="line"><a id="l03876" name="l03876"></a><span class="lineno"> 3876</span> </div>
<div class="line"><a id="l03877" name="l03877"></a><span class="lineno"> 3877</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l03878" name="l03878"></a><span class="lineno"> 3878</span><span class="keywordtype">      real</span> (kind=kind_phys) :: fx, sratio</div>
<div class="line"><a id="l03879" name="l03879"></a><span class="lineno"> 3879</span><span class="comment">!</span></div>
<div class="line"><a id="l03880" name="l03880"></a><span class="lineno"> 3880</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l03881" name="l03881"></a><span class="lineno"> 3881</span><span class="comment">!</span></div>
<div class="line"><a id="l03882" name="l03882"></a><span class="lineno"> 3882</span><span class="comment">!  --- ...  direct evap a function of relative soil moisture availability,</span></div>
<div class="line"><a id="l03883" name="l03883"></a><span class="lineno"> 3883</span><span class="comment">!           linear when fxexp=1.</span></div>
<div class="line"><a id="l03884" name="l03884"></a><span class="lineno"> 3884</span><span class="comment">!           fx &gt; 1 represents demand control</span></div>
<div class="line"><a id="l03885" name="l03885"></a><span class="lineno"> 3885</span><span class="comment">!           fx &lt; 1 represents flux control</span></div>
<div class="line"><a id="l03886" name="l03886"></a><span class="lineno"> 3886</span> </div>
<div class="line"><a id="l03887" name="l03887"></a><span class="lineno"> 3887</span>      sratio = (smc - smcdry) / (smcmax - smcdry)</div>
<div class="line"><a id="l03888" name="l03888"></a><span class="lineno"> 3888</span> </div>
<div class="line"><a id="l03889" name="l03889"></a><span class="lineno"> 3889</span>      <span class="keywordflow">if</span> (sratio &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03890" name="l03890"></a><span class="lineno"> 3890</span>        fx = sratio**fxexp</div>
<div class="line"><a id="l03891" name="l03891"></a><span class="lineno"> 3891</span>        fx = max( min( fx, 1.0 ), 0.0 )</div>
<div class="line"><a id="l03892" name="l03892"></a><span class="lineno"> 3892</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l03893" name="l03893"></a><span class="lineno"> 3893</span>        fx = 0.0</div>
<div class="line"><a id="l03894" name="l03894"></a><span class="lineno"> 3894</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l03895" name="l03895"></a><span class="lineno"> 3895</span> </div>
<div class="line"><a id="l03896" name="l03896"></a><span class="lineno"> 3896</span><span class="comment">!  --- ...  allow for the direct-evap-reducing effect of shade</span></div>
<div class="line"><a id="l03897" name="l03897"></a><span class="lineno"> 3897</span> </div>
<div class="line"><a id="l03898" name="l03898"></a><span class="lineno"> 3898</span>      edir1 = fx * ( 1.0 - shdfac ) * etp1</div>
<div class="line"><a id="l03899" name="l03899"></a><span class="lineno"> 3899</span><span class="comment">!</span></div>
<div class="line"><a id="l03900" name="l03900"></a><span class="lineno"> 3900</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l03901" name="l03901"></a><span class="lineno"> 3901</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gabf8ee2c002871d95bc356e2058f49a92.html#gabf8ee2c002871d95bc356e2058f49a92">devap</a></div>
<div class="line"><a id="l03902" name="l03902"></a><span class="lineno"> 3902</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l03903" name="l03903"></a><span class="lineno"> 3903</span> </div>
<div class="line"><a id="l03904" name="l03904"></a><span class="lineno"> 3904</span> </div>
<div class="line"><a id="l03905" name="l03905"></a><span class="lineno"> 3905</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l03906" name="l03906"></a><span class="lineno"> 3906</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l03907" name="l03907"></a><span class="lineno"> 3907</span><span class="comment">!&gt; This subroutine calculates amount of supercooled liquid soil water</span></div>
<div class="line"><a id="l03908" name="l03908"></a><span class="lineno"> 3908</span><span class="comment">!! content if temperature is below 273.15K (t0). It requires Newton-type</span></div>
<div class="line"><a id="l03909" name="l03909"></a><span class="lineno"> 3909</span><span class="comment">!! iteration to solve the nonlinear implicit equation given in eqn 17</span></div>
<div class="line"><a id="l03910" name="l03910"></a><span class="lineno"> 3910</span><span class="comment">!! of Koren et al.(1999) \cite koren_et_al_1999.</span></div>
<div class="line"><a id="l03911" name="l03911"></a><span class="lineno"> 3911</span><span class="comment">!!</span></div>
<div class="line"><a id="l03912" name="l03912"></a><span class="lineno"> 3912</span><span class="comment">!! New version (June 2001): much faster and more accurate Newton iteration</span></div>
<div class="line"><a id="l03913" name="l03913"></a><span class="lineno"> 3913</span><span class="comment">!! achieved by first taking log of eqn cited above -- less than 4 (typically</span></div>
<div class="line"><a id="l03914" name="l03914"></a><span class="lineno"> 3914</span><span class="comment">!! 1 or 2) iterations achieves convergence. Also, explicit 1-step solution</span></div>
<div class="line"><a id="l03915" name="l03915"></a><span class="lineno"> 3915</span><span class="comment">!! option for special case of paramter ck=0, which reduces the orginal</span></div>
<div class="line"><a id="l03916" name="l03916"></a><span class="lineno"> 3916</span><span class="comment">!! implicit equation to a simpler explicit form, known as the &quot;flerchinger eqn&quot;.</span></div>
<div class="line"><a id="l03917" name="l03917"></a><span class="lineno"> 3917</span><span class="comment">!! Improved handling of solution in the limit of freezing point temperature t0.</span></div>
<div class="foldopen" id="foldopen03918" data-start="" data-end="">
<div class="line"><a id="l03918" name="l03918"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga7c0e713811400259a984b2153834e70c.html#ga7c0e713811400259a984b2153834e70c"> 3918</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga7c0e713811400259a984b2153834e70c.html#ga7c0e713811400259a984b2153834e70c">frh2o</a>                                                  &amp;</div>
<div class="line"><a id="l03919" name="l03919"></a><span class="lineno"> 3919</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03920" name="l03920"></a><span class="lineno"> 3920</span>     &amp;     ( tkelv, smc, sh2o, smcmax, bexp, psis,                      &amp;</div>
<div class="line"><a id="l03921" name="l03921"></a><span class="lineno"> 3921</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03922" name="l03922"></a><span class="lineno"> 3922</span>     &amp;       liqwat                                                     &amp;</div>
<div class="line"><a id="l03923" name="l03923"></a><span class="lineno"> 3923</span>     &amp;     )</div>
<div class="line"><a id="l03924" name="l03924"></a><span class="lineno"> 3924</span> </div>
<div class="line"><a id="l03925" name="l03925"></a><span class="lineno"> 3925</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l03926" name="l03926"></a><span class="lineno"> 3926</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l03927" name="l03927"></a><span class="lineno"> 3927</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03928" name="l03928"></a><span class="lineno"> 3928</span><span class="comment">!  subroutine frh2o calculates amount of supercooled liquid soil water  !</span></div>
<div class="line"><a id="l03929" name="l03929"></a><span class="lineno"> 3929</span><span class="comment">!  content if temperature is below 273.15k (t0).  requires newton-type  !</span></div>
<div class="line"><a id="l03930" name="l03930"></a><span class="lineno"> 3930</span><span class="comment">!  iteration to solve the nonlinear implicit equation given in eqn 17   !</span></div>
<div class="line"><a id="l03931" name="l03931"></a><span class="lineno"> 3931</span><span class="comment">!  of koren et al (1999, jgr, vol 104(d16), 19569-19585).               !</span></div>
<div class="line"><a id="l03932" name="l03932"></a><span class="lineno"> 3932</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03933" name="l03933"></a><span class="lineno"> 3933</span><span class="comment">!  new version (june 2001): much faster and more accurate newton        !</span></div>
<div class="line"><a id="l03934" name="l03934"></a><span class="lineno"> 3934</span><span class="comment">!  iteration achieved by first taking log of eqn cited above -- less    !</span></div>
<div class="line"><a id="l03935" name="l03935"></a><span class="lineno"> 3935</span><span class="comment">!  than 4 (typically 1 or 2) iterations achieves convergence.  also,    !</span></div>
<div class="line"><a id="l03936" name="l03936"></a><span class="lineno"> 3936</span><span class="comment">!  explicit 1-step solution option for special case of parameter ck=0,  !</span></div>
<div class="line"><a id="l03937" name="l03937"></a><span class="lineno"> 3937</span><span class="comment">!  which reduces the original implicit equation to a simpler explicit   !</span></div>
<div class="line"><a id="l03938" name="l03938"></a><span class="lineno"> 3938</span><span class="comment">!  form, known as the &quot;flerchinger eqn&quot;. improved handling of solution  !</span></div>
<div class="line"><a id="l03939" name="l03939"></a><span class="lineno"> 3939</span><span class="comment">!  in the limit of freezing point temperature t0.                       !</span></div>
<div class="line"><a id="l03940" name="l03940"></a><span class="lineno"> 3940</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03941" name="l03941"></a><span class="lineno"> 3941</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l03942" name="l03942"></a><span class="lineno"> 3942</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03943" name="l03943"></a><span class="lineno"> 3943</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03944" name="l03944"></a><span class="lineno"> 3944</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l03945" name="l03945"></a><span class="lineno"> 3945</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03946" name="l03946"></a><span class="lineno"> 3946</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l03947" name="l03947"></a><span class="lineno"> 3947</span><span class="comment">!     tkelv    - real, temperature (k)                             1    !</span></div>
<div class="line"><a id="l03948" name="l03948"></a><span class="lineno"> 3948</span><span class="comment">!     smc      - real, total soil moisture content (volumetric)    1    !</span></div>
<div class="line"><a id="l03949" name="l03949"></a><span class="lineno"> 3949</span><span class="comment">!     sh2o     - real, liquid soil moisture content (volumetric)   1    !</span></div>
<div class="line"><a id="l03950" name="l03950"></a><span class="lineno"> 3950</span><span class="comment">!     smcmax   - real, saturation soil moisture content            1    !</span></div>
<div class="line"><a id="l03951" name="l03951"></a><span class="lineno"> 3951</span><span class="comment">!     bexp     - real, soil type &quot;b&quot; parameter                     1    !</span></div>
<div class="line"><a id="l03952" name="l03952"></a><span class="lineno"> 3952</span><span class="comment">!     psis     - real, saturated soil matric potential             1    !</span></div>
<div class="line"><a id="l03953" name="l03953"></a><span class="lineno"> 3953</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03954" name="l03954"></a><span class="lineno"> 3954</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l03955" name="l03955"></a><span class="lineno"> 3955</span><span class="comment">!     liqwat   - real, supercooled liquid water content            1    !</span></div>
<div class="line"><a id="l03956" name="l03956"></a><span class="lineno"> 3956</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l03957" name="l03957"></a><span class="lineno"> 3957</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l03958" name="l03958"></a><span class="lineno"> 3958</span><span class="comment">!</span></div>
<div class="line"><a id="l03959" name="l03959"></a><span class="lineno"> 3959</span><span class="comment">!  ---  constant parameters:</span></div>
<div class="line"><a id="l03960" name="l03960"></a><span class="lineno"> 3960</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: ck    = 8.0</div>
<div class="line"><a id="l03961" name="l03961"></a><span class="lineno"> 3961</span><span class="comment">!     real (kind=kind_phys), parameter :: ck    = 0.0</span></div>
<div class="line"><a id="l03962" name="l03962"></a><span class="lineno"> 3962</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: blim  = 5.5</div>
<div class="line"><a id="l03963" name="l03963"></a><span class="lineno"> 3963</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: <a class="code hl_function" href="group___noah_m_p___l_s_m_gace27cd3a7b4e23955e39e33bd344baae.html#gace27cd3a7b4e23955e39e33bd344baae">error</a> = 0.005</div>
<div class="line"><a id="l03964" name="l03964"></a><span class="lineno"> 3964</span> </div>
<div class="line"><a id="l03965" name="l03965"></a><span class="lineno"> 3965</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l03966" name="l03966"></a><span class="lineno"> 3966</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: tkelv, smc, sh2o, smcmax,    &amp;</div>
<div class="line"><a id="l03967" name="l03967"></a><span class="lineno"> 3967</span>     &amp;       bexp, psis</div>
<div class="line"><a id="l03968" name="l03968"></a><span class="lineno"> 3968</span> </div>
<div class="line"><a id="l03969" name="l03969"></a><span class="lineno"> 3969</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l03970" name="l03970"></a><span class="lineno"> 3970</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: liqwat</div>
<div class="line"><a id="l03971" name="l03971"></a><span class="lineno"> 3971</span> </div>
<div class="line"><a id="l03972" name="l03972"></a><span class="lineno"> 3972</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l03973" name="l03973"></a><span class="lineno"> 3973</span><span class="keywordtype">      real</span> (kind=kind_phys) :: bx, denom, df, dswl, fk, swl, swlk</div>
<div class="line"><a id="l03974" name="l03974"></a><span class="lineno"> 3974</span> </div>
<div class="line"><a id="l03975" name="l03975"></a><span class="lineno"> 3975</span>      <span class="keywordtype">integer</span> :: nlog, kcount</div>
<div class="line"><a id="l03976" name="l03976"></a><span class="lineno"> 3976</span><span class="comment">!</span></div>
<div class="line"><a id="l03977" name="l03977"></a><span class="lineno"> 3977</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l03978" name="l03978"></a><span class="lineno"> 3978</span><span class="comment">!</span></div>
<div class="line"><a id="l03979" name="l03979"></a><span class="lineno"> 3979</span><span class="comment">!  --- ...  limits on parameter b: b &lt; 5.5  (use parameter blim)</span></div>
<div class="line"><a id="l03980" name="l03980"></a><span class="lineno"> 3980</span><span class="comment">!           simulations showed if b &gt; 5.5 unfrozen water content is</span></div>
<div class="line"><a id="l03981" name="l03981"></a><span class="lineno"> 3981</span><span class="comment">!           non-realistically high at very low temperatures.</span></div>
<div class="line"><a id="l03982" name="l03982"></a><span class="lineno"> 3982</span> </div>
<div class="line"><a id="l03983" name="l03983"></a><span class="lineno"> 3983</span>      bx = bexp</div>
<div class="line"><a id="l03984" name="l03984"></a><span class="lineno"> 3984</span>      <span class="keywordflow">if</span> (bexp &gt; blim)  bx = blim</div>
<div class="line"><a id="l03985" name="l03985"></a><span class="lineno"> 3985</span> </div>
<div class="line"><a id="l03986" name="l03986"></a><span class="lineno"> 3986</span><span class="comment">!  --- ...  initializing iterations counter and iterative solution flag.</span></div>
<div class="line"><a id="l03987" name="l03987"></a><span class="lineno"> 3987</span> </div>
<div class="line"><a id="l03988" name="l03988"></a><span class="lineno"> 3988</span>      nlog  = 0</div>
<div class="line"><a id="l03989" name="l03989"></a><span class="lineno"> 3989</span>      kcount= 0</div>
<div class="line"><a id="l03990" name="l03990"></a><span class="lineno"> 3990</span> </div>
<div class="line"><a id="l03991" name="l03991"></a><span class="lineno"> 3991</span><span class="comment">!  --- ...  if temperature not significantly below freezing (t0), sh2o = smc</span></div>
<div class="line"><a id="l03992" name="l03992"></a><span class="lineno"> 3992</span> </div>
<div class="line"><a id="l03993" name="l03993"></a><span class="lineno"> 3993</span>      <span class="keywordflow">if</span> (tkelv &gt; (tfreez-1.e-3)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l03994" name="l03994"></a><span class="lineno"> 3994</span> </div>
<div class="line"><a id="l03995" name="l03995"></a><span class="lineno"> 3995</span>        liqwat = smc</div>
<div class="line"><a id="l03996" name="l03996"></a><span class="lineno"> 3996</span> </div>
<div class="line"><a id="l03997" name="l03997"></a><span class="lineno"> 3997</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l03998" name="l03998"></a><span class="lineno"> 3998</span> </div>
<div class="line"><a id="l03999" name="l03999"></a><span class="lineno"> 3999</span>        <span class="keywordflow">if</span> (ck /= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04000" name="l04000"></a><span class="lineno"> 4000</span> </div>
<div class="line"><a id="l04001" name="l04001"></a><span class="lineno"> 4001</span><span class="comment">!  --- ...  option 1: iterated solution for nonzero ck</span></div>
<div class="line"><a id="l04002" name="l04002"></a><span class="lineno"> 4002</span><span class="comment">!                     in koren et al, jgr, 1999, eqn 17</span></div>
<div class="line"><a id="l04003" name="l04003"></a><span class="lineno"> 4003</span> </div>
<div class="line"><a id="l04004" name="l04004"></a><span class="lineno"> 4004</span><span class="comment">!  --- ...  initial guess for swl (frozen content)</span></div>
<div class="line"><a id="l04005" name="l04005"></a><span class="lineno"> 4005</span> </div>
<div class="line"><a id="l04006" name="l04006"></a><span class="lineno"> 4006</span>          swl = smc - sh2o</div>
<div class="line"><a id="l04007" name="l04007"></a><span class="lineno"> 4007</span> </div>
<div class="line"><a id="l04008" name="l04008"></a><span class="lineno"> 4008</span><span class="comment">!  --- ...  keep within bounds.</span></div>
<div class="line"><a id="l04009" name="l04009"></a><span class="lineno"> 4009</span> </div>
<div class="line"><a id="l04010" name="l04010"></a><span class="lineno"> 4010</span>          swl = max( min( swl, smc-0.02 ), 0.0 )</div>
<div class="line"><a id="l04011" name="l04011"></a><span class="lineno"> 4011</span> </div>
<div class="line"><a id="l04012" name="l04012"></a><span class="lineno"> 4012</span><span class="comment">!  --- ...  start of iterations</span></div>
<div class="line"><a id="l04013" name="l04013"></a><span class="lineno"> 4013</span> </div>
<div class="line"><a id="l04014" name="l04014"></a><span class="lineno"> 4014</span>          <span class="keywordflow">do</span> <span class="keywordflow">while</span> ( (nlog &lt; 10) .and. (kcount == 0) )</div>
<div class="line"><a id="l04015" name="l04015"></a><span class="lineno"> 4015</span>            nlog = nlog + 1</div>
<div class="line"><a id="l04016" name="l04016"></a><span class="lineno"> 4016</span> </div>
<div class="line"><a id="l04017" name="l04017"></a><span class="lineno"> 4017</span>            df = log( (psis*gs2/lsubf) * ( (1.0 + ck*swl)**2.0 )        &amp;</div>
<div class="line"><a id="l04018" name="l04018"></a><span class="lineno"> 4018</span>     &amp;         * (smcmax/(smc-swl))**bx ) - log(-(tkelv-tfreez)/tkelv)</div>
<div class="line"><a id="l04019" name="l04019"></a><span class="lineno"> 4019</span> </div>
<div class="line"><a id="l04020" name="l04020"></a><span class="lineno"> 4020</span>            denom = 2.0*ck/(1.0 + ck*swl) + bx/(smc - swl)</div>
<div class="line"><a id="l04021" name="l04021"></a><span class="lineno"> 4021</span>            swlk  = swl - df/denom</div>
<div class="line"><a id="l04022" name="l04022"></a><span class="lineno"> 4022</span> </div>
<div class="line"><a id="l04023" name="l04023"></a><span class="lineno"> 4023</span><span class="comment">!  --- ...  bounds useful for mathematical solution.</span></div>
<div class="line"><a id="l04024" name="l04024"></a><span class="lineno"> 4024</span> </div>
<div class="line"><a id="l04025" name="l04025"></a><span class="lineno"> 4025</span>            swlk = max( min( swlk, smc-0.02 ), 0.0 )</div>
<div class="line"><a id="l04026" name="l04026"></a><span class="lineno"> 4026</span> </div>
<div class="line"><a id="l04027" name="l04027"></a><span class="lineno"> 4027</span><span class="comment">!  --- ...  mathematical solution bounds applied.</span></div>
<div class="line"><a id="l04028" name="l04028"></a><span class="lineno"> 4028</span> </div>
<div class="line"><a id="l04029" name="l04029"></a><span class="lineno"> 4029</span>            dswl = abs(swlk - swl)</div>
<div class="line"><a id="l04030" name="l04030"></a><span class="lineno"> 4030</span>            swl = swlk</div>
<div class="line"><a id="l04031" name="l04031"></a><span class="lineno"> 4031</span> </div>
<div class="line"><a id="l04032" name="l04032"></a><span class="lineno"> 4032</span><span class="comment">!  --- ...  if more than 10 iterations, use explicit method (ck=0 approx.)</span></div>
<div class="line"><a id="l04033" name="l04033"></a><span class="lineno"> 4033</span><span class="comment">!           when dswl less or eq. error, no more iterations required.</span></div>
<div class="line"><a id="l04034" name="l04034"></a><span class="lineno"> 4034</span> </div>
<div class="line"><a id="l04035" name="l04035"></a><span class="lineno"> 4035</span>            <span class="keywordflow">if</span> ( dswl &lt;= <a class="code hl_function" href="group___noah_m_p___l_s_m_gace27cd3a7b4e23955e39e33bd344baae.html#gace27cd3a7b4e23955e39e33bd344baae">error</a> )  <span class="keywordflow">then</span></div>
<div class="line"><a id="l04036" name="l04036"></a><span class="lineno"> 4036</span>              kcount = kcount + 1</div>
<div class="line"><a id="l04037" name="l04037"></a><span class="lineno"> 4037</span><span class="keywordflow">            endif</span></div>
<div class="line"><a id="l04038" name="l04038"></a><span class="lineno"> 4038</span><span class="keywordflow">          enddo</span>   <span class="comment">!  end do_while_loop</span></div>
<div class="line"><a id="l04039" name="l04039"></a><span class="lineno"> 4039</span> </div>
<div class="line"><a id="l04040" name="l04040"></a><span class="lineno"> 4040</span><span class="comment">!  --- ...  bounds applied within do-block are valid for physical solution.</span></div>
<div class="line"><a id="l04041" name="l04041"></a><span class="lineno"> 4041</span> </div>
<div class="line"><a id="l04042" name="l04042"></a><span class="lineno"> 4042</span>          liqwat = smc - swl</div>
<div class="line"><a id="l04043" name="l04043"></a><span class="lineno"> 4043</span> </div>
<div class="line"><a id="l04044" name="l04044"></a><span class="lineno"> 4044</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_ck_block</span></div>
<div class="line"><a id="l04045" name="l04045"></a><span class="lineno"> 4045</span> </div>
<div class="line"><a id="l04046" name="l04046"></a><span class="lineno"> 4046</span><span class="comment">!  --- ...  option 2: explicit solution for flerchinger eq. i.e. ck=0</span></div>
<div class="line"><a id="l04047" name="l04047"></a><span class="lineno"> 4047</span><span class="comment">!                     in koren et al., jgr, 1999, eqn 17</span></div>
<div class="line"><a id="l04048" name="l04048"></a><span class="lineno"> 4048</span><span class="comment">!           apply physical bounds to flerchinger solution</span></div>
<div class="line"><a id="l04049" name="l04049"></a><span class="lineno"> 4049</span> </div>
<div class="line"><a id="l04050" name="l04050"></a><span class="lineno"> 4050</span>        <span class="keywordflow">if</span> (kcount == 0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04051" name="l04051"></a><span class="lineno"> 4051</span>          fk = ( ( (lsubf/(gs2*(-psis)))                                &amp;</div>
<div class="line"><a id="l04052" name="l04052"></a><span class="lineno"> 4052</span>     &amp;       * ((tkelv-tfreez)/tkelv) )**(-1/bx) ) * smcmax</div>
<div class="line"><a id="l04053" name="l04053"></a><span class="lineno"> 4053</span> </div>
<div class="line"><a id="l04054" name="l04054"></a><span class="lineno"> 4054</span>          fk = max( fk, 0.02 )</div>
<div class="line"><a id="l04055" name="l04055"></a><span class="lineno"> 4055</span> </div>
<div class="line"><a id="l04056" name="l04056"></a><span class="lineno"> 4056</span>          liqwat = min( fk, smc )</div>
<div class="line"><a id="l04057" name="l04057"></a><span class="lineno"> 4057</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l04058" name="l04058"></a><span class="lineno"> 4058</span> </div>
<div class="line"><a id="l04059" name="l04059"></a><span class="lineno"> 4059</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_tkelv_block</span></div>
<div class="line"><a id="l04060" name="l04060"></a><span class="lineno"> 4060</span><span class="comment">!</span></div>
<div class="line"><a id="l04061" name="l04061"></a><span class="lineno"> 4061</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l04062" name="l04062"></a><span class="lineno"> 4062</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga7c0e713811400259a984b2153834e70c.html#ga7c0e713811400259a984b2153834e70c">frh2o</a></div>
<div class="line"><a id="l04063" name="l04063"></a><span class="lineno"> 4063</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l04064" name="l04064"></a><span class="lineno"> 4064</span> </div>
<div class="line"><a id="l04065" name="l04065"></a><span class="lineno"> 4065</span> </div>
<div class="line"><a id="l04066" name="l04066"></a><span class="lineno"> 4066</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l04067" name="l04067"></a><span class="lineno"> 4067</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l04068" name="l04068"></a><span class="lineno"> 4068</span><span class="comment">!&gt; This subroutine calculates the right hand side of the time tendency</span></div>
<div class="line"><a id="l04069" name="l04069"></a><span class="lineno"> 4069</span><span class="comment">!! term of the soil thermal diffusion equation. Also to compute (prepare)</span></div>
<div class="line"><a id="l04070" name="l04070"></a><span class="lineno"> 4070</span><span class="comment">!! the matrix coefficients for the tri-diagonal matrix of the implicit time</span></div>
<div class="line"><a id="l04071" name="l04071"></a><span class="lineno"> 4071</span><span class="comment">!! scheme.</span></div>
<div class="foldopen" id="foldopen04072" data-start="" data-end="">
<div class="line"><a id="l04072" name="l04072"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gabb602c2b09396e2f94c9556259f5bae4.html#gabb602c2b09396e2f94c9556259f5bae4"> 4072</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gabb602c2b09396e2f94c9556259f5bae4.html#gabb602c2b09396e2f94c9556259f5bae4">hrt</a>                                                    &amp;</div>
<div class="line"><a id="l04073" name="l04073"></a><span class="lineno"> 4073</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04074" name="l04074"></a><span class="lineno"> 4074</span>     &amp;     ( nsoil, stc, smc, smcmax, zsoil, yy, zz1, tbot,             &amp;</div>
<div class="line"><a id="l04075" name="l04075"></a><span class="lineno"> 4075</span>     &amp;       zbot, psisat, dt, bexp, df1, quartz, csoil, vegtyp,        &amp;</div>
<div class="line"><a id="l04076" name="l04076"></a><span class="lineno"> 4076</span>     &amp;       shdfac, lheatstrg,                                         &amp;</div>
<div class="line"><a id="l04077" name="l04077"></a><span class="lineno"> 4077</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04078" name="l04078"></a><span class="lineno"> 4078</span>     &amp;       sh2o,                                                      &amp;</div>
<div class="line"><a id="l04079" name="l04079"></a><span class="lineno"> 4079</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04080" name="l04080"></a><span class="lineno"> 4080</span>     &amp;       rhsts, ai, bi, ci                                          &amp;</div>
<div class="line"><a id="l04081" name="l04081"></a><span class="lineno"> 4081</span>     &amp;     )</div>
<div class="line"><a id="l04082" name="l04082"></a><span class="lineno"> 4082</span> </div>
<div class="line"><a id="l04083" name="l04083"></a><span class="lineno"> 4083</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l04084" name="l04084"></a><span class="lineno"> 4084</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l04085" name="l04085"></a><span class="lineno"> 4085</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04086" name="l04086"></a><span class="lineno"> 4086</span><span class="comment">!  subroutine hrt calculates the right hand side of the time tendency   !</span></div>
<div class="line"><a id="l04087" name="l04087"></a><span class="lineno"> 4087</span><span class="comment">!  term of the soil thermal diffusion equation.  also to compute        !</span></div>
<div class="line"><a id="l04088" name="l04088"></a><span class="lineno"> 4088</span><span class="comment">!  (prepare) the matrix coefficients for the tri-diagonal matrix of     !</span></div>
<div class="line"><a id="l04089" name="l04089"></a><span class="lineno"> 4089</span><span class="comment">!  the implicit time scheme.                                            !</span></div>
<div class="line"><a id="l04090" name="l04090"></a><span class="lineno"> 4090</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04091" name="l04091"></a><span class="lineno"> 4091</span><span class="comment">!  subprogram called:  tbnd, snksrc, tmpavg                             !</span></div>
<div class="line"><a id="l04092" name="l04092"></a><span class="lineno"> 4092</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04093" name="l04093"></a><span class="lineno"> 4093</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04094" name="l04094"></a><span class="lineno"> 4094</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l04095" name="l04095"></a><span class="lineno"> 4095</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04096" name="l04096"></a><span class="lineno"> 4096</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l04097" name="l04097"></a><span class="lineno"> 4097</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l04098" name="l04098"></a><span class="lineno"> 4098</span><span class="comment">!     stc      - real, soil temperature                          nsoil  !</span></div>
<div class="line"><a id="l04099" name="l04099"></a><span class="lineno"> 4099</span><span class="comment">!     smc      - real, total soil moisture                       nsoil  !</span></div>
<div class="line"><a id="l04100" name="l04100"></a><span class="lineno"> 4100</span><span class="comment">!     smcmax   - real, porosity                                    1    !</span></div>
<div class="line"><a id="l04101" name="l04101"></a><span class="lineno"> 4101</span><span class="comment">!     zsoil    - real, soil layer depth below ground (negative)  nsoil  !</span></div>
<div class="line"><a id="l04102" name="l04102"></a><span class="lineno"> 4102</span><span class="comment">!     yy       - real,                                             1    !</span></div>
<div class="line"><a id="l04103" name="l04103"></a><span class="lineno"> 4103</span><span class="comment">!     zz1      - real, soil temperture at the top soil column      1    !</span></div>
<div class="line"><a id="l04104" name="l04104"></a><span class="lineno"> 4104</span><span class="comment">!     tbot     - real, bottom soil temp                            1    !</span></div>
<div class="line"><a id="l04105" name="l04105"></a><span class="lineno"> 4105</span><span class="comment">!     zbot     - real, specify depth of lower bd soil              1    !</span></div>
<div class="line"><a id="l04106" name="l04106"></a><span class="lineno"> 4106</span><span class="comment">!     psisat   - real, saturated soil potential                    1    !</span></div>
<div class="line"><a id="l04107" name="l04107"></a><span class="lineno"> 4107</span><span class="comment">!     dt       - real, time step                                   1    !</span></div>
<div class="line"><a id="l04108" name="l04108"></a><span class="lineno"> 4108</span><span class="comment">!     bexp     - real, soil type &quot;b&quot; parameter                     1    !</span></div>
<div class="line"><a id="l04109" name="l04109"></a><span class="lineno"> 4109</span><span class="comment">!     df1      - real, thermal diffusivity                         1    !</span></div>
<div class="line"><a id="l04110" name="l04110"></a><span class="lineno"> 4110</span><span class="comment">!     quartz   - real, soil quartz content                         1    !</span></div>
<div class="line"><a id="l04111" name="l04111"></a><span class="lineno"> 4111</span><span class="comment">!     csoil    - real, soil heat capacity                          1    !</span></div>
<div class="line"><a id="l04112" name="l04112"></a><span class="lineno"> 4112</span><span class="comment">!     vegtyp   - integer, vegetation type                          1    !</span></div>
<div class="line"><a id="l04113" name="l04113"></a><span class="lineno"> 4113</span><span class="comment">!     shdfac   - real, aeral coverage of green vegetation          1    !</span></div>
<div class="line"><a id="l04114" name="l04114"></a><span class="lineno"> 4114</span><span class="comment">!     lheatstrg- logical, flag for canopy heat storage             1    !</span></div>
<div class="line"><a id="l04115" name="l04115"></a><span class="lineno"> 4115</span><span class="comment">!                         parameterization                              !</span></div>
<div class="line"><a id="l04116" name="l04116"></a><span class="lineno"> 4116</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04117" name="l04117"></a><span class="lineno"> 4117</span><span class="comment">!  input/outputs:                                                       !</span></div>
<div class="line"><a id="l04118" name="l04118"></a><span class="lineno"> 4118</span><span class="comment">!     sh2o     - real, unfrozen soil moisture                    nsoil  !</span></div>
<div class="line"><a id="l04119" name="l04119"></a><span class="lineno"> 4119</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04120" name="l04120"></a><span class="lineno"> 4120</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l04121" name="l04121"></a><span class="lineno"> 4121</span><span class="comment">!     rhsts    - real, time tendency of soil thermal diffusion   nsoil  !</span></div>
<div class="line"><a id="l04122" name="l04122"></a><span class="lineno"> 4122</span><span class="comment">!     ai       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l04123" name="l04123"></a><span class="lineno"> 4123</span><span class="comment">!     bi       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l04124" name="l04124"></a><span class="lineno"> 4124</span><span class="comment">!     ci       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l04125" name="l04125"></a><span class="lineno"> 4125</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04126" name="l04126"></a><span class="lineno"> 4126</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l04127" name="l04127"></a><span class="lineno"> 4127</span><span class="comment">!</span></div>
<div class="line"><a id="l04128" name="l04128"></a><span class="lineno"> 4128</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04129" name="l04129"></a><span class="lineno"> 4129</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil, vegtyp</div>
<div class="line"><a id="l04130" name="l04130"></a><span class="lineno"> 4130</span> </div>
<div class="line"><a id="l04131" name="l04131"></a><span class="lineno"> 4131</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">intent(in)</span> :: stc(nsoil), smc(nsoil),     &amp;</div>
<div class="line"><a id="l04132" name="l04132"></a><span class="lineno"> 4132</span>     &amp;       smcmax, zsoil(nsoil), yy, zz1, tbot, zbot, psisat, dt,     &amp;</div>
<div class="line"><a id="l04133" name="l04133"></a><span class="lineno"> 4133</span>     &amp;       bexp, df1, quartz, csoil, shdfac</div>
<div class="line"><a id="l04134" name="l04134"></a><span class="lineno"> 4134</span> </div>
<div class="line"><a id="l04135" name="l04135"></a><span class="lineno"> 4135</span>      <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: lheatstrg</div>
<div class="line"><a id="l04136" name="l04136"></a><span class="lineno"> 4136</span> </div>
<div class="line"><a id="l04137" name="l04137"></a><span class="lineno"> 4137</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04138" name="l04138"></a><span class="lineno"> 4138</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">intent(inout)</span> :: sh2o(nsoil)</div>
<div class="line"><a id="l04139" name="l04139"></a><span class="lineno"> 4139</span> </div>
<div class="line"><a id="l04140" name="l04140"></a><span class="lineno"> 4140</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04141" name="l04141"></a><span class="lineno"> 4141</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">intent(out)</span> :: rhsts(nsoil), ai(nsold),   &amp;</div>
<div class="line"><a id="l04142" name="l04142"></a><span class="lineno"> 4142</span>     &amp;       bi(nsold), ci(nsold)</div>
<div class="line"><a id="l04143" name="l04143"></a><span class="lineno"> 4143</span> </div>
<div class="line"><a id="l04144" name="l04144"></a><span class="lineno"> 4144</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l04145" name="l04145"></a><span class="lineno"> 4145</span><span class="keywordtype">      real</span> (kind=kind_phys) :: ddz, ddz2, denom, df1n, df1k, dtsdz,     &amp;</div>
<div class="line"><a id="l04146" name="l04146"></a><span class="lineno"> 4146</span>     &amp;       dtsdz2, hcpct, qtot, ssoil, sice, tavg, tbk, tbk1,         &amp;</div>
<div class="line"><a id="l04147" name="l04147"></a><span class="lineno"> 4147</span>     &amp;       tsnsr, tsurf, csoil_loc</div>
<div class="line"><a id="l04148" name="l04148"></a><span class="lineno"> 4148</span> </div>
<div class="line"><a id="l04149" name="l04149"></a><span class="lineno"> 4149</span>      <span class="keywordtype">integer</span> :: i, k</div>
<div class="line"><a id="l04150" name="l04150"></a><span class="lineno"> 4150</span> </div>
<div class="line"><a id="l04151" name="l04151"></a><span class="lineno"> 4151</span>      <span class="keywordtype">logical</span> :: itavg</div>
<div class="line"><a id="l04152" name="l04152"></a><span class="lineno"> 4152</span> </div>
<div class="line"><a id="l04153" name="l04153"></a><span class="lineno"> 4153</span><span class="comment">!</span></div>
<div class="line"><a id="l04154" name="l04154"></a><span class="lineno"> 4154</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l04155" name="l04155"></a><span class="lineno"> 4155</span><span class="comment">!</span></div>
<div class="line"><a id="l04156" name="l04156"></a><span class="lineno"> 4156</span>        csoil_loc=csoil</div>
<div class="line"><a id="l04157" name="l04157"></a><span class="lineno"> 4157</span> </div>
<div class="line"><a id="l04158" name="l04158"></a><span class="lineno"> 4158</span>       <span class="keywordflow">if</span> (.not.lheatstrg .and. ivegsrc == 1)<span class="keywordflow">then</span></div>
<div class="line"><a id="l04159" name="l04159"></a><span class="lineno"> 4159</span><span class="comment">!urban</span></div>
<div class="line"><a id="l04160" name="l04160"></a><span class="lineno"> 4160</span><span class="comment">!</span></div>
<div class="line"><a id="l04161" name="l04161"></a><span class="lineno"> 4161</span><span class="comment">!jhan urban canopy heat storage effect is included in pbl scheme</span></div>
<div class="line"><a id="l04162" name="l04162"></a><span class="lineno"> 4162</span><span class="comment">!</span></div>
<div class="line"><a id="l04163" name="l04163"></a><span class="lineno"> 4163</span>        <span class="keywordflow">if</span>( vegtyp == 13 ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04164" name="l04164"></a><span class="lineno"> 4164</span><span class="comment">!           csoil_loc=3.0e6</span></div>
<div class="line"><a id="l04165" name="l04165"></a><span class="lineno"> 4165</span>            csoil_loc=3.0e6*(1.-shdfac)+csoil*shdfac  <span class="comment">! gvf</span></div>
<div class="line"><a id="l04166" name="l04166"></a><span class="lineno"> 4166</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l04167" name="l04167"></a><span class="lineno"> 4167</span><span class="keywordflow">       endif</span></div>
<div class="line"><a id="l04168" name="l04168"></a><span class="lineno"> 4168</span> </div>
<div class="line"><a id="l04169" name="l04169"></a><span class="lineno"> 4169</span><span class="comment">!  --- ...  initialize logical for soil layer temperature averaging.</span></div>
<div class="line"><a id="l04170" name="l04170"></a><span class="lineno"> 4170</span> </div>
<div class="line"><a id="l04171" name="l04171"></a><span class="lineno"> 4171</span>      itavg = .true.</div>
<div class="line"><a id="l04172" name="l04172"></a><span class="lineno"> 4172</span><span class="comment">!     itavg = .false.</span></div>
<div class="line"><a id="l04173" name="l04173"></a><span class="lineno"> 4173</span> </div>
<div class="line"><a id="l04174" name="l04174"></a><span class="lineno"> 4174</span><span class="comment">!  ===  begin section for top soil layer</span></div>
<div class="line"><a id="l04175" name="l04175"></a><span class="lineno"> 4175</span> </div>
<div class="line"><a id="l04176" name="l04176"></a><span class="lineno"> 4176</span><span class="comment">!  --- ...  calc the heat capacity of the top soil layer</span></div>
<div class="line"><a id="l04177" name="l04177"></a><span class="lineno"> 4177</span> </div>
<div class="line"><a id="l04178" name="l04178"></a><span class="lineno"> 4178</span>      hcpct = sh2o(1)*cph2o2 + (1.0 - smcmax)*csoil_loc                 &amp;</div>
<div class="line"><a id="l04179" name="l04179"></a><span class="lineno"> 4179</span>     &amp;      + (smcmax - smc(1))*cp2 + (smc(1) - sh2o(1))*cpice1</div>
<div class="line"><a id="l04180" name="l04180"></a><span class="lineno"> 4180</span> </div>
<div class="line"><a id="l04181" name="l04181"></a><span class="lineno"> 4181</span><span class="comment">!  --- ...  calc the matrix coefficients ai, bi, and ci for the top layer</span></div>
<div class="line"><a id="l04182" name="l04182"></a><span class="lineno"> 4182</span> </div>
<div class="line"><a id="l04183" name="l04183"></a><span class="lineno"> 4183</span>      ddz = 1.0 / ( -0.5*zsoil(2) )</div>
<div class="line"><a id="l04184" name="l04184"></a><span class="lineno"> 4184</span>      ai(1) = 0.0</div>
<div class="line"><a id="l04185" name="l04185"></a><span class="lineno"> 4185</span>      ci(1) = (df1*ddz) / ( zsoil(1)*hcpct )</div>
<div class="line"><a id="l04186" name="l04186"></a><span class="lineno"> 4186</span>      bi(1) = -ci(1) + df1 / ( 0.5*zsoil(1)*zsoil(1)*hcpct*zz1 )</div>
<div class="line"><a id="l04187" name="l04187"></a><span class="lineno"> 4187</span> </div>
<div class="line"><a id="l04188" name="l04188"></a><span class="lineno"> 4188</span><span class="comment">!  --- ...  calculate the vertical soil temp gradient btwn the 1st and 2nd soil</span></div>
<div class="line"><a id="l04189" name="l04189"></a><span class="lineno"> 4189</span><span class="comment">!           layers.  then calculate the subsurface heat flux. use the temp</span></div>
<div class="line"><a id="l04190" name="l04190"></a><span class="lineno"> 4190</span><span class="comment">!           gradient and subsfc heat flux to calc &quot;right-hand side tendency</span></div>
<div class="line"><a id="l04191" name="l04191"></a><span class="lineno"> 4191</span><span class="comment">!           terms&quot;, or &quot;rhsts&quot;, for top soil layer.</span></div>
<div class="line"><a id="l04192" name="l04192"></a><span class="lineno"> 4192</span> </div>
<div class="line"><a id="l04193" name="l04193"></a><span class="lineno"> 4193</span>      dtsdz = (stc(1) - stc(2)) / (-0.5*zsoil(2))</div>
<div class="line"><a id="l04194" name="l04194"></a><span class="lineno"> 4194</span>      ssoil = df1 * (stc(1) - yy) / (0.5*zsoil(1)*zz1)</div>
<div class="line"><a id="l04195" name="l04195"></a><span class="lineno"> 4195</span>      rhsts(1) = (df1*dtsdz - ssoil) / (zsoil(1)*hcpct)</div>
<div class="line"><a id="l04196" name="l04196"></a><span class="lineno"> 4196</span> </div>
<div class="line"><a id="l04197" name="l04197"></a><span class="lineno"> 4197</span><span class="comment">!  --- ...  next capture the vertical difference of the heat flux at top and</span></div>
<div class="line"><a id="l04198" name="l04198"></a><span class="lineno"> 4198</span><span class="comment">!           bottom of first soil layer for use in heat flux constraint applied to</span></div>
<div class="line"><a id="l04199" name="l04199"></a><span class="lineno"> 4199</span><span class="comment">!           potential soil freezing/thawing in routine snksrc.</span></div>
<div class="line"><a id="l04200" name="l04200"></a><span class="lineno"> 4200</span> </div>
<div class="line"><a id="l04201" name="l04201"></a><span class="lineno"> 4201</span>      qtot = ssoil - df1*dtsdz</div>
<div class="line"><a id="l04202" name="l04202"></a><span class="lineno"> 4202</span> </div>
<div class="line"><a id="l04203" name="l04203"></a><span class="lineno"> 4203</span><span class="comment">!  --- ...  if temperature averaging invoked (itavg=true; else skip):</span></div>
<div class="line"><a id="l04204" name="l04204"></a><span class="lineno"> 4204</span><span class="comment">!           set temp &quot;tsurf&quot; at top of soil column (for use in freezing soil</span></div>
<div class="line"><a id="l04205" name="l04205"></a><span class="lineno"> 4205</span><span class="comment">!           physics later in subroutine snksrc).  if snowpack content is</span></div>
<div class="line"><a id="l04206" name="l04206"></a><span class="lineno"> 4206</span><span class="comment">!           zero, then tsurf expression below gives tsurf = skin temp.  if</span></div>
<div class="line"><a id="l04207" name="l04207"></a><span class="lineno"> 4207</span><span class="comment">!           snowpack is nonzero (hence argument zz1=1), then tsurf expression</span></div>
<div class="line"><a id="l04208" name="l04208"></a><span class="lineno"> 4208</span><span class="comment">!           below yields soil column top temperature under snowpack.  then</span></div>
<div class="line"><a id="l04209" name="l04209"></a><span class="lineno"> 4209</span><span class="comment">!           calculate temperature at bottom interface of 1st soil layer for use</span></div>
<div class="line"><a id="l04210" name="l04210"></a><span class="lineno"> 4210</span><span class="comment">!           later in subroutine snksrc</span></div>
<div class="line"><a id="l04211" name="l04211"></a><span class="lineno"> 4211</span> </div>
<div class="line"><a id="l04212" name="l04212"></a><span class="lineno"> 4212</span>      <span class="keywordflow">if</span> (itavg) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04213" name="l04213"></a><span class="lineno"> 4213</span> </div>
<div class="line"><a id="l04214" name="l04214"></a><span class="lineno"> 4214</span>        tsurf = (yy + (zz1-1)*stc(1)) / zz1</div>
<div class="line"><a id="l04215" name="l04215"></a><span class="lineno"> 4215</span> </div>
<div class="line"><a id="l04216" name="l04216"></a><span class="lineno"> 4216</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga8e248a6da8d1fd3c2e64b76f3bfbea50.html#ga8e248a6da8d1fd3c2e64b76f3bfbea50">tbnd</a>                                                       &amp;</div>
<div class="line"><a id="l04217" name="l04217"></a><span class="lineno"> 4217</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04218" name="l04218"></a><span class="lineno"> 4218</span>     &amp;     ( stc(1), stc(2), zsoil, zbot, 1, nsoil,                     &amp;</div>
<div class="line"><a id="l04219" name="l04219"></a><span class="lineno"> 4219</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04220" name="l04220"></a><span class="lineno"> 4220</span>     &amp;       tbk                                                        &amp;</div>
<div class="line"><a id="l04221" name="l04221"></a><span class="lineno"> 4221</span>     &amp;     )</div>
<div class="line"><a id="l04222" name="l04222"></a><span class="lineno"> 4222</span> </div>
<div class="line"><a id="l04223" name="l04223"></a><span class="lineno"> 4223</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l04224" name="l04224"></a><span class="lineno"> 4224</span> </div>
<div class="line"><a id="l04225" name="l04225"></a><span class="lineno"> 4225</span><span class="comment">!  --- ...  calculate frozen water content in 1st soil layer.</span></div>
<div class="line"><a id="l04226" name="l04226"></a><span class="lineno"> 4226</span> </div>
<div class="line"><a id="l04227" name="l04227"></a><span class="lineno"> 4227</span>      sice = smc(1) - sh2o(1)</div>
<div class="line"><a id="l04228" name="l04228"></a><span class="lineno"> 4228</span> </div>
<div class="line"><a id="l04229" name="l04229"></a><span class="lineno"> 4229</span><span class="comment">!  --- ...  if frozen water present or any of layer-1 mid-point or bounding</span></div>
<div class="line"><a id="l04230" name="l04230"></a><span class="lineno"> 4230</span><span class="comment">!           interface temperatures below freezing, then call snksrc to</span></div>
<div class="line"><a id="l04231" name="l04231"></a><span class="lineno"> 4231</span><span class="comment">!           compute heat source/sink (and change in frozen water content)</span></div>
<div class="line"><a id="l04232" name="l04232"></a><span class="lineno"> 4232</span><span class="comment">!           due to possible soil water phase change</span></div>
<div class="line"><a id="l04233" name="l04233"></a><span class="lineno"> 4233</span> </div>
<div class="line"><a id="l04234" name="l04234"></a><span class="lineno"> 4234</span>      <span class="keywordflow">if</span> ( (sice &gt; 0.0) .or. (tsurf &lt; tfreez) .or.                      &amp;</div>
<div class="line"><a id="l04235" name="l04235"></a><span class="lineno"> 4235</span>     &amp;     (stc(1) &lt; tfreez) .or. (tbk &lt; tfreez) ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04236" name="l04236"></a><span class="lineno"> 4236</span> </div>
<div class="line"><a id="l04237" name="l04237"></a><span class="lineno"> 4237</span>        <span class="keywordflow">if</span> (itavg) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04238" name="l04238"></a><span class="lineno"> 4238</span> </div>
<div class="line"><a id="l04239" name="l04239"></a><span class="lineno"> 4239</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gae50411efeb11ddeb8a0c53010745a95c.html#gae50411efeb11ddeb8a0c53010745a95c">tmpavg</a>                                                   &amp;</div>
<div class="line"><a id="l04240" name="l04240"></a><span class="lineno"> 4240</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04241" name="l04241"></a><span class="lineno"> 4241</span>     &amp;     ( tsurf, stc(1), tbk, zsoil, nsoil, 1,                       &amp;</div>
<div class="line"><a id="l04242" name="l04242"></a><span class="lineno"> 4242</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04243" name="l04243"></a><span class="lineno"> 4243</span>     &amp;       tavg                                                       &amp;</div>
<div class="line"><a id="l04244" name="l04244"></a><span class="lineno"> 4244</span>     &amp;     )</div>
<div class="line"><a id="l04245" name="l04245"></a><span class="lineno"> 4245</span> </div>
<div class="line"><a id="l04246" name="l04246"></a><span class="lineno"> 4246</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l04247" name="l04247"></a><span class="lineno"> 4247</span> </div>
<div class="line"><a id="l04248" name="l04248"></a><span class="lineno"> 4248</span>          tavg = stc(1)</div>
<div class="line"><a id="l04249" name="l04249"></a><span class="lineno"> 4249</span> </div>
<div class="line"><a id="l04250" name="l04250"></a><span class="lineno"> 4250</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_itavg_block</span></div>
<div class="line"><a id="l04251" name="l04251"></a><span class="lineno"> 4251</span> </div>
<div class="line"><a id="l04252" name="l04252"></a><span class="lineno"> 4252</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga1b241897d00ec3d66eabe9e959d0ce04.html#ga1b241897d00ec3d66eabe9e959d0ce04">snksrc</a>                                                     &amp;</div>
<div class="line"><a id="l04253" name="l04253"></a><span class="lineno"> 4253</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04254" name="l04254"></a><span class="lineno"> 4254</span>     &amp;     ( nsoil, 1, tavg, smc(1), smcmax, psisat, bexp, dt,          &amp;</div>
<div class="line"><a id="l04255" name="l04255"></a><span class="lineno"> 4255</span>     &amp;       qtot, zsoil,                                               &amp;</div>
<div class="line"><a id="l04256" name="l04256"></a><span class="lineno"> 4256</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04257" name="l04257"></a><span class="lineno"> 4257</span>     &amp;       sh2o(1),                                                   &amp;</div>
<div class="line"><a id="l04258" name="l04258"></a><span class="lineno"> 4258</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04259" name="l04259"></a><span class="lineno"> 4259</span>     &amp;       tsnsr                                                      &amp;</div>
<div class="line"><a id="l04260" name="l04260"></a><span class="lineno"> 4260</span>     &amp;     )</div>
<div class="line"><a id="l04261" name="l04261"></a><span class="lineno"> 4261</span> </div>
<div class="line"><a id="l04262" name="l04262"></a><span class="lineno"> 4262</span> </div>
<div class="line"><a id="l04263" name="l04263"></a><span class="lineno"> 4263</span>        rhsts(1) = rhsts(1) - tsnsr / ( zsoil(1)*hcpct )</div>
<div class="line"><a id="l04264" name="l04264"></a><span class="lineno"> 4264</span> </div>
<div class="line"><a id="l04265" name="l04265"></a><span class="lineno"> 4265</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_sice_block</span></div>
<div class="line"><a id="l04266" name="l04266"></a><span class="lineno"> 4266</span> </div>
<div class="line"><a id="l04267" name="l04267"></a><span class="lineno"> 4267</span><span class="comment">!  ===  this ends section for top soil layer.</span></div>
<div class="line"><a id="l04268" name="l04268"></a><span class="lineno"> 4268</span> </div>
<div class="line"><a id="l04269" name="l04269"></a><span class="lineno"> 4269</span><span class="comment">!  --- ...  initialize ddz2</span></div>
<div class="line"><a id="l04270" name="l04270"></a><span class="lineno"> 4270</span> </div>
<div class="line"><a id="l04271" name="l04271"></a><span class="lineno"> 4271</span>      ddz2 = 0.0</div>
<div class="line"><a id="l04272" name="l04272"></a><span class="lineno"> 4272</span> </div>
<div class="line"><a id="l04273" name="l04273"></a><span class="lineno"> 4273</span><span class="comment">!  --- ...  loop thru the remaining soil layers, repeating the above process</span></div>
<div class="line"><a id="l04274" name="l04274"></a><span class="lineno"> 4274</span><span class="comment">!           (except subsfc or &quot;ground&quot; heat flux not repeated in lower layers)</span></div>
<div class="line"><a id="l04275" name="l04275"></a><span class="lineno"> 4275</span> </div>
<div class="line"><a id="l04276" name="l04276"></a><span class="lineno"> 4276</span>      df1k = df1</div>
<div class="line"><a id="l04277" name="l04277"></a><span class="lineno"> 4277</span> </div>
<div class="line"><a id="l04278" name="l04278"></a><span class="lineno"> 4278</span>      <span class="keywordflow">do</span> k = 2, nsoil</div>
<div class="line"><a id="l04279" name="l04279"></a><span class="lineno"> 4279</span> </div>
<div class="line"><a id="l04280" name="l04280"></a><span class="lineno"> 4280</span><span class="comment">!  --- ...  calculate heat capacity for this soil layer.</span></div>
<div class="line"><a id="l04281" name="l04281"></a><span class="lineno"> 4281</span> </div>
<div class="line"><a id="l04282" name="l04282"></a><span class="lineno"> 4282</span>        hcpct = sh2o(k)*cph2o2 + (1.0 - smcmax)*csoil_loc               &amp;</div>
<div class="line"><a id="l04283" name="l04283"></a><span class="lineno"> 4283</span>     &amp;        + (smcmax - smc(k))*cp2 + (smc(k) - sh2o(k))*cpice1</div>
<div class="line"><a id="l04284" name="l04284"></a><span class="lineno"> 4284</span> </div>
<div class="line"><a id="l04285" name="l04285"></a><span class="lineno"> 4285</span>        <span class="keywordflow">if</span> (k /= nsoil) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04286" name="l04286"></a><span class="lineno"> 4286</span> </div>
<div class="line"><a id="l04287" name="l04287"></a><span class="lineno"> 4287</span><span class="comment">!  --- ...  this section for layer 2 or greater, but not last layer.</span></div>
<div class="line"><a id="l04288" name="l04288"></a><span class="lineno"> 4288</span><span class="comment">!           calculate thermal diffusivity for this layer.</span></div>
<div class="line"><a id="l04289" name="l04289"></a><span class="lineno"> 4289</span> </div>
<div class="line"><a id="l04290" name="l04290"></a><span class="lineno"> 4290</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga8bc3154096e6364c5fcddf884c003bef.html#ga8bc3154096e6364c5fcddf884c003bef">tdfcnd</a>                                                   &amp;</div>
<div class="line"><a id="l04291" name="l04291"></a><span class="lineno"> 4291</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04292" name="l04292"></a><span class="lineno"> 4292</span>     &amp;     ( smc(k), quartz, smcmax, sh2o(k),                           &amp;</div>
<div class="line"><a id="l04293" name="l04293"></a><span class="lineno"> 4293</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04294" name="l04294"></a><span class="lineno"> 4294</span>     &amp;       df1n                                                       &amp;</div>
<div class="line"><a id="l04295" name="l04295"></a><span class="lineno"> 4295</span>     &amp;     )</div>
<div class="line"><a id="l04296" name="l04296"></a><span class="lineno"> 4296</span><span class="comment">!urban</span></div>
<div class="line"><a id="l04297" name="l04297"></a><span class="lineno"> 4297</span><span class="comment">!     if (ivegsrc == 1)then</span></div>
<div class="line"><a id="l04298" name="l04298"></a><span class="lineno"> 4298</span><span class="comment">!      if ( vegtyp == 13 ) df1n = 3.24</span></div>
<div class="line"><a id="l04299" name="l04299"></a><span class="lineno"> 4299</span><span class="comment">!     endif</span></div>
<div class="line"><a id="l04300" name="l04300"></a><span class="lineno"> 4300</span><span class="comment">!wz only urban for igbp type</span></div>
<div class="line"><a id="l04301" name="l04301"></a><span class="lineno"> 4301</span><span class="comment">!</span></div>
<div class="line"><a id="l04302" name="l04302"></a><span class="lineno"> 4302</span><span class="comment">!jhan urban canopy heat storage effect is included in pbl scheme</span></div>
<div class="line"><a id="l04303" name="l04303"></a><span class="lineno"> 4303</span><span class="comment">!</span></div>
<div class="line"><a id="l04304" name="l04304"></a><span class="lineno"> 4304</span>        <span class="keywordflow">if</span>((.not.lheatstrg) .and.</div>
<div class="line"><a id="l04305" name="l04305"></a><span class="lineno"> 4305</span>     &amp;      (ivegsrc == 1 .and. vegtyp == 13)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04306" name="l04306"></a><span class="lineno"> 4306</span>          df1n = 3.24*(1.-shdfac) + shdfac*df1n</div>
<div class="line"><a id="l04307" name="l04307"></a><span class="lineno"> 4307</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l04308" name="l04308"></a><span class="lineno"> 4308</span> </div>
<div class="line"><a id="l04309" name="l04309"></a><span class="lineno"> 4309</span><span class="comment">!  --- ...  calc the vertical soil temp gradient thru this layer</span></div>
<div class="line"><a id="l04310" name="l04310"></a><span class="lineno"> 4310</span> </div>
<div class="line"><a id="l04311" name="l04311"></a><span class="lineno"> 4311</span>          denom = 0.5 * (zsoil(k-1) - zsoil(k+1))</div>
<div class="line"><a id="l04312" name="l04312"></a><span class="lineno"> 4312</span>          dtsdz2 = (stc(k) - stc(k+1)) / denom</div>
<div class="line"><a id="l04313" name="l04313"></a><span class="lineno"> 4313</span> </div>
<div class="line"><a id="l04314" name="l04314"></a><span class="lineno"> 4314</span><span class="comment">!  --- ...  calc the matrix coef, ci, after calc&#39;ng its partial product</span></div>
<div class="line"><a id="l04315" name="l04315"></a><span class="lineno"> 4315</span> </div>
<div class="line"><a id="l04316" name="l04316"></a><span class="lineno"> 4316</span>          ddz2 = 2.0 / (zsoil(k-1) - zsoil(k+1))</div>
<div class="line"><a id="l04317" name="l04317"></a><span class="lineno"> 4317</span>          ci(k) = -df1n*ddz2 / ((zsoil(k-1) - zsoil(k)) * hcpct)</div>
<div class="line"><a id="l04318" name="l04318"></a><span class="lineno"> 4318</span> </div>
<div class="line"><a id="l04319" name="l04319"></a><span class="lineno"> 4319</span><span class="comment">!  --- ...  if temperature averaging invoked (itavg=true; else skip):</span></div>
<div class="line"><a id="l04320" name="l04320"></a><span class="lineno"> 4320</span><span class="comment">!           calculate temp at bottom of layer.</span></div>
<div class="line"><a id="l04321" name="l04321"></a><span class="lineno"> 4321</span> </div>
<div class="line"><a id="l04322" name="l04322"></a><span class="lineno"> 4322</span>          <span class="keywordflow">if</span> (itavg) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04323" name="l04323"></a><span class="lineno"> 4323</span> </div>
<div class="line"><a id="l04324" name="l04324"></a><span class="lineno"> 4324</span>            <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga8e248a6da8d1fd3c2e64b76f3bfbea50.html#ga8e248a6da8d1fd3c2e64b76f3bfbea50">tbnd</a>                                                   &amp;</div>
<div class="line"><a id="l04325" name="l04325"></a><span class="lineno"> 4325</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04326" name="l04326"></a><span class="lineno"> 4326</span>     &amp;     ( stc(k), stc(k+1), zsoil, zbot, k, nsoil,                   &amp;</div>
<div class="line"><a id="l04327" name="l04327"></a><span class="lineno"> 4327</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04328" name="l04328"></a><span class="lineno"> 4328</span>     &amp;       tbk1                                                       &amp;</div>
<div class="line"><a id="l04329" name="l04329"></a><span class="lineno"> 4329</span>     &amp;     )</div>
<div class="line"><a id="l04330" name="l04330"></a><span class="lineno"> 4330</span> </div>
<div class="line"><a id="l04331" name="l04331"></a><span class="lineno"> 4331</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l04332" name="l04332"></a><span class="lineno"> 4332</span> </div>
<div class="line"><a id="l04333" name="l04333"></a><span class="lineno"> 4333</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l04334" name="l04334"></a><span class="lineno"> 4334</span> </div>
<div class="line"><a id="l04335" name="l04335"></a><span class="lineno"> 4335</span><span class="comment">!  --- ...  special case of bottom soil layer:  calculate thermal diffusivity</span></div>
<div class="line"><a id="l04336" name="l04336"></a><span class="lineno"> 4336</span><span class="comment">!           for bottom layer.</span></div>
<div class="line"><a id="l04337" name="l04337"></a><span class="lineno"> 4337</span> </div>
<div class="line"><a id="l04338" name="l04338"></a><span class="lineno"> 4338</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga8bc3154096e6364c5fcddf884c003bef.html#ga8bc3154096e6364c5fcddf884c003bef">tdfcnd</a>                                                   &amp;</div>
<div class="line"><a id="l04339" name="l04339"></a><span class="lineno"> 4339</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04340" name="l04340"></a><span class="lineno"> 4340</span>     &amp;     ( smc(k), quartz, smcmax, sh2o(k),                           &amp;</div>
<div class="line"><a id="l04341" name="l04341"></a><span class="lineno"> 4341</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04342" name="l04342"></a><span class="lineno"> 4342</span>     &amp;       df1n                                                       &amp;</div>
<div class="line"><a id="l04343" name="l04343"></a><span class="lineno"> 4343</span>     &amp;     )</div>
<div class="line"><a id="l04344" name="l04344"></a><span class="lineno"> 4344</span><span class="comment">!urban</span></div>
<div class="line"><a id="l04345" name="l04345"></a><span class="lineno"> 4345</span><span class="comment">!     if (ivegsrc == 1)then</span></div>
<div class="line"><a id="l04346" name="l04346"></a><span class="lineno"> 4346</span><span class="comment">!      if ( vegtyp == 13 ) df1n = 3.24</span></div>
<div class="line"><a id="l04347" name="l04347"></a><span class="lineno"> 4347</span><span class="comment">!     endif</span></div>
<div class="line"><a id="l04348" name="l04348"></a><span class="lineno"> 4348</span><span class="comment">!wz only urban for igbp type</span></div>
<div class="line"><a id="l04349" name="l04349"></a><span class="lineno"> 4349</span><span class="comment">!</span></div>
<div class="line"><a id="l04350" name="l04350"></a><span class="lineno"> 4350</span><span class="comment">!jhan urban canopy heat storage effect is included in pbl scheme</span></div>
<div class="line"><a id="l04351" name="l04351"></a><span class="lineno"> 4351</span><span class="comment">!</span></div>
<div class="line"><a id="l04352" name="l04352"></a><span class="lineno"> 4352</span>        <span class="keywordflow">if</span>((.not.lheatstrg) .and.</div>
<div class="line"><a id="l04353" name="l04353"></a><span class="lineno"> 4353</span>     &amp;      (ivegsrc == 1 .and. vegtyp == 13)) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04354" name="l04354"></a><span class="lineno"> 4354</span>          df1n = 3.24*(1.-shdfac) + shdfac*df1n</div>
<div class="line"><a id="l04355" name="l04355"></a><span class="lineno"> 4355</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l04356" name="l04356"></a><span class="lineno"> 4356</span> </div>
<div class="line"><a id="l04357" name="l04357"></a><span class="lineno"> 4357</span><span class="comment">!  --- ...  calc the vertical soil temp gradient thru bottom layer.</span></div>
<div class="line"><a id="l04358" name="l04358"></a><span class="lineno"> 4358</span> </div>
<div class="line"><a id="l04359" name="l04359"></a><span class="lineno"> 4359</span>          denom = 0.5 * (zsoil(k-1) + zsoil(k)) - zbot</div>
<div class="line"><a id="l04360" name="l04360"></a><span class="lineno"> 4360</span>          dtsdz2 = (stc(k) - tbot) / denom</div>
<div class="line"><a id="l04361" name="l04361"></a><span class="lineno"> 4361</span> </div>
<div class="line"><a id="l04362" name="l04362"></a><span class="lineno"> 4362</span><span class="comment">!  --- ...  set matrix coef, ci to zero if bottom layer.</span></div>
<div class="line"><a id="l04363" name="l04363"></a><span class="lineno"> 4363</span> </div>
<div class="line"><a id="l04364" name="l04364"></a><span class="lineno"> 4364</span>          ci(k) = 0.0</div>
<div class="line"><a id="l04365" name="l04365"></a><span class="lineno"> 4365</span> </div>
<div class="line"><a id="l04366" name="l04366"></a><span class="lineno"> 4366</span><span class="comment">!  --- ...  if temperature averaging invoked (itavg=true; else skip):</span></div>
<div class="line"><a id="l04367" name="l04367"></a><span class="lineno"> 4367</span><span class="comment">!           calculate temp at bottom of last layer.</span></div>
<div class="line"><a id="l04368" name="l04368"></a><span class="lineno"> 4368</span> </div>
<div class="line"><a id="l04369" name="l04369"></a><span class="lineno"> 4369</span>          <span class="keywordflow">if</span> (itavg) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04370" name="l04370"></a><span class="lineno"> 4370</span> </div>
<div class="line"><a id="l04371" name="l04371"></a><span class="lineno"> 4371</span>            <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga8e248a6da8d1fd3c2e64b76f3bfbea50.html#ga8e248a6da8d1fd3c2e64b76f3bfbea50">tbnd</a>                                                   &amp;</div>
<div class="line"><a id="l04372" name="l04372"></a><span class="lineno"> 4372</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04373" name="l04373"></a><span class="lineno"> 4373</span>     &amp;     ( stc(k), tbot, zsoil, zbot, k, nsoil,                       &amp;</div>
<div class="line"><a id="l04374" name="l04374"></a><span class="lineno"> 4374</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04375" name="l04375"></a><span class="lineno"> 4375</span>     &amp;       tbk1                                                       &amp;</div>
<div class="line"><a id="l04376" name="l04376"></a><span class="lineno"> 4376</span>     &amp;     )</div>
<div class="line"><a id="l04377" name="l04377"></a><span class="lineno"> 4377</span> </div>
<div class="line"><a id="l04378" name="l04378"></a><span class="lineno"> 4378</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l04379" name="l04379"></a><span class="lineno"> 4379</span> </div>
<div class="line"><a id="l04380" name="l04380"></a><span class="lineno"> 4380</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_k_block</span></div>
<div class="line"><a id="l04381" name="l04381"></a><span class="lineno"> 4381</span> </div>
<div class="line"><a id="l04382" name="l04382"></a><span class="lineno"> 4382</span><span class="comment">!  --- ...  calculate rhsts for this layer after calc&#39;ng a partial product.</span></div>
<div class="line"><a id="l04383" name="l04383"></a><span class="lineno"> 4383</span> </div>
<div class="line"><a id="l04384" name="l04384"></a><span class="lineno"> 4384</span>        denom = (zsoil(k) - zsoil(k-1)) * hcpct</div>
<div class="line"><a id="l04385" name="l04385"></a><span class="lineno"> 4385</span>        rhsts(k) = ( df1n*dtsdz2 - df1k*dtsdz ) / denom</div>
<div class="line"><a id="l04386" name="l04386"></a><span class="lineno"> 4386</span> </div>
<div class="line"><a id="l04387" name="l04387"></a><span class="lineno"> 4387</span>        qtot = -1.0 * denom * rhsts(k)</div>
<div class="line"><a id="l04388" name="l04388"></a><span class="lineno"> 4388</span>        sice = smc(k) - sh2o(k)</div>
<div class="line"><a id="l04389" name="l04389"></a><span class="lineno"> 4389</span> </div>
<div class="line"><a id="l04390" name="l04390"></a><span class="lineno"> 4390</span>        <span class="keywordflow">if</span> ( (sice &gt; 0.0) .or. (tbk &lt; tfreez) .or.                      &amp;</div>
<div class="line"><a id="l04391" name="l04391"></a><span class="lineno"> 4391</span>     &amp;       (stc(k) &lt; tfreez) .or. (tbk1 &lt; tfreez) ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04392" name="l04392"></a><span class="lineno"> 4392</span> </div>
<div class="line"><a id="l04393" name="l04393"></a><span class="lineno"> 4393</span>          <span class="keywordflow">if</span> (itavg) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04394" name="l04394"></a><span class="lineno"> 4394</span> </div>
<div class="line"><a id="l04395" name="l04395"></a><span class="lineno"> 4395</span>            <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gae50411efeb11ddeb8a0c53010745a95c.html#gae50411efeb11ddeb8a0c53010745a95c">tmpavg</a>                                                 &amp;</div>
<div class="line"><a id="l04396" name="l04396"></a><span class="lineno"> 4396</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04397" name="l04397"></a><span class="lineno"> 4397</span>     &amp;     ( tbk, stc(k), tbk1, zsoil, nsoil, k,                        &amp;</div>
<div class="line"><a id="l04398" name="l04398"></a><span class="lineno"> 4398</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04399" name="l04399"></a><span class="lineno"> 4399</span>     &amp;       tavg                                                       &amp;</div>
<div class="line"><a id="l04400" name="l04400"></a><span class="lineno"> 4400</span>     &amp;     )</div>
<div class="line"><a id="l04401" name="l04401"></a><span class="lineno"> 4401</span> </div>
<div class="line"><a id="l04402" name="l04402"></a><span class="lineno"> 4402</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l04403" name="l04403"></a><span class="lineno"> 4403</span>            tavg = stc(k)</div>
<div class="line"><a id="l04404" name="l04404"></a><span class="lineno"> 4404</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l04405" name="l04405"></a><span class="lineno"> 4405</span> </div>
<div class="line"><a id="l04406" name="l04406"></a><span class="lineno"> 4406</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga1b241897d00ec3d66eabe9e959d0ce04.html#ga1b241897d00ec3d66eabe9e959d0ce04">snksrc</a>                                                   &amp;</div>
<div class="line"><a id="l04407" name="l04407"></a><span class="lineno"> 4407</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04408" name="l04408"></a><span class="lineno"> 4408</span>     &amp;     ( nsoil, k, tavg, smc(k), smcmax, psisat, bexp, dt,          &amp;</div>
<div class="line"><a id="l04409" name="l04409"></a><span class="lineno"> 4409</span>     &amp;       qtot, zsoil,                                               &amp;</div>
<div class="line"><a id="l04410" name="l04410"></a><span class="lineno"> 4410</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04411" name="l04411"></a><span class="lineno"> 4411</span>     &amp;       sh2o(k),                                                   &amp;</div>
<div class="line"><a id="l04412" name="l04412"></a><span class="lineno"> 4412</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04413" name="l04413"></a><span class="lineno"> 4413</span>     &amp;       tsnsr                                                      &amp;</div>
<div class="line"><a id="l04414" name="l04414"></a><span class="lineno"> 4414</span>     &amp;     )</div>
<div class="line"><a id="l04415" name="l04415"></a><span class="lineno"> 4415</span> </div>
<div class="line"><a id="l04416" name="l04416"></a><span class="lineno"> 4416</span>          rhsts(k) = rhsts(k) - tsnsr/denom</div>
<div class="line"><a id="l04417" name="l04417"></a><span class="lineno"> 4417</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l04418" name="l04418"></a><span class="lineno"> 4418</span> </div>
<div class="line"><a id="l04419" name="l04419"></a><span class="lineno"> 4419</span><span class="comment">!  --- ...  calc matrix coefs, ai, and bi for this layer.</span></div>
<div class="line"><a id="l04420" name="l04420"></a><span class="lineno"> 4420</span> </div>
<div class="line"><a id="l04421" name="l04421"></a><span class="lineno"> 4421</span>        ai(k) = - df1 * ddz / ((zsoil(k-1) - zsoil(k)) * hcpct)</div>
<div class="line"><a id="l04422" name="l04422"></a><span class="lineno"> 4422</span>        bi(k) = -(ai(k) + ci(k))</div>
<div class="line"><a id="l04423" name="l04423"></a><span class="lineno"> 4423</span> </div>
<div class="line"><a id="l04424" name="l04424"></a><span class="lineno"> 4424</span><span class="comment">!  --- ...  reset values of df1, dtsdz, ddz, and tbk for loop to next soil layer.</span></div>
<div class="line"><a id="l04425" name="l04425"></a><span class="lineno"> 4425</span> </div>
<div class="line"><a id="l04426" name="l04426"></a><span class="lineno"> 4426</span>        tbk   = tbk1</div>
<div class="line"><a id="l04427" name="l04427"></a><span class="lineno"> 4427</span>        df1k  = df1n</div>
<div class="line"><a id="l04428" name="l04428"></a><span class="lineno"> 4428</span>        dtsdz = dtsdz2</div>
<div class="line"><a id="l04429" name="l04429"></a><span class="lineno"> 4429</span>        ddz   = ddz2</div>
<div class="line"><a id="l04430" name="l04430"></a><span class="lineno"> 4430</span> </div>
<div class="line"><a id="l04431" name="l04431"></a><span class="lineno"> 4431</span><span class="keywordflow">      enddo</span>   <span class="comment">! end do_k_loop</span></div>
<div class="line"><a id="l04432" name="l04432"></a><span class="lineno"> 4432</span> </div>
<div class="line"><a id="l04433" name="l04433"></a><span class="lineno"> 4433</span><span class="comment">!</span></div>
<div class="line"><a id="l04434" name="l04434"></a><span class="lineno"> 4434</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l04435" name="l04435"></a><span class="lineno"> 4435</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gabb602c2b09396e2f94c9556259f5bae4.html#gabb602c2b09396e2f94c9556259f5bae4">hrt</a></div>
<div class="line"><a id="l04436" name="l04436"></a><span class="lineno"> 4436</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l04437" name="l04437"></a><span class="lineno"> 4437</span> </div>
<div class="line"><a id="l04438" name="l04438"></a><span class="lineno"> 4438</span> </div>
<div class="line"><a id="l04439" name="l04439"></a><span class="lineno"> 4439</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l04440" name="l04440"></a><span class="lineno"> 4440</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l04441" name="l04441"></a><span class="lineno"> 4441</span><span class="comment">!&gt; This subroutine calculates the right hand side of the time tendency</span></div>
<div class="line"><a id="l04442" name="l04442"></a><span class="lineno"> 4442</span><span class="comment">!! term of the soil thermal diffusion equation for sea-ice (ice = 1) or</span></div>
<div class="line"><a id="l04443" name="l04443"></a><span class="lineno"> 4443</span><span class="comment">!! glacial-ice (ice).</span></div>
<div class="foldopen" id="foldopen04444" data-start="" data-end="">
<div class="line"><a id="l04444" name="l04444"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga32e89df3740f968f500900125ae9633d.html#ga32e89df3740f968f500900125ae9633d"> 4444</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga32e89df3740f968f500900125ae9633d.html#ga32e89df3740f968f500900125ae9633d">hrtice</a>                                                 &amp;</div>
<div class="line"><a id="l04445" name="l04445"></a><span class="lineno"> 4445</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04446" name="l04446"></a><span class="lineno"> 4446</span>     &amp;     ( nsoil, stc, zsoil, yy, zz1, df1, ice,                      &amp;</div>
<div class="line"><a id="l04447" name="l04447"></a><span class="lineno"> 4447</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04448" name="l04448"></a><span class="lineno"> 4448</span>     &amp;       tbot,                                                      &amp;</div>
<div class="line"><a id="l04449" name="l04449"></a><span class="lineno"> 4449</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04450" name="l04450"></a><span class="lineno"> 4450</span>     &amp;       rhsts, ai, bi, ci                                          &amp;</div>
<div class="line"><a id="l04451" name="l04451"></a><span class="lineno"> 4451</span>     &amp;     )</div>
<div class="line"><a id="l04452" name="l04452"></a><span class="lineno"> 4452</span> </div>
<div class="line"><a id="l04453" name="l04453"></a><span class="lineno"> 4453</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l04454" name="l04454"></a><span class="lineno"> 4454</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l04455" name="l04455"></a><span class="lineno"> 4455</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04456" name="l04456"></a><span class="lineno"> 4456</span><span class="comment">!  subroutine hrtice calculates the right hand side of the time tendency!</span></div>
<div class="line"><a id="l04457" name="l04457"></a><span class="lineno"> 4457</span><span class="comment">!  term of the soil thermal diffusion equation for sea-ice (ice = 1) or !</span></div>
<div class="line"><a id="l04458" name="l04458"></a><span class="lineno"> 4458</span><span class="comment">!  glacial-ice (ice). compute (prepare) the matrix coefficients for the !</span></div>
<div class="line"><a id="l04459" name="l04459"></a><span class="lineno"> 4459</span><span class="comment">!  tri-diagonal matrix of the implicit time scheme.                     !</span></div>
<div class="line"><a id="l04460" name="l04460"></a><span class="lineno"> 4460</span><span class="comment">!  (note:  this subroutine only called for sea-ice or glacial ice, but  !</span></div>
<div class="line"><a id="l04461" name="l04461"></a><span class="lineno"> 4461</span><span class="comment">!  not for non-glacial land (ice = 0).                                  !</span></div>
<div class="line"><a id="l04462" name="l04462"></a><span class="lineno"> 4462</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04463" name="l04463"></a><span class="lineno"> 4463</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l04464" name="l04464"></a><span class="lineno"> 4464</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04465" name="l04465"></a><span class="lineno"> 4465</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04466" name="l04466"></a><span class="lineno"> 4466</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l04467" name="l04467"></a><span class="lineno"> 4467</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04468" name="l04468"></a><span class="lineno"> 4468</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l04469" name="l04469"></a><span class="lineno"> 4469</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l04470" name="l04470"></a><span class="lineno"> 4470</span><span class="comment">!     stc      - real, soil temperature                          nsoil  !</span></div>
<div class="line"><a id="l04471" name="l04471"></a><span class="lineno"> 4471</span><span class="comment">!     zsoil    - real, soil depth (negative sign, as below grd)  nsoil  !</span></div>
<div class="line"><a id="l04472" name="l04472"></a><span class="lineno"> 4472</span><span class="comment">!     yy       - real, soil temperature at the top of column       1    !</span></div>
<div class="line"><a id="l04473" name="l04473"></a><span class="lineno"> 4473</span><span class="comment">!     zz1      - real,                                             1    !</span></div>
<div class="line"><a id="l04474" name="l04474"></a><span class="lineno"> 4474</span><span class="comment">!     df1      - real, thermal diffusivity and conductivity        1    !</span></div>
<div class="line"><a id="l04475" name="l04475"></a><span class="lineno"> 4475</span><span class="comment">!     ice      - integer, sea-ice flag (=1: sea-ice, =0: land)     1    !</span></div>
<div class="line"><a id="l04476" name="l04476"></a><span class="lineno"> 4476</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04477" name="l04477"></a><span class="lineno"> 4477</span><span class="comment">!  input/outputs:                                                       !</span></div>
<div class="line"><a id="l04478" name="l04478"></a><span class="lineno"> 4478</span><span class="comment">!     tbot     - real, bottom soil temperature                     1    !</span></div>
<div class="line"><a id="l04479" name="l04479"></a><span class="lineno"> 4479</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04480" name="l04480"></a><span class="lineno"> 4480</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l04481" name="l04481"></a><span class="lineno"> 4481</span><span class="comment">!     rhsts    - real, time tendency of soil thermal diffusion   nsoil  !</span></div>
<div class="line"><a id="l04482" name="l04482"></a><span class="lineno"> 4482</span><span class="comment">!     ai       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l04483" name="l04483"></a><span class="lineno"> 4483</span><span class="comment">!     bi       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l04484" name="l04484"></a><span class="lineno"> 4484</span><span class="comment">!     ci       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l04485" name="l04485"></a><span class="lineno"> 4485</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04486" name="l04486"></a><span class="lineno"> 4486</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l04487" name="l04487"></a><span class="lineno"> 4487</span><span class="comment">!</span></div>
<div class="line"><a id="l04488" name="l04488"></a><span class="lineno"> 4488</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04489" name="l04489"></a><span class="lineno"> 4489</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil, ice</div>
<div class="line"><a id="l04490" name="l04490"></a><span class="lineno"> 4490</span> </div>
<div class="line"><a id="l04491" name="l04491"></a><span class="lineno"> 4491</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: stc(nsoil), zsoil(nsoil),    &amp;</div>
<div class="line"><a id="l04492" name="l04492"></a><span class="lineno"> 4492</span>     &amp;       yy, zz1, df1</div>
<div class="line"><a id="l04493" name="l04493"></a><span class="lineno"> 4493</span> </div>
<div class="line"><a id="l04494" name="l04494"></a><span class="lineno"> 4494</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04495" name="l04495"></a><span class="lineno"> 4495</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(inout)</span> :: tbot</div>
<div class="line"><a id="l04496" name="l04496"></a><span class="lineno"> 4496</span> </div>
<div class="line"><a id="l04497" name="l04497"></a><span class="lineno"> 4497</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04498" name="l04498"></a><span class="lineno"> 4498</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: rhsts(nsoil), ai(nsold),    &amp;</div>
<div class="line"><a id="l04499" name="l04499"></a><span class="lineno"> 4499</span>     &amp;       bi(nsold), ci(nsold)</div>
<div class="line"><a id="l04500" name="l04500"></a><span class="lineno"> 4500</span> </div>
<div class="line"><a id="l04501" name="l04501"></a><span class="lineno"> 4501</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l04502" name="l04502"></a><span class="lineno"> 4502</span><span class="keywordtype">      real</span> (kind=kind_phys) :: ddz, ddz2, denom, dtsdz, dtsdz2,         &amp;</div>
<div class="line"><a id="l04503" name="l04503"></a><span class="lineno"> 4503</span>     &amp;       hcpct, ssoil, zbot</div>
<div class="line"><a id="l04504" name="l04504"></a><span class="lineno"> 4504</span> </div>
<div class="line"><a id="l04505" name="l04505"></a><span class="lineno"> 4505</span>      <span class="keywordtype">integer</span> :: k</div>
<div class="line"><a id="l04506" name="l04506"></a><span class="lineno"> 4506</span> </div>
<div class="line"><a id="l04507" name="l04507"></a><span class="lineno"> 4507</span><span class="comment">!</span></div>
<div class="line"><a id="l04508" name="l04508"></a><span class="lineno"> 4508</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l04509" name="l04509"></a><span class="lineno"> 4509</span><span class="comment">!</span></div>
<div class="line"><a id="l04510" name="l04510"></a><span class="lineno"> 4510</span><span class="comment">!  --- ...  set a nominal universal value of the sea-ice specific heat capacity,</span></div>
<div class="line"><a id="l04511" name="l04511"></a><span class="lineno"> 4511</span><span class="comment">!           hcpct = 1880.0*917.0 = 1.72396e+6 (source:  fei chen, 1995)</span></div>
<div class="line"><a id="l04512" name="l04512"></a><span class="lineno"> 4512</span><span class="comment">!           set bottom of sea-ice pack temperature: tbot = 271.16</span></div>
<div class="line"><a id="l04513" name="l04513"></a><span class="lineno"> 4513</span><span class="comment">!           set a nominal universal value of glacial-ice specific heat capacity,</span></div>
<div class="line"><a id="l04514" name="l04514"></a><span class="lineno"> 4514</span><span class="comment">!           hcpct = 2100.0*900.0 = 1.89000e+6 (source:  bob grumbine, 2005)</span></div>
<div class="line"><a id="l04515" name="l04515"></a><span class="lineno"> 4515</span><span class="comment">!           tbot passed in as argument, value from global data set</span></div>
<div class="line"><a id="l04516" name="l04516"></a><span class="lineno"> 4516</span> </div>
<div class="line"><a id="l04517" name="l04517"></a><span class="lineno"> 4517</span>      <span class="keywordflow">if</span> (ice == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04518" name="l04518"></a><span class="lineno"> 4518</span><span class="comment">!  --- ...  sea-ice</span></div>
<div class="line"><a id="l04519" name="l04519"></a><span class="lineno"> 4519</span>        hcpct = 1.72396e+6</div>
<div class="line"><a id="l04520" name="l04520"></a><span class="lineno"> 4520</span>        tbot = 271.16</div>
<div class="line"><a id="l04521" name="l04521"></a><span class="lineno"> 4521</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l04522" name="l04522"></a><span class="lineno"> 4522</span><span class="comment">!  --- ...  glacial-ice</span></div>
<div class="line"><a id="l04523" name="l04523"></a><span class="lineno"> 4523</span>        hcpct = 1.89000e+6</div>
<div class="line"><a id="l04524" name="l04524"></a><span class="lineno"> 4524</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l04525" name="l04525"></a><span class="lineno"> 4525</span> </div>
<div class="line"><a id="l04526" name="l04526"></a><span class="lineno"> 4526</span><span class="comment">!  --- ...  the input argument df1 is a universally constant value of sea-ice</span></div>
<div class="line"><a id="l04527" name="l04527"></a><span class="lineno"> 4527</span><span class="comment">!           and glacial-ice thermal diffusivity, set in sflx as df1 = 2.2.</span></div>
<div class="line"><a id="l04528" name="l04528"></a><span class="lineno"> 4528</span> </div>
<div class="line"><a id="l04529" name="l04529"></a><span class="lineno"> 4529</span><span class="comment">!  --- ...  set ice pack depth.  use tbot as ice pack lower boundary temperature</span></div>
<div class="line"><a id="l04530" name="l04530"></a><span class="lineno"> 4530</span><span class="comment">!           (that of unfrozen sea water at bottom of sea ice pack).  assume ice</span></div>
<div class="line"><a id="l04531" name="l04531"></a><span class="lineno"> 4531</span><span class="comment">!           pack is of n=nsoil layers spanning a uniform constant ice pack</span></div>
<div class="line"><a id="l04532" name="l04532"></a><span class="lineno"> 4532</span><span class="comment">!           thickness as defined by zsoil(nsoil) in routine sflx.</span></div>
<div class="line"><a id="l04533" name="l04533"></a><span class="lineno"> 4533</span><span class="comment">!           if glacial-ice, set zbot = -25 meters</span></div>
<div class="line"><a id="l04534" name="l04534"></a><span class="lineno"> 4534</span> </div>
<div class="line"><a id="l04535" name="l04535"></a><span class="lineno"> 4535</span>      <span class="keywordflow">if</span> (ice == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04536" name="l04536"></a><span class="lineno"> 4536</span><span class="comment">!  --- ...  sea-ice</span></div>
<div class="line"><a id="l04537" name="l04537"></a><span class="lineno"> 4537</span>        zbot = zsoil(nsoil)</div>
<div class="line"><a id="l04538" name="l04538"></a><span class="lineno"> 4538</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l04539" name="l04539"></a><span class="lineno"> 4539</span><span class="comment">!  --- ...  glacial-ice</span></div>
<div class="line"><a id="l04540" name="l04540"></a><span class="lineno"> 4540</span>        zbot = -25.0</div>
<div class="line"><a id="l04541" name="l04541"></a><span class="lineno"> 4541</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l04542" name="l04542"></a><span class="lineno"> 4542</span> </div>
<div class="line"><a id="l04543" name="l04543"></a><span class="lineno"> 4543</span><span class="comment">!  --- ...  calc the matrix coefficients ai, bi, and ci for the top layer</span></div>
<div class="line"><a id="l04544" name="l04544"></a><span class="lineno"> 4544</span> </div>
<div class="line"><a id="l04545" name="l04545"></a><span class="lineno"> 4545</span>      ddz = 1.0 / (-0.5*zsoil(2))</div>
<div class="line"><a id="l04546" name="l04546"></a><span class="lineno"> 4546</span>      ai(1) = 0.0</div>
<div class="line"><a id="l04547" name="l04547"></a><span class="lineno"> 4547</span>      ci(1) = (df1*ddz) / (zsoil(1)*hcpct)</div>
<div class="line"><a id="l04548" name="l04548"></a><span class="lineno"> 4548</span>      bi(1) = -ci(1) + df1 / (0.5*zsoil(1)*zsoil(1)*hcpct*zz1)</div>
<div class="line"><a id="l04549" name="l04549"></a><span class="lineno"> 4549</span> </div>
<div class="line"><a id="l04550" name="l04550"></a><span class="lineno"> 4550</span><span class="comment">!  --- ...  calc the vertical soil temp gradient btwn the top and 2nd soil</span></div>
<div class="line"><a id="l04551" name="l04551"></a><span class="lineno"> 4551</span><span class="comment">!           layers. recalc/adjust the soil heat flux.  use the gradient and</span></div>
<div class="line"><a id="l04552" name="l04552"></a><span class="lineno"> 4552</span><span class="comment">!           flux to calc rhsts for the top soil layer.</span></div>
<div class="line"><a id="l04553" name="l04553"></a><span class="lineno"> 4553</span> </div>
<div class="line"><a id="l04554" name="l04554"></a><span class="lineno"> 4554</span>      dtsdz = (stc(1) - stc(2)) / (-0.5*zsoil(2))</div>
<div class="line"><a id="l04555" name="l04555"></a><span class="lineno"> 4555</span>      ssoil = df1 * (stc(1) - yy) / (0.5*zsoil(1)*zz1)</div>
<div class="line"><a id="l04556" name="l04556"></a><span class="lineno"> 4556</span>      rhsts(1) = (df1*dtsdz - ssoil) / (zsoil(1)*hcpct)</div>
<div class="line"><a id="l04557" name="l04557"></a><span class="lineno"> 4557</span> </div>
<div class="line"><a id="l04558" name="l04558"></a><span class="lineno"> 4558</span><span class="comment">!  --- ...  initialize ddz2</span></div>
<div class="line"><a id="l04559" name="l04559"></a><span class="lineno"> 4559</span> </div>
<div class="line"><a id="l04560" name="l04560"></a><span class="lineno"> 4560</span>      ddz2 = 0.0</div>
<div class="line"><a id="l04561" name="l04561"></a><span class="lineno"> 4561</span> </div>
<div class="line"><a id="l04562" name="l04562"></a><span class="lineno"> 4562</span><span class="comment">!  --- ...  loop thru the remaining soil layers, repeating the above process</span></div>
<div class="line"><a id="l04563" name="l04563"></a><span class="lineno"> 4563</span> </div>
<div class="line"><a id="l04564" name="l04564"></a><span class="lineno"> 4564</span>      <span class="keywordflow">do</span> k = 2, nsoil</div>
<div class="line"><a id="l04565" name="l04565"></a><span class="lineno"> 4565</span> </div>
<div class="line"><a id="l04566" name="l04566"></a><span class="lineno"> 4566</span>        <span class="keywordflow">if</span> (k /= nsoil) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04567" name="l04567"></a><span class="lineno"> 4567</span> </div>
<div class="line"><a id="l04568" name="l04568"></a><span class="lineno"> 4568</span><span class="comment">!  --- ...  calc the vertical soil temp gradient thru this layer.</span></div>
<div class="line"><a id="l04569" name="l04569"></a><span class="lineno"> 4569</span> </div>
<div class="line"><a id="l04570" name="l04570"></a><span class="lineno"> 4570</span>          denom = 0.5 * (zsoil(k-1) - zsoil(k+1))</div>
<div class="line"><a id="l04571" name="l04571"></a><span class="lineno"> 4571</span>          dtsdz2 = (stc(k) - stc(k+1)) / denom</div>
<div class="line"><a id="l04572" name="l04572"></a><span class="lineno"> 4572</span> </div>
<div class="line"><a id="l04573" name="l04573"></a><span class="lineno"> 4573</span><span class="comment">!  --- ...  calc the matrix coef, ci, after calc&#39;ng its partial product.</span></div>
<div class="line"><a id="l04574" name="l04574"></a><span class="lineno"> 4574</span> </div>
<div class="line"><a id="l04575" name="l04575"></a><span class="lineno"> 4575</span>          ddz2 = 2.0 / (zsoil(k-1) - zsoil(k+1))</div>
<div class="line"><a id="l04576" name="l04576"></a><span class="lineno"> 4576</span>          ci(k) = -df1*ddz2 / ((zsoil(k-1) - zsoil(k))*hcpct)</div>
<div class="line"><a id="l04577" name="l04577"></a><span class="lineno"> 4577</span> </div>
<div class="line"><a id="l04578" name="l04578"></a><span class="lineno"> 4578</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l04579" name="l04579"></a><span class="lineno"> 4579</span> </div>
<div class="line"><a id="l04580" name="l04580"></a><span class="lineno"> 4580</span><span class="comment">!  --- ...  calc the vertical soil temp gradient thru the lowest layer.</span></div>
<div class="line"><a id="l04581" name="l04581"></a><span class="lineno"> 4581</span> </div>
<div class="line"><a id="l04582" name="l04582"></a><span class="lineno"> 4582</span>          dtsdz2 = (stc(k) - tbot)                                      &amp;</div>
<div class="line"><a id="l04583" name="l04583"></a><span class="lineno"> 4583</span>     &amp;           / (0.5*(zsoil(k-1) + zsoil(k)) - zbot)</div>
<div class="line"><a id="l04584" name="l04584"></a><span class="lineno"> 4584</span> </div>
<div class="line"><a id="l04585" name="l04585"></a><span class="lineno"> 4585</span><span class="comment">!  --- ...  set matrix coef, ci to zero.</span></div>
<div class="line"><a id="l04586" name="l04586"></a><span class="lineno"> 4586</span> </div>
<div class="line"><a id="l04587" name="l04587"></a><span class="lineno"> 4587</span>          ci(k) = 0.0</div>
<div class="line"><a id="l04588" name="l04588"></a><span class="lineno"> 4588</span> </div>
<div class="line"><a id="l04589" name="l04589"></a><span class="lineno"> 4589</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_k_block</span></div>
<div class="line"><a id="l04590" name="l04590"></a><span class="lineno"> 4590</span> </div>
<div class="line"><a id="l04591" name="l04591"></a><span class="lineno"> 4591</span><span class="comment">!  --- ...  calc rhsts for this layer after calc&#39;ng a partial product.</span></div>
<div class="line"><a id="l04592" name="l04592"></a><span class="lineno"> 4592</span> </div>
<div class="line"><a id="l04593" name="l04593"></a><span class="lineno"> 4593</span>        denom = (zsoil(k) - zsoil(k-1)) * hcpct</div>
<div class="line"><a id="l04594" name="l04594"></a><span class="lineno"> 4594</span>        rhsts(k) = (df1*dtsdz2 - df1*dtsdz) / denom</div>
<div class="line"><a id="l04595" name="l04595"></a><span class="lineno"> 4595</span> </div>
<div class="line"><a id="l04596" name="l04596"></a><span class="lineno"> 4596</span><span class="comment">!  --- ...  calc matrix coefs, ai, and bi for this layer.</span></div>
<div class="line"><a id="l04597" name="l04597"></a><span class="lineno"> 4597</span> </div>
<div class="line"><a id="l04598" name="l04598"></a><span class="lineno"> 4598</span>        ai(k) = - df1*ddz / ((zsoil(k-1) - zsoil(k)) * hcpct)</div>
<div class="line"><a id="l04599" name="l04599"></a><span class="lineno"> 4599</span>        bi(k) = -(ai(k) + ci(k))</div>
<div class="line"><a id="l04600" name="l04600"></a><span class="lineno"> 4600</span> </div>
<div class="line"><a id="l04601" name="l04601"></a><span class="lineno"> 4601</span><span class="comment">!  --- ...  reset values of dtsdz and ddz for loop to next soil lyr.</span></div>
<div class="line"><a id="l04602" name="l04602"></a><span class="lineno"> 4602</span> </div>
<div class="line"><a id="l04603" name="l04603"></a><span class="lineno"> 4603</span>        dtsdz = dtsdz2</div>
<div class="line"><a id="l04604" name="l04604"></a><span class="lineno"> 4604</span>        ddz   = ddz2</div>
<div class="line"><a id="l04605" name="l04605"></a><span class="lineno"> 4605</span> </div>
<div class="line"><a id="l04606" name="l04606"></a><span class="lineno"> 4606</span><span class="keywordflow">      enddo</span>   <span class="comment">! end do_k_loop</span></div>
<div class="line"><a id="l04607" name="l04607"></a><span class="lineno"> 4607</span><span class="comment">!</span></div>
<div class="line"><a id="l04608" name="l04608"></a><span class="lineno"> 4608</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l04609" name="l04609"></a><span class="lineno"> 4609</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga32e89df3740f968f500900125ae9633d.html#ga32e89df3740f968f500900125ae9633d">hrtice</a></div>
<div class="line"><a id="l04610" name="l04610"></a><span class="lineno"> 4610</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l04611" name="l04611"></a><span class="lineno"> 4611</span> </div>
<div class="line"><a id="l04612" name="l04612"></a><span class="lineno"> 4612</span> </div>
<div class="line"><a id="l04613" name="l04613"></a><span class="lineno"> 4613</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l04614" name="l04614"></a><span class="lineno"> 4614</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l04615" name="l04615"></a><span class="lineno"> 4615</span><span class="comment">!&gt; This subroutine calculates/updates the soil temperature field.</span></div>
<div class="foldopen" id="foldopen04616" data-start="" data-end="">
<div class="line"><a id="l04616" name="l04616"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gacb79bab20ee25c57918575949c15de73.html#gacb79bab20ee25c57918575949c15de73"> 4616</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gacb79bab20ee25c57918575949c15de73.html#gacb79bab20ee25c57918575949c15de73">hstep</a>                                                  &amp;</div>
<div class="line"><a id="l04617" name="l04617"></a><span class="lineno"> 4617</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04618" name="l04618"></a><span class="lineno"> 4618</span>     &amp;     ( nsoil, stcin, dt,                                          &amp;</div>
<div class="line"><a id="l04619" name="l04619"></a><span class="lineno"> 4619</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04620" name="l04620"></a><span class="lineno"> 4620</span>     &amp;       rhsts, ai, bi, ci,                                         &amp;</div>
<div class="line"><a id="l04621" name="l04621"></a><span class="lineno"> 4621</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04622" name="l04622"></a><span class="lineno"> 4622</span>     &amp;       stcout                                                     &amp;</div>
<div class="line"><a id="l04623" name="l04623"></a><span class="lineno"> 4623</span>     &amp;     )</div>
<div class="line"><a id="l04624" name="l04624"></a><span class="lineno"> 4624</span> </div>
<div class="line"><a id="l04625" name="l04625"></a><span class="lineno"> 4625</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l04626" name="l04626"></a><span class="lineno"> 4626</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l04627" name="l04627"></a><span class="lineno"> 4627</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04628" name="l04628"></a><span class="lineno"> 4628</span><span class="comment">!  subroutine hstep calculates/updates the soil temperature field.      !</span></div>
<div class="line"><a id="l04629" name="l04629"></a><span class="lineno"> 4629</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04630" name="l04630"></a><span class="lineno"> 4630</span><span class="comment">!  subprogram called:  rosr12                                           !</span></div>
<div class="line"><a id="l04631" name="l04631"></a><span class="lineno"> 4631</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04632" name="l04632"></a><span class="lineno"> 4632</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04633" name="l04633"></a><span class="lineno"> 4633</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l04634" name="l04634"></a><span class="lineno"> 4634</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04635" name="l04635"></a><span class="lineno"> 4635</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l04636" name="l04636"></a><span class="lineno"> 4636</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l04637" name="l04637"></a><span class="lineno"> 4637</span><span class="comment">!     stcin    - real, soil temperature                          nsoil  !</span></div>
<div class="line"><a id="l04638" name="l04638"></a><span class="lineno"> 4638</span><span class="comment">!     dt       - real, time step                                   1    !</span></div>
<div class="line"><a id="l04639" name="l04639"></a><span class="lineno"> 4639</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04640" name="l04640"></a><span class="lineno"> 4640</span><span class="comment">!  input/outputs:                                                       !</span></div>
<div class="line"><a id="l04641" name="l04641"></a><span class="lineno"> 4641</span><span class="comment">!     rhsts    - real, time tendency of soil thermal diffusion   nsoil  !</span></div>
<div class="line"><a id="l04642" name="l04642"></a><span class="lineno"> 4642</span><span class="comment">!     ai       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l04643" name="l04643"></a><span class="lineno"> 4643</span><span class="comment">!     bi       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l04644" name="l04644"></a><span class="lineno"> 4644</span><span class="comment">!     ci       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l04645" name="l04645"></a><span class="lineno"> 4645</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04646" name="l04646"></a><span class="lineno"> 4646</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l04647" name="l04647"></a><span class="lineno"> 4647</span><span class="comment">!     stcout   - real, updated soil temperature                  nsoil  !</span></div>
<div class="line"><a id="l04648" name="l04648"></a><span class="lineno"> 4648</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04649" name="l04649"></a><span class="lineno"> 4649</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l04650" name="l04650"></a><span class="lineno"> 4650</span><span class="comment">!</span></div>
<div class="line"><a id="l04651" name="l04651"></a><span class="lineno"> 4651</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04652" name="l04652"></a><span class="lineno"> 4652</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil</div>
<div class="line"><a id="l04653" name="l04653"></a><span class="lineno"> 4653</span> </div>
<div class="line"><a id="l04654" name="l04654"></a><span class="lineno"> 4654</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">intent(in)</span> :: stcin(nsoil), dt</div>
<div class="line"><a id="l04655" name="l04655"></a><span class="lineno"> 4655</span> </div>
<div class="line"><a id="l04656" name="l04656"></a><span class="lineno"> 4656</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04657" name="l04657"></a><span class="lineno"> 4657</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">intent(inout)</span> :: rhsts(nsoil),            &amp;</div>
<div class="line"><a id="l04658" name="l04658"></a><span class="lineno"> 4658</span>     &amp;      ai(nsold), bi(nsold), ci(nsold)</div>
<div class="line"><a id="l04659" name="l04659"></a><span class="lineno"> 4659</span> </div>
<div class="line"><a id="l04660" name="l04660"></a><span class="lineno"> 4660</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04661" name="l04661"></a><span class="lineno"> 4661</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">intent(out)</span> :: stcout(nsoil)</div>
<div class="line"><a id="l04662" name="l04662"></a><span class="lineno"> 4662</span> </div>
<div class="line"><a id="l04663" name="l04663"></a><span class="lineno"> 4663</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l04664" name="l04664"></a><span class="lineno"> 4664</span>      <span class="keywordtype">integer</span> :: k</div>
<div class="line"><a id="l04665" name="l04665"></a><span class="lineno"> 4665</span> </div>
<div class="line"><a id="l04666" name="l04666"></a><span class="lineno"> 4666</span><span class="keywordtype">      real</span> (kind=kind_phys) :: ciin(nsold), rhstsin(nsoil)</div>
<div class="line"><a id="l04667" name="l04667"></a><span class="lineno"> 4667</span> </div>
<div class="line"><a id="l04668" name="l04668"></a><span class="lineno"> 4668</span><span class="comment">!</span></div>
<div class="line"><a id="l04669" name="l04669"></a><span class="lineno"> 4669</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l04670" name="l04670"></a><span class="lineno"> 4670</span><span class="comment">!</span></div>
<div class="line"><a id="l04671" name="l04671"></a><span class="lineno"> 4671</span><span class="comment">!  --- ...  create finite difference values for use in rosr12 routine</span></div>
<div class="line"><a id="l04672" name="l04672"></a><span class="lineno"> 4672</span> </div>
<div class="line"><a id="l04673" name="l04673"></a><span class="lineno"> 4673</span>      <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l04674" name="l04674"></a><span class="lineno"> 4674</span>        rhsts(k) = rhsts(k) * dt</div>
<div class="line"><a id="l04675" name="l04675"></a><span class="lineno"> 4675</span>        ai(k) = ai(k) * dt</div>
<div class="line"><a id="l04676" name="l04676"></a><span class="lineno"> 4676</span>        bi(k) = 1.0 + bi(k)*dt</div>
<div class="line"><a id="l04677" name="l04677"></a><span class="lineno"> 4677</span>        ci(k) = ci(k) * dt</div>
<div class="line"><a id="l04678" name="l04678"></a><span class="lineno"> 4678</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l04679" name="l04679"></a><span class="lineno"> 4679</span> </div>
<div class="line"><a id="l04680" name="l04680"></a><span class="lineno"> 4680</span><span class="comment">!  --- ...  copy values for input variables before call to rosr12</span></div>
<div class="line"><a id="l04681" name="l04681"></a><span class="lineno"> 4681</span> </div>
<div class="line"><a id="l04682" name="l04682"></a><span class="lineno"> 4682</span>      <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l04683" name="l04683"></a><span class="lineno"> 4683</span>         rhstsin(k) = rhsts(k)</div>
<div class="line"><a id="l04684" name="l04684"></a><span class="lineno"> 4684</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l04685" name="l04685"></a><span class="lineno"> 4685</span> </div>
<div class="line"><a id="l04686" name="l04686"></a><span class="lineno"> 4686</span>      <span class="keywordflow">do</span> k = 1, nsold</div>
<div class="line"><a id="l04687" name="l04687"></a><span class="lineno"> 4687</span>        ciin(k) = ci(k)</div>
<div class="line"><a id="l04688" name="l04688"></a><span class="lineno"> 4688</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l04689" name="l04689"></a><span class="lineno"> 4689</span> </div>
<div class="line"><a id="l04690" name="l04690"></a><span class="lineno"> 4690</span><span class="comment">!  --- ...  solve the tri-diagonal matrix equation</span></div>
<div class="line"><a id="l04691" name="l04691"></a><span class="lineno"> 4691</span> </div>
<div class="line"><a id="l04692" name="l04692"></a><span class="lineno"> 4692</span>      <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga3d7dabe1147278de865aa4691d5b2de0.html#ga3d7dabe1147278de865aa4691d5b2de0">rosr12</a>                                                       &amp;</div>
<div class="line"><a id="l04693" name="l04693"></a><span class="lineno"> 4693</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04694" name="l04694"></a><span class="lineno"> 4694</span>     &amp;     ( nsoil, ai, bi, rhstsin,                                    &amp;</div>
<div class="line"><a id="l04695" name="l04695"></a><span class="lineno"> 4695</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04696" name="l04696"></a><span class="lineno"> 4696</span>     &amp;       ciin,                                                      &amp;</div>
<div class="line"><a id="l04697" name="l04697"></a><span class="lineno"> 4697</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04698" name="l04698"></a><span class="lineno"> 4698</span>     &amp;       ci, rhsts                                                  &amp;</div>
<div class="line"><a id="l04699" name="l04699"></a><span class="lineno"> 4699</span>     &amp;     )</div>
<div class="line"><a id="l04700" name="l04700"></a><span class="lineno"> 4700</span> </div>
<div class="line"><a id="l04701" name="l04701"></a><span class="lineno"> 4701</span><span class="comment">!  --- ...  calc/update the soil temps using matrix solution</span></div>
<div class="line"><a id="l04702" name="l04702"></a><span class="lineno"> 4702</span> </div>
<div class="line"><a id="l04703" name="l04703"></a><span class="lineno"> 4703</span>      <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l04704" name="l04704"></a><span class="lineno"> 4704</span>        stcout(k) = stcin(k) + ci(k)</div>
<div class="line"><a id="l04705" name="l04705"></a><span class="lineno"> 4705</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l04706" name="l04706"></a><span class="lineno"> 4706</span><span class="comment">!</span></div>
<div class="line"><a id="l04707" name="l04707"></a><span class="lineno"> 4707</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l04708" name="l04708"></a><span class="lineno"> 4708</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gacb79bab20ee25c57918575949c15de73.html#gacb79bab20ee25c57918575949c15de73">hstep</a></div>
<div class="line"><a id="l04709" name="l04709"></a><span class="lineno"> 4709</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l04710" name="l04710"></a><span class="lineno"> 4710</span> </div>
<div class="line"><a id="l04711" name="l04711"></a><span class="lineno"> 4711</span> </div>
<div class="line"><a id="l04712" name="l04712"></a><span class="lineno"> 4712</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l04713" name="l04713"></a><span class="lineno"> 4713</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l04714" name="l04714"></a><span class="lineno"> 4714</span><span class="comment">!&gt; This subroutine inverts (solve) the tri-diagonal matrix problem.</span></div>
<div class="foldopen" id="foldopen04715" data-start="" data-end="">
<div class="line"><a id="l04715" name="l04715"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga3d7dabe1147278de865aa4691d5b2de0.html#ga3d7dabe1147278de865aa4691d5b2de0"> 4715</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga3d7dabe1147278de865aa4691d5b2de0.html#ga3d7dabe1147278de865aa4691d5b2de0">rosr12</a>                                                 &amp;</div>
<div class="line"><a id="l04716" name="l04716"></a><span class="lineno"> 4716</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04717" name="l04717"></a><span class="lineno"> 4717</span>     &amp;     ( nsoil, a, b, d,                                            &amp;</div>
<div class="line"><a id="l04718" name="l04718"></a><span class="lineno"> 4718</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04719" name="l04719"></a><span class="lineno"> 4719</span>     &amp;       c,                                                         &amp;</div>
<div class="line"><a id="l04720" name="l04720"></a><span class="lineno"> 4720</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04721" name="l04721"></a><span class="lineno"> 4721</span>     &amp;       p, delta                                                   &amp;</div>
<div class="line"><a id="l04722" name="l04722"></a><span class="lineno"> 4722</span>     &amp;     )</div>
<div class="line"><a id="l04723" name="l04723"></a><span class="lineno"> 4723</span> </div>
<div class="line"><a id="l04724" name="l04724"></a><span class="lineno"> 4724</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l04725" name="l04725"></a><span class="lineno"> 4725</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l04726" name="l04726"></a><span class="lineno"> 4726</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04727" name="l04727"></a><span class="lineno"> 4727</span><span class="comment">!  subroutine rosr12 inverts (solve) the tri-diagonal matrix problem    !</span></div>
<div class="line"><a id="l04728" name="l04728"></a><span class="lineno"> 4728</span><span class="comment">!  shown below:                                                         !</span></div>
<div class="line"><a id="l04729" name="l04729"></a><span class="lineno"> 4729</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04730" name="l04730"></a><span class="lineno"> 4730</span><span class="comment">! ###                                            ### ###  ###   ###  ###!</span></div>
<div class="line"><a id="l04731" name="l04731"></a><span class="lineno"> 4731</span><span class="comment">! #b(1), c(1),  0  ,  0  ,  0  ,   . . .  ,    0   # #      #   #      #!</span></div>
<div class="line"><a id="l04732" name="l04732"></a><span class="lineno"> 4732</span><span class="comment">! #a(2), b(2), c(2),  0  ,  0  ,   . . .  ,    0   # #      #   #      #!</span></div>
<div class="line"><a id="l04733" name="l04733"></a><span class="lineno"> 4733</span><span class="comment">! # 0  , a(3), b(3), c(3),  0  ,   . . .  ,    0   # #      #   # d(3) #!</span></div>
<div class="line"><a id="l04734" name="l04734"></a><span class="lineno"> 4734</span><span class="comment">! # 0  ,  0  , a(4), b(4), c(4),   . . .  ,    0   # # p(4) #   # d(4) #!</span></div>
<div class="line"><a id="l04735" name="l04735"></a><span class="lineno"> 4735</span><span class="comment">! # 0  ,  0  ,  0  , a(5), b(5),   . . .  ,    0   # # p(5) #   # d(5) #!</span></div>
<div class="line"><a id="l04736" name="l04736"></a><span class="lineno"> 4736</span><span class="comment">! # .                                          .   # #  .   # = #   .  #!</span></div>
<div class="line"><a id="l04737" name="l04737"></a><span class="lineno"> 4737</span><span class="comment">! # .                                          .   # #  .   #   #   .  #!</span></div>
<div class="line"><a id="l04738" name="l04738"></a><span class="lineno"> 4738</span><span class="comment">! # .                                          .   # #  .   #   #   .  #!</span></div>
<div class="line"><a id="l04739" name="l04739"></a><span class="lineno"> 4739</span><span class="comment">! # 0  , . . . , 0 , a(m-2), b(m-2), c(m-2),   0   # #p(m-2)#   #d(m-2)#!</span></div>
<div class="line"><a id="l04740" name="l04740"></a><span class="lineno"> 4740</span><span class="comment">! # 0  , . . . , 0 ,   0   , a(m-1), b(m-1), c(m-1)# #p(m-1)#   #d(m-1)#!</span></div>
<div class="line"><a id="l04741" name="l04741"></a><span class="lineno"> 4741</span><span class="comment">! # 0  , . . . , 0 ,   0   ,   0   ,  a(m) ,  b(m) # # p(m) #   # d(m) #!</span></div>
<div class="line"><a id="l04742" name="l04742"></a><span class="lineno"> 4742</span><span class="comment">! ###                                            ### ###  ###   ###  ###!</span></div>
<div class="line"><a id="l04743" name="l04743"></a><span class="lineno"> 4743</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04744" name="l04744"></a><span class="lineno"> 4744</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l04745" name="l04745"></a><span class="lineno"> 4745</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04746" name="l04746"></a><span class="lineno"> 4746</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04747" name="l04747"></a><span class="lineno"> 4747</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l04748" name="l04748"></a><span class="lineno"> 4748</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04749" name="l04749"></a><span class="lineno"> 4749</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l04750" name="l04750"></a><span class="lineno"> 4750</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l04751" name="l04751"></a><span class="lineno"> 4751</span><span class="comment">!     a        - real, matrix coefficients                       nsoil  !</span></div>
<div class="line"><a id="l04752" name="l04752"></a><span class="lineno"> 4752</span><span class="comment">!     b        - real, matrix coefficients                       nsoil  !</span></div>
<div class="line"><a id="l04753" name="l04753"></a><span class="lineno"> 4753</span><span class="comment">!     d        - real, soil water time tendency                  nsoil  !</span></div>
<div class="line"><a id="l04754" name="l04754"></a><span class="lineno"> 4754</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04755" name="l04755"></a><span class="lineno"> 4755</span><span class="comment">!  input/outputs:                                                       !</span></div>
<div class="line"><a id="l04756" name="l04756"></a><span class="lineno"> 4756</span><span class="comment">!     c        - real, matrix coefficients                       nsoil  !</span></div>
<div class="line"><a id="l04757" name="l04757"></a><span class="lineno"> 4757</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04758" name="l04758"></a><span class="lineno"> 4758</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l04759" name="l04759"></a><span class="lineno"> 4759</span><span class="comment">!     p        - real,                                           nsoil  !</span></div>
<div class="line"><a id="l04760" name="l04760"></a><span class="lineno"> 4760</span><span class="comment">!     delta    - real,                                           nsoil  !</span></div>
<div class="line"><a id="l04761" name="l04761"></a><span class="lineno"> 4761</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04762" name="l04762"></a><span class="lineno"> 4762</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l04763" name="l04763"></a><span class="lineno"> 4763</span><span class="comment">!</span></div>
<div class="line"><a id="l04764" name="l04764"></a><span class="lineno"> 4764</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04765" name="l04765"></a><span class="lineno"> 4765</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil</div>
<div class="line"><a id="l04766" name="l04766"></a><span class="lineno"> 4766</span> </div>
<div class="line"><a id="l04767" name="l04767"></a><span class="lineno"> 4767</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">dimension(nsoil)</span>, <span class="keywordtype">intent(in)</span> :: a, b, d</div>
<div class="line"><a id="l04768" name="l04768"></a><span class="lineno"> 4768</span> </div>
<div class="line"><a id="l04769" name="l04769"></a><span class="lineno"> 4769</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04770" name="l04770"></a><span class="lineno"> 4770</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">dimension(nsoil)</span>, <span class="keywordtype">intent(inout)</span> :: c</div>
<div class="line"><a id="l04771" name="l04771"></a><span class="lineno"> 4771</span> </div>
<div class="line"><a id="l04772" name="l04772"></a><span class="lineno"> 4772</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04773" name="l04773"></a><span class="lineno"> 4773</span><span class="keywordtype">      real</span> (kind=kind_phys),  <span class="keywordtype">dimension(nsoil)</span>, <span class="keywordtype">intent(out)</span> :: p, delta</div>
<div class="line"><a id="l04774" name="l04774"></a><span class="lineno"> 4774</span> </div>
<div class="line"><a id="l04775" name="l04775"></a><span class="lineno"> 4775</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l04776" name="l04776"></a><span class="lineno"> 4776</span>      <span class="keywordtype">integer</span> :: k, kk</div>
<div class="line"><a id="l04777" name="l04777"></a><span class="lineno"> 4777</span> </div>
<div class="line"><a id="l04778" name="l04778"></a><span class="lineno"> 4778</span><span class="comment">!</span></div>
<div class="line"><a id="l04779" name="l04779"></a><span class="lineno"> 4779</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l04780" name="l04780"></a><span class="lineno"> 4780</span><span class="comment">!</span></div>
<div class="line"><a id="l04781" name="l04781"></a><span class="lineno"> 4781</span><span class="comment">!  --- ...  initialize eqn coef c for the lowest soil layer</span></div>
<div class="line"><a id="l04782" name="l04782"></a><span class="lineno"> 4782</span> </div>
<div class="line"><a id="l04783" name="l04783"></a><span class="lineno"> 4783</span>      c(nsoil) = 0.0</div>
<div class="line"><a id="l04784" name="l04784"></a><span class="lineno"> 4784</span> </div>
<div class="line"><a id="l04785" name="l04785"></a><span class="lineno"> 4785</span><span class="comment">!  --- ...  solve the coefs for the 1st soil layer</span></div>
<div class="line"><a id="l04786" name="l04786"></a><span class="lineno"> 4786</span> </div>
<div class="line"><a id="l04787" name="l04787"></a><span class="lineno"> 4787</span>      p(1) = -c(1) / b(1)</div>
<div class="line"><a id="l04788" name="l04788"></a><span class="lineno"> 4788</span>      delta(1) = d(1) / b(1)</div>
<div class="line"><a id="l04789" name="l04789"></a><span class="lineno"> 4789</span> </div>
<div class="line"><a id="l04790" name="l04790"></a><span class="lineno"> 4790</span><span class="comment">!  --- ...  solve the coefs for soil layers 2 thru nsoil</span></div>
<div class="line"><a id="l04791" name="l04791"></a><span class="lineno"> 4791</span> </div>
<div class="line"><a id="l04792" name="l04792"></a><span class="lineno"> 4792</span>      <span class="keywordflow">do</span> k = 2, nsoil</div>
<div class="line"><a id="l04793" name="l04793"></a><span class="lineno"> 4793</span>        p(k) = -c(k) * ( 1.0 / (b(k) + a(k)*p(k-1)) )</div>
<div class="line"><a id="l04794" name="l04794"></a><span class="lineno"> 4794</span>        delta(k) = (d(k) - a(k)*delta(k-1))                              &amp;</div>
<div class="line"><a id="l04795" name="l04795"></a><span class="lineno"> 4795</span>     &amp;           * ( 1.0 / (b(k) + a(k)*p(k-1)) )</div>
<div class="line"><a id="l04796" name="l04796"></a><span class="lineno"> 4796</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l04797" name="l04797"></a><span class="lineno"> 4797</span> </div>
<div class="line"><a id="l04798" name="l04798"></a><span class="lineno"> 4798</span><span class="comment">!  --- ...  set p to delta for lowest soil layer</span></div>
<div class="line"><a id="l04799" name="l04799"></a><span class="lineno"> 4799</span> </div>
<div class="line"><a id="l04800" name="l04800"></a><span class="lineno"> 4800</span>      p(nsoil) = delta(nsoil)</div>
<div class="line"><a id="l04801" name="l04801"></a><span class="lineno"> 4801</span> </div>
<div class="line"><a id="l04802" name="l04802"></a><span class="lineno"> 4802</span><span class="comment">!  --- ...  adjust p for soil layers 2 thru nsoil</span></div>
<div class="line"><a id="l04803" name="l04803"></a><span class="lineno"> 4803</span> </div>
<div class="line"><a id="l04804" name="l04804"></a><span class="lineno"> 4804</span>      <span class="keywordflow">do</span> k = 2, nsoil</div>
<div class="line"><a id="l04805" name="l04805"></a><span class="lineno"> 4805</span>         kk = nsoil - k + 1</div>
<div class="line"><a id="l04806" name="l04806"></a><span class="lineno"> 4806</span>         p(kk) = p(kk)*p(kk+1) + delta(kk)</div>
<div class="line"><a id="l04807" name="l04807"></a><span class="lineno"> 4807</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l04808" name="l04808"></a><span class="lineno"> 4808</span><span class="comment">!</span></div>
<div class="line"><a id="l04809" name="l04809"></a><span class="lineno"> 4809</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l04810" name="l04810"></a><span class="lineno"> 4810</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga3d7dabe1147278de865aa4691d5b2de0.html#ga3d7dabe1147278de865aa4691d5b2de0">rosr12</a></div>
<div class="line"><a id="l04811" name="l04811"></a><span class="lineno"> 4811</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l04812" name="l04812"></a><span class="lineno"> 4812</span> </div>
<div class="line"><a id="l04813" name="l04813"></a><span class="lineno"> 4813</span> </div>
<div class="line"><a id="l04814" name="l04814"></a><span class="lineno"> 4814</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l04815" name="l04815"></a><span class="lineno"> 4815</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l04816" name="l04816"></a><span class="lineno"> 4816</span><span class="comment">!&gt; This subroutine calculates sink/source term of the termal diffusion equation.</span></div>
<div class="foldopen" id="foldopen04817" data-start="" data-end="">
<div class="line"><a id="l04817" name="l04817"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga1b241897d00ec3d66eabe9e959d0ce04.html#ga1b241897d00ec3d66eabe9e959d0ce04"> 4817</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga1b241897d00ec3d66eabe9e959d0ce04.html#ga1b241897d00ec3d66eabe9e959d0ce04">snksrc</a>                                                 &amp;</div>
<div class="line"><a id="l04818" name="l04818"></a><span class="lineno"> 4818</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04819" name="l04819"></a><span class="lineno"> 4819</span>     &amp;     ( nsoil, k, tavg, smc, smcmax, psisat, bexp, dt,             &amp;</div>
<div class="line"><a id="l04820" name="l04820"></a><span class="lineno"> 4820</span>     &amp;       qtot, zsoil,                                               &amp;</div>
<div class="line"><a id="l04821" name="l04821"></a><span class="lineno"> 4821</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04822" name="l04822"></a><span class="lineno"> 4822</span>     &amp;       sh2o,                                                      &amp;</div>
<div class="line"><a id="l04823" name="l04823"></a><span class="lineno"> 4823</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04824" name="l04824"></a><span class="lineno"> 4824</span>     &amp;       tsrc                                                       &amp;</div>
<div class="line"><a id="l04825" name="l04825"></a><span class="lineno"> 4825</span>     &amp;     )</div>
<div class="line"><a id="l04826" name="l04826"></a><span class="lineno"> 4826</span> </div>
<div class="line"><a id="l04827" name="l04827"></a><span class="lineno"> 4827</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l04828" name="l04828"></a><span class="lineno"> 4828</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l04829" name="l04829"></a><span class="lineno"> 4829</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04830" name="l04830"></a><span class="lineno"> 4830</span><span class="comment">!  subroutine snksrc calculates sink/source term of the termal          !</span></div>
<div class="line"><a id="l04831" name="l04831"></a><span class="lineno"> 4831</span><span class="comment">!  diffusion equation.                                                  !</span></div>
<div class="line"><a id="l04832" name="l04832"></a><span class="lineno"> 4832</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04833" name="l04833"></a><span class="lineno"> 4833</span><span class="comment">!  subprograms called: frh2o                                            !</span></div>
<div class="line"><a id="l04834" name="l04834"></a><span class="lineno"> 4834</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04835" name="l04835"></a><span class="lineno"> 4835</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04836" name="l04836"></a><span class="lineno"> 4836</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l04837" name="l04837"></a><span class="lineno"> 4837</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04838" name="l04838"></a><span class="lineno"> 4838</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l04839" name="l04839"></a><span class="lineno"> 4839</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l04840" name="l04840"></a><span class="lineno"> 4840</span><span class="comment">!     k        - integer, index of soil layers                     1    !</span></div>
<div class="line"><a id="l04841" name="l04841"></a><span class="lineno"> 4841</span><span class="comment">!     tavg     - real, soil layer average temperature              1    !</span></div>
<div class="line"><a id="l04842" name="l04842"></a><span class="lineno"> 4842</span><span class="comment">!     smc      - real, total soil moisture                         1    !</span></div>
<div class="line"><a id="l04843" name="l04843"></a><span class="lineno"> 4843</span><span class="comment">!     smcmax   - real, porosity                                    1    !</span></div>
<div class="line"><a id="l04844" name="l04844"></a><span class="lineno"> 4844</span><span class="comment">!     psisat   - real, saturated soil potential                    1    !</span></div>
<div class="line"><a id="l04845" name="l04845"></a><span class="lineno"> 4845</span><span class="comment">!     bexp     - real, soil type &quot;b&quot; parameter                     1    !</span></div>
<div class="line"><a id="l04846" name="l04846"></a><span class="lineno"> 4846</span><span class="comment">!     dt       - real, time step                                   1    !</span></div>
<div class="line"><a id="l04847" name="l04847"></a><span class="lineno"> 4847</span><span class="comment">!     qtot     - real, tot vertical diff of heat flux              1    !</span></div>
<div class="line"><a id="l04848" name="l04848"></a><span class="lineno"> 4848</span><span class="comment">!     zsoil    - real, soil layer depth below ground (negative)  nsoil  !</span></div>
<div class="line"><a id="l04849" name="l04849"></a><span class="lineno"> 4849</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04850" name="l04850"></a><span class="lineno"> 4850</span><span class="comment">!  input/outputs:                                                       !</span></div>
<div class="line"><a id="l04851" name="l04851"></a><span class="lineno"> 4851</span><span class="comment">!     sh2o     - real, available liqued water                      1    !</span></div>
<div class="line"><a id="l04852" name="l04852"></a><span class="lineno"> 4852</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04853" name="l04853"></a><span class="lineno"> 4853</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l04854" name="l04854"></a><span class="lineno"> 4854</span><span class="comment">!     tsrc     - real, heat source/sink                            1    !</span></div>
<div class="line"><a id="l04855" name="l04855"></a><span class="lineno"> 4855</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04856" name="l04856"></a><span class="lineno"> 4856</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l04857" name="l04857"></a><span class="lineno"> 4857</span><span class="comment">!</span></div>
<div class="line"><a id="l04858" name="l04858"></a><span class="lineno"> 4858</span><span class="comment">!  ---  parameter constants:</span></div>
<div class="line"><a id="l04859" name="l04859"></a><span class="lineno"> 4859</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">parameter</span> :: dh2o = 1.0000e3</div>
<div class="line"><a id="l04860" name="l04860"></a><span class="lineno"> 4860</span> </div>
<div class="line"><a id="l04861" name="l04861"></a><span class="lineno"> 4861</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04862" name="l04862"></a><span class="lineno"> 4862</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil, k</div>
<div class="line"><a id="l04863" name="l04863"></a><span class="lineno"> 4863</span> </div>
<div class="line"><a id="l04864" name="l04864"></a><span class="lineno"> 4864</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: tavg, smc, smcmax, psisat,   &amp;</div>
<div class="line"><a id="l04865" name="l04865"></a><span class="lineno"> 4865</span>     &amp;       bexp, dt, qtot, zsoil(nsoil)</div>
<div class="line"><a id="l04866" name="l04866"></a><span class="lineno"> 4866</span> </div>
<div class="line"><a id="l04867" name="l04867"></a><span class="lineno"> 4867</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l04868" name="l04868"></a><span class="lineno"> 4868</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(inout)</span> :: sh2o</div>
<div class="line"><a id="l04869" name="l04869"></a><span class="lineno"> 4869</span> </div>
<div class="line"><a id="l04870" name="l04870"></a><span class="lineno"> 4870</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04871" name="l04871"></a><span class="lineno"> 4871</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: tsrc</div>
<div class="line"><a id="l04872" name="l04872"></a><span class="lineno"> 4872</span> </div>
<div class="line"><a id="l04873" name="l04873"></a><span class="lineno"> 4873</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l04874" name="l04874"></a><span class="lineno"> 4874</span><span class="keywordtype">      real</span> (kind=kind_phys) :: dz, free, xh2o</div>
<div class="line"><a id="l04875" name="l04875"></a><span class="lineno"> 4875</span> </div>
<div class="line"><a id="l04876" name="l04876"></a><span class="lineno"> 4876</span><span class="comment">!  ---  external functions:</span></div>
<div class="line"><a id="l04877" name="l04877"></a><span class="lineno"> 4877</span><span class="comment">!     real (kind=kind_phys) :: frh2o</span></div>
<div class="line"><a id="l04878" name="l04878"></a><span class="lineno"> 4878</span><span class="comment">!</span></div>
<div class="line"><a id="l04879" name="l04879"></a><span class="lineno"> 4879</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l04880" name="l04880"></a><span class="lineno"> 4880</span><span class="comment">!</span></div>
<div class="line"><a id="l04881" name="l04881"></a><span class="lineno"> 4881</span>      <span class="keywordflow">if</span> (k == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04882" name="l04882"></a><span class="lineno"> 4882</span>        dz = -zsoil(1)</div>
<div class="line"><a id="l04883" name="l04883"></a><span class="lineno"> 4883</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l04884" name="l04884"></a><span class="lineno"> 4884</span>        dz = zsoil(k-1) - zsoil(k)</div>
<div class="line"><a id="l04885" name="l04885"></a><span class="lineno"> 4885</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l04886" name="l04886"></a><span class="lineno"> 4886</span> </div>
<div class="line"><a id="l04887" name="l04887"></a><span class="lineno"> 4887</span><span class="comment">!  --- ...  via function frh2o, compute potential or &#39;equilibrium&#39; unfrozen</span></div>
<div class="line"><a id="l04888" name="l04888"></a><span class="lineno"> 4888</span><span class="comment">!           supercooled free water for given soil type and soil layer temperature.</span></div>
<div class="line"><a id="l04889" name="l04889"></a><span class="lineno"> 4889</span><span class="comment">!           function frh20 invokes eqn (17) from v. koren et al (1999, jgr, vol.</span></div>
<div class="line"><a id="l04890" name="l04890"></a><span class="lineno"> 4890</span><span class="comment">!           104, pg 19573).  (aside:  latter eqn in journal in centigrade units.</span></div>
<div class="line"><a id="l04891" name="l04891"></a><span class="lineno"> 4891</span><span class="comment">!           routine frh2o use form of eqn in kelvin units.)</span></div>
<div class="line"><a id="l04892" name="l04892"></a><span class="lineno"> 4892</span> </div>
<div class="line"><a id="l04893" name="l04893"></a><span class="lineno"> 4893</span><span class="comment">!     free = frh2o( tavg,smc,sh2o,smcmax,bexp,psisat )</span></div>
<div class="line"><a id="l04894" name="l04894"></a><span class="lineno"> 4894</span> </div>
<div class="line"><a id="l04895" name="l04895"></a><span class="lineno"> 4895</span>      <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga7c0e713811400259a984b2153834e70c.html#ga7c0e713811400259a984b2153834e70c">frh2o</a>                                                        &amp;</div>
<div class="line"><a id="l04896" name="l04896"></a><span class="lineno"> 4896</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04897" name="l04897"></a><span class="lineno"> 4897</span>     &amp;     ( tavg, smc, sh2o, smcmax, bexp, psisat,                     &amp;</div>
<div class="line"><a id="l04898" name="l04898"></a><span class="lineno"> 4898</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04899" name="l04899"></a><span class="lineno"> 4899</span>     &amp;       free                                                       &amp;</div>
<div class="line"><a id="l04900" name="l04900"></a><span class="lineno"> 4900</span>     &amp;     )</div>
<div class="line"><a id="l04901" name="l04901"></a><span class="lineno"> 4901</span> </div>
<div class="line"><a id="l04902" name="l04902"></a><span class="lineno"> 4902</span> </div>
<div class="line"><a id="l04903" name="l04903"></a><span class="lineno"> 4903</span><span class="comment">!  --- ...  in next block of code, invoke eqn 18 of v. koren et al (1999, jgr,</span></div>
<div class="line"><a id="l04904" name="l04904"></a><span class="lineno"> 4904</span><span class="comment">!           vol. 104, pg 19573.)  that is, first estimate the new amountof liquid</span></div>
<div class="line"><a id="l04905" name="l04905"></a><span class="lineno"> 4905</span><span class="comment">!           water, &#39;xh2o&#39;, implied by the sum of (1) the liquid water at the begin</span></div>
<div class="line"><a id="l04906" name="l04906"></a><span class="lineno"> 4906</span><span class="comment">!           of current time step, and (2) the freeze of thaw change in liquid</span></div>
<div class="line"><a id="l04907" name="l04907"></a><span class="lineno"> 4907</span><span class="comment">!           water implied by the heat flux &#39;qtot&#39; passed in from routine hrt.</span></div>
<div class="line"><a id="l04908" name="l04908"></a><span class="lineno"> 4908</span><span class="comment">!           second, determine if xh2o needs to be bounded by &#39;free&#39; (equil amt) or</span></div>
<div class="line"><a id="l04909" name="l04909"></a><span class="lineno"> 4909</span><span class="comment">!           if &#39;free&#39; needs to be bounded by xh2o.</span></div>
<div class="line"><a id="l04910" name="l04910"></a><span class="lineno"> 4910</span> </div>
<div class="line"><a id="l04911" name="l04911"></a><span class="lineno"> 4911</span>      xh2o = sh2o + qtot*dt / (dh2o*lsubf*dz)</div>
<div class="line"><a id="l04912" name="l04912"></a><span class="lineno"> 4912</span> </div>
<div class="line"><a id="l04913" name="l04913"></a><span class="lineno"> 4913</span><span class="comment">!  --- ...  first, if freezing and remaining liquid less than lower bound, then</span></div>
<div class="line"><a id="l04914" name="l04914"></a><span class="lineno"> 4914</span><span class="comment">!           reduce extent of freezing, thereby letting some or all of heat flux</span></div>
<div class="line"><a id="l04915" name="l04915"></a><span class="lineno"> 4915</span><span class="comment">!           qtot cool the soil temp later in routine hrt.</span></div>
<div class="line"><a id="l04916" name="l04916"></a><span class="lineno"> 4916</span> </div>
<div class="line"><a id="l04917" name="l04917"></a><span class="lineno"> 4917</span>      <span class="keywordflow">if</span> ( xh2o &lt; sh2o .and. xh2o &lt; free) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04918" name="l04918"></a><span class="lineno"> 4918</span>        <span class="keywordflow">if</span> ( free &gt; sh2o ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04919" name="l04919"></a><span class="lineno"> 4919</span>          xh2o = sh2o</div>
<div class="line"><a id="l04920" name="l04920"></a><span class="lineno"> 4920</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l04921" name="l04921"></a><span class="lineno"> 4921</span>          xh2o = free</div>
<div class="line"><a id="l04922" name="l04922"></a><span class="lineno"> 4922</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l04923" name="l04923"></a><span class="lineno"> 4923</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l04924" name="l04924"></a><span class="lineno"> 4924</span> </div>
<div class="line"><a id="l04925" name="l04925"></a><span class="lineno"> 4925</span><span class="comment">!  --- ...  second, if thawing and the increase in liquid water greater than</span></div>
<div class="line"><a id="l04926" name="l04926"></a><span class="lineno"> 4926</span><span class="comment">!           upper bound, then reduce extent of thaw, thereby letting some or</span></div>
<div class="line"><a id="l04927" name="l04927"></a><span class="lineno"> 4927</span><span class="comment">!           all of heat flux qtot warm the soil temp later in routine hrt.</span></div>
<div class="line"><a id="l04928" name="l04928"></a><span class="lineno"> 4928</span> </div>
<div class="line"><a id="l04929" name="l04929"></a><span class="lineno"> 4929</span>      <span class="keywordflow">if</span> ( xh2o &gt; sh2o .and. xh2o &gt; free )  <span class="keywordflow">then</span></div>
<div class="line"><a id="l04930" name="l04930"></a><span class="lineno"> 4930</span>        <span class="keywordflow">if</span> ( free &lt; sh2o ) <span class="keywordflow">then</span></div>
<div class="line"><a id="l04931" name="l04931"></a><span class="lineno"> 4931</span>          xh2o = sh2o</div>
<div class="line"><a id="l04932" name="l04932"></a><span class="lineno"> 4932</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l04933" name="l04933"></a><span class="lineno"> 4933</span>          xh2o = free</div>
<div class="line"><a id="l04934" name="l04934"></a><span class="lineno"> 4934</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l04935" name="l04935"></a><span class="lineno"> 4935</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l04936" name="l04936"></a><span class="lineno"> 4936</span> </div>
<div class="line"><a id="l04937" name="l04937"></a><span class="lineno"> 4937</span>      xh2o = max( min( xh2o, smc ), 0.0 )</div>
<div class="line"><a id="l04938" name="l04938"></a><span class="lineno"> 4938</span> </div>
<div class="line"><a id="l04939" name="l04939"></a><span class="lineno"> 4939</span><span class="comment">!  --- ...  calculate phase-change heat source/sink term for use in routine hrt</span></div>
<div class="line"><a id="l04940" name="l04940"></a><span class="lineno"> 4940</span><span class="comment">!           and update liquid water to reflcet final freeze/thaw increment.</span></div>
<div class="line"><a id="l04941" name="l04941"></a><span class="lineno"> 4941</span> </div>
<div class="line"><a id="l04942" name="l04942"></a><span class="lineno"> 4942</span>      tsrc = -dh2o * lsubf * dz * (xh2o - sh2o) / dt</div>
<div class="line"><a id="l04943" name="l04943"></a><span class="lineno"> 4943</span>      sh2o = xh2o</div>
<div class="line"><a id="l04944" name="l04944"></a><span class="lineno"> 4944</span><span class="comment">!</span></div>
<div class="line"><a id="l04945" name="l04945"></a><span class="lineno"> 4945</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l04946" name="l04946"></a><span class="lineno"> 4946</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga1b241897d00ec3d66eabe9e959d0ce04.html#ga1b241897d00ec3d66eabe9e959d0ce04">snksrc</a></div>
<div class="line"><a id="l04947" name="l04947"></a><span class="lineno"> 4947</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l04948" name="l04948"></a><span class="lineno"> 4948</span> </div>
<div class="line"><a id="l04949" name="l04949"></a><span class="lineno"> 4949</span> </div>
<div class="line"><a id="l04950" name="l04950"></a><span class="lineno"> 4950</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l04951" name="l04951"></a><span class="lineno"> 4951</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l04952" name="l04952"></a><span class="lineno"> 4952</span><span class="comment">!&gt; This subroutine calculates the right hand side of the time tendency</span></div>
<div class="line"><a id="l04953" name="l04953"></a><span class="lineno"> 4953</span><span class="comment">!! term of the soil water diffusion equation. Also to compute</span></div>
<div class="line"><a id="l04954" name="l04954"></a><span class="lineno"> 4954</span><span class="comment">!! (prepare) the matrix coefficients for the tri-diagonal matrix of</span></div>
<div class="line"><a id="l04955" name="l04955"></a><span class="lineno"> 4955</span><span class="comment">!! the implicit time scheme.</span></div>
<div class="foldopen" id="foldopen04956" data-start="" data-end="">
<div class="line"><a id="l04956" name="l04956"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gaf59c85cce3b10eaa0ffeb366de9d5304.html#gaf59c85cce3b10eaa0ffeb366de9d5304"> 4956</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gaf59c85cce3b10eaa0ffeb366de9d5304.html#gaf59c85cce3b10eaa0ffeb366de9d5304">srt</a>                                                    &amp;</div>
<div class="line"><a id="l04957" name="l04957"></a><span class="lineno"> 4957</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l04958" name="l04958"></a><span class="lineno"> 4958</span>     &amp;     ( nsoil, edir, et, sh2o, sh2oa, pcpdrp, zsoil, dwsat,        &amp;</div>
<div class="line"><a id="l04959" name="l04959"></a><span class="lineno"> 4959</span>     &amp;       dksat, smcmax, bexp, dt, smcwlt, slope, kdt, frzx, sice,   &amp;</div>
<div class="line"><a id="l04960" name="l04960"></a><span class="lineno"> 4960</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l04961" name="l04961"></a><span class="lineno"> 4961</span>     &amp;       rhstt, runoff1, runoff2, ai, bi, ci                        &amp;</div>
<div class="line"><a id="l04962" name="l04962"></a><span class="lineno"> 4962</span>     &amp;     )</div>
<div class="line"><a id="l04963" name="l04963"></a><span class="lineno"> 4963</span> </div>
<div class="line"><a id="l04964" name="l04964"></a><span class="lineno"> 4964</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l04965" name="l04965"></a><span class="lineno"> 4965</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l04966" name="l04966"></a><span class="lineno"> 4966</span><span class="comment">!    subroutine srt calculates the right hand side of the time tendency !</span></div>
<div class="line"><a id="l04967" name="l04967"></a><span class="lineno"> 4967</span><span class="comment">!    term of the soil water diffusion equation.  also to compute        !</span></div>
<div class="line"><a id="l04968" name="l04968"></a><span class="lineno"> 4968</span><span class="comment">!    ( prepare ) the matrix coefficients for the tri-diagonal matrix    !</span></div>
<div class="line"><a id="l04969" name="l04969"></a><span class="lineno"> 4969</span><span class="comment">!    of the implicit time scheme.                                       !</span></div>
<div class="line"><a id="l04970" name="l04970"></a><span class="lineno"> 4970</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04971" name="l04971"></a><span class="lineno"> 4971</span><span class="comment">!  subprogram called:  wdfcnd                                           !</span></div>
<div class="line"><a id="l04972" name="l04972"></a><span class="lineno"> 4972</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04973" name="l04973"></a><span class="lineno"> 4973</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04974" name="l04974"></a><span class="lineno"> 4974</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l04975" name="l04975"></a><span class="lineno"> 4975</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04976" name="l04976"></a><span class="lineno"> 4976</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l04977" name="l04977"></a><span class="lineno"> 4977</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l04978" name="l04978"></a><span class="lineno"> 4978</span><span class="comment">!     edir     - real, direct soil evaporation                     1    !</span></div>
<div class="line"><a id="l04979" name="l04979"></a><span class="lineno"> 4979</span><span class="comment">!     et       - real, plant transpiration                       nsoil  !</span></div>
<div class="line"><a id="l04980" name="l04980"></a><span class="lineno"> 4980</span><span class="comment">!     sh2o     - real, unfrozen soil moisture                    nsoil  !</span></div>
<div class="line"><a id="l04981" name="l04981"></a><span class="lineno"> 4981</span><span class="comment">!     sh2oa    - real,                                           nsoil  !</span></div>
<div class="line"><a id="l04982" name="l04982"></a><span class="lineno"> 4982</span><span class="comment">!     pcpdrp   - real, combined prcp and drip                      1    !</span></div>
<div class="line"><a id="l04983" name="l04983"></a><span class="lineno"> 4983</span><span class="comment">!     zsoil    - real, soil layer depth below ground             nsoil  !</span></div>
<div class="line"><a id="l04984" name="l04984"></a><span class="lineno"> 4984</span><span class="comment">!     dwsat    - real, saturated soil diffusivity                  1    !</span></div>
<div class="line"><a id="l04985" name="l04985"></a><span class="lineno"> 4985</span><span class="comment">!     dksat    - real, saturated soil hydraulic conductivity       1    !</span></div>
<div class="line"><a id="l04986" name="l04986"></a><span class="lineno"> 4986</span><span class="comment">!     smcmax   - real, porosity                                    1    !</span></div>
<div class="line"><a id="l04987" name="l04987"></a><span class="lineno"> 4987</span><span class="comment">!     bexp     - real, soil type &quot;b&quot; parameter                     1    !</span></div>
<div class="line"><a id="l04988" name="l04988"></a><span class="lineno"> 4988</span><span class="comment">!     dt       - real, time step                                   1    !</span></div>
<div class="line"><a id="l04989" name="l04989"></a><span class="lineno"> 4989</span><span class="comment">!     smcwlt   - real, wilting point                               1    !</span></div>
<div class="line"><a id="l04990" name="l04990"></a><span class="lineno"> 4990</span><span class="comment">!     slope    - real, linear reservoir coefficient                1    !</span></div>
<div class="line"><a id="l04991" name="l04991"></a><span class="lineno"> 4991</span><span class="comment">!     kdt      - real,                                             1    !</span></div>
<div class="line"><a id="l04992" name="l04992"></a><span class="lineno"> 4992</span><span class="comment">!     frzx     - real, frozen ground parameter                     1    !</span></div>
<div class="line"><a id="l04993" name="l04993"></a><span class="lineno"> 4993</span><span class="comment">!     sice     - real, ice content at each soil layer            nsoil  !</span></div>
<div class="line"><a id="l04994" name="l04994"></a><span class="lineno"> 4994</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l04995" name="l04995"></a><span class="lineno"> 4995</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l04996" name="l04996"></a><span class="lineno"> 4996</span><span class="comment">!     rhstt    - real, soil water time tendency                  nsoil  !</span></div>
<div class="line"><a id="l04997" name="l04997"></a><span class="lineno"> 4997</span><span class="comment">!     runoff1  - real, surface runoff not infiltrating sfc         1    !</span></div>
<div class="line"><a id="l04998" name="l04998"></a><span class="lineno"> 4998</span><span class="comment">!     runoff2  - real, sub surface runoff (baseflow)               1    !</span></div>
<div class="line"><a id="l04999" name="l04999"></a><span class="lineno"> 4999</span><span class="comment">!     ai       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l05000" name="l05000"></a><span class="lineno"> 5000</span><span class="comment">!     bi       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l05001" name="l05001"></a><span class="lineno"> 5001</span><span class="comment">!     ci       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l05002" name="l05002"></a><span class="lineno"> 5002</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05003" name="l05003"></a><span class="lineno"> 5003</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l05004" name="l05004"></a><span class="lineno"> 5004</span><span class="comment">!</span></div>
<div class="line"><a id="l05005" name="l05005"></a><span class="lineno"> 5005</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l05006" name="l05006"></a><span class="lineno"> 5006</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil</div>
<div class="line"><a id="l05007" name="l05007"></a><span class="lineno"> 5007</span> </div>
<div class="line"><a id="l05008" name="l05008"></a><span class="lineno"> 5008</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">dimension(nsoil)</span>, <span class="keywordtype">intent(in)</span> :: et,        &amp;</div>
<div class="line"><a id="l05009" name="l05009"></a><span class="lineno"> 5009</span>     &amp;       sh2o, sh2oa, zsoil, sice</div>
<div class="line"><a id="l05010" name="l05010"></a><span class="lineno"> 5010</span> </div>
<div class="line"><a id="l05011" name="l05011"></a><span class="lineno"> 5011</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: edir, pcpdrp, dwsat, dksat,  &amp;</div>
<div class="line"><a id="l05012" name="l05012"></a><span class="lineno"> 5012</span>     &amp;       smcmax, smcwlt, bexp, dt, slope, kdt, frzx</div>
<div class="line"><a id="l05013" name="l05013"></a><span class="lineno"> 5013</span> </div>
<div class="line"><a id="l05014" name="l05014"></a><span class="lineno"> 5014</span><span class="comment">!  --- outputs:</span></div>
<div class="line"><a id="l05015" name="l05015"></a><span class="lineno"> 5015</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: runoff1, runoff2,           &amp;</div>
<div class="line"><a id="l05016" name="l05016"></a><span class="lineno"> 5016</span>     &amp;      rhstt(nsoil), ai(nsold), bi(nsold), ci(nsold)</div>
<div class="line"><a id="l05017" name="l05017"></a><span class="lineno"> 5017</span> </div>
<div class="line"><a id="l05018" name="l05018"></a><span class="lineno"> 5018</span> </div>
<div class="line"><a id="l05019" name="l05019"></a><span class="lineno"> 5019</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l05020" name="l05020"></a><span class="lineno"> 5020</span><span class="keywordtype">      real</span> (kind=kind_phys) :: acrt, dd, ddt, ddz, ddz2, denom, denom2, &amp;</div>
<div class="line"><a id="l05021" name="l05021"></a><span class="lineno"> 5021</span>     &amp;       dice, dsmdz, dsmdz2, dt1, fcr, infmax, mxsmc, mxsmc2, px,  &amp;</div>
<div class="line"><a id="l05022" name="l05022"></a><span class="lineno"> 5022</span>     &amp;       numer, pddum, sicemax, slopx, smcav, sstt, sum, val, wcnd, &amp;</div>
<div class="line"><a id="l05023" name="l05023"></a><span class="lineno"> 5023</span>     &amp;       wcnd2, wdf, wdf2, dmax(nsold)</div>
<div class="line"><a id="l05024" name="l05024"></a><span class="lineno"> 5024</span> </div>
<div class="line"><a id="l05025" name="l05025"></a><span class="lineno"> 5025</span>      <span class="keywordtype">integer</span> :: cvfrz, ialp1, iohinf, j, jj, k, ks</div>
<div class="line"><a id="l05026" name="l05026"></a><span class="lineno"> 5026</span><span class="comment">!</span></div>
<div class="line"><a id="l05027" name="l05027"></a><span class="lineno"> 5027</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l05028" name="l05028"></a><span class="lineno"> 5028</span><span class="comment">!</span></div>
<div class="line"><a id="l05029" name="l05029"></a><span class="lineno"> 5029</span><span class="comment">!  --- ...  frozen ground version:</span></div>
<div class="line"><a id="l05030" name="l05030"></a><span class="lineno"> 5030</span><span class="comment">!           reference frozen ground parameter, cvfrz, is a shape parameter</span></div>
<div class="line"><a id="l05031" name="l05031"></a><span class="lineno"> 5031</span><span class="comment">!           of areal distribution function of soil ice content which equals</span></div>
<div class="line"><a id="l05032" name="l05032"></a><span class="lineno"> 5032</span><span class="comment">!           1/cv. cv is a coefficient of spatial variation of soil ice content.</span></div>
<div class="line"><a id="l05033" name="l05033"></a><span class="lineno"> 5033</span><span class="comment">!           based on field data cv depends on areal mean of frozen depth, and</span></div>
<div class="line"><a id="l05034" name="l05034"></a><span class="lineno"> 5034</span><span class="comment">!           it close to constant = 0.6 if areal mean frozen depth is above 20 cm.</span></div>
<div class="line"><a id="l05035" name="l05035"></a><span class="lineno"> 5035</span><span class="comment">!           that is why parameter cvfrz = 3 (int{1/0.6*0.6}). current logic</span></div>
<div class="line"><a id="l05036" name="l05036"></a><span class="lineno"> 5036</span><span class="comment">!           doesn&#39;t allow cvfrz be bigger than 3</span></div>
<div class="line"><a id="l05037" name="l05037"></a><span class="lineno"> 5037</span> </div>
<div class="line"><a id="l05038" name="l05038"></a><span class="lineno"> 5038</span>        parameter(cvfrz = 3)</div>
<div class="line"><a id="l05039" name="l05039"></a><span class="lineno"> 5039</span> </div>
<div class="line"><a id="l05040" name="l05040"></a><span class="lineno"> 5040</span>c ----------------------------------------------------------------------</div>
<div class="line"><a id="l05041" name="l05041"></a><span class="lineno"> 5041</span><span class="comment">!  --- ...  determine rainfall infiltration rate and runoff.  include</span></div>
<div class="line"><a id="l05042" name="l05042"></a><span class="lineno"> 5042</span><span class="comment">!           the infiltration formule from schaake and koren model.</span></div>
<div class="line"><a id="l05043" name="l05043"></a><span class="lineno"> 5043</span><span class="comment">!           modified by q duan</span></div>
<div class="line"><a id="l05044" name="l05044"></a><span class="lineno"> 5044</span> </div>
<div class="line"><a id="l05045" name="l05045"></a><span class="lineno"> 5045</span>      iohinf = 1</div>
<div class="line"><a id="l05046" name="l05046"></a><span class="lineno"> 5046</span> </div>
<div class="line"><a id="l05047" name="l05047"></a><span class="lineno"> 5047</span><span class="comment">!  --- ... let sicemax be the greatest, if any, frozen water content within</span></div>
<div class="line"><a id="l05048" name="l05048"></a><span class="lineno"> 5048</span><span class="comment">!          soil layers.</span></div>
<div class="line"><a id="l05049" name="l05049"></a><span class="lineno"> 5049</span> </div>
<div class="line"><a id="l05050" name="l05050"></a><span class="lineno"> 5050</span>      sicemax = 0.0</div>
<div class="line"><a id="l05051" name="l05051"></a><span class="lineno"> 5051</span>      <span class="keywordflow">do</span> ks = 1, nsoil</div>
<div class="line"><a id="l05052" name="l05052"></a><span class="lineno"> 5052</span>       <span class="keywordflow">if</span> (sice(ks) &gt; sicemax) sicemax = sice(ks)</div>
<div class="line"><a id="l05053" name="l05053"></a><span class="lineno"> 5053</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l05054" name="l05054"></a><span class="lineno"> 5054</span> </div>
<div class="line"><a id="l05055" name="l05055"></a><span class="lineno"> 5055</span><span class="comment">!  --- ...  determine rainfall infiltration rate and runoff</span></div>
<div class="line"><a id="l05056" name="l05056"></a><span class="lineno"> 5056</span> </div>
<div class="line"><a id="l05057" name="l05057"></a><span class="lineno"> 5057</span>      pddum = pcpdrp</div>
<div class="line"><a id="l05058" name="l05058"></a><span class="lineno"> 5058</span>      runoff1 = 0.0</div>
<div class="line"><a id="l05059" name="l05059"></a><span class="lineno"> 5059</span> </div>
<div class="line"><a id="l05060" name="l05060"></a><span class="lineno"> 5060</span>      <span class="keywordflow">if</span> (pcpdrp /= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05061" name="l05061"></a><span class="lineno"> 5061</span> </div>
<div class="line"><a id="l05062" name="l05062"></a><span class="lineno"> 5062</span><span class="comment">!  --- ...  modified by q. duan, 5/16/94</span></div>
<div class="line"><a id="l05063" name="l05063"></a><span class="lineno"> 5063</span> </div>
<div class="line"><a id="l05064" name="l05064"></a><span class="lineno"> 5064</span>        dt1 = dt/86400.</div>
<div class="line"><a id="l05065" name="l05065"></a><span class="lineno"> 5065</span>        smcav = smcmax - smcwlt</div>
<div class="line"><a id="l05066" name="l05066"></a><span class="lineno"> 5066</span>        dmax(1) = -zsoil(1) * smcav</div>
<div class="line"><a id="l05067" name="l05067"></a><span class="lineno"> 5067</span> </div>
<div class="line"><a id="l05068" name="l05068"></a><span class="lineno"> 5068</span><span class="comment">!  --- ...  frozen ground version:</span></div>
<div class="line"><a id="l05069" name="l05069"></a><span class="lineno"> 5069</span> </div>
<div class="line"><a id="l05070" name="l05070"></a><span class="lineno"> 5070</span>        dice = -zsoil(1) * sice(1)</div>
<div class="line"><a id="l05071" name="l05071"></a><span class="lineno"> 5071</span> </div>
<div class="line"><a id="l05072" name="l05072"></a><span class="lineno"> 5072</span>        dmax(1) = dmax(1)*(1.0 - (sh2oa(1)+sice(1)-smcwlt)/smcav)</div>
<div class="line"><a id="l05073" name="l05073"></a><span class="lineno"> 5073</span>        dd = dmax(1)</div>
<div class="line"><a id="l05074" name="l05074"></a><span class="lineno"> 5074</span> </div>
<div class="line"><a id="l05075" name="l05075"></a><span class="lineno"> 5075</span>        <span class="keywordflow">do</span> ks = 2, nsoil</div>
<div class="line"><a id="l05076" name="l05076"></a><span class="lineno"> 5076</span> </div>
<div class="line"><a id="l05077" name="l05077"></a><span class="lineno"> 5077</span><span class="comment">!  --- ...  frozen ground version:</span></div>
<div class="line"><a id="l05078" name="l05078"></a><span class="lineno"> 5078</span> </div>
<div class="line"><a id="l05079" name="l05079"></a><span class="lineno"> 5079</span>          dice = dice + ( zsoil(ks-1) - zsoil(ks) ) * sice(ks)</div>
<div class="line"><a id="l05080" name="l05080"></a><span class="lineno"> 5080</span> </div>
<div class="line"><a id="l05081" name="l05081"></a><span class="lineno"> 5081</span>          dmax(ks) = (zsoil(ks-1)-zsoil(ks))*smcav</div>
<div class="line"><a id="l05082" name="l05082"></a><span class="lineno"> 5082</span>          dmax(ks) = dmax(ks)*(1.0 - (sh2oa(ks)+sice(ks)-smcwlt)/smcav)</div>
<div class="line"><a id="l05083" name="l05083"></a><span class="lineno"> 5083</span>          dd = dd + dmax(ks)</div>
<div class="line"><a id="l05084" name="l05084"></a><span class="lineno"> 5084</span><span class="keywordflow">        enddo</span></div>
<div class="line"><a id="l05085" name="l05085"></a><span class="lineno"> 5085</span> </div>
<div class="line"><a id="l05086" name="l05086"></a><span class="lineno"> 5086</span><span class="comment">!  --- ...  val = (1.-exp(-kdt*sqrt(dt1)))</span></div>
<div class="line"><a id="l05087" name="l05087"></a><span class="lineno"> 5087</span><span class="comment">!           in below, remove the sqrt in above</span></div>
<div class="line"><a id="l05088" name="l05088"></a><span class="lineno"> 5088</span> </div>
<div class="line"><a id="l05089" name="l05089"></a><span class="lineno"> 5089</span>        val = 1.0 - exp(-kdt*dt1)</div>
<div class="line"><a id="l05090" name="l05090"></a><span class="lineno"> 5090</span>        ddt = dd * val</div>
<div class="line"><a id="l05091" name="l05091"></a><span class="lineno"> 5091</span> </div>
<div class="line"><a id="l05092" name="l05092"></a><span class="lineno"> 5092</span>        px = pcpdrp * dt</div>
<div class="line"><a id="l05093" name="l05093"></a><span class="lineno"> 5093</span>        <span class="keywordflow">if</span> (px &lt; 0.0) px = 0.0</div>
<div class="line"><a id="l05094" name="l05094"></a><span class="lineno"> 5094</span> </div>
<div class="line"><a id="l05095" name="l05095"></a><span class="lineno"> 5095</span>        infmax = (px*(ddt/(px+ddt)))/dt</div>
<div class="line"><a id="l05096" name="l05096"></a><span class="lineno"> 5096</span> </div>
<div class="line"><a id="l05097" name="l05097"></a><span class="lineno"> 5097</span><span class="comment">!  --- ...  frozen ground version:</span></div>
<div class="line"><a id="l05098" name="l05098"></a><span class="lineno"> 5098</span><span class="comment">!           reduction of infiltration based on frozen ground parameters</span></div>
<div class="line"><a id="l05099" name="l05099"></a><span class="lineno"> 5099</span> </div>
<div class="line"><a id="l05100" name="l05100"></a><span class="lineno"> 5100</span>        fcr = 1.</div>
<div class="line"><a id="l05101" name="l05101"></a><span class="lineno"> 5101</span> </div>
<div class="line"><a id="l05102" name="l05102"></a><span class="lineno"> 5102</span>        <span class="keywordflow">if</span> (dice &gt; 1.e-2) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05103" name="l05103"></a><span class="lineno"> 5103</span>          acrt = cvfrz * frzx / dice</div>
<div class="line"><a id="l05104" name="l05104"></a><span class="lineno"> 5104</span>          sum = 1.</div>
<div class="line"><a id="l05105" name="l05105"></a><span class="lineno"> 5105</span> </div>
<div class="line"><a id="l05106" name="l05106"></a><span class="lineno"> 5106</span>          ialp1 = cvfrz - 1</div>
<div class="line"><a id="l05107" name="l05107"></a><span class="lineno"> 5107</span>          <span class="keywordflow">do</span> j = 1, ialp1</div>
<div class="line"><a id="l05108" name="l05108"></a><span class="lineno"> 5108</span>            k = 1</div>
<div class="line"><a id="l05109" name="l05109"></a><span class="lineno"> 5109</span> </div>
<div class="line"><a id="l05110" name="l05110"></a><span class="lineno"> 5110</span>            <span class="keywordflow">do</span> jj = j+1,ialp1</div>
<div class="line"><a id="l05111" name="l05111"></a><span class="lineno"> 5111</span>              k = k * jj</div>
<div class="line"><a id="l05112" name="l05112"></a><span class="lineno"> 5112</span><span class="keywordflow">            enddo</span></div>
<div class="line"><a id="l05113" name="l05113"></a><span class="lineno"> 5113</span> </div>
<div class="line"><a id="l05114" name="l05114"></a><span class="lineno"> 5114</span>            sum = sum + (acrt**( cvfrz-j)) / float(k)</div>
<div class="line"><a id="l05115" name="l05115"></a><span class="lineno"> 5115</span><span class="keywordflow">          enddo</span></div>
<div class="line"><a id="l05116" name="l05116"></a><span class="lineno"> 5116</span> </div>
<div class="line"><a id="l05117" name="l05117"></a><span class="lineno"> 5117</span>          fcr = 1.0 - exp(-acrt) * sum</div>
<div class="line"><a id="l05118" name="l05118"></a><span class="lineno"> 5118</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l05119" name="l05119"></a><span class="lineno"> 5119</span> </div>
<div class="line"><a id="l05120" name="l05120"></a><span class="lineno"> 5120</span>        infmax = infmax * fcr</div>
<div class="line"><a id="l05121" name="l05121"></a><span class="lineno"> 5121</span> </div>
<div class="line"><a id="l05122" name="l05122"></a><span class="lineno"> 5122</span><span class="comment">!  --- ...  correction of infiltration limitation:</span></div>
<div class="line"><a id="l05123" name="l05123"></a><span class="lineno"> 5123</span><span class="comment">!           if infmax .le. hydrolic conductivity assign infmax the value</span></div>
<div class="line"><a id="l05124" name="l05124"></a><span class="lineno"> 5124</span><span class="comment">!           of hydrolic conductivity</span></div>
<div class="line"><a id="l05125" name="l05125"></a><span class="lineno"> 5125</span> </div>
<div class="line"><a id="l05126" name="l05126"></a><span class="lineno"> 5126</span><span class="comment">!       mxsmc = max ( sh2oa(1), sh2oa(2) )</span></div>
<div class="line"><a id="l05127" name="l05127"></a><span class="lineno"> 5127</span>        mxsmc = sh2oa(1)</div>
<div class="line"><a id="l05128" name="l05128"></a><span class="lineno"> 5128</span> </div>
<div class="line"><a id="l05129" name="l05129"></a><span class="lineno"> 5129</span>        <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gabfc5ae94c847aa3351345e0e924302a1.html#gabfc5ae94c847aa3351345e0e924302a1">wdfcnd</a>                                                     &amp;</div>
<div class="line"><a id="l05130" name="l05130"></a><span class="lineno"> 5130</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l05131" name="l05131"></a><span class="lineno"> 5131</span>     &amp;     ( mxsmc, smcmax, bexp, dksat, dwsat, sicemax,                &amp;</div>
<div class="line"><a id="l05132" name="l05132"></a><span class="lineno"> 5132</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l05133" name="l05133"></a><span class="lineno"> 5133</span>     &amp;       wdf, wcnd                                                  &amp;</div>
<div class="line"><a id="l05134" name="l05134"></a><span class="lineno"> 5134</span>     &amp;     )</div>
<div class="line"><a id="l05135" name="l05135"></a><span class="lineno"> 5135</span> </div>
<div class="line"><a id="l05136" name="l05136"></a><span class="lineno"> 5136</span>        infmax = max( infmax, wcnd )</div>
<div class="line"><a id="l05137" name="l05137"></a><span class="lineno"> 5137</span>        infmax = min( infmax, px )</div>
<div class="line"><a id="l05138" name="l05138"></a><span class="lineno"> 5138</span> </div>
<div class="line"><a id="l05139" name="l05139"></a><span class="lineno"> 5139</span>        <span class="keywordflow">if</span> (pcpdrp &gt; infmax) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05140" name="l05140"></a><span class="lineno"> 5140</span>          runoff1 = pcpdrp - infmax</div>
<div class="line"><a id="l05141" name="l05141"></a><span class="lineno"> 5141</span>          pddum   = infmax</div>
<div class="line"><a id="l05142" name="l05142"></a><span class="lineno"> 5142</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l05143" name="l05143"></a><span class="lineno"> 5143</span> </div>
<div class="line"><a id="l05144" name="l05144"></a><span class="lineno"> 5144</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_pcpdrp_block</span></div>
<div class="line"><a id="l05145" name="l05145"></a><span class="lineno"> 5145</span> </div>
<div class="line"><a id="l05146" name="l05146"></a><span class="lineno"> 5146</span><span class="comment">!  --- ... to avoid spurious drainage behavior, &#39;upstream differencing&#39;</span></div>
<div class="line"><a id="l05147" name="l05147"></a><span class="lineno"> 5147</span><span class="comment">!          in line below replaced with new approach in 2nd line:</span></div>
<div class="line"><a id="l05148" name="l05148"></a><span class="lineno"> 5148</span><span class="comment">!          &#39;mxsmc = max(sh2oa(1), sh2oa(2))&#39;</span></div>
<div class="line"><a id="l05149" name="l05149"></a><span class="lineno"> 5149</span> </div>
<div class="line"><a id="l05150" name="l05150"></a><span class="lineno"> 5150</span>      mxsmc = sh2oa(1)</div>
<div class="line"><a id="l05151" name="l05151"></a><span class="lineno"> 5151</span> </div>
<div class="line"><a id="l05152" name="l05152"></a><span class="lineno"> 5152</span>      <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gabfc5ae94c847aa3351345e0e924302a1.html#gabfc5ae94c847aa3351345e0e924302a1">wdfcnd</a>                                                       &amp;</div>
<div class="line"><a id="l05153" name="l05153"></a><span class="lineno"> 5153</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l05154" name="l05154"></a><span class="lineno"> 5154</span>     &amp;     ( mxsmc, smcmax, bexp, dksat, dwsat, sicemax,                &amp;</div>
<div class="line"><a id="l05155" name="l05155"></a><span class="lineno"> 5155</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l05156" name="l05156"></a><span class="lineno"> 5156</span>     &amp;       wdf, wcnd                                                  &amp;</div>
<div class="line"><a id="l05157" name="l05157"></a><span class="lineno"> 5157</span>     &amp;     )</div>
<div class="line"><a id="l05158" name="l05158"></a><span class="lineno"> 5158</span> </div>
<div class="line"><a id="l05159" name="l05159"></a><span class="lineno"> 5159</span><span class="comment">!  --- ...  calc the matrix coefficients ai, bi, and ci for the top layer</span></div>
<div class="line"><a id="l05160" name="l05160"></a><span class="lineno"> 5160</span> </div>
<div class="line"><a id="l05161" name="l05161"></a><span class="lineno"> 5161</span>      ddz = 1.0 / ( -.5*zsoil(2) )</div>
<div class="line"><a id="l05162" name="l05162"></a><span class="lineno"> 5162</span>      ai(1) = 0.0</div>
<div class="line"><a id="l05163" name="l05163"></a><span class="lineno"> 5163</span>      bi(1) = wdf * ddz / ( -zsoil(1) )</div>
<div class="line"><a id="l05164" name="l05164"></a><span class="lineno"> 5164</span>      ci(1) = -bi(1)</div>
<div class="line"><a id="l05165" name="l05165"></a><span class="lineno"> 5165</span> </div>
<div class="line"><a id="l05166" name="l05166"></a><span class="lineno"> 5166</span><span class="comment">!  --- ...  calc rhstt for the top layer after calc&#39;ng the vertical soil</span></div>
<div class="line"><a id="l05167" name="l05167"></a><span class="lineno"> 5167</span><span class="comment">!           moisture gradient btwn the top and next to top layers.</span></div>
<div class="line"><a id="l05168" name="l05168"></a><span class="lineno"> 5168</span> </div>
<div class="line"><a id="l05169" name="l05169"></a><span class="lineno"> 5169</span>      dsmdz = ( sh2o(1) - sh2o(2) ) / ( -.5*zsoil(2) )</div>
<div class="line"><a id="l05170" name="l05170"></a><span class="lineno"> 5170</span>      rhstt(1) = (wdf*dsmdz + wcnd - pddum + edir + et(1)) / zsoil(1)</div>
<div class="line"><a id="l05171" name="l05171"></a><span class="lineno"> 5171</span>      sstt = wdf * dsmdz + wcnd + edir + et(1)</div>
<div class="line"><a id="l05172" name="l05172"></a><span class="lineno"> 5172</span> </div>
<div class="line"><a id="l05173" name="l05173"></a><span class="lineno"> 5173</span><span class="comment">!  --- ...  initialize ddz2</span></div>
<div class="line"><a id="l05174" name="l05174"></a><span class="lineno"> 5174</span> </div>
<div class="line"><a id="l05175" name="l05175"></a><span class="lineno"> 5175</span>      ddz2 = 0.0</div>
<div class="line"><a id="l05176" name="l05176"></a><span class="lineno"> 5176</span> </div>
<div class="line"><a id="l05177" name="l05177"></a><span class="lineno"> 5177</span><span class="comment">!  --- ...  loop thru the remaining soil layers, repeating the abv process</span></div>
<div class="line"><a id="l05178" name="l05178"></a><span class="lineno"> 5178</span> </div>
<div class="line"><a id="l05179" name="l05179"></a><span class="lineno"> 5179</span>      <span class="keywordflow">do</span> k = 2, nsoil</div>
<div class="line"><a id="l05180" name="l05180"></a><span class="lineno"> 5180</span>        denom2 = (zsoil(k-1) - zsoil(k))</div>
<div class="line"><a id="l05181" name="l05181"></a><span class="lineno"> 5181</span> </div>
<div class="line"><a id="l05182" name="l05182"></a><span class="lineno"> 5182</span>        <span class="keywordflow">if</span> (k /= nsoil) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05183" name="l05183"></a><span class="lineno"> 5183</span>          slopx = 1.0</div>
<div class="line"><a id="l05184" name="l05184"></a><span class="lineno"> 5184</span> </div>
<div class="line"><a id="l05185" name="l05185"></a><span class="lineno"> 5185</span><span class="comment">!  --- ...  again, to avoid spurious drainage behavior, &#39;upstream differencing&#39;</span></div>
<div class="line"><a id="l05186" name="l05186"></a><span class="lineno"> 5186</span><span class="comment">!           in line below replaced with new approach in 2nd line:</span></div>
<div class="line"><a id="l05187" name="l05187"></a><span class="lineno"> 5187</span><span class="comment">!           &#39;mxsmc2 = max (sh2oa(k), sh2oa(k+1))&#39;</span></div>
<div class="line"><a id="l05188" name="l05188"></a><span class="lineno"> 5188</span> </div>
<div class="line"><a id="l05189" name="l05189"></a><span class="lineno"> 5189</span>          mxsmc2 = sh2oa(k)</div>
<div class="line"><a id="l05190" name="l05190"></a><span class="lineno"> 5190</span> </div>
<div class="line"><a id="l05191" name="l05191"></a><span class="lineno"> 5191</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gabfc5ae94c847aa3351345e0e924302a1.html#gabfc5ae94c847aa3351345e0e924302a1">wdfcnd</a>                                                   &amp;</div>
<div class="line"><a id="l05192" name="l05192"></a><span class="lineno"> 5192</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l05193" name="l05193"></a><span class="lineno"> 5193</span>     &amp;     ( mxsmc2, smcmax, bexp, dksat, dwsat, sicemax,               &amp;</div>
<div class="line"><a id="l05194" name="l05194"></a><span class="lineno"> 5194</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l05195" name="l05195"></a><span class="lineno"> 5195</span>     &amp;       wdf2, wcnd2                                                &amp;</div>
<div class="line"><a id="l05196" name="l05196"></a><span class="lineno"> 5196</span>     &amp;     )</div>
<div class="line"><a id="l05197" name="l05197"></a><span class="lineno"> 5197</span> </div>
<div class="line"><a id="l05198" name="l05198"></a><span class="lineno"> 5198</span><span class="comment">!  --- ...  calc some partial products for later use in calc&#39;ng rhstt</span></div>
<div class="line"><a id="l05199" name="l05199"></a><span class="lineno"> 5199</span> </div>
<div class="line"><a id="l05200" name="l05200"></a><span class="lineno"> 5200</span>          denom = (zsoil(k-1) - zsoil(k+1))</div>
<div class="line"><a id="l05201" name="l05201"></a><span class="lineno"> 5201</span>          dsmdz2 = (sh2o(k) - sh2o(k+1)) / (denom * 0.5)</div>
<div class="line"><a id="l05202" name="l05202"></a><span class="lineno"> 5202</span> </div>
<div class="line"><a id="l05203" name="l05203"></a><span class="lineno"> 5203</span><span class="comment">!  --- ...  calc the matrix coef, ci, after calc&#39;ng its partial product</span></div>
<div class="line"><a id="l05204" name="l05204"></a><span class="lineno"> 5204</span> </div>
<div class="line"><a id="l05205" name="l05205"></a><span class="lineno"> 5205</span>          ddz2 = 2.0 / denom</div>
<div class="line"><a id="l05206" name="l05206"></a><span class="lineno"> 5206</span>          ci(k) = -wdf2 * ddz2 / denom2</div>
<div class="line"><a id="l05207" name="l05207"></a><span class="lineno"> 5207</span> </div>
<div class="line"><a id="l05208" name="l05208"></a><span class="lineno"> 5208</span>        <span class="keywordflow">else</span>   <span class="comment">! if_k_block</span></div>
<div class="line"><a id="l05209" name="l05209"></a><span class="lineno"> 5209</span> </div>
<div class="line"><a id="l05210" name="l05210"></a><span class="lineno"> 5210</span><span class="comment">!  --- ...  slope of bottom layer is introduced</span></div>
<div class="line"><a id="l05211" name="l05211"></a><span class="lineno"> 5211</span> </div>
<div class="line"><a id="l05212" name="l05212"></a><span class="lineno"> 5212</span>          slopx = slope</div>
<div class="line"><a id="l05213" name="l05213"></a><span class="lineno"> 5213</span> </div>
<div class="line"><a id="l05214" name="l05214"></a><span class="lineno"> 5214</span><span class="comment">!  --- ...  retrieve the soil water diffusivity and hydraulic conductivity</span></div>
<div class="line"><a id="l05215" name="l05215"></a><span class="lineno"> 5215</span><span class="comment">!           for this layer</span></div>
<div class="line"><a id="l05216" name="l05216"></a><span class="lineno"> 5216</span> </div>
<div class="line"><a id="l05217" name="l05217"></a><span class="lineno"> 5217</span>          <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_gabfc5ae94c847aa3351345e0e924302a1.html#gabfc5ae94c847aa3351345e0e924302a1">wdfcnd</a>                                                   &amp;</div>
<div class="line"><a id="l05218" name="l05218"></a><span class="lineno"> 5218</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l05219" name="l05219"></a><span class="lineno"> 5219</span>     &amp;     ( sh2oa(nsoil), smcmax, bexp, dksat, dwsat, sicemax,         &amp;</div>
<div class="line"><a id="l05220" name="l05220"></a><span class="lineno"> 5220</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l05221" name="l05221"></a><span class="lineno"> 5221</span>     &amp;       wdf2, wcnd2                                                &amp;</div>
<div class="line"><a id="l05222" name="l05222"></a><span class="lineno"> 5222</span>     &amp;     )</div>
<div class="line"><a id="l05223" name="l05223"></a><span class="lineno"> 5223</span> </div>
<div class="line"><a id="l05224" name="l05224"></a><span class="lineno"> 5224</span><span class="comment">!  --- ...  calc a partial product for later use in calc&#39;ng rhstt</span></div>
<div class="line"><a id="l05225" name="l05225"></a><span class="lineno"> 5225</span>          dsmdz2 = 0.0</div>
<div class="line"><a id="l05226" name="l05226"></a><span class="lineno"> 5226</span> </div>
<div class="line"><a id="l05227" name="l05227"></a><span class="lineno"> 5227</span><span class="comment">!  --- ...  set matrix coef ci to zero</span></div>
<div class="line"><a id="l05228" name="l05228"></a><span class="lineno"> 5228</span> </div>
<div class="line"><a id="l05229" name="l05229"></a><span class="lineno"> 5229</span>          ci(k) = 0.0</div>
<div class="line"><a id="l05230" name="l05230"></a><span class="lineno"> 5230</span> </div>
<div class="line"><a id="l05231" name="l05231"></a><span class="lineno"> 5231</span><span class="keywordflow">        endif</span>   <span class="comment">! end if_k_block</span></div>
<div class="line"><a id="l05232" name="l05232"></a><span class="lineno"> 5232</span> </div>
<div class="line"><a id="l05233" name="l05233"></a><span class="lineno"> 5233</span><span class="comment">!  --- ...  calc rhstt for this layer after calc&#39;ng its numerator</span></div>
<div class="line"><a id="l05234" name="l05234"></a><span class="lineno"> 5234</span> </div>
<div class="line"><a id="l05235" name="l05235"></a><span class="lineno"> 5235</span>        numer = wdf2*dsmdz2 + slopx*wcnd2 - wdf*dsmdz - wcnd + et(k)</div>
<div class="line"><a id="l05236" name="l05236"></a><span class="lineno"> 5236</span>        rhstt(k) = numer / (-denom2)</div>
<div class="line"><a id="l05237" name="l05237"></a><span class="lineno"> 5237</span> </div>
<div class="line"><a id="l05238" name="l05238"></a><span class="lineno"> 5238</span><span class="comment">!  --- ...  calc matrix coefs, ai, and bi for this layer</span></div>
<div class="line"><a id="l05239" name="l05239"></a><span class="lineno"> 5239</span> </div>
<div class="line"><a id="l05240" name="l05240"></a><span class="lineno"> 5240</span>        ai(k) = -wdf * ddz / denom2</div>
<div class="line"><a id="l05241" name="l05241"></a><span class="lineno"> 5241</span>        bi(k) = -( ai(k) + ci(k) )</div>
<div class="line"><a id="l05242" name="l05242"></a><span class="lineno"> 5242</span> </div>
<div class="line"><a id="l05243" name="l05243"></a><span class="lineno"> 5243</span><span class="comment">!  --- ...  reset values of wdf, wcnd, dsmdz, and ddz for loop to next lyr</span></div>
<div class="line"><a id="l05244" name="l05244"></a><span class="lineno"> 5244</span><span class="comment">!      runoff2:  sub-surface or baseflow runoff</span></div>
<div class="line"><a id="l05245" name="l05245"></a><span class="lineno"> 5245</span> </div>
<div class="line"><a id="l05246" name="l05246"></a><span class="lineno"> 5246</span>        <span class="keywordflow">if</span> (k == nsoil) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05247" name="l05247"></a><span class="lineno"> 5247</span>          runoff2 = slopx * wcnd2</div>
<div class="line"><a id="l05248" name="l05248"></a><span class="lineno"> 5248</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l05249" name="l05249"></a><span class="lineno"> 5249</span> </div>
<div class="line"><a id="l05250" name="l05250"></a><span class="lineno"> 5250</span>        <span class="keywordflow">if</span> (k /= nsoil) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05251" name="l05251"></a><span class="lineno"> 5251</span>          wdf  = wdf2</div>
<div class="line"><a id="l05252" name="l05252"></a><span class="lineno"> 5252</span>          wcnd = wcnd2</div>
<div class="line"><a id="l05253" name="l05253"></a><span class="lineno"> 5253</span>          dsmdz= dsmdz2</div>
<div class="line"><a id="l05254" name="l05254"></a><span class="lineno"> 5254</span>          ddz  = ddz2</div>
<div class="line"><a id="l05255" name="l05255"></a><span class="lineno"> 5255</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l05256" name="l05256"></a><span class="lineno"> 5256</span><span class="keywordflow">      enddo</span>   <span class="comment">! end do_k_loop</span></div>
<div class="line"><a id="l05257" name="l05257"></a><span class="lineno"> 5257</span><span class="comment">!</span></div>
<div class="line"><a id="l05258" name="l05258"></a><span class="lineno"> 5258</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l05259" name="l05259"></a><span class="lineno"> 5259</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gaf59c85cce3b10eaa0ffeb366de9d5304.html#gaf59c85cce3b10eaa0ffeb366de9d5304">srt</a></div>
<div class="line"><a id="l05260" name="l05260"></a><span class="lineno"> 5260</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l05261" name="l05261"></a><span class="lineno"> 5261</span> </div>
<div class="line"><a id="l05262" name="l05262"></a><span class="lineno"> 5262</span> </div>
<div class="line"><a id="l05263" name="l05263"></a><span class="lineno"> 5263</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l05264" name="l05264"></a><span class="lineno"> 5264</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l05265" name="l05265"></a><span class="lineno"> 5265</span><span class="comment">!&gt; This subroutine calculates/updates soil moisture content values and</span></div>
<div class="line"><a id="l05266" name="l05266"></a><span class="lineno"> 5266</span><span class="comment">!! canopy moisture content values.</span></div>
<div class="foldopen" id="foldopen05267" data-start="" data-end="">
<div class="line"><a id="l05267" name="l05267"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga22b00b15c1b261126ec2d15719cb3aa4.html#ga22b00b15c1b261126ec2d15719cb3aa4"> 5267</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga22b00b15c1b261126ec2d15719cb3aa4.html#ga22b00b15c1b261126ec2d15719cb3aa4">sstep</a>                                                  &amp;</div>
<div class="line"><a id="l05268" name="l05268"></a><span class="lineno"> 5268</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l05269" name="l05269"></a><span class="lineno"> 5269</span>     &amp;     ( nsoil, sh2oin, rhsct, dt, smcmax, cmcmax, zsoil, sice,     &amp;</div>
<div class="line"><a id="l05270" name="l05270"></a><span class="lineno"> 5270</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l05271" name="l05271"></a><span class="lineno"> 5271</span>     &amp;       cmc, rhstt, ai, bi, ci,                                    &amp;</div>
<div class="line"><a id="l05272" name="l05272"></a><span class="lineno"> 5272</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l05273" name="l05273"></a><span class="lineno"> 5273</span>     &amp;       sh2oout, runoff3, smc                                      &amp;</div>
<div class="line"><a id="l05274" name="l05274"></a><span class="lineno"> 5274</span>     &amp;     )</div>
<div class="line"><a id="l05275" name="l05275"></a><span class="lineno"> 5275</span> </div>
<div class="line"><a id="l05276" name="l05276"></a><span class="lineno"> 5276</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l05277" name="l05277"></a><span class="lineno"> 5277</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l05278" name="l05278"></a><span class="lineno"> 5278</span><span class="comment">!    subroutine sstep calculates/updates soil moisture content values   !</span></div>
<div class="line"><a id="l05279" name="l05279"></a><span class="lineno"> 5279</span><span class="comment">!    and canopy moisture content values.                                !</span></div>
<div class="line"><a id="l05280" name="l05280"></a><span class="lineno"> 5280</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05281" name="l05281"></a><span class="lineno"> 5281</span><span class="comment">!  subprogram called:  rosr12                                           !</span></div>
<div class="line"><a id="l05282" name="l05282"></a><span class="lineno"> 5282</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05283" name="l05283"></a><span class="lineno"> 5283</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05284" name="l05284"></a><span class="lineno"> 5284</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l05285" name="l05285"></a><span class="lineno"> 5285</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05286" name="l05286"></a><span class="lineno"> 5286</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l05287" name="l05287"></a><span class="lineno"> 5287</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l05288" name="l05288"></a><span class="lineno"> 5288</span><span class="comment">!     sh2oin   - real, unfrozen soil moisture                    nsoil  !</span></div>
<div class="line"><a id="l05289" name="l05289"></a><span class="lineno"> 5289</span><span class="comment">!     rhsct    - real,                                             1    !</span></div>
<div class="line"><a id="l05290" name="l05290"></a><span class="lineno"> 5290</span><span class="comment">!     dt       - real, time step                                   1    !</span></div>
<div class="line"><a id="l05291" name="l05291"></a><span class="lineno"> 5291</span><span class="comment">!     smcmax   - real, porosity                                    1    !</span></div>
<div class="line"><a id="l05292" name="l05292"></a><span class="lineno"> 5292</span><span class="comment">!     cmcmax   - real, maximum canopy water parameters             1    !</span></div>
<div class="line"><a id="l05293" name="l05293"></a><span class="lineno"> 5293</span><span class="comment">!     zsoil    - real, soil layer depth below ground             nsoil  !</span></div>
<div class="line"><a id="l05294" name="l05294"></a><span class="lineno"> 5294</span><span class="comment">!     sice     - real, ice content at each soil layer            nsoil  !</span></div>
<div class="line"><a id="l05295" name="l05295"></a><span class="lineno"> 5295</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05296" name="l05296"></a><span class="lineno"> 5296</span><span class="comment">!  input/outputs:                                                       !</span></div>
<div class="line"><a id="l05297" name="l05297"></a><span class="lineno"> 5297</span><span class="comment">!     cmc      - real, canopy moisture content                     1    !</span></div>
<div class="line"><a id="l05298" name="l05298"></a><span class="lineno"> 5298</span><span class="comment">!     rhstt    - real, soil water time tendency                  nsoil  !</span></div>
<div class="line"><a id="l05299" name="l05299"></a><span class="lineno"> 5299</span><span class="comment">!     ai       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l05300" name="l05300"></a><span class="lineno"> 5300</span><span class="comment">!     bi       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l05301" name="l05301"></a><span class="lineno"> 5301</span><span class="comment">!     ci       - real, matrix coefficients                       nsold  !</span></div>
<div class="line"><a id="l05302" name="l05302"></a><span class="lineno"> 5302</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05303" name="l05303"></a><span class="lineno"> 5303</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l05304" name="l05304"></a><span class="lineno"> 5304</span><span class="comment">!     sh2oout  - real, updated soil moisture content             nsoil  !</span></div>
<div class="line"><a id="l05305" name="l05305"></a><span class="lineno"> 5305</span><span class="comment">!     runoff3  - real, excess of porosity                          1    !</span></div>
<div class="line"><a id="l05306" name="l05306"></a><span class="lineno"> 5306</span><span class="comment">!     smc      - real, total soil moisture                       nsoil  !</span></div>
<div class="line"><a id="l05307" name="l05307"></a><span class="lineno"> 5307</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05308" name="l05308"></a><span class="lineno"> 5308</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l05309" name="l05309"></a><span class="lineno"> 5309</span><span class="comment">!</span></div>
<div class="line"><a id="l05310" name="l05310"></a><span class="lineno"> 5310</span><span class="comment">!  ---  input:</span></div>
<div class="line"><a id="l05311" name="l05311"></a><span class="lineno"> 5311</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil</div>
<div class="line"><a id="l05312" name="l05312"></a><span class="lineno"> 5312</span> </div>
<div class="line"><a id="l05313" name="l05313"></a><span class="lineno"> 5313</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">dimension(nsoil)</span>, <span class="keywordtype">intent(in)</span> :: sh2oin,    &amp;</div>
<div class="line"><a id="l05314" name="l05314"></a><span class="lineno"> 5314</span>     &amp;       zsoil, sice</div>
<div class="line"><a id="l05315" name="l05315"></a><span class="lineno"> 5315</span> </div>
<div class="line"><a id="l05316" name="l05316"></a><span class="lineno"> 5316</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: rhsct, dt, smcmax, cmcmax</div>
<div class="line"><a id="l05317" name="l05317"></a><span class="lineno"> 5317</span> </div>
<div class="line"><a id="l05318" name="l05318"></a><span class="lineno"> 5318</span><span class="comment">!  ---  inout/outputs:</span></div>
<div class="line"><a id="l05319" name="l05319"></a><span class="lineno"> 5319</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(inout)</span> :: cmc, rhstt(nsoil),        &amp;</div>
<div class="line"><a id="l05320" name="l05320"></a><span class="lineno"> 5320</span>     &amp;       ai(nsold), bi(nsold), ci(nsold)</div>
<div class="line"><a id="l05321" name="l05321"></a><span class="lineno"> 5321</span> </div>
<div class="line"><a id="l05322" name="l05322"></a><span class="lineno"> 5322</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l05323" name="l05323"></a><span class="lineno"> 5323</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: sh2oout(nsoil), runoff3,    &amp;</div>
<div class="line"><a id="l05324" name="l05324"></a><span class="lineno"> 5324</span>     &amp;       smc(nsoil)</div>
<div class="line"><a id="l05325" name="l05325"></a><span class="lineno"> 5325</span> </div>
<div class="line"><a id="l05326" name="l05326"></a><span class="lineno"> 5326</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l05327" name="l05327"></a><span class="lineno"> 5327</span><span class="keywordtype">      real</span> (kind=kind_phys) :: ciin(nsold), rhsttin(nsoil), ddz, stot,  &amp;</div>
<div class="line"><a id="l05328" name="l05328"></a><span class="lineno"> 5328</span>     &amp;       wplus</div>
<div class="line"><a id="l05329" name="l05329"></a><span class="lineno"> 5329</span> </div>
<div class="line"><a id="l05330" name="l05330"></a><span class="lineno"> 5330</span>      <span class="keywordtype">integer</span> :: i, k, kk11</div>
<div class="line"><a id="l05331" name="l05331"></a><span class="lineno"> 5331</span><span class="comment">!</span></div>
<div class="line"><a id="l05332" name="l05332"></a><span class="lineno"> 5332</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l05333" name="l05333"></a><span class="lineno"> 5333</span><span class="comment">!</span></div>
<div class="line"><a id="l05334" name="l05334"></a><span class="lineno"> 5334</span><span class="comment">!  --- ...  create &#39;amount&#39; values of variables to be input to the</span></div>
<div class="line"><a id="l05335" name="l05335"></a><span class="lineno"> 5335</span><span class="comment">!           tri-diagonal matrix routine.</span></div>
<div class="line"><a id="l05336" name="l05336"></a><span class="lineno"> 5336</span> </div>
<div class="line"><a id="l05337" name="l05337"></a><span class="lineno"> 5337</span>      <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l05338" name="l05338"></a><span class="lineno"> 5338</span>        rhstt(k) = rhstt(k) * dt</div>
<div class="line"><a id="l05339" name="l05339"></a><span class="lineno"> 5339</span>        ai(k) = ai(k) * dt</div>
<div class="line"><a id="l05340" name="l05340"></a><span class="lineno"> 5340</span>        bi(k) = 1. + bi(k) * dt</div>
<div class="line"><a id="l05341" name="l05341"></a><span class="lineno"> 5341</span>        ci(k) = ci(k) * dt</div>
<div class="line"><a id="l05342" name="l05342"></a><span class="lineno"> 5342</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l05343" name="l05343"></a><span class="lineno"> 5343</span> </div>
<div class="line"><a id="l05344" name="l05344"></a><span class="lineno"> 5344</span><span class="comment">!  --- ...  copy values for input variables before call to rosr12</span></div>
<div class="line"><a id="l05345" name="l05345"></a><span class="lineno"> 5345</span> </div>
<div class="line"><a id="l05346" name="l05346"></a><span class="lineno"> 5346</span>      <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l05347" name="l05347"></a><span class="lineno"> 5347</span>        rhsttin(k) = rhstt(k)</div>
<div class="line"><a id="l05348" name="l05348"></a><span class="lineno"> 5348</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l05349" name="l05349"></a><span class="lineno"> 5349</span> </div>
<div class="line"><a id="l05350" name="l05350"></a><span class="lineno"> 5350</span>      <span class="keywordflow">do</span> k = 1, nsold</div>
<div class="line"><a id="l05351" name="l05351"></a><span class="lineno"> 5351</span>        ciin(k) = ci(k)</div>
<div class="line"><a id="l05352" name="l05352"></a><span class="lineno"> 5352</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l05353" name="l05353"></a><span class="lineno"> 5353</span> </div>
<div class="line"><a id="l05354" name="l05354"></a><span class="lineno"> 5354</span><span class="comment">!  --- ...  call rosr12 to solve the tri-diagonal matrix</span></div>
<div class="line"><a id="l05355" name="l05355"></a><span class="lineno"> 5355</span> </div>
<div class="line"><a id="l05356" name="l05356"></a><span class="lineno"> 5356</span>      <span class="keyword">call </span><a class="code hl_function" href="group___noah___l_s_m_ga3d7dabe1147278de865aa4691d5b2de0.html#ga3d7dabe1147278de865aa4691d5b2de0">rosr12</a>                                                       &amp;</div>
<div class="line"><a id="l05357" name="l05357"></a><span class="lineno"> 5357</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l05358" name="l05358"></a><span class="lineno"> 5358</span>     &amp;     ( nsoil, ai, bi, rhsttin,                                    &amp;</div>
<div class="line"><a id="l05359" name="l05359"></a><span class="lineno"> 5359</span><span class="comment">!  ---  input/outputs:</span></div>
<div class="line"><a id="l05360" name="l05360"></a><span class="lineno"> 5360</span>     &amp;       ciin,                                                      &amp;</div>
<div class="line"><a id="l05361" name="l05361"></a><span class="lineno"> 5361</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l05362" name="l05362"></a><span class="lineno"> 5362</span>     &amp;       ci, rhstt                                                  &amp;</div>
<div class="line"><a id="l05363" name="l05363"></a><span class="lineno"> 5363</span>     &amp;     )</div>
<div class="line"><a id="l05364" name="l05364"></a><span class="lineno"> 5364</span> </div>
<div class="line"><a id="l05365" name="l05365"></a><span class="lineno"> 5365</span><span class="comment">!  --- ...  sum the previous smc value and the matrix solution to get</span></div>
<div class="line"><a id="l05366" name="l05366"></a><span class="lineno"> 5366</span><span class="comment">!           a new value.  min allowable value of smc will be 0.02.</span></div>
<div class="line"><a id="l05367" name="l05367"></a><span class="lineno"> 5367</span><span class="comment">!      runoff3: runoff within soil layers</span></div>
<div class="line"><a id="l05368" name="l05368"></a><span class="lineno"> 5368</span> </div>
<div class="line"><a id="l05369" name="l05369"></a><span class="lineno"> 5369</span>      wplus   = 0.0</div>
<div class="line"><a id="l05370" name="l05370"></a><span class="lineno"> 5370</span>      runoff3 = 0.0</div>
<div class="line"><a id="l05371" name="l05371"></a><span class="lineno"> 5371</span>      ddz     = -zsoil(1)</div>
<div class="line"><a id="l05372" name="l05372"></a><span class="lineno"> 5372</span> </div>
<div class="line"><a id="l05373" name="l05373"></a><span class="lineno"> 5373</span>      <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l05374" name="l05374"></a><span class="lineno"> 5374</span>        <span class="keywordflow">if</span> (k /= 1) ddz = zsoil(k - 1) - zsoil(k)</div>
<div class="line"><a id="l05375" name="l05375"></a><span class="lineno"> 5375</span> </div>
<div class="line"><a id="l05376" name="l05376"></a><span class="lineno"> 5376</span>        sh2oout(k) = sh2oin(k) + ci(k) + wplus/ddz</div>
<div class="line"><a id="l05377" name="l05377"></a><span class="lineno"> 5377</span> </div>
<div class="line"><a id="l05378" name="l05378"></a><span class="lineno"> 5378</span>        stot = sh2oout(k) + sice(k)</div>
<div class="line"><a id="l05379" name="l05379"></a><span class="lineno"> 5379</span>        <span class="keywordflow">if</span> (stot &gt; smcmax) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05380" name="l05380"></a><span class="lineno"> 5380</span>          <span class="keywordflow">if</span> (k == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05381" name="l05381"></a><span class="lineno"> 5381</span>            ddz = -zsoil(1)</div>
<div class="line"><a id="l05382" name="l05382"></a><span class="lineno"> 5382</span>          <span class="keywordflow">else</span></div>
<div class="line"><a id="l05383" name="l05383"></a><span class="lineno"> 5383</span>            kk11 = k - 1</div>
<div class="line"><a id="l05384" name="l05384"></a><span class="lineno"> 5384</span>            ddz = -zsoil(k) + zsoil(kk11)</div>
<div class="line"><a id="l05385" name="l05385"></a><span class="lineno"> 5385</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l05386" name="l05386"></a><span class="lineno"> 5386</span> </div>
<div class="line"><a id="l05387" name="l05387"></a><span class="lineno"> 5387</span>          wplus = (stot - smcmax) * ddz</div>
<div class="line"><a id="l05388" name="l05388"></a><span class="lineno"> 5388</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l05389" name="l05389"></a><span class="lineno"> 5389</span>          wplus = 0.0</div>
<div class="line"><a id="l05390" name="l05390"></a><span class="lineno"> 5390</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l05391" name="l05391"></a><span class="lineno"> 5391</span> </div>
<div class="line"><a id="l05392" name="l05392"></a><span class="lineno"> 5392</span>        smc(k) = max( min( stot, smcmax ), 0.02 )</div>
<div class="line"><a id="l05393" name="l05393"></a><span class="lineno"> 5393</span>        sh2oout(k) = max( smc(k)-sice(k), 0.0 )</div>
<div class="line"><a id="l05394" name="l05394"></a><span class="lineno"> 5394</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l05395" name="l05395"></a><span class="lineno"> 5395</span> </div>
<div class="line"><a id="l05396" name="l05396"></a><span class="lineno"> 5396</span>      runoff3 = wplus</div>
<div class="line"><a id="l05397" name="l05397"></a><span class="lineno"> 5397</span> </div>
<div class="line"><a id="l05398" name="l05398"></a><span class="lineno"> 5398</span><span class="comment">!  --- ...  update canopy water content/interception (cmc).  convert rhsct to</span></div>
<div class="line"><a id="l05399" name="l05399"></a><span class="lineno"> 5399</span><span class="comment">!           an &#39;amount&#39; value and add to previous cmc value to get new cmc.</span></div>
<div class="line"><a id="l05400" name="l05400"></a><span class="lineno"> 5400</span> </div>
<div class="line"><a id="l05401" name="l05401"></a><span class="lineno"> 5401</span>      cmc = cmc + dt*rhsct</div>
<div class="line"><a id="l05402" name="l05402"></a><span class="lineno"> 5402</span>      <span class="keywordflow">if</span> (cmc &lt; 1.e-20) cmc = 0.0</div>
<div class="line"><a id="l05403" name="l05403"></a><span class="lineno"> 5403</span>      cmc = min( cmc, cmcmax )</div>
<div class="line"><a id="l05404" name="l05404"></a><span class="lineno"> 5404</span><span class="comment">!</span></div>
<div class="line"><a id="l05405" name="l05405"></a><span class="lineno"> 5405</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l05406" name="l05406"></a><span class="lineno"> 5406</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga22b00b15c1b261126ec2d15719cb3aa4.html#ga22b00b15c1b261126ec2d15719cb3aa4">sstep</a></div>
<div class="line"><a id="l05407" name="l05407"></a><span class="lineno"> 5407</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l05408" name="l05408"></a><span class="lineno"> 5408</span> </div>
<div class="line"><a id="l05409" name="l05409"></a><span class="lineno"> 5409</span> </div>
<div class="line"><a id="l05410" name="l05410"></a><span class="lineno"> 5410</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l05411" name="l05411"></a><span class="lineno"> 5411</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l05412" name="l05412"></a><span class="lineno"> 5412</span><span class="comment">!&gt; This subroutine calculates temperature on the boundary of the</span></div>
<div class="line"><a id="l05413" name="l05413"></a><span class="lineno"> 5413</span><span class="comment">!! layer by interpolation of the middle layer temperatures.</span></div>
<div class="foldopen" id="foldopen05414" data-start="" data-end="">
<div class="line"><a id="l05414" name="l05414"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga8e248a6da8d1fd3c2e64b76f3bfbea50.html#ga8e248a6da8d1fd3c2e64b76f3bfbea50"> 5414</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga8e248a6da8d1fd3c2e64b76f3bfbea50.html#ga8e248a6da8d1fd3c2e64b76f3bfbea50">tbnd</a>                                                   &amp;</div>
<div class="line"><a id="l05415" name="l05415"></a><span class="lineno"> 5415</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l05416" name="l05416"></a><span class="lineno"> 5416</span>     &amp;     ( tu, tb, zsoil, zbot, k, nsoil,                             &amp;</div>
<div class="line"><a id="l05417" name="l05417"></a><span class="lineno"> 5417</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l05418" name="l05418"></a><span class="lineno"> 5418</span>     &amp;       tbnd1                                                      &amp;</div>
<div class="line"><a id="l05419" name="l05419"></a><span class="lineno"> 5419</span>     &amp;     )</div>
<div class="line"><a id="l05420" name="l05420"></a><span class="lineno"> 5420</span> </div>
<div class="line"><a id="l05421" name="l05421"></a><span class="lineno"> 5421</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l05422" name="l05422"></a><span class="lineno"> 5422</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l05423" name="l05423"></a><span class="lineno"> 5423</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05424" name="l05424"></a><span class="lineno"> 5424</span><span class="comment">!    subroutine tbnd calculates temperature on the boundary of the      !</span></div>
<div class="line"><a id="l05425" name="l05425"></a><span class="lineno"> 5425</span><span class="comment">!    layer by interpolation of the middle layer temperatures            !</span></div>
<div class="line"><a id="l05426" name="l05426"></a><span class="lineno"> 5426</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05427" name="l05427"></a><span class="lineno"> 5427</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l05428" name="l05428"></a><span class="lineno"> 5428</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05429" name="l05429"></a><span class="lineno"> 5429</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l05430" name="l05430"></a><span class="lineno"> 5430</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05431" name="l05431"></a><span class="lineno"> 5431</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l05432" name="l05432"></a><span class="lineno"> 5432</span><span class="comment">!     tu       - real, soil temperature                            1    !</span></div>
<div class="line"><a id="l05433" name="l05433"></a><span class="lineno"> 5433</span><span class="comment">!     tb       - real, bottom soil temp                            1    !</span></div>
<div class="line"><a id="l05434" name="l05434"></a><span class="lineno"> 5434</span><span class="comment">!     zsoil    - real, soil layer depth                          nsoil  !</span></div>
<div class="line"><a id="l05435" name="l05435"></a><span class="lineno"> 5435</span><span class="comment">!     zbot     - real, specify depth of lower bd soil              1    !</span></div>
<div class="line"><a id="l05436" name="l05436"></a><span class="lineno"> 5436</span><span class="comment">!     k        - integer, soil layer index                         1    !</span></div>
<div class="line"><a id="l05437" name="l05437"></a><span class="lineno"> 5437</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l05438" name="l05438"></a><span class="lineno"> 5438</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05439" name="l05439"></a><span class="lineno"> 5439</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l05440" name="l05440"></a><span class="lineno"> 5440</span><span class="comment">!     tbnd1    - real, temperature at bottom interface of the lyr  1    !</span></div>
<div class="line"><a id="l05441" name="l05441"></a><span class="lineno"> 5441</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05442" name="l05442"></a><span class="lineno"> 5442</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l05443" name="l05443"></a><span class="lineno"> 5443</span><span class="comment">!</span></div>
<div class="line"><a id="l05444" name="l05444"></a><span class="lineno"> 5444</span><span class="comment">!  ---  input:</span></div>
<div class="line"><a id="l05445" name="l05445"></a><span class="lineno"> 5445</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: k, nsoil</div>
<div class="line"><a id="l05446" name="l05446"></a><span class="lineno"> 5446</span> </div>
<div class="line"><a id="l05447" name="l05447"></a><span class="lineno"> 5447</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: tu, tb, zbot, zsoil(nsoil)</div>
<div class="line"><a id="l05448" name="l05448"></a><span class="lineno"> 5448</span> </div>
<div class="line"><a id="l05449" name="l05449"></a><span class="lineno"> 5449</span><span class="comment">!  ---  output:</span></div>
<div class="line"><a id="l05450" name="l05450"></a><span class="lineno"> 5450</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: tbnd1</div>
<div class="line"><a id="l05451" name="l05451"></a><span class="lineno"> 5451</span> </div>
<div class="line"><a id="l05452" name="l05452"></a><span class="lineno"> 5452</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l05453" name="l05453"></a><span class="lineno"> 5453</span><span class="keywordtype">      real</span> (kind=kind_phys) :: zb, zup</div>
<div class="line"><a id="l05454" name="l05454"></a><span class="lineno"> 5454</span> </div>
<div class="line"><a id="l05455" name="l05455"></a><span class="lineno"> 5455</span><span class="comment">!  --- ...  use surface temperature on the top of the first layer</span></div>
<div class="line"><a id="l05456" name="l05456"></a><span class="lineno"> 5456</span> </div>
<div class="line"><a id="l05457" name="l05457"></a><span class="lineno"> 5457</span>      <span class="keywordflow">if</span> (k == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05458" name="l05458"></a><span class="lineno"> 5458</span>        zup = 0.0</div>
<div class="line"><a id="l05459" name="l05459"></a><span class="lineno"> 5459</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05460" name="l05460"></a><span class="lineno"> 5460</span>        zup = zsoil(k-1)</div>
<div class="line"><a id="l05461" name="l05461"></a><span class="lineno"> 5461</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l05462" name="l05462"></a><span class="lineno"> 5462</span> </div>
<div class="line"><a id="l05463" name="l05463"></a><span class="lineno"> 5463</span><span class="comment">!  --- ...  use depth of the constant bottom temperature when interpolate</span></div>
<div class="line"><a id="l05464" name="l05464"></a><span class="lineno"> 5464</span><span class="comment">!           temperature into the last layer boundary</span></div>
<div class="line"><a id="l05465" name="l05465"></a><span class="lineno"> 5465</span> </div>
<div class="line"><a id="l05466" name="l05466"></a><span class="lineno"> 5466</span>      <span class="keywordflow">if</span> (k == nsoil) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05467" name="l05467"></a><span class="lineno"> 5467</span>        zb = 2.0*zbot - zsoil(k)</div>
<div class="line"><a id="l05468" name="l05468"></a><span class="lineno"> 5468</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05469" name="l05469"></a><span class="lineno"> 5469</span>        zb = zsoil(k+1)</div>
<div class="line"><a id="l05470" name="l05470"></a><span class="lineno"> 5470</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l05471" name="l05471"></a><span class="lineno"> 5471</span> </div>
<div class="line"><a id="l05472" name="l05472"></a><span class="lineno"> 5472</span><span class="comment">!  --- ...  linear interpolation between the average layer temperatures</span></div>
<div class="line"><a id="l05473" name="l05473"></a><span class="lineno"> 5473</span> </div>
<div class="line"><a id="l05474" name="l05474"></a><span class="lineno"> 5474</span>      tbnd1 = tu + (tb-tu)*(zup-zsoil(k))/(zup-zb)</div>
<div class="line"><a id="l05475" name="l05475"></a><span class="lineno"> 5475</span><span class="comment">!</span></div>
<div class="line"><a id="l05476" name="l05476"></a><span class="lineno"> 5476</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l05477" name="l05477"></a><span class="lineno"> 5477</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga8e248a6da8d1fd3c2e64b76f3bfbea50.html#ga8e248a6da8d1fd3c2e64b76f3bfbea50">tbnd</a></div>
<div class="line"><a id="l05478" name="l05478"></a><span class="lineno"> 5478</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l05479" name="l05479"></a><span class="lineno"> 5479</span> </div>
<div class="line"><a id="l05480" name="l05480"></a><span class="lineno"> 5480</span> </div>
<div class="line"><a id="l05481" name="l05481"></a><span class="lineno"> 5481</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l05482" name="l05482"></a><span class="lineno"> 5482</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l05483" name="l05483"></a><span class="lineno"> 5483</span><span class="comment">!&gt; This subroutine calculates soil layer average temperature (tavg)</span></div>
<div class="line"><a id="l05484" name="l05484"></a><span class="lineno"> 5484</span><span class="comment">!! in freezing/thawing layer using up, down, and middle layer</span></div>
<div class="line"><a id="l05485" name="l05485"></a><span class="lineno"> 5485</span><span class="comment">!! temperature (tup, tdn, tm), where tup is at top boundary of layer,</span></div>
<div class="line"><a id="l05486" name="l05486"></a><span class="lineno"> 5486</span><span class="comment">!! tdn is at bottom boundary of layer. tm is layer prognostic state</span></div>
<div class="line"><a id="l05487" name="l05487"></a><span class="lineno"> 5487</span><span class="comment">!! temperature.</span></div>
<div class="foldopen" id="foldopen05488" data-start="" data-end="">
<div class="line"><a id="l05488" name="l05488"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gae50411efeb11ddeb8a0c53010745a95c.html#gae50411efeb11ddeb8a0c53010745a95c"> 5488</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gae50411efeb11ddeb8a0c53010745a95c.html#gae50411efeb11ddeb8a0c53010745a95c">tmpavg</a>                                                 &amp;</div>
<div class="line"><a id="l05489" name="l05489"></a><span class="lineno"> 5489</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l05490" name="l05490"></a><span class="lineno"> 5490</span>     &amp;     ( tup, tm, tdn, zsoil, nsoil, k,                             &amp;</div>
<div class="line"><a id="l05491" name="l05491"></a><span class="lineno"> 5491</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l05492" name="l05492"></a><span class="lineno"> 5492</span>     &amp;       tavg                                                       &amp;</div>
<div class="line"><a id="l05493" name="l05493"></a><span class="lineno"> 5493</span>     &amp;     )</div>
<div class="line"><a id="l05494" name="l05494"></a><span class="lineno"> 5494</span> </div>
<div class="line"><a id="l05495" name="l05495"></a><span class="lineno"> 5495</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l05496" name="l05496"></a><span class="lineno"> 5496</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l05497" name="l05497"></a><span class="lineno"> 5497</span><span class="comment">!    subroutine tmpavg calculates soil layer average temperature (tavg) !</span></div>
<div class="line"><a id="l05498" name="l05498"></a><span class="lineno"> 5498</span><span class="comment">!    in freezing/thawing layer using up, down, and middle layer         !</span></div>
<div class="line"><a id="l05499" name="l05499"></a><span class="lineno"> 5499</span><span class="comment">!    temperatures (tup, tdn, tm), where tup is at top boundary of       !</span></div>
<div class="line"><a id="l05500" name="l05500"></a><span class="lineno"> 5500</span><span class="comment">!    layer, tdn is at bottom boundary of layer.  tm is layer prognostic !</span></div>
<div class="line"><a id="l05501" name="l05501"></a><span class="lineno"> 5501</span><span class="comment">!    state temperature.                                                 !</span></div>
<div class="line"><a id="l05502" name="l05502"></a><span class="lineno"> 5502</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05503" name="l05503"></a><span class="lineno"> 5503</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05504" name="l05504"></a><span class="lineno"> 5504</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l05505" name="l05505"></a><span class="lineno"> 5505</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05506" name="l05506"></a><span class="lineno"> 5506</span><span class="comment">!</span></div>
<div class="line"><a id="l05507" name="l05507"></a><span class="lineno"> 5507</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l05508" name="l05508"></a><span class="lineno"> 5508</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05509" name="l05509"></a><span class="lineno"> 5509</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l05510" name="l05510"></a><span class="lineno"> 5510</span><span class="comment">!     tup      - real, temperature ar top boundary of layer        1    !</span></div>
<div class="line"><a id="l05511" name="l05511"></a><span class="lineno"> 5511</span><span class="comment">!     tm       - real, layer prognostic state temperature          1    !</span></div>
<div class="line"><a id="l05512" name="l05512"></a><span class="lineno"> 5512</span><span class="comment">!     tdn      - real, temperature ar bottom boundary of layer     1    !</span></div>
<div class="line"><a id="l05513" name="l05513"></a><span class="lineno"> 5513</span><span class="comment">!     zsoil    - real, soil layer depth                          nsoil  !</span></div>
<div class="line"><a id="l05514" name="l05514"></a><span class="lineno"> 5514</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l05515" name="l05515"></a><span class="lineno"> 5515</span><span class="comment">!     k        - integer, layer index                              1    !</span></div>
<div class="line"><a id="l05516" name="l05516"></a><span class="lineno"> 5516</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l05517" name="l05517"></a><span class="lineno"> 5517</span><span class="comment">!     tavg     - real, soil layer average temperature              1    !</span></div>
<div class="line"><a id="l05518" name="l05518"></a><span class="lineno"> 5518</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05519" name="l05519"></a><span class="lineno"> 5519</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l05520" name="l05520"></a><span class="lineno"> 5520</span><span class="comment">!</span></div>
<div class="line"><a id="l05521" name="l05521"></a><span class="lineno"> 5521</span><span class="comment">!  ---  input:</span></div>
<div class="line"><a id="l05522" name="l05522"></a><span class="lineno"> 5522</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil, k</div>
<div class="line"><a id="l05523" name="l05523"></a><span class="lineno"> 5523</span> </div>
<div class="line"><a id="l05524" name="l05524"></a><span class="lineno"> 5524</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: tup, tm, tdn, zsoil(nsoil)</div>
<div class="line"><a id="l05525" name="l05525"></a><span class="lineno"> 5525</span> </div>
<div class="line"><a id="l05526" name="l05526"></a><span class="lineno"> 5526</span><span class="comment">!  ---  output:</span></div>
<div class="line"><a id="l05527" name="l05527"></a><span class="lineno"> 5527</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: tavg</div>
<div class="line"><a id="l05528" name="l05528"></a><span class="lineno"> 5528</span> </div>
<div class="line"><a id="l05529" name="l05529"></a><span class="lineno"> 5529</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l05530" name="l05530"></a><span class="lineno"> 5530</span><span class="keywordtype">      real</span> (kind=kind_phys) :: dz, dzh, x0, xdn, xup</div>
<div class="line"><a id="l05531" name="l05531"></a><span class="lineno"> 5531</span><span class="comment">!</span></div>
<div class="line"><a id="l05532" name="l05532"></a><span class="lineno"> 5532</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l05533" name="l05533"></a><span class="lineno"> 5533</span><span class="comment">!</span></div>
<div class="line"><a id="l05534" name="l05534"></a><span class="lineno"> 5534</span>      <span class="keywordflow">if</span> (k == 1) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05535" name="l05535"></a><span class="lineno"> 5535</span>        dz = -zsoil(1)</div>
<div class="line"><a id="l05536" name="l05536"></a><span class="lineno"> 5536</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05537" name="l05537"></a><span class="lineno"> 5537</span>        dz = zsoil(k-1) - zsoil(k)</div>
<div class="line"><a id="l05538" name="l05538"></a><span class="lineno"> 5538</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l05539" name="l05539"></a><span class="lineno"> 5539</span> </div>
<div class="line"><a id="l05540" name="l05540"></a><span class="lineno"> 5540</span>      dzh = dz * 0.5</div>
<div class="line"><a id="l05541" name="l05541"></a><span class="lineno"> 5541</span> </div>
<div class="line"><a id="l05542" name="l05542"></a><span class="lineno"> 5542</span>      <span class="keywordflow">if</span> (tup &lt; tfreez) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05543" name="l05543"></a><span class="lineno"> 5543</span> </div>
<div class="line"><a id="l05544" name="l05544"></a><span class="lineno"> 5544</span>        <span class="keywordflow">if</span> (tm &lt; tfreez) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05545" name="l05545"></a><span class="lineno"> 5545</span>          <span class="keywordflow">if</span> (tdn &lt; tfreez) <span class="keywordflow">then</span>               <span class="comment">! tup, tm, tdn &lt; t0</span></div>
<div class="line"><a id="l05546" name="l05546"></a><span class="lineno"> 5546</span>            tavg = (tup + 2.0*tm + tdn) / 4.0</div>
<div class="line"><a id="l05547" name="l05547"></a><span class="lineno"> 5547</span>          <span class="keywordflow">else</span>                                 <span class="comment">! tup &amp; tm &lt; t0,  tdn &gt;= t0</span></div>
<div class="line"><a id="l05548" name="l05548"></a><span class="lineno"> 5548</span>            x0 = (tfreez - tm) * dzh / (tdn - tm)</div>
<div class="line"><a id="l05549" name="l05549"></a><span class="lineno"> 5549</span>            tavg = 0.5*(tup*dzh + tm*(dzh+x0)+tfreez*(2.*dzh-x0)) / dz</div>
<div class="line"><a id="l05550" name="l05550"></a><span class="lineno"> 5550</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l05551" name="l05551"></a><span class="lineno"> 5551</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l05552" name="l05552"></a><span class="lineno"> 5552</span>          <span class="keywordflow">if</span> (tdn &lt; tfreez) <span class="keywordflow">then</span>               <span class="comment">! tup &lt; t0, tm &gt;= t0, tdn &lt; t0</span></div>
<div class="line"><a id="l05553" name="l05553"></a><span class="lineno"> 5553</span>            xup  = (tfreez-tup) * dzh / (tm-tup)</div>
<div class="line"><a id="l05554" name="l05554"></a><span class="lineno"> 5554</span>            xdn  = dzh - (tfreez-tm) * dzh / (tdn-tm)</div>
<div class="line"><a id="l05555" name="l05555"></a><span class="lineno"> 5555</span>            tavg = 0.5*(tup*xup + tfreez*(2.*dz-xup-xdn)+tdn*xdn) / dz</div>
<div class="line"><a id="l05556" name="l05556"></a><span class="lineno"> 5556</span>          <span class="keywordflow">else</span>                                 <span class="comment">! tup &lt; t0, tm &gt;= t0, tdn &gt;= t0</span></div>
<div class="line"><a id="l05557" name="l05557"></a><span class="lineno"> 5557</span>            xup  = (tfreez-tup) * dzh / (tm-tup)</div>
<div class="line"><a id="l05558" name="l05558"></a><span class="lineno"> 5558</span>            tavg = 0.5*(tup*xup + tfreez*(2.*dz-xup)) / dz</div>
<div class="line"><a id="l05559" name="l05559"></a><span class="lineno"> 5559</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l05560" name="l05560"></a><span class="lineno"> 5560</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l05561" name="l05561"></a><span class="lineno"> 5561</span> </div>
<div class="line"><a id="l05562" name="l05562"></a><span class="lineno"> 5562</span>      <span class="keywordflow">else</span>    <span class="comment">! if_tup_block</span></div>
<div class="line"><a id="l05563" name="l05563"></a><span class="lineno"> 5563</span> </div>
<div class="line"><a id="l05564" name="l05564"></a><span class="lineno"> 5564</span>        <span class="keywordflow">if</span> (tm &lt; tfreez) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05565" name="l05565"></a><span class="lineno"> 5565</span>          <span class="keywordflow">if</span> (tdn &lt; tfreez) <span class="keywordflow">then</span>               <span class="comment">! tup &gt;= t0, tm &lt; t0, tdn &lt; t0</span></div>
<div class="line"><a id="l05566" name="l05566"></a><span class="lineno"> 5566</span>            xup  = dzh - (tfreez-tup) * dzh / (tm-tup)</div>
<div class="line"><a id="l05567" name="l05567"></a><span class="lineno"> 5567</span>            tavg = 0.5*(tfreez*(dz-xup) + tm*(dzh+xup)+tdn*dzh) / dz</div>
<div class="line"><a id="l05568" name="l05568"></a><span class="lineno"> 5568</span>          <span class="keywordflow">else</span>                                 <span class="comment">! tup &gt;= t0, tm &lt; t0, tdn &gt;= t0</span></div>
<div class="line"><a id="l05569" name="l05569"></a><span class="lineno"> 5569</span>            xup  = dzh - (tfreez-tup) * dzh / (tm-tup)</div>
<div class="line"><a id="l05570" name="l05570"></a><span class="lineno"> 5570</span>            xdn  = (tfreez-tm) * dzh / (tdn-tm)</div>
<div class="line"><a id="l05571" name="l05571"></a><span class="lineno"> 5571</span>            tavg = 0.5 * (tfreez*(2.*dz-xup-xdn) + tm*(xup+xdn)) / dz</div>
<div class="line"><a id="l05572" name="l05572"></a><span class="lineno"> 5572</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l05573" name="l05573"></a><span class="lineno"> 5573</span>        <span class="keywordflow">else</span></div>
<div class="line"><a id="l05574" name="l05574"></a><span class="lineno"> 5574</span>          <span class="keywordflow">if</span> (tdn &lt; tfreez) <span class="keywordflow">then</span>               <span class="comment">! tup &gt;= t0, tm &gt;= t0, tdn &lt; t0</span></div>
<div class="line"><a id="l05575" name="l05575"></a><span class="lineno"> 5575</span>            xdn  = dzh - (tfreez-tm) * dzh / (tdn-tm)</div>
<div class="line"><a id="l05576" name="l05576"></a><span class="lineno"> 5576</span>            tavg = (tfreez*(dz-xdn) + 0.5*(tfreez+tdn)*xdn) / dz</div>
<div class="line"><a id="l05577" name="l05577"></a><span class="lineno"> 5577</span>          <span class="keywordflow">else</span>                                 <span class="comment">! tup &gt;= t0, tm &gt;= t0, tdn &gt;= t0</span></div>
<div class="line"><a id="l05578" name="l05578"></a><span class="lineno"> 5578</span>            tavg = (tup + 2.0*tm + tdn) / 4.0</div>
<div class="line"><a id="l05579" name="l05579"></a><span class="lineno"> 5579</span><span class="keywordflow">          endif</span></div>
<div class="line"><a id="l05580" name="l05580"></a><span class="lineno"> 5580</span><span class="keywordflow">        endif</span></div>
<div class="line"><a id="l05581" name="l05581"></a><span class="lineno"> 5581</span> </div>
<div class="line"><a id="l05582" name="l05582"></a><span class="lineno"> 5582</span><span class="keywordflow">      endif</span>   <span class="comment">! end if_tup_block</span></div>
<div class="line"><a id="l05583" name="l05583"></a><span class="lineno"> 5583</span><span class="comment">!</span></div>
<div class="line"><a id="l05584" name="l05584"></a><span class="lineno"> 5584</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l05585" name="l05585"></a><span class="lineno"> 5585</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gae50411efeb11ddeb8a0c53010745a95c.html#gae50411efeb11ddeb8a0c53010745a95c">tmpavg</a></div>
<div class="line"><a id="l05586" name="l05586"></a><span class="lineno"> 5586</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l05587" name="l05587"></a><span class="lineno"> 5587</span> </div>
<div class="line"><a id="l05588" name="l05588"></a><span class="lineno"> 5588</span> </div>
<div class="line"><a id="l05589" name="l05589"></a><span class="lineno"> 5589</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l05590" name="l05590"></a><span class="lineno"> 5590</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l05591" name="l05591"></a><span class="lineno"> 5591</span><span class="comment">!&gt; This subroutine calculates transpiration for the veg class.</span></div>
<div class="foldopen" id="foldopen05592" data-start="" data-end="">
<div class="line"><a id="l05592" name="l05592"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_ga4bf7fbbf861a5c232da14ca6b74cdd4f.html#ga4bf7fbbf861a5c232da14ca6b74cdd4f"> 5592</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga4bf7fbbf861a5c232da14ca6b74cdd4f.html#ga4bf7fbbf861a5c232da14ca6b74cdd4f">transp</a>                                                 &amp;</div>
<div class="line"><a id="l05593" name="l05593"></a><span class="lineno"> 5593</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l05594" name="l05594"></a><span class="lineno"> 5594</span>     &amp;     ( nsoil, nroot, etp1, smc, smcwlt, smcref,                   &amp;</div>
<div class="line"><a id="l05595" name="l05595"></a><span class="lineno"> 5595</span>     &amp;       cmc, cmcmax, zsoil, shdfac, pc, cfactr, rtdis,             &amp;</div>
<div class="line"><a id="l05596" name="l05596"></a><span class="lineno"> 5596</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l05597" name="l05597"></a><span class="lineno"> 5597</span>     &amp;       et1                                                        &amp;</div>
<div class="line"><a id="l05598" name="l05598"></a><span class="lineno"> 5598</span>     &amp;     )</div>
<div class="line"><a id="l05599" name="l05599"></a><span class="lineno"> 5599</span> </div>
<div class="line"><a id="l05600" name="l05600"></a><span class="lineno"> 5600</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l05601" name="l05601"></a><span class="lineno"> 5601</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l05602" name="l05602"></a><span class="lineno"> 5602</span><span class="comment">!     subroutine transp calculates transpiration for the veg class.     !</span></div>
<div class="line"><a id="l05603" name="l05603"></a><span class="lineno"> 5603</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05604" name="l05604"></a><span class="lineno"> 5604</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l05605" name="l05605"></a><span class="lineno"> 5605</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05606" name="l05606"></a><span class="lineno"> 5606</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05607" name="l05607"></a><span class="lineno"> 5607</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l05608" name="l05608"></a><span class="lineno"> 5608</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05609" name="l05609"></a><span class="lineno"> 5609</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l05610" name="l05610"></a><span class="lineno"> 5610</span><span class="comment">!     nsoil    - integer, number of soil layers                    1    !</span></div>
<div class="line"><a id="l05611" name="l05611"></a><span class="lineno"> 5611</span><span class="comment">!     nroot    - integer, number of root layers                    1    !</span></div>
<div class="line"><a id="l05612" name="l05612"></a><span class="lineno"> 5612</span><span class="comment">!     etp1     - real, potential evaporation                       1    !</span></div>
<div class="line"><a id="l05613" name="l05613"></a><span class="lineno"> 5613</span><span class="comment">!     smc      - real, unfrozen soil moisture                    nsoil  !</span></div>
<div class="line"><a id="l05614" name="l05614"></a><span class="lineno"> 5614</span><span class="comment">!     smcwlt   - real, wilting point                               1    !</span></div>
<div class="line"><a id="l05615" name="l05615"></a><span class="lineno"> 5615</span><span class="comment">!     smcref   - real, soil mois threshold                         1    !</span></div>
<div class="line"><a id="l05616" name="l05616"></a><span class="lineno"> 5616</span><span class="comment">!     cmc      - real, canopy moisture content                     1    !</span></div>
<div class="line"><a id="l05617" name="l05617"></a><span class="lineno"> 5617</span><span class="comment">!     cmcmax   - real, maximum canopy water parameters             1    !</span></div>
<div class="line"><a id="l05618" name="l05618"></a><span class="lineno"> 5618</span><span class="comment">!     zsoil    - real, soil layer depth below ground             nsoil  !</span></div>
<div class="line"><a id="l05619" name="l05619"></a><span class="lineno"> 5619</span><span class="comment">!     shdfac   - real, aeral coverage of green vegetation          1    !</span></div>
<div class="line"><a id="l05620" name="l05620"></a><span class="lineno"> 5620</span><span class="comment">!     pc       - real, plant coeff                                 1    !</span></div>
<div class="line"><a id="l05621" name="l05621"></a><span class="lineno"> 5621</span><span class="comment">!     cfactr   - real, canopy water parameters                     1    !</span></div>
<div class="line"><a id="l05622" name="l05622"></a><span class="lineno"> 5622</span><span class="comment">!     rtdis    - real, root distribution                         nsoil  !</span></div>
<div class="line"><a id="l05623" name="l05623"></a><span class="lineno"> 5623</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05624" name="l05624"></a><span class="lineno"> 5624</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l05625" name="l05625"></a><span class="lineno"> 5625</span><span class="comment">!     et1      - real, plant transpiration                       nsoil  !</span></div>
<div class="line"><a id="l05626" name="l05626"></a><span class="lineno"> 5626</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05627" name="l05627"></a><span class="lineno"> 5627</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l05628" name="l05628"></a><span class="lineno"> 5628</span><span class="comment">!</span></div>
<div class="line"><a id="l05629" name="l05629"></a><span class="lineno"> 5629</span><span class="comment">!  ---  input:</span></div>
<div class="line"><a id="l05630" name="l05630"></a><span class="lineno"> 5630</span>      <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: nsoil, nroot</div>
<div class="line"><a id="l05631" name="l05631"></a><span class="lineno"> 5631</span> </div>
<div class="line"><a id="l05632" name="l05632"></a><span class="lineno"> 5632</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span> :: etp1, smcwlt, smcref,        &amp;</div>
<div class="line"><a id="l05633" name="l05633"></a><span class="lineno"> 5633</span>     &amp;       cmc, cmcmax, shdfac, pc, cfactr</div>
<div class="line"><a id="l05634" name="l05634"></a><span class="lineno"> 5634</span> </div>
<div class="line"><a id="l05635" name="l05635"></a><span class="lineno"> 5635</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">dimension(nsoil)</span>, <span class="keywordtype">intent(in)</span> :: smc,       &amp;</div>
<div class="line"><a id="l05636" name="l05636"></a><span class="lineno"> 5636</span>     &amp;       zsoil, rtdis</div>
<div class="line"><a id="l05637" name="l05637"></a><span class="lineno"> 5637</span> </div>
<div class="line"><a id="l05638" name="l05638"></a><span class="lineno"> 5638</span><span class="comment">!  ---  output:</span></div>
<div class="line"><a id="l05639" name="l05639"></a><span class="lineno"> 5639</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">dimension(nsoil)</span>, <span class="keywordtype">intent(out)</span> :: et1</div>
<div class="line"><a id="l05640" name="l05640"></a><span class="lineno"> 5640</span> </div>
<div class="line"><a id="l05641" name="l05641"></a><span class="lineno"> 5641</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l05642" name="l05642"></a><span class="lineno"> 5642</span><span class="keywordtype">      real</span> (kind=kind_phys) :: denom, etp1a, rtx, sgx, gx(7)</div>
<div class="line"><a id="l05643" name="l05643"></a><span class="lineno"> 5643</span> </div>
<div class="line"><a id="l05644" name="l05644"></a><span class="lineno"> 5644</span>      <span class="keywordtype">integer</span> :: i, k</div>
<div class="line"><a id="l05645" name="l05645"></a><span class="lineno"> 5645</span><span class="comment">!</span></div>
<div class="line"><a id="l05646" name="l05646"></a><span class="lineno"> 5646</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l05647" name="l05647"></a><span class="lineno"> 5647</span><span class="comment">!</span></div>
<div class="line"><a id="l05648" name="l05648"></a><span class="lineno"> 5648</span><span class="comment">!  --- ...  initialize plant transp to zero for all soil layers.</span></div>
<div class="line"><a id="l05649" name="l05649"></a><span class="lineno"> 5649</span> </div>
<div class="line"><a id="l05650" name="l05650"></a><span class="lineno"> 5650</span>      <span class="keywordflow">do</span> k = 1, nsoil</div>
<div class="line"><a id="l05651" name="l05651"></a><span class="lineno"> 5651</span>        et1(k) = 0.0</div>
<div class="line"><a id="l05652" name="l05652"></a><span class="lineno"> 5652</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l05653" name="l05653"></a><span class="lineno"> 5653</span> </div>
<div class="line"><a id="l05654" name="l05654"></a><span class="lineno"> 5654</span><span class="comment">!  --- ...  calculate an &#39;adjusted&#39; potential transpiration</span></div>
<div class="line"><a id="l05655" name="l05655"></a><span class="lineno"> 5655</span><span class="comment">!           if statement below to avoid tangent linear problems near zero</span></div>
<div class="line"><a id="l05656" name="l05656"></a><span class="lineno"> 5656</span><span class="comment">!           note: gx and other terms below redistribute transpiration by layer,</span></div>
<div class="line"><a id="l05657" name="l05657"></a><span class="lineno"> 5657</span><span class="comment">!           et(k), as a function of soil moisture availability, while preserving</span></div>
<div class="line"><a id="l05658" name="l05658"></a><span class="lineno"> 5658</span><span class="comment">!           total etp1a.</span></div>
<div class="line"><a id="l05659" name="l05659"></a><span class="lineno"> 5659</span> </div>
<div class="line"><a id="l05660" name="l05660"></a><span class="lineno"> 5660</span>      <span class="keywordflow">if</span> (cmc /= 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05661" name="l05661"></a><span class="lineno"> 5661</span>        etp1a = shdfac * pc * etp1 * (1.0 - (cmc /cmcmax) ** cfactr)</div>
<div class="line"><a id="l05662" name="l05662"></a><span class="lineno"> 5662</span>      <span class="keywordflow">else</span></div>
<div class="line"><a id="l05663" name="l05663"></a><span class="lineno"> 5663</span>        etp1a = shdfac * pc * etp1</div>
<div class="line"><a id="l05664" name="l05664"></a><span class="lineno"> 5664</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l05665" name="l05665"></a><span class="lineno"> 5665</span> </div>
<div class="line"><a id="l05666" name="l05666"></a><span class="lineno"> 5666</span>      sgx = 0.0</div>
<div class="line"><a id="l05667" name="l05667"></a><span class="lineno"> 5667</span>      <span class="keywordflow">do</span> i = 1, nroot</div>
<div class="line"><a id="l05668" name="l05668"></a><span class="lineno"> 5668</span>        gx(i) = ( smc(i) - smcwlt ) / ( smcref - smcwlt )</div>
<div class="line"><a id="l05669" name="l05669"></a><span class="lineno"> 5669</span>        gx(i) = max( min( gx(i), 1.0 ), 0.0 )</div>
<div class="line"><a id="l05670" name="l05670"></a><span class="lineno"> 5670</span>        sgx = sgx + gx(i)</div>
<div class="line"><a id="l05671" name="l05671"></a><span class="lineno"> 5671</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l05672" name="l05672"></a><span class="lineno"> 5672</span>      sgx = sgx / nroot</div>
<div class="line"><a id="l05673" name="l05673"></a><span class="lineno"> 5673</span> </div>
<div class="line"><a id="l05674" name="l05674"></a><span class="lineno"> 5674</span>      denom = 0.0</div>
<div class="line"><a id="l05675" name="l05675"></a><span class="lineno"> 5675</span>      <span class="keywordflow">do</span> i = 1, nroot</div>
<div class="line"><a id="l05676" name="l05676"></a><span class="lineno"> 5676</span>        rtx = rtdis(i) + gx(i) - sgx</div>
<div class="line"><a id="l05677" name="l05677"></a><span class="lineno"> 5677</span>        gx(i) = gx(i) * max( rtx, 0.0 )</div>
<div class="line"><a id="l05678" name="l05678"></a><span class="lineno"> 5678</span>        denom = denom + gx(i)</div>
<div class="line"><a id="l05679" name="l05679"></a><span class="lineno"> 5679</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l05680" name="l05680"></a><span class="lineno"> 5680</span>      <span class="keywordflow">if</span> (denom &lt;= 0.0) denom = 1.0</div>
<div class="line"><a id="l05681" name="l05681"></a><span class="lineno"> 5681</span> </div>
<div class="line"><a id="l05682" name="l05682"></a><span class="lineno"> 5682</span>      <span class="keywordflow">do</span> i = 1, nroot</div>
<div class="line"><a id="l05683" name="l05683"></a><span class="lineno"> 5683</span>        et1(i) = etp1a * gx(i) / denom</div>
<div class="line"><a id="l05684" name="l05684"></a><span class="lineno"> 5684</span><span class="keywordflow">      enddo</span></div>
<div class="line"><a id="l05685" name="l05685"></a><span class="lineno"> 5685</span> </div>
<div class="line"><a id="l05686" name="l05686"></a><span class="lineno"> 5686</span><span class="comment">!  --- ...  above code assumes a vertically uniform root distribution</span></div>
<div class="line"><a id="l05687" name="l05687"></a><span class="lineno"> 5687</span><span class="comment">!           code below tests a variable root distribution</span></div>
<div class="line"><a id="l05688" name="l05688"></a><span class="lineno"> 5688</span> </div>
<div class="line"><a id="l05689" name="l05689"></a><span class="lineno"> 5689</span><span class="comment">!     et(1) = ( zsoil(1) / zsoil(nroot) ) * gx * etp1a</span></div>
<div class="line"><a id="l05690" name="l05690"></a><span class="lineno"> 5690</span><span class="comment">!     et(1) = ( zsoil(1) / zsoil(nroot) ) * etp1a</span></div>
<div class="line"><a id="l05691" name="l05691"></a><span class="lineno"> 5691</span> </div>
<div class="line"><a id="l05692" name="l05692"></a><span class="lineno"> 5692</span><span class="comment">!  --- ...  using root distribution as weighting factor</span></div>
<div class="line"><a id="l05693" name="l05693"></a><span class="lineno"> 5693</span> </div>
<div class="line"><a id="l05694" name="l05694"></a><span class="lineno"> 5694</span><span class="comment">!     et(1) = rtdis(1) * etp1a</span></div>
<div class="line"><a id="l05695" name="l05695"></a><span class="lineno"> 5695</span><span class="comment">!     et(1) = etp1a * part(1)</span></div>
<div class="line"><a id="l05696" name="l05696"></a><span class="lineno"> 5696</span> </div>
<div class="line"><a id="l05697" name="l05697"></a><span class="lineno"> 5697</span><span class="comment">!  --- ...  loop down thru the soil layers repeating the operation above,</span></div>
<div class="line"><a id="l05698" name="l05698"></a><span class="lineno"> 5698</span><span class="comment">!           but using the thickness of the soil layer (rather than the</span></div>
<div class="line"><a id="l05699" name="l05699"></a><span class="lineno"> 5699</span><span class="comment">!           absolute depth of each layer) in the final calculation.</span></div>
<div class="line"><a id="l05700" name="l05700"></a><span class="lineno"> 5700</span> </div>
<div class="line"><a id="l05701" name="l05701"></a><span class="lineno"> 5701</span><span class="comment">!     do k = 2, nroot</span></div>
<div class="line"><a id="l05702" name="l05702"></a><span class="lineno"> 5702</span><span class="comment">!       gx = ( smc(k) - smcwlt ) / ( smcref - smcwlt )</span></div>
<div class="line"><a id="l05703" name="l05703"></a><span class="lineno"> 5703</span><span class="comment">!       gx = max ( min ( gx, 1.0 ), 0.0 )</span></div>
<div class="line"><a id="l05704" name="l05704"></a><span class="lineno"> 5704</span><span class="comment">!  --- ...  test canopy resistance</span></div>
<div class="line"><a id="l05705" name="l05705"></a><span class="lineno"> 5705</span><span class="comment">!       gx = 1.0</span></div>
<div class="line"><a id="l05706" name="l05706"></a><span class="lineno"> 5706</span><span class="comment">!       et(k) = ((zsoil(k)-zsoil(k-1))/zsoil(nroot))*gx*etp1a</span></div>
<div class="line"><a id="l05707" name="l05707"></a><span class="lineno"> 5707</span><span class="comment">!       et(k) = ((zsoil(k)-zsoil(k-1))/zsoil(nroot))*etp1a</span></div>
<div class="line"><a id="l05708" name="l05708"></a><span class="lineno"> 5708</span> </div>
<div class="line"><a id="l05709" name="l05709"></a><span class="lineno"> 5709</span><span class="comment">!  --- ...  using root distribution as weighting factor</span></div>
<div class="line"><a id="l05710" name="l05710"></a><span class="lineno"> 5710</span> </div>
<div class="line"><a id="l05711" name="l05711"></a><span class="lineno"> 5711</span><span class="comment">!       et(k) = rtdis(k) * etp1a</span></div>
<div class="line"><a id="l05712" name="l05712"></a><span class="lineno"> 5712</span><span class="comment">!       et(k) = etp1a*part(k)</span></div>
<div class="line"><a id="l05713" name="l05713"></a><span class="lineno"> 5713</span><span class="comment">!     enddo</span></div>
<div class="line"><a id="l05714" name="l05714"></a><span class="lineno"> 5714</span> </div>
<div class="line"><a id="l05715" name="l05715"></a><span class="lineno"> 5715</span><span class="comment">!</span></div>
<div class="line"><a id="l05716" name="l05716"></a><span class="lineno"> 5716</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l05717" name="l05717"></a><span class="lineno"> 5717</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga4bf7fbbf861a5c232da14ca6b74cdd4f.html#ga4bf7fbbf861a5c232da14ca6b74cdd4f">transp</a></div>
<div class="line"><a id="l05718" name="l05718"></a><span class="lineno"> 5718</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l05719" name="l05719"></a><span class="lineno"> 5719</span> </div>
<div class="line"><a id="l05720" name="l05720"></a><span class="lineno"> 5720</span> </div>
<div class="line"><a id="l05721" name="l05721"></a><span class="lineno"> 5721</span><span class="comment">!-----------------------------------</span><span class="comment"></span></div>
<div class="line"><a id="l05722" name="l05722"></a><span class="lineno"> 5722</span><span class="comment">!&gt;\ingroup Noah_LSM</span></div>
<div class="line"><a id="l05723" name="l05723"></a><span class="lineno"> 5723</span><span class="comment">!&gt; This subroutine calculates soil water diffusivity and soil</span></div>
<div class="line"><a id="l05724" name="l05724"></a><span class="lineno"> 5724</span><span class="comment">!! hydraulic conductivity.</span></div>
<div class="foldopen" id="foldopen05725" data-start="" data-end="">
<div class="line"><a id="l05725" name="l05725"></a><span class="lineno"><a class="line" href="group___noah___l_s_m_gabfc5ae94c847aa3351345e0e924302a1.html#gabfc5ae94c847aa3351345e0e924302a1"> 5725</a></span>      <span class="keyword">subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gabfc5ae94c847aa3351345e0e924302a1.html#gabfc5ae94c847aa3351345e0e924302a1">wdfcnd</a>                                                 &amp;</div>
<div class="line"><a id="l05726" name="l05726"></a><span class="lineno"> 5726</span><span class="comment">!  ---  inputs:</span></div>
<div class="line"><a id="l05727" name="l05727"></a><span class="lineno"> 5727</span>     &amp;     ( smc, smcmax, bexp, dksat, dwsat, sicemax,                  &amp;</div>
<div class="line"><a id="l05728" name="l05728"></a><span class="lineno"> 5728</span><span class="comment">!  ---  outputs:</span></div>
<div class="line"><a id="l05729" name="l05729"></a><span class="lineno"> 5729</span>     &amp;       wdf, wcnd                                                  &amp;</div>
<div class="line"><a id="l05730" name="l05730"></a><span class="lineno"> 5730</span>     &amp;     )</div>
<div class="line"><a id="l05731" name="l05731"></a><span class="lineno"> 5731</span> </div>
<div class="line"><a id="l05732" name="l05732"></a><span class="lineno"> 5732</span><span class="comment">! ===================================================================== !</span></div>
<div class="line"><a id="l05733" name="l05733"></a><span class="lineno"> 5733</span><span class="comment">!  description:                                                         !</span></div>
<div class="line"><a id="l05734" name="l05734"></a><span class="lineno"> 5734</span><span class="comment">!     subroutine wdfcnd calculates soil water diffusivity and soil      !</span></div>
<div class="line"><a id="l05735" name="l05735"></a><span class="lineno"> 5735</span><span class="comment">!     hydraulic conductivity.                                           !</span></div>
<div class="line"><a id="l05736" name="l05736"></a><span class="lineno"> 5736</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05737" name="l05737"></a><span class="lineno"> 5737</span><span class="comment">!  subprogram called:  none                                             !</span></div>
<div class="line"><a id="l05738" name="l05738"></a><span class="lineno"> 5738</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05739" name="l05739"></a><span class="lineno"> 5739</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05740" name="l05740"></a><span class="lineno"> 5740</span><span class="comment">!  ====================  defination of variables  ====================  !</span></div>
<div class="line"><a id="l05741" name="l05741"></a><span class="lineno"> 5741</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05742" name="l05742"></a><span class="lineno"> 5742</span><span class="comment">!  inputs:                                                       size   !</span></div>
<div class="line"><a id="l05743" name="l05743"></a><span class="lineno"> 5743</span><span class="comment">!     smc      - real, layer total soil moisture                   1    !</span></div>
<div class="line"><a id="l05744" name="l05744"></a><span class="lineno"> 5744</span><span class="comment">!     smcmax   - real, porosity                                    1    !</span></div>
<div class="line"><a id="l05745" name="l05745"></a><span class="lineno"> 5745</span><span class="comment">!     bexp     - real, soil type &quot;b&quot; parameter                     1    !</span></div>
<div class="line"><a id="l05746" name="l05746"></a><span class="lineno"> 5746</span><span class="comment">!     dksat    - real, saturated soil hydraulic conductivity       1    !</span></div>
<div class="line"><a id="l05747" name="l05747"></a><span class="lineno"> 5747</span><span class="comment">!     dwsat    - real, saturated soil diffusivity                  1    !</span></div>
<div class="line"><a id="l05748" name="l05748"></a><span class="lineno"> 5748</span><span class="comment">!     sicemax  - real, max frozen water content in soil layer      1    !</span></div>
<div class="line"><a id="l05749" name="l05749"></a><span class="lineno"> 5749</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05750" name="l05750"></a><span class="lineno"> 5750</span><span class="comment">!  outputs:                                                             !</span></div>
<div class="line"><a id="l05751" name="l05751"></a><span class="lineno"> 5751</span><span class="comment">!     wdf      - real, soil water diffusivity                      1    !</span></div>
<div class="line"><a id="l05752" name="l05752"></a><span class="lineno"> 5752</span><span class="comment">!     wcnd     - real, soil hydraulic conductivity                 1    !</span></div>
<div class="line"><a id="l05753" name="l05753"></a><span class="lineno"> 5753</span><span class="comment">!                                                                       !</span></div>
<div class="line"><a id="l05754" name="l05754"></a><span class="lineno"> 5754</span><span class="comment">!  ====================    end of description    =====================  !</span></div>
<div class="line"><a id="l05755" name="l05755"></a><span class="lineno"> 5755</span><span class="comment">!</span></div>
<div class="line"><a id="l05756" name="l05756"></a><span class="lineno"> 5756</span><span class="comment">!  ---  input:</span></div>
<div class="line"><a id="l05757" name="l05757"></a><span class="lineno"> 5757</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(in)</span>  :: smc, smcmax, bexp, dksat,   &amp;</div>
<div class="line"><a id="l05758" name="l05758"></a><span class="lineno"> 5758</span>     &amp;       dwsat, sicemax</div>
<div class="line"><a id="l05759" name="l05759"></a><span class="lineno"> 5759</span> </div>
<div class="line"><a id="l05760" name="l05760"></a><span class="lineno"> 5760</span><span class="comment">!  ---  output:</span></div>
<div class="line"><a id="l05761" name="l05761"></a><span class="lineno"> 5761</span><span class="keywordtype">      real</span> (kind=kind_phys), <span class="keywordtype">intent(out)</span> :: wdf, wcnd</div>
<div class="line"><a id="l05762" name="l05762"></a><span class="lineno"> 5762</span> </div>
<div class="line"><a id="l05763" name="l05763"></a><span class="lineno"> 5763</span><span class="comment">!  ---  locals:</span></div>
<div class="line"><a id="l05764" name="l05764"></a><span class="lineno"> 5764</span><span class="keywordtype">      real</span> (kind=kind_phys) :: expon, factr1, factr2, vkwgt</div>
<div class="line"><a id="l05765" name="l05765"></a><span class="lineno"> 5765</span><span class="comment">!</span></div>
<div class="line"><a id="l05766" name="l05766"></a><span class="lineno"> 5766</span><span class="comment">!===&gt; ...  begin here</span></div>
<div class="line"><a id="l05767" name="l05767"></a><span class="lineno"> 5767</span><span class="comment">!</span></div>
<div class="line"><a id="l05768" name="l05768"></a><span class="lineno"> 5768</span><span class="comment">!  --- ...  calc the ratio of the actual to the max psbl soil h2o content</span></div>
<div class="line"><a id="l05769" name="l05769"></a><span class="lineno"> 5769</span> </div>
<div class="line"><a id="l05770" name="l05770"></a><span class="lineno"> 5770</span>      factr1 = min(1.0, max(0.0, 0.2/smcmax))</div>
<div class="line"><a id="l05771" name="l05771"></a><span class="lineno"> 5771</span>      factr2 = min(1.0, max(0.0, smc/smcmax))</div>
<div class="line"><a id="l05772" name="l05772"></a><span class="lineno"> 5772</span> </div>
<div class="line"><a id="l05773" name="l05773"></a><span class="lineno"> 5773</span><span class="comment">!  --- ...  prep an expntl coef and calc the soil water diffusivity</span></div>
<div class="line"><a id="l05774" name="l05774"></a><span class="lineno"> 5774</span> </div>
<div class="line"><a id="l05775" name="l05775"></a><span class="lineno"> 5775</span>      expon = bexp + 2.0</div>
<div class="line"><a id="l05776" name="l05776"></a><span class="lineno"> 5776</span>      wdf = dwsat * factr2 ** expon</div>
<div class="line"><a id="l05777" name="l05777"></a><span class="lineno"> 5777</span> </div>
<div class="line"><a id="l05778" name="l05778"></a><span class="lineno"> 5778</span><span class="comment">!  --- ...  frozen soil hydraulic diffusivity.  very sensitive to the vertical</span></div>
<div class="line"><a id="l05779" name="l05779"></a><span class="lineno"> 5779</span><span class="comment">!           gradient of unfrozen water. the latter gradient can become very</span></div>
<div class="line"><a id="l05780" name="l05780"></a><span class="lineno"> 5780</span><span class="comment">!           extreme in freezing/thawing situations, and given the relatively</span></div>
<div class="line"><a id="l05781" name="l05781"></a><span class="lineno"> 5781</span><span class="comment">!           few and thick soil layers, this gradient sufferes serious</span></div>
<div class="line"><a id="l05782" name="l05782"></a><span class="lineno"> 5782</span><span class="comment">!           trunction errors yielding erroneously high vertical transports of</span></div>
<div class="line"><a id="l05783" name="l05783"></a><span class="lineno"> 5783</span><span class="comment">!           unfrozen water in both directions from huge hydraulic diffusivity.</span></div>
<div class="line"><a id="l05784" name="l05784"></a><span class="lineno"> 5784</span><span class="comment">!           therefore, we found we had to arbitrarily constrain wdf</span></div>
<div class="line"><a id="l05785" name="l05785"></a><span class="lineno"> 5785</span><span class="comment">!</span></div>
<div class="line"><a id="l05786" name="l05786"></a><span class="lineno"> 5786</span><span class="comment">!           version d_10cm:  .......  factr1 = 0.2/smcmax</span></div>
<div class="line"><a id="l05787" name="l05787"></a><span class="lineno"> 5787</span><span class="comment">!           weighted approach.......  pablo grunmann, 28_sep_1999.</span></div>
<div class="line"><a id="l05788" name="l05788"></a><span class="lineno"> 5788</span> </div>
<div class="line"><a id="l05789" name="l05789"></a><span class="lineno"> 5789</span>      <span class="keywordflow">if</span> (sicemax &gt; 0.0) <span class="keywordflow">then</span></div>
<div class="line"><a id="l05790" name="l05790"></a><span class="lineno"> 5790</span>        vkwgt = 1.0 / (1.0 + (500.0*sicemax)**3.0)</div>
<div class="line"><a id="l05791" name="l05791"></a><span class="lineno"> 5791</span>        wdf = vkwgt*wdf + (1.0- vkwgt)*dwsat*factr1**expon</div>
<div class="line"><a id="l05792" name="l05792"></a><span class="lineno"> 5792</span><span class="keywordflow">      endif</span></div>
<div class="line"><a id="l05793" name="l05793"></a><span class="lineno"> 5793</span> </div>
<div class="line"><a id="l05794" name="l05794"></a><span class="lineno"> 5794</span><span class="comment">!  --- ...  reset the expntl coef and calc the hydraulic conductivity</span></div>
<div class="line"><a id="l05795" name="l05795"></a><span class="lineno"> 5795</span> </div>
<div class="line"><a id="l05796" name="l05796"></a><span class="lineno"> 5796</span>      expon = (2.0 * bexp) + 3.0</div>
<div class="line"><a id="l05797" name="l05797"></a><span class="lineno"> 5797</span>      wcnd = dksat * factr2 ** expon</div>
<div class="line"><a id="l05798" name="l05798"></a><span class="lineno"> 5798</span><span class="comment">!</span></div>
<div class="line"><a id="l05799" name="l05799"></a><span class="lineno"> 5799</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l05800" name="l05800"></a><span class="lineno"> 5800</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_gabfc5ae94c847aa3351345e0e924302a1.html#gabfc5ae94c847aa3351345e0e924302a1">wdfcnd</a></div>
<div class="line"><a id="l05801" name="l05801"></a><span class="lineno"> 5801</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l05802" name="l05802"></a><span class="lineno"> 5802</span> </div>
<div class="line"><a id="l05803" name="l05803"></a><span class="lineno"> 5803</span><span class="comment">! =========================== !</span></div>
<div class="line"><a id="l05804" name="l05804"></a><span class="lineno"> 5804</span><span class="comment">!     end contain programs    !</span></div>
<div class="line"><a id="l05805" name="l05805"></a><span class="lineno"> 5805</span><span class="comment">! =========================== !</span></div>
<div class="line"><a id="l05806" name="l05806"></a><span class="lineno"> 5806</span> </div>
<div class="line"><a id="l05807" name="l05807"></a><span class="lineno"> 5807</span><span class="comment">!...................................</span></div>
</div>
<div class="line"><a id="l05808" name="l05808"></a><span class="lineno"> 5808</span>      <span class="keyword">end subroutine </span><a class="code hl_function" href="group___noah___l_s_m_ga36e98f3ac91f839b816fd167eab30901.html#ga36e98f3ac91f839b816fd167eab30901">gfssflx</a></div>
<div class="line"><a id="l05809" name="l05809"></a><span class="lineno"> 5809</span><span class="comment">!-----------------------------------</span></div>
<div class="line"><a id="l05810" name="l05810"></a><span class="lineno"> 5810</span>      <span class="keyword">end module </span><a class="code hl_namespace" href="namespacesflx.html">sflx</a></div>
<div class="ttc" id="agroup___noah___l_s_m_ga028fc448a3afe77726222a337008ffa4_html_ga028fc448a3afe77726222a337008ffa4"><div class="ttname"><a href="group___noah___l_s_m_ga028fc448a3afe77726222a337008ffa4.html#ga028fc448a3afe77726222a337008ffa4">csnow</a></div><div class="ttdeci">subroutine csnow</div><div class="ttdoc">This subroutine calculates snow termal conductivity.</div><div class="ttdef"><b>Definition</b> <a href="#l01228">sflx.f:1229</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga18a0f02e4a1a32b6cde35cbe67b09908_html_ga18a0f02e4a1a32b6cde35cbe67b09908"><div class="ttname"><a href="group___noah___l_s_m_ga18a0f02e4a1a32b6cde35cbe67b09908.html#ga18a0f02e4a1a32b6cde35cbe67b09908">alcalc</a></div><div class="ttdeci">subroutine alcalc</div><div class="ttdoc">This subroutine calculates albedo including snow effect (0 -&gt; 1).</div><div class="ttdef"><b>Definition</b> <a href="#l00988">sflx.f:989</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga1b241897d00ec3d66eabe9e959d0ce04_html_ga1b241897d00ec3d66eabe9e959d0ce04"><div class="ttname"><a href="group___noah___l_s_m_ga1b241897d00ec3d66eabe9e959d0ce04.html#ga1b241897d00ec3d66eabe9e959d0ce04">snksrc</a></div><div class="ttdeci">subroutine snksrc(nsoil, k, tavg, smc, smcmax, psisat, bexp, dt, qtot, zsoil, sh2o, tsrc)</div><div class="ttdoc">This subroutine calculates sink/source term of the termal diffusion equation.</div><div class="ttdef"><b>Definition</b> <a href="#l04817">sflx.f:4826</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga1c19b4bae5de2a391c019b6778a58dad_html_ga1c19b4bae5de2a391c019b6778a58dad"><div class="ttname"><a href="group___noah___l_s_m_ga1c19b4bae5de2a391c019b6778a58dad.html#ga1c19b4bae5de2a391c019b6778a58dad">redprm</a></div><div class="ttdeci">subroutine redprm(errmsg, errflg)</div><div class="ttdoc">This subroutine internally sets default values or optionally read-in via namelist i/o,...</div><div class="ttdef"><b>Definition</b> <a href="#l01682">sflx.f:1683</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga22b00b15c1b261126ec2d15719cb3aa4_html_ga22b00b15c1b261126ec2d15719cb3aa4"><div class="ttname"><a href="group___noah___l_s_m_ga22b00b15c1b261126ec2d15719cb3aa4.html#ga22b00b15c1b261126ec2d15719cb3aa4">sstep</a></div><div class="ttdeci">subroutine sstep(nsoil, sh2oin, rhsct, dt, smcmax, cmcmax, zsoil, sice, cmc, rhstt, ai, bi, ci, sh2oout, runoff3, smc)</div><div class="ttdoc">This subroutine calculates/updates soil moisture content values and canopy moisture content values.</div><div class="ttdef"><b>Definition</b> <a href="#l05267">sflx.f:5275</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga25b90f8a8049eb17cc6cb6a3fecf3fdc_html_ga25b90f8a8049eb17cc6cb6a3fecf3fdc"><div class="ttname"><a href="group___noah___l_s_m_ga25b90f8a8049eb17cc6cb6a3fecf3fdc.html#ga25b90f8a8049eb17cc6cb6a3fecf3fdc">penman</a></div><div class="ttdeci">subroutine penman</div><div class="ttdoc">This subroutine calculates potential evaporation for the current point. various partial sums/products...</div><div class="ttdef"><b>Definition</b> <a href="#l01571">sflx.f:1572</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga32e89df3740f968f500900125ae9633d_html_ga32e89df3740f968f500900125ae9633d"><div class="ttname"><a href="group___noah___l_s_m_ga32e89df3740f968f500900125ae9633d.html#ga32e89df3740f968f500900125ae9633d">hrtice</a></div><div class="ttdeci">subroutine hrtice(nsoil, stc, zsoil, yy, zz1, df1, ice, tbot, rhsts, ai, bi, ci)</div><div class="ttdoc">This subroutine calculates the right hand side of the time tendency term of the soil thermal diffusio...</div><div class="ttdef"><b>Definition</b> <a href="#l04444">sflx.f:4452</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga36e98f3ac91f839b816fd167eab30901_html_ga36e98f3ac91f839b816fd167eab30901"><div class="ttname"><a href="group___noah___l_s_m_ga36e98f3ac91f839b816fd167eab30901.html#ga36e98f3ac91f839b816fd167eab30901">sflx::gfssflx</a></div><div class="ttdeci">subroutine gfssflx(nsoil, couple, icein, ffrozp, dt, zlvl, sldpth, swdn, swnet, lwdn, sfcems, sfcprs, sfctmp, sfcspd, prcp, q2, q2sat, dqsdt2, th2, ivegsrc, vegtyp, soiltyp, slopetyp, shdmin, alb, snoalb, rhonewsn, exticeden, bexpp, xlaip, lheatstrg, tbot, cmc, t1, stc, smc, sh2o, sneqv, ch, cm, z0, nroot, shdfac, snowh, albedo, eta, sheat, ec, edir, et, ett, esnow, drip, dew, beta, etp, ssoil, flx1, flx2, flx3, runoff1, runoff2, runoff3, snomlt, sncovr, rc, pc, rsmin, xlai, rcs, rct, rcq, rcsoil, soilw, soilm, smcwlt, smcdry, smcref, smcmax, errmsg, errflg)</div><div class="ttdoc">This is the entity of GFS Noah LSM model of physics subroutines. It is a soil/veg/snowpack land-surfa...</div><div class="ttdef"><b>Definition</b> <a href="#l00116">sflx.f:131</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga3d7dabe1147278de865aa4691d5b2de0_html_ga3d7dabe1147278de865aa4691d5b2de0"><div class="ttname"><a href="group___noah___l_s_m_ga3d7dabe1147278de865aa4691d5b2de0.html#ga3d7dabe1147278de865aa4691d5b2de0">rosr12</a></div><div class="ttdeci">subroutine rosr12(nsoil, a, b, d, c, p, delta)</div><div class="ttdoc">This subroutine inverts (solve) the tri-diagonal matrix problem.</div><div class="ttdef"><b>Definition</b> <a href="#l04715">sflx.f:4723</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga4af741ecc120ddb0d7282f78df4136a5_html_ga4af741ecc120ddb0d7282f78df4136a5"><div class="ttname"><a href="group___noah___l_s_m_ga4af741ecc120ddb0d7282f78df4136a5.html#ga4af741ecc120ddb0d7282f78df4136a5">evapo</a></div><div class="ttdeci">subroutine evapo(nsoil, nroot, cmc, cmcmax, etp1, dt, zsoil, sh2o, smcmax, smcwlt, smcref, smcdry, pc, shdfac, cfactr, rtdis, fxexp, eta1, edir1, ec1, et1, ett1)</div><div class="ttdoc">This subroutine calculates soil moisture flux. The soil moisture content (smc - a per unit volume mea...</div><div class="ttdef"><b>Definition</b> <a href="#l03145">sflx.f:3153</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga4bf7fbbf861a5c232da14ca6b74cdd4f_html_ga4bf7fbbf861a5c232da14ca6b74cdd4f"><div class="ttname"><a href="group___noah___l_s_m_ga4bf7fbbf861a5c232da14ca6b74cdd4f.html#ga4bf7fbbf861a5c232da14ca6b74cdd4f">transp</a></div><div class="ttdeci">subroutine transp(nsoil, nroot, etp1, smc, smcwlt, smcref, cmc, cmcmax, zsoil, shdfac, pc, cfactr, rtdis, et1)</div><div class="ttdoc">This subroutine calculates transpiration for the veg class.</div><div class="ttdef"><b>Definition</b> <a href="#l05592">sflx.f:5599</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga7c0e713811400259a984b2153834e70c_html_ga7c0e713811400259a984b2153834e70c"><div class="ttname"><a href="group___noah___l_s_m_ga7c0e713811400259a984b2153834e70c.html#ga7c0e713811400259a984b2153834e70c">frh2o</a></div><div class="ttdeci">subroutine frh2o(tkelv, smc, sh2o, smcmax, bexp, psis, liqwat)</div><div class="ttdoc">This subroutine calculates amount of supercooled liquid soil water content if temperature is below 27...</div><div class="ttdef"><b>Definition</b> <a href="#l03918">sflx.f:3924</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga8bc3154096e6364c5fcddf884c003bef_html_ga8bc3154096e6364c5fcddf884c003bef"><div class="ttname"><a href="group___noah___l_s_m_ga8bc3154096e6364c5fcddf884c003bef.html#ga8bc3154096e6364c5fcddf884c003bef">tdfcnd</a></div><div class="ttdeci">subroutine tdfcnd(smc, qz, smcmax, sh2o, df)</div><div class="ttdoc">This subroutine calculates thermal diffusivity and conductivity of the soil for a given point and tim...</div><div class="ttdef"><b>Definition</b> <a href="#l02999">sflx.f:3005</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga8e248a6da8d1fd3c2e64b76f3bfbea50_html_ga8e248a6da8d1fd3c2e64b76f3bfbea50"><div class="ttname"><a href="group___noah___l_s_m_ga8e248a6da8d1fd3c2e64b76f3bfbea50.html#ga8e248a6da8d1fd3c2e64b76f3bfbea50">tbnd</a></div><div class="ttdeci">subroutine tbnd(tu, tb, zsoil, zbot, k, nsoil, tbnd1)</div><div class="ttdoc">This subroutine calculates temperature on the boundary of the layer by interpolation of the middle la...</div><div class="ttdef"><b>Definition</b> <a href="#l05414">sflx.f:5420</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga92994e4737ecfd692a6704778558c9c2_html_ga92994e4737ecfd692a6704778558c9c2"><div class="ttname"><a href="group___noah___l_s_m_ga92994e4737ecfd692a6704778558c9c2.html#ga92994e4737ecfd692a6704778558c9c2">nopac</a></div><div class="ttdeci">subroutine nopac</div><div class="ttdoc">This subroutine calculates soil moisture and heat flux values and update soil moisture content and so...</div><div class="ttdef"><b>Definition</b> <a href="#l01292">sflx.f:1293</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga95d889f436d70014fe640fa1b2420545_html_ga95d889f436d70014fe640fa1b2420545"><div class="ttname"><a href="group___noah___l_s_m_ga95d889f436d70014fe640fa1b2420545.html#ga95d889f436d70014fe640fa1b2420545">snowz0</a></div><div class="ttdeci">subroutine snowz0</div><div class="ttdoc">This subroutine calculates total roughness length over snow.</div><div class="ttdef"><b>Definition</b> <a href="#l02947">sflx.f:2948</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_ga977daabf4ff68b28fc5ccd8796d815cd_html_ga977daabf4ff68b28fc5ccd8796d815cd"><div class="ttname"><a href="group___noah___l_s_m_ga977daabf4ff68b28fc5ccd8796d815cd.html#ga977daabf4ff68b28fc5ccd8796d815cd">shflx</a></div><div class="ttdeci">subroutine shflx(nsoil, smc, smcmax, dt, yy, zz1, zsoil, zbot, psisat, bexp, df1, ice, quartz, csoil, vegtyp, shdfac, lheatstrg, stc, t1, tbot, sh2o, ssoil)</div><div class="ttdoc">This subroutine updates the temperature state of the soil column based on the thermal diffusion equat...</div><div class="ttdef"><b>Definition</b> <a href="#l03293">sflx.f:3303</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gaa292bfa0bd38e58ab9389cb38e4d09c0_html_gaa292bfa0bd38e58ab9389cb38e4d09c0"><div class="ttname"><a href="group___noah___l_s_m_gaa292bfa0bd38e58ab9389cb38e4d09c0.html#gaa292bfa0bd38e58ab9389cb38e4d09c0">canres</a></div><div class="ttdeci">subroutine canres</div><div class="ttdoc">This subroutine calculates canopy resistance which depends on incoming solar radiation,...</div><div class="ttdef"><b>Definition</b> <a href="#l01074">sflx.f:1075</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gab5149f309f4e291435f75dd63d4a97ac_html_gab5149f309f4e291435f75dd63d4a97ac"><div class="ttname"><a href="group___noah___l_s_m_gab5149f309f4e291435f75dd63d4a97ac.html#gab5149f309f4e291435f75dd63d4a97ac">snowpack</a></div><div class="ttdeci">subroutine snowpack(esd, dtsec, tsnow, tsoil, snowh, sndens)</div><div class="ttdoc">This subroutine calculates compaction of a snowpack under conditions of increasing snow density,...</div><div class="ttdef"><b>Definition</b> <a href="#l03677">sflx.f:3683</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gab816dbe84c4db91178251b08553c6d02_html_gab816dbe84c4db91178251b08553c6d02"><div class="ttname"><a href="group___noah___l_s_m_gab816dbe84c4db91178251b08553c6d02.html#gab816dbe84c4db91178251b08553c6d02">snow_new</a></div><div class="ttdeci">subroutine snow_new</div><div class="ttdoc">This subroutine calculates snow depth and densitity to account for the new snowfall....</div><div class="ttdef"><b>Definition</b> <a href="#l02870">sflx.f:2871</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gabb602c2b09396e2f94c9556259f5bae4_html_gabb602c2b09396e2f94c9556259f5bae4"><div class="ttname"><a href="group___noah___l_s_m_gabb602c2b09396e2f94c9556259f5bae4.html#gabb602c2b09396e2f94c9556259f5bae4">hrt</a></div><div class="ttdeci">subroutine hrt(nsoil, stc, smc, smcmax, zsoil, yy, zz1, tbot, zbot, psisat, dt, bexp, df1, quartz, csoil, vegtyp, shdfac, lheatstrg, sh2o, rhsts, ai, bi, ci)</div><div class="ttdoc">This subroutine calculates the right hand side of the time tendency term of the soil thermal diffusio...</div><div class="ttdef"><b>Definition</b> <a href="#l04072">sflx.f:4082</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gabf8ee2c002871d95bc356e2058f49a92_html_gabf8ee2c002871d95bc356e2058f49a92"><div class="ttname"><a href="group___noah___l_s_m_gabf8ee2c002871d95bc356e2058f49a92.html#gabf8ee2c002871d95bc356e2058f49a92">devap</a></div><div class="ttdeci">subroutine devap(etp1, smc, shdfac, smcmax, smcdry, fxexp, edir1)</div><div class="ttdoc">This subrtouine calculates direct soil evaporation.</div><div class="ttdef"><b>Definition</b> <a href="#l03839">sflx.f:3845</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gabfc5ae94c847aa3351345e0e924302a1_html_gabfc5ae94c847aa3351345e0e924302a1"><div class="ttname"><a href="group___noah___l_s_m_gabfc5ae94c847aa3351345e0e924302a1.html#gabfc5ae94c847aa3351345e0e924302a1">wdfcnd</a></div><div class="ttdeci">subroutine wdfcnd(smc, smcmax, bexp, dksat, dwsat, sicemax, wdf, wcnd)</div><div class="ttdoc">This subroutine calculates soil water diffusivity and soil hydraulic conductivity.</div><div class="ttdef"><b>Definition</b> <a href="#l05725">sflx.f:5731</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gacb79bab20ee25c57918575949c15de73_html_gacb79bab20ee25c57918575949c15de73"><div class="ttname"><a href="group___noah___l_s_m_gacb79bab20ee25c57918575949c15de73.html#gacb79bab20ee25c57918575949c15de73">hstep</a></div><div class="ttdeci">subroutine hstep(nsoil, stcin, dt, rhsts, ai, bi, ci, stcout)</div><div class="ttdoc">This subroutine calculates/updates the soil temperature field.</div><div class="ttdef"><b>Definition</b> <a href="#l04616">sflx.f:4624</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gad65a889bf3f431ade2a312674671ab41_html_gad65a889bf3f431ade2a312674671ab41"><div class="ttname"><a href="group___noah___l_s_m_gad65a889bf3f431ade2a312674671ab41.html#gad65a889bf3f431ade2a312674671ab41">snopac</a></div><div class="ttdeci">subroutine snopac</div><div class="ttdoc">This subroutine calculates soil moisture and heat flux values and update soil moisture content and so...</div><div class="ttdef"><b>Definition</b> <a href="#l02343">sflx.f:2344</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gae50411efeb11ddeb8a0c53010745a95c_html_gae50411efeb11ddeb8a0c53010745a95c"><div class="ttname"><a href="group___noah___l_s_m_gae50411efeb11ddeb8a0c53010745a95c.html#gae50411efeb11ddeb8a0c53010745a95c">tmpavg</a></div><div class="ttdeci">subroutine tmpavg(tup, tm, tdn, zsoil, nsoil, k, tavg)</div><div class="ttdoc">This subroutine calculates soil layer average temperature (tavg) in freezing/thawing layer using up,...</div><div class="ttdef"><b>Definition</b> <a href="#l05488">sflx.f:5494</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gaf59c85cce3b10eaa0ffeb366de9d5304_html_gaf59c85cce3b10eaa0ffeb366de9d5304"><div class="ttname"><a href="group___noah___l_s_m_gaf59c85cce3b10eaa0ffeb366de9d5304.html#gaf59c85cce3b10eaa0ffeb366de9d5304">srt</a></div><div class="ttdeci">subroutine srt(nsoil, edir, et, sh2o, sh2oa, pcpdrp, zsoil, dwsat, dksat, smcmax, bexp, dt, smcwlt, slope, kdt, frzx, sice, rhstt, runoff1, runoff2, ai, bi, ci)</div><div class="ttdoc">This subroutine calculates the right hand side of the time tendency term of the soil water diffusion ...</div><div class="ttdef"><b>Definition</b> <a href="#l04956">sflx.f:4963</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gafa3e5637e56746e2539ef2567836defa_html_gafa3e5637e56746e2539ef2567836defa"><div class="ttname"><a href="group___noah___l_s_m_gafa3e5637e56746e2539ef2567836defa.html#gafa3e5637e56746e2539ef2567836defa">smflx</a></div><div class="ttdeci">subroutine smflx(nsoil, dt, kdt, smcmax, smcwlt, cmcmax, prcp1, zsoil, slope, frzx, bexp, dksat, dwsat, shdfac, edir1, ec1, et1, cmc, sh2o, smc, runoff1, runoff2, runoff3, drip)</div><div class="ttdoc">This subroutine calculates soil moisture flux. The soil moisture content (smc - a per unit vulume mea...</div><div class="ttdef"><b>Definition</b> <a href="#l03466">sflx.f:3476</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gafca324f1a0f2bcca12116291bfc8ad68_html_gafca324f1a0f2bcca12116291bfc8ad68"><div class="ttname"><a href="group___noah___l_s_m_gafca324f1a0f2bcca12116291bfc8ad68.html#gafca324f1a0f2bcca12116291bfc8ad68">snfrac</a></div><div class="ttdeci">subroutine snfrac</div><div class="ttdoc">This subroutine calculates snow fraction (0-&gt;1).</div><div class="ttdef"><b>Definition</b> <a href="#l02271">sflx.f:2272</a></div></div>
<div class="ttc" id="agroup___noah___l_s_m_gafdc2dc9815673befca7228be47616e41_html_gafdc2dc9815673befca7228be47616e41"><div class="ttname"><a href="group___noah___l_s_m_gafdc2dc9815673befca7228be47616e41.html#gafdc2dc9815673befca7228be47616e41">sfcdif</a></div><div class="ttdeci">subroutine sfcdif</div><div class="ttdoc">This subroutine calculates surface layer exchange coefficients via iterative process(see Chen et al....</div><div class="ttdef"><b>Definition</b> <a href="#l01985">sflx.f:1986</a></div></div>
<div class="ttc" id="agroup___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1_html_ga9d5adb20aca5b72a7e126136088e20d1"><div class="ttname"><a href="group___noah_m_p___l_s_m_ga9d5adb20aca5b72a7e126136088e20d1.html#ga9d5adb20aca5b72a7e126136088e20d1">albedo</a></div><div class="ttdeci">subroutine albedo(parameters, vegtyp, ist, ice, nsoil, dt, cosz, fage, elai, esai, tg, tv, snowh, fsno, fwet, smc, sneqvo, sneqv, qsnow, fveg, iloc, jloc, albold, tauss, albgrd, albgri, albd, albi, fabd, fabi, ftdd, ftid, ftii, fsun, frevi, frevd, fregd, fregi, bgap, wgap, albsnd, albsni)</div><div class="ttdoc">surface albedos. also fluxes (per unit incoming direct and diffuse radiation) reflected,...</div><div class="ttdef"><b>Definition</b> <a href="module__sf__noahmplsm_8_f90_source.html#l02908">module_sf_noahmplsm.F90:2918</a></div></div>
<div class="ttc" id="agroup___noah_m_p___l_s_m_gace27cd3a7b4e23955e39e33bd344baae_html_gace27cd3a7b4e23955e39e33bd344baae"><div class="ttname"><a href="group___noah_m_p___l_s_m_gace27cd3a7b4e23955e39e33bd344baae.html#gace27cd3a7b4e23955e39e33bd344baae">error</a></div><div class="ttdeci">subroutine error(parameters, swdown,fsa,fsr,fira,fsh,fcev, fgev,fctr,ssoil,beg_wb,canliq,canice, sneqv,wa,smc,dzsnso,prcp,ecan, etran,edir,runsrf,runsub,dt,nsoil, nsnow,ist,errwat, iloc,jloc,fveg, sav,sag,fsrv,fsrg,zwt,pah, ifdef ccpp</div><div class="ttdoc">check surface energy balance and water balance.</div><div class="ttdef"><b>Definition</b> <a href="module__sf__noahmplsm_8_f90_source.html#l01464">module_sf_noahmplsm.F90:1471</a></div></div>
<div class="ttc" id="anamespacemachine_html"><div class="ttname"><a href="namespacemachine.html">machine</a></div><div class="ttdef"><b>Definition</b> <a href="machine_8_f90_source.html#l00001">machine.F90:1</a></div></div>
<div class="ttc" id="anamespacenamelist__soilveg_html"><div class="ttname"><a href="namespacenamelist__soilveg.html">namelist_soilveg</a></div><div class="ttdoc">This module contains namelist options for Noah LSM.</div><div class="ttdef"><b>Definition</b> <a href="namelist__soilveg_8f_source.html#l00006">namelist_soilveg.f:6</a></div></div>
<div class="ttc" id="anamespacesflx_html"><div class="ttname"><a href="namespacesflx.html">sflx</a></div><div class="ttdoc">This module contains the entity of GFS Noah LSM Model(Version 2.7).</div><div class="ttdef"><b>Definition</b> <a href="#l00005">sflx.f:5</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- HTML footer for doxygen 1.9.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="dir_8793a1d86eabfbf136477319f12c7204.html">SFC_Models</a></li><li class="navelem"><a href="dir_b3377f0f07e407c82e315ef0f6624239.html">Land</a></li><li class="navelem"><a href="dir_adf77c8146b0cdf226a90029e2c08193.html">Noah</a></li><li class="navelem"><b>sflx.f</b></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.16.1 </li>
  </ul>
</div>
<script type="text/javascript">
  $(function() {
    toggleButton = document.createElement('doxygen-awesome-dark-mode-toggle')
    toggleButton.title = "Toggle Light/Dark Mode"
    $(document).ready(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
    // every resize will remove the button, which is why it has to be added again:
    $(window).resize(function(){
      document.getElementById("MSearchBox").parentNode.appendChild(toggleButton)
    })
  })
</script>
</body>
</html>
